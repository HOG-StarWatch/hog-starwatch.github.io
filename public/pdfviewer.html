<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¢å¼ºå‹PDFæŸ¥çœ‹å™¨</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        :root {
            --bg-primary: #f4f4f4;
            --bg-secondary: white;
            --text-primary: #333;
            --btn-primary: #4CAF50;
            --btn-hover: #45a049;
        }

        /* æš—å¤œæ¨¡å¼ */
        .dark-mode {
            --bg-primary: #232323;
            --bg-secondary: #2c2c2c;
            --text-primary: #f0f0f0;
            --btn-primary: #4B0082;
            --btn-hover: #320255;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ï¼Œä»…è°ƒæ•´é¢œè‰²å˜é‡ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--bg-secondary);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .toolbar {
            background-color: var(--bg-primary);
        }

        .btn {
            background-color: var(--btn-primary);
        }

        .btn:hover {
            background-color: var(--btn-hover);
        }

        /* æ–°å¢æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        #mode-toggle {
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <!-- åŸæœ‰å·¥å…·æ  -->
            <div class="import-section">
                <input type="file" id="pdf-upload" accept=".pdf">
                
                <input type="text" id="pdf-url" class="url-input" placeholder="è¾“å…¥PDFæ–‡ä»¶é“¾æ¥">
                <button id="load-url" class="btn">å¯¼å…¥é“¾æ¥</button>
            </div>
            
            <div class="page-controls">
                <!-- æ–°å¢é¡µé¢è·³è½¬è¾“å…¥ -->
                <input type="number" id="page-jump" min="1" style="width:50px" placeholder="é¡µç ">
                <button id="jump-page" class="btn">è·³è½¬</button>

                <!-- åŸæœ‰åˆ†é¡µå’Œç¼©æ”¾æ§ä»¶ -->
                <button id="prev-page" class="btn">ä¸Šä¸€é¡µ</button>
                <span id="page-num">0 / 0</span>
                <button id="next-page" class="btn">ä¸‹ä¸€é¡µ</button>
                
                <select id="zoom-select">
                    <option value="0.5">50%</option>
                    <option value="1" selected>100%</option>
                    <option value="1.5">150%</option>
                    <option value="2">200%</option>
                </select>

                <button id="save-pdf" class="btn">ä¿å­˜PDF</button>

                <!-- æ–°å¢æ¨¡å¼åˆ‡æ¢ -->
                <button id="mode-toggle" class="btn">ğŸŒ“</button>
            </div>
        </div>
        
        <div id="pdf-viewer"></div>
    </div>

    <!-- ä¿æŒåŸæœ‰externalåº“å’Œè„šæœ¬å¼•ç”¨ -->
    <script src="pdf.min.js"></script>
    <script src="pdf.worker.min.js"></script>
    <script src="FileSaver.min.js"></script>

    <script>
        // PDF.jsé…ç½®
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js';

        // å…¨å±€å˜é‡
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0;
        let pdfRawData = null;

        // è·å–DOMå…ƒç´ 
        const pdfUpload = document.getElementById('pdf-upload');
        const pdfUrl = document.getElementById('pdf-url');
        const loadUrlBtn = document.getElementById('load-url');
        const pdfViewer = document.getElementById('pdf-viewer');
        const prevPage = document.getElementById('prev-page');
        const nextPage = document.getElementById('next-page');
        const pageNumSpan = document.getElementById('page-num');
        const zoomSelect = document.getElementById('zoom-select');
        const savePdfBtn = document.getElementById('save-pdf');

        // è§£æURLå‚æ•°çš„å‡½æ•°
        function getUrlParameter(name) {
            name = name.replace(/[$$]/, '\$$').replace(/[$$]/, '\$$');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1]);
        }

        // æ¸²æŸ“PDFé¡µé¢(ä¹‹å‰çš„ä»£ç ä¿æŒä¸å˜)
        function renderPage(num) {
            pageRendering = true;
            
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                
                renderTask.promise.then(function() {
                    pageRendering = false;
                    
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
                
                pageNumSpan.textContent = `${num} / ${pdfDoc.numPages}`;
                
                pdfViewer.innerHTML = '';
                pdfViewer.appendChild(canvas);
            });
        }

        // åŠ è½½PDFçš„é€šç”¨æ–¹æ³•
        function loadPDF(data, filename = 'downloaded.pdf') {
            pdfjsLib.getDocument(data).promise.then(function(pdf) {
                pdfDoc = pdf;
                pageNum = 1;
                pdfRawData = data;
                savePdfBtn.dataset.filename = filename; // ä¿å­˜æ–‡ä»¶å
                renderPage(pageNum);
            }).catch(function(error) {
                alert('PDFåŠ è½½å¤±è´¥ï¼š' + error);
            });
        }

        // åˆå§‹åŒ–æ—¶æ£€æŸ¥URLå‚æ•°
        function initFromUrlParam() {
            // å°è¯•ä»URLå‚æ•°ä¸­è·å–PDFé“¾æ¥
            const pdfLink = getUrlParameter('pdf');
            if (pdfLink) {
                pdfUrl.value = pdfLink;
                // è‡ªåŠ¨åŠ è½½PDF
                fetchPdfFromUrl(pdfLink);
            }
        }

        // ä»URLè·å–PDFçš„å¢å¼ºå‡½æ•°
        function fetchPdfFromUrl(url) {
            // æå–æ–‡ä»¶åï¼ˆå¦‚æœå¯èƒ½ï¼‰
            let filename = 'downloaded.pdf';
            try {
                const urlObj = new URL(url);
                const pathParts = urlObj.pathname.split('/');
                const lastPart = pathParts[pathParts.length - 1];
                if (lastPart.endsWith('.pdf')) {
                    filename = lastPart;
                }
            } catch(e) {
                console.warn('æ— æ³•æå–æ–‡ä»¶å', e);
            }

            fetch(url)
                .then(response => {
                    // å¤„ç†å¯èƒ½çš„é”™è¯¯å“åº”
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const typedArray = new Uint8Array(arrayBuffer);
                    loadPDF(typedArray, filename);
                })
                .catch(error => {
                    alert('PDFé“¾æ¥åŠ è½½å¤±è´¥ï¼š' + error);
                });
        }

        // é“¾æ¥å¯¼å…¥äº‹ä»¶
        loadUrlBtn.addEventListener('click', function() {
            const url = pdfUrl.value.trim();
            if (url) {
                fetchPdfFromUrl(url);
            }
        });

        // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
        pdfUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const typedArray = new Uint8Array(e.target.result);
                    loadPDF(typedArray, file.name);
                }
                
                reader.readAsArrayBuffer(file);
            }
        });

        // ä¿å­˜PDFåˆ°æœ¬åœ°
        savePdfBtn.addEventListener('click', function() {
            if (pdfRawData) {
                const blob = new Blob([pdfRawData], { type: 'application/pdf' });
                saveAs(blob, this.dataset.filename || 'downloaded.pdf');
            } else {
                alert('è¯·å…ˆåŠ è½½PDF');
            }
        });

        // ç¿»é¡µäº‹ä»¶(ä¹‹å‰ä»£ç ä¿æŒä¸å˜)
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        prevPage.addEventListener('click', function() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        });

        nextPage.addEventListener('click', function() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        });

        // ç¼©æ”¾äº‹ä»¶
        zoomSelect.addEventListener('change', function() {
            scale = parseFloat(this.value);
            if (pdfDoc) {
                renderPage(pageNum);
            }
        });
		// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', initFromUrlParam);
        // é¡µé¢è·³è½¬åŠŸèƒ½
        const pageJump = document.getElementById('page-jump');
        const jumpPageBtn = document.getElementById('jump-page');

        jumpPageBtn.addEventListener('click', function() {
            const targetPage = parseInt(pageJump.value);
            if (pdfDoc && targetPage > 0 && targetPage <= pdfDoc.numPages) {
                pageNum = targetPage;
                queueRenderPage(pageNum);
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ');
            }
        });

        // æš—å¤œæ¨¡å¼åˆ‡æ¢
        const modeToggle = document.getElementById('mode-toggle');
        modeToggle.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            // å¯ä»¥å­˜å‚¨ç”¨æˆ·åå¥½
            localStorage.setItem('theme', 
                document.body.classList.contains('dark-mode') ? 'dark' : 'light'
            );
        });

        // åˆå§‹åŒ–æ—¶æ£€æŸ¥ä¹‹å‰çš„æ¨¡å¼åå¥½
        window.addEventListener('load', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        });
    </script>

    <!-- ä½¿ç”¨è¯´æ˜éƒ¨åˆ† -->
    <div style="max-width: 900px; margin: 20px auto; background: var(--bg-primary); padding: 15px; border-radius: 5px;">
        <h3>PDFæŸ¥çœ‹å™¨ä½¿ç”¨ç¤ºä¾‹</h3>
        <ol>
            <li>
                <strong>ç›´æ¥é“¾æ¥æ‰“å¼€æ–¹å¼ï¼š</strong>
                <br>
                åœ¨æµè§ˆå™¨åœ°å€æ ä¸­æ·»åŠ PDFé“¾æ¥å‚æ•°ï¼Œä¾‹å¦‚ï¼š
                <pre>http://my-site.com/pdfviewer.html?pdf=https://example.com/sample.pdf</pre>
            </li>
            <li>
                <strong>æ‰‹åŠ¨å¯¼å…¥æ–¹å¼ï¼š</strong>
                <br>
                1) åœ¨è¾“å…¥æ¡†ä¸­ç²˜è´´PDFé“¾æ¥
                <br>
                2) ç‚¹å‡»"å¯¼å…¥é“¾æ¥"æŒ‰é’®
            </li>
            <li>
                <strong>æœ¬åœ°æ–‡ä»¶å¯¼å…¥ï¼š</strong>
                <br>
                ç‚¹å‡»æ–‡ä»¶é€‰æ‹©æŒ‰é’®ï¼Œé€‰æ‹©æœ¬åœ°PDFæ–‡ä»¶
            </li>
        </ol>
        
        <h4>æ³¨æ„äº‹é¡¹ï¼š</h4>
        <ul>
            <li>PDFé“¾æ¥éœ€è¦æ”¯æŒè·¨åŸŸè®¿é—®</li>
            <li>éƒ¨åˆ†å—ä¿æŠ¤çš„PDFå¯èƒ½æ— æ³•ç›´æ¥åŠ è½½</li>
            <li>å¤§æ–‡ä»¶åŠ è½½å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´</li>
        </ul>
    </div>
</body>
</html>
