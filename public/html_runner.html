<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainbow Mica Code Runner</title>
    <style>
        :root {
            /* Default to Violet Theme */
            --bg-color: #0f0c29;
            --accent-color: #7b2cbf;
            --accent-glow: #9d4edd;
            --glass-bg: rgba(30, 30, 40, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background: radial-gradient(circle at 0% 0%, #301847 0%, #0f0c29 50%, #000000 100%);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.5s ease;
        }

        /* Ambient background orbs for glass effect enhancement */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out alternate;
            transition: background 0.5s ease;
        }
        .orb-1 { width: 300px; height: 300px; background: #7b2cbf; top: -50px; left: -50px; }
        .orb-2 { width: 400px; height: 400px; background: #3c096c; bottom: -100px; right: -100px; animation-delay: -5s; }
        .orb-3 { width: 200px; height: 200px; background: #5a189a; top: 40%; left: 40%; opacity: 0.3; }

        @keyframes float {
            0% { transform: translate(0, 0); }
            100% { transform: translate(30px, 50px); }
        }

        /* Main Container */
        .container {
            width: 95vw;
            height: 90vh;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(90deg, var(--text-main), var(--accent-glow));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filename-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            width: 120px;
            outline: none;
            transition: all 0.3s;
        }
        
        .filename-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            color: var(--text-main);
            width: 160px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--accent-color);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button:hover {
            background: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
        }

        /* Workspace Layout */
        .workspace {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* Editor Section */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .pane-label {
            padding: 8px 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pane-label:first-child {
            border-top: none;
        }

        /* Editor Wrapper for Line Numbers */
        .editor-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        .line-numbers {
            width: 40px;
            background: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.3);
            text-align: right;
            padding: 15px 5px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            user-select: none;
            overflow: hidden;
            border-right: 1px solid var(--glass-border);
        }

        textarea {
            flex: 1;
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-main);
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            white-space: pre;
            overflow-x: auto;
        }

        textarea::selection {
            background: var(--accent-color);
            color: white;
        }
        
        /* Split Mode Styling */
        #splitModePane {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        
        #singleModePane {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Preview Section */
        .preview-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.02);
            position: relative;
        }

        iframe {
            flex: 1;
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            transition: background 0.3s;
        }
        
        .theme-toggle {
            cursor: pointer;
            opacity: 0.7;
            transition: transform 0.3s;
            font-size: 1.2em;
        }
        .theme-toggle:hover {
            opacity: 1;
            transform: rotate(90deg);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
            opacity: 0.5;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-glow);
        }

        @media (max-width: 768px) {
            .workspace {
                flex-direction: column;
            }
            .editor-container {
                border-right: none;
                border-bottom: 1px solid var(--glass-border);
                height: 50%;
            }
        }

        /* Console Pane */
        .console-pane {
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-top: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: height 0.3s;
            position: absolute;
            bottom: 0;
            width: 100%;
            z-index: 10;
        }

        .console-pane.collapsed {
            height: 35px;
        }

        .console-header {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .console-output {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
            color: #ddd;
        }

        .log-entry { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-info { color: #ddd; }
        .log-warn { color: #ffcc00; }
        .log-error { color: #ff5555; }
    </style>
</head>
<body>

    <!-- Background Ambience -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <div class="container">
        <header>
            <div class="logo">
                <span>‚ö°</span> CodeRunner <span id="themeName" style="opacity:0.5; font-size: 0.8em; font-weight:normal;">| Violet Mica</span>
            </div>
            <div class="controls">
                <button onclick="toggleMode()" id="modeBtn" title="ÂàáÊç¢ËßÜÂõæÊ®°Âºè (Switch View)">ÂàáËá≥‰∏âÁ™óÂè£</button>
                <button onclick="copyCode()" title="Â§çÂà∂ÂÖ®ÈÉ®‰ª£Á†Å">üìã Â§çÂà∂</button>
                <button onclick="resetCode()" title="ÈáçÁΩÆ‰ª£Á†Å">‚Ü∫ ÈáçÁΩÆ</button>
                <button onclick="shareCode()" title="ÁîüÊàêÂàÜ‰∫´ÈìæÊé•">üîó ÂàÜ‰∫´</button>
                <div style="display:flex; align-items:center; background:rgba(255,255,255,0.05); border-radius:8px; padding-right:5px;">
                    <input type="text" id="filenameInput" class="filename-input" value="exported_project" placeholder="Êñá‰ª∂Âêç">
                    <span style="font-size:0.8em; color:rgba(255,255,255,0.3); margin-right:5px;">.html</span>
                    <button onclick="exportCode()" title="ÂØºÂá∫‰∏∫ HTML Êñá‰ª∂" style="border:none; background:transparent; padding:5px;">üíæ</button>
                </div>
                <div style="width: 1px; height: 20px; background: rgba(255,255,255,0.2); margin: 0 5px;"></div>
                <button onclick="runCode()" id="runBtn">‚ñ∂ ËøêË°å</button>
                <button onclick="openNewTab()" id="newTabBtn">‚Üó Êñ∞Ê†áÁ≠æÈ°µ</button>
            </div>
        </header>

        <main class="workspace">
            <div class="editor-container">
                
                <!-- Single Mode Pane -->
                <div id="singleModePane">
                    <div class="pane-label">
                        <span>HTML / CSS / JS Source (Single File)</span>
                    </div>
                    <div class="editor-wrapper">
                        <div class="line-numbers" id="ln-source">1</div>
                        <textarea id="sourceCode" spellcheck="false" placeholder="Âú®Ê≠§ËæìÂÖ•ÂÆåÊï¥ HTML ‰ª£Á†Å...">
<!DOCTYPE html>
<html>
<head>
<style>
  body { 
    font-family: 'Segoe UI', sans-serif; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
    background: #121212; 
    color: #e0e0e0;
    margin: 0;
  }
  .card {
    background: #1e1e1e;
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    text-align: center;
    border: 1px solid #333;
    max-width: 350px;
  }
  h1 { 
    background: linear-gradient(90deg, #bb86fc, #9d4edd);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
  }
  p { color: #a0a0a0; }
  button {
    background: #bb86fc;
    color: #121212;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 15px;
    font-weight: bold;
    transition: 0.2s;
  }
  button:hover { background: #9d4edd; }
</style>
</head>
<body>

<div class="card">
  <h1>‚ú® Hello World</h1>
  <p>ËøôÊòØ‰∏Ä‰∏™ÂÆûÊó∂ HTML ÁºñËæëÂô®</p>
  <p style="font-size:0.8em; color:#666;">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∏ÖÁ©∫‰ª£Á†ÅÊ°Ü</p>
  <!-- Ë∞ÉÁî®Áà∂Á™óÂè£ÁöÑ clearEditor ÊñπÊ≥ï -->
   <button onclick="console.log('‚ù§LOVE‚ù§');">‚ù§</button>
  <button onclick="window.parent.clearEditor()">ÁÇπÂáªÊàëÂºÄÂßãÁºñÂÜôËá™Â∑±ÁöÑ‰ª£Á†ÅÂêßÔºÅ‚ù§</button>
  <br>
  
</div>

<script>
  console.log("System Ready: " + new Date().toLocaleTimeString());
</script>

</body>
</html>
</textarea>
                    </div>
                </div>

                <!-- Split Mode Pane -->
                <div id="splitModePane">
                    <div class="pane-label" style="background:rgba(255, 100, 100, 0.1);">
                        <span>HTML Body</span>
                    </div>
                    <div class="editor-wrapper" style="flex:1;">
                        <div class="line-numbers" id="ln-html">1</div>
                        <textarea id="htmlCode" spellcheck="false" placeholder="<!-- ËæìÂÖ• HTML ÁªìÊûÑ -->"></textarea>
                    </div>
                    
                    <div class="pane-label" style="background:rgba(100, 200, 255, 0.1);">
                        <span>CSS &lt;style&gt;</span>
                    </div>
                    <div class="editor-wrapper" style="flex:1;">
                        <div class="line-numbers" id="ln-css">1</div>
                        <textarea id="cssCode" spellcheck="false" placeholder="/* ËæìÂÖ• CSS Ê†∑Âºè */"></textarea>
                    </div>
                    
                    <div class="pane-label" style="background:rgba(255, 255, 100, 0.1);">
                        <span>JS &lt;script&gt;</span>
                    </div>
                    <div class="editor-wrapper" style="flex:1;">
                        <div class="line-numbers" id="ln-js">1</div>
                        <textarea id="jsCode" spellcheck="false" placeholder="// ËæìÂÖ• JavaScript ‰ª£Á†Å"></textarea>
                    </div>
                </div>

            </div>

            <div class="preview-container">
                <div class="pane-label" style="display:flex; justify-content:space-between;">
                    <span>Live Preview</span>
                    <span class="theme-toggle" onclick="cycleTheme()" title="ÂàáÊç¢‰∏ªÈ¢òÈÖçËâ≤ (Switch Theme)">üé®</span>
                </div>
                <iframe id="previewFrame"></iframe>
                <div id="consolePane" class="console-pane collapsed">
                    <div class="console-header" onclick="toggleConsole()">
                        <span>Console Output</span>
                        <div>
                            <button onclick="event.stopPropagation(); clearConsole()" style="padding:2px 6px; font-size:10px;">üö´ Clear</button>
                            <span id="consoleToggleIcon">‚ñ≤</span>
                        </div>
                    </div>
                    <div id="consoleOutput" class="console-output"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- LZ-String Library (Inlined for portability) -->
    <script>
    var LZString = (function() {
      var f = String.fromCharCode;
      var keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
      var baseReverseDic = {};

      function getBaseValue(alphabet, character) {
        if (!baseReverseDic[alphabet]) {
          baseReverseDic[alphabet] = {};
          for (var i = 0; i < alphabet.length; i++) {
            baseReverseDic[alphabet][alphabet.charAt(i)] = i;
          }
        }
        return baseReverseDic[alphabet][character];
      }

      var LZString = {
        compressToEncodedURIComponent: function(input) {
          if (input == null) return "";
          return LZString._compress(input, 6, function(a) { return keyStrUriSafe.charAt(a); });
        },
        decompressFromEncodedURIComponent: function(input) {
          if (input == null) return "";
          if (input == "") return null;
          input = input.replace(/ /g, "+");
          return LZString._decompress(input.length, 32, function(index) { return getBaseValue(keyStrUriSafe, input.charAt(index)); });
        },
        _compress: function(uncompressed, bitsPerChar, getCharFromInt) {
          if (uncompressed == null) return "";
          var i, value, context_dictionary = {}, context_dictionaryToCreate = {}, context_c = "", context_wc = "", context_w = "", context_enlargeIn = 2, context_dictSize = 3, context_numBits = 2, context_data = [], context_data_val = 0, context_data_position = 0, ii;

          for (ii = 0; ii < uncompressed.length; ii += 1) {
            context_c = uncompressed.charAt(ii);
            if (!Object.prototype.hasOwnProperty.call(context_dictionary, context_c)) {
              context_dictionary[context_c] = context_dictSize++;
              context_dictionaryToCreate[context_c] = true;
            }
            context_wc = context_w + context_c;
            if (Object.prototype.hasOwnProperty.call(context_dictionary, context_wc)) {
              context_w = context_wc;
            } else {
              if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
                if (context_w.charCodeAt(0) < 256) {
                  for (i = 0; i < context_numBits; i++) {
                    context_data_val = (context_data_val << 1);
                    if (context_data_position == bitsPerChar - 1) {
                      context_data_position = 0;
                      context_data.push(getCharFromInt(context_data_val));
                      context_data_val = 0;
                    } else {
                      context_data_position++;
                    }
                  }
                  value = context_w.charCodeAt(0);
                  for (i = 0; i < 8; i++) {
                    context_data_val = (context_data_val << 1) | (value & 1);
                    if (context_data_position == bitsPerChar - 1) {
                      context_data_position = 0;
                      context_data.push(getCharFromInt(context_data_val));
                      context_data_val = 0;
                    } else {
                      context_data_position++;
                    }
                    value = value >> 1;
                  }
                } else {
                  value = 1;
                  for (i = 0; i < context_numBits; i++) {
                    context_data_val = (context_data_val << 1) | value;
                    if (context_data_position == bitsPerChar - 1) {
                      context_data_position = 0;
                      context_data.push(getCharFromInt(context_data_val));
                      context_data_val = 0;
                    } else {
                      context_data_position++;
                    }
                    value = 0;
                  }
                  value = context_w.charCodeAt(0);
                  for (i = 0; i < 16; i++) {
                    context_data_val = (context_data_val << 1) | (value & 1);
                    if (context_data_position == bitsPerChar - 1) {
                      context_data_position = 0;
                      context_data.push(getCharFromInt(context_data_val));
                      context_data_val = 0;
                    } else {
                      context_data_position++;
                    }
                    value = value >> 1;
                  }
                }
                context_enlargeIn--;
                if (context_enlargeIn == 0) {
                  context_enlargeIn = Math.pow(2, context_numBits);
                  context_numBits++;
                }
                delete context_dictionaryToCreate[context_w];
              } else {
                value = context_dictionary[context_w];
                for (i = 0; i < context_numBits; i++) {
                  context_data_val = (context_data_val << 1) | (value & 1);
                  if (context_data_position == bitsPerChar - 1) {
                    context_data_position = 0;
                    context_data.push(getCharFromInt(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                  value = value >> 1;
                }
              }
              context_enlargeIn--;
              if (context_enlargeIn == 0) {
                context_enlargeIn = Math.pow(2, context_numBits);
                context_numBits++;
              }
              context_dictionary[context_wc] = context_dictSize++;
              context_w = String(context_c);
            }
          }

          if (context_w !== "") {
            if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
              if (context_w.charCodeAt(0) < 256) {
                for (i = 0; i < context_numBits; i++) {
                  context_data_val = (context_data_val << 1);
                  if (context_data_position == bitsPerChar - 1) {
                    context_data_position = 0;
                    context_data.push(getCharFromInt(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                }
                value = context_w.charCodeAt(0);
                for (i = 0; i < 8; i++) {
                  context_data_val = (context_data_val << 1) | (value & 1);
                  if (context_data_position == bitsPerChar - 1) {
                    context_data_position = 0;
                    context_data.push(getCharFromInt(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                  value = value >> 1;
                }
              } else {
                value = 1;
                for (i = 0; i < context_numBits; i++) {
                  context_data_val = (context_data_val << 1) | value;
                  if (context_data_position == bitsPerChar - 1) {
                    context_data_position = 0;
                    context_data.push(getCharFromInt(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                  value = 0;
                }
                value = context_w.charCodeAt(0);
                for (i = 0; i < 16; i++) {
                  context_data_val = (context_data_val << 1) | (value & 1);
                  if (context_data_position == bitsPerChar - 1) {
                    context_data_position = 0;
                    context_data.push(getCharFromInt(context_data_val));
                    context_data_val = 0;
                  } else {
                    context_data_position++;
                  }
                  value = value >> 1;
                }
              }
              context_enlargeIn--;
              if (context_enlargeIn == 0) {
                context_enlargeIn = Math.pow(2, context_numBits);
                context_numBits++;
              }
              delete context_dictionaryToCreate[context_w];
            } else {
              value = context_dictionary[context_w];
              for (i = 0; i < context_numBits; i++) {
                context_data_val = (context_data_val << 1) | (value & 1);
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else {
                  context_data_position++;
                }
                value = value >> 1;
              }
            }
            context_enlargeIn--;
            if (context_enlargeIn == 0) {
              context_enlargeIn = Math.pow(2, context_numBits);
              context_numBits++;
            }
          }

          value = 2;
          for (i = 0; i < context_numBits; i++) {
            context_data_val = (context_data_val << 1) | (value & 1);
            if (context_data_position == bitsPerChar - 1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
            value = value >> 1;
          }

          while (true) {
            context_data_val = (context_data_val << 1);
            if (context_data_position == bitsPerChar - 1) {
              context_data.push(getCharFromInt(context_data_val));
              break;
            } else context_data_position++;
          }
          return context_data.join('');
        },
        _decompress: function(length, resetValue, getNextValue) {
          var dictionary = [], next, enlargeIn = 4, dictSize = 4, numBits = 3, entry = "", result = [], i, w, bits, resb, maxpower, power, c, data = {val: getNextValue(0), position: resetValue, index: 1};

          for (i = 0; i < 3; i += 1) {
            dictionary[i] = i;
          }

          bits = 0;
          maxpower = Math.pow(2, 2);
          power = 1;
          while (power != maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position == 0) {
              data.position = resetValue;
              data.val = getNextValue(data.index++);
            }
            bits |= (resb > 0 ? 1 : 0) * power;
            power <<= 1;
          }

          switch (next = bits) {
            case 0:
              bits = 0;
              maxpower = Math.pow(2, 8);
              power = 1;
              while (power != maxpower) {
                resb = data.val & data.position;
                data.position >>= 1;
                if (data.position == 0) {
                  data.position = resetValue;
                  data.val = getNextValue(data.index++);
                }
                bits |= (resb > 0 ? 1 : 0) * power;
                power <<= 1;
              }
              c = f(bits);
              break;
            case 1:
              bits = 0;
              maxpower = Math.pow(2, 16);
              power = 1;
              while (power != maxpower) {
                resb = data.val & data.position;
                data.position >>= 1;
                if (data.position == 0) {
                  data.position = resetValue;
                  data.val = getNextValue(data.index++);
                }
                bits |= (resb > 0 ? 1 : 0) * power;
                power <<= 1;
              }
              c = f(bits);
              break;
            case 2:
              return "";
          }
          dictionary[3] = c;
          w = c;
          result.push(c);
          while (true) {
            if (data.index > length) {
              return "";
            }

            bits = 0;
            maxpower = Math.pow(2, numBits);
            power = 1;
            while (power != maxpower) {
              resb = data.val & data.position;
              data.position >>= 1;
              if (data.position == 0) {
                data.position = resetValue;
                data.val = getNextValue(data.index++);
              }
              bits |= (resb > 0 ? 1 : 0) * power;
              power <<= 1;
            }

            switch (c = bits) {
              case 0:
                bits = 0;
                maxpower = Math.pow(2, 8);
                power = 1;
                while (power != maxpower) {
                  resb = data.val & data.position;
                  data.position >>= 1;
                  if (data.position == 0) {
                    data.position = resetValue;
                    data.val = getNextValue(data.index++);
                  }
                  bits |= (resb > 0 ? 1 : 0) * power;
                  power <<= 1;
                }
                dictionary[dictSize++] = f(bits);
                c = dictSize - 1;
                enlargeIn--;
                break;
              case 1:
                bits = 0;
                maxpower = Math.pow(2, 16);
                power = 1;
                while (power != maxpower) {
                  resb = data.val & data.position;
                  data.position >>= 1;
                  if (data.position == 0) {
                    data.position = resetValue;
                    data.val = getNextValue(data.index++);
                  }
                  bits |= (resb > 0 ? 1 : 0) * power;
                  power <<= 1;
                }
                dictionary[dictSize++] = f(bits);
                c = dictSize - 1;
                enlargeIn--;
                break;
              case 2:
                return result.join('');
            }

            if (enlargeIn == 0) {
              enlargeIn = Math.pow(2, numBits);
              numBits++;
            }

            if (dictionary[c]) {
              entry = dictionary[c];
            } else {
              if (c === dictSize) {
                entry = w + w.charAt(0);
              } else {
                return null;
              }
            }
            result.push(entry);

            dictionary[dictSize++] = w + entry.charAt(0);
            enlargeIn--;

            w = entry;

            if (enlargeIn == 0) {
              enlargeIn = Math.pow(2, numBits);
              numBits++;
            }
          }
        }
      };
      return LZString;
    })();
    </script>
    <script>
        const sourceCode = document.getElementById('sourceCode');
        const htmlCode = document.getElementById('htmlCode');
        const cssCode = document.getElementById('cssCode');
        const jsCode = document.getElementById('jsCode');
        
        const singlePane = document.getElementById('singleModePane');
        const splitPane = document.getElementById('splitModePane');
        const modeBtn = document.getElementById('modeBtn');
        
        const iframe = document.getElementById('previewFrame');
        const runBtn = document.getElementById('runBtn');
        const themeNameLabel = document.getElementById('themeName');
        const filenameInput = document.getElementById('filenameInput');
        
        let isSplitMode = false;
        
        // Capture initial code for reset
        const INITIAL_SOURCE = sourceCode.value;

        // --- Line Numbers Logic ---
        function updateLineNumbers(textarea, lnContainer) {
            const lines = textarea.value.split('\n').length;
            lnContainer.innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>');
            // Sync scroll
            lnContainer.scrollTop = textarea.scrollTop;
        }

        // Attach line number events
        const editorPairs = [
            { ta: sourceCode, ln: document.getElementById('ln-source') },
            { ta: htmlCode, ln: document.getElementById('ln-html') },
            { ta: cssCode, ln: document.getElementById('ln-css') },
            { ta: jsCode, ln: document.getElementById('ln-js') }
        ];

        editorPairs.forEach(pair => {
            const update = () => updateLineNumbers(pair.ta, pair.ln);
            pair.ta.addEventListener('input', update);
            pair.ta.addEventListener('scroll', () => {
                pair.ln.scrollTop = pair.ta.scrollTop;
            });
            // Initial update
            update();
        });

        // --- Theme Management ---
        const themes = [
            { // Violet (Default)
                name: 'Violet',
                '--bg-color': '#0f0c29',
                '--accent-color': '#7b2cbf',
                '--accent-glow': '#9d4edd',
                orb1: '#7b2cbf', orb2: '#3c096c', orb3: '#5a189a',
                bgGradient: 'radial-gradient(circle at 0% 0%, #301847 0%, #0f0c29 50%, #000000 100%)'
            },
            { // Black
                name: 'Black',
                '--bg-color': '#000000',
                '--accent-color': '#444444',
                '--accent-glow': '#666666',
                orb1: '#222222', orb2: '#111111', orb3: '#333333',
                bgGradient: 'radial-gradient(circle at 0% 0%, #1a1a1a 0%, #000000 50%, #000000 100%)'
            },
            { // White
                name: 'White',
                '--bg-color': '#ffffff',
                '--accent-color': '#666666',
                '--accent-glow': '#aaaaaa',
                orb1: '#dddddd', orb2: '#eeeeee', orb3: '#cccccc',
                bgGradient: 'radial-gradient(circle at 0% 0%, #f0f0f0 0%, #ffffff 50%, #e0e0e0 100%)'
            },
            { // Red
                name: 'Red',
                '--bg-color': '#2a0a0a',
                '--accent-color': '#e63946',
                '--accent-glow': '#ff6b6b',
                orb1: '#e63946', orb2: '#9d0208', orb3: '#ff0000',
                bgGradient: 'radial-gradient(circle at 0% 0%, #4a0a0a 0%, #1a0505 50%, #000000 100%)'
            },
            { // Orange
                name: 'Orange',
                '--bg-color': '#2a150a',
                '--accent-color': '#fb8500',
                '--accent-glow': '#ffb703',
                orb1: '#fb8500', orb2: '#e85d04', orb3: '#ffba08',
                bgGradient: 'radial-gradient(circle at 0% 0%, #4a250a 0%, #1a0e05 50%, #000000 100%)'
            },
            { // Yellow
                name: 'Yellow',
                '--bg-color': '#2a250a',
                '--accent-color': '#ffb703',
                '--accent-glow': '#ffd000',
                orb1: '#ffb703', orb2: '#fb8500', orb3: '#ffee32',
                bgGradient: 'radial-gradient(circle at 0% 0%, #4a400a 0%, #1a1805 50%, #000000 100%)'
            },
            { // Green
                name: 'Green',
                '--bg-color': '#0a2a1a',
                '--accent-color': '#2a9d8f',
                '--accent-glow': '#48cae4',
                orb1: '#2a9d8f', orb2: '#264653', orb3: '#2ec4b6',
                bgGradient: 'radial-gradient(circle at 0% 0%, #0a4a2a 0%, #051a10 50%, #000000 100%)'
            },
            { // Blue
                name: 'Blue',
                '--bg-color': '#0a1f2a',
                '--accent-color': '#0096c7',
                '--accent-glow': '#48cae4',
                orb1: '#0096c7', orb2: '#023e8a', orb3: '#00b4d8',
                bgGradient: 'radial-gradient(circle at 0% 0%, #0a3a4a 0%, #05151a 50%, #000000 100%)'
            },
            { // Indigo
                name: 'Indigo',
                '--bg-color': '#0a0e2a',
                '--accent-color': '#4361ee',
                '--accent-glow': '#4cc9f0',
                orb1: '#4361ee', orb2: '#3f37c9', orb3: '#4895ef',
                bgGradient: 'radial-gradient(circle at 0% 0%, #1a1a4a 0%, #05051a 50%, #000000 100%)'
            }
        ];

        let currentThemeIndex = 0;

        function cycleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            const theme = themes[currentThemeIndex];
            
            const root = document.documentElement;
            root.style.setProperty('--bg-color', theme['--bg-color']);
            root.style.setProperty('--accent-color', theme['--accent-color']);
            root.style.setProperty('--accent-glow', theme['--accent-glow']);
            
            document.body.style.background = theme.bgGradient;
            
            document.querySelector('.orb-1').style.background = theme.orb1;
            document.querySelector('.orb-2').style.background = theme.orb2;
            document.querySelector('.orb-3').style.background = theme.orb3;
            
            // Handle White Theme Text Color
            if (theme.name === 'White') {
                document.documentElement.style.setProperty('--text-main', '#333333');
                document.documentElement.style.setProperty('--text-muted', '#666666');
            } else {
                document.documentElement.style.setProperty('--text-main', '#e0e0e0');
                document.documentElement.style.setProperty('--text-muted', '#a0a0a0');
            }

            themeNameLabel.innerText = `| ${theme.name} Mica`;
        }

        // --- Console Logic ---
        const consolePane = document.getElementById('consolePane');
        const consoleOutput = document.getElementById('consoleOutput');
        const consoleToggleIcon = document.getElementById('consoleToggleIcon');

        function toggleConsole() {
            consolePane.classList.toggle('collapsed');
            consoleToggleIcon.innerText = consolePane.classList.contains('collapsed') ? '‚ñ≤' : '‚ñº';
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        function appendLog(level, msg) {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level}`;
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'console') {
                appendLog(event.data.level, event.data.msg);
            }
        });

        function buildFullCode(injectConsole = false) {
            let code = '';
            
            // 1. Construct the base code (from split or single)
            if (isSplitMode) {
                code = `<!` + `DOCTYPE html>
<` + `html>
<` + `head>
<` + `style>
${cssCode.value}
</` + `style>
</` + `head>
<` + `body>

${htmlCode.value}

<scr` + `ipt>
${jsCode.value}
</scr` + `ipt>

</` + `body>
</` + `html>`;
            } else {
                code = sourceCode.value;
            }
            
            // 2. Optional Console Injection
            if (injectConsole) {
                const consoleScript = `
<scr` + `ipt>
    (function(){
        // Prevent duplicate wrapping
        if (window.console.__isWrapped) return;
        
        const oldLog = console.log;
        const oldError = console.error;
        const oldWarn = console.warn;
        
        function send(type, args) {
            try {
                const msg = args.map(arg => {
                    if (typeof arg === 'object') return JSON.stringify(arg);
                    return String(arg);
                }).join(' ');
                window.parent.postMessage({type: 'console', level: type, msg: msg}, '*');
            } catch(e) {}
        }

        console.log = function(...args) { oldLog.apply(console, args); send('info', args); };
        console.error = function(...args) { oldError.apply(console, args); send('error', args); };
        console.warn = function(...args) { oldWarn.apply(console, args); send('warn', args); };
        console.__isWrapped = true;
    })();
</scr` + `ipt>
`;
                // Inject before closing body or html
                if (code.includes('</` + `body>')) {
                    code = code.replace('</` + `body>', `${consoleScript}</` + `body>`);
                } else if (code.includes('</` + `html>')) {
                    code = code.replace('</` + `html>', `${consoleScript}</` + `html>`);
                } else {
                    code += consoleScript;
                }
            }
            
            return code;
        }

        // --- Core Functions ---

        function updateSplitEditors(fullCode) {
            // Extract Style
            const styleMatch = fullCode.match(/<style[^>]*>([\s\S]*?)<\/style>/i);
            cssCode.value = styleMatch ? styleMatch[1].trim() : '';
            
            // Extract Script
            const scriptMatch = fullCode.match(/<script[^>]*>([\s\S]*?)<\/script>/i);
            jsCode.value = scriptMatch ? scriptMatch[1].trim() : '';
            
            // Extract Body (Rough approximation: remove style/script and html/head/body tags)
            let bodyContent = fullCode
                .replace(/<style[^>]*>[\s\S]*?<\/style>/ig, '')
                .replace(/<script[^>]*>[\s\S]*?<\/script>/ig, '')
                .replace(/<!DOCTYPE html>/i, '')
                .replace(/<html>/i, '')
                .replace(/<\/html>/i, '')
                .replace(/<head>[\s\S]*?<\/head>/i, '') // Remove head if separate
                .replace(/<body>/i, '')
                .replace(/<\/body>/i, '')
                .trim();
            
            htmlCode.value = bodyContent;
            
            // Trigger line number updates
            setTimeout(() => {
                updateLineNumbers(htmlCode, document.getElementById('ln-html'));
                updateLineNumbers(cssCode, document.getElementById('ln-css'));
                updateLineNumbers(jsCode, document.getElementById('ln-js'));
            }, 0);
        }

        function toggleMode() {
            isSplitMode = !isSplitMode;
            
            if (isSplitMode) {
                // Switching to Split Mode: Extract code
                modeBtn.innerText = "ÂàáËá≥ÂçïÁ™óÂè£";
                singlePane.style.display = 'none';
                splitPane.style.display = 'flex';
                
                updateSplitEditors(sourceCode.value);
                
            } else {
                // Switching to Single Mode: Combine code
                modeBtn.innerText = "‚ó´ ÂàáËá≥‰∏âÁ™óÂè£";
                splitPane.style.display = 'none';
                singlePane.style.display = 'flex';
                
                // Use the shared builder (without console injection)
                sourceCode.value = buildFullCode(false);
                
                // Trigger line number update
                setTimeout(() => {
                    updateLineNumbers(sourceCode, document.getElementById('ln-source'));
                }, 0);
            }
            updatePreview();
        }

        // Deprecated: old getFullCode() logic is now in buildFullCode()
        // We keep this wrapper for backward compatibility if needed, or replace usages
        function getFullCode() {
             return buildFullCode(true); // Default behavior for run/preview
        }

        function runCode() {
            updatePreview();
            
            const originalText = runBtn.innerText;
            runBtn.innerText = "‚úî Â∑≤ËøêË°å";
            setTimeout(() => {
                runBtn.innerText = "‚ñ∂ ËøêË°å";
            }, 1000);
        }

        function updatePreview() {
            const code = getFullCode();
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(code);
            iframeDoc.close();
        }

        function copyCode() {
            const code = getFullCode();
            navigator.clipboard.writeText(code).then(() => {
                alert('‰ª£Á†ÅÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
            });
        }

        function resetCode() {
            if (!confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰ª£Á†ÅÂêóÔºüÊâÄÊúâ‰øÆÊîπÂ∞Ü‰∏¢Â§±„ÄÇ')) return;
            
            if (isSplitMode) {
                updateSplitEditors(INITIAL_SOURCE);
                // Also update sourceCode to keep state consistent, though hidden
                sourceCode.value = INITIAL_SOURCE;
            } else {
                sourceCode.value = INITIAL_SOURCE;
                // Update line numbers
                setTimeout(() => updateLineNumbers(sourceCode, document.getElementById('ln-source')), 0);
            }
            updatePreview();
        }

        function exportCode() {
            const code = getFullCode();
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            let filename = filenameInput.value.trim();
            if (!filename) filename = 'exported_project';
            if (!filename.toLowerCase().endsWith('.html')) filename += '.html';
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function openNewTab() {
            const code = getFullCode();
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.open();
                newWindow.document.write(code);
                newWindow.document.close();
                newWindow.document.title = "Code Runner Preview";
            } else {
                alert("ËØ∑ÂÖÅËÆ∏ÂºπÂá∫Á™óÂè£‰ª•Âú®Êñ∞Ê†áÁ≠æÈ°µ‰∏≠È¢ÑËßà„ÄÇ");
            }
        }
        
        function shareCode() {
            let rawCode = buildFullCode(false); // Get code without console injection

            try {
                let encoded = "";
                // Try LZString compression if available
                if (typeof LZString !== 'undefined') {
                    encoded = LZString.compressToEncodedURIComponent(rawCode);
                } else {
                    // Fallback to Base64
                    encoded = btoa(unescape(encodeURIComponent(rawCode)));
                }
                
                const url = window.location.origin + window.location.pathname + '?code=' + encodeURIComponent(encoded);
                
                // Check length limits (approximate URL limit 2048 chars for safety)
                if (url.length > 8000) {
                    if(!confirm("ÁîüÊàêÁöÑÈìæÊé•ÈùûÂ∏∏Èïø (" + url.length + " Â≠óÁ¨¶)ÔºåÂèØËÉΩÊó†Ê≥ïÂú®Êüê‰∫õÊµèËßàÂô®ÊàñÂ∫îÁî®‰∏≠ÊâìÂºÄ„ÄÇÊòØÂê¶ÁªßÁª≠Â§çÂà∂Ôºü")) {
                        return;
                    }
                }

                navigator.clipboard.writeText(url).then(() => {
                    const method = typeof LZString !== 'undefined' ? 'LZString Compressed' : 'Base64';
                    alert(`ÂàÜ‰∫´ÈìæÊé•Â∑≤Â§çÂà∂ÔºÅ(${method})`);
                });
            } catch (e) {
                alert('ÁîüÊàêÂàÜ‰∫´ÈìæÊé•Â§±Ë¥•: ' + e.message);
            }
        }

        // Check for shared code on load
        function loadSharedCode() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('code')) {
                try {
                    const encoded = params.get('code');
                    let decoded = "";
                    
                    // Try LZString decompression first
                    if (typeof LZString !== 'undefined') {
                        // LZString.compressToEncodedURIComponent was used, so we use decompressFromEncodedURIComponent
                        // URLSearchParams already decoded the % encoding for us, so we have the raw LZString output (which may contain +)
                        decoded = LZString.decompressFromEncodedURIComponent(encoded);
                    }
                    
                    // If LZString failed or wasn't used (returns null/empty), try Base64 fallback
                    if (!decoded) {
                         try {
                            // Base64 was also component encoded, params.get() decoded it once.
                            // Standard Base64 might still need care but btoa/atob should be fine if it was valid base64
                            decoded = decodeURIComponent(escape(atob(encoded)));
                         } catch(e) {
                             console.warn("Base64 decode failed", e);
                         }
                    }

                    if (decoded || decoded === '') {
                        sourceCode.value = decoded;
                        // Clear split editors just in case
                        htmlCode.value = ''; cssCode.value = ''; jsCode.value = '';
                        // Default to single mode is fine as sourceCode is populated
                        console.log("Shared code loaded.");
                    } else {
                        throw new Error("Decoding returned null/undefined");
                    }
                } catch (e) {
                    console.error("Failed to load shared code", e);
                    alert("Êó†Ê≥ïÂä†ËΩΩÂàÜ‰∫´ÁöÑ‰ª£Á†ÅÔºöËß£ÊûêÂ§±Ë¥•„ÄÇ\n" + e.message);
                }
            }
        }

        // Clear editor helper for internal button
        window.clearEditor = function() {
            if (isSplitMode) {
                htmlCode.value = '';
                cssCode.value = '';
                jsCode.value = '';
            } else {
                sourceCode.value = '';
            }
            updatePreview();
        };

        // Event Listeners for Auto-Run
        [sourceCode, htmlCode, cssCode, jsCode].forEach(el => {
            let timeout;
            el.addEventListener('keyup', () => {
                clearTimeout(timeout);
                timeout = setTimeout(updatePreview, 800);
            });
            
            // Tab support & Smart Indent & Auto Close
            el.addEventListener('keydown', function(e) {
                if (e.key == 'Tab') {
                    e.preventDefault();
                    var start = this.selectionStart;
                    var end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + "\t" + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 1;
                } else if (e.key == 'Enter') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    const value = this.value;
                    
                    // Find current line indent
                    const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                    const line = value.substring(lineStart, start);
                    const match = line.match(/^\s*/);
                    const indent = match ? match[0] : '';
                    
                    // Check if we are inside a block that needs extra indent (simple heuristic)
                    const lastChar = line.trim().slice(-1);
                    const extraIndent = (lastChar === '{' || lastChar === '(' || lastChar === '[') ? '\t' : '';
                    
                    const insert = '\n' + indent + extraIndent;
                    
                    this.value = value.substring(0, start) + insert + value.substring(end);
                    this.selectionStart = this.selectionEnd = start + insert.length;
                    
                    // If we created an extra indent, should we add a closing brace line?
                    // E.g. {<Enter> becomes:
                    // {
                    //    |
                    // }
                    // Simple check: if next char is closing brace
                    if (extraIndent && value[end] === getClosingPair(lastChar)) {
                        const closingInsert = '\n' + indent;
                        this.value = this.value.substring(0, this.selectionStart) + closingInsert + this.value.substring(this.selectionStart);
                        // Cursor stays inside
                    }
                } else {
                    // Auto Close Pairs
                    const pairs = { '(': ')', '{': '}', '[': ']', '"': '"', "'": "'", '<': '>' };
                    if (pairs[e.key]) {
                        e.preventDefault();
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        const close = pairs[e.key];
                        
                        // If selecting text, wrap it
                        if (start !== end) {
                            const text = this.value.substring(start, end);
                            this.value = this.value.substring(0, start) + e.key + text + close + this.value.substring(end);
                            this.selectionStart = start; 
                            this.selectionEnd = end + 2;
                        } else {
                            this.value = this.value.substring(0, start) + e.key + close + this.value.substring(end);
                            this.selectionStart = this.selectionEnd = start + 1;
                        }
                    }
                }
            });
        });
        
        function getClosingPair(char) {
            if (char === '{') return '}';
            if (char === '(') return ')';
            if (char === '[') return ']';
            return '';
        }

        // Initial Run
        window.addEventListener('DOMContentLoaded', () => {
            loadSharedCode();
            updatePreview();
        });

    </script>
</body>
</html>