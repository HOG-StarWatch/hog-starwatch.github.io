<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repo Explorer</title>
    <script src="jszip.min.js" onerror="this.onerror=function(){this.onerror=null;this.src='https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';};this.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';"></script>
    <style>
        :root{--bg:#0d1117;--text:#c9d1d9;--border:#30363d;--hover:#161b22;--link:#58a6ff;--inp-bg:#0d1117;--inp-bd:#30363d;--btn-bg:#238636;--btn-tx:#fff;--btn-hv:#2ea043;--panel:#161b22;--act-bg:#21262d;--act-bd:#30363d;--text-dim: #8b949e;--highlight: #1f6feb;}
        ::-webkit-scrollbar{width:6px;height:6px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:rgba(48, 54, 61, 0.6);border-radius:3px}
        ::-webkit-scrollbar-thumb:hover{background:rgba(88, 166, 255, 0.4)}
        
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem;background:var(--bg);color:var(--text);transition:0.3s;position:relative}
        
        /* Header & API Status */
        .header-row{display:flex;justify-content:center;align-items:center;position:relative;margin-bottom:2rem}
        h3{font-weight:300;letter-spacing:1px;color:var(--text);margin:0;font-size: 1.5rem;}
        .api-status{position:absolute;right:0;top:50%;transform:translateY(-50%);width:10px;height:10px;border-radius:50%;background:#8b949e;cursor:help;transition:0.3s;opacity: 0.7;}
        .api-status[data-level="high"]{background:#3fb950;box-shadow:0 0 8px rgba(63,185,80,0.4)}
        .api-status[data-level="medium"]{background:#d29922;box-shadow:0 0 8px rgba(210,153,34,0.4)}
        .api-status[data-level="low"]{background:#f85149;box-shadow:0 0 8px rgba(248,81,73,0.4)}

        /* Minimalist Capsule Search */
        .capsule-search{display:flex;align-items:center;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:50px;padding:4px 6px 4px 15px;margin-bottom:30px;transition:0.2s;max-width:600px;margin-left:auto;margin-right:auto; backdrop-filter: blur(5px);}
        .capsule-search:focus-within{border-color:var(--link);box-shadow:0 0 0 2px rgba(88,166,255,0.1); background:rgba(255,255,255,0.05);}
        .capsule-search input{border:none;background:transparent;padding:8px;margin:0;outline:none;box-shadow:none;font-size:14px;width:100%;color:var(--text);}
        .capsule-search button{border-radius:40px;padding:6px 16px;margin:0;border:none;font-size: 13px;}

        input,select{width:100%;padding:10px 0;margin-bottom:15px;border:none;border-bottom:1px solid var(--border);background:transparent;color:var(--text);outline:none;transition:0.2s;box-sizing:border-box;border-radius:0;}
        input:focus,select:focus{border-bottom-color:var(--link)}
        
        button{padding:8px 16px;background:var(--btn-bg);color:var(--btn-tx);border:none;border-radius:4px;cursor:pointer;font-weight:500;transition:0.2s;font-size: 13px;}
        button:hover{background:var(--btn-hv);transform:translateY(-1px);}
        button:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
        
        .tree-view{margin-top:20px;border:1px solid var(--border);border-radius:8px;padding:10px;max-height:70vh;overflow-y:auto;display:none;background:rgba(22, 27, 34, 0.5);}
        
        /* Tree Item Styles */
        .tree-item { display: flex; align-items: center; padding: 5px 8px; border-radius: 4px; cursor: pointer; user-select: none; transition: all 0.15s ease; margin-bottom: 1px; }
        .tree-item:hover { background: rgba(255,255,255,0.05); }
        .tree-item input[type="checkbox"] { margin-right: 10px; width: 14px; height: 14px; accent-color: var(--link); cursor: pointer; border-radius: 3px; opacity: 0.7; }
        .tree-item input[type="checkbox"]:checked { opacity: 1; }
        .tree-item svg { fill: var(--text-dim); margin-right: 8px; width: 16px; height: 16px; min-width: 16px; transition: 0.2s; }
        .tree-item:hover svg { fill: var(--text); }
        .tree-item span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px; }
        
        .tree-content { display: flex; align-items: center; justify-content: space-between; width: 100%; padding-right: 5px; white-space: nowrap; }
        .tree-item-left { display: flex; align-items: center; overflow: hidden; height: auto; min-height: 24px; }
        .file-name { font-size: 13px; color: var(--text); margin-left: 2px; line-height: 1.5; opacity: 0.9; }
        
        .action-btn { margin-left: 8px; padding: 2px 8px; font-size: 11px; border: 1px solid var(--border); border-radius: 12px; cursor: pointer; background: transparent; color: var(--text-dim); transition: 0.2s; opacity: 0; }
        .tree-item:hover .action-btn { opacity: 1; }
        .action-btn:hover { background: var(--link); color: #fff; border-color: var(--link); }
        
        .settings-toggle { font-size: 12px; color: var(--text-dim); cursor: pointer; margin-bottom: 10px; display: inline-block; opacity: 0.6; user-select: none; transition: 0.2s; }
        .settings-toggle:hover { opacity: 1; color: var(--link); }
        .settings-toggle::before { content: 'â–¸'; display: inline-block; margin-right: 5px; font-size: 12px; transition: transform 0.2s; }
        .settings-toggle.open::before { transform: rotate(90deg); }
        .settings-panel { display: none; padding: 20px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; }
        
        .progress-container { margin-top: 20px; display: none; }.progress-bar-bg{width:100%;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
        .console-log { margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 8px; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 11px; color: var(--text-dim); max-height: 150px; overflow-y: auto; display: none; white-space: pre-wrap; word-break: break-all; }
        .progress-bar-fill { height: 100%; background: var(--link); width: 0%; transition: width 0.2s; }
        .file-progress-wrap { width: 50px; height: 3px; background: rgba(255,255,255,0.1); margin-left: 8px; border-radius: 2px; overflow: hidden; display: inline-block; vertical-align: middle; }
        .file-progress-bar { width: 0%; height: 100%; background: #2ea44f; transition: width 0.3s; }
        
        details > summary { cursor: pointer; list-style: none; user-select: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        /* Select Dark Mode */
        #ref-selector { background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 5px; }
        #ref-selector option { background: var(--bg); color: var(--text); }

        /* Focused Tree Item */
        .tree-item:focus { outline: none; background: rgba(88, 166, 255, 0.2) !important; }
        
        .children-container { margin-left: 18px; border-left: 1px solid rgba(48, 54, 61, 0.4); padding-left: 0 !important; }

        /* Modals & Glassmorphism */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;display:none;justify-content:center;align-items:center;backdrop-filter:blur(5px);transition:opacity 0.2s;}
        .modal-content{background:rgba(22, 27, 34, 0.85);width:90%;max-width:1000px;height:80vh;border-radius:16px;border:1px solid rgba(255,255,255,0.1);display:flex;flex-direction:column;position:relative;box-shadow:0 20px 50px rgba(0,0,0,0.5);backdrop-filter:blur(10px);overflow:hidden;}
        .modal-header{padding:15px 25px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.02);}
        .modal-body{flex:1;overflow:auto;padding:25px;background:transparent;}
        .close-modal{cursor:pointer;font-size:24px;color:var(--text-dim);width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:0.2s;}
        .close-modal:hover{color:var(--text);background:rgba(255,255,255,0.1);}
        
        /* Minimalist Inputs */
        input.minimal-input, select.minimal-input {
            width: 100%; padding: 10px 0; margin-bottom: 15px; border: none; border-bottom: 1px solid var(--border);
            background: transparent; color: var(--text); outline: none; transition: 0.3s; border-radius: 0; font-size: 14px;
        }
        input.minimal-input:focus, select.minimal-input:focus { border-bottom-color: var(--link); }
        select.minimal-input option { background: var(--bg); color: var(--text); }

        /* Search Button Border */
        #btn-search-file { border-color: var(--border); }
        
        /* Breadcrumbs (Reverted to simple style) */
        .breadcrumbs-container{display:flex;align-items:center;flex-wrap:wrap;gap:5px;margin-bottom:20px;}
        .breadcrumb-item{color:var(--text-dim);cursor:pointer;text-decoration:none;transition:0.2s;font-size:14px;padding:2px 5px; border-radius:4px;}
        .breadcrumb-item:hover{color:var(--link);background:rgba(255,255,255,0.05);}
        .breadcrumb-separator{color:var(--text-dim);font-size:12px;opacity:0.6;margin:0 2px;}

        .tree-view{margin-top:20px;border:1px solid var(--border);border-radius:12px;padding:15px;max-height:70vh;overflow-y:auto;display:none;background:rgba(22, 27, 34, 0.4);}

        .preview-code{font-family:'SFMono-Regular', Consolas, monospace;white-space:pre;color:var(--text); font-size: 13px;}
        .preview-image{max-width:100%;display:block;margin:0 auto}
        .tree-checkbox{margin-right:8px;cursor:pointer;width:14px;height:14px;margin-top:0;vertical-align:middle;display:inline-block}

        .file-size{font-size:11px;color:var(--text-dim);margin-left:10px;min-width:60px;text-align:right; font-family: monospace;}
        .icon-img{width:16px;height:16px;vertical-align:middle;margin-right:5px}
        
        .console-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
        .console-title{font-size:11px;color:var(--text-dim);font-weight:600;text-transform: uppercase; letter-spacing: 0.5px;}
        .console-clear{font-size:11px;color:var(--link);cursor:pointer;opacity: 0.8;}
        .console-clear:hover{opacity: 1; text-decoration: underline;}
        
        details>summary .folder-arrow{display:inline-block;font-size:9px;margin-right:6px;transition:transform 0.2s;color:var(--text-dim); width: 10px; text-align: center;}
        details[open]>summary .folder-arrow{transform:rotate(90deg)}

        /* Discovery Styles */
        .tab-btn { flex:1; padding:10px; border-bottom:2px solid transparent; cursor:pointer; text-align:center; font-size:13px; color:var(--text-dim); transition:0.2s; }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { border-bottom-color:var(--link); color:var(--text); font-weight: 500; }
        
        .repo-card { background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:8px; padding:15px; cursor:pointer; transition:0.2s; display:flex; flex-direction:column; height:180px; }
        .repo-card:hover { transform:translateY(-2px); border-color:var(--link); background:rgba(255,255,255,0.06); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .repo-header { display:flex; justify-content:space-between; margin-bottom:10px; }
        .repo-name { font-weight:600; color:var(--link); word-break:break-all; font-size:14px; }
        .repo-desc { color:var(--text); font-size:12px; line-height:1.5; flex:1; overflow:hidden; display:-webkit-box; -webkit-line-clamp:3; line-clamp:3; -webkit-box-orient:vertical; margin-bottom:10px; opacity:0.7; }
        .repo-meta { display:flex; gap:10px; font-size:11px; color:#8b949e; align-items:center; }
        .meta-item { display:flex; align-items:center; gap:4px; }
        .lang-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
        
        /* Markdown minimal styles */
        .markdown-body { font-size:14px; line-height:1.6; color:var(--text); }
        .markdown-body h1, .markdown-body h2 { border-bottom:1px solid var(--border); padding-bottom:0.3em; margin-top:1em; margin-bottom:10px; }
        .markdown-body a { color:var(--link); text-decoration:none; }
        .markdown-body code { background:rgba(110,118,129,0.4); border-radius:4px; padding:0.2em 0.4em; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 85%; }
        .markdown-body pre { background:#161b22; border-radius:6px; padding:15px; overflow:auto; margin:10px 0; }
        .markdown-body img { max-width:100%; border:1px solid var(--border); border-radius:4px; background:transparent; }

        /* Dashboard / Status Modal Styles */
        .tab-nav { display: flex; border-bottom: 1px solid var(--border); background: transparent; padding: 0 10px; flex-shrink: 0; }
        .tab-item { padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; font-size: 13px; color: var(--text-dim); transition: 0.2s; }
        .tab-item:hover { color: var(--text); }
        .tab-item.active { border-bottom-color: #f78166; color: var(--text); font-weight: 500; }
        .status-tab-content { display: none; flex: 1; overflow-y: auto; padding: 20px; }
        .status-tab-content.active { display: block; }

        /* Activity Timeline */
        .timeline-item { display: flex; gap: 15px; padding-bottom: 25px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: 15px; top: 30px; bottom: 0; width: 1px; background: var(--border); z-index: 0; }
        .timeline-item:last-child::before { display: none; }
        .timeline-icon { width: 30px; height: 30px; border-radius: 50%; background: var(--panel); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; z-index: 1; font-size: 14px; flex-shrink: 0; color: var(--text-dim); }
        .timeline-body { flex: 1; font-size: 13px; background: rgba(255,255,255,0.02); padding: 12px; border-radius: 6px; border: 1px solid var(--border); }
        .timeline-header { display: flex; justify-content: space-between; margin-bottom: 5px; color: var(--text-dim); font-size: 12px; }
        .timeline-user { font-weight: 600; color: var(--text); margin-right: 5px; }
        .timeline-action { color: var(--text); }
        .timeline-ref { font-family: monospace; background: rgba(110,118,129,0.2); padding: 2px 5px; border-radius: 3px; font-size: 11px; color: var(--link); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 20px; text-align: center; transition: 0.2s; }
        .stat-card:hover { border-color: var(--link); }
        .stat-value { font-size: 28px; font-weight: 300; color: var(--text); margin-bottom: 5px; }
        .stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        
        /* Drag Selection Styles */
        .selection-box { position: absolute; border: 1px solid rgba(88, 166, 255, 0.5); background: rgba(88, 166, 255, 0.1); pointer-events: none; z-index: 9999; display: none; border-radius: 2px; }
        .tree-item.selecting { background: rgba(88, 166, 255, 0.15) !important; }

        /* Minimalist Action Bar */
        .action-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .action-item { background: transparent; border: 1px solid transparent; color: var(--text-dim); cursor: pointer; font-size: 12px; padding: 6px 12px; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-weight: 500; border-radius: 20px; }
        .action-item:hover { color: var(--link); background: rgba(88, 166, 255, 0.08); border-color: rgba(88, 166, 255, 0.2); }
        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { padding: 0 10px; margin: 1rem auto; max-width: 100%; }
            .header-row { flex-direction: column; text-align: center; gap: 10px; }
            .api-status { position: static; transform: none; margin: 0 auto; }
            .capsule-search { flex-wrap: wrap; padding: 10px; border-radius: 12px; gap: 10px; }
            .capsule-search input { width: 100%; text-align: center; padding: 5px; }
            .capsule-search button { width: 100%; margin: 0; }
            .action-bar { gap: 10px; justify-content: space-around; }
            .action-item { padding: 8px 12px; flex: 1; justify-content: center; min-width: 120px; font-size: 11px; }
            
            /* Modal Responsive */
            .modal-content { width: 95%; height: 90vh; max-height: 90vh; border-radius: 8px; }
            .modal-body { padding: 15px; }
            
            /* Discovery Panel Responsive */
            .discovery-container { flex-direction: column; }
            .discovery-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border); max-height: 300px; overflow-y: auto; }
            #disc-preview-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; border-left: none; }
            #disc-repo-list { grid-template-columns: 1fr; }
            
            /* Stats Grid */
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            
            /* Tree View */
            .tree-item { padding: 8px 5px; }
            .file-size { display: none; } /* Hide size on small screens */
            .action-btn { opacity: 1; padding: 4px 8px; } /* Always show actions */
            
            /* Breadcrumbs */
            .breadcrumbs-container { flex-direction: column; align-items: flex-start; }
            #ref-selector { width: 100%; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="header-row">
        <h3>GitHub Repo Explorer / ä»“åº“æµè§ˆå™¨</h3>
        <div class="api-status" id="api-status" title="API Rate Limit: Unknown"></div>
    </div>
    
    <div class="capsule-search">
        <input type="text" id="url" placeholder="Paste GitHub URL / ç²˜è´´ GitHub é“¾æ¥ (e.g. user/repo)">
        <button id="btn-analyze" onclick="start()" style="white-space:nowrap;">Analyze</button>
        <button id="btn-discovery" onclick="openDiscovery()" title="Find Repos / å‘ç°ä»“åº“" style="background:transparent; border:none; color:var(--text-dim); padding:0 10px; margin-left:5px; border-left:1px solid var(--border); border-radius:0;">ğŸ” Find</button>
    </div>

    <div class="action-bar">
        <button class="action-item" id="btn-download" onclick="downloadZip()" disabled>
            <svg viewBox="0 0 16 16"><path d="M7.47 10.78a.75.75 0 001.06 0l3.75-3.75a.75.75 0 00-1.06-1.06L8.75 8.44V1.75a.75.75 0 00-1.5 0v6.69L4.78 5.97a.75.75 0 00-1.06 1.06l3.75 3.75zM3.75 13a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5z"></path></svg>
            Download ZIP
        </button>
        <button class="action-item" id="btn-export-ai" onclick="exportForAI()" disabled>
            <svg viewBox="0 0 16 16"><path d="M0 3.75C0 2.784.784 2 1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0114.25 14H1.75A1.75 1.75 0 010 12.25v-8.5zm1.75-.25a.25.25 0 00-.25.25v8.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25v-8.5a.25.25 0 00-.25-.25H1.75zM3.5 6.25a.75.75 0 01.75-.75h7a.75.75 0 010 1.5h-7a.75.75 0 01-.75-.75zm.75 2.25a.75.75 0 000 1.5h4a.75.75 0 000-1.5h-4z"></path></svg>
            Export to AI
        </button>
        <button class="action-item" id="btn-status" onclick="openRepoStatus()" disabled>
            <svg viewBox="0 0 16 16"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM6.5 7.75A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
            Repo Status
        </button>
        <button class="action-item" id="btn-github1s" onclick="openGithub1s()" disabled>
            <svg viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            Github1s
        </button>
    </div>

    <!-- Status Modal -->
    <div id="status-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px; max-height: 85vh; display:flex; flex-direction:column; width:90%;">
             <div class="modal-header">
                <span style="font-weight:600">Repo Dashboard</span>
                <span class="close-modal" onclick="$('#status-modal').style.display='none'">Ã—</span>
            </div>
            
            <div class="tab-nav">
                <div class="tab-item active" onclick="switchStatusTab('overview')">ğŸ“Š Overview</div>
                <div class="tab-item" onclick="switchStatusTab('activity')">âš¡ Activity</div>
                <div class="tab-item" onclick="switchStatusTab('ci')">ğŸ—ï¸ CI/CD</div>
            </div>

            <div class="modal-body" style="padding:0; display:flex; flex-direction:column; overflow:hidden;">
                <!-- Overview Tab -->
                <div id="status-tab-overview" class="status-tab-content active">
                    Loading...
                </div>
                
                <!-- Activity Tab -->
                <div id="status-tab-activity" class="status-tab-content">
                    <div style="text-align:center; padding:20px; color:#8b949e;">Loading activity...</div>
                </div>

                <!-- CI Tab -->
                <div id="status-tab-ci" class="status-tab-content">
                    <div style="text-align:center; padding:20px; color:#8b949e;">Loading CI status...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Discovery Modal -->
    <div id="discovery-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 1200px; height: 90vh; display:flex; flex-direction:column;">
            <div class="modal-header">
                <span id="disc-modal-title" style="font-weight:600">Repo Discovery / å‘ç°ä»“åº“</span>
                <span class="close-modal" onclick="closeDiscovery()">Ã—</span>
            </div>
            <div class="modal-body" style="padding:0; display:flex; flex:1; overflow:hidden;">
                <!-- Sidebar -->
                <div class="discovery-sidebar" style="width:300px; border-right:1px solid var(--border); padding:15px; overflow-y:auto; flex-shrink:0;">
                    <div style="margin-bottom:15px; font-weight:bold; color:var(--text);">ğŸ” ç­›é€‰ä¸æœç´¢</div>
                    
                    <div class="tab-group" style="display:flex; gap:10px; margin-bottom:15px;">
                        <div class="tab-btn active" onclick="switchDiscoveryMode('search')" id="tab-search">å…³é”®è¯æœç´¢</div>
                        <div class="tab-btn" onclick="switchDiscoveryMode('trending')" id="tab-trending">ğŸ”¥ è¶‹åŠ¿æ¦œå•</div>
                    </div>

                    <div id="disc-search-controls" style="margin-bottom:15px;">
                        <label style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-dim);">å…³é”®è¯</label>
                        <input type="text" id="disc-searchInput" class="minimal-input" placeholder="React, Vue, AI..." style="margin-bottom:0;">
                    </div>

                    <div style="margin-bottom:15px;">
                        <label style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-dim);">ç¼–ç¨‹è¯­è¨€</label>
                        <select id="disc-langSelect" class="minimal-input" style="margin-bottom:0;">
                            <option value="">å…¨éƒ¨è¯­è¨€</option>
                            <option value="javascript">JavaScript</option>
                            <option value="typescript">TypeScript</option>
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="go">Go</option>
                            <option value="rust">Rust</option>
                            <option value="c++">C++</option>
                            <option value="c">C</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="vue">Vue</option>
                            <option value="swift">Swift</option>
                            <option value="kotlin">Kotlin</option>
                            <option value="dart">Dart</option>
                        </select>
                    </div>

                    <div style="margin-bottom:15px;">
                        <label style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-dim);">æ’åºæ–¹å¼</label>
                        <select id="disc-sortSelect" class="minimal-input" style="margin-bottom:0;">
                            <option value="stars">æŒ‰ Stars æ•°</option>
                            <option value="forks">æŒ‰ Forks æ•°</option>
                            <option value="updated">æŒ‰æ›´æ–°æ—¶é—´</option>
                        </select>
                    </div>

                    <div style="margin-bottom:15px;">
                        <label style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-dim);">æœ€ä½ Stars</label>
                        <input type="number" id="disc-minStars" class="minimal-input" placeholder="ä¾‹å¦‚: 1000" min="0" style="margin-bottom:0;">
                    </div>

                    <div style="margin-bottom:15px;">
                        <label style="display:block; margin-bottom:5px; font-size:12px; color:var(--text-dim);">æ—¶é—´èŒƒå›´ (è¶‹åŠ¿)</label>
                        <select id="disc-dateRange" class="minimal-input" style="margin-bottom:0;" disabled>
                            <option value="daily">ä»Šæ—¥çƒ­é—¨</option>
                            <option value="weekly" selected>æœ¬å‘¨çƒ­é—¨</option>
                            <option value="monthly">æœ¬æœˆçƒ­é—¨</option>
                        </select>
                    </div>

                    <button id="disc-actionBtn" onclick="performDiscoveryAction()" style="width:100%;">ğŸ” å¼€å§‹æœç´¢</button>
                </div>

                <!-- Main List -->
                <div class="discovery-main" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                    <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <div id="disc-list-title" style="font-weight:bold;">æœç´¢ç»“æœ</div>
                        <div id="disc-result-count" style="font-size:12px; color:var(--text-dim);">0 ä¸ªé¡¹ç›®</div>
                    </div>
                    <div id="disc-repo-list" style="flex:1; overflow-y:auto; padding:15px; display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:15px; align-content:start;">
                        <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #8b949e;">
                            ğŸ‘ˆ åœ¨å·¦ä¾§è¾“å…¥å…³é”®è¯æˆ–é€‰æ‹©è¶‹åŠ¿æ¦œå•
                        </div>
                    </div>
                </div>
                
                <!-- Preview Panel (Nested) -->
                <div id="disc-preview-panel" style="width:50%; border-left:1px solid var(--border); background:var(--bg); display:none; flex-direction:column;">
                    <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <span id="disc-preview-title" style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px;">Preview</span>
                        <div style="display:flex; align-items:center;">
                             <select id="disc-render-engine" onchange="rerenderPreview()" style="margin-right:10px; font-size:12px; padding:4px; border:1px solid var(--border); background:var(--bg); color:var(--text); border-radius:4px;">
                                 <option value="js">JS Render (Fast)</option>
                                 <option value="api">GitHub API (Perfect)</option>
                                 <option value="source">Source Code</option>
                             </select>
                             <button onclick="closeDiscPreview()" style="padding:4px 8px; font-size:12px;">âœ•</button>
                        </div>
                    </div>
                    <div id="disc-preview-content" class="markdown-body" style="flex:1; overflow-y:auto; padding:20px;"></div>
                    <div style="padding:15px; border-top:1px solid var(--border); display:flex; gap:10px;">
                        <button id="disc-btn-open" class="action-item" style="flex:1; justify-content:center;">Open Here / è§£æ</button>
                        <button id="disc-btn-github1s" class="action-item" style="flex:1; justify-content:center;">Github1s</button>
                        <a id="disc-link-github" href="#" target="_blank" style="flex:1; display:flex;"><button class="action-item" style="width:100%; justify-content:center;">GitHub</button></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="preview-title" style="font-weight:600">Preview</span>
                <span class="close-modal" onclick="closePreview()">Ã—</span>
            </div>
            <div class="modal-body" id="preview-body">Loading...</div>
        </div>
    </div>

    <div class="settings-toggle" onclick="toggleSettings(this)">Advanced Settings / é«˜çº§è®¾ç½®</div>
    <div class="settings-panel" id="settings-panel">
        <div style="margin-bottom:15px">
            <label>GitHub Token (Opt)</label>
            <input type="password" id="gh-token" class="minimal-input" placeholder="ghp_xxxxxxxxxxxx">
            <div style="font-size:12px;color:#6a737d">æé«˜ API é€Ÿç‡é™åˆ¶ã€‚è­¦å‘Šï¼šé…ç½®å Token ä¼šå‘é€ç»™ä»£ç†ã€‚</div>
        </div>
        <div style="margin-bottom:15px">
            <label>API Proxy / API ä»£ç† (Opt)</label>
            <input type="text" id="api-proxy" class="minimal-input" placeholder="e.g. https://api.cors.me/">
            <div style="font-size:12px;color:#6a737d">GitHub API è¯·æ±‚å‰ç¼€ï¼Œç”¨äºç»•è¿‡ CORS æˆ–é€Ÿç‡é™åˆ¶ã€‚</div>
        </div>
        <div>
            <label>File URL Template / æ–‡ä»¶é“¾æ¥æ¨¡æ¿</label>
            <input type="text" id="url-template" class="minimal-input" value="https://raw.githubusercontent.com/{owner}/{repo}/{ref}/{path}">
            <div style="font-size:12px;color:#6a737d">æ„å»ºä¸‹è½½é“¾æ¥ã€‚å¯åœ¨æ­¤å¡«å…¥ä»£ç†ã€‚å ä½ç¬¦: {owner}, {repo}, {ref}, {path}ã€‚</div>
            <div style="font-size:11px;color:#8b949e;margin-top:5px;line-height:1.4">
                Examples:<br>
                - Default: <code>https://raw.githubusercontent.com/{owner}/{repo}/{ref}/{path}</code><br>
                - jsDelivr: <code>https://cdn.jsdelivr.net/gh/{owner}/{repo}@{ref}/{path}</code><br>
                - Proxy: <code>https://ghproxy.com/https://raw.githubusercontent.com/{owner}/{repo}/{ref}/{path}</code>
            </div>
        </div>
    </div>

    <div class="progress-container" id="progress-container">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-bar"></div></div>
        <div style="text-align:center;margin-top:8px;font-size:13px;color:#8b949e" id="status-text">Ready / å°±ç»ª</div>
    </div>
    
    <div class="breadcrumbs-container" id="breadcrumbs-container" style="display:none; margin-top: 20px;">
        <div id="breadcrumbs" class="breadcrumbs"></div>
        <select id="ref-selector" onchange="onRefChange()" style="width:auto;padding:4px 10px;margin:0;font-size:13px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:4px;"></select>
    </div>
    
    <div id="search-container" style="margin-top: 10px; display:flex; gap:10px; align-items: center;">
        <input type="text" id="file-search" class="minimal-input" placeholder="Search files... / æœç´¢æ–‡ä»¶... (Enter URL first)" style="margin-bottom:0;" disabled>
        <button id="btn-search-file" class="action-item" onclick="performFileSearch()" disabled>Search</button>
    </div>

    <div id="tree-view" class="tree-view"></div>

    <div id="console-container" style="display:none;margin-top:15px">
        <div class="console-header">
            <span class="console-title">Console Output</span>
            <span class="console-clear" onclick="clearLog()">Clear</span>
        </div>
        <div id="console-log" class="console-log" style="display:block;margin-top:0"></div>
    </div>

    </div><!-- Main Container End -->
    <script>
        const $ = s => document.querySelector(s);
        const log = t => {
             const st = $('#status-text');
             if(st) st.innerText = t;
             
             const container = $('#console-container');
             const cl = $('#console-log');
             if (cl && container) {
                 container.style.display = 'block';
                 const line = document.createElement('div');
                 const time = new Date().toLocaleTimeString();
                 line.innerText = `[${time}] ${t}`;
                 line.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                 line.style.padding = '2px 0';
                 cl.appendChild(line);
                 cl.scrollTop = cl.scrollHeight;
             }
             console.log(t);
        };
        
        function clearLog() {
            const cl = $('#console-log');
            if(cl) cl.innerHTML = '';
            $('#console-container').style.display = 'none';
        }
        const setProgress = (percent) => {
            $('#progress-bar').style.width = `${percent}%`;
            $('#progress-container').style.display = 'block';
        };

        const TEXT = {
            download: 'Download / ä¸‹è½½',
            zip: 'Zip / æ‰“åŒ…',
            copied: 'Copied! / å·²å¤åˆ¶!',
            failedCopy: 'Failed / å¤±è´¥',
            error: 'Error / é”™è¯¯',
            analyzing: 'Analyzing... / è§£æä¸­...',
            fetchingBranches: 'Fetching branches... / è·å–åˆ†æ”¯...',
            fetchingRepos: 'Fetching repos... / è·å–ä»“åº“...',
            fetchingFileList: 'Fetching file list... / è·å–æ–‡ä»¶åˆ—è¡¨...',
            selectRepo: 'Select Repo / é€‰æ‹©ä»“åº“',
            noFilesFound: 'No files found / æœªæ‰¾åˆ°æ–‡ä»¶',
            invalidUrl: 'Invalid URL / æ— æ•ˆé“¾æ¥',
            downloadingFiles: 'Downloading files... / ä¸‹è½½æ–‡ä»¶ä¸­...',
            zipping: 'Zipping... / æ‰“åŒ…ä¸­...',
            done: 'Done! / å®Œæˆ!',
            enterUrl: 'Please enter a URL / è¯·è¾“å…¥é“¾æ¥',
            analysisComplete: 'Analysis complete. Found {count} files. / è§£æå®Œæˆ, å…±æ‰¾åˆ° {count} ä¸ªæ–‡ä»¶.',
            preview: 'Preview / é¢„è§ˆ',
            close: 'Close / å…³é—­',
            noSelection: 'No files selected / æœªé€‰æ‹©æ–‡ä»¶'
        };
        const t = (k, args = {}) => {
            let str = TEXT[k] || k;
            for (let key in args) {
                str = str.replace(new RegExp(`{${key}}`, 'g'), args[key]);
            }
            return str;
        };

        let currentFiles = [];
        let currentRepoInfo = {};
        let currentRefs = [];

        function toggleSettings(el) {
            const panel = $('#settings-panel');
            const isOpen = panel.style.display === 'block';
            panel.style.display = isOpen ? 'none' : 'block';
            if (el) el.classList.toggle('open', !isOpen);
        }

        async function fetchWithProxy(url, type = 'api') {
            const apiProxy = $('#api-proxy').value.trim();
            const token = $('#gh-token').value.trim();
            const headers = {};
            if (token) headers['Authorization'] = `token ${token}`;

            let finalUrl = url;
            if (type === 'api' && apiProxy) {
                finalUrl = apiProxy + url;
            } 
            
            return fetch(finalUrl, { headers }).then(r => {
                monitorRateLimit(r);
                return r;
            });
        }

        function monitorRateLimit(response) {
            const limit = response.headers.get('x-ratelimit-limit');
            const remaining = response.headers.get('x-ratelimit-remaining');
            const reset = response.headers.get('x-ratelimit-reset');
            
            if (remaining !== null) {
                const el = $('#api-status');
                if (el) {
                    const r = parseInt(remaining, 10);
                    const l = parseInt(limit, 10);
                    const percentage = (r / l) * 100;
                    
                    let level = 'high';
                    if (percentage < 20) level = 'low';
                    else if (percentage < 50) level = 'medium';
                    
                    el.setAttribute('data-level', level);
                    
                    const resetDate = new Date(parseInt(reset, 10) * 1000);
                    el.title = `API: ${r}/${l} remaining\nResets: ${resetDate.toLocaleTimeString()}`;
                }
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                log(`${t('copied')}: ${text}`);
            }).catch(err => {
                console.error(t('failedCopy'), err);
                log(t('failedCopy') + ': ' + err);
            });
        }

        function formatSize(bytes) {
            if (bytes === undefined || bytes === null) return '';
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return `${bytes.toFixed(1)} ${units[i]}`;
        }

        function getFileIcon(filename) {
            return 'ğŸ“„';
        }

        // é¢„è§ˆé€»è¾‘
        async function previewFile(url, filename, filepath) {
            const ext = filename.split('.').pop().toLowerCase();

            if (ext === 'md' || ext === 'markdown') {
                try {
                    // Open discovery/markdown preview panel
                    const text = await fetch(url).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.text();
                    });
                    
                    // Make sure marked is loaded if needed (reusing discovery logic)
                    if (!markedLoaded && !window.marked) {
                        // Attempt load
                        try {
                            await loadScript([
                                'marked.min.js',
                                'https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js',
                                'https://unpkg.com/marked@9.1.2/marked.min.js'
                            ]);
                            markedLoaded = true;
                        } catch(e) { console.error('Marked load failed', e); }
                    }

                    showMarkdownFile(filename, text, url, filepath);
                    return;
                } catch(e) {
                    console.error('MD Preview failed', e);
                    // Fallback to normal preview on error
                }
            }

            const isImg = ['png','jpg','jpeg','gif','svg'].includes(ext);
            
            $('#preview-title').innerText = filename;
            $('#preview-body').innerHTML = 'Loading...';
            $('#preview-modal').style.display = 'flex';
            
            try {
                if (isImg) {
                    $('#preview-body').innerHTML = `<img src="${url}" class="preview-image">`;
                } else {
                    // Use fetch directly to match download behavior and avoid unwanted proxying
                    // if the URL is already absolute.
                    const text = await fetch(url).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.text();
                    });
                    
                    // Simple escape
                    const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    $('#preview-body').innerHTML = `<div class="preview-code">${safeText}</div>`;
                }
            } catch (e) {
                console.error('Preview error:', e);
                $('#preview-body').innerText = t('error') + ': ' + e.message;
            }
        }
        
        function closePreview() {
            $('#preview-modal').style.display = 'none';
        }
        
        let lastCheckedCheckbox = null;
        
        function toggleAll(checkbox, event) {
            // Shift + Click Range Selection
            if (event && event.shiftKey && lastCheckedCheckbox && lastCheckedCheckbox !== checkbox) {
                const all = Array.from(document.querySelectorAll('.tree-checkbox'));
                const start = all.indexOf(lastCheckedCheckbox);
                const end = all.indexOf(checkbox);
                
                if (start !== -1 && end !== -1) {
                    const low = Math.min(start, end);
                    const high = Math.max(start, end);
                    for (let i = low; i <= high; i++) {
                        const c = all[i];
                        if (c !== checkbox) {
                            c.checked = checkbox.checked;
                            c.indeterminate = false; 
                            if (c.getAttribute('data-type') === 'folder') handleFolderSelect(c, false); 
                            updateParentState(c); 
                        }
                    }
                }
            }
            
            if (checkbox.getAttribute('data-type') === 'folder') {
                handleFolderSelect(checkbox);
            }
            
            updateParentState(checkbox);
            lastCheckedCheckbox = checkbox;
        }

        function handleFolderSelect(checkbox, recurseUp = true) {
            const details = checkbox.closest('details');
            if (details) {
                 const container = details.querySelector('.children-container');
                 if (container) {
                     const children = container.querySelectorAll('.tree-checkbox');
                     children.forEach(c => {
                         c.checked = checkbox.checked;
                         c.indeterminate = false; 
                     });
                 }
            }
            if (recurseUp) updateParentState(checkbox);
        }
        
        function updateParentState(checkbox) {
            let container = checkbox.closest('.children-container');
            if (!container) return; // Top level

            let parentDetails = container.parentElement; // <details>
            if (!parentDetails) return;

            let parentSummary = parentDetails.querySelector('summary');
            if (!parentSummary) return;

            let parentCheckbox = parentSummary.querySelector('.tree-checkbox');
            if (!parentCheckbox) return;

            // Get direct children checkboxes only
            const siblingCheckboxes = Array.from(container.querySelectorAll(':scope > .tree-item .tree-checkbox, :scope > details > summary .tree-checkbox'));
            
            const allChecked = siblingCheckboxes.every(c => c.checked);
            const someChecked = siblingCheckboxes.some(c => c.checked || c.indeterminate);
            
            const newState = allChecked;
            const newIndeterminate = someChecked && !allChecked;
            
            if (parentCheckbox.checked !== newState || parentCheckbox.indeterminate !== newIndeterminate) {
                parentCheckbox.checked = newState;
                parentCheckbox.indeterminate = newIndeterminate;
                updateParentState(parentCheckbox);
            }
        }

        // Drag Selection Logic
        let isDragging = false;
        let startX = 0, startY = 0;
        let selectionBox = null;
        let initialCheckboxStates = new Map(); // Store initial states

        function getBodyOffset() {
            const rect = document.body.getBoundingClientRect();
            return {
                left: rect.left + window.scrollX,
                top: rect.top + window.scrollY
            };
        }

        document.addEventListener('mousedown', (e) => {
            const treeView = document.getElementById('tree-view');
            if (!treeView || treeView.style.display === 'none') return;
            if (!treeView.contains(e.target)) return;
            
            if (['INPUT', 'A', 'BUTTON', 'SUMMARY'].includes(e.target.tagName) || e.target.closest('summary') || e.target.closest('.action-btn')) return;

            isDragging = true;
            
            const offset = getBodyOffset();
            startX = e.pageX - offset.left;
            startY = e.pageY - offset.top;
            
            if (!selectionBox) {
                selectionBox = document.createElement('div');
                selectionBox.className = 'selection-box';
                document.body.appendChild(selectionBox);
            }
            
            selectionBox.style.left = startX + 'px';
            selectionBox.style.top = startY + 'px';
            selectionBox.style.width = '0px';
            selectionBox.style.height = '0px';
            selectionBox.style.display = 'block';
            
            // Snapshot current states
            initialCheckboxStates.clear();
            document.querySelectorAll('.tree-checkbox').forEach(cb => {
                initialCheckboxStates.set(cb, cb.checked);
            });
            
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging || !selectionBox) return;
            
            const offset = getBodyOffset();
            const currentX = e.pageX - offset.left;
            const currentY = e.pageY - offset.top;
            
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);
            const left = Math.min(currentX, startX);
            const top = Math.min(currentY, startY);
            
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            
            const items = document.querySelectorAll('.tree-item');
            items.forEach(item => {
                // Skip hidden items (e.g. inside collapsed details)
                if (item.offsetParent === null) return;

                const rect = item.getBoundingClientRect();
                const itemLeft = rect.left + window.scrollX - offset.left;
                const itemTop = rect.top + window.scrollY - offset.top;
                
                const intersect = (left < itemLeft + rect.width && left + width > itemLeft && top < itemTop + rect.height && top + height > itemTop);
                
                if (intersect) {
                    item.classList.add('selecting');
                    const checkbox = item.querySelector('.tree-checkbox');
                    if (checkbox) {
                        // Toggle logic: Invert initial state
                        const wasChecked = initialCheckboxStates.get(checkbox);
                        checkbox.checked = !wasChecked;
                        checkbox.indeterminate = false;
                    }
                } else {
                    if (item.classList.contains('selecting')) {
                        item.classList.remove('selecting');
                        const checkbox = item.querySelector('.tree-checkbox');
                        if (checkbox) {
                            // Revert to initial state
                            checkbox.checked = initialCheckboxStates.get(checkbox);
                        }
                    }
                }
            });
        });

        document.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            isDragging = false;
            if (selectionBox) selectionBox.style.display = 'none';
            
            const affectedItems = document.querySelectorAll('.tree-item.selecting');
            affectedItems.forEach(item => item.classList.remove('selecting'));
            
            const changedCheckboxes = [];
            affectedItems.forEach(item => {
                const cb = item.querySelector('.tree-checkbox');
                if(cb) changedCheckboxes.push(cb);
            });
            
            // 1. Handle Folders (Top-Down)
            changedCheckboxes.forEach(cb => {
                 if (cb.getAttribute('data-type') === 'folder') {
                     handleFolderSelect(cb, false);
                 }
            });

            // 2. Handle Parent Updates (Bottom-Up)
            changedCheckboxes.reverse().forEach(cb => updateParentState(cb));
            
            initialCheckboxStates.clear();
        });

        function renderBreadcrumbs(owner, repo, branch, path) {
            const container = $('#breadcrumbs');
            container.innerHTML = '';
            
            const parts = [
                { name: owner, url: `https://github.com/${owner}` },
                { name: repo, url: `https://github.com/${owner}/${repo}` },
                { name: branch, url: `https://github.com/${owner}/${repo}/tree/${branch}` }
            ];
            
            if (path) {
                path.split('/').forEach((p, i, arr) => {
                    const currentPath = arr.slice(0, i + 1).join('/');
                    parts.push({ 
                        name: p, 
                        url: `https://github.com/${owner}/${repo}/tree/${branch}/${currentPath}`,
                        isPath: true
                    });
                });
            }
            
            parts.forEach((p, i) => {
                const span = document.createElement('span');
                span.className = 'breadcrumb-item';
                span.innerText = p.name;
                span.onclick = () => {
                     $('#url').value = p.url;
                     start();
                };
                container.appendChild(span);
                
                if (i < parts.length - 1) {
                    const sep = document.createElement('span');
                    sep.className = 'breadcrumb-separator';
                    sep.innerText = '/';
                    container.appendChild(sep);
                }
            });
        }

        // ç›®å½•æ ‘æ¸²æŸ“é€»è¾‘
        function renderTree(files, rootPath) {
            lastCheckedCheckbox = null;
            const tree = {};
            
            // æ„å»ºæ ‘ç»“æ„
            files.forEach(file => {
                const relativePath = file.path.replace(rootPath, '').replace(/^\//, '');
                const parts = relativePath.split('/');
                let current = tree;
                
                parts.forEach((part, i) => {
                    if (!current[part]) {
                        current[part] = (i === parts.length - 1) ? { __file: file } : { __path: (current.__path ? current.__path + '/' : (rootPath ? rootPath + '/' : '')) + part };
                    }
                    current = current[part];
                });
            });
            // ä¿®å¤æ ¹è·¯å¾„è¿½è¸ª
            function fixPath(node, prefix) {
                Object.keys(node).forEach(key => {
                    if (key.startsWith('__')) return;
                    const fullPath = prefix ? prefix + '/' + key : key;
                    if (!node[key].__file) {
                        node[key].__path = fullPath;
                        fixPath(node[key], fullPath);
                    }
                });
            }
            fixPath(tree, rootPath);

            const container = $('#tree-view');
            container.innerHTML = '';
            container.style.display = 'block';
            
            function createNode(name, obj) {
                const isFile = obj.__file;
                const isFolder = !isFile;

                const div = document.createElement('div');
                div.className = 'tree-item';
                div.setAttribute('tabindex', '0'); // Keyboard focus
                
                // å›¾æ ‡é€»è¾‘
                const iconHtml = isFile 
                    ? `<span class="file-icon">${getFileIcon(name)}</span>` 
                    : `<span class="folder-arrow">â–¶</span><span class="folder-icon">ğŸ“‚</span>`;

                let actionsHtml = '';
                let progressHtml = '';
                let sizeHtml = '';
                let clickAction = '';

                if (isFile) {
                    const safeId = 'file-' + obj.__file.path.replace(/[^a-zA-Z0-9]/g, '-');
                    obj.__file.domId = safeId;
                    
                    progressHtml = `
                        <div class="file-progress-wrap">
                            <div class="file-progress-bar" id="${safeId}"></div>
                        </div>
                    `;
                    actionsHtml = `
                        <span class="action-btn" onclick="copyToClipboard('${obj.__file.repoUrl}')" title="Copy GitHub Link">Repo</span>
                        <span class="action-btn" onclick="copyToClipboard('${obj.__file.url}')" title="Copy Raw Link">Raw</span>
                        <span class="action-btn" onclick="downloadSingleFile('${obj.__file.url}', '${name}')" title="Download File">${t('download')}</span>
                    `;
                    sizeHtml = `<span class="file-size">${formatSize(obj.__file.size)}</span>`;
                    
                    const safePath = obj.__file.path.replace(/'/g, "\\'");
                    clickAction = `onclick="previewFile('${obj.__file.url}', '${name}', '${safePath}')" style="cursor:pointer; text-decoration:underline;"`;
                } else {
                    const folderPath = obj.__path;
                    const repoUrl = `https://github.com/${currentRepoInfo.owner}/${currentRepoInfo.repo}/tree/${currentRepoInfo.ref}/${folderPath}`;
                    actionsHtml = `
                         <span class="action-btn" onclick="copyToClipboard('${repoUrl}')" title="Copy GitHub Link">Repo</span>
                         <span class="action-btn" onclick="downloadFolderZip('${folderPath}')" title="Download Folder as ZIP">${t('zip')}</span>
                    `;
                }

                // å¤é€‰æ¡†
                const checkboxHtml = `<input type="checkbox" class="tree-checkbox" checked onclick="event.stopPropagation()" onchange="toggleAll(this, event)" data-path="${isFile ? obj.__file.path : obj.__path}" data-type="${isFile ? 'file' : 'folder'}">`;

                div.innerHTML = `
                    <div class="tree-content">
                        <div class="tree-item-left">
                            ${checkboxHtml}
                            ${iconHtml}
                            <span class="file-name" title="${name}" ${clickAction}>${name}</span>
                        </div>
                        <div style="display:flex; align-items:center;">
                            ${sizeHtml}
                            ${actionsHtml}
                            ${progressHtml}
                        </div>
                    </div>
                `;
                
                if (isFolder) {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    summary.appendChild(div);
                    details.appendChild(summary);
                    
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'children-container';
                    details.appendChild(childrenContainer);
                    
                    // Lazy Loading Logic
                    details.__treeNode = obj;
                    details.__rendered = false;
                    
                    details.addEventListener('toggle', function() {
                        if (this.open && !this.__rendered) {
                            this.__rendered = true;
                            const nodeObj = this.__treeNode;
                            const container = this.querySelector('.children-container');
                            
                            const keys = Object.keys(nodeObj).filter(k => !k.startsWith('__'));
                            const folders = keys.filter(k => !nodeObj[k].__file).sort();
                            const files = keys.filter(k => nodeObj[k].__file).sort();
                            
                            [...folders, ...files].forEach(key => {
                                const childNode = createNode(key, nodeObj[key]);
                                container.appendChild(childNode);
                            });
                            
                            // Sync checkbox state from parent
                            const parentCb = this.querySelector('.tree-checkbox');
                            if (parentCb && !parentCb.indeterminate) {
                                const childCbs = container.querySelectorAll('.tree-checkbox');
                                childCbs.forEach(cb => cb.checked = parentCb.checked);
                            }
                        }
                    });
                    
                    return details;
                } else {
                    return div;
                }
            }
            
            // æ ¹ç›®å½•æ’åº
            const keys = Object.keys(tree).filter(k => !k.startsWith('__'));
            const folders = keys.filter(k => !tree[k].__file).sort();
            const rootFiles = keys.filter(k => tree[k].__file).sort();
            
            [...folders, ...rootFiles].forEach(key => {
                const node = createNode(key, tree[key]);
                container.appendChild(node);
            });
        }

        // å¿«æ·é”®é€»è¾‘
        document.addEventListener('keydown', (e) => {
            // Ctrl+F: Focus Search
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                const searchInput = document.getElementById('file-search');
                if (searchInput && !searchInput.disabled) {
                    searchInput.focus();
                    searchInput.select();
                }
                return;
            }

            // Tree Navigation
            const active = document.activeElement;
            const isTreeItem = active.classList.contains('tree-item');
            
            if (isTreeItem) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    moveFocus(active, 1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    moveFocus(active, -1);
                } else if (e.key === ' ' || e.key === 'Enter') {
                    e.preventDefault();
                    
                    const details = active.closest('details');
                    // Check if we are focusing a folder summary
                    if (details && details.querySelector('summary > .tree-item') === active) {
                        if (e.key === 'Enter') {
                            details.open = !details.open;
                        } else {
                           // Space: Toggle Checkbox
                           const cb = active.querySelector('.tree-checkbox');
                           if(cb) {
                               cb.checked = !cb.checked;
                               toggleAll(cb, { stopPropagation: () => {} });
                           }
                        }
                    } else {
                        // File
                        if (e.key === 'Enter') {
                            const nameSpan = active.querySelector('.file-name');
                            if(nameSpan) nameSpan.click();
                        } else {
                           const cb = active.querySelector('.tree-checkbox');
                           if(cb) {
                               cb.checked = !cb.checked;
                               toggleAll(cb, { stopPropagation: () => {} });
                           }
                        }
                    }
                }
            }
        });

        function moveFocus(current, direction) {
            // Get all visible tree-items
            // We traverse the DOM to find visible tree-items
            // A simple approach: querySelectorAll('.tree-item') and filter by visibility
            const allItems = Array.from(document.querySelectorAll('.tree-item'));
            // Filter out items inside closed details
            // An item is visible if all its ancestor details are open.
            // But offsetParent check is faster and simpler for "rendered and visible"
            const visibleItems = allItems.filter(el => el.offsetParent !== null);
            
            const index = visibleItems.indexOf(current);
            if (index !== -1) {
                const newIndex = index + direction;
                if (newIndex >= 0 && newIndex < visibleItems.length) {
                    visibleItems[newIndex].focus();
                }
            }
        }

        function parseGitHubUrl(url) {
            url = url.trim();
            
            // Remove query params and hash (e.g. ?tab=readme-ov-file, #L10)
            url = url.split(/[?#]/)[0];

            if (url.startsWith('git@github.com:')) {
                url = url.replace('git@github.com:', 'https://github.com/').replace(/\.git$/, '');
            }
            
            // å¤„ç† raw.githubusercontent.com
            // Format: https://raw.githubusercontent.com/owner/repo/ref/path
            const rawMatch = url.match(/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/([^/]+)\/(.+)/);
            if (rawMatch) {
                return {
                    owner: rawMatch[1],
                    repo: rawMatch[2],
                    type: 'blob',
                    ref: rawMatch[3],
                    path: rawMatch[4]
                };
            }

            url = url.replace(/\.git$/, '');
            
            // å¤„ç† /commit/SHA -> å°† SHA è§†ä¸ºå¼•ç”¨
            const commitMatch = url.match(/github\.com\/([^/]+)\/([^/]+)\/commit\/([a-f0-9]+)/);
            if (commitMatch) {
                return {
                    owner: commitMatch[1],
                    repo: commitMatch[2],
                    type: 'tree', // treat as tree root
                    ref: commitMatch[3],
                    path: ''
                };
            }
            
            // å¤„ç†ç”¨æˆ·ä¸»é¡µé“¾æ¥
            // Regex for user: github.com/username (and optional /)
            
            const userMatch = url.match(/github\.com\/([^/]+)\/?$/);
            if (userMatch) {
                 return {
                     owner: userMatch[1],
                     type: 'user'
                 };
            }

            const match = url.match(/github\.com\/([^/]+)\/([^/]+)(?:\/(tree|blob)\/([^/]+)(?:\/(.*))?)?/);
            if (!match) return null;
            return {
                owner: match[1],
                repo: match[2],
                type: match[3],
                ref: match[4], // branch or tag or commit
                path: match[5] || ''
            };
        }
        
        async function downloadSingleFile(url, filename) {
             try {
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = filename;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
             } catch (e) {
                 console.error(e);
                 log(t('error') + ': ' + e.message);
             }
        }

        function getSelectedFiles(scopePath = null) {
            // æŸ¥æ‰¾æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
            const checkedInputs = Array.from(document.querySelectorAll('.tree-checkbox:checked[data-type="file"]'));
            const checkedPaths = new Set(checkedInputs.map(i => i.getAttribute('data-path')));
            
            let files = currentFiles.filter(f => checkedPaths.has(f.path));
            
            if (scopePath) {
                 files = files.filter(f => f.path === scopePath || f.path.startsWith(scopePath + '/'));
            }
            return files;
        }

        async function downloadFolderZip(folderPath) {
            const filesToZip = getSelectedFiles(folderPath);
            
            if (filesToZip.length === 0) {
                log(t('noSelection'));
                return;
            }
            
            const { owner, repo, ref } = currentRepoInfo;
            const safeRef = ref.replace(/[\/\\]/g, '-');
            const safePath = folderPath.replace(/[\/\\]/g, '-');
            const zipName = `${owner}-${repo}-${safeRef}-${safePath}.zip`;

            await downloadFilesAsZip(filesToZip, zipName);
        }

        async function downloadFilesAsZip(files, zipName) {
            $('#btn-analyze').disabled = true;
            $('#btn-download').disabled = true;
            
             const zip = new JSZip();
             let count = 0;
             log(t('downloadingFiles', { count: files.length }));
             setProgress(0);

             // å¹¶å‘ä¸‹è½½é™åˆ¶
             const limit = 10;
             for (let i = 0; i < files.length; i += limit) {
                 await Promise.all(files.slice(i, i + limit).map(async f => {
                     const bar = f.domId ? document.getElementById(f.domId) : null;
                     if(bar) bar.style.width = '20%'; 
                     
                     try {
                         const blob = await fetch(f.url).then(r => r.blob());
                         zip.file(f.path, blob);
                         if(bar) bar.style.width = '100%';
                     } catch (e) { 
                         console.error(e);
                         if(bar) {
                             bar.style.backgroundColor = 'red';
                             bar.style.width = '100%';
                         }
                     }
                     count++;
                     const percent = (count / files.length * 100).toFixed(0);
                     log(`${t('downloadingFiles', { count: files.length })} (${percent}%)`);
                     setProgress(percent);
                 }));
             }

            zip.generateAsync({type:"blob"}).then(function(content) {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = zipName;
                a.click();
                
                log(t('done'));
                $('#progress-container').style.display = 'none';
                $('#btn-download').disabled = false;
            });
        }

        // æ·»åŠ å›è½¦è§¦å‘
        $('#url').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') start();
        });
        
        // ç»‘å®šæœç´¢æ¡†å›è½¦äº‹ä»¶
        $('#file-search').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') performFileSearch();
        });

        async function start() {
            let url = $('#url').value.trim();
            if (!url) return log(t('enterUrl'));
            
            // è‡ªåŠ¨è¡¥å…¨ github.com å‰ç¼€
            if (!url.startsWith('http') && !url.startsWith('git@')) {
                if (url.indexOf('github.com') === -1) {
                     // ç®€å•çš„æ ¼å¼æ£€æŸ¥ï¼Œé¿å…éæ³•å­—ç¬¦ï¼Ÿæš‚æ—¶å…ˆç›´æ¥è¡¥å…¨
                     url = 'https://github.com/' + url;
                } else {
                     url = 'https://' + url;
                }
                $('#url').value = url;
            }

            $('#btn-analyze').disabled = true;
            $('#btn-download').disabled = true;
            $('#btn-export-ai').disabled = true;
            $('#btn-github1s').disabled = true;
            $('#progress-container').style.display = 'none';
            $('#progress-bar').style.width = '0%';
            $('#tree-view').style.display = 'none';
            $('#file-search').disabled = true; // Disable search
            $('#btn-search-file').disabled = true;
            $('#file-search').value = ''; // Clear search
            log(t('analyzing'));

            // è§£æ URL
            const parsed = parseGitHubUrl(url);
            if (!parsed) {
                log(t('invalidUrl'));
                $('#btn-analyze').disabled = false;
                return;
            }
            
            const { owner, repo, type, path: urlPath } = parsed;
            let ref = parsed.ref;
            let path = urlPath;
            
            // å¤„ç†ç”¨æˆ·ä¸»é¡µé€»è¾‘
            if (parsed.type === 'user') {
                await handleUserRepos(parsed.owner);
                return;
            }

            log(t('fetchingBranches'));
            
            try {
                // è·å–æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾
                // ç”¨äºåŒºåˆ† URL ä¸­çš„åˆ†æ”¯åå’Œè·¯å¾„
                // e.g. tree/feature/new/logic/src/index.js -> is branch "feature/new" or "feature/new/logic"?
                const [branches, tags] = await Promise.all([
                    fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}/branches`).then(r => r.json()),
                    fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}/tags`).then(r => r.json())
                ]);

                if (branches.message) throw new Error(branches.message);

                const branchNames = branches.map(b => b.name);
                const tagNames = tags.map(t => t.name);
                const refs = [...branchNames, ...tagNames].sort((a, b) => b.length - a.length); // Sort by length desc
                currentRefs = refs; // Store for selector

                // è‹¥æœªæŒ‡å®šå¼•ç”¨ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤åˆ†æ”¯
                if (!ref) {
                     const repoInfo = await fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}`).then(r => r.json());
                     ref = repoInfo.default_branch || 'master';
                } else {
                     // å°è¯•ä» URL åŒ¹é…å¼•ç”¨
                     // The URL parser might have captured "branch/path/to/file" as "branch" and "path/to/file"
                     // We need to check if the captured "ref" is actually part of a longer branch name
                     const potentialRef = ref + (path ? '/' + path : '');
                     const matchedRef = refs.find(r => potentialRef === r || potentialRef.startsWith(r + '/'));
                     
                     if (matchedRef) {
                         ref = matchedRef;
                         path = potentialRef.substring(matchedRef.length).replace(/^\//, '');
                     }
                }
                
                // å¡«å……å¼•ç”¨é€‰æ‹©å™¨
                const selector = $('#ref-selector');
                selector.innerHTML = '';
                
                // æ˜¾ç¤ºæ’åºï¼šä¸»åˆ†æ”¯ä¼˜å…ˆ
                const displayRefs = [...currentRefs].sort((a, b) => {
                    const pA = (a === 'main' || a === 'master') ? 1 : 0;
                    const pB = (b === 'main' || b === 'master') ? 1 : 0;
                    if (pA !== pB) return pB - pA; // Higher priority first
                    return a.localeCompare(b);
                });

                displayRefs.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r;
                    option.text = r;
                    option.selected = r === ref;
                    selector.appendChild(option);
                });
                
                $('#breadcrumbs-container').style.display = 'flex'; // Show breadcrumbs container

                currentRepoInfo = { owner, repo, path: path || '' };
                await fetchAndRenderTree(owner, repo, ref, path);

            } catch (e) {
                console.error(e);
                log(t('error') + ': ' + e.message);
            } finally {
                $('#btn-analyze').disabled = false;
            }
        }
        
        async function handleUserRepos(owner) {
             log(t('fetchingRepos'));
             try {
                 const repos = await fetchWithProxy(`https://api.github.com/users/${owner}/repos?per_page=100&sort=updated`).then(r => r.json());
                 if (repos.message) throw new Error(repos.message);
                 if (!repos.length) throw new Error(t('noFilesFound')); // å¤ç”¨æ¶ˆæ¯
                 
                 const container = $('#tree-view');
                 container.innerHTML = '';
                 container.style.display = 'block';
                 
                 const ul = document.createElement('div');
                 repos.forEach(repo => {
                     const div = document.createElement('div');
                     div.className = 'tree-item';
                     div.style.padding = '5px 10px';
                     div.style.cursor = 'pointer';
                     div.innerHTML = `
                         <div style="display:flex; align-items:center;">
                             <span class="folder-icon">ğŸ“¦</span>
                             <span class="file-name" style="font-weight:600">${repo.name}</span>
                             <span style="margin-left:10px; font-size:12px; color:#6a737d;">${repo.description || ''}</span>
                         </div>
                     `;
                     div.onclick = () => {
                         $('#url').value = repo.html_url;
                         start();
                     };
                     ul.appendChild(div);
                 });
                 container.appendChild(ul);
                 
                 log(t('selectRepo'));
                 $('#breadcrumbs-container').style.display = 'none';
                 
             } catch(e) {
                 console.error(e);
                 log(t('error') + ': ' + e.message);
             } finally {
                 $('#btn-analyze').disabled = false;
                 // Enable status button if repo loaded
                 if (currentRepoInfo.owner) $('#btn-status').disabled = false;
             }
        }
        
        async function onRefChange() {
             const ref = $('#ref-selector').value;
             const { owner, repo, path } = currentRepoInfo;
             if (!owner || !repo) return;
             
             $('#btn-analyze').disabled = true;
             $('#btn-download').disabled = true;
             
             try {
                 await fetchAndRenderTree(owner, repo, ref, path);
             } catch(e) {
                 console.error(e);
                 log(t('error') + ': ' + e.message);
             } finally {
                 $('#btn-analyze').disabled = false;
             }
        }

        async function fetchAndRenderTree(owner, repo, ref, path) {
            log(t('fetchingFileList'));
            let files = [];
            
            // æ£€æŸ¥æ˜¯å¦ä¸º blob URLï¼ŒåŒºåˆ†æ–‡ä»¶å’Œç›®å½•
            // If path is provided, we need to check if it's a file or directory. 
            // The previous logic used 'type' from URL, but now we might change branch.
            // Let's assume tree first.
            
            try {
                 const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${ref}?recursive=1`;
                 const treeData = await fetchWithProxy(treeUrl).then(r => r.json());
                 
                 if (treeData.message) throw new Error(treeData.message);
                 
                 files = treeData.tree
                     .filter(i => i.type === 'blob'); // Only files

                 if (path) {
                     // Check if path exists as a directory prefix or exact file match
                     files = files.filter(i => i.path === path || i.path.startsWith(path + '/'));
                 }
                 
                 // è‹¥æœªæ‰¾åˆ°æ–‡ä»¶
                 // If Tree API fails (e.g. repo too large), maybe fallback or error
            } catch (e) {
                // è‹¥ Tree API å¤±è´¥
                throw e;
            }
            
            if (!files.length) throw new Error(t('noFilesFound'));

            $('#btn-status').disabled = false;

            // ä½¿ç”¨æ¨¡æ¿å¤„ç† URL
            const template = $('#url-template').value.trim();
            const branch = ref; // Use resolved ref as branch
            files = files.map(i => {
                let fileUrl = template
                    .replace('{owner}', owner)
                    .replace('{repo}', repo)
                    .replace('{ref}', branch)
                    .replace('{branch}', branch)
                    .replace('{path}', i.path);
                
                const repoUrl = `https://github.com/${owner}/${repo}/blob/${branch}/${i.path}`;

                return { 
                    path: i.path, 
                    url: fileUrl,
                    repoUrl: repoUrl,
                    size: i.size // Capture size
                };
            });

            currentFiles = files; // Store for download
            // currentRepoInfo è·¯å¾„å·²è®¾ç½®
            currentRepoInfo.ref = ref; // Update ref in state

            // æ¸²æŸ“ç›®å½•æ ‘
            renderBreadcrumbs(owner, repo, branch, path);
            renderTree(files, path);
            
            $('#file-search').disabled = false; // Enable search
            $('#btn-search-file').disabled = false;
            $('#file-search').placeholder = "Search files... / æœç´¢æ–‡ä»¶...";
            
            log(t('analysisComplete', { count: files.length }));
            $('#btn-download').disabled = false;
            $('#btn-github1s').disabled = false;
            $('#btn-export-ai').disabled = false;
        }

        function performFileSearch() {
            const val = $('#file-search').value.trim().toLowerCase();
            
            if (!val) {
                renderTree(currentFiles, currentRepoInfo.path);
                log('Search cleared.');
                return;
            }
            
            log(`Searching for "${val}"...`);
            
            // Filter files
            const filtered = currentFiles.filter(f => f.path.toLowerCase().includes(val));
            
            log(`Found ${filtered.length} matches.`);
            
            // Re-render
            renderTree(filtered, currentRepoInfo.path);
            
            // Expand all folders when searching
            const details = document.querySelectorAll('#tree-view details');
            details.forEach(d => d.open = true);
        }

        async function exportForAI() {
             const checked = document.querySelectorAll('.tree-checkbox:checked');
             let filesToExport = [];
             
             if (checked.length > 0) {
                 checked.forEach(c => {
                     const path = c.getAttribute('data-path');
                     const file = currentFiles.find(f => f.path === path);
                     if (file) filesToExport.push(file);
                 });
             } else {
                 if (!confirm(t('noSelection') + '. Export ALL files in current view? / æœªé€‰æ‹©æ–‡ä»¶ã€‚å¯¼å‡ºå½“å‰è§†å›¾æ‰€æœ‰æ–‡ä»¶ï¼Ÿ')) {
                     return;
                 }
                 filesToExport = currentFiles;
             }
             
             if (filesToExport.length > 50) {
                 if (!confirm(`Warning: You are about to export ${filesToExport.length} files. This may take a while and consume API quota. Continue?`)) return;
             }

             const btn = $('#btn-export-ai');
             const originalText = btn.innerText;
             btn.disabled = true;
             btn.innerText = "Exporting...";
             
             try {
                 let markdown = `# File Tree\n\n`;
                 
                 // Generate Tree Structure
                 filesToExport.forEach(f => {
                     markdown += `- ${f.path}\n`;
                 });
                 
                 markdown += `\n# File Contents\n\n`;
                 
                 let count = 0;
                 // Concurrent limit
                 const limit = 5;
                 for (let i = 0; i < filesToExport.length; i += limit) {
                     await Promise.all(filesToExport.slice(i, i + limit).map(async file => {
                        try {
                            const ext = file.path.split('.').pop();
                            const res = await fetch(file.url);
                            const text = await res.text();
                            
                            // Simple content check to avoid binary (if extension is not obvious)
                            if (text.indexOf('\0') !== -1) {
                                markdown += `## ${file.path}\n\n> Binary file skipped\n\n`;
                            } else {
                                markdown += `## ${file.path}\n\n\`\`\`${ext}\n${text}\n\`\`\`\n\n`;
                            }
                        } catch (e) {
                            markdown += `## ${file.path}\n\n> Error fetching content: ${e.message}\n\n`;
                        }
                        count++;
                        btn.innerText = `Exporting ${count}/${filesToExport.length}...`;
                     }));
                 }
                 
                 // Download
                 const blob = new Blob([markdown], { type: 'text/markdown' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `${currentRepoInfo.repo}-context.md`;
                 a.click();
                 
             } catch (e) {
                 alert('Export failed: ' + e.message);
                 console.error(e);
             } finally {
                 btn.disabled = false;
                 btn.innerText = originalText;
             }
        }

        async function downloadZip() {
            const filesToZip = getSelectedFiles();
            if (filesToZip.length === 0) {
                log(t('noSelection'));
                return;
            }
            
            const { owner, repo, ref, path } = currentRepoInfo;
            const safeRef = ref.replace(/[\/\\]/g, '-');
            let zipName = `${owner}-${repo}-${safeRef}`;
            
            if (path) {
                 const safePath = path.replace(/[\/\\]/g, '-');
                 zipName += `-${safePath}`;
            }
            zipName += '.zip';

            await downloadFilesAsZip(filesToZip, zipName);
        }

        /* Discovery Logic */
        let discMode = 'search';
        let markedLoaded = false;
        
        function openDiscovery() {
            $('#discovery-modal').style.display = 'flex';
            $('#disc-modal-title').innerText = "Repo Discovery / å‘ç°ä»“åº“";
            
            // Restore layout (in case it was used for file preview)
            $('.discovery-sidebar').style.display = 'block';
            $('.discovery-main').style.display = 'flex';
            $('#disc-preview-panel').style.width = '50%';
            $('#disc-preview-panel').style.borderLeft = '1px solid var(--border)';
            $('#disc-preview-panel').style.display = 'none'; // Start hidden

            if (!markedLoaded) {
                // Load marked: Local -> Cloudflare -> unpkg
                loadScript([
                    'marked.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js',
                    'https://unpkg.com/marked@9.1.2/marked.min.js'
                ]).then(() => {
                    markedLoaded = true;
                    console.log('Marked loaded');
                }).catch(e => console.error('Failed to load marked', e));
            }
        }
        
        function closeDiscovery() {
            $('#discovery-modal').style.display = 'none';
        }

        function switchDiscoveryMode(mode) {
            discMode = mode;
            $('#tab-search').className = `tab-btn ${mode === 'search' ? 'active' : ''}`;
            $('#tab-trending').className = `tab-btn ${mode === 'trending' ? 'active' : ''}`;
            
            const searchInput = $('#disc-searchInput');
            const dateRange = $('#disc-dateRange');
            const actionBtn = $('#disc-actionBtn');

            if (mode === 'trending') {
                searchInput.disabled = true;
                searchInput.placeholder = "Trending mode";
                dateRange.disabled = false;
                actionBtn.innerText = "ğŸ”¥ View Trending";
                performDiscoveryAction();
            } else {
                searchInput.disabled = false;
                searchInput.placeholder = "React, Vue, AI...";
                dateRange.disabled = true;
                actionBtn.innerText = "ğŸ” Search";
            }
        }

        async function performDiscoveryAction() {
            const listEl = $('#disc-repo-list');
            listEl.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding: 50px;">Loading...</div>';
            
            try {
                let query = '';
                if (discMode === 'search') {
                    const k = $('#disc-searchInput').value.trim();
                    if (k) query += k;
                    else if (!$('#disc-langSelect').value) query += 'stars:>1000';
                } else {
                    const range = $('#disc-dateRange').value;
                    const date = new Date();
                    if (range === 'daily') date.setDate(date.getDate() - 1);
                    else if (range === 'weekly') date.setDate(date.getDate() - 7);
                    else if (range === 'monthly') date.setMonth(date.getMonth() - 1);
                    query += `created:>${date.toISOString().split('T')[0]}`;
                }

                const lang = $('#disc-langSelect').value;
                if (lang) query += ` language:${lang}`;
                
                const minStars = $('#disc-minStars').value;
                if (minStars) query += ` stars:>${minStars}`;
                
                const sort = $('#disc-sortSelect').value;
                const url = `https://api.github.com/search/repositories?q=${encodeURIComponent(query.trim())}&sort=${sort}&order=desc&per_page=30`;

                const res = await fetch(url);
                if (!res.ok) {
                     if (res.status === 403) throw new Error('API Rate Limit Exceeded');
                     throw new Error(`API Error ${res.status}`);
                }
                
                const data = await res.json();
                renderDiscoveryRepos(data.items);
                $('#disc-result-count').innerText = `${data.total_count} results`;
                $('#disc-list-title').innerText = discMode === 'search' ? 'Search Results' : 'Trending';

            } catch (e) {
                console.error(e);
                listEl.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #ff4d4f;">Error: ${e.message}</div>`;
            }
        }

        function renderDiscoveryRepos(repos) {
            const listEl = $('#disc-repo-list');
            listEl.innerHTML = '';
            
            if (!repos || !repos.length) {
                listEl.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-dim);">No results found</div>';
                return;
            }

            repos.forEach(repo => {
                const card = document.createElement('div');
                card.className = 'repo-card';
                card.onclick = () => showDiscoveryPreview(repo);
                
                let langColor = '#ccc';
                if (repo.language) {
                    const colors = { JavaScript: '#f1e05a', TypeScript: '#2b7489', Python: '#3572A5', Java: '#b07219', Go: '#00ADD8', Rust: '#dea584', Vue: '#41b883', HTML:'#e34c26', CSS:'#563d7c' };
                    langColor = colors[repo.language] || '#ccc';
                }

                card.innerHTML = `
                    <div class="repo-header">
                        <span class="repo-name">${repo.full_name}</span>
                        <span style="font-size:11px; color:#8b949e">${new Date(repo.updated_at).toLocaleDateString()}</span>
                    </div>
                    <div class="repo-desc">${repo.description || 'No description'}</div>
                    <div class="repo-meta">
                        <div class="meta-item" style="color:${langColor}"><span class="lang-dot" style="background:${langColor}"></span> ${repo.language || 'Unknown'}</div>
                        <div class="meta-item">â­ ${(repo.stargazers_count/1000).toFixed(1)}k</div>
                    </div>
                `;
                listEl.appendChild(card);
            });
        }

        let currentPreviewRepo = null;
        let currentRawReadme = null;

        async function showDiscoveryPreview(repo) {
            const panel = $('#disc-preview-panel');
            const content = $('#disc-preview-content');
            
            // Restore inner title for discovery mode
            $('#disc-preview-title').style.display = 'block';

            panel.style.display = 'flex';
            $('#disc-preview-title').innerText = repo.full_name;
            $('#disc-link-github').href = repo.html_url;
            
            // Store current context
            currentPreviewRepo = repo;
            currentRawReadme = null;

            // Reset buttons
            $('#disc-btn-open').innerText = "Open Here";
            $('#disc-btn-open').onclick = () => {
                closeDiscovery();
                $('#url').value = repo.html_url;
                start();
            };
            
            $('#disc-btn-github1s').onclick = () => {
                window.open(`https://github1s.com/${repo.full_name}`, '_blank');
            };

            content.innerHTML = 'Loading README...';

            try {
                const res = await fetch(`https://api.github.com/repos/${repo.full_name}/readme`);
                if (!res.ok) throw new Error('No README');
                const data = await res.json();
                const raw = decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, ''))));
                currentRawReadme = raw;
                
                await renderMarkdown(raw, repo.full_name);
            } catch (e) {
                content.innerText = 'Failed to load README: ' + e.message;
            }
        }

        async function showMarkdownFile(filename, text, url, filepath) {
            // Show modal
            $('#discovery-modal').style.display = 'flex';
            
            // Set full URL path title
            const fullUrl = `https://github.com/${currentRepoInfo.owner}/${currentRepoInfo.repo}/blob/${currentRepoInfo.ref}/${filepath}`;
            const titleEl = $('#disc-modal-title');
            titleEl.innerText = fullUrl;
            titleEl.title = fullUrl;
            titleEl.style.whiteSpace = 'nowrap';
            titleEl.style.overflow = 'hidden';
            titleEl.style.textOverflow = 'ellipsis';
            titleEl.style.maxWidth = 'calc(100vw - 100px)';
            titleEl.style.display = 'block';

            // Layout for file preview: Hide sidebar/main, Full width panel
            $('.discovery-sidebar').style.display = 'none';
            $('.discovery-main').style.display = 'none';
            
            const panel = $('#disc-preview-panel');
            panel.style.display = 'flex';
            panel.style.width = '100%';
            panel.style.borderLeft = 'none';
            
            // Hide the redundant preview title inside the panel since we moved it to modal header
            $('#disc-preview-title').style.display = 'none';

            // $('#disc-preview-title').innerText = filename; // No longer needed
            $('#disc-link-github').href = url;
            
            // Context
            currentPreviewRepo = currentRepoInfo.owner + '/' + currentRepoInfo.repo;
            currentRawReadme = text;

            // Buttons
            $('#disc-btn-open').innerText = "Download";
            $('#disc-btn-open').onclick = () => downloadSingleFile(url, filename);
            
            $('#disc-btn-github1s').onclick = () => {
                 const { owner, repo, ref } = currentRepoInfo;
                 const g1sUrl = `https://github1s.com/${owner}/${repo}/blob/${ref}/${filepath}`;
                 window.open(g1sUrl, '_blank');
            };
            
            await renderMarkdown(text, currentPreviewRepo);
        }
        
        async function rerenderPreview() {
            if (currentRawReadme && currentPreviewRepo) {
                const content = $('#disc-preview-content');
                content.innerHTML = '<span style="color:gray">Re-rendering...</span>';
                try {
                    await renderMarkdown(currentRawReadme, currentPreviewRepo.full_name);
                } catch(e) {
                    content.innerText = 'Render failed: ' + e.message;
                }
            }
        }

        async function renderMarkdown(text, contextRepo) {
              const engine = $('#disc-render-engine').value;
              const content = $('#disc-preview-content');
              
              if (engine === 'source') {
                  const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                  content.innerHTML = `<pre style="white-space:pre-wrap; word-wrap:break-word; background:var(--bg-secondary); padding:10px; border-radius:4px; font-family:monospace;">${safeText}</pre>`;
                  return;
              }

              if (engine === 'api') {
                 // GitHub API Render
                 try {
                     const res = await fetch('https://api.github.com/markdown', {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                             // If token is set, use it
                             ...(localStorage.getItem('gh_token') ? { 'Authorization': `token ${localStorage.getItem('gh_token')}` } : {})
                         },
                         body: JSON.stringify({
                             text: text,
                             mode: 'gfm',
                             context: contextRepo
                         })
                     });
                     
                     if (!res.ok) throw new Error(`API Error ${res.status}`);
                     const html = await res.text();
                     content.innerHTML = html;
                 } catch (e) {
                     console.error('API Render Error', e);
                     content.innerHTML = `<div style="color:red">API Render Failed: ${e.message}. Falling back to JS.</div>`;
                     // Fallback
                     if (window.marked) content.innerHTML += window.marked.parse(text);
                 }
             } else {
                 // JS Render
                 if (window.marked) {
                     content.innerHTML = window.marked.parse(text);
                 } else {
                     content.innerText = text;
                 }
             }
        }
        
        function closeDiscPreview() {
            const sidebar = $('.discovery-sidebar');
            // If sidebar is hidden, we are in file preview mode -> close entire modal
            if (sidebar.style.display === 'none') {
                closeDiscovery();
            } else {
                $('#disc-preview-panel').style.display = 'none';
            }
        }

        function loadScript(urls) {
            if (!urls || !urls.length) return Promise.reject(new Error('No URLs'));
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = urls[0];
                s.onload = resolve;
                s.onerror = () => {
                    console.warn(`Failed to load ${urls[0]}, trying fallback...`);
                    loadScript(urls.slice(1)).then(resolve).catch(reject);
                };
                document.head.appendChild(s);
            });
        }
        
        // Bind Enter for discovery search
        $('#disc-searchInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') performDiscoveryAction();
        });

        // Close modals on click outside / ç‚¹å‡»è¾¹ç¼˜å…³é—­
        document.querySelectorAll('.modal-overlay').forEach(el => {
            el.addEventListener('click', (e) => {
                if (e.target === el) {
                    if (el.id === 'discovery-modal') {
                         // Check if in preview mode
                         if ($('#disc-preview-panel').style.display === 'flex' && $('.discovery-sidebar').style.display === 'none') {
                             // In full preview mode, close everything
                             closeDiscovery();
                         } else if ($('#disc-preview-panel').style.display === 'flex') {
                             // In discovery preview mode, just close preview
                             closeDiscPreview();
                         } else {
                             closeDiscovery();
                         }
                    } else if (el.id === 'preview-modal') {
                        closePreview();
                    } else {
                        el.style.display = 'none';
                    }
                }
            });
        });

        // Global Key Handler for ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const preview = $('#disc-preview-panel');
                const modal = $('#discovery-modal');
                
                if (preview && preview.style.display === 'flex') {
                    closeDiscPreview();
                    e.preventDefault();
                    e.stopPropagation();
                } else if (modal && modal.style.display === 'flex') {
                    closeDiscovery();
                    e.preventDefault();
                    e.stopPropagation();
                } else if ($('#status-modal').style.display === 'flex') {
                    $('#status-modal').style.display = 'none';
                    e.preventDefault();
                }
            }
        });

        let statusDataCache = {};

        function switchStatusTab(tabId) {
            // Update Tab UI
            document.querySelectorAll('.tab-nav .tab-item').forEach(el => {
                el.classList.remove('active');
                if (el.getAttribute('onclick').includes(tabId)) el.classList.add('active');
            });
            
            document.querySelectorAll('.status-tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`status-tab-${tabId}`).classList.add('active');
            
            // Load content if needed
            if (tabId === 'overview') loadStatusOverview();
            else if (tabId === 'activity') loadStatusActivity();
            else if (tabId === 'ci') loadStatusCI();
        }

        async function openRepoStatus() {
             const { owner, repo } = currentRepoInfo;
             if (!owner || !repo) return;
             
             $('#status-modal').style.display = 'flex';
             
             // Reset Cache if repo changed
             const repoKey = `${owner}/${repo}`;
             if (statusDataCache.key !== repoKey) {
                 statusDataCache = { key: repoKey };
                 // Reset UI
                 $('#status-tab-overview').innerHTML = 'Loading...';
                 $('#status-tab-activity').innerHTML = '<div style="text-align:center; padding:20px; color:#8b949e;">Loading activity...</div>';
                 $('#status-tab-ci').innerHTML = '<div style="text-align:center; padding:20px; color:#8b949e;">Loading CI status...</div>';
             }

             switchStatusTab('overview');
        }

        async function loadStatusOverview() {
            if (statusDataCache.overview) return;
            
            const { owner, repo } = currentRepoInfo;
            const container = $('#status-tab-overview');
            
            try {
                const [repoData, community] = await Promise.all([
                    fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}`).then(r => r.json()),
                    fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}/community/profile`).then(r => r.ok ? r.json() : null)
                ]);

                const hasGitignore = currentFiles.some(f => f.path.endsWith('.gitignore'));
                const hasLicense = currentFiles.some(f => f.path.toUpperCase().includes('LICENSE'));
                const hasEditorConfig = currentFiles.some(f => f.path === '.editorconfig');
                const hasESLint = currentFiles.some(f => f.path.includes('.eslintrc') || f.path.includes('eslint.config'));
                
                let html = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${formatCompactNumber(repoData.stargazers_count)}</div>
                            <div class="stat-label">Stars</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCompactNumber(repoData.forks_count)}</div>
                            <div class="stat-label">Forks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCompactNumber(repoData.subscribers_count)}</div>
                            <div class="stat-label">Watchers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCompactNumber(repoData.open_issues_count)}</div>
                            <div class="stat-label">Issues</div>
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <h4 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">Repository Info</h4>
                            <div style="font-size:13px; line-height:2.2;">
                                <div>ğŸ“¦ Size: <b>${formatSize(repoData.size * 1024)}</b></div>
                                <div>âš–ï¸ License: <b>${repoData.license ? (repoData.license.spdx_id || repoData.license.name) : 'None'}</b></div>
                                <div>ğŸ“… Created: <b>${new Date(repoData.created_at).toLocaleDateString()}</b></div>
                                <div>ğŸ”„ Updated: <b>${new Date(repoData.updated_at).toLocaleDateString()}</b></div>
                                <div>ğŸŒ Language: <b>${repoData.language || 'N/A'}</b></div>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">Health Check</h4>
                            <div style="font-size:13px; line-height:2.2;">
                                <div>${hasGitignore ? 'âœ…' : 'âŒ'} .gitignore</div>
                                <div>${hasLicense ? 'âœ…' : 'âŒ'} LICENSE</div>
                                <div>${community && community.files && community.files.readme ? 'âœ…' : 'âŒ'} README</div>
                                <div>${community && community.files && community.files.contributing ? 'âœ…' : 'âŒ'} CONTRIBUTING</div>
                                <div>${hasEditorConfig ? 'âœ…' : 'âšª'} .editorconfig</div>
                                <div>${hasESLint ? 'âœ…' : 'âšª'} ESLint</div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                statusDataCache.overview = true;
                
            } catch (e) {
                container.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
            }
        }

        async function loadStatusActivity() {
            if (statusDataCache.activity) return;
            
            const { owner, repo } = currentRepoInfo;
            const container = $('#status-tab-activity');
            
            try {
                const events = await fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}/events?per_page=30`).then(r => r.json());
                
                if (!Array.isArray(events)) throw new Error(events.message || 'Failed to fetch events');
                
                let html = '';
                if (events.length === 0) {
                    html = '<div style="text-align:center; padding:20px; color:gray">No recent activity</div>';
                } else {
                    events.forEach(e => {
                        let action = '';
                        let icon = 'ğŸ“';
                        let details = '';
                        
                        switch(e.type) {
                            case 'PushEvent':
                                icon = 'ğŸ”¨';
                                action = `pushed to <span class="timeline-ref">${e.payload.ref.replace('refs/heads/', '')}</span>`;
                                details = (e.payload.commits || []).map(c => `<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">- ${c.message}</div>`).join('');
                                break;
                            case 'PullRequestEvent':
                                icon = 'ğŸ”€';
                                action = `${e.payload.action} PR <span class="timeline-ref">#${e.payload.number}</span>`;
                                details = `<div style="font-weight:600">${e.payload.pull_request.title}</div>`;
                                break;
                            case 'IssuesEvent':
                                icon = 'ğŸ›';
                                action = `${e.payload.action} issue <span class="timeline-ref">#${e.payload.issue.number}</span>`;
                                details = `<div style="font-weight:600">${e.payload.issue.title}</div>`;
                                break;
                            case 'WatchEvent':
                                icon = 'â­';
                                action = 'starred this repository';
                                break;
                            case 'ForkEvent':
                                icon = 'ğŸ´';
                                action = 'forked this repository';
                                break;
                            case 'CreateEvent':
                                icon = 'âœ¨';
                                action = `created ${e.payload.ref_type} <span class="timeline-ref">${e.payload.ref || ''}</span>`;
                                break;
                            case 'DeleteEvent':
                                icon = 'ğŸ—‘ï¸';
                                action = `deleted ${e.payload.ref_type} <span class="timeline-ref">${e.payload.ref || ''}</span>`;
                                break;
                            default:
                                action = e.type.replace('Event', '');
                        }
                        
                        html += `
                            <div class="timeline-item">
                                <div class="timeline-icon">${icon}</div>
                                <div class="timeline-body">
                                    <div class="timeline-header">
                                        <div>
                                            <span class="timeline-user">${e.actor.login}</span> ${action}
                                        </div>
                                        <div>${timeAgo(new Date(e.created_at))}</div>
                                    </div>
                                    ${details ? `<div style="margin-top:5px; color:var(--text-dim);">${details}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                statusDataCache.activity = true;
                
            } catch (e) {
                container.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
            }
        }

        async function loadStatusCI() {
            if (statusDataCache.ci) return;
            
            const { owner, repo, ref } = currentRepoInfo;
            const container = $('#status-tab-ci');
            
            try {
                const checkRuns = await fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}/commits/${ref}/check-runs`).then(r => r.ok ? r.json() : null);
                
                let html = '';
                if (checkRuns && checkRuns.check_runs && checkRuns.check_runs.length > 0) {
                     checkRuns.check_runs.forEach(run => {
                         const color = run.conclusion === 'success' ? '#2da44e' : (run.conclusion === 'failure' ? '#cf222e' : '#9a6700');
                         const icon = run.conclusion === 'success' ? 'âœ”' : (run.conclusion === 'failure' ? 'âœ–' : 'â—');
                         html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border); align-items:center;">
                             <div style="display:flex; align-items:center; gap:10px;">
                                 <span style="color:${color}; font-size:16px;">${icon}</span>
                                 <div>
                                     <div style="font-weight:600">${run.name}</div>
                                     <div style="font-size:11px; color:var(--text-dim);">${run.app ? run.app.name : 'GitHub Actions'}</div>
                                 </div>
                             </div>
                             <div style="text-align:right;">
                                 <div style="font-size:12px; color:${color}; text-transform:capitalize;">${run.conclusion || run.status}</div>
                                 <div style="font-size:11px; color:var(--text-dim);">${new Date(run.completed_at || run.started_at).toLocaleDateString()}</div>
                             </div>
                         </div>`;
                     });
                } else {
                     html = `<div style="text-align:center; padding:50px; color:gray;">No CI/CD checks found for ref: <b>${ref}</b></div>`;
                }
                
                container.innerHTML = html;
                statusDataCache.ci = true;
            } catch (e) {
                container.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
            }
        }
        
        function formatCompactNumber(num) {
            return Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(num);
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return Math.floor(seconds) + "s ago";
        }

        function openGithub1s() {
             const { owner, repo, ref, path } = currentRepoInfo;
             if (!owner || !repo) return;
             
             let url = `https://github1s.com/${owner}/${repo}`;
             if (ref) {
                 // github1s format: https://github1s.com/owner/repo/tree/ref/path
                 // If path is empty, it's just root of ref
                 
                 // Note: github1s handles /blob/ vs /tree/ gracefully, but let's stick to standard github URL structure
                 // If we have a path, and we are in explorer mode (folder), use tree.
                 url += `/tree/${ref}`;
                 if (path) {
                     url += `/${path}`;
                 }
             }
             window.open(url, '_blank');
        }

        // Initialize from URL params / åˆå§‹åŒ– URL å‚æ•°
        window.addEventListener('DOMContentLoaded', () => {
             const search = window.location.search;
             if (!search) return;

             let targetUrl = '';
             const params = new URLSearchParams(search);
             
             // 1. Check ?url=...
             if (params.get('url')) {
                 targetUrl = params.get('url');
             } else {
                 // 2. Fallback for ?https://github.com/... or ?user/repo
                 // Remove '?' and try to decode first
                 let raw = search.substring(1);
                 try {
                     raw = decodeURIComponent(raw);
                 } catch (e) {
                     console.error('URL decode failed:', e);
                 }
                 
                 // Basic validation to see if it looks like a URL or repo path
                 if (raw.startsWith('http') || raw.startsWith('github.com') || raw.split('/').length >= 2) {
                     targetUrl = raw;
                 }
             }
             
             if (targetUrl) {
                 $('#url').value = targetUrl;
                 // Small delay to ensure UI is ready
                 setTimeout(start, 100);
             }
        });
    </script>
</body>
</html>
