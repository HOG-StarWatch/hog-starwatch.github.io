<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repo Explorer</title>
    <script src="jszip.min.js" onerror="this.onerror=function(){this.onerror=null;this.src='https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';};this.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';"></script>
    <style>
        :root{--bg:#0d1117;--text:#c9d1d9;--border:#30363d;--hover:#161b22;--link:#58a6ff;--inp-bg:#0d1117;--inp-bd:#30363d;--btn-bg:#238636;--btn-tx:#fff;--btn-hv:#2ea043;--panel:#161b22;--act-bg:#21262d;--act-bd:#30363d}
        ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem;background:var(--bg);color:var(--text);transition:0.3s}
        h3{text-align:center;font-weight:300;letter-spacing:1px;margin-bottom:2rem;color:var(--text)}
        input,select{width:100%;padding:12px;margin-bottom:15px;border:1px solid var(--inp-bd);border-radius:6px;background:var(--inp-bg);color:var(--text);outline:none;transition:0.2s;box-sizing:border-box}
        input:focus,select:focus{border-color:var(--link)}
        button{padding:10px 20px;background:var(--btn-bg);color:var(--btn-tx);border:1px solid rgba(240,246,252,0.1);border-radius:6px;cursor:pointer;font-weight:600;transition:0.2s}
        button:hover{background:var(--btn-hv)}button:disabled{opacity:0.6;cursor:not-allowed}
        .tree-view{margin-top:20px;border:1px solid var(--border);border-radius:6px;padding:10px;max-height:70vh;overflow-y:auto;display:none;background:var(--panel)}
        .tree-item{padding:6px 0;border-radius:4px;transition:0.1s;display:flex;align-items:center}
        .tree-item:hover{background:var(--hover)}
        .tree-content{display:flex;align-items:center;justify-content:space-between;width:100%;padding-right:5px;white-space:nowrap}
        .tree-item-left{display:flex;align-items:center;overflow:hidden;height:auto;min-height:24px}
        .file-name{font-size:14px;color:var(--text);margin-left:5px;line-height:1.5}
        .action-btn{margin-left:8px;padding:3px 10px;font-size:12px;border:1px solid var(--act-bd);border-radius:20px;cursor:pointer;background:var(--act-bg);color:var(--text);transition:0.2s}
        .action-btn:hover{background:var(--link);color:#fff;border-color:var(--link)}
        .settings-toggle{font-size:13px;color:var(--link);cursor:pointer;margin-bottom:10px;display:inline-block;opacity:0.8;user-select:none}
        .settings-toggle::before{content:'â–¶';display:inline-block;margin-right:5px;font-size:10px;transition:transform 0.2s}
        .settings-toggle.open::before{transform:rotate(90deg)}
        .settings-panel{display:none;padding:20px;background:var(--panel);border:1px solid var(--border);border-radius:6px;margin-bottom:20px}
        .progress-container{margin-top:20px;display:none}.progress-bar-bg{width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
        .console-log{margin-top:15px;padding:10px;background:var(--act-bg);border:1px solid var(--border);border-radius:6px;font-family:monospace;font-size:12px;color:var(--text);max-height:150px;overflow-y:auto;display:none;white-space:pre-wrap;word-break:break-all}
        .progress-bar-fill{height:100%;background:var(--btn-bg);width:0%;transition:width 0.2s}
        .file-progress-wrap{width:50px;height:4px;background:var(--border);margin-left:8px;border-radius:2px;overflow:hidden;display:inline-block;vertical-align:middle}
        .file-progress-bar{width:0%;height:100%;background:#2ea44f;transition:width 0.3s}
        details>summary{cursor:pointer;list-style:none;user-select:none}details>summary::-webkit-details-marker{display:none}
        
        /* New Features CSS */
        .breadcrumbs-container{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:10px}
        .breadcrumbs{font-size:14px;color:var(--text);display:flex;flex-wrap:wrap;gap:5px;align-items:center}
        .breadcrumb-item{color:var(--link);cursor:pointer;text-decoration:none}
        .breadcrumb-item:hover{text-decoration:underline}
        .breadcrumb-separator{color:var(--text);opacity:0.5}
        
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;display:none;justify-content:center;align-items:center}
        .modal-content{background:var(--panel);width:90%;max-width:1000px;height:80vh;border-radius:8px;border:1px solid var(--border);display:flex;flex-direction:column;position:relative}
        .modal-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-body{flex:1;overflow:auto;padding:15px;background:var(--bg)}
        .close-modal{cursor:pointer;font-size:24px;color:var(--text)}
        .preview-code{font-family:monospace;white-space:pre;color:var(--text)}
        .preview-image{max-width:100%;display:block;margin:0 auto}
        
        .tree-checkbox{margin-right:8px;cursor:pointer;width:14px;height:14px;margin-top:0;vertical-align:middle;display:inline-block}
        .file-size{font-size:12px;color:#6a737d;margin-left:10px;min-width:60px;text-align:right}
        .icon-img{width:16px;height:16px;vertical-align:middle;margin-right:5px}
        
        .console-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
        .console-title{font-size:12px;color:#8b949e;font-weight:600}
        .console-clear{font-size:11px;color:var(--link);cursor:pointer;text-decoration:underline}
        
        details>summary .folder-arrow{display:inline-block;font-size:10px;margin-right:5px;transition:transform 0.2s;color:#8b949e}
        details[open]>summary .folder-arrow{transform:rotate(90deg)}
    </style>
</head>
<body>
    <h3>GitHub Repo Explorer / ä»“åº“æµè§ˆå™¨</h3>
    <input type="text" id="url" placeholder="Paste GitHub URL / ç²˜è´´ GitHub é“¾æ¥ (e.g. https://github.com/user/repo)">
    
    <div style="display:flex;gap:10px;justify-content:center;margin-bottom:15px">
        <button id="btn-analyze" onclick="start()">Analyze / è§£æé“¾æ¥</button>
        <button id="btn-download" onclick="downloadZip()" disabled>Download ZIP / ä¸‹è½½ ZIP</button>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="preview-title" style="font-weight:600">Preview</span>
                <span class="close-modal" onclick="closePreview()">Ã—</span>
            </div>
            <div class="modal-body" id="preview-body">Loading...</div>
        </div>
    </div>

    <div class="settings-toggle" onclick="toggleSettings(this)">Advanced Settings / é«˜çº§è®¾ç½®</div>
    <div class="settings-panel" id="settings-panel">
        <div style="margin-bottom:15px">
            <label>GitHub Token (Opt)</label>
            <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx">
            <div style="font-size:12px;color:#6a737d">æé«˜ API é€Ÿç‡é™åˆ¶ã€‚è­¦å‘Šï¼šé…ç½®å Token ä¼šå‘é€ç»™ä»£ç†ã€‚</div>
        </div>
        <div style="margin-bottom:15px">
            <label>API Proxy / API ä»£ç† (Opt)</label>
            <input type="text" id="api-proxy" placeholder="e.g. https://api.cors.me/">
            <div style="font-size:12px;color:#6a737d">GitHub API è¯·æ±‚å‰ç¼€ï¼Œç”¨äºç»•è¿‡ CORS æˆ–é€Ÿç‡é™åˆ¶ã€‚</div>
        </div>
        <div>
            <label>File URL Template / æ–‡ä»¶é“¾æ¥æ¨¡æ¿</label>
            <input type="text" id="url-template" value="https://raw.githubusercontent.com/{owner}/{repo}/{ref}/{path}">
            <div style="font-size:12px;color:#6a737d">æ„å»ºä¸‹è½½é“¾æ¥ã€‚å¯åœ¨æ­¤å¡«å…¥ä»£ç†ã€‚å ä½ç¬¦: {owner}, {repo}, {ref}, {path}ã€‚</div>
            <div style="font-size:11px;color:#8b949e;margin-top:5px;line-height:1.4">
                Examples:<br>
                - Default: <code>https://raw.githubusercontent.com/{owner}/{repo}/{ref}/{path}</code><br>
                - jsDelivr: <code>https://cdn.jsdelivr.net/gh/{owner}/{repo}@{ref}/{path}</code><br>
                - Proxy: <code>https://ghproxy.com/https://raw.githubusercontent.com/{owner}/{repo}/{ref}/{path}</code>
            </div>
        </div>
    </div>

    <div class="progress-container" id="progress-container">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-bar"></div></div>
        <div style="text-align:center;margin-top:8px;font-size:13px;color:#8b949e" id="status-text">Ready / å°±ç»ª</div>
    </div>
    
    <div class="breadcrumbs-container" id="breadcrumbs-container" style="display:none; margin-top: 20px;">
        <div id="breadcrumbs" class="breadcrumbs"></div>
        <select id="ref-selector" onchange="onRefChange()" style="width:auto;padding:4px 10px;margin:0;font-size:13px"></select>
    </div>
    <div id="tree-view" class="tree-view"></div>

    <div id="console-container" style="display:none;margin-top:15px">
        <div class="console-header">
            <span class="console-title">Console Output</span>
            <span class="console-clear" onclick="clearLog()">Clear</span>
        </div>
        <div id="console-log" class="console-log" style="display:block;margin-top:0"></div>
    </div>

    <script>
        const $ = s => document.querySelector(s);
        const log = t => {
             const st = $('#status-text');
             if(st) st.innerText = t;
             
             const container = $('#console-container');
             const cl = $('#console-log');
             if (cl && container) {
                 container.style.display = 'block';
                 const line = document.createElement('div');
                 const time = new Date().toLocaleTimeString();
                 line.innerText = `[${time}] ${t}`;
                 line.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                 line.style.padding = '2px 0';
                 cl.appendChild(line);
                 cl.scrollTop = cl.scrollHeight;
             }
             console.log(t);
        };
        
        function clearLog() {
            const cl = $('#console-log');
            if(cl) cl.innerHTML = '';
            $('#console-container').style.display = 'none';
        }
        const setProgress = (percent) => {
            $('#progress-bar').style.width = `${percent}%`;
            $('#progress-container').style.display = 'block';
        };

        const TEXT = {
            download: 'Download / ä¸‹è½½',
            zip: 'Zip / æ‰“åŒ…',
            copied: 'Copied! / å·²å¤åˆ¶!',
            failedCopy: 'Failed / å¤±è´¥',
            error: 'Error / é”™è¯¯',
            analyzing: 'Analyzing... / è§£æä¸­...',
            fetchingBranches: 'Fetching branches... / è·å–åˆ†æ”¯...',
            fetchingRepos: 'Fetching repos... / è·å–ä»“åº“...',
            fetchingFileList: 'Fetching file list... / è·å–æ–‡ä»¶åˆ—è¡¨...',
            selectRepo: 'Select Repo / é€‰æ‹©ä»“åº“',
            noFilesFound: 'No files found / æœªæ‰¾åˆ°æ–‡ä»¶',
            invalidUrl: 'Invalid URL / æ— æ•ˆé“¾æ¥',
            downloadingFiles: 'Downloading files... / ä¸‹è½½æ–‡ä»¶ä¸­...',
            zipping: 'Zipping... / æ‰“åŒ…ä¸­...',
            done: 'Done! / å®Œæˆ!',
            enterUrl: 'Please enter a URL / è¯·è¾“å…¥é“¾æ¥',
            analysisComplete: 'Analysis complete. Found {count} files. / è§£æå®Œæˆ, å…±æ‰¾åˆ° {count} ä¸ªæ–‡ä»¶.',
            preview: 'Preview / é¢„è§ˆ',
            close: 'Close / å…³é—­',
            noSelection: 'No files selected / æœªé€‰æ‹©æ–‡ä»¶'
        };
        const t = (k, args = {}) => {
            let str = TEXT[k] || k;
            for (let key in args) {
                str = str.replace(new RegExp(`{${key}}`, 'g'), args[key]);
            }
            return str;
        };

        let currentFiles = [];
        let currentRepoInfo = {};
        let currentRefs = [];

        function toggleSettings(el) {
            const panel = $('#settings-panel');
            const isOpen = panel.style.display === 'block';
            panel.style.display = isOpen ? 'none' : 'block';
            if (el) el.classList.toggle('open', !isOpen);
        }

        async function fetchWithProxy(url, type = 'api') {
            const apiProxy = $('#api-proxy').value.trim();
            const token = $('#gh-token').value.trim();
            const headers = {};
            if (token) headers['Authorization'] = `token ${token}`;

            let finalUrl = url;
            if (type === 'api' && apiProxy) {
                finalUrl = apiProxy + url;
            } 
            
            return fetch(finalUrl, { headers });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                log(`${t('copied')}: ${text}`);
            }).catch(err => {
                console.error(t('failedCopy'), err);
                log(t('failedCopy') + ': ' + err);
            });
        }

        function formatSize(bytes) {
            if (bytes === undefined || bytes === null) return '';
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return `${bytes.toFixed(1)} ${units[i]}`;
        }

        function getFileIcon(filename) {
            return 'ğŸ“„';
        }

        // é¢„è§ˆé€»è¾‘
        async function previewFile(url, filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const isImg = ['png','jpg','jpeg','gif','svg'].includes(ext);
            
            $('#preview-title').innerText = filename;
            $('#preview-body').innerHTML = 'Loading...';
            $('#preview-modal').style.display = 'flex';
            
            try {
                if (isImg) {
                    $('#preview-body').innerHTML = `<img src="${url}" class="preview-image">`;
                } else {
                    // Use fetch directly to match download behavior and avoid unwanted proxying
                    // if the URL is already absolute.
                    const text = await fetch(url).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.text();
                    });
                    
                    // Simple escape
                    const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    $('#preview-body').innerHTML = `<div class="preview-code">${safeText}</div>`;
                }
            } catch (e) {
                console.error('Preview error:', e);
                $('#preview-body').innerText = t('error') + ': ' + e.message;
            }
        }
        
        function closePreview() {
            $('#preview-modal').style.display = 'none';
        }
        
        function toggleAll(checkbox) {
            const type = checkbox.getAttribute('data-type');
            if (type === 'folder') {
                const details = checkbox.closest('details');
                if (details) {
                     const container = details.querySelector('.children-container');
                     if (container) {
                         const children = container.querySelectorAll('.tree-checkbox');
                         children.forEach(c => c.checked = checkbox.checked);
                     }
                }
            }
        }

        function renderBreadcrumbs(owner, repo, branch, path) {
            const container = $('#breadcrumbs');
            container.innerHTML = '';
            
            const parts = [
                { name: owner, url: `https://github.com/${owner}` },
                { name: repo, url: `https://github.com/${owner}/${repo}` },
                { name: branch, url: `https://github.com/${owner}/${repo}/tree/${branch}` }
            ];
            
            if (path) {
                path.split('/').forEach((p, i, arr) => {
                    const currentPath = arr.slice(0, i + 1).join('/');
                    parts.push({ 
                        name: p, 
                        url: `https://github.com/${owner}/${repo}/tree/${branch}/${currentPath}`,
                        isPath: true
                    });
                });
            }
            
            parts.forEach((p, i) => {
                const span = document.createElement('span');
                span.className = 'breadcrumb-item';
                span.innerText = p.name;
                span.onclick = () => {
                     $('#url').value = p.url;
                     start();
                };
                container.appendChild(span);
                
                if (i < parts.length - 1) {
                    const sep = document.createElement('span');
                    sep.className = 'breadcrumb-separator';
                    sep.innerText = '/';
                    container.appendChild(sep);
                }
            });
        }

        // ç›®å½•æ ‘æ¸²æŸ“é€»è¾‘
        function renderTree(files, rootPath) {
            const tree = {};
            
            // æ„å»ºæ ‘ç»“æ„
            files.forEach(file => {
                const relativePath = file.path.replace(rootPath, '').replace(/^\//, '');
                const parts = relativePath.split('/');
                let current = tree;
                
                parts.forEach((part, i) => {
                    if (!current[part]) {
                        current[part] = (i === parts.length - 1) ? { __file: file } : { __path: (current.__path ? current.__path + '/' : (rootPath ? rootPath + '/' : '')) + part };
                    }
                    current = current[part];
                });
            });
            // ä¿®å¤æ ¹è·¯å¾„è¿½è¸ª
            function fixPath(node, prefix) {
                Object.keys(node).forEach(key => {
                    if (key.startsWith('__')) return;
                    const fullPath = prefix ? prefix + '/' + key : key;
                    if (!node[key].__file) {
                        node[key].__path = fullPath;
                        fixPath(node[key], fullPath);
                    }
                });
            }
            fixPath(tree, rootPath);

            const container = $('#tree-view');
            container.innerHTML = '';
            container.style.display = 'block';
            
            function createNode(name, obj, indent) {
                const isFile = obj.__file;
                const isFolder = !isFile;

                const div = document.createElement('div');
                div.className = 'tree-item';
                div.style.paddingLeft = (indent * 20) + 'px';
                
                // å›¾æ ‡é€»è¾‘
                const iconHtml = isFile 
                    ? `<span class="file-icon">${getFileIcon(name)}</span>` 
                    : `<span class="folder-arrow">â–¶</span><span class="folder-icon">ğŸ“‚</span>`;

                let actionsHtml = '';
                let progressHtml = '';
                let sizeHtml = '';
                let clickAction = '';

                if (isFile) {
                    const safeId = 'file-' + obj.__file.path.replace(/[^a-zA-Z0-9]/g, '-');
                    obj.__file.domId = safeId; // å­˜å‚¨ ID ä»¥ä¾¿æ›´æ–°
                    
                    progressHtml = `
                        <div class="file-progress-wrap">
                            <div class="file-progress-bar" id="${safeId}"></div>
                        </div>
                    `;
                    actionsHtml = `
                        <span class="action-btn" onclick="copyToClipboard('${obj.__file.repoUrl}')" title="Copy GitHub Link">Repo</span>
                        <span class="action-btn" onclick="copyToClipboard('${obj.__file.url}')" title="Copy Raw Link">Raw</span>
                        <span class="action-btn" onclick="downloadSingleFile('${obj.__file.url}', '${name}')" title="Download File">${t('download')}</span>
                    `;
                    sizeHtml = `<span class="file-size">${formatSize(obj.__file.size)}</span>`;
                    
                    // é¢„è§ˆæ“ä½œ
                    clickAction = `onclick="previewFile('${obj.__file.url}', '${name}')" style="cursor:pointer; text-decoration:underline;"`;
                } else {
                    // æ–‡ä»¶å¤¹æ“ä½œ
                    const folderPath = obj.__path;
                    const repoUrl = `https://github.com/${currentRepoInfo.owner}/${currentRepoInfo.repo}/tree/${currentRepoInfo.ref}/${folderPath}`;
                    actionsHtml = `
                         <span class="action-btn" onclick="copyToClipboard('${repoUrl}')" title="Copy GitHub Link">Repo</span>
                         <span class="action-btn" onclick="downloadFolderZip('${folderPath}')" title="Download Folder as ZIP">${t('zip')}</span>
                    `;
                }

                // å¤é€‰æ¡†
                const checkboxHtml = `<input type="checkbox" class="tree-checkbox" checked onchange="toggleAll(this)" data-path="${isFile ? obj.__file.path : obj.__path}" data-type="${isFile ? 'file' : 'folder'}">`;

                div.innerHTML = `
                    <div class="tree-content">
                        <div class="tree-item-left">
                            ${checkboxHtml}
                            ${iconHtml}
                            <span class="file-name" title="${name}" ${clickAction}>${name}</span>
                        </div>
                        <div style="display:flex; align-items:center;">
                            ${sizeHtml}
                            ${actionsHtml}
                            ${progressHtml}
                        </div>
                    </div>
                `;
                
                if (isFolder) {
                    const details = document.createElement('details');
                    // details.open = true; // Default collapsed
                    const summary = document.createElement('summary');
                    summary.appendChild(div);
                    details.appendChild(summary);
                    
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'children-container';
                    childrenContainer.style.paddingLeft = '20px';
                    details.appendChild(childrenContainer);
                    
                    // é€’å½’è°ƒç”¨å­èŠ‚ç‚¹
                    
                    // æ’åºï¼šæ–‡ä»¶å¤¹ä¼˜å…ˆ
                    const keys = Object.keys(obj).filter(k => !k.startsWith('__'));
                    const folders = keys.filter(k => !obj[k].__file).sort();
                    const files = keys.filter(k => obj[k].__file).sort();
                    
                    [...folders, ...files].forEach(key => {
                        const childNode = createNode(key, obj[key], indent + 1);
                        childrenContainer.appendChild(childNode);
                    });
                    
                    details.appendChild(childrenContainer);
                    return details;
                } else {
                    return div;
                }
            }
            
            // æ ¹ç›®å½•æ’åº
            const keys = Object.keys(tree).filter(k => !k.startsWith('__'));
            const folders = keys.filter(k => !tree[k].__file).sort();
            const rootFiles = keys.filter(k => tree[k].__file).sort();
            
            [...folders, ...rootFiles].forEach(key => {
                const node = createNode(key, tree[key], 0);
                container.appendChild(node);
            });
        }

        function parseGitHubUrl(url) {
            url = url.trim();
            if (url.startsWith('git@github.com:')) {
                url = url.replace('git@github.com:', 'https://github.com/').replace(/\.git$/, '');
            }
            
            // å¤„ç† raw.githubusercontent.com
            // Format: https://raw.githubusercontent.com/owner/repo/ref/path
            const rawMatch = url.match(/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/([^/]+)\/(.+)/);
            if (rawMatch) {
                return {
                    owner: rawMatch[1],
                    repo: rawMatch[2],
                    type: 'blob',
                    ref: rawMatch[3],
                    path: rawMatch[4]
                };
            }

            url = url.replace(/\.git$/, '');
            
            // å¤„ç† /commit/SHA -> å°† SHA è§†ä¸ºå¼•ç”¨
            const commitMatch = url.match(/github\.com\/([^/]+)\/([^/]+)\/commit\/([a-f0-9]+)/);
            if (commitMatch) {
                return {
                    owner: commitMatch[1],
                    repo: commitMatch[2],
                    type: 'tree', // treat as tree root
                    ref: commitMatch[3],
                    path: ''
                };
            }
            
            // å¤„ç†ç”¨æˆ·ä¸»é¡µé“¾æ¥
            // Regex for user: github.com/username (and optional /)
            
            const userMatch = url.match(/github\.com\/([^/]+)\/?$/);
            if (userMatch) {
                 return {
                     owner: userMatch[1],
                     type: 'user'
                 };
            }

            const match = url.match(/github\.com\/([^/]+)\/([^/]+)(?:\/(tree|blob)\/([^/]+)(?:\/(.*))?)?/);
            if (!match) return null;
            return {
                owner: match[1],
                repo: match[2],
                type: match[3],
                ref: match[4], // branch or tag or commit
                path: match[5] || ''
            };
        }
        
        async function downloadSingleFile(url, filename) {
             try {
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = filename;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
             } catch (e) {
                 console.error(e);
                 log(t('error') + ': ' + e.message);
             }
        }

        function getSelectedFiles(scopePath = null) {
            // æŸ¥æ‰¾æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
            const checkedInputs = Array.from(document.querySelectorAll('.tree-checkbox:checked[data-type="file"]'));
            const checkedPaths = new Set(checkedInputs.map(i => i.getAttribute('data-path')));
            
            let files = currentFiles.filter(f => checkedPaths.has(f.path));
            
            if (scopePath) {
                 files = files.filter(f => f.path === scopePath || f.path.startsWith(scopePath + '/'));
            }
            return files;
        }

        async function downloadFolderZip(folderPath) {
            const filesToZip = getSelectedFiles(folderPath);
            
            if (filesToZip.length === 0) {
                log(t('noSelection'));
                return;
            }
            
            const { owner, repo, ref } = currentRepoInfo;
            const safeRef = ref.replace(/[\/\\]/g, '-');
            const safePath = folderPath.replace(/[\/\\]/g, '-');
            const zipName = `${owner}-${repo}-${safeRef}-${safePath}.zip`;

            await downloadFilesAsZip(filesToZip, zipName);
        }

        async function downloadFilesAsZip(files, zipName) {
            $('#btn-analyze').disabled = true;
            $('#btn-download').disabled = true;
            
             const zip = new JSZip();
             let count = 0;
             log(t('downloadingFiles', { count: files.length }));
             setProgress(0);

             // å¹¶å‘ä¸‹è½½é™åˆ¶
             const limit = 10;
             for (let i = 0; i < files.length; i += limit) {
                 await Promise.all(files.slice(i, i + limit).map(async f => {
                     const bar = f.domId ? document.getElementById(f.domId) : null;
                     if(bar) bar.style.width = '20%'; 
                     
                     try {
                         const blob = await fetch(f.url).then(r => r.blob());
                         zip.file(f.path, blob);
                         if(bar) bar.style.width = '100%';
                     } catch (e) { 
                         console.error(e);
                         if(bar) {
                             bar.style.backgroundColor = 'red';
                             bar.style.width = '100%';
                         }
                     }
                     count++;
                     const percent = (count / files.length * 100).toFixed(0);
                     log(`${t('downloadingFiles', { count: files.length })} (${percent}%)`);
                     setProgress(percent);
                 }));
             }

            zip.generateAsync({type:"blob"}).then(function(content) {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = zipName;
                a.click();
                
                log(t('done'));
                $('#progress-container').style.display = 'none';
                $('#btn-download').disabled = false;
            });
        }

        async function start() {
            const url = $('#url').value.trim();
            if (!url) return log(t('enterUrl'));
            
            $('#btn-analyze').disabled = true;
            $('#btn-download').disabled = true;
            $('#progress-container').style.display = 'none';
            $('#progress-bar').style.width = '0%';
            $('#tree-view').style.display = 'none';
            log(t('analyzing'));

            // è§£æ URL
            const parsed = parseGitHubUrl(url);
            if (!parsed) {
                log(t('invalidUrl'));
                $('#btn-analyze').disabled = false;
                return;
            }
            
            const { owner, repo, type, path: urlPath } = parsed;
            let ref = parsed.ref;
            let path = urlPath;
            
            // å¤„ç†ç”¨æˆ·ä¸»é¡µé€»è¾‘
            if (parsed.type === 'user') {
                await handleUserRepos(parsed.owner);
                return;
            }

            log(t('fetchingBranches'));
            
            try {
                // è·å–æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾
                // ç”¨äºåŒºåˆ† URL ä¸­çš„åˆ†æ”¯åå’Œè·¯å¾„
                // e.g. tree/feature/new/logic/src/index.js -> is branch "feature/new" or "feature/new/logic"?
                const [branches, tags] = await Promise.all([
                    fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}/branches`).then(r => r.json()),
                    fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}/tags`).then(r => r.json())
                ]);

                if (branches.message) throw new Error(branches.message);

                const branchNames = branches.map(b => b.name);
                const tagNames = tags.map(t => t.name);
                const refs = [...branchNames, ...tagNames].sort((a, b) => b.length - a.length); // Sort by length desc
                currentRefs = refs; // Store for selector

                // è‹¥æœªæŒ‡å®šå¼•ç”¨ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤åˆ†æ”¯
                if (!ref) {
                     const repoInfo = await fetchWithProxy(`https://api.github.com/repos/${owner}/${repo}`).then(r => r.json());
                     ref = repoInfo.default_branch || 'master';
                } else {
                     // å°è¯•ä» URL åŒ¹é…å¼•ç”¨
                     // The URL parser might have captured "branch/path/to/file" as "branch" and "path/to/file"
                     // We need to check if the captured "ref" is actually part of a longer branch name
                     const potentialRef = ref + (path ? '/' + path : '');
                     const matchedRef = refs.find(r => potentialRef === r || potentialRef.startsWith(r + '/'));
                     
                     if (matchedRef) {
                         ref = matchedRef;
                         path = potentialRef.substring(matchedRef.length).replace(/^\//, '');
                     }
                }
                
                // å¡«å……å¼•ç”¨é€‰æ‹©å™¨
                const selector = $('#ref-selector');
                selector.innerHTML = '';
                
                // æ˜¾ç¤ºæ’åºï¼šä¸»åˆ†æ”¯ä¼˜å…ˆ
                const displayRefs = [...currentRefs].sort((a, b) => {
                    const pA = (a === 'main' || a === 'master') ? 1 : 0;
                    const pB = (b === 'main' || b === 'master') ? 1 : 0;
                    if (pA !== pB) return pB - pA; // Higher priority first
                    return a.localeCompare(b);
                });

                displayRefs.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r;
                    option.text = r;
                    option.selected = r === ref;
                    selector.appendChild(option);
                });
                
                $('#breadcrumbs-container').style.display = 'flex'; // Show breadcrumbs container

                currentRepoInfo = { owner, repo, path: path || '' };
                await fetchAndRenderTree(owner, repo, ref, path);

            } catch (e) {
                console.error(e);
                log(t('error') + ': ' + e.message);
            } finally {
                $('#btn-analyze').disabled = false;
            }
        }
        
        async function handleUserRepos(owner) {
             log(t('fetchingRepos'));
             try {
                 const repos = await fetchWithProxy(`https://api.github.com/users/${owner}/repos?per_page=100&sort=updated`).then(r => r.json());
                 if (repos.message) throw new Error(repos.message);
                 if (!repos.length) throw new Error(t('noFilesFound')); // å¤ç”¨æ¶ˆæ¯
                 
                 const container = $('#tree-view');
                 container.innerHTML = '';
                 container.style.display = 'block';
                 
                 const ul = document.createElement('div');
                 repos.forEach(repo => {
                     const div = document.createElement('div');
                     div.className = 'tree-item';
                     div.style.padding = '5px 10px';
                     div.style.cursor = 'pointer';
                     div.innerHTML = `
                         <div style="display:flex; align-items:center;">
                             <span class="folder-icon">ğŸ“¦</span>
                             <span class="file-name" style="font-weight:600">${repo.name}</span>
                             <span style="margin-left:10px; font-size:12px; color:#6a737d;">${repo.description || ''}</span>
                         </div>
                     `;
                     div.onclick = () => {
                         $('#url').value = repo.html_url;
                         start();
                     };
                     ul.appendChild(div);
                 });
                 container.appendChild(ul);
                 
                 log(t('selectRepo'));
                 $('#breadcrumbs-container').style.display = 'none';
                 
             } catch (e) {
                 console.error(e);
                 log(t('error') + ': ' + e.message);
             } finally {
                 $('#btn-analyze').disabled = false;
             }
        }
        
        async function onRefChange() {
             const ref = $('#ref-selector').value;
             const { owner, repo, path } = currentRepoInfo;
             if (!owner || !repo) return;
             
             $('#btn-analyze').disabled = true;
             $('#btn-download').disabled = true;
             
             try {
                 await fetchAndRenderTree(owner, repo, ref, path);
             } catch(e) {
                 console.error(e);
                 log(t('error') + ': ' + e.message);
             } finally {
                 $('#btn-analyze').disabled = false;
             }
        }

        async function fetchAndRenderTree(owner, repo, ref, path) {
            log(t('fetchingFileList'));
            let files = [];
            
            // æ£€æŸ¥æ˜¯å¦ä¸º blob URLï¼ŒåŒºåˆ†æ–‡ä»¶å’Œç›®å½•
            // If path is provided, we need to check if it's a file or directory. 
            // The previous logic used 'type' from URL, but now we might change branch.
            // Let's assume tree first.
            
            try {
                 const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${ref}?recursive=1`;
                 const treeData = await fetchWithProxy(treeUrl).then(r => r.json());
                 
                 if (treeData.message) throw new Error(treeData.message);
                 
                 files = treeData.tree
                     .filter(i => i.type === 'blob'); // Only files

                 if (path) {
                     // Check if path exists as a directory prefix or exact file match
                     files = files.filter(i => i.path === path || i.path.startsWith(path + '/'));
                 }
                 
                 // è‹¥æœªæ‰¾åˆ°æ–‡ä»¶
                 // If Tree API fails (e.g. repo too large), maybe fallback or error
            } catch (e) {
                // è‹¥ Tree API å¤±è´¥
                throw e;
            }
            
            if (!files.length) throw new Error(t('noFilesFound'));

            // ä½¿ç”¨æ¨¡æ¿å¤„ç† URL
            const template = $('#url-template').value.trim();
            const branch = ref; // Use resolved ref as branch
            files = files.map(i => {
                let fileUrl = template
                    .replace('{owner}', owner)
                    .replace('{repo}', repo)
                    .replace('{ref}', branch)
                    .replace('{branch}', branch)
                    .replace('{path}', i.path);
                
                const repoUrl = `https://github.com/${owner}/${repo}/blob/${branch}/${i.path}`;

                return { 
                    path: i.path, 
                    url: fileUrl,
                    repoUrl: repoUrl,
                    size: i.size // Capture size
                };
            });

            currentFiles = files; // Store for download
            // currentRepoInfo è·¯å¾„å·²è®¾ç½®
            currentRepoInfo.ref = ref; // Update ref in state

            // æ¸²æŸ“ç›®å½•æ ‘
            renderBreadcrumbs(owner, repo, branch, path);
            renderTree(files, path);
            
            log(t('analysisComplete', { count: files.length }));
            $('#btn-download').disabled = false;
        }

        async function downloadZip() {
            const filesToZip = getSelectedFiles();
            if (filesToZip.length === 0) {
                log(t('noSelection'));
                return;
            }
            
            const { owner, repo, ref, path } = currentRepoInfo;
            const safeRef = ref.replace(/[\/\\]/g, '-');
            let zipName = `${owner}-${repo}-${safeRef}`;
            
            if (path) {
                 const safePath = path.replace(/[\/\\]/g, '-');
                 zipName += `-${safePath}`;
            }
            zipName += '.zip';

            await downloadFilesAsZip(filesToZip, zipName);
        }
    </script>
</body>
</html>
