<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巴别图书馆</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0908;
            --bg-medium: #1a1612;
            --parchment: #f4f1e8;
            --parchment-dark: #e8e4d9;
            --ink: #2c2416;
            --ink-light: #5c4a32;
            --gold: #d4af37;
            --gold-light: #f4cf67;
            --gold-dark: #8b7355;
            --crimson: #8b3a3a;
            --emerald: #2d6a4f;
            --sapphire: #3a5a8a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Serif SC', serif;
            background: var(--bg-dark);
            color: var(--parchment);
            min-height: 100vh;
            line-height: 1.8;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        header {
            position: relative;
            background: linear-gradient(180deg, var(--bg-medium) 0%, var(--bg-dark) 100%);
            padding: 3rem 2rem;
            text-align: center;
            border-bottom: 2px solid var(--gold-dark);
            overflow: hidden;
            z-index: 1;
        }
        header::before {
            content: '';
            position: absolute;
            top: 0; left: 50%;
            transform: translateX(-50%);
            width: 200%;
            height: 100%;
            background: radial-gradient(ellipse at center top, rgba(212,175,55,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        h1 {
            font-family: 'ZCOOL XiaoWei', serif;
            font-size: clamp(2rem, 6vw, 3.5rem);
            color: var(--gold);
            letter-spacing: 0.4em;
            text-shadow: 0 0 30px rgba(212,175,55,0.5), 0 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 0.5rem;
            animation: glow 4s ease-in-out infinite;
        }
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 30px rgba(212,175,55,0.5), 0 2px 4px rgba(0,0,0,0.5); }
            50% { text-shadow: 0 0 50px rgba(212,175,55,0.8), 0 2px 4px rgba(0,0,0,0.5); }
        }
        .subtitle { font-style: italic; color: var(--parchment); opacity: 0.7; font-size: 1.1rem; }

        nav {
            position: sticky;
            top: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            background: linear-gradient(180deg, var(--bg-medium) 0%, rgba(26,22,18,0.95) 100%);
            border-bottom: 1px solid var(--gold-dark);
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        nav button {
            font-family: 'Noto Serif SC', serif;
            padding: 0.7rem 1.5rem;
            background: transparent;
            color: var(--gold);
            border: 1px solid var(--gold-dark);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        nav button::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212,175,55,0.2), transparent);
            transition: left 0.5s;
        }
        nav button:hover::before { left: 100%; }
        nav button:hover {
            background: rgba(212,175,55,0.1);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212,175,55,0.2);
        }
        nav button.active {
            background: var(--gold);
            color: var(--bg-dark);
            font-weight: 600;
            box-shadow: 0 0 20px rgba(212,175,55,0.4);
        }

        main {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        .section { display: none; animation: fadeSlideIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .book-container {
            background: linear-gradient(145deg, #fffef9 0%, #f8f5ec 100%);
            border: none;
            border-radius: 4px;
            box-shadow: 
                0 0 0 1px var(--gold-dark),
                0 0 0 4px var(--bg-medium),
                0 0 0 5px var(--gold-dark),
                0 20px 60px rgba(0,0,0,0.5),
                inset 0 0 100px rgba(212,175,55,0.05);
            padding: 2.5rem;
            margin: 1.5rem 0;
            position: relative;
            overflow: hidden;
        }
        .book-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
        }

        .page-content {
    font-family: 'Courier New', 'Noto Serif SC', monospace; /* 等宽字体是网格排版的基础 */
    font-size: 0.9rem; /* 稍微调大一点字体，看清楚 */
    line-height: 1.6; /* 行高固定 */
    
    /* 核心修改：锁定物理尺寸 */
    height: 700px; /* 强制高度，根据3200字估算 */
    width: 100%;
    
    /* 关键：保留空白符的物理占位 */
    white-space: pre-wrap; /* 允许换行，但保留空格的宽度 */
    word-break: break-all; /* 强制在字符间换行，保持网格整齐 */
    
    padding: 2rem;
    background: linear-gradient(to bottom, #fffff8 0%, #fffef5 100%);
    border: 1px solid #e0d9c8;
    color: var(--ink);
    position: relative;
    box-shadow: inset 0 0 30px rgba(0,0,0,0.05);
    
    /* 允许内容过多时滚动，但通常3200字应该刚好填满 */
    overflow-y: auto; 
    
    /* 装饰：左侧装订线 */
    border-left: 5px double #d4c5a9;
    
    background-image: repeating-linear-gradient(
    transparent,
    transparent 1.5em, /* 对应 line-height - 1px */
    rgba(0, 0, 0, 0.03) 1.5em,
    rgba(0, 0, 0, 0.03) 1.6em /* 对应 line-height */
);
background-attachment: local;
}
        .page-content::before {
            content: '';
            position: absolute;
            left: 0; top: 0;
            width: 3px; height: 100%;
            background: linear-gradient(to bottom, #d4c5a9, #c4b599, #d4c5a9);
        }

        /* 修改 page-info 让它支持横向排列 */
/* --- 布局容器重构 --- */
.page-info-container {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #d4c5a9;
    color: var(--ink);
}

.layout-row {
    display: flex;
    gap: 1.5rem; /* 封面和信息的间距 */
    margin-bottom: 1.5rem;
    align-items: flex-start; /* 顶部对齐 */
}

/* --- 封面样式 (复用之前的逻辑，微调尺寸) --- */
.book-cover {
    width: 70px;  /* 稍微大一点点 */
    height: 100px;
    background: #2c2416;
    border-radius: 2px 4px 4px 2px;
    box-shadow: 4px 4px 10px rgba(0,0,0,0.3);
    flex-shrink: 0; /* 禁止被压缩 */
    position: relative;
    margin-top: 1.3rem;
    overflow: hidden;
    transition: transform 0.3s;
}
.book-cover:hover { transform: scale(1.02); }
.book-cover::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
    background: linear-gradient(to right, rgba(255,255,255,0.2), transparent); z-index: 2;
}

/* --- 右侧详情栏 --- */
.book-details {
    flex: 1; /* 占据剩余宽度 */
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 0; /* 关键：防止长文本撑破flex容器 */
}

/* 1. 确保位置信息绝不换行 */
.meta-row {
    line-height: 1.5;
    font-size: 0.95rem;
    
    /* 关键：强制整行不换行 */
    white-space: nowrap; 
    /* 如果屏幕实在太小，允许溢出部分隐藏（防止破坏布局） */
    overflow: hidden; 
    text-overflow: ellipsis;
}

#locationInfo {
    color: var(--ink);
    font-weight: 600; /* 加粗一点更清晰 */
}

.meta-label {
    /* 原来是 --ink-light (浅褐)，改成 --gold-dark (深金褐) 或者直接用深色 */
    color: #4a3b2a; /* 一个更深、对比度更高的褐色 */
    font-size: 0.85rem;
    display: inline-block;
    min-width: 45px;
    font-weight: 700; /* 加粗！让它不再隐形 */
}

#locationInfo {
    color: var(--ink); /* 使用最深的墨色 #2c2416 */
    font-weight: 500;
}

/* 2. 书名：单行、横向滚动、可复制 */
.book-title-text {
    /* 必须是块级或行内块才能滚动 */
    display: block; 
    width: 100%;
    
    /* 强制不换行 */
    white-space: nowrap;
    
    /* 允许横向滚动 */
    overflow-x: auto; 
    overflow-y: hidden;
    
    /* 视觉样式 */
    font-style: italic;
    color: var(--ink);
    font-weight: 600;
    background: linear-gradient(to right, rgba(212,175,55,0.15), transparent);
    padding: 2px 4px;
    border-left: 2px solid var(--gold);
    
    /* 新增：保证最小高度 */
    min-height: 1.5em;
    line-height: 1.5;
    
    /* 关键：允许用户长按选择/复制文本 */
    user-select: text;
    -webkit-user-select: text;
    cursor: text;
    
    /* 滚动条美化 */
    scrollbar-width: none;
    -ms-overflow-style: none;
}

/* 针对 Chrome/Safari 隐藏滚动条 */
.book-title-text::-webkit-scrollbar {
    display: none;
}

/* --- 空间漫游控制台 --- */
.spatial-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 0.5rem;
    background: rgba(0,0,0,0.03);
    padding: 0.5rem;
    border-radius: 4px;
    border: 1px solid rgba(212,175,55,0.2);
    width: fit-content;
}

.spatial-group {
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.spatial-divider {
    width: 1px; height: 20px;
    background: var(--gold-dark);
    opacity: 0.3;
}

.spatial-label {
    font-size: 0.7rem;
    color: var(--gold-dark);
    text-transform: uppercase;
    margin-right: 0.2rem;
}

.spatial-btn {
    width: 24px; height: 24px;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg-medium);
    border: 1px solid var(--gold-dark);
    color: var(--gold);
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.6rem;
    transition: all 0.2s;
}
.spatial-btn:hover {
    background: var(--gold);
    color: var(--bg-dark);
    transform: translateY(-1px);
}
.spatial-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    transform: none;
}

/* 可读化开关禁用状态 */
.toggle:disabled, .toggle[disabled] {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
}

/* --- 底部页码导航条 --- */
.page-navigation-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255,255,255,0.5);
    padding: 0.5rem;
    border-radius: 4px;
    border: 1px solid #d4c5a9;
}
.nav-btn {
    padding: 0.4rem 1rem;
    font-size: 0.9rem;
    background: transparent;
    border: 1px solid var(--gold-dark);
    color: var(--ink);
    border-radius: 3px;
    cursor: pointer;
}
.nav-btn:hover:not(:disabled) {
    background: rgba(212,175,55,0.1);
}
.nav-btn:disabled { opacity: 0.5; cursor: default; border-color: #ccc; }

.page-input-wrapper {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    color: var(--ink-light);
}
#pageInput {
    width: 45px; text-align: center; border:none; border-bottom:1px solid var(--gold);
    background: transparent; color: var(--ink); font-weight: bold;
}
        .page-info strong { color: var(--ink-light); }

        .book-title {
            font-style: italic;
            color: var(--ink);
            background: linear-gradient(to right, rgba(212,175,55,0.1), transparent);
            padding: 0.2rem 0.5rem;
            border-left: 2px solid var(--gold);
        }

        .coordinate {
            font-family: 'Courier New', monospace;
            font-size: 0.5rem;
            background: linear-gradient(to bottom, #f0ebe0, #e8e3d8);
            padding: 0.8rem;
            border: 1px solid #d4c5a9;
            border-radius: 3px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
            color: var(--ink);
            line-height: 1.4;
        }

        .page-navigation { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        
        .btn, .page-navigation button {
            font-family: 'Noto Serif SC', serif;
            padding: 0.6rem 1.2rem;
            background: linear-gradient(145deg, var(--ink) 0%, #1a1510 100%);
            color: var(--gold);
            border: 1px solid var(--gold-dark);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        .btn:hover, .page-navigation button:hover {
            background: linear-gradient(145deg, var(--gold) 0%, #c4a030 100%);
            color: var(--ink);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212,175,55,0.3);
        }
        .btn:disabled, .page-navigation button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--gold-dark);
        }
        .btn-secondary:hover {
            background: rgba(212,175,55,0.1);
            color: var(--gold);
        }

        .page-navigation input {
            width: 50px;
            padding: 0.5rem;
            text-align: center;
            font-family: 'Courier New', monospace;
            border: 1px solid #d4c5a9;
            background: #fffff8;
            border-radius: 3px;
            color: var(--ink);
        }

        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; color: var(--gold); }
        
        textarea, input[type="text"] {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            border: 1px solid var(--gold-dark);
            background: rgba(255,255,255,0.05);
            color: var(--parchment);
            border-radius: 3px;
            font-family: inherit;
            transition: all 0.3s;
        }
        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(212,175,55,0.2);
            background: rgba(255,255,255,0.08);
        }
        textarea { min-height: 100px; resize: vertical; }

        .char-count { font-size: 0.85rem; color: var(--gold-dark); margin-top: 0.5rem; }
        .char-count.warning { color: var(--crimson); }

        .search-results { margin-top: 2rem; }
        .result-category {
            margin-bottom: 2rem;
            border: 1px solid var(--gold-dark);
            border-radius: 4px;
            overflow: hidden;
            animation: fadeSlideIn 0.5s ease;
        }
        .result-category h3 {
            background: linear-gradient(90deg, var(--bg-medium) 0%, rgba(26,22,18,0.8) 100%);
            color: var(--gold);
            padding: 1rem 1.2rem;
            font-size: 1rem;
            font-weight: 500;
            border-bottom: 1px solid var(--gold-dark);
        }
        .result-item {
            padding: 1rem 1.2rem;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid rgba(212,175,55,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        .result-item:hover {
            background: rgba(212,175,55,0.1);
            padding-left: 1.5rem;
        }
        .result-preview {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--parchment-dark);
            margin-top: 0.5rem;
            opacity: 0.8;
        }
        .result-coord {
            font-family: 'Courier New', monospace;
            font-size: 0.55rem;
            color: var(--gold-dark);
            margin-top: 0.4rem;
            word-break: break-all;
            max-height: 40px;
            overflow: hidden;
        }
        .result-title {
            color: var(--gold-light);
            font-style: italic;
            font-size: 0.9rem;
        }
        .load-more {
            padding: 1rem;
            text-align: center;
            background: rgba(212,175,55,0.05);
            cursor: pointer;
            color: var(--gold-dark);
            transition: all 0.3s;
            border-top: 1px solid rgba(212,175,55,0.1);
        }
        .load-more:hover {
            background: rgba(212,175,55,0.15);
            color: var(--gold);
        }

        .highlight {
            background: linear-gradient(to bottom, rgba(212,175,55,0.4), rgba(212,175,55,0.6));
            padding: 1px 3px;
            border-radius: 2px;
            color: var(--ink);
            font-weight: 600;
        }

        .readable-high { color: var(--emerald); font-weight: 600; text-decoration: underline; }
        .readable-medium { color: var(--sapphire); font-weight: 500; }
        .readable-low { color: var(--crimson); opacity: 0.7; }

        .toggle-container { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1rem; }
        .toggle {
            position: relative;
            width: 50px; height: 26px;
            background: var(--bg-medium);
            border: 1px solid var(--gold-dark);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle.active { background: var(--gold-dark); border-color: var(--gold); }
        .toggle::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 20px; height: 20px;
            background: var(--parchment);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .toggle.active::after { transform: translateX(24px); background: var(--gold); }
       /* --- 图例容器：垂直排列两行 --- */
.readable-legend {
    display: none; /* 默认隐藏 */
    flex-direction: column; /* 关键：让两行内容垂直堆叠 */
    gap: 0.6rem; /* 两行之间的距离 */
    
    margin-top: 1rem;
    padding: 0.8rem 1.2rem;
    
    /* 容器外观 */
    background: rgba(10, 9, 8, 0.4);
    border: 1px solid rgba(212, 175, 55, 0.15);
    border-radius: 6px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
}

.readable-legend.show {
    display: flex; /* 激活时显示为flex */
}

/* --- 每一行的样式 --- */
.legend-row {
    display: flex;
    justify-content: center; /* 居中对齐，看起来更平衡 */
    align-items: center;
    gap: 1.5rem; /* 同一行内每个项目之间的距离 */
    flex-wrap: wrap; /* 防止极端小屏幕下溢出 */
    font-size: 0.85rem;
    color: var(--parchment-dark);
}

/* --- 图例中的特殊样式微调 --- */
.legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

/* 只是为了图例显示好看的一点点微调 */
.legend-sentence-box {
    background: rgba(189, 82, 255, 0.15); 
    border-bottom: 2px solid #bd52ff; 
    color: #e0ccff; 
    padding: 0 6px; 
    border-radius: 3px;
    font-size: 0.8rem;
    position: relative;
}
.legend-sentence-box::after {
    content: '✨';
    position: absolute;
    top: -6px; right: -4px;
    font-size: 0.7em;
}

        .legend-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
        .legend-dot.high { background: var(--emerald); }
        .legend-dot.medium { background: var(--sapphire); }
        .legend-dot.low { background: var(--crimson); }

        .bookmark-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1.2rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--gold-dark);
            border-radius: 4px;
            margin-bottom: 0.8rem;
            transition: all 0.3s;
        }
        .bookmark-item:hover {
            background: rgba(212,175,55,0.08);
            border-color: var(--gold);
        }
        .bookmark-info { flex: 1; cursor: pointer; overflow: hidden; }
        .bookmark-name { font-weight: 600; margin-bottom: 0.4rem; color: var(--gold); }
        .bookmark-coord { font-family: 'Courier New', monospace; font-size: 0.5rem; color: var(--parchment-dark); word-break: break-all; max-height: 35px; overflow: hidden; opacity: 0.7; }
        .delete-btn {
            background: var(--crimson);
            color: #fff;
            border: none;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            border-radius: 3px;
            flex-shrink: 0;
            margin-left: 1rem;
            transition: all 0.3s;
        }
        .delete-btn:hover { background: #a54545; transform: scale(1.05); }

        .about-content {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--gold-dark);
            border-radius: 4px;
            padding: 2.5rem;
        }
        .about-content h2 {
            color: var(--gold);
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gold-dark);
            font-weight: 500;
        }
        .about-content h2:first-child { margin-top: 0; }
        .about-content p { margin-bottom: 1rem; text-align: justify; color: var(--parchment-dark); line-height: 2; }
        .about-content blockquote {
            font-style: italic;
            border-left: 3px solid var(--gold);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: rgba(212,175,55,0.05);
            color: var(--parchment);
            border-radius: 0 4px 4px 0;
        }
        .about-content ul { margin: 1rem 0 1rem 2rem; color: var(--parchment-dark); }
        .about-content li { margin-bottom: 0.5rem; }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .stat-card {
            background: linear-gradient(145deg, rgba(212,175,55,0.1) 0%, rgba(212,175,55,0.05) 100%);
            padding: 1.2rem;
            text-align: center;
            border: 1px solid var(--gold-dark);
            border-radius: 4px;
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212,175,55,0.15);
        }
        .stat-number { font-size: 1.3rem; color: var(--gold); font-weight: 600; }
        .stat-label { font-size: 0.8rem; color: var(--parchment-dark); margin-top: 0.3rem; }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(145deg, var(--bg-medium) 0%, var(--bg-dark) 100%);
            color: var(--gold);
            padding: 1rem 2rem;
            border-radius: 50px;
            z-index: 2000;
            border: 1px solid var(--gold-dark);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: toastIn 0.5s forwards, toastOut 0.5s 2s forwards;
        }
        @keyframes toastIn { to { transform: translateX(-50%) translateY(0); } }
        @keyframes toastOut { to { transform: translateX(-50%) translateY(100px); opacity: 0; } }

        .progress-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10,9,8,0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(5px);
        }
        .progress-box {
            background: linear-gradient(145deg, var(--bg-medium) 0%, var(--bg-dark) 100%);
            padding: 2.5rem 3rem;
            border-radius: 8px;
            text-align: center;
            max-width: 350px;
            border: 1px solid var(--gold-dark);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .progress-title { font-size: 1.2rem; color: var(--gold); margin-bottom: 1.5rem; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
            border: 1px solid var(--gold-dark);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-dark), var(--gold), var(--gold-light));
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            transition: width 0.3s ease;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .progress-detail { font-size: 0.85rem; color: var(--parchment-dark); margin-top: 0.5rem; }
        .progress-icon { font-size: 2.5rem; margin-bottom: 1rem; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .info-card {
            background: rgba(212,175,55,0.05);
            border: 1px solid var(--gold-dark);
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--parchment-dark);
        }
        .info-card strong { color: var(--gold); }

        @media (max-width: 600px) {
            main { padding: 1rem; }
            .book-container { padding: 1.2rem; }
            .page-content { font-size: 0.45rem; padding: 0.8rem; min-height: 250px; }
            nav button { padding: 0.5rem 0.8rem; font-size: 0.8rem; }
            header { padding: 2rem 1rem; }
            h1 { letter-spacing: 0.2em; }
        }
        
        /* --- 新增样式：真词与句子 --- */

/* 真正的英语单词 - 金色高亮 */
.readable-real { 
    color: #ffd700; 
    text-shadow: 0 0 5px rgba(212,175,55,0.4);
    font-weight: 700;
}

/* 疑似有意义的句子 - 背景微光 */
/* --- 样式更新 --- */

/* 1. 疑似句子：使用鲜艳的霓虹紫荧光笔风格 */
.sentence-highlight {
    /* 鲜艳的半透明紫色背景 */
    background: rgba(189, 82, 255, 0.15); 
    /* 底部有一条实线荧光条，像划重点一样 */
    border-bottom: 2px solid #bd52ff;
    /* 微微的发光效果 */
    box-shadow: 0 0 10px rgba(189, 82, 255, 0.15);
    border-radius: 3px;
    margin: 0 3px;
    padding: 1px 0; /* 稍微撑开一点高度 */
    position: relative;
    /* 让它即便叠在别的颜色上也能看清 */
    z-index: 1; 
}

/* 句子右上角的魔法闪光 */
.sentence-highlight::after {
    content: '✨';
    font-size: 0.7rem;
    position: absolute;
    top: -0.6rem;
    right: -0.3rem;
    opacity: 0.9;
    filter: drop-shadow(0 0 2px #bd52ff);
    animation: twinkle 3s infinite ease-in-out;
}

/* --- 技术分析面板重构 --- */
.analysis-panel {
    display: flex;
    justify-content: space-between;
    align-items: flex-start; /* 顶部对齐 */
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid var(--gold-dark);
    border-bottom: none; /* 进度条在下面，去掉底边框 */
    border-radius: 4px 4px 0 0;
    padding: 1rem;
    margin-top: 1rem;
    font-family: 'Noto Serif SC', serif;
}

.analysis-item {
    flex: 1; /* 左右均分 */
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.analysis-item.left { align-items: flex-start; } /* 左侧左对齐 */
.analysis-item.right { align-items: flex-end; } /* 右侧右对齐 */

.analysis-divider {
    width: 1px;
    height: 40px; /* 定高 */
    background: linear-gradient(to bottom, transparent, var(--gold-dark), transparent);
    opacity: 0.5;
    margin: 0 1rem;
    align-self: center;
}

.analysis-label {
    font-size: 0.75rem;
    color: var(--gold-dark);
    font-weight: 600;
    letter-spacing: 1px;
}

.analysis-data {
    display: flex;
    align-items: baseline;
    gap: 0.3rem;
    line-height: 1;
}

.analysis-value {
    font-size: 1.3rem; /*稍微加大一点*/
    /* 原来是 var(--gold) #d4af37，现在改成更亮的高饱和度金黄色 */
    color: #ffc107; 
    font-family: 'Courier New', monospace;
    font-weight: 700;
    /* 关键：加上发光效果，让数字“浮”起来 */
    text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
    letter-spacing: 1px;
}

.analysis-unit {
    font-size: 0.75rem;
    color: var(--parchment-dark);
}

.analysis-subtext {
    font-size: 0.75rem;
    color: var(--parchment-dark);
    opacity: 0.8;
}

/* 进度条样式调整 */
.entropy-bar-container {
    width: 100%; /* 铺满 */
    height: 4px;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--gold-dark);
    border-top: none;
    border-radius: 0 0 4px 4px;
    overflow: hidden;
    margin-top: 0; /* 紧贴面板 */
    margin-bottom: 1.5rem;
}

.entropy-fill {
    height: 100%;
    width: 0%;
    background: var(--gold);
    transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

/* --- 移动端适配修正 --- */
@media (max-width: 600px) {
    /* 1. 强制页码导航不换行 */
    .page-navigation-bar {
        flex-wrap: nowrap; /* 关键 */
        gap: 0.5rem;
        padding: 0.4rem;
    }

    /* 2. 缩小按钮 */
    .nav-btn {
        padding: 0.4rem 0.6rem; /* 减小内边距 */
        font-size: 0.8rem;
        white-space: nowrap; /* 防止按钮内文字换行 */
        flex-shrink: 0; /* 防止按钮被挤扁 */
    }

    /* 3. 优化中间的输入框区域 */
    .page-input-wrapper {
        font-size: 0.75rem; /* 字体改小 */
        display: flex;
        align-items: center;
        gap: 2px;
        white-space: nowrap;
        overflow: hidden; /* 防止极端情况溢出 */
    }

    /* 输入框本体也改小 */
    #pageInput {
        width: 35px;
        font-size: 0.85rem;
    }
    
    /* 4. 如果屏幕实在太窄 (如 iPhone SE)，把按钮文字简化 */
    /* 这是一个高级技巧：利用 CSS 内容替换 */
    .nav-btn span { display: none; } /* 隐藏原来的文字如果用了span */
    /* 由于我们直接写在button里，这里不动 HTML，直接依赖上面的缩小 padding 应该够了 */
    
    /* 5. 空间漫游控制台 - 移动端适配 */
    .spatial-controls {
        flex-wrap: wrap;      /* 允许换行 */
        gap: 0.5rem;          /* 缩小间距 */
        width: 100%;          /* 占满宽度 */
        justify-content: flex-start;
    }
    
    .spatial-group {
        gap: 0.2rem;          /* 缩小按钮间距 */
    }
    
    .spatial-btn {
        width: 28px;          /* 稍微大一点方便点击 */
        height: 28px;
        font-size: 0.7rem;
    }
    
    .spatial-label {
        font-size: 0.65rem;
        min-width: auto;
    }
    
    .spatial-divider {
        display: none;        /* 移动端隐藏分隔线，节省空间 */
    }
    
}

/* 调整原来的样式，拉开层次 */
.readable-high { color: #4ade80; font-weight: 600; } /* 亮绿色 */
.readable-medium { color: #60a5fa; } /* 亮蓝色 */
.readable-low { color: #f87171; opacity: 0.8; } /* 柔和红 */

/* --- 游戏化系统样式 --- */

/* --- XP 显示设置 --- */
.xp-settings {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
    font-size: 0.8rem;
}

.xp-setting-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--parchment-dark);
}

.xp-setting-item input[type="checkbox"] {
    width: 14px;
    height: 14px;
    accent-color: var(--gold);
    cursor: pointer;
}

.xp-setting-item label {
    cursor: pointer;
    user-select: none;
}

/* 玩家状态栏 (固定在导航栏下方) */
.player-status-bar {
    background: linear-gradient(90deg, var(--bg-medium) 0%, rgba(20,18,15,0.95) 50%, var(--bg-medium) 100%);
    border-bottom: 1px solid var(--gold-dark);
    padding: 0.5rem 1rem;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
    font-size: 0.9rem;
    position: sticky;
    top: 60px; /* 根据nav高度调整 */
    z-index: 90;
    backdrop-filter: blur(5px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.level-badge {
    background: var(--gold);
    color: var(--bg-dark);
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 4px;
    border: 1px solid #fff;
    box-shadow: 0 0 10px rgba(212,175,55,0.4);
}

.xp-container {
    flex: 1;
    max-width: 300px;
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.xp-track {
    flex: 1;
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    border: 1px solid var(--gold-dark);
    overflow: hidden;
    position: relative;
}

.xp-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--emerald) 0%, #6ee7b7 100%);
    width: 0%;
    transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
}

.xp-text {
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    color: var(--gold-light);
    min-width: 80px;
    text-align: right;
}

/* 成就网格 */
.achievement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    padding: 1rem 0;
}

.ach-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--gold-dark);
    border-radius: 6px;
    padding: 1.2rem;
    display: flex;
    gap: 1rem;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
}

.ach-card.locked {
    opacity: 0.6;
    filter: grayscale(1);
    border-style: dashed;
}

.ach-card.unlocked {
    background: linear-gradient(145deg, rgba(212,175,55,0.1) 0%, rgba(0,0,0,0) 100%);
    border-color: var(--gold);
    box-shadow: 0 4px 15px rgba(212,175,55,0.1);
    animation: glowPulse 3s infinite;
}

.ach-icon {
    font-size: 2rem;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    background: rgba(0,0,0,0.3);
    border-radius: 50%;
    border: 1px solid var(--gold-dark);
}

.ach-info h4 {
    color: var(--gold);
    margin-bottom: 0.3rem;
    font-size: 1rem;
}

.ach-desc {
    font-size: 0.8rem;
    color: var(--parchment-dark);
    line-height: 1.4;
}

.ach-reward {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: var(--emerald);
    font-weight: 600;
}

/* 浮动 XP 动画 - 更醒目版 */
.float-xp {
    position: fixed;
    color: #4ade80;
    font-weight: bold;
    font-size: 1.5rem;
    pointer-events: none;
    z-index: 9999;
    animation: floatUp 2s forwards;
    text-shadow: 
        0 0 10px rgba(74, 222, 128, 0.8),
        0 0 20px rgba(74, 222, 128, 0.5),
        0 2px 4px rgba(0,0,0,0.8);
    font-family: 'Courier New', monospace;
}

@keyframes floatUp {
    0% { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
    20% {
        opacity: 1;
        transform: translateY(-10px) scale(1.3);
    }
    100% { 
        opacity: 0; 
        transform: translateY(-60px) scale(1); 
    }
}

/* 升级弹窗 */
.levelup-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 5000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
    backdrop-filter: blur(5px);
}
.levelup-overlay.active { opacity: 1; pointer-events: auto; }

.levelup-box {
    text-align: center;
    transform: scale(0.8);
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.levelup-overlay.active .levelup-box { transform: scale(1); }

.levelup-title {
    font-size: 3rem;
    color: var(--gold);
    font-family: 'ZCOOL XiaoWei', serif;
    margin-bottom: 1rem;
    text-shadow: 0 0 30px var(--gold);
    animation: glow 2s infinite;
}
.levelup-badge {
    font-size: 6rem;
    margin: 1rem 0;
    filter: drop-shadow(0 0 20px rgba(212,175,55,0.6));
}
.levelup-desc { color: var(--parchment); font-size: 1.2rem; margin-bottom: 2rem; }

@media (max-width: 600px) {
    .player-status-bar { flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem; top: 55px; }
    .xp-container { width: 100%; max-width: none; }
    .achievement-grid { grid-template-columns: 1fr; }
}

/* --- XP 获取详情面板 --- */
.xp-gain-panel {
    position: fixed;
    bottom: 80px;
    right: 20px;
    background: linear-gradient(145deg, rgba(20,18,14,0.95), rgba(10,9,8,0.98));
    border: 1px solid var(--gold);
    border-radius: 8px;
    padding: 1rem 1.2rem;
    min-width: 220px;
    max-width: 280px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 20px rgba(212,175,55,0.2);
    z-index: 1500;
    transform: translateX(120%);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.xp-gain-panel.show {
    transform: translateX(0);
    opacity: 1;
}

.xp-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--gold-dark);
}

.xp-panel-title {
    color: var(--gold);
    font-weight: 600;
    font-size: 0.95rem;
}

.xp-panel-total {
    color: #4ade80;
    font-weight: 700;
    font-size: 1.3rem;
    text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
}

.xp-factor-list {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
}

.xp-factor {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
    padding: 0.3rem 0;
}

.xp-factor-name {
    color: var(--parchment-dark);
}

.xp-factor-value {
    font-family: 'Courier New', monospace;
    font-weight: 600;
}

.xp-factor-value.positive { color: #4ade80; }
.xp-factor-value.negative { color: #f87171; }
.xp-factor-value.neutral { color: var(--gold); }
.xp-factor-value.multiplier { color: #60a5fa; }

.xp-panel-footer {
    margin-top: 0.8rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--gold-dark);
    font-size: 0.75rem;
    color: var(--parchment-dark);
    text-align: center;
    opacity: 0.7;
}

.xp-visited-notice {
    background: rgba(248,113,113,0.1);
    border: 1px dashed #f87171;
    border-radius: 4px;
    padding: 0.8rem;
    text-align: center;
    color: #f87171;
    font-size: 0.85rem;
}

/* 移动端适配 */
@media (max-width: 600px) {
    .xp-gain-panel {
        bottom: 70px;
        right: 10px;
        left: 10px;
        max-width: none;
        min-width: auto;
    }
}

/* --- 墙面导航模态框 --- */
.wall-modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(10, 9, 8, 0.95);
    backdrop-filter: blur(8px);
    z-index: 4000;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.wall-modal.active {
    opacity: 1;
    pointer-events: auto;
}

.wall-modal-content {
    width: 90%;
    max-width: 500px;
    text-align: center;
    position: relative;
    transform: scale(0.9);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.wall-modal.active .wall-modal-content {
    transform: scale(1);
}

.wall-modal-title {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 2rem;
    color: var(--gold);
    text-shadow: 0 0 20px rgba(212,175,55,0.4);
    margin-bottom: 0.5rem;
}
.wall-modal-subtitle {
    color: var(--parchment-dark);
    font-size: 0.9rem;
    margin-bottom: 3rem;
    opacity: 0.7;
}

/* --- 六边形罗盘核心布局 --- */
.hex-compass-container {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* --- 通道按钮样式 --- */
.hex-passage-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 50px;
    height: 100px;
    background: linear-gradient(90deg, rgba(45,106,79,0.3), rgba(45,106,79,0.1));
    border: 1px dashed var(--emerald);
    color: var(--emerald);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 5px;
    font-size: 0.75rem;
    border-radius: 4px;
    opacity: 0.7;
}
.hex-passage-btn:hover {
    background: linear-gradient(90deg, rgba(45,106,79,0.5), rgba(45,106,79,0.3));
    opacity: 1;
    box-shadow: 0 0 20px rgba(45,106,79,0.4);
}
.hex-passage-btn.left {
    left: -70px;
}
.hex-passage-btn.right {
    right: -70px;
}
.passage-icon {
    font-size: 1.2rem;
}
.passage-label {
    font-size: 0.65rem;
    text-align: center;
    line-height: 1.2;
}

/* 装饰性通道文字 */
.hex-passage {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.7rem;
    color: var(--parchment-dark);
    opacity: 0.3;
    letter-spacing: 2px;
    width: 100px;
}
.hex-passage.left { left: -60px; text-align: right; }
.hex-passage.right { right: -60px; text-align: left; }

.hex-grid {
    position: relative;
    width: 260px;
    height: 260px;
    /* 旋转30度让六边形尖角朝上/下，或者保持平边 */
}

/* 墙面按钮通用样式 */
.hex-wall-btn {
    position: absolute;
    width: 50%;
    height: 50%;
    background: rgba(212,175,55,0.05);
    border: 1px solid var(--gold-dark);
    color: var(--gold);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 5px;
    z-index: 10;
}
.hex-wall-btn:hover {
    background: rgba(212,175,55,0.2);
    box-shadow: 0 0 30px rgba(212,175,55,0.2) inset;
    z-index: 20;
}
.hex-wall-btn.active {
    background: var(--gold);
    color: var(--bg-dark);
    border-color: #fff;
    box-shadow: 0 0 40px rgba(212,175,55,0.6);
    z-index: 30;
    transform: scale(1.05);
}

/* 
   布局逻辑：模拟博尔赫斯的六边形
   假设六边形左右是通道，剩下四个面是墙。
   我们用 CSS grid 或 absolute positioning 拼一个视觉上的六边形。
*/

/* 左上 (墙1) */
.hex-wall-btn.wall-1 {
    top: 0; left: 25%;
    width: 50%; height: 50%;
    clip-path: polygon(50% 50%, 0 0, 100% 0);
    /* 修正位置微调 */
    transform-origin: 50% 100%;
}
/* 右上 (墙2) - 实际上我们稍微改一下布局，让它更像罗盘 */

/* --- 重新设计：十字交叉布局 (更适合操作) --- 
   或者使用更有趣的扇形布局。
   这里使用：围绕中心的四个梯形
*/

.hex-wall-btn {
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, rgba(30,25,20,0.9), rgba(10,9,8,0.9));
    border: 1px solid var(--gold-dark);
    clip-path: none; /* 重置 */
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

/* 墙 1: 上方 */
.hex-wall-btn.wall-1 {
    top: 0; left: 50%;
    transform: translateX(-50%);
    clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);
    height: 80px; width: 140px;
}
/* 墙 2: 右侧 */
.hex-wall-btn.wall-2 {
    top: 50%; right: 0;
    transform: translateY(-50%);
    clip-path: polygon(0% 0%, 100% 20%, 100% 80%, 0% 100%);
    width: 80px; height: 140px;
}
/* 墙 3: 下方 */
.hex-wall-btn.wall-3 {
    bottom: 0; left: 50%;
    transform: translateX(-50%);
    clip-path: polygon(0% 0%, 100% 0%, 80% 100%, 20% 100%);
    height: 80px; width: 140px;
}
/* 墙 4: 左侧 */
.hex-wall-btn.wall-4 {
    top: 50%; left: 0;
    transform: translateY(-50%);
    clip-path: polygon(0% 20%, 100% 0%, 100% 100%, 0% 80%);
    width: 80px; height: 140px;
}

/* 选中状态的微调 */
.hex-wall-btn.wall-1.active { transform: translateX(-50%) translateY(-5px); }
.hex-wall-btn.wall-2.active { transform: translateY(-50%) translateX(5px); }
.hex-wall-btn.wall-3.active { transform: translateX(-50%) translateY(5px); }
.hex-wall-btn.wall-4.active { transform: translateY(-50%) translateX(-5px); }

/* 中心装饰 */
.hex-center {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 70px; height: 70px;
    background: radial-gradient(circle, var(--gold-dark) 0%, transparent 70%);
    border: 1px solid var(--gold);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: pulseSlow 4s infinite;
    pointer-events: none;
    z-index: 0;
}
@keyframes pulseSlow {
    0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); }
}

.wall-label { font-size: 0.9rem; font-weight: bold; margin-bottom: 2px; }
.wall-icon { font-size: 1.2rem; }

/* 移动端适配 */
@media (max-width: 600px) {
    .hex-compass-container { transform: scale(0.8); }
    .wall-modal-title { font-size: 1.5rem; }
    .hex-passage { display: none; }
}


/* === 编码选择弹窗 === */
.encoding-modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(10, 9, 8, 0.95);
    backdrop-filter: blur(8px);
    z-index: 5000;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    padding: 1rem;
}
.encoding-modal.active {
    opacity: 1;
    pointer-events: auto;
}

.encoding-modal-content {
    background: linear-gradient(145deg, #1a1612 0%, #0d0c0a 100%);
    border: 1px solid var(--gold-dark);
    border-radius: 12px;
    max-width: 560px;
    width: 100%;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 40px rgba(212,175,55,0.1);
    transform: scale(0.95);
    transition: transform 0.3s ease;
}
.encoding-modal.active .encoding-modal-content {
    transform: scale(1);
}

.encoding-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid var(--gold-dark);
    background: rgba(212,175,55,0.05);
    flex-shrink: 0;
}
.encoding-modal-header h3 {
    color: var(--gold);
    font-size: 1.2rem;
    margin: 0;
}
.encoding-modal-close {
    background: none;
    border: none;
    color: var(--parchment-dark);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.2rem 0.5rem;
    transition: color 0.2s;
}
.encoding-modal-close:hover {
    color: var(--gold);
}

.encoding-modal-body {
    padding: 1rem 1.5rem;
    overflow-y: auto;
}

.encoding-intro {
    color: var(--parchment-dark);
    font-size: 0.9rem;
    margin-bottom: 1rem;
    line-height: 1.6;
}

/* 编码选项卡 - 基础样式 */
.encoding-option {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}
.encoding-option:hover {
    background: rgba(212,175,55,0.08);
    border-color: rgba(212,175,55,0.4);
    transform: translateX(4px);
}

/* 推荐标记：只是加个小标签，不改边框 */
.encoding-option.recommended {
    background: rgba(212,175,55,0.05);
}

/* 当前选中状态：加黄边 */
.encoding-option.selected {
    border-color: var(--gold) !important;
    background: rgba(212,175,55,0.12);
    box-shadow: 0 0 15px rgba(212,175,55,0.15);
}

.encoding-option-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    gap: 0.5rem;
}
.encoding-name {
    color: var(--gold-light);
    font-weight: 600;
    font-size: 1rem;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.4rem;
}
.encoding-length {
    color: var(--parchment-dark);
    font-size: 0.8rem;
    font-family: 'Courier New', monospace;
    white-space: nowrap;
    flex-shrink: 0;
}

.recommend-badge {
    background: var(--gold);
    color: var(--bg-dark);
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-weight: 700;
    white-space: nowrap;
}

/* 描述文字优化 */
.encoding-desc {
    color: var(--parchment);
    font-size: 0.85rem;
    line-height: 1.6;
    margin-bottom: 0.6rem;
}
.encoding-desc code {
    background: rgba(212,175,55,0.2);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    white-space: nowrap;
}
.encoding-desc strong {
    color: var(--gold-light);
}

/* 警告/注意文字单独一行 */
.encoding-note {
    display: block;
    margin-top: 0.4rem;
    padding: 0.4rem 0.6rem;
    background: rgba(251, 191, 36, 0.1);
    border-left: 2px solid #fbbf24;
    border-radius: 0 4px 4px 0;
    font-size: 0.8rem;
    color: #fbbf24;
    line-height: 1.5;
}

.encoding-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.5rem;
}
.tag {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
    white-space: nowrap;
}
.tag-compat {
    background: rgba(45, 106, 79, 0.3);
    color: #4ade80;
}
.tag-warn {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}
.tag-danger {
    background: rgba(248, 113, 113, 0.2);
    color: #f87171;
}
.tag-length {
    background: rgba(96, 165, 250, 0.2);
    color: #60a5fa;
}

/* 移动端响应式优化 */
@media (max-width: 600px) {
    .encoding-modal {
        padding: 0.5rem;
        align-items: flex-end;
    }
    .encoding-modal-content {
        max-height: 90vh;
        border-radius: 12px 12px 0 0;
    }
    .encoding-modal-body {
        padding: 0.8rem 1rem;
    }
    .encoding-option {
        padding: 0.8rem;
    }
    .encoding-option-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.3rem;
    }
    .encoding-length {
        font-size: 0.75rem;
    }
    .encoding-desc {
        font-size: 0.8rem;
    }
    .encoding-note {
        font-size: 0.75rem;
    }
    .tag {
        font-size: 0.65rem;
    }
}

    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <header>
        <h1>巴别图书馆</h1>
        <p class="subtitle">"宇宙（别人称之为图书馆）由无数六角形回廊组成..."</p>
    </header>

    <nav>
        <button class="active" data-section="browse">📖 浏览</button>
        <button data-section="search">🔍 搜索</button>
        <button data-section="random">🎲 随机</button>
        <button data-section="goto">📍 前往</button>
        <button data-section="bookmarks">⭐ 书签</button>
        <button data-section="achievements">🏆 成就</button>
        <button data-section="about">ℹ️ 关于</button>
    </nav>

    <div class="player-status-bar">
    <div style="display:flex;align-items:center;gap:0.5rem">
        <span>探索等级</span>
        <span class="level-badge" id="playerLevel">1</span>
    </div>
    <div class="xp-container">
        <div class="xp-track">
            <div class="xp-fill" id="xpFill"></div>
        </div>
        <div class="xp-text"><span id="currentXp">0</span> / <span id="maxXp">100</span> XP</div>
    </div>
</div>

    <main>
        <section id="browse" class="section active">
            <div class="toggle-container">
                <span style="color: var(--parchment-dark)">可读化模式</span>
                <div class="toggle" id="readableToggle"></div>
            </div>
            <div class="readable-legend" id="readableLegend">
    <!-- 第一行：特殊挖掘 (真词 & 句子) -->
    <div class="legend-row">
        <div class="legend-item">
            <span style="color: #ffd700; font-weight: 700; text-shadow: 0 0 5px rgba(212,175,55,0.4);">★ 英语真词</span>
        </div>
        
        <div class="legend-item">
            <span class="legend-sentence-box">疑似句子</span>
        </div>
    </div>

    <!-- 视觉分隔线（可选，如果觉得太挤可以保留，不需要也可以删掉，现在的gap够大了） -->
    <div style="height:1px; background:linear-gradient(90deg, transparent, rgba(212,175,55,0.15), transparent); width:100%;"></div>

    <!-- 第二行：拼写概率 (高/中/低) -->
    <div class="legend-row">
        <div class="legend-item">
            <span class="legend-dot high"></span>高概率
        </div>
        <div class="legend-item">
            <span class="legend-dot medium"></span>中概率
        </div>
        <div class="legend-item">
            <span class="legend-dot low"></span>低概率
        </div>
    </div>
</div>

            <div class="book-container">
                <div id="pageContent" class="page-content">
✦ 欢迎来到真正的巴别图书馆 ✦

这是一个完全基于数学构建的无限宇宙：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- 每一页 = 一个 4677 位的 29 进制巨数
- 坐标 = 书名 + 内容 的唯一数学编码
- 在这里，"创造"即是"发现"，因为一切早已存在

【当前系统架构】
1. 空间结构：六边形回廊 → 4面墙 → 5层书架 → 32卷书 → 410页
2. 编码技术：支持 Base16k/36/85/65k/1.1M 多种压缩方案
3. 书名系统：支持独立书名（1/4/20/640个）或掩码派生模式
4. 坐标格式：编码.书名模式:内容-w墙-s架-v卷-p页

在此，你可以找到：
- 昨天丢失的购物清单
- 莎士比亚从未写出的第 38 部剧作
- 甚至是你此时此刻正在阅读这句话的描述

点击「随机」开始流浪，或使用「搜索」定位特定真理。</div>

                <!-- 替换原来的 .page-info 整个 div -->
<div class="page-info-container">
    
    <!-- 上半部分：封面 + 信息 + 空间漫游 -->
    <div class="layout-row">
        <!-- 左侧：封面 -->
        <div id="bookCover" class="book-cover"></div>

        <!-- 右侧：详情与控制 -->
        <div class="book-details">
            <!-- 书名 -->
            <div class="meta-row">
                <span class="meta-label">书名：</span>
                <span id="bookTitle" class="book-title-text">—</span>
            </div>
            
            <!-- 位置 -->
            <div class="meta-row">
                <span class="meta-label">位置：</span>
                <span id="locationInfo">—</span>
            </div>

            <!-- 新增：交互维度 - 空间漫游控制台 -->
            <div class="spatial-controls">
            <div class="spatial-group">
        <span class="spatial-label">墙</span>
        <button class="spatial-btn" id="navWallBtn" title="打开六边形导航 (W)">⬡ <span id="currentWallNum" style="font-size:0.6rem;margin-left:2px">1</span></button>
    </div>
    
    <div class="spatial-divider"></div>
                <div class="spatial-group">
                    <span class="spatial-label">架</span>
                    <button class="spatial-btn" id="navShelfUp" title="上一层书架 (↑)">▲</button>
                    <button class="spatial-btn" id="navShelfDown" title="下一层书架 (↓)">▼</button>
                </div>
                <div class="spatial-divider"></div>
                <div class="spatial-group">
                    <span class="spatial-label">卷</span>
                    <button class="spatial-btn" id="navVolLeft" title="左边的书 (←)">◀</button>
                    <button class="spatial-btn" id="navVolRight" title="右边的书 (→)">▶</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 下半部分：页码导航 (横向铺满) -->
    <div class="page-navigation-bar">
        <button id="prevBtn" class="nav-btn" disabled>‹ 上一页</button>
        <div class="page-input-wrapper">
            <span>第</span>
            <input type="number" id="pageInput" min="1" max="410" value="1" disabled>
            <span>页 / 410</span>
        </div>
        <button id="nextBtn" class="nav-btn" disabled>下一页 ›</button>
    </div>

</div>

<!-- 技术分析面板 -->
<div class="analysis-panel">
    <!-- 左侧：坐标数据 -->
    <div class="analysis-item left">
        <span class="analysis-label">坐标深度</span>
        <div class="analysis-data">
            <span class="analysis-value" id="hexLength">0</span>
            <span class="analysis-unit">字符</span>
        </div>
        <div class="analysis-subtext" id="coordTypeLabel">Base-16k 编码</div>
    </div>
    
    <!-- 中间分割线 -->
    <div class="analysis-divider"></div>

    <!-- 右侧：综合评分 -->
    <div class="analysis-item right">
        <span class="analysis-label">信息熵值</span>
        <div class="analysis-data">
            <span class="analysis-value" id="entropyValue">0.00</span>
            <span class="analysis-unit">Bits</span>
        </div>
        <!-- 这里显示结合了词库分析后的综合评价 -->
        <div class="analysis-subtext" id="entropyDesc">计算中...</div>
    </div>
</div>
<!-- 进度条单独放下面，作为整体的装饰 -->
<div class="entropy-bar-container">
    <div id="entropyBar" class="entropy-fill"></div>
</div>

                <div style="margin-top:1.2rem">
                    <button class="btn btn-secondary" id="addBookmarkBtn">⭐ 添加书签</button>
                    <button class="btn btn-secondary" id="copyCoordBtn">📋 复制坐标</button>
                </div>

<div style="margin-top:1.5rem; border-top: 1px solid rgba(212,175,55,0.2); padding-top:1rem;">
    <!-- 编码选择行 -->
    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem">
        <label style="color:var(--ink-light);font-size:0.85rem;margin:0;width:3rem;flex-shrink:0">编码</label>
        <button id="encodingSelectorBtn" style="
            background: rgba(255,255,255,0.1); 
            border: 1px solid var(--gold-dark); 
            color: var(--ink); 
            padding: 0.4rem 0.8rem; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: space-between;
            min-width: 0;
        ">
            <span id="currentEncodingName" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Base16k</span>
            <span style="opacity:0.6;flex-shrink:0">▼</span>
        </button>
    </div>
    <!-- 书名模式选择行 -->
    <div style="display:flex; align-items:center; gap:0.5rem;">
        <label style="color:var(--ink-light);font-size:0.85rem;margin:0;width:3rem;flex-shrink:0">书名</label>
        <button id="titleModeSelectorBtn" style="
            background: rgba(255,255,255,0.1); 
            border: 1px solid var(--gold-dark); 
            color: var(--ink); 
            padding: 0.4rem 0.8rem; 
            border-radius: 4px; 
            font-family: 'Noto Serif SC', serif;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: space-between;
            min-width: 0;
        ">
            <span style="display:flex;align-items:center;gap:0.3rem;overflow:hidden">
                <span>📚</span>
                <span id="currentTitleModeName" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">墙×架</span>
            </span>
            <span style="opacity:0.6;flex-shrink:0">▼</span>
        </button>
    </div>

                    </div>
                    <label style="color:var(--ink-light);font-size:0.9rem">完整坐标：</label>
                    <div class="coordinate" id="fullCoordinate">—</div>
                </div>
            </div>
        </section>

        <section id="search" class="section">
            <div class="form-group">
                <label>🔍 搜索文本（a-z、空格、逗号、句号）</label>
                <textarea id="searchInput" placeholder="输入要搜索的文本..."></textarea>
                <div class="char-count" id="searchCharCount">0 / 3200 字符</div>
            </div>
            <div class="info-card" style="margin-bottom:1.5rem">
                ⏱️ 搜索涉及大整数运算，每次约需 <strong>5-15秒</strong><br>
                📖 首页搜索：输入的文本将出现在第一页开头
            </div>
            <button class="btn" id="searchBtn">开始搜索</button>
            <div id="searchResults" class="search-results"></div>
        </section>

        <section id="random" class="section">
            <div style="text-align:center;padding:2rem 0">
                <div style="font-size:4rem;margin-bottom:1rem">🎲</div>
                <p style="font-size:1.1rem;color:var(--parchment-dark);margin-bottom:1.5rem">
                    踏入无限的书架<br>发现一页等待被阅读的文字
                </p>
                <div class="info-card" style="max-width:400px;margin:0 auto 1.5rem">
                    ⏱️ 生成随机页面需要约 <strong>3-8秒</strong>
                </div>
                <button class="btn" id="randomBtn" style="font-size:1.1rem;padding:0.8rem 2rem">
                    ✨ 访问随机页面
                </button>
            </div>
        </section>

        <section id="goto" class="section">
            <div class="form-group">
                <label>📍 输入完整坐标</label>
                <textarea id="coordinateInput" style="min-height:120px;font-size:0.7rem" placeholder="粘贴完整坐标..."></textarea>
            </div>
            <div class="info-card" style="margin-bottom:1.5rem">
                格式：<code style="color:var(--gold)">hex-w[1-4]-s[1-5]-v[1-32]-p[1-410]</code>
            </div>
            <button class="btn" id="gotoBtn">前往该页面</button>
        </section>

        <section id="bookmarks" class="section">
            <h2 style="color:var(--gold);margin-bottom:1.5rem;display:flex;align-items:center;gap:0.5rem">
                ⭐ 我的书签
            </h2>
            <div id="bookmarkList"></div>
        </section>

<section id="achievements" class="section">
    <div style="text-align:center;margin-bottom:2rem">
        <h2 style="color:var(--gold)">🏆 探索者成就</h2>
        <p style="color:var(--parchment-dark);font-size:0.9rem">记录你在无尽回廊中的每一个足迹</p>
    </div>

<div class="xp-settings">
    <span style="color:var(--gold);font-weight:600">经验提示：</span>
    <div class="xp-setting-item">
        <input type="checkbox" id="showXpFloat" checked>
        <label for="showXpFloat">浮动数字</label>
    </div>
    <div class="xp-setting-item">
        <input type="checkbox" id="showXpPanel" checked>
        <label for="showXpPanel">详情面板</label>
    </div>
</div>

<div style="text-align:right; margin-top:1rem; border-bottom: 1px solid var(--gold-dark); padding-bottom: 1rem; margin-bottom: 1rem;">
    <button onclick="resetGameData()" style="
        background: rgba(139, 58, 58, 0.2); 
        border: 1px solid var(--crimson); 
        color: var(--crimson); 
        padding: 0.5rem 1rem; 
        font-family: inherit; 
        cursor: pointer; 
        font-size: 0.8rem; 
        border-radius: 4px;
        transition: all 0.3s;">
        ⚠️ 重置所有数据
    </button>
</div>
    
    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-number" id="statTotalVisits">0</div>
            <div class="stat-label">总访问页数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statCoverTypes">0/30</div>
            <div class="stat-label">已发现封面类型</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statTotalXP">0</div>
            <div class="stat-label">累计获得经验</div>
        </div>
    </div>

    <div id="achievementList" class="achievement-grid">
        <!-- JS生成 -->
    </div>
</section>

        <section id="about" class="section">
    <div class="about-content">
        <h2>📚 巴别图书馆</h2>
        <blockquote>
            "宇宙（别人称之为图书馆）由无数六角形回廊组成，数目不定，也许是无限的..."<br>
            <span style="opacity:0.7">— 豪尔赫·路易斯·博尔赫斯，1941</span>
        </blockquote>
        
        <h2>🧮 核心数学原理</h2>
        <p>不同于普通的随机生成器，本图书馆是一个<strong>严格的双向数学映射系统</strong>：</p>
        <ul>
            <li><strong>全排列：</strong>每页 3200 字符，每字符 29 种可能。总页数为 29<sup>3200</sup> ≈ 10<sup>4677</sup>。</li>
            <li><strong>唯一性：</strong>每一个可能的字符组合都对应一个唯一的、绝对的整数坐标。</li>
            <li><strong>位置掩码：</strong>利用 <code>HMAC(墙,架,卷,页)</code> 生成确定性噪点掩码，与内容坐标进行异或(XOR)运算。同一坐标在不同位置会显示完全不同的内容，符合"位置决定内容"的混沌特性。</li>
        </ul>
        
        <h2>🔖 书名与坐标系统</h2>
        <p>当前的坐标系统采用了<strong>复合编码技术</strong>：</p>
        <ul>
            <li><strong>数据结构：</strong>完整坐标 = <code>书名数值 × 页面空间 + 内容数值</code></li>
            <li><strong>这意味着：</strong>复制坐标时，同时包含了书名和正文的位置信息。</li>
            <li><strong>书名模式：</strong>
                <ul>
                    <li><span style="color:var(--gold)">独立模式</span>：1/4/20/640 个书名直接存储在坐标中，完全随机</li>
                    <li><span style="color:var(--gold)">掩码派生</span>：存储种子书名，通过数学变换让 640 个位置显示不同书名</li>
                </ul>
            </li>
            <li><strong>坐标格式：</strong><code>编码.书名模式:内容-w墙-s架-v卷-p页</code></li>
            <li><strong>多模态编码：</strong>
                <ul>
                    <li><span style="color:var(--gold)">Base16k（默认）</span>：约 16000 个常用汉字，压缩率 ~63%</li>
                    <li><strong>Base36</strong>：数字+字母，兼容性最强</li>
                    <li><strong>Base85</strong>：ASCII 可打印字符，压缩率 ~58%</li>
                    <li><strong>Base65k / Base1.1M</strong>：极端压缩，兼容性较差</li>
                </ul>
            </li>
        </ul>
        
        <h2>🌌 探索者指南</h2>
        <p>在这个包含了所有可能性的集合中，<strong>意义是极其稀缺的资源</strong>。</p>
        <ul>
            <li><strong>精确搜索：</strong>逆向计算出包含你搜索词的页面坐标</li>
            <li><strong>书名搜索：</strong>定位包含特定书名的书籍</li>
            <li><strong>可读化模式：</strong>在乱码海洋中高亮出偶然形成的英语单词和疑似句子</li>
            <li><strong>成就系统：</strong>记录探索足迹，发现稀有封面和低熵页面</li>
        </ul>
        
        <div style="width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark),transparent);margin:2rem 0;opacity:0.5"></div>
        
        <h2>📊 宇宙常数</h2>
        <div class="stat-grid">
            <div class="stat-card"><div class="stat-number">29</div><div class="stat-label">字符集大小</div></div>
            <div class="stat-card"><div class="stat-number">3,200</div><div class="stat-label">单页容量</div></div>
            <div class="stat-card"><div class="stat-number">10<sup>4677</sup></div><div class="stat-label">总排列数</div></div>
            <div class="stat-card"><div class="stat-number">∞</div><div class="stat-label">回廊数量</div></div>
        </div>
    </div>
</section>
    </main>

    <div id="progressOverlay" class="progress-overlay" style="display:none">
        <div class="progress-box">
            <div class="progress-icon">📚</div>
            <div class="progress-title" id="progressText">正在计算...</div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width:0%"></div>
            </div>
            <div class="progress-detail" id="progressDetail"></div>
        </div>
    </div>

<div id="levelUpModal" class="levelup-overlay">
    <div class="levelup-box">
        <div class="levelup-badge">🆙</div>
        <div class="levelup-title">等级提升!</div>
        <div class="levelup-desc">你现在是 <span id="newLevelNum" style="color:var(--gold);font-weight:bold">2</span> 级探索者</div>
        <button class="btn" onclick="closeLevelUp()">继续旅程</button>
    </div>
</div>

<!-- 墙面导航模态框 -->
<div id="wallNavModal" class="wall-modal">
    <div class="wall-modal-content">
        <h3 class="wall-modal-title">六边形回廊导航</h3>
        <p class="wall-modal-subtitle">选择要前往的墙面</p>
        
        <div class="hex-compass-container">
    <!-- 可交互的通道按钮 -->
    <button class="hex-passage-btn left" id="passageLeft" title="穿过左侧通道">
        <div class="passage-icon">🚪</div>
        <div class="passage-label">← 前往<br>相邻六边形</div>
    </button>
    <button class="hex-passage-btn right" id="passageRight" title="穿过右侧通道">
        <div class="passage-icon">🚪</div>
        <div class="passage-label">前往 →<br>相邻六边形</div>
    </button>

    <!-- 核心六边形交互区 -->
    <div class="hex-grid">
                <!-- 墙面按钮：使用 clip-path 切割成梯形/三角形拼成六边形 -->
                <button class="hex-wall-btn wall-1" data-wall="1">
                    <div class="wall-label">墙 1</div>
                    <div class="wall-icon">📚</div>
                </button>
                <button class="hex-wall-btn wall-2" data-wall="2">
                    <div class="wall-label">墙 2</div>
                    <div class="wall-icon">📚</div>
                </button>
                <button class="hex-wall-btn wall-3" data-wall="3">
                    <div class="wall-label">墙 3</div>
                    <div class="wall-icon">📚</div>
                </button>
                <button class="hex-wall-btn wall-4" data-wall="4">
                    <div class="wall-label">墙 4</div>
                    <div class="wall-icon">📚</div>
                </button>
                
                <!-- 中心装饰 -->
                <div class="hex-center">
                    <div class="hex-center-icon">👁️</div>
                </div>
            </div>
        </div>
        
        <button class="btn btn-secondary" style="margin-top:2rem" onclick="closeWallNav()">关闭罗盘</button>
    </div>
</div>

<!-- XP 获取详情面板 -->
<div id="xpGainPanel" class="xp-gain-panel">
    <div class="xp-panel-header">
        <span class="xp-panel-title">✨ 经验获取</span>
        <span class="xp-panel-total" id="xpTotalGain">+0</span>
    </div>
    <div id="xpFactorList" class="xp-factor-list">
        <!-- 动态填充 -->
    </div>
    <div class="xp-panel-footer" id="xpPanelFooter">
        点击任意处关闭
    </div>
</div>

<!-- 编码选择弹窗 -->
<div id="encodingModal" class="encoding-modal">
    <div class="encoding-modal-content">
        <div class="encoding-modal-header">
            <h3>📊 选择坐标编码</h3>
            <button class="encoding-modal-close" onclick="closeEncodingModal()">✕</button>
        </div>
        <div class="encoding-modal-body">
            <p class="encoding-intro">不同编码会影响坐标长度和分享兼容性，请根据使用场景选择：</p>
            
            <div class="encoding-option" data-encoding="b36">
                <div class="encoding-option-header">
                    <span class="encoding-name">Base36</span>
                    <span class="encoding-length">压缩率：100.00%</span>
                </div>
                <div class="encoding-desc">仅使用数字 0-9 和字母 a-z，<strong>兼容性最佳</strong>，可在任何平台安全分享。</div>
                <div class="encoding-tags">
                    <span class="tag tag-compat">✓ 全平台兼容</span>
                    <span class="tag tag-length">✗ 最长</span>
                </div>
            </div>
            
            <div class="encoding-option" data-encoding="b85">
                <div class="encoding-option-header">
                    <span class="encoding-name">Base85</span>
                    <span class="encoding-length">压缩率：80.86%</span>
                </div>
                <div class="encoding-desc">使用 ASCII 可打印字符，长度较短。</div>
                <span class="encoding-note">⚠ 部分论坛或聊天软件可能将符号（如 <code>.</code> <code>!</code> <code>?</code>）误识别为链接，导致坐标被截断或破坏。</span>
                <div class="encoding-tags">
                    <span class="tag tag-warn">⚠ 部分平台有风险</span>
                    <span class="tag tag-length">○ 较长</span>
                </div>
            </div>
            
            <div class="encoding-option recommended" data-encoding="b16k">
                <div class="encoding-option-header">
                    <span class="encoding-name">Base16k <span class="recommend-badge">推荐</span></span>
                    <span class="encoding-length">压缩率：36.96%</span>
                </div>
                <div class="encoding-desc">使用常用汉字（CJK 基本区前 16384 字），<strong>兼容性与长度的最佳平衡</strong>，适合大多数中文平台。</div>
                <div class="encoding-tags">
                    <span class="tag tag-compat">✓ 中文平台友好</span>
                    <span class="tag tag-length">✓ 较短</span>
                </div>
            </div>
            
            <div class="encoding-option" data-encoding="b20k">
                <div class="encoding-option-header">
                    <span class="encoding-name">Base20k</span>
                    <span class="encoding-length">压缩率：36.30%</span>
                </div>
                <div class="encoding-desc">使用完整的 CJK 基本区汉字（20902 字），比 Base16k 略短。</div>
                <span class="encoding-note">⚠ 可能包含部分生僻字，某些设备显示为方块。</span>
                <div class="encoding-tags">
                    <span class="tag tag-compat">✓ 中文平台友好</span>
                    <span class="tag tag-length">✓ 较短</span>
                </div>
            </div>
            
            <div class="encoding-option" data-encoding="b27k">
                <div class="encoding-option-header">
                    <span class="encoding-name">Base27k</span>
                    <span class="encoding-length">压缩率：35.31%</span>
                </div>
                <div class="encoding-desc">使用 CJK 基本区 + 扩展 A 区（27494 字），包含古汉字。</div>
                <span class="encoding-note">⚠ 包含大量生僻字和古字，多数字体无法完整显示。</span>
                <div class="encoding-tags">
                    <span class="tag tag-warn">⚠ 可能显示异常</span>
                    <span class="tag tag-length">✓ 短</span>
                </div>
            </div>
            
            <div class="encoding-option" data-encoding="b65k">
                <div class="encoding-option-header">
                    <span class="encoding-name">Base65k</span>
                    <span class="encoding-length">压缩率：32.34%</span>
                </div>
                <div class="encoding-desc">使用 BMP 平面大部分字符（65536 个），<strong>显著缩短坐标</strong>。</div>
                <span class="encoding-note">⚠ 包含汉字、日文假名、韩文、各种符号，外观较混杂。</span>
                <div class="encoding-tags">
                    <span class="tag tag-warn">⚠ 混合字符集</span>
                    <span class="tag tag-length">✓ 很短</span>
                </div>
            </div>
            
            <div class="encoding-option" data-encoding="b11m">
                <div class="encoding-option-header">
                    <span class="encoding-name">Base1.1M</span>
                    <span class="encoding-length">压缩率：25.74%</span>
                </div>
                <div class="encoding-desc">使用全部 Unicode 字符（约 110 万个），<strong>坐标最短</strong>。</div>
                <span class="encoding-note">⚠ 实验性功能！包含 emoji、古文字、特殊符号等，很可能在分享时被过滤或乱码。</span>
                <div class="encoding-tags">
                    <span class="tag tag-danger">✗ 兼容性差</span>
                    <span class="tag tag-length">✓ 最短</span>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 书名模式选择弹窗 -->
<div id="titleModeModal" class="encoding-modal">
    <div class="encoding-modal-content">
        <div class="encoding-modal-header">
            <h3>📚 书名模式设置</h3>
            <button class="encoding-modal-close" onclick="closeTitleModeModal()">✕</button>
        </div>
        <div class="encoding-modal-body">
            <p class="encoding-intro">选择六边形内 640 本书的书名生成方式。不同模式会影响坐标长度。</p>
            
            <div class="title-mode-section">
                <h4 style="color:var(--gold); margin: 1rem 0 0.5rem; font-size: 0.9rem;">🎲 独立随机模式</h4>
                <p style="color:var(--parchment-dark); font-size: 0.8rem; margin-bottom: 0.8rem;">每个书名都是真正独立存储的随机数据，完全可搜索。</p>
            </div>
            
            <div class="encoding-option" data-titlemode="single">
                <div class="encoding-option-header">
                    <span class="encoding-name">统一书名</span>
                    <span class="encoding-length">≈ 1100 字符</span>
                </div>
                <div class="encoding-desc">整个六边形内 <strong>640 本书共享同一个书名</strong>。坐标最短，兼容性最好。</div>
                <div class="encoding-tags">
                    <span class="tag tag-compat">✓ 坐标最短</span>
                    <span class="tag tag-length">1 个书名</span>
                </div>
            </div>
            
            <div class="encoding-option" data-titlemode="wall">
                <div class="encoding-option-header">
                    <span class="encoding-name">每墙不同</span>
                    <span class="encoding-length">≈ 1220 字符</span>
                </div>
                <div class="encoding-desc">每面墙有独立书名，<strong>同一面墙的 160 本书共享书名</strong>。</div>
                <div class="encoding-tags">
                    <span class="tag tag-compat">✓ 较短</span>
                    <span class="tag tag-length">4 个书名</span>
                </div>
            </div>
            
            <div class="encoding-option" data-titlemode="wall-shelf">
                <div class="encoding-option-header">
                    <span class="encoding-name">每墙每架不同 <span class="recommend-badge">推荐</span></span>
                    <span class="encoding-length">≈ 1290 字符</span>
                </div>
                <div class="encoding-desc">每面墙的每一架有独立书名，<strong>同一架的 32 本书共享书名</strong>。</div>
                <div class="encoding-tags">
                    <span class="tag tag-compat">✓ 适中</span>
                    <span class="tag tag-length">20 个书名</span>
                </div>
            </div>
            
            <div class="encoding-option" data-titlemode="full">
                <div class="encoding-option-header">
                    <span class="encoding-name">每本不同</span>
                    <span class="encoding-length">≈ 6900 字符</span>
                </div>
                <div class="encoding-desc"><strong>每本书都有完全独立的书名</strong>，真正的 640 个随机书名。</div>
                <span class="encoding-note">⚠ 坐标长度增加约 5 倍，分享和存储较为不便。</span>
                <div class="encoding-tags">
                    <span class="tag tag-warn">⚠ 坐标很长</span>
                    <span class="tag tag-length">640 个书名</span>
                </div>
            </div>
            
            <div class="title-mode-section" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gold-dark);">
                <h4 style="color:var(--gold); margin: 0 0 0.5rem; font-size: 0.9rem;">🔮 数学派生模式</h4>
                <p style="color:var(--parchment-dark); font-size: 0.8rem; margin-bottom: 0.8rem;">存储一个种子书名，其他书名通过数学变换派生。坐标短但书名搜索需要指定位置。</p>
            </div>
            
            <div class="encoding-option" data-titlemode="mask-keep">
    <div class="encoding-option-header">
        <span class="encoding-name">掩码派生 A（保长度）</span>
        <span class="encoding-length">≈ 1100 字符</span>
    </div>
    <div class="encoding-desc">存储一个<strong>种子书名</strong>，640 个位置通过仿射变换显示不同书名。</div>
    <span class="encoding-note">
        💡 书名内容剧烈变化，但<strong>长度保持不变</strong>。<br>
        💡 数学上是完美双射，概率分布与种子书名一致。
    </span>
    <div class="encoding-tags">
        <span class="tag tag-compat">✓ 数学严谨</span>
        <span class="tag tag-length">640 个派生书名</span>
    </div>
</div>

<div class="encoding-option" data-titlemode="mask-vary">
    <div class="encoding-option-header">
        <span class="encoding-name">掩码派生 B（变长度）</span>
        <span class="encoding-length">≈ 1100 字符</span>
    </div>
    <div class="encoding-desc">存储一个<strong>种子书名</strong>，640 个位置的书名<strong>内容和长度都剧烈变化</strong>。</div>
    <span class="encoding-note">
        💡 视觉上更丰富，不同位置书名长度差异明显。<br>
        💡 可逆但非均匀分布，某些书名可能略常见。
    </span>
    <div class="encoding-tags">
        <span class="tag tag-warn">△ 略有偏差</span>
        <span class="tag tag-length">640 个派生书名</span>
    </div>
</div>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid rgba(212,175,55,0.2);">
                <h4 style="color:var(--gold); margin: 0 0 0.5rem; font-size: 0.85rem;">⚠️ 兼容性说明</h4>
                <ul style="color:var(--parchment-dark); font-size: 0.8rem; line-height: 1.6; margin: 0; padding-left: 1.2rem;">
                    <li>不同模式生成的坐标<strong>互不兼容</strong></li>
                    <li>切换模式后，旧坐标可能显示不正确的书名</li>
                    <li>分享坐标时，请确保接收方使用相同的书名模式</li>
                    <li>书签中会记录生成时的模式</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * 巴别图书馆 (The Library of Babel) - 核心实现
 * 
 * 【项目概述】
 * 本项目是一个基于博尔赫斯小说《巴别图书馆》概念的数学模拟器。
 * 它构建了一个包含所有可能的29进制字符组合（26个字母+空格+逗号+句号）的无限宇宙。
 * 每一个页面（3200字符）都对应一个唯一的、绝对的大整数坐标。
 * 
 * 【核心架构】
 * 1. 坐标系统：
 *    - 采用 "六边形回廊(Hex) - 墙(Wall) - 书架(Shelf) - 卷(Volume) - 页(Page)" 的五维坐标系。
 *    - 核心映射：Hex <=> BigInt (使用多种编码如 Base16k/Base36 进行压缩展示)。
 * 
 * 2. 数学原理：
 *    - 双向映射：
 *      - 正向 (Loc -> Content): 使用坐标作为种子，通过伪随机数生成器 (PRNG) 生成确定的页面内容。
 *      - 逆向 (Content -> Loc): 将文本视为29进制数字，直接计算其在宇宙中的绝对坐标（搜索功能）。
 *    - 混沌掩码：为了模拟"位置决定内容"的特性，引入了基于位置 (W,S,V,P) 的 HMAC 掩码，
 *      使得同一本书在不同位置显示完全不同的内容。
 * 
 * 3. 关键特性：
 *    - 多模态编码：支持 Base16k (汉字), Base36, Base85 等多种坐标压缩算法。
 *    - 游戏化系统：内置 XP 经验系统、成就系统、探索等级，增加探索乐趣。
 *    - 语义分析：计算页面信息熵 (Entropy) 和 语义评分 (Semantic Score)，识别"有意义"的页面。
 *    - 视觉生成：基于坐标哈希程序化生成独一无二的书籍封面。
 * 
 * 【代码结构】
 * - 常量定义：字符集、宇宙常数、编码配置
 * - 核心数学库：BigInt 运算、进制转换、掩码算法
 * - 游戏逻辑：存档管理、XP计算、成就触发
 * - UI 交互：DOM 操作、事件监听、Canvas/SVG 渲染
 * 
 * @version 4.0
 */
// ============================================================
// 真正的巴别图书馆 - 可变书名版
// ============================================================

// ============================================================
// 词典数据与语义分析
// ============================================================

/**
 * 英语常用词数据集 (Top 1000+)
 * 用于语义评分和真词检测
 * 压缩存储为 CSV 字符串以减少文件体积
 */
const COMMON_WORDS_STR = "the,and,to,of,a,in,was,that,he,not,his,her,it,you,had,with,for,she,as,on,is,at,be,him,have,said,from,but,me,my,were,they,all,by,this,would,do,out,up,one,so,an,could,or,been,them,did,we,are,what,there,about,which,their,into,like,if,who,when,no,can,will,your,back,time,more,know,then,man,down,over,now,some,just,see,only,than,other,way,has,before,two,little,get,very,any,go,made,too,here,never,eyes,think,thought,again,through,even,much,good,off,us,first,our,how,where,after,looked,come,its,came,right,away,long,old,going,still,day,got,say,hand,went,head,should,face,own,make,well,asked,life,must,himself,people,want,around,might,something,room,take,knew,took,such,told,men,door,left,being,last,because,look,night,those,these,house,tell,saw,another,while,most,turned,put,felt,woman,great,place,upon,mr.,years,without,found,always,am,nothing,though,against,same,father,home,many,work,let,seemed,things,few,mother,thing,ever,may,love,every,voice,three,hands,once,mind,enough,under,heard,young,moment,new,find,also,between,side,does,each,world,wanted,anything,both,until,really,called,give,herself,better,looking,sure,began,yes,behind,next,course,yet,far,seen,stood,name,small,gave,done,almost,need,why,oh,god,light,end,morning,sat,heart,days,white,water,girl,part,help,half,words,feel,since,set,open,across,body,together,gone,keep,along,mrs.,kind,bed,front,black,quite,hair,hard,myself,shall,already,mean,used,soon,family,feet,wife,toward,having,whole,hear,women,else,call,table,dark,best,money,held,talk,believe,boy,says,leave,brought,big,children,friend,later,walked,least,air,everything,taken,word,coming,full,matter,tried,high,child,doing,year,dead,death,past,fact,car,arms,started,alone,rather,son,close,story,four,others,trying,kept,read,second,five,times,case,point,making,mouth,given,john,ask,use,miss,rest,known,de,understand,smile,fire,inside,happened,large,less,lost,opened,sound,someone,friends,arm,stopped,able,moved,reached,smiled,window,round,care,near,turn,lot,business,idea,book,floor,perhaps,remember,red,getting,feeling,real,town,bad,true,either,whom,among,different,passed,suddenly,country,pulled,often,lay,deep,above,person,hope,thinking,question,sense,short,become,became,live,taking,husband,ground,brother,cold,replied,reason,hour,school,ran,several,fell,whose,saying,certain,probably,evening,ago,answer,show,run,speak,within,themselves,met,minutes,ready,however,returned,poor,living,spoke,longer,office,during,blue,bit,outside,order,followed,late,shook,talking,forward,waiting,sent,line,chair,power,answered,stop,stay,nodded,quickly,road,blood,hundred,hours,wrong,lips,continued,sort,lord,try,daughter,city,fine,watched,dear,standing,caught,beautiful,top,slowly,sir,clear,possible,early,wall,ten,eye,bring,laughed,sitting,happy,hold,twenty,whether,cut,itself,pretty,nor,closed,anyone,sun,present,sleep,change,human,cried,return,war,truth,lady,street,breath,maybe,six,finally,fear,move,appeared,needed,letter,number,wish,free,week,yourself,towards,glass,horse,play,decided,meet,sister,beside,seem,died,land,strong,walk,stand,means,fingers,silence,york,added,english,rose,london,police,afraid,low,meant,sea,job,attention,married,sight,chance,shoulder,paper,lived,till,sorry,strange,american,seems,loved,wait,kitchen,indeed,green,sometimes,form,important,law,in.,watch,doubt,knows,king,state,phone,beyond,months,start,filled,working,running,wind,stared,trouble,mary,die,self,except,earth,led,hot,age,girls,corner,dinner,heavy,trees,comes,raised,jack,foot,couple,straight,afternoon,boys,food,baby,suppose,shot,pain,party,quiet,leaving,nature,legs,watching,neck,carried,everyone,sit,interest,figure,deal,company,killed,easy,thousand,minute,onto,nearly,worked,clothes,pay,mine,simply,makes,fall,holding,tears,george,certainly,books,arrived,picked,today,hell,tree,further,looks,position,waited,guess,thoughts,view,although,sky,following,dr.,river,nice,seeing,soul,drink,shoulders,beginning,wondered,touch,wide,doctor,exactly,middle,seat,tom,public,ship,warm,entered,instead,remembered,changed,realized,church,whatever,news,gold,please,immediately,finished,glad,building,hurt,soft,expression,dropped,actually,spent,stepped,telling,no.,skin,dog,moving,kill,general,noticed,parents,single,drew,manner,silent,coffee,giving,step,subject,piece,eat,conversation,liked,whispered,written,covered,wonder,french,beneath,empty,hit,fast,none,force,glanced,remained,lives,weeks,hardly,desk,distance,stone,james,chest,broken,steps,dress,showed,especially,expected,pleasure,edge,group,future,bright,placed,below,turning,fellow,meeting,visit,broke,grew,learned,control,hall,picture,problem,talked,england,history,ahead,happen,supposed,questions,tone,leaned,david,walking,surprised,write,cause,pushed,music,received,information,secret,marriage,henry,mr,fight,captain,sign,laugh,box,third,act,neither,lifted,wrote,break,hung,thirty,born,laid,summer,boat,reading,surprise,thus,experience,writing,game,pass,note,goes,miles,throat,send,wild,usual,nose,shut,direction,pointed,horses,walls,tall,paul,knowing,quick,sweet,guy,common,character,space,re,gun,ought,follow,seven,spirit,stories,forget,strength,safe,master,drive,situation,tired,ones,simple,village,lying,dream,brown,presence,desire,peter,wants,sudden,agreed,offered,eight,threw,necessary,darkness,scene,knowledge,difficult,account,william,service,struck,lie,touched,allowed,crowd,fair,paid,pocket,art,thick,sam,serious,bear,perfect,special,class,shirt,teeth,save,memory,worse,dressed,alive,quietly,field,gaze,garden,st.,places,carefully,thin,cry,aware,ah,completely,pale,plan,personal,rain,yeah,hat,considered,reach,believed,drove,tea,rich,somewhere,natural,stairs,forth,easily,anyway,particular,wore,speaking,angry,area,private,explained,charles,ways,letters,bag,worth,playing,fresh,understood,tonight,paused,beauty,train,learn,wearing,therefore,closer,windows,court,effect,sick,social,expect,ears,tomorrow,huge,wine,worry,catch,joe,ill,trust,smiling,slightly,older,forced,chapter,staring,length,clean,usually,purpose,wished,impossible,begin,terrible,path,peace,likely,notice,finger,action,knees,carry,played,imagine,thank,earlier,coat,gray,wood,language,shouted,ear,month,officer,asking,system,entire,lines,merely,kiss,snow,offer,bar,yellow,main,robert,novel,managed,takes,study,listen,marry,spot,doors,station,kissed,smoke,faces,built,handed,michael,stuff,dry,glance,thou,duty,apartment,ring,feelings,buy,century,escape,richard,silver,pressed,lead,pleased,bottom,slow,settled,promise,tongue,ll,ye,wonderful,explain,forgotten,gentleman,hers,gently,softly,leaves,society,crossed,sharp,bedroom,sighed,helped,spread,laughing,thomas,hotel,names,tiny,clearly,america,rolled,anger,aside,lights,familiar,battle,discovered,ordered,evidence,lose,smell,rock,ride,listened,flat,sounded,busy,harry,headed,paris,hoped,government,kids,houses,grass,fifty,interested,heat,pair,bent,drawn,pick,heads,repeated,calling,various,cross,stayed,spring,bank,effort,army,cover,suggested,complete,winter,keeping,slipped,sounds,frank,check,cool,hospital,evil,somehow,appear,bought,loud,prepared,shop,charge,putting,growing,example,chief,cup,gets,exclaimed,works,respect,fit,danger,asleep,opening,fallen,entirely,suit,share,flowers,bottle,appearance,store,choice,beat,enemy,wet,camp,guard,narrow,moments,grown,papers,sex,promised,final,breakfast,needs,listening,streets,board,local,named,unless,pull,passing,movement,dance,opinion,level,shrugged,political,joy,em,meaning,noise,north,calm,ancient,attack,british,nine,ladies,message,murder,perfectly,yours,youth,stage,fish,cast,gate,support,soldiers,attempt,instant,period,weight,mentioned,concerned,remain,sake,carrying,ice,jim,university,elizabeth,indian,hill,fool,ben,grabbed,la,okay,opposite,lower,report,disappeared,nobody,difference,sunday,directly,tight,states,uncle,mrs,drawing,author,german,hate,sad,moon,members,shoes,allow,object,mad,events,cheek,falling,particularly,journey,former,somewhat,bound,somebody,plain,search,jane,animal,reply,stomach,interesting,christmas,involved,lovely,flesh,determined,joined,forty,drop,key,leg,using,lunch,spoken,apart,trip,officers,opportunity,relief,proud,m.,spend,twice,west,thy,knife,dollars,rising,thee,barely,color,aunt,burst,ended,sarah,mountain,laughter,pieces,refused,surface,caused,rooms,kid,circumstances,result,join,image,greater,gathered,dangerous,south,hanging,sides,cheeks,shadow,ball,united,ve,younger,bill,powerful,iron,hide,jumped,kate,terms,song,worried,dozen,accept,island,fixed,everybody,mark,forest,due,thinks,speech,fun,finding,weather,taste,mention,faith,jesus,proper,dust,forehead,blow,occasion,served,rise,center,hidden,lit,wedding,demanded,brain,relationship,wear,pleasant,condition,orders,france,hearing,careful,observed,wondering,crazy,willing,page,locked,leading,success,date,stranger,driver,bare,sword,shaking,matters,twelve,gives,including,race,anybody,failed,grave,parts,published,roof,removed,size,hole,possibly,loose,admit,shape,christ,throw,passion,sleeping,christian,judge,style,surely,creature,apparently,handsome,deeply,besides,rode,begun,pride,fighting,consider,gentle,damn,voices,command,luck,burning,truly,happiness,original,grow,approached,loss,fifteen,wooden,according,stuck,yesterday,faced,entrance,queen,property,stupid,dreams,curious,decision,intended,cat,slept,brief,stick,mirror,post,double,bird,broad,crying,type,forever,dad,chin,arthur,accepted,physical,heaven,crime,recognized,dying,colonel,female,bodies,calls,military,fully,unable,square,stretched,comfort,list,anne,missed,reality,climbed,golden,bread,problems,ourselves,mere,animals,plans,martin,yard,distant,obvious,brothers,guys,vision,modern,mistake,spite,realize,machine,ideas,fat,reminded,handle,prince,firm,murmured,priest,driving,process,hey,latter,frightened,higher,bridge,storm,woods,i.,prove,truck,enjoy,odd,continue,ii,existence,comfortable,thrown,male,wrapped,madame,obviously,otherwise,slid,pictures,influence,taught,notes,hurried,flight,circle,stars,mountains,eating,buried,occurred,worst,edward,formed,excitement,health,energy,understanding,passage,weak,dogs,grinned,j.,leather,shock,charlie,honest,similar,speed,admitted,contact,pink,faint,deck,jacket,address,a.,tied,adam,famous,practice,anxious,tale,fortune,don,fly,seconds,gay,pulling,draw,glasses,beer,cabin,dare,team,tells,welcome,rough,won,cousin,enter,birds,shadows,missing,hated,hoping,nervous,major,gotten,anna,farm,drinking,anywhere,insisted,response,doorway,value,showing,jake,reasons,turns,features,saved,muttered,naked,cases,worn,breathing,fault,becoming,plenty,material,described,details,funny,concern,bringing,studied,rang,waved,shore,agree,meal,beach,drunk,thanks,press,college,slight,ate,interrupted,nick,burned,sand,security,series,courage,lies,swung,flying,confidence,avoid,price,community,setting,gift,fought,individual,cigarette,stream,boots,ordinary,billy,normal,metal,writer,greatest,telephone,rushed,declared,magic,june,washington,servant,risk,mike,shown,absolutely,birth,member,imagined,lover,cost,card,poured,president,smith,soldier,snapped,advice,plate,singing,wound,pure,task,breast,afterwards,prison,checked,enjoyed,lack,accident,generally,pity,fate,eyed,required,seated,scarcely,grey,imagination,approach,persons,alice,fields,sold,freedom,rate,awful,wise,points,et,san,hesitated,serve,provided,fashion,lucy,clouds,honor,characters,east,hills,screen,sell,degree,innocent,everywhere,religious,mood,announced,produced,upstairs,guests,fancy,alex,advantage,staff,joseph,carriage,companion,wanting,anymore,hungry,despite,career,mom,affair,authority,starting,sigh,flew,excited,riding,cars,dirty,previous,convinced,smooth,max,margaret,spirits,yards,crew,claim,impression,travel,friendly,swept,rights,finish,blind,leaning,nights,nurse,amount,wave,servants,letting,proved,track,justice,trail,satisfied,counter,count,gentlemen,patient,trade,horror,upper,europe,record,moral,sought,throughout,sexual,waist,receive,devil,meat,painted,engaged,happens,regard,breaking,win,helen,scared,driven,appears,supper,lake,protect,forgot,chosen,vast,cleared,grace,noble,bathroom,radio,pp.,pages,created,dancing,cloth,lawyer,fiction,lucky,wake,assured,warning,porch,grandfather,hero,quarter,saturday,base,conscious,presented,match,shame,million,bob,figures,audience,market,knocked,rocks,instance,hurry,band,guilty,shared,remains,signs,sons,marked,students,event,surrounded,shake,stones,blame,valley,issue,milk,simon,suffering,gonna,bet,ease,april,popular,pause,invited,motion,rule,plane,maria,steady,terror,grand,laura,cell,bow,silk,difficulty,role,newspaper,returning,lowered,larger,mass,happening,fill,farther,false,closely,rush,decide,choose,literature,rear,gesture,term,awake,daily,excuse,planned,bell,literary,shit,foreign,club,drank,oil,reader,direct,attitude,gazed,arranged,dining,becomes,suffered,wheel,safety,library,feels,folded,dawn,delight,trial,regular,satisfaction,frowned,hang,excellent,forms,firmly,add,bones,grandmother,scott,grin,arrival,daniel,harm,unknown,indians,mile,title,waves,struggle,frame,pool,bitter,sees,march,trembling,dan,per,whenever,sisters,ass,rachel,louis,habit,upset,remarked,lee,sooner,duke,pounds,russian,education,bloody,families,philip,stands,heavily,treated,source,shoot,religion,seriously,grief,importance,lip,silently,honour,altogether,cloud,wounded,chairs,badly,pack,informed,july,emily,mama,eager,statement,strike,teacher,numbers,seek,row,favorite,affairs,capable,pressure,susan,lap,possibility,chamber,twisted,guns,tail,clock,range,park,sweat,thrust,ceiling,rage,progress,rope,pointing,confused,breasts,explanation,raise,forces,castle,emotion,tony,memories,maggie,gods,quality,facts,star,shows,season,ships,dull,instantly,connection,spanish,build,dragged,figured,steel,chinese,cap,science,fired,highly,extra,eventually,mystery,jean,content,sing,available,computer,knee,regarded,grateful,block,easier,mostly,startled,assumed,visible,estate,lamp,cook,screamed,delicate,tossed,pray,warmth,witness,lonely,current,occupied,theory,wings,friendship,noted,whisper,bore,leader,curiosity,training,palm,extremely,forgive,buildings,stephen,bus,introduced,killing,maid,equal,august,possessed,prayer,ends,yelled,chose,staying,absence,bowed,teach,poet,solid,stare,possession,roman,emma,silly,folks,waste,hiding,brilliant,agent,faded,rapidly,recently,lift,desperate,lightly,reaching,push,rested,slip,engine,lock,brave,joke,argument,equally,loving,losing,damned,medical,responded,washed,shining,naturally,suspected,section,mental,escaped,tender,weapon,dirt,successful,intelligence,tie,mess,suspect,provide,asks,restaurant,confusion,guest,rome,poetry,sheet,blew,changes,roll,enormous,wagon,rubbed,responsible,film,based,collection,recent,sentence,copy,palace,hearts,test,text,precious,recognize,greek,consciousness,h.,fairly,annie,stock,minds,s.,seized,irish,unusual,afford,u.s.,separate,established,prevent,mistress,italian,luke,darling,colored,totally,inner,matt,partner,laws,california,feared,dick,experienced,rare,legal,ann,belonged,affection,mighty,culture,cards,couch,official,mission,reported,powers,permission,sank,fruit,considerable,swallowed,rules,desert,proof,native,television,woke,giant,manage,expressed,sympathy,weapons,foolish,violence,chain,warned,victim,owner,nation,rolling,ugly,c.,cared,belief,mysterious,tightly,student,sharply,facing,en,released,discussion,total,novels,smaller,efforts,johnny,walter,relieved,sending,childhood,belt,professional,searching,height,bother,w.,pot,sofa,deeper,intention,furniture,learning,jimmy,touching,smart,cruel,spare,hopes,flung,pushing,description,mud,destroyed,detail,discover,tales,extended,torn,credit,shade,worthy,brow,aloud,request,hunting,visited,conduct,le,fence,wealth,rid,despair,andrew,pen,thousands,troops,tv,roger,breeze,lad,crowded,boston,reaction,waters,parties,suggest,reflected,artist,pile,bench,grip,revealed,background,traffic,vain,wiped,sink,eleven,downstairs,professor,aid,constant,bearing,e.,alarm,ocean,pace,painful,ability,conditions,tables,useful,midnight,fond,expecting,contained,measure,belly,pipe,connected,mail,branches,nearby,b.,funeral,correct,groups,uniform,immediate,violent,throwing,extraordinary,non,flower,pants,suffer,morrow,emotions,volume,movie,marie,abandoned,loves,ashamed,folk,heels,recall,favor,daddy,helping,julia,creatures,actual,cattle,regret,obliged,fourth,enemies,sin,charlotte,inch,september,sang,ignored,accompanied,abruptly,approaching,prisoner,developed,frequently,sufficient,shower,plastic,paint,ruth,flashed,october,coast,armed,discuss,friday,glow,chicago,jones,rifle,greatly,shooting,vanished,judgment,kicked,balance,interview,settle,clever,horrible,colour,writers,national,gas,guards,delighted,succeeded,intense,peculiar,shifted,reputation,mixed,acting,gown,catherine,capital,committed,protection,poem,sorrow,attached,anxiety,related,jason,exhausted,tent,quarters,stiff,slave,flash,remaining,corridor,wash,temper,cottage,painting,guessed,miserable,jump,closing,directed,honey,holy,changing,briefly,r.,responsibility,shocked,finds,landed,beating,knock,earl,blanket,shouting,development,tradition,cave,india,included,paying,bowl,begins,unhappy,tear,hello,clothing,beard,research,harder,increased,atmosphere,jewish,ceased,article,jews,advanced,monsieur,version,household,likes,ellen,sally,answers,wisdom,delivered,charming,morgan,royal,sacred,saddle,americans,exist,kinds,wishes,evidently,scattered,inches,addressed,ghost,cutting,brushed,struggled,relations,incident,stronger,remarkable,department,fist,occasionally,constantly,van,bone,definitely,guilt,kindly,gradually,brush,properly,shed,remark,lots,dim,daughters,orange,dared,cream,guide,jaw,heading,express,actions,identity,nowhere,comment,operation,planning,scent,pistol,steve,eaten,extent,landing,swear,proceeded,skirt,parked,treat,belong,attend,faster,damp,project,glory,january,november,advance,dressing,climb,spiritual,midst,barn,boss,pattern,structure,monday,gathering,nearer,mounted,model,sunlight,weary,threatened,johnson,notion,virginia,addition,packed,temple,failure,gasped,sixty,refuse,flame,senses,generous,fucking,romantic,services,jenny,secure,feed,tip,backed,tower,contrary,performance,file,design,activity,resting,nancy,beg,gain,amy,supply,scream,destroy,sheep,partly,burn,interests,narrative,arrive,seeking,raising,dignity,secretary,lieutenant,exercise,claimed,conscience,fed,parking,politics,loudly,saint,pockets,beast,offering,fierce,lined,appreciate,detective,results,lily,minister,panic,utterly,behavior,chris,muscles,hint,purple,map,split,clerk,exchange,screaming,molly,collar,basket,stated,produce,december,keeps,papa,lately,recalled,bible,rank,cash,centre,treatment,fail,breathed,dreadful,suspicion,trace,ridiculous,troubled,emerged,sprang,apparent,demand,camera,presently,spell,disappointed,noon,japanese,stolen,plant,oxford,owned,conclusion,stirred,unexpected,keys,replaced,signed,historical,movements,eyebrows,threat,active,focus,highest,lean,duties,hundreds,bath,sacrifice,hugh,bride,caroline,signal,attractive,aged,shortly,bigger,tough,shone,trunk,embarrassed,purse,reference,frozen,eggs,central,songs,d.,fled,bags,texas,mercy,germany,site,barbara,elbow,superior,games,knight,charged,dried,relaxed,widow,readers,images,inquired,county,criminal,objects,examined,thoroughly,smoking,picking,wire,charm,practical,release,departure,concerning,tommy,cries,hut,hannah,puzzled,eve,magazine,bay,attempted,sheets,desired,boxes,pete,parted,edition,blank,considering,etc.,describe,display,searched,host,shaped,greeted,jeans,acted,reflection,pillow,attended,runs,impressed,hath,reports,envelope,bite,flames,ed,crack,bunch,button,retired,hips,trick,alexander,birthday,stopping,nearest,victory,wrist,assume,deserted,brings,completed,danny,hallway,wandered,shelter,tore,directions,deny,indicated,bye,avenue,peered,records,horizon,africa,wives,jackson,salt,separated,accustomed,sensation,begged,patience,remembering,create,fishing,beloved,gained,concluded,boats,tim,resolved,amused,tape,enjoying,hid,companions,tracks,weekend,kindness,breathe,precisely,uncomfortable,ceremony,jail,adventure,cotton,expensive,trained,agreement,striking,decent,iii,follows,francis,blade,recovered,flushed,slammed,genius,challenge,suggestion,martha,ireland,blond,preferred,printed,haired,medicine,vague,gather,patrick,squeezed,fury,hollow,admiration,european,acquaintance,unto,appeal,prisoners,fears,western,extreme,discovery,pressing,g.,portion,tray,souls,fever,fix,eric,danced,manager,exposed,p.,ray,grounds,invitation,sara,sugar,calmly,numerous,angel,invisible,workers,vessel,lands,gates,devoted,complex,discussed,dreamed,beings,marks,prefer,phrase,hired,nicholas,fred,divine,princess,route,corners,useless,positive,cab,custom,collected,stern,teaching,virtue,platform,disturbed,rarely,chuckled,effects,resist,descended,damage,sail,smiles,covering,ruin,protest,grasp,wicked,appointed,manners,exact,matthew,sum,splendid,beth,investigation,strangers,enthusiasm,granted,chicken,plot,evident,jacob,waving,carpet,footsteps,pregnant,relation,closet,string,seldom,mexico,jerked,affected,sorts,candle,instructions,flow,neighborhood,generation,shout,murdered,branch,necessity,critical,assistance,walks,skill,defense,fellows,quit,eighteen,crossing,occasions,represented,equipment,brian,goods,nod,spotted,practically,bitch,ralph,ex,compared,applied,humor,tension,misery,trousers,benefit,struggling,drifted,pretend,gazing,l.,backward,urged,disease,hastily,soil,studying,february,drinks,inclined,punishment,wing,desperately,dug,bars,fur,existed,faithful,claire,fuck,employed,mist,triumph,reasonable,civil,occasional,jerry,variety,cheap,prayed,limited,jealous,curled,crept,classes,population,absolute,blinked,filling,proposed,emotional,marble,cities,wilson,un,contents,program,swiftly,handkerchief,robe,massive,arrest,corn,jonathan,thumb,shift,entering,assure,curtains,unconscious,safely,lesson,remote,smelled,loaded,vehicle,stove,arrested,straw,secrets,district,subjects,plays,roads,photograph,mid,tucked,bastard,favour,holds,universe,romance,policy,glimpse,contrast,answering,endless,slightest,sensed,bullet,planet,harsh,lewis,latest,coach,sergeant,oliver,furious,union,port,mask,scenes,helpless,puts,consideration,seats,brick,disappointment,tide,cop,eagerly,catholic,countenance,survive,mate,crown,meanwhile,grant,bobby,principal,appropriate,stretch,italy,deliberately,method,slaves,utter,upward,embrace,neat,slender,ranch,genuine,dollar,cheerful,polite,taylor,cake,happily,views,elsewhere,unlike,cart,valuable,formal,lightning,burden,intimate,piano,lighted,newspapers,african,distinguished,attacked,visitors,reveal,wherever,trusted,strongly,aboard,liberty,basis,lawn,des,citizens,bishop,divided,intelligent,magnificent,dealing,destruction,chill,doctors,falls,elements,cow,studies,latin,performed,dave,china,curtain,surrounding,uttered,countries,sheriff,centuries,aspect,blessed,weakness,bold,keen,oak,unfortunate,francisco,awkward,traditional,labor,plants,principle,knelt,canada,counted,shoved,reserved,cloak,protested,prepare,lovers,drawer,catching,activities,kingdom,confess,healthy,robin,permitted,praise,al,dropping,visitor,kick,consequence,ruined,stroke,designed,drug,commanded,nerves,treasure,hatred,hunt,preparing,cracked,echoed,pardon,eddie,outer,howard,amongst,arose,load,editor,andy,remove,ours,scotland,significant,kissing,lifting,cooking,rent,shell,gifts,jeff,convince,homes,dishes,steadily,floating,killer,solemn,clearing,trap,monster,nonsense,council,assistant,stumbled,alan,sixteen,mistaken,elevator,sale,lisa,conviction,spun,rescue,fog,print,standard,blowing,stole,leaped,amusement,departed,specific,pilot,accused,kelly,holes,impulse,snake,respond,resumed,terribly,elegant,accounts,garage,victoria,access,include,anthony,drag,confident,argue,stable,que,prospect,gratitude,revenge,moonlight,raw,beaten,articles,limbs,referred,majesty,prayers,owe,appointment,delay,upright,starts,colors,depths,sunshine,visiting,farmer,confirmed,straightened,julie,percent,immense,bottles,repeat,remind,t.,emperor,grim,hunger,v.,terrified,reward,personally,banks,species,overcome,groaned,acts,obtained,roar,overhead,worship,bushes,agony,hi,region,severe,sensitive,strangely,f.,queer,wheels,carl,composed,admired,thunder,status,neighbors,roses,intent,portrait,trembled,selling,alike,illness,apple,landscape,iv,steal,reception,interior,pretended,intend,attracted,instinct,exciting,contempt,fairy,encounter,clung,speaks,bored,savage,melancholy,bosom,gordon,betty,holiday,josh,swing,bits,sadly,suspicious,abroad,st,essential,intellectual,ideal,britain,spain,diana,goodness,require,experiences,spending,remarks,shopping,slope,issues,sheer,wholly,thanked,personality,domestic,victor,ages,ladder,swift,wit,glancing,perceived,talent,pit,towel,glorious,cops,nevertheless,pine,astonishment,angrily,leads,samuel,wandering,balls,increase,questioned,brass,ok,carved,clenched,maintain,humanity,poems,target,daylight,amanda,claims,bull,philosophy,passengers,swimming,minor,sets,rushing,ryan,plates,areas,defend,wishing,jamie,mac,fashioned,accomplished,velvet,larry,blocks,ma,dumb,tour,contract,schools,uneasy,sits,client,shakespeare,gloves,focused,jury,curse,hugged,beds,astonished,fourteen,glowing,moves,cultural,concealed,gang,fires,dread,denied,observe,regarding,independent,earnest,rebecca,marched,ending,border,longing,throne,soup,scheme,glared,skull,chances,concrete,halfway,stunned,mothers,planted,consequences,russia,roots,growth,urge,eternal,captured,arrangement,bush,agents,accent,fetch,aim,financial,commander,shy,deadly,deserve,examination,retreat,seventy,wolf,patted,betrayed,distress,observation,thighs,backs,divorce,profession,polished,humble,ringing,swinging,marcus,newly,scale,lawrence,director,nervously,plus,babies,angle,jessica,blown,authorities,afterward,tragedy,louise,conference,routine,exchanged,policeman,strode,electric,gripped,principles,tightened,attempts,powder,palms,emergency,rings,albert,ya,element,sensible,reduced,cambridge,serving,sleeve,fort,tones,bothered,circles,cursed,autumn,inn,rapid,waiter,santa,adopted,stained,reckon,pounding,strain,organization,lane,wounds,climbing,senior,warrior,elder,impatient,leaders,production,bills,stuffed,argued,acquired,qualities,underneath,alert,jobs,cigar,ned,conflict,raced,cheese,theme,freely,threatening,amazing,warriors,entry,uncertain,arrangements,tapped,photographs,williams,ing,casual,grab,writes,tin,mortal,louder,determination,relatives,creation,weeping,rude,function,column,courtyard,unit,victims,attorney,demands,lessons,steep,potential,shots,goin,butter,kevin,amazed,perform,deliver,laying,supported,inevitable,disgust,suicide,karen,governor,ignore,analysis,scientific,eh,absurd,highway,tobacco,wretched,corpse,clara,peaceful,located,ross,wildly,checking,fifth,construction,taxi,relative,barrel,annoyed,pierre,tunnel,visits,joan,washing,drugs,steam,patients,code,clasped,surprising,traveling,slapped,recognition,drops,toes,lest,swore,data,offices,purposes,phil,campaign,degrees,solution,covers,roared,ted,minded,delightful,crushed,bitterly,disappear,miracle,profound,altar,rail,liquid,communication,alongside,nephew,ignorant,vaguely,motionless,net,pound,causing,rubbing,fists,capacity,adding,lace,allowing,stir,ha,resistance,log,distinct,lungs,buying,delicious,sophie,charges,avoided,canvas,examine,weird,sean,amid,du,passenger,passionate,studio,dramatic,los,neatly,towns,basic,gardens,sadness,uses,realised,associated,airport,defeat,subtle,harold,supplies,linen,cock,jo,winds,origin,meetings,shield,complicated,innocence,harriet,lion,feast,shops,wept,crash,ms.,ticket,miller,dismissed,ian,gossip,pitch,selected,presents,er,traveled,growled,fatal,huh,elderly,customers,collect,doc,flowing,southern,average,legend,millions,grinning,exception,staircase,drama,whoever,nails,egg,inspired,assigned,priests,swim,lincoln,incredible,candles,cliff,kisses,survived,score,saving,rows,dragon,fireplace,plainly,habits,absorbed,sliding,racing,residence,consent,complained,restless,unpleasant,prize,horn,majority,blessing,containing,pursuit,inhabitants,congress,linda,katie,increasing,sore,injured,leaf,awoke,northern,poverty,deer,snatched,von,depth,fanny,lobby,el,cent,nerve,witch,instrument,pouring,permit,literally,faintly,tune,holmes,identified,engagement,crawled,deserved,approval,lied,cure,doubts,advised,halt,previously,proceed,leo,plunged,pursued,nathan,cups,patch,mild,mexican,possess,dorothy,causes,gear,necessarily,difficulties,dickens,sidewalk,gallery,isabel,hook,summoned,heap,obtain,pencil,trapped,poison,lifetime,haste,hesitation,flag,motor,flood,receiving,israel,eased,favourite,embarrassment,items,verse,fantasy,th,parker,sufficiently,mill,yer,opinions,sack,individuals,crisis,narrowed,dr,longed,division,wasted,bleeding,aye,coloured,territory,statue,janet,chocolate,shoe,heavens,encouraged,handful,ignorance,relax,frequent,dusty,acquainted,location,polly,goal,industry,alley,income,tenderness,strip,occur,tries,disaster,compelled,frown,fearful,thoughtfully,rendered,significance,edges,roy,acknowledged,neighbor,bend,tribe,coal,tense,stepping,pour,solitary,contain,maintained,greeting,criticism,combination,journal,meantime,troubles,cleaning,jew,recorded,nodding,awakened,dreaming,intensity,endure,chase,knocking,theatre,unfortunately,suits,merchant,gabriel,issued,pig,pulse,gloom,ford,firing,respectable,protected,expense,slide,germans,jennifer,permanent,rick,suitable,photo,warn,swallow,biggest,jordan,co,soviet,violently,darkened,dish,champagne,bells,impatiently,driveway,arrange,drowned,economic,shelf,doubted,absent,strained,jesse,grasped,entitled,dean,additional,thursday,julian,amazement,earned,craft,lasted,desires,controlled,madness,effective,expert,fame,impact,shaken,murderer,floated,glances,boot,curiously,behalf,originally,eleanor,wealthy,venture,hug,glare,modest,belongs,whip,christopher,withdrew,confessed,player,counsel,cage,sounding,debt,temporary,dutch,lydia,douglas,slipping,witnesses,displayed,voyage,pronounced,nasty,casually,pat,passes,den,basement,florence,switched,der,alien,teachers,offers,finest,jessie,typical,stroked,factory,carter,blows,parlor,fortunate,meg,sole,terry,questioning,anxiously,hip,types,shattered,recover,mutual,norman,merry,angela,represent,pretending,veil,slowed,adult,believing,thief,fathers,daring,unique,shivered,spreading,feminine,piled,confession,clutched,bomb,sticks,baron,crystal,quarrel,humans,chapel,succeed,dragging,vivid,willie,tuesday,mankind,eighty,cautiously,persuaded,readily,idle,curve,dig,fitted,purchase,motive,se,returns,committee,wool,clay,stripped,tremendous,thread,shuddered,opposition,admire,vote,educated,carol,veins,owen,sailed,tempted,profit,duncan,values,introduction,nightmare,whilst,davis,ritual,sources,bruce,secured,flashing,placing,celebrated,maiden,tank,collapsed,bless,fan,aaron,root,bundle,borne,mason,stool,rounded,rob,destiny,jungle,tasted,graham,assembled,switch,sucked,stores,agreeable,messages,brows,dresses,brains,dealt,error,sweep,sideways,choked,conceal,shiny,hunter,bid,seed,stops,resolution,motioned,ragged,nations,allen,suggests,sandy,niece,distinction,rice,encountered,restored,musical,blast,exit,parish,brandy,manuscript,leap,comparison,thirteen,spy,combat,cats,translation,spine,blake,sunset,largely,humour,movies,dashed,sport,shallow,egypt,angeles,bark,concerns,review,sinking,flowed,limits,blankets,devotion,methods,mixture,commented,lively,furnished,sharing,receiver,introduce,nest,pavement,contemporary,organized,cleaned,muscle,feathers,swollen,haunted,assault,counting,apply,seventeen,ripped,wednesday,rhythm,theater,grain,heir,framed,jeremy,ashes,link,ere,oldest,fox,substance,butt,whispering,flies,alfred,generations,jealousy,persuade,ward,moreover,rubber,identify,walker,cabinet,ambition,publication,buttons,invite,winning,vice,anguish,mumbled,toilet,deed,torture,politely,foul,waking,opens,instructed,fastened,whistle,gleaming,juice,continuing,lawyers,beasts,operations,lesbian,possibilities,labour,pains,idiot,gloomy,conducted,slim,peasant,obey,cigarettes,authors,risen,universal,thoughtful,speaker,juan,pleaded,seeming,tend,package,sip,continues,ribs,whiskey,explosion,secretly,reporter,combined,popped,gestured,sailor,herd,prevented,russell,tools,openly,resources,graceful,revealing,pope,thigh,concept,awe,digging,exquisite,grade,dusk,feature,kings,frustration,behaviour,toast,ad,largest,nina,materials,magazines,bending,talks,clue,football,commercial,blonde,brightly,accompany,twins,comments,suited,chap,urgent,angels,burnt,mode,sweeping,whereas,respected,negative,justin,publisher,arrow,intently,systems,believes,satisfy,fbi,joint,alarmed,anti,balcony,surrender,expedition,tragic,doll,youngest,differences,certainty,inspector,spots,evenings,fitting,explaining,tilted,beam,definite,documents,copies,stirring,ranks,amusing,normally,vital,sober,forcing,aimed,agency,cole,symbol,pin,stretching,seemingly,icy,lid,praying,international,gotta,forming,elaborate,indifference,hopeless,establishment,judith,characteristic,headquarters,indifferent,mansion,moses,kitty,islands,theirs,exploded,adams,ventured,relationships,farewell,civilization,ridge,adventures,potatoes,jay,translated,initial,spinning,acknowledge,oath,companies,loyalty,arguments,guided,edith,insist,discipline,crimes,belonging,positions,rigid,meals,halted,witnessed,discussing,elbows,twin,charity,liquor,refuge,paintings,cooper,jumping,preserved,lucas,settlement,election,awhile,likewise,disposed,diamond,pole,agnes,ghosts,utmost,empire,emphasis,inc.,reverend,decisions,management,sylvia,knot,fabric,retorted,sunk,product,gravely,curls,doubtless,messenger,establish,marrying,context,media,intentions,cane,procession,katherine,whipped,creek,selfish,hay,opposed,skills,insult,fiercely,olivia,tugged,cares,sealed,testimony,cows,infinite,lantern,crouched,pie,physician,promises,handled,blouse,bargain,promptly,sins,environment,dock,luxury,forbidden,develop,bucket,fleet,nay,honestly,device,indicate,soap,knights,precise,tis,tax,purchased,revolution,temperature,heel,joshua,berlin,widened,mouths,coffin,terrace,bears,flipped,machines,loyal,prior,lamps,depend,prey,lighting,rat,hank,parent,shirts,insurance,litde,continually,villages,melted,determine,railroad,heroes,capture,officials,daisy,ancestors,cheer,passages,envy,vacation,payment,complain,unlikely,singular,mingled,creating,founded,clark,greg,demon,defence,achieved,hearted,contains,froze,roughly,pre,escort,sleeves,aroused,altered,mainly,moscow,florida,assist,limit,bolt,actor,clad,proposal,privacy,patiently,smoked,stress,cellar,skirts,nora,soaked,sipped,liz,harris,scarlet,primitive,brad,infant,cooked,travelling,depends,fantastic,curved,reluctantly,hamilton,limp,shapes,stout,morris,hats,sports,customs,barry,bitterness,staggered,sticking,ultimate,scratched,sailing,arts,masters,arriving,greet,lazy,regularly,pond,benjamin,kit,mare,sue,files,brand,toby,feeding,abandon,appetite,injury,goddess,stuart,offended,needle,gap,surroundings,charley,shouts,eastern,circumstance,quoted,realizing,nineteenth,rejected,lingered,pitched,impressive,wrinkled,hostile,supplied,anticipation,tricks,lecture,clients,suspended,pacific,tipped,lighter,alternative,warren,dies,ruins,stealing,concentrated,clutching,parting,physically,sentiment,perspective,bernard,scrambled,myth,japan,nostrils,mob,internal,railway,kim,abuse,eldest,embraced,sometime,gravel,logic,murmur,attempting,earn,patterns,tops,impatience,dripping,uh,k.,rays,sympathetic,confined,fork,franklin,isaac,employment,seal,fountain,reins,twilight,hammer,players,distracted,expressions,tearing,proudly,reluctant,tended,indignation,formerly,courtesy,entertainment,concentrate,pursue,preserve,prominent,sincere,threshold,anderson,arched,owed,clinging,con,wilderness,winding,courts,herbert,muffled,worrying,decorated,compassion,stake,jokes,hence,lodge,hissed,boyfriend,demanding,spear,goodbye,worlds,aisle,mattered,abby,convenient,esther,execution,careless,foundation,glittering,forgetting,colin,spit,toe,copyright,hardy,sweater,mount,suitcase,australia,bewildered,disposition,philadelphia,undoubtedly,noises,drained,distinctly,commit,inquiry,grunted,schedule,gorgeous,privilege,reaches,document,aspects,volumes,dat,ink,illusion,parliament,vanity,jill,welcomed,defined,apron,citizen,holly,bond,inform,n.,narrator,tap,insane,buck,ignoring,hurriedly,les,keith,borrowed,girlfriend,peering,hire,cheerfully,crimson,poets,pad,resemblance,shifting,backwards,traced,kicking,outfit,felix,exists,sailors,measured,odds,madam,mayor,blushed,negro,deeds,karl,notebook,painfully,irony,dearest,grows,concentration,coldly,requested,austin,loneliness,mechanical,darted,jerusalem,shaft,solitude,neglected,yelling,obeyed,guarded,moaned,cunning,cousins,flush,condemned,und,vol,copper,outward,license,examining,canadian,conversations,hitting,nuts,disguise,moore,aircraft,elected,warrant,bullets,donald,anyhow,boards,reserve,commission,temples,invented,dislike,transformed,gary,sickness,campbell,disbelief,drift,pop,kennedy,temptation,penny,da,booth,punch,tub,folly,patrol,scanned,perfection,paths,stubborn,standards,closest,caesar,beef,owners,conceived,farmers,application,artists,episode,whence,englishman,costume,orleans,rival,affect,realm,perfume,echo,smells,vengeance,chains,resolve,behave,reign,vi,prime,increasingly,pan,session,ivan,disturbing,appearing,frederick,carrie,misfortune,widely,bald,independence,discourse,co.,gerald,begging,twist,attraction,refer,admiral,fiery,lou,probable,breaks,ninety,wrists,gravity,achieve,navy,arnold,grandma,stanley,rabbit,resentment,happier,strictly,raymond,alcohol,regiment,lust,hood,shelves,fuel,coin,occupation,spat,stack,measures,jewels,suite,snorted,hearth,softened,parallel,pleasures,feeble,underground,shine,rug,rosa,twisting,logan,declare,noah,vincent,assurance,hal,atlantic,artistic,seth,cocked,fascinated,erect,shorts,sparkling,countess,dwelling,registered,socks,languages,awareness,frances,stricken,wrath,renewed,helmet,ankle,destination,mug,medium,quinn,edged,apologize,core,tomb,motives,tyler,era,painter,topic,rocking,casting,purely,vulnerable,ashore,snap,scarce,bade,preparation,spilled,coarse,momentarily,primary,megan,antonio,gleam,childish,ache,comic,dense,disturb,joining,sworn,teasing,strolled,strings,nail,intervals,winked,sobbing,mix,handling,furiously,lab,taller,downtown,leapt,beautifully,settling,intimacy,ken,mistakes,examples,hollywood,essence,defeated,requires,ties,sleepy,reflect,caution,drifting,propped,pet,promising,sixth,detailed,persisted,sunny,napoleon,incidents,whirled,bout,attacks,breathless,blazing,logical,pathetic,dated,roused,eyelids,gracious,husbands,wonders,draped,consisted,channel,tube,relatively,perceive,isolated,vessels,overwhelmed,battered,floors,nelson,smashed,yield,wrought,solemnly,gilbert,colleagues,columns,differently,clare,compliment,dates,linked,obscure,accurate,hears,frankly,hastened,surgeon,creative,caring,strict,texts,todd,fragments,partners,critics,delivery,acres,shells,titles,earnestly,outline,instruments,dismay,sydney,hideous,repeating,tess,senator,suspicions,boring,canoe,georgia,tendency,darker,miranda,grimly,frowning,adjusted,roaring,licked,association,wars,hast,housekeeper,tumbled,churches,irritated,rider,depressed,maurice,rotten,cemetery,teased,earliest,mister,apology,chaos,noisy,paced,judged,jan,quest,sour,recognised,referring,coins,overwhelming,youthful,subsequent,frantic,rivers,anticipated,eva,traces,di,spared,joyce,awaiting,arguing,weep,stella,shivering,warmed,psychological,glowed,neighbours,chiefly,ultimately,squeeze,miriam,prose,unaware,heroic,kyle,handing,considerably,dedicated,interpretation,experiment,carlos,attending,trailed,drunken,transferred,kidding,connie,leslie,revelation,filthy,ruled,bedside,aching,hurrying,claude,succession,weighed,hans,thompson,ached,wider,sniffed,magical,baseball,ankles,descent,christians,arrows,engineer,amelia,thereby,swell,mouse,identical,fatigue,judy,complaint,smoothly,malcolm,fortunately,goat,mock,cord,wipe,tips,ribbon,revolver,profile,sized,eyebrow,warmly,trigger,wander,acceptance,noticing,giggled,harbor,wiping,opera,levels,craig,circled,dipped,corrected,panting,wallet,sweetheart,stillness,joey,interfere,beans,comrades,contest,blocked,classic,inspiration,improved,cargo,natives,healing,repair,beheld,comfortably,mischief,derived,proportion,mum,sandwich,debate,observing,tangled,pearl,survival,administration,spray,eternity,travelled,simultaneously,situations,failing,chorus,lump,conception,hitherto,jar,downward,item,coats,dennis,brutal,affectionate,competition,deputy,accepting,chimney,propose,tennis,countryside,chat,apt,fascinating,scandal,refusing,i.e.,liking,cafe,thankful,pony,artificial,finishing,kin,approved,costs,worker,fools,seas,engines,neighbourhood,addressing,landlord,perched,edgar,cease,unnecessary,packing,photos,positively,behold,rounds,simplicity,garments,bury,collins,kneeling,belle,fancied,colours,video,pinned,cassie,constructed,clapped,preparations,ropes,trash,inherited,crashed,extensive,swords,marshall,herr,scorn,sentences,crowds,consumed,improve,tribes,hauled,horns,hesitate,matched,huddled,unlocked,essay,depression,museum,unexpectedly,awfully,enjoyment,boiled,ne,bat,jet,jon,nurses,quantity,cautious,mourning,describes,customer,fading,declined,ter,supreme,satin,retreated,mattress,avoiding,lizzie,launched,guardian,instinctively,jest,cents,deaths,passions,bred,crooked,luggage,helpful,representative,harvey,deliberate,rattled,accordingly,toy,diamonds,attendant,races,groan,slumped,feather,tenderly,render,register,carries,cal,evelyn,rocky,punished,resembled,gregory,swam,vehicles,appreciation,apprehension,armor,oscar,joanna,behaved,heartily,applause,headache,sales,doubtful,crawl,cuts,mused,agitated,carolina,im,preacher,rev.,respects,ol,shiver,spectacle,blush,shrug,bike,heated,panel,mitch,disgrace,kent,meadow,objection,helps,nineteen,complexion,suggesting,flicked,bronze,wheeled,fright,ellie,funds,harrison,recollection,tremble,phoebe,rises,locks,masses,willingly,opportunities,unseen,spoon,baker,becky,diary,robinson,hooked,virtually,laughs,plump,pounded,torch,irene,jerk,yourselves,horace,liberal,harper,mentally,monkey,fragile,screams,rim,tho,proceedings,vulgar,barrier,traditions,followers,awaited,pillows,reads,stamped,entertained,replace,rational,murray,troy,edinburgh,cape,calculated,separation,merit,leon,cowboy,thrill,pots,parade,vegetables,frightening,solve,exceedingly,unwilling,economy,crumpled,rocked,pleasantly,solomon,golf,makeup,gasp,fashionable,folds,peasants,spoiled,muddy,pulls,candy,sexy,harmony,lend,shades,vacant,couples,stall,ethan,anchor,scottish,shorter,ridden,bulk,random,del,advise,stewart,references,edmund,rack,providing,resigned,executed,appreciated,cupboard,smelling,imaginary,drawers,lingering,bursting,leisure,wits,comforting,quivering,visions,ambulance,scare,melissa,waitress,shudder,annual,leonard,distinguish,brushing,startling,salad,subdued,tossing,watson,organ,drum,gladly,substantial,tickets,destined,recording,transport,incapable,remainder,masculine,gloria,correspondence,squad,technology,emptied,duck,cells,ali,monk,celebration,beatrice,russians,shrill,announcement,encouragement,encourage,lounge,gut,jess,yell,cute,monstrous,ruby,watches,vicious,beliefs,cynthia,mars,wreck,wheat,swayed,arch,robbed,rolls,gestures,conventional,celebrate,inviting,soothing,picnic,realization,lacked,republic,junior,scarf,virtues,curb,sketch,decades,stored,mule,ditch,roland,severely,dwell,fro,provides,clicked,prompted,nursing,cruelty,yonder,teddy,partially,heather,provisions,wells,judges,explains,confronted,trucks,betray,whispers,arab,steven,statements,thrilled,caleb,successfully,wages,slavery,flooded,eden,deaf,employees,writings,arc,ho,repeatedly,represents,flock,ducked,steering,scholar,paces,garbage,percy,a.m.,sped,sophia,mademoiselle,cameron,automatically,chasing,compound,adults,trips,wayne,oddly,crisp,robes,surprisingly,approve,stooped,lo,spencer,streaming,slain,depended,actors,wales,ibid,salary,timber,functions,dante,ash,welfare,sweetness,biting,trifle,scar,honesty,sails,forests,wagons,nell,odor,phrases,clubs,compare,joel,selection,prices,hawk,casey,ay,oven,lets,automatic,classical,pleading,christianity,lofty,supporting,crawling,storage,peggy,sharon,tan,streams,doctrine,launch,dash,leah,harvest,mme,chased,definition,theories,travis,threats,describing,engage,enabled,hurting,piercing,stiffened,neil,commanding,petty,smallest,nothin,institution,crush,reverse,satan,yanked,strategy,jacques,accomplish,lt,deceived,smoothed,axe,rub,swaying,punched,poked,marching,network,spoil,git,occurs,rita,wolves,meredith,victorian,fuss,regretted,ample,dangers,cannon,communicate,stockings,expenses,resort,dagger,tests,connections,hedge,scratch,dangling,hostess,violet,hardened,seventh,academy,existing,railing,enterprise,yon,coincidence,flashlight,justified,fare,refrigerator,assuming,virgin,talents,verses,blamed,illegal,bands,fake,irritation,perception,briskly,stations,skinny,murphy,cough,instincts,novelist,alas,boiling,demons,duchess,paula,strikes,restore,cancer,protecting,surgery,congregation,hugo,inspection,someday,abraham,trunks,federal,homer,jersey,rural,cavalry,commenced,expectation,whites,grandson,twentieth,knives,christine,institutions,concert,fingertips,pierced,pa,wrap,sheila,dreaded,induced,survey,imagining,whisky,agitation,annoyance,inward,whatsoever,commitment,recovery,explore,ledge,mitchell,slap,shadowy,projects,endured,fluttered,egyptian,suppressed,heaved,procedure,il,react,wax,wears,tongues,retire,dale,assignment,learnt,contented,blackness,hunters,eagle,sphere,pupils,click,electronic,touches,personnel,advancing,rats,alter,bounced,nicely,kirk,harvard,towers,tissue,necklace,logs,transfer,technical,semi,derek,winced,dimly,indicating,depart,scholars,freed,conrad,shawl,pleasing,lads,stiffly,gigantic,hector,rosie,poetic,adrian,forgiveness,moist,hoarse,situated,sentimental,creeping,enthusiastic,laundry,deepest,holidays,coward,fits,enclosed,saloon,dialogue,external,advantages,attract,hitler,louisa,offence,protective,clumsy,perry,retained,burial,institute,mat,rented,apples,convincing,prints,relieve,possessions,formidable,milton,sebastian,doug,presumably,challenged,beads,includes,recommended,viewed,composition,overheard,ohio,desperation,sweating,owing,collecting,uncertainty,hudson,clan,harmless,wearily,units,cliffs,essentially,packet,admirable,fold,varied,rag,submit,reminds,claws,barked,thirst,reproach,gleamed,climate,legged,resisted,hunted,jefferson,hearty,ensure,draft,multitude,circular,spectacles,admiring,yielded,thieves,helicopter,alec,expectations,overnight,wallace,outstretched,diane,removing,kay,gender,neighbour,ernest,venice,sends,erected,turner,eliot,beams,salvation,attic,surveyed,unfamiliar,sobbed,everyday,seeds,andrea,bathed,battles,convey,madison,esteem,adds,crude,imposed,eighteenth,composure,marion,natalie,eliza,hurled,lent,tastes,haze,colony,refusal,formation,hospitality,machinery,weeds,sobs,exhaustion,policemen,pacing,operating,plains,loan,dozens,jackie,leaping,lauren,plague,rod,horrified,sob,evans,sustained,jewelry,coughed,comprehend,dublin,vii,antique,entertain,gus,exile,reed,earthly,listed,convent,drives,satisfactory,gallant,sucking,skies,relate,dumped,index,planes,phase,justify,collapse,periods,factor,mocking,neglect,tourists,matching,folding,boldly,doomed,pigs,tool,exaggerated,assembly,damaged,eagerness,bothering,desirable,supernatural,laden,goddamn,sections,sung,butler,byron,evan,rifles,elephant,frantically,residents,borrow,constance,geoffrey,ripe,commands,sinister,apartments,eugene,producing,mysteries,slippers,springs,stroking,charms,atop,nicole,plucked,lordship,bis,pro,umbrella,sermon,generosity,instruction,frail,preceding,identification,stride,merchants,ivory,pills,breed,despised,wasting,mustache,wade,consolation,keeper,muscular,dispute,romans,fruits,pipes,choosing,tiger,slice,resignation,practices,invasion,industrial,blinking,upwards,fortnight,cable,ms,products,admission,burke,speeches,lacking,buffalo,dine,customary,tapping,fee,tooth,trains,ashley,torment,rescued,ambitious,correctly,tortured,chewing,jaws,finn,humiliation,fer,void,venus,illuminated,meets,flora,intellect,cakes,obligation,seize,lamb,balanced,hen,province,hasty,sullen,ron,hairs,invariably,employ,blades,sewing,mornings,brandon,armies,goose,discomfort,joking,patches,momentary,implied,calf,terrific,indication,crop,flickered,beamed,lashes,jolly,mississippi,porter,francs,glaring,thorough,basin,exotic,bathing,decade,verge,rejoined,nate,sentiments,tire,comedy,actress,briefcase,wi,asia,bacon,whistled,donna,puzzle,defiance,models,specifically,technique,stray,marquis,dora,na,samantha,diego,hebrew,guarantee,wary,boarding,melanie,chambers,spark,layer,entertaining,piles,shabby,designs,decline,scotch,invention,viii,chuckle,deceased,unnatural,contributed,peak,randy,hum,limb,punish,pose,faculty,humming,ham,saints,executive,rumors,commonly,lloyd,vera,stammered,edited,tavern,est,squinted,detected,drake,objective,films,screwed,crashing,outcome,marty,dependent,holland,float,insight,chickens,proposition,script,inquiries,chloe,grumbled,blaze,pennsylvania,notions,greece,spin,sternly,countless,stables,sturdy,blurred,throbbing,characteristics,crest,hovered,reporters,shotgun,testing,pearls,posted,custody,hurts,fortunes,arise,remarkably,glove,realise,occupy,rags,investigate,shakes,squire,nursery,celia,frustrated,dove,critic,rosy,hester,pictured,instances,rebellion,confirm,unusually,rape,whistling,kansas,pickup,grandpa,radiant,posts,shelley,napkin,filed,ellis,giles,heavenly,conveyed,triumphant,snakes,isbn,chewed,worries,frontier,matches,shrieked,sandwiches,bonds,grabbing,heal,sequence,bows,paradise,remembers,grove,reasoning,bruised,steaming,regions,monica,stacked,knuckles,mound,web,flickering,detached,transparent,honored,baked,disappearance,allows,muttering,converted,whore,incredibly,mines,kettle,trailer,wardrobe,bolted,delayed,bella,inferior,roofs,starving,escorted,p.m.,trailing,bailey,murders,via,elaine,console,compartment,homosexual,singer,nuclear,choking,richmond,guts,reverence,stages,dazed,cans,cathedral,qui,enable,signature,sub,travels,dresser,consulted,complaining,civilized,crap,encouraging,dizzy,improvement,vietnam,dolly,remorse,academic,bonnet,festival,awkwardly,morality,tasks,straining,riders,easter,mildly,intensely,tina,bunk,dreary,inevitably,reasonably,worldly,phenomenon,acceptable,developing,penguin,disappearing,barking,groom,terrifying,philosopher,garment,heroine,rely,presume,uniforms,hovering,efficient,vampire,teresa,praised,stays,reflecting,detectives,safer,gambling,ella,practiced,equivalent,orderly,emerge,sights,perpetual,surge,ecstasy,distressed,saxon,mamma,bicycle,timid,brute,flour,toss,abrupt,interval,wright,captive,option,dating,curly,impressions,draws,tents,freezing,tested,lesser,stephanie,radical,bloom,attitudes,embarrassing,obedience,si,steward,withdraw,deserves,impress,poised,amiable,vigorous,hanged,wink,choices,pub,objected,dana,doubled,treasures,namely,miniature,extend,observations,armchair,specially,rusty,inquire,rattle,conspiracy,audible,pious,dealer,pump,campus,scrap,injustice,dignified,gasping,hopeful,complaints,dallas,cycle,ot,olive,pinched,interrupt,extending,fundamental,regards,suggestions,jared,chips,pairs,tracy,taut,horseback,conclusions,serpent,toys,strongest,reckless,providence,peoples,guidance,forgiven,descend,howling,helplessly,cia,imitation,reminding,cupped,intercourse,legends,scowled,lone,notwithstanding,columbia,julius,fascination,flee,betsy,inheritance,barren,legitimate,horrid,disorder,fore,conceive,jammed,hunched,gwen,adjoining,proclaimed,candidate,nap,sly,representation,underwear,jose,errand,infinitely,mature,summit,freshly,nan,moan,fewer,arrogant,buddy,fortress,enters,speculation,cradle,regardless,spaces,stung,sweetly,abbey,liar,desolate,heed,employer,manhattan,deemed,fade,swelling,fiona,villagers,animated,gin,salute,trading,genuinely,shares,mute,devices,parlour,pausing,hates,involving,assumption,stamp,jr.,strokes,mercedes,li,flared,coolly,disliked,stem,timothy,reflections,glistening,bearded,sincerity,afforded,weekly,kathy,fluid,sauce,raging,foam,symptoms,wont,sprung,needing,dazzling,splashed,darcy,expressing,dances,lists,creep,serves,embroidered,descending,urging,kathleen,immortal,archie,stately,telegram,wow,appealed,irresistible,plea,excused,treating,associate,villa,frenchman,opponent,marian,deborah,tails,fund,acid,mickey,trim,prosperity,frost,sophisticated,sammy,lords,upside,stabbed,excess,chester,braced,poles,ale,proceeding,fetched,influenced,nods,massachusetts,foster,valentine,blurted,overlooked,defensive,cursing,rightly,jasper,intact,rum,lowest,brighter,drowning,henri,performing,plantation,shaw,expose,escaping,banged,crucial,announce,halls,maids,excitedly,thine,overlooking,angus,deprived,warehouse,taxes,chatter,inclination,reform,uneasily,numb,cot,shepherd,primarily,retirement,denial,discreet,unconsciously,lowering,clinic,flown,andre,reassuring,nowadays,chiefs,shrewd,riley,leadership,divorced,peer,heights,communities,temporarily,vile,integrity,benefits,monks,attendance,courses,conquered,pursuing,assisted,marc,drums,michelle,criminals,butcher,erotic,posture,philosophical,fixing,dee,shuffled,marvelous,locate,wonderfully,brenda,marvellous,sexuality,knots,sincerely,lynn,corruption,quote,sticky,bodily,compromise,ironic,rue,hilda,greeks,fearing,tara,debts,indignant,stan,responsibilities,regained,consult,consequently,refers,gina,nipples,moss,checks,gabe,poker,val,excuses,prejudice,bang,insects,rattling,offensive,amidst,transformation,teams,fans,lance,allan,cheered,sovereign,abstract,raid,fried,disgusted,drivers,shaved,fulfilled,soda,bucks,fluttering,alison,anonymous,barney,angie,moustache,nun,skins,symbols,plaster,versions,australian,token,pedro,electricity,bart,comrade,fighter,benny,clothed,traitor,passionately,snarled,equipped,steamer,convention,granite,females,solely,continent,penetrated,frighten,striped,artillery,acquaintances,carelessly,swelled,exclusive,scheduled,operate,claudia,withdrawn,loosened,vowed,appearances,diet,accord,drown,brisk,purity,sneak,understands,whale,hushed,ominous,guitar,replies,isabella,swamp,manhood,wiser,ghastly,recommend,polish,offense,cindy,stumbling,scope,confided,baggage,robbery,heavier,collective,hem,brightened,detroit,toronto,restraint,razor,shocking,melting,tribute,theo,premises,bert,sample,chapters,hopefully,communications,canal,harbour,thither,faults,clergyman,bennett,medieval,prevailed,verbal,connor,select,continuous,pays,camps,graduate,ammunition,imperial,motel,topped,cushions,chuck,vigorously,deciding,tanks,shirley,pasture,astonishing,phoned,senate,roberts,portuguese,publicity,benches,folklore,vow,nigh,disagreeable,globe,privately,snapping,bidding,wherein,deepened,sensations,slung,roast,fumbled,stares,battery,qualified,needles,trimmed,unity,ribbons,yo,politicians,scenery,tumbling,fletcher,representing,lain,retain,hither,bees,reassured,shores,echoing,weakly,emptiness,potato,attributed,crane,discarded,slopes,magistrate,laurie,natured,cameras,serene,nigger,raven,zone,yawned,oral,appealing,mobile,sidney,foe,rewarded,screw,elena,farms,solved,ego,monitor,dome,throws,involve,skinned,wires,angles,elders,colorado,par,hatch,dominated,bestowed,scientists,accidentally,injuries,grotesque,destroying,signals,motions,turkish,urgency,ordering,comb,beggar,restrained,discretion,menu,pupil,zoe,helena,vienna,operator,michigan,pines,reluctance,curling,hillside,beckoned,frankie,adequate,breaths,superiority,thence,dancers,vest,acute,sensual,oblivious,adopt,weariness,isolation,outrage,brightness,attachment,backing,stark,risks,edwin,leigh,nobility,saul,scratching,judging,spider,consists,vicinity,comforted,tires,advertising,honorable,siege,spectators,otto,regain,thereof,aggressive,hush,dwelt,league,tempered,handwriting,trusting,vols,greedy,circling,hysterical,houston,sprawled,pondered,effectively,arrives,canyon,pitiful,investment,josie,paragraph,harness,probability,chilly,peril,belongings,morton,dialed,cardboard,scraped,constitution,sandra,bachelor,princes,wee,bizarre,repose,dive,resulted,sparks,troop,symbolic,ton,layers,graves,delicately,presentation,brooding,hostility,flattered,trevor,tug,pregnancy,fights,discovering,roles,remembrance,tread,explanations,gertrude,gaining,cathy,winston,verdict,loomed,hugging,rebel,hotels,pissed,woven,relating,extension,gripping,submitted,blacks,mirrors,bleak,delicacy,stain,bounded,conclude,emerging,cope,ta,circus,grimaced,passport,handy,bumped,civilian,melt,maps,remedy,imprisoned,suspense,ministers,reared,reckoned,jam,bin,sanctuary,descriptions,clarence,forbid,chilled,patricia,lena,broadway,noses,courtroom,gideon,phillip,sting,subsided,bartender,erin,thirsty,exposure,contrived,programs,sheltered,yacht,caress,resume,flicker,affections,preoccupied,slippery,shaded,picturesque,jules,allison,sonny,urban,disposal,prairie,gothic,babe,confront,strewn,tunic,crops,trivial,facility,pier,prophet,blinded,volunteered,echoes,eighth,reliable,profits,te,properties,ida,frightful,storms,patron,bee,cherished,abilities,involvement,bud,malice,sipping,wrapping,array,asserted,es,disgusting,doom,poe,declaration,hull,adored,vines,gym,drawings,scars,christina,alicia,refined,mounting,ruler,pitt,contribution,strap,nat,journalist,respectful,melville,dump,shane,chart,champion,eli,highness,depending,suspiciously,cluster,barracks,pamela,fragrance,restaurants,swirling,dearly,hawthorne,dismal,suck,rustling,tenth,crowned,defended,reproduced,naval,structures,shutters,bombs,persian,boundaries,publishing,achievement,cultivated,coughing,chattering,dryly,tighter,rogers,kenneth,adorned,deposited,reminder,bastards,caressed,bust,shannon,wendy,doth,installed,zeal,printing,temperament,accusation,abe,plunge,approaches,towering,undertake,architecture,epic,compliments,detect,deals,rooted,enforcement,estimate,agatha,slick,expanse,villain,themes,visibly,maker,imposing,doin,ups,monsters,veranda,foliage,puffed,drain,banker,trotted,iris,kane,trials,dwarf,necks,tourist,jeffrey,naive,shillings,ferry,discharge,blushing,devils,parcel,gavin,summons,cookies,twitched,minimum,debris,convenience,betrayal,grasping,circuit,claiming,resented,seasons,unfair,contemplated,cardinal,manifest,neutral,welsh,attacking,zack,promotion,mules,athens,disguised,mack,cecil,baskets,hounds,crushing,sparkled,colleague,worthless,shrank,spirited,jonas,managing,swiss,struggles,zero,satisfying,hangs,riches,warming,wanna,futile,haul,dessert,shriek,missouri,fantasies,borders,perplexed,frenzy,poisoned,prolonged,curves,yearning,currently,sunrise,fleeting,cement,avail,summon,noting,indulge,nut,commotion,gaping,hail,o.,unmistakable,caps,moaning,unworthy,climax,zach,irregular,crow,dismounted,harshly,overcoat,dancer,inserted,cracks,abundance,conservative,bluff,forefinger,factors,mabel,associates,decidedly,constable,au,bricks,unbearable,cured,pauline,lodging,officially,savages,picks,oneself,attentive,boom,hinted,consistent,ordeal,locker,prospects,pastor,marianne,strands,errors,herbs,streak,fails,pitcher,flashes,streaked,luncheon,badge,flaming,traveller,denver,portraits,sway,rafe,throng,jude,interruption,miami,communist,cracking,greasy,marshal,blunt,blur,skeleton,puppy,shaky,owl,bony,stairway,secrecy,spilling,links,jerome,deceive,luther,grocery,breach,statues,splash,strung,sleek,stale,virgil,choir,blair,visual,intolerable,hits,arranging,grinding,consciously,apollo,worm,elevated,quivered,permanently,gardener,scientist,partial,colonial,skilled,raft,dew,doris,monument,curl,boarded,drying,discussions,substitute,donkey,observer,healed,starved,options,chairman,processes,reduce,employee,cody,crosses,laboratory,absently,threaten,preceded,cavern,rubbish,multiple,com,contacts,foyer,sullivan,estates,granny,resident,excessive,allah,bounds,glided,bliss,raining,organizations,stalked,bowing,exclusively,uneasiness,shack,withered,acquire,blinding,faltered,relevant,padded,protestant,backyard,meters,decay,formula,surveillance,bubble,allies,riot,vein,gross,maintenance,chemical,squeezing,genre,heaving,rupert,confidential,theft,jug,saluted,luis,softness,hopped,junk,publicly,lining,bonnie,carson,knob,interviews,alliance,blackened,illinois,bradley,kills,somethin,blossoms,pillars,surviving,rex,dame,category,ushered,attendants,burton,elsie,sacrificed,controls,leisurely,dylan,sandals,slaughter,suzanne,retrieved,familiarity,toil,scalp,lemon,despise,reveals,joyous,bait,binding,litter,nope,chad,tangle,palmer,towels,mel,wig,rides,implications,hart,pouch,amuse,demonstration,enchanted,persistent,greatness,crawford,illustrated,blindly,manly,abode,aids,competent,consented,shrine,gum,rugged,proves,recovering,carriages,quixote,prosecution,marco,divide,timing,bess,diminished,sarcasm,virtuous,graduated,clint,domain,experiments,trent,vegetable,barnes,define,await,miguel,monastery,amber,speechless,husky,jewel,dis,nigel,pins,clyde,nudged,classroom,patio,musicians,bureau,exclamation,spacious,cora,particulars,breeding,valued,scooped,stationed,brooklyn,stroll,essays,prosperous,respective,yankee,drill,arizona,honourable,likeness,demonstrated,rejection,clipped,clarity,denying,travellers,idly,lasting,goats,secondary,subsequently,calendar,fisher,hairy,inhabited,peaks,rains,precision,treacherous,insulted,defendant,shove,techniques,turf,strips,humorous,thud,scented,conquest,willy,lester,brook,loosely,innumerable,wretch,atlanta,doyle,objections,tucker,anglo,corridors,distorted,terminal,refuses,lashed,bouncing,gracefully,ceremonies,shalt,compass,males,lame,mouthed,attained,maud,tailor,shutting,adjust,historian,pizza,tidy,sliced,pirate,spies,liable,pools,heritage,lass,sighs,dined,oxygen,conspicuous,ghostly,maxwell,recognise,lifeless,preference,fragrant,exhibited,barred,penetrating,murmuring,blazed,modesty,label,passive,wizard,banging,theodore,peeled,moderate,howl,jagged,transmitted,orchard,tanned,sinclair,midday,dominant,predicted,cramped,pistols,headlights,silvery,barrels,horribly,psychology,kentucky,ivy,kurt,ardent,fucked,curtis,laurel,owns,foreigners,suspects,chatting,shrink,baltimore,turkey,preliminary,counts,folder,lick,distraction,banquet,lipstick,deception,expanded,elliot,beats,mae,lodged,righteous,flags,presenting,tropical,scrutiny,bowls,cited,valleys,demonstrate,freddie,fisherman,veiled,mona,stevenson,penis,ethel,vault,breeches,uncommon,rio,grease,alleged,stench,hose,commonplace,notorious,favored,westminster,slit,mining,lurched,distribution,stew,whirling,footing,freeze,manuel,unsure,dissolved,penetrate,flattened,feverish,profoundly,reasoned,readiness,cushion,slamming,agencies,mommy,apologized,juliet,rebels,longest,clatter,merits,sundays,interference,comin,quaint,garrett,moisture,boast,naomi,photographer,luminous,aloft,cherry,dam,beaming,evolution,valerie,interpreted,boil,hon,calmed,unfolded,surged,salon,jenna,losses,phillips,clearer,cooler,realistic,amos,clouded,thumbs,tripped,warfare,thereafter,untouched,myths,shovel,ascended,exercises,wilt,quicker,mick,poking,exhibition,dawned,bra,connect,bridget,addresses,duly,melody,harley,auntie,hare,treachery,offspring,clamped,carmen,loading,gil,hong,maze,nonetheless,volunteer,robbie,lectures,op,hints,manor,almighty,pang,veronica,vase,rumor,provincial,proprietor,colorful,penalty,discharged,cynical,influences,quilt,psychic,brethren,accidents,miracles,daphne,extravagant,huts,carrier,prudent,patty,liver,e.g.,slack,grandchildren,nuns,truths,practised,biscuits,honeymoon,shipping,shimmering,pas,imaginative,ambassador,nellie,rip,distributed,horrors,historic,randall,une,decides,surrendered,twenties,rash,repaired,heartbeat,streamed,superb,buzz,trot,defending,calvin,muzzle,relish,canopy,treaty,democracy,pork,oars,lids,bellowed,abigail,gerard,accompanying,berkeley,laced,knotted,therapy,blocking,contracted,plead,indicates,proving,carolyn,pierce,supposedly,tons,confirmation,countered,flights,blanche,intending,repetition,automobile,reactions,growl,memorable,strapped,moods,vows,beverly,vanessa,afternoons,sane,flap,comparatively,wailing,gallop,lodgings,seeks,silas,waistcoat,operated,balloon,sage,thrusting,merlin,libby,archer,loses,ursula,devon,conquer,kong,disapproval,lindsay,disdain,loft,corporate,restrain,spears,grandparents,madeleine,luxurious,cleveland,gilt,waits,brett,sadie,hound,clerks,invaded,ally,adjacent,humility,stab,bind,landlady,corrupt,formally,retrieve,mournful,buzzing,gulped,lurking,tactics,homosexuality,blink,caressing,gifted,tormented,frog,paws,scout,chores,weaving,airplane,dashing,aback,pledge,inability,cue,andrews,din,lesbians,outlined,exposing,scores,doorbell,watchful,skipped,basically,pam,mice,gulf,serena,metallic,exploring,publish,wailed,insignificant,cheering,recalling,vernon,mast,jade,lime,foremost,carla,burns,maternal,montgomery,compelling,super,lions,commerce,eerie,alexandra,communicated,threads,fling,garrison,specimen,eyeing,pillar,tugging,ducks,someplace,mentioning,loop,companionship,trance,adapted,enveloped,corps,revived,settlers,aesthetic,inhaled,fabulous,frock,scholarship,exhibit,aristocratic,furthermore,lionel,zeus,brooke,prophecy,spectacular,bravely,emerson,steer,weigh,bessie,detachment,bedrooms,maintaining,tow,whereabouts,inwardly,uncovered,reynolds,broom,wed,gene,dose,frames,linger,bug,stoop,howled,slapping,glittered,mahogany,conceded,walt,sites,tedious,accurately,winner,licking,randolph,interrupting,hopelessly,greed,haughty,accuracy,neared,squatted,editions,onward,bruno,scales,tennessee,contribute,jed,survivors,sketches,fraud,steak,cocktail,tempting,rites,theatrical,reappeared,compact,teenager,uncomfortably,bruises,donovan,drenched,khan,hue,popularity,webster,janice,maine,augustus,approximately,pinch,cassandra,salmon,usa,tramp,stupidity,marriages,sublime,ix,inscription,fragment,emotionally,tenants,facilities,politeness,ty,unfinished,strand,dial,boundary,confrontation,esq,reporting,allowance,charging,bo,coals,paw,superstition,rumble,banished,stair,spells,cruise,gratefully,pursed,testament,silenced,clifford,channels,deposit,glossy,attire,blessings,corpses,foreman,raises,eloquent,advances,torches,basil,hailed,newman,metaphor,vanish,lillian,henderson,perspiration,dinners,computers,eminent,societies,indiana,sustain,liverpool,republican,thickly,à,delia,witches,attentions,authentic,weed,bolan,wisely,schemes,reacted,poorly,posed,commissioner,prone,curses,tiles,fraction,receipt,scrub,finer,housing,subjected,patting,evenly,pal,elegance,petition,richly,vegas,accordance,submission,resemble,armour,orchestra,dilemma,refrain,poland,indulgence,puff,wail,michel,dismiss,immensely,racial,missionary,pained,nightmares,edna,educational,keenly,warmer,mirth,responses,roosevelt,sacrifices,associations,transition,infantry,pirates,surf,flourish,turmoil,workmen,stevens,surprises,um,disturbance,hereafter,mantle,tristan,proportions,decisive,experts,marine,gaily,provision,welcoming,doorstep,oval,brady,stature,explored,wesley,vince,involuntarily,caves,oppressed,audrey,edwards,signaled,pepper,bitten,rory,occurrence,clues,perish,windshield,contemplation,yep,stump,rates,explode,therein,ny,intricate,appalled,jeanne,mattie,butterfly,ideals,silky,barber,flatly,lookin,inspected,jupiter,stance,ruling,retreating,ninth,quiver,annoying,destructive,stallion,tease,outskirts,testify,neighbouring,reassure,seriousness,soothed,accuse,d.c.,shadowed,darkly,meaningless,reject,projected,scraping,carpenter,outburst,arrogance,sufferings,hardest,portions,overall,rot,brim,bullshit,faithfully,regulations,thirties,fainted,inflicted,chess,privileges,exterior,fringe,distinctive,exceptional,mechanism,herman,vividly,rainbow,nazi,mockery,scraps,fictional,whither,switzerland,confidently,fleeing,boyish,tattered,strides,representatives,dimensions,rung,anew,mildred,sighing,exasperated,convicted,clive,gaunt,clarke,hughes,insistent,involves,gale,recollect,tag,grandeur,dip,chancellor,knit,meadows,directing,invested,stony,politician,baffled,legacy,dotted,freddy,tolerate,indulged,muster,hack,fuckin,latch,norton,abused,misty,sunglasses,slips,obsession,farmhouse,winged,wolfe,seattle,glen,scary,asshole,combed,banner,dans,amounts,charmed,sancho,obligations,hissing,assertion,asian,rabbi,descendants,stifled,eats,revolt,sid,intrigued,induce,bernie,provoked,bandage,expressive,giggling,patent,clarissa,hind,unnoticed,budget,ada,slumber,editors,preston,meditation,ronald,freud,buggy,loaf,rabbits,dragons,buttocks,eloquence,madman,certificate,hides,ramp,dane,giggle,mi,requirements,phenomena,fingernails,simpson,invalid,imprisonment,haunt,sabbath,engaging,wry,nathaniel,joys,slacks,ingenious,maximum,allusion,carts,granddaughter,abel,marjorie,scrape,josephine,breadth,announcing,fishermen,liam,snatch,blossom,transported,mates,drooping,spill,architect,quickened,bridle,averted,steered,millie,notices,venerable,amateur,angelo,swirled,quentin,organs,forlorn,ornaments,chariot,kenny,bamboo,eileen,challenging,stalls,outrageous,fielding,chestnut,rocket,flank,excellency,maureen,ravine,cling,exercised,watery,catastrophe,baxter,courteous,ruthless,dangerously,sorrows,dolls,clayton,bewilderment,proven,newton,sums,willed,governess,microphone,theresa,striving,considerations,flannel,estimated,chelsea,scarred,imminent,flapping,mandy,travelers,outraged,cf,mediterranean,planets,solar,marguerite,vodka,nightgown,smeared,senseless,finely,bertha,monarch,awakening,sneered,lunged,preach,twinkling,phoenix,bridges,stormed,earrings,chauffeur,fighters,hooves,tutor,flutter,goals,weighing,glimpsed,vine,energetic,torso,shave,darting,scolded,forearm,lousy,gentleness,scots,treason,unison,ladyship,supposing,madeline,liza,madly,basketball,yale,arena,illustration,cheated,lucia,brooks,removal,obstacle,bump,duel,aft,pilots,mythology,callie,eccentric,richardson,furnish,unjust,boredom,las,vent,confusing,chalk,womb,jackets,violin,wan,resulting,varying,bulging,orphan,privileged,wrenched,sacks,rosemary,guessing,unlucky,tame,phyllis,scanning,diplomatic,nicky,container,frau,concentrating,jenkins,menace,potent,veteran,triumphantly,staggering,respecting,mouthful,preaching,fairies,tessa,shouldered,displeasure,straps,connecticut,sickly,miraculous,snowy,equality,seventeenth,kitten,wid,magician,rainy,dainty,catches,slower,abundant,nailed,obsessed,humbly,shuddering,shifts,exalted,fingered,rand,oriental,distract,mon,constituted,toll,montana,intruder,electrical,missile,accounted,hamlet,wyatt,stormy,efficiency,ox,tristram,blankly,interpret,starve,notable,arabic,rests,ginny,neighboring,sweaty,controlling,menacing,swearing,grassy,torrent,rained,centered,coke,cult,silken,closes,stunning,tubes,weakened,kat,speakers,accommodate,rotting,coolness,regina,insists,insistence,calves,broadly,poster,draught,lila,ax,brink,matilda,whiskers,carlo,collections,copied,weekends,topics,responding,miners,powerless,admitting,chip,terrain,consisting,vivian,unreasonable,joyful,promoted,lifts,sasha,morals,playful,manchester,energies,flattering,undertaking,creaking,slam,rails,savannah,propriety,inadequate,miserably,clasp,joints,devoured,plato,weaker,urgently,fished,brent,accusing,proceeds,thames,appalling,pint,hyde,fitzgerald,participate,countrymen,robbers,internet,martial,erupted,alarming,lush,exhaled,undressed,numbered,vic,offend,generals,ricky,willow,trench,endowed,explosive,chanced,trumpet,distrust,peacefully,investigating,suppress,ruffled,lakes,bryan,piss,talented,coachman,shuffling,furnace,gilded,contemplate,wrinkles,marsh,spitting,lucien,outright,squares,cecilia,contemplating,knitting,sessions,panties,exertion,cultures,overboard,strangled,noel,bass,mane,cigars,origins,holt,happiest,planting,sighted,boasted,abyss,embassy,marking,crippled,diseases,extract,grunt,id,envied,woe,reviews,wally,span,influential,blinds,ants,respectfully,nobles,legendary,freak,biography,farming,encounters,anton,marilyn,twain,diving,similarly,aura,parson,armstrong,crumbling,impending,thicket,clip,gail,grapes,declaring,horsemen,continual,radar,giants,jan.,thrilling,extracted,sal,aroma,disastrous,reservation,honoured,emphatically,fritz,thanksgiving,differ,mara,creates,clapping,lore,sneer,favourable,naughty,hazel,crews,clown,resembling,dillon,denise,cheat,cuba,conductor,indignantly,thump,bolts,franz,griffin,jeremiah,cass,affectionately,awaken,luckily,produces,cordial,uneven,hymn,teenage,naught,glint,youths,henrietta,colt,corresponding,accidental,groaning,christie,masks,inland,mischievous,pension,fills,successor,lazily,savings,sleeps,mall,freight,sings,gowns,elise,galloped,bursts,ronnie,westward,inspect,malicious,glazed,caravan,fences,introducing,haunting,recognizing,interviewed,showered,unspoken,interrogation,splashing,severed,corporal,nikki,barton,accumulated,softer,assent,ambitions,springing,avery,reversed,instinctive,richer,regrets,lanes,clergy,obstacles,enduring,slate,fooled,guiding,insanity,undone,twas,raged,dreamy,musician,afore,enraged,dire,exasperation,tying,margin,plunging,aubrey,trinity,insect,vitality,targets,kinda,intervention,petersburg,isle,wondrous,gettin,witty,delivering,tensed,spaniards,beforehand,tranquil,vertical,crouching,whereupon,democratic,paperwork,explicit,cooperation,pulpit,obscured,monthly,feminist,mallory,superstitious,scattering,jennie,coldness,leans,shyly,orbit,tackle,anita,affecting,sporting,rustle,tanner,dinah,chant,hoisted,paige,foundations,wheelchair,soiled,irving,publishers,francesca,grieved,chopped,camel,preached,editorial,rejoiced,sunken,nightfall,satellite,circulation,rejoice,jars,minority,uniformed,vexed,positioned,creaked,reggie,dominic,belinda,peters,archbishop,incense,boris,presumed,holster,indoors,amen,programme,tor,receives,peculiarly,comprehension,plank,memorial,gait,potter,considers,endeavour,nobleman,hiss,littered,fertile,raped,scissors,tremor,tolstoy,attributes,compensation,berries,investigator,trails,tumble,abide,ginger,endeavoured,crammed,susie,harlequin,prosecutor,quarry,straighten,choke,fran,housed,lovingly,mixing,wrestling,soothe,churchill,assert,discern,illustrations,colonies,stretches,haven,warily,profitable,sarcastic,dough,scowl,olga,whipping,biological,hooks,extinguished,traits,sabrina,lumber,boughs,guarding,limitations,popping,curving,reuben,tory,yielding,speedily,laurence,spied,recited,jeep,illusions,wrecked,petals,consulting,flinched,captains,peach,remnants,smoky,clutch,squat,nipple,headlong,renaissance,crust,transportation,wad,brakes,throats,incomprehensible,succeeding,texture,maya,barefoot,ruddy,emerald,pumping,naples,traps,tidings,slab,meanings,anniversary,alma,reproduction,reddish,crackling,marvel,imply,joked,mills,valet,everlasting,strove,louisiana,discouraged,recorder,harding,favorable,crook,regime,dispersed,telephoned,devote,ministry,majestic,austen,vacuum,philippe,fifties,prick,locking,rushes,assessment,utterance,worms,volunteers,dimension,depicted,murderous,valid,oppression,oregon,nuisance,designated,dubious,austria,boulder,dona,tumult,pudding,unmarried,significantly,bouquet,boyd,peers,ce,somber,sherman,diversion,insisting,dna,tile,defiant,heaps,gingerly,beauties,reverie,cottages,connecting,aurora,endurance,foreigner,flare,tightening,augusta,godfrey,rumbled,ernie,twitching,hop,gal,markets,hastings,dawson,yorkshire,gaiety,learns,partnership,contentment,lure,heaped,hmm,arabs,ambush,straightforward,preservation,perished,wang,rogue,devoid,oppose,homage,hummed,homeless,costly,sa,dey,geneva,zealand,pleases,voted,smash,apparatus,lois,plots,novelty,stakes,jonah,forthcoming,rendezvous,boulders,negroes,cd,minnie,securely,broadcast,monotonous,seizing,emphasized,hateful,divisions,oppressive,undertaken,skip,buzzed,graveyard,mocked,splendor,trout,prompt,paved,swallowing,priscilla,cruelly,innocently,shameful,scrubbed,lengthy,voiced,nestled,smothered,relentless,allie,tracking,intimately,milo,hoarsely,fancies,applying,protests,breathlessly,narratives,cain,beau,aunts,sloping,bordered,realizes,oblige,vegetation,tending,risked,prescribed,homework,hubert,han,darkening,powell,albeit,corral,grazing,obedient,snoring,implies,bail,typed,hospitals,journals,charcoal,greene,mo,developments,aiming,hating,panicked,stinging,commentary,coated,practicing,costumes,occupants,trifling,hale,stink,faculties,vocabulary,favors,sexually,accessible,thundered,telegraph,measuring,apologies,dealings,sur,grimace,buttoned,packs,intuition,receptionist,experiencing,engineering,clump,perch,infection,terrorist,inexplicable,serial,governed,lengths,proofs,jen,obtaining,tentative,glimmer,sprawling,katy,rimmed,sensing,sneaking,erection,marina,lavender,ounce,policies,shoving,outstanding,benson,l.a.,unreal,stating,rudy,shipped,backpack";

// 将字符串转为 Set 以便极速查询 (O(1)复杂度)
const REAL_WORDS = new Set(COMMON_WORDS_STR.split(','));

// 辅助函数：判断是否是真词
function isRealWord(w) {
    return REAL_WORDS.has(w.toLowerCase());
}

const CHARS = 'abcdefghijklmnopqrstuvwxyz ,.';
const BASE = 29n;
const PAGE_LEN = 3200;
const WALLS = 4, SHELVES = 5, VOLUMES = 32, PAGES = 410;

// 新的书名空间设计：长度与内容分离
const CONTENT_SPACE_PER_LENGTH = 29n ** 25n;  // 每个长度的最大内容空间
const UNIFORM_TITLE_SPACE = 25n * CONTENT_SPACE_PER_LENGTH;  // 总空间：25 × 29^25

let state = { hex: '', wall: 1, shelf: 1, volume: 1, page: 1, searchTerm: '', readable: false };
let computing = false;
let lastXpCoordSignature = '';

// ============================================================
// 游戏化系统数据
// ============================================================
let gameData = {
    level: 1,
    xp: 0,
    maxXp: 100,
    totalXp: 0,
    stats: {
        visits: 0,
        searches: 0,
        randoms: 0,
        bookmarks: 0,
        coversSeen: [], // 存储已见过的封面图案ID
        highestEntropy: 0,
        lowestEntropy: 10,
        highestSemantics: 0
    },
    achievements: [], // 存储已解锁的成就ID
    recentHashes: []
};

// 成就数据库
const ACHIEVEMENTS = [
    { id: 'first_step', name: '初入回廊', desc: '访问任意 1 个页面', icon: '🦶', xp: 50, condition: (g) => g.stats.visits >= 1 },
    { id: 'novice', name: '新手书虫', desc: '访问 10 个页面', icon: '🐛', xp: 100, condition: (g) => g.stats.visits >= 10 },
    { id: 'explorer', name: '资深馆员', desc: '访问 100 个页面', icon: '🕯️', xp: 500, condition: (g) => g.stats.visits >= 100 },
    { id: 'cover_fan', name: '封面鉴赏家', desc: '发现 5 种不同的封面图案', icon: '🎨', xp: 200, condition: (g) => g.stats.coversSeen.length >= 5 },
    { id: 'cover_master', name: '装帧大师', desc: '发现全部 30 种封面图案', icon: '🖼️', xp: 2000, condition: (g) => g.stats.coversSeen.length >= 30 },
    { id: 'meaning_seeker', name: '意义追寻者', desc: '发现一个语义评分 > 30 的页面', icon: '📜', xp: 300, condition: (g) => g.stats.highestSemantics >= 30 },
    { id: 'truth_finder', name: '真理挖掘者', desc: '发现一个语义评分 > 60 的页面', icon: '💎', xp: 1000, condition: (g) => g.stats.highestSemantics >= 60 },
    { id: 'void_gazer', name: '凝视深渊', desc: '遇到一个熵值 > 4.856 的极度混乱页面', icon: '🌀', xp: 1000, condition: (g) => g.stats.highestEntropy > 4.856 },
    { id: 'order_keeper', name: '秩序守望者', desc: '遇到一个熵值 < 3.500 的高度重复页面', icon: '⚖️', xp: 150, condition: (g) => g.stats.lowestEntropy < 3.500 },
    { id: 'alpha_omega', name: 'Alpha & Omega', desc: '访问过第 1 页和第 410 页', icon: '🔁', xp: 500, condition: (g, currentP) => currentP === 1 || currentP === 410, checkState: true } // 特殊检查逻辑
];

/**
 * 从 LocalStorage 加载游戏进度
 * 包含版本兼容性合并逻辑
 */
function loadGame() {
    const saved = localStorage.getItem('babelGameData');
    if (saved) {
        const parsed = JSON.parse(saved);
        // 合并数据以防版本更新
        gameData = { ...gameData, ...parsed, stats: { ...gameData.stats, ...parsed.stats } };
    }
    updatePlayerUI();
}

/**
 * 保存游戏进度到 LocalStorage
 */
function saveGame() {
    localStorage.setItem('babelGameData', JSON.stringify(gameData));
}

/**
 * 计算页面探索经验值 (XP)
 * 综合考虑语义分、信息熵和探索方式
 * 
 * @param {string} text 页面内容
 * @param {number} semanticsScore 语义评分
 * @param {number} entropy 信息熵
 * @param {boolean} isRandom 是否为随机探索 (搜索模式有惩罚)
 * @returns {Object} { total, factors, rawTotal, multiplier }
 */
function calculatePageXP(text, semanticsScore, entropy, isRandom) {
    const factors = [];
    
    // 1. 基础探索分
    let baseXP = 10;
    factors.push({ name: '🚶 基础探索', value: baseXP, type: 'positive' });
    
    // 2. 语义加成
    let semanticBonus = Math.floor(Math.pow(semanticsScore, 1.5) * 0.5);
    if (semanticBonus > 0) {
        factors.push({ name: '📖 语义加成', value: semanticBonus, type: 'positive', detail: `评分 ${semanticsScore.toFixed(1)}` });
    }
    
    // 3. 熵值加成（寻找极值）
    let entropyBonus = 0;
    if (entropy > 4.856) {
        entropyBonus = 20;
        factors.push({ name: '🌀 极高熵值', value: entropyBonus, type: 'positive', detail: `${entropy.toFixed(3)} bits` });
    } else if (entropy < 4.400) {
        entropyBonus = 20;
        factors.push({ name: '⚖️ 极低熵值', value: entropyBonus, type: 'positive', detail: `${entropy.toFixed(3)} bits` });
    }
    
    // 4. 计算原始总分
    let rawTotal = baseXP + semanticBonus + entropyBonus;
    
    // 5. 来源倍率
    let multiplier = isRandom ? 1.0 : 0.1;
    let multiplierReason = isRandom ? '🎲 随机探索' : '🔍 搜索定位';
    
    // 搜索到高语义内容，降低倍率防刷分
    if (!isRandom && semanticsScore > 40) {
        multiplier = 0.01;
        multiplierReason = '🔍 搜索(高语义惩罚)';
    }
    
    factors.push({ name: multiplierReason, value: `×${multiplier}`, type: 'multiplier' });
    
    // 6. 最终计算
    let total = Math.floor(rawTotal * multiplier);
    total = Math.max(1, total); // 至少1点
    
    return { total, factors, rawTotal, multiplier };
}

function addXP(amount, factors = null) {
    gameData.xp += amount;
    gameData.totalXp += amount;
    
    // 检查开关状态
    const showFloat = document.getElementById('showXpFloat')?.checked ?? true;
    const showPanel = document.getElementById('showXpPanel')?.checked ?? true;
    
    // 显示详情面板（如果开启且有因子数据）
    if (showPanel && factors && factors.length > 0) {
        showXPGainPanel(amount, factors);
    }
    
    // 浮动文字效果（如果开启）
    if (showFloat) {
        const hud = document.querySelector('.player-status-bar');
        if (hud) {
            const rect = hud.getBoundingClientRect();
            const floatEl = document.createElement('div');
            floatEl.className = 'float-xp';
            floatEl.textContent = `+${amount} XP`;
            floatEl.style.left = (rect.left + rect.width/2) + 'px';
            floatEl.style.top = (rect.top + 30) + 'px';
            document.body.appendChild(floatEl);
            setTimeout(() => floatEl.remove(), 2000);
        }
    }

    // 升级逻辑
    while (gameData.xp >= gameData.maxXp) {
        gameData.xp -= gameData.maxXp;
        gameData.level++;
        gameData.maxXp = Math.floor(100 * Math.pow(gameData.level, 1.2));
        showLevelUp();
    }
    
    saveGame();
    updatePlayerUI();
}

// 显示 XP 获取详情面板
function showXPGainPanel(total, factors) {
    const panel = document.getElementById('xpGainPanel');
    const totalEl = document.getElementById('xpTotalGain');
    const listEl = document.getElementById('xpFactorList');
    
    totalEl.textContent = `+${total}`;
    
    // 渲染因子列表
    listEl.innerHTML = factors.map(f => {
        const valueClass = f.type || 'neutral';
        const detail = f.detail ? ` <span style="opacity:0.6;font-size:0.7rem">(${f.detail})</span>` : '';
        const valueDisplay = typeof f.value === 'number' ? `+${f.value}` : f.value;
        return `
            <div class="xp-factor">
                <span class="xp-factor-name">${f.name}${detail}</span>
                <span class="xp-factor-value ${valueClass}">${valueDisplay}</span>
            </div>
        `;
    }).join('');
    
    // 显示面板
    panel.classList.add('show');
    
    // 5秒后自动隐藏，或点击隐藏
    const hidePanel = () => {
        panel.classList.remove('show');
        panel.removeEventListener('click', hidePanel);
        document.removeEventListener('click', hideOutside);
    };
    
    const hideOutside = (e) => {
        if (!panel.contains(e.target)) {
            hidePanel();
        }
    };
    
    // 延迟添加点击外部隐藏，避免立即触发
    setTimeout(() => {
        document.addEventListener('click', hideOutside);
        panel.addEventListener('click', hidePanel);
    }, 100);
    
    // 8秒后自动隐藏
    setTimeout(hidePanel, 8000);
}

// 显示已访问提示
function showVisitedNotice() {
    const showPanel = document.getElementById('showXpPanel')?.checked ?? true;
    if (!showPanel) return; // 如果关闭了面板就不显示
    
    const panel = document.getElementById('xpGainPanel');
    const totalEl = document.getElementById('xpTotalGain');
    const listEl = document.getElementById('xpFactorList');
    
    totalEl.textContent = '+0';
    listEl.innerHTML = `
        <div class="xp-visited-notice">
            📍 此页面已访问过<br>
            <span style="font-size:0.75rem;opacity:0.8">需探索新页面后可重新获得经验</span>
        </div>
    `;
    
    panel.classList.add('show');
    setTimeout(() => panel.classList.remove('show'), 3000);
}

function showLevelUp() {
    document.getElementById('newLevelNum').textContent = gameData.level;
    document.getElementById('levelUpModal').classList.add('active');
    // 撒花特效可以在这里加
}

function closeLevelUp() {
    document.getElementById('levelUpModal').classList.remove('active');
}
window.closeLevelUp = closeLevelUp; // 暴露给HTML

function updatePlayerUI() {
    document.getElementById('playerLevel').textContent = gameData.level;
    document.getElementById('currentXp').textContent = Math.floor(gameData.xp);
    document.getElementById('maxXp').textContent = gameData.maxXp;
    const pct = Math.min(100, (gameData.xp / gameData.maxXp) * 100);
    document.getElementById('xpFill').style.width = `${pct}%`;
    
    // 更新统计面板
    document.getElementById('statTotalVisits').textContent = gameData.stats.visits;
    document.getElementById('statCoverTypes').textContent = `${gameData.stats.coversSeen.length} / 30`;
    document.getElementById('statTotalXP').textContent = Math.floor(gameData.totalXp);
    
    renderAchievements();
}

/**
 * 检查成就状态
 * 遍历所有未解锁成就，判断是否满足解锁条件
 * 包含对特定成就（如首尾页访问）的特殊逻辑处理
 * 
 * @param {Object} pageData 当前页面数据（可选，用于检查特定页面访问成就）
 */
function checkAchievements(pageData) {
    let unlockedAny = false;
    
    ACHIEVEMENTS.forEach(ach => {
        if (!gameData.achievements.includes(ach.id)) {
            // 特殊检查：有些成就需要组合状态（比如 alpha_omega）
            if (ach.id === 'alpha_omega') {
                if (!gameData.stats.visitedPages) gameData.stats.visitedPages = [];
                if (pageData && (pageData.page === 1 || pageData.page === 410)) {
                    if(!gameData.stats.visitedPages.includes(pageData.page)) 
                        gameData.stats.visitedPages.push(pageData.page);
                }
                if (gameData.stats.visitedPages && 
                    gameData.stats.visitedPages.includes(1) && 
                    gameData.stats.visitedPages.includes(410)) {
                        unlockAchievement(ach); unlockedAny = true;
                }
            } else {
                // 标准检查
                if (ach.condition(gameData)) {
                    unlockAchievement(ach);
                    unlockedAny = true;
                }
            }
        }
    });
    
    if(unlockedAny) saveGame();
}

/**
 * 解锁指定成就
 * 更新游戏数据，增加 XP，并显示通知
 * 
 * @param {Object} ach 成就对象
 */
function unlockAchievement(ach) {
    gameData.achievements.push(ach.id);
    addXP(ach.xp);
    showToast(`🏆 解锁成就：${ach.name}`);
}

/**
 * 渲染成就列表
 * 生成成就面板的 HTML 内容，区分已解锁和未解锁状态
 */
function renderAchievements() {
    const list = document.getElementById('achievementList');
    if (!list) return; // 可能在初始化前
    
    list.innerHTML = ACHIEVEMENTS.map(ach => {
        const isUnlocked = gameData.achievements.includes(ach.id);
        return `
            <div class="ach-card ${isUnlocked ? 'unlocked' : 'locked'}">
                <div class="ach-icon">${ach.icon}</div>
                <div class="ach-info">
                    <h4>${ach.name}</h4>
                    <div class="ach-desc">${ach.desc}</div>
                    <div class="ach-reward">奖励: ${ach.xp} XP</div>
                    ${isUnlocked ? '<div style="position:absolute;top:10px;right:10px;color:var(--gold)">✓</div>' : ''}
                </div>
            </div>
        `;
    }).join('');
}

/**
 * 创建背景星空
 * 生成 100 个随机位置、大小和闪烁动画的星星
 */
function createStars() {
    const container = document.getElementById('stars');
    for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = star.style.height = (Math.random() * 2 + 1) + 'px';
        star.style.animationDelay = Math.random() * 3 + 's';
        star.style.animationDuration = (Math.random() * 2 + 2) + 's';
        container.appendChild(star);
    }
}

// ============================================================
// 书名编解码（支持1-25字符，真正双向可逆）
// ============================================================

/**
 * 数字 → 书名（均匀长度分布版）
 * 将大整数转换为 1-25 位的 29 进制字符串
 * 
 * @param {BigInt} num 输入的大整数
 * @returns {string} 书名字符串
 */
function numToTitle(num) {
    if (num < 0n) num = -num;
    num = num % UNIFORM_TITLE_SPACE;
    
    // 提取长度索引和内容
    const lengthIndex = num / CONTENT_SPACE_PER_LENGTH;
    const contentNum = num % CONTENT_SPACE_PER_LENGTH;
    
    // 长度 = 1-25
    const len = Number(lengthIndex % 25n) + 1;
    
    // 将 contentNum 转为 len 位的 29 进制字符
    let chars = [];
    let temp = contentNum;
    for (let i = 0; i < len; i++) {
        chars.push(CHARS[Number(temp % 29n)]);
        temp = temp / 29n;
    }
    
    return chars.reverse().join('') || 'a';
}

/**
 * 书名 → 数字（均匀长度分布版）
 * 将书名字符串转换为大整数坐标
 * 
 * @param {string} title 书名字符串
 * @returns {BigInt} 大整数坐标
 */
function titleToNum(title) {
    title = title.toLowerCase().replace(/[^a-z ,.]/g, '');
    if (title.length === 0) title = 'a';
    if (title.length > 25) title = title.substring(0, 25);
    
    const len = title.length;
    const lengthIndex = BigInt(len - 1);  // 0-24
    
    // 编码书名内容为 29 进制数
    let contentNum = 0n;
    for (let i = 0; i < len; i++) {
        const idx = CHARS.indexOf(title[i]);
        contentNum = contentNum * 29n + BigInt(idx >= 0 ? idx : 0);
    }
    
    // 组合：长度索引 * 内容空间 + 内容
    return lengthIndex * CONTENT_SPACE_PER_LENGTH + contentNum;
}

function generateTitle(hex, w, s, v) {
    return getDisplayTitle(hex, w, s, v);
}

// ============================================================
// 进度显示
// ============================================================
function showProgress(text, detail = '') {
    document.getElementById('progressOverlay').style.display = 'flex';
    document.getElementById('progressText').textContent = text;
    document.getElementById('progressDetail').textContent = detail;
    document.getElementById('progressFill').style.width = '0%';
}

function updateProgress(percent, detail = '') {
    document.getElementById('progressFill').style.width = percent + '%';
    if (detail) document.getElementById('progressDetail').textContent = detail;
}

function hideProgress() {
    document.getElementById('progressOverlay').style.display = 'none';
}

// ============================================================
// BigInt 转换
// ============================================================
async function pageToBigInt(text) {
    let result = 0n;
    const step = Math.floor(PAGE_LEN / 25);
    for (let i = 0; i < text.length; i++) {
        const idx = CHARS.indexOf(text[i]);
        result = result * BASE + BigInt(idx >= 0 ? idx : 0);
        if (i % step === 0) {
            updateProgress(Math.floor(i / PAGE_LEN * 45), `编码: ${i}/${PAGE_LEN}`);
            await new Promise(r => setTimeout(r, 0));
        }
    }
    return result;
}

async function bigIntToPage(num, startPct = 50) {
    if (num < 0n) num = -num;
    let chars = [];
    const step = Math.floor(PAGE_LEN / 25);
    let cnt = 0;
    while (num > 0n && chars.length < PAGE_LEN) {
        chars.push(CHARS[Number(num % BASE)]);
        num = num / BASE;
        cnt++;
        if (cnt % step === 0) {
            updateProgress(startPct + Math.floor(cnt / PAGE_LEN * 45), `解码: ${cnt}/${PAGE_LEN}`);
            await new Promise(r => setTimeout(r, 0));
        }
    }
    while (chars.length < PAGE_LEN) chars.push(CHARS[0]);
    return chars.reverse().join('');
}

// ============================================================
// 多模态编码系统 (Multi-Encoding System) - 完整修复版
// ============================================================

// ============================================================
// 书名模式系统
// ============================================================

const SINGLE_TITLE_SPACE = UNIFORM_TITLE_SPACE;  // 25n * 29n ** 25n

// 页面内容空间大小（固定）
const PAGE_SPACE = 29n ** 3200n; // 约 10^4677

/**
 * 书名模式配置
 * 定义不同的书名分布策略
 */
const TITLE_MODES = {
    'single': {
        name: '统一书名',
        count: 1,
        titleSpace: SINGLE_TITLE_SPACE,
        getIndex: (w, s, v) => 0,  // 所有位置返回同一个索引
        description: '整个六边形内 640 本书共享同一个书名'
    },
    'wall': {
        name: '每墙不同',
        count: 4,
        titleSpace: SINGLE_TITLE_SPACE ** 4n,
        getIndex: (w, s, v) => w - 1,  // 0-3
        description: '每面墙有独立书名，同一面墙的 160 本书共享书名'
    },
    'wall-shelf': {
        name: '每墙每架不同',
        count: 20,
        titleSpace: SINGLE_TITLE_SPACE ** 20n,
        getIndex: (w, s, v) => (w - 1) * 5 + (s - 1),  // 0-19
        description: '每面墙的每一架有独立书名，同一架的 32 本书共享书名'
    },
    'full': {
        name: '每本不同',
        count: 640,
        titleSpace: SINGLE_TITLE_SPACE ** 640n,
        getIndex: (w, s, v) => (w - 1) * 160 + (s - 1) * 32 + (v - 1),  // 0-639
        description: '每本书都有独立书名，完全随机'
    },
    'mask-keep': {
        name: '掩码(保长度)',
        count: 1,
        titleSpace: SINGLE_TITLE_SPACE,
        getIndex: (w, s, v) => 0,
        description: '存储种子书名，通过仿射变换派生，书名长度保持不变'
    },
    'mask-vary': {
        name: '掩码(变长度)',
        count: 1,
        titleSpace: SINGLE_TITLE_SPACE,
        getIndex: (w, s, v) => 0,
        description: '存储种子书名，通过变换派生，书名内容和长度都剧烈变化'
    }
};

// 从 localStorage 读取书名模式，默认为 'wall-shelf'
if (!state.titleMode) {
    const savedTitleMode = localStorage.getItem('babelTitleMode');
    state.titleMode = (savedTitleMode && TITLE_MODES[savedTitleMode]) ? savedTitleMode : 'wall-shelf';
}

/**
 * 获取当前模式的书名空间大小
 * @returns {BigInt}
 */
function getCurrentTitleSpace() {
    return TITLE_MODES[state.titleMode]?.titleSpace || SINGLE_TITLE_SPACE;
}

// ============================================================
// 多书名编解码核心函数
// ============================================================

/**
 * 从完整数值中提取指定位置的书名
 * 
 * @param {BigInt} fullNum 完整的大整数坐标
 * @param {number} index 书名索引
 * @param {string} mode 书名模式
 * @returns {BigInt} 该位置的书名数值
 */
function getTitleAt(fullNum, index, mode) {
    const modeConfig = TITLE_MODES[mode];
    if (!modeConfig || modeConfig.count === 1) {
        // 单书名模式或掩码模式
        const titleSpace = getCurrentTitleSpace();
        return (fullNum / PAGE_SPACE) % titleSpace;
    }
    
    // 多书名模式：书名按顺序排列在高位
    // fullNum = title[0] * (SINGLE^(n-1) * PAGE) + title[1] * (SINGLE^(n-2) * PAGE) + ... + content
    const count = modeConfig.count;
    const titlesNum = fullNum / PAGE_SPACE;
    
    // 从高位到低位，index=0 是最高位
    let remaining = titlesNum;
    for (let i = 0; i < index; i++) {
        remaining = remaining % (SINGLE_TITLE_SPACE ** BigInt(count - i - 1));
    }
    
    if (index < count - 1) {
        return remaining / (SINGLE_TITLE_SPACE ** BigInt(count - index - 1));
    } else {
        return remaining % SINGLE_TITLE_SPACE;
    }
}

/**
 * 设置指定位置的书名，返回新的完整数值
 * 
 * @param {BigInt} fullNum 原始完整数值
 * @param {number} index 要修改的书名索引
 * @param {BigInt} newTitleNum 新的书名数值
 * @param {string} mode 书名模式
 * @returns {BigInt} 新的完整数值
 */
function setTitleAt(fullNum, index, newTitleNum, mode) {
    const modeConfig = TITLE_MODES[mode];
    const contentNum = fullNum % PAGE_SPACE;
    
    if (!modeConfig || modeConfig.count === 1) {
        // 单书名模式
        return newTitleNum * PAGE_SPACE + contentNum;
    }
    
    // 多书名模式：需要提取所有书名，修改指定的一个，再组合
    const count = modeConfig.count;
    const titles = [];
    
    for (let i = 0; i < count; i++) {
        titles.push(getTitleAt(fullNum, i, mode));
    }
    
    titles[index] = newTitleNum % SINGLE_TITLE_SPACE;
    
    // 重新组合
    let titlesNum = 0n;
    for (let i = 0; i < count; i++) {
        titlesNum = titlesNum * SINGLE_TITLE_SPACE + titles[i];
    }
    
    return titlesNum * PAGE_SPACE + contentNum;
}

// 生成所有位置的随机书名，返回完整的 titlesNum
function generateRandomTitles(mode, rng) {
    const modeConfig = TITLE_MODES[mode];
    const count = modeConfig?.count || 1;
    
    let titlesNum = 0n;
    for (let i = 0; i < count; i++) {
        // 生成随机书名
        const titleLen = 1 + Math.floor(rng() * 25);
        let title = '';
        for (let j = 0; j < titleLen; j++) {
            title += CHARS[Math.floor(rng() * 29)];
        }
        title = title.trim().replace(/^[,.\s]+|[,.\s]+$/g, '') || 'a';
        
        const titleNum = titleToNum(title);
        titlesNum = titlesNum * SINGLE_TITLE_SPACE + titleNum;
    }
    
    return titlesNum;
}

// ============================================================
/**
 * 混沌书名掩码系统 (V4 终极版)
 * 使用仿射变换 (Affine Transformation) 和 HMAC 算法
 * 实现"位置决定内容"的特性，确保每个位置的书名看起来都是随机但确定的。
 */

/**
 * 扩展欧几里得算法求模逆元
 * 用于解密过程，还原被仿射变换混淆的数值
 * 
 * @param {BigInt} a 数值
 * @param {BigInt} m 模数
 * @returns {BigInt} a 在模 m 下的逆元
 */
function modInverse(a, m) {
    let [old_r, r] = [m, a];
    let [old_s, s] = [0n, 1n];
    while (r !== 0n) {
        const q = old_r / r;
        [old_r, r] = [r, old_r - q * r];
        [old_s, s] = [s, old_s - q * s];
    }
    if (old_r !== 1n) throw new Error("Inverse not found");
    return ((old_s % m) + m) % m;
}

// ============================================================
// 掩码模式 A：保持长度（均匀分布版）
// ============================================================

/**
 * 生成基于位置的仿射变换参数 (保持长度模式)
 * 
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @param {number} len 书名长度
 * @returns {Object} { m: 乘数, a: 加数, space: 模空间 }
 */
function getPositionalParamsKeep(w, s, v, len) {
    const seedStr = `BABEL_KEEP_V2|${w}|${s}|${v}|${len}`;
    const seedHash = hashStr(seedStr); 
    const rng = mulberry32(seedHash);
    
    // 在内容空间内变换（不是 29^len，而是完整的 CONTENT_SPACE_PER_LENGTH）
    // 但实际有效内容只占 29^len，所以我们在 29^len 内变换
    const effectiveSpace = 29n ** BigInt(len);
    
    let adder = 0n;
    for (let i = 0; i < 8; i++) {
        adder = (adder << 32n) | BigInt(Math.floor(rng() * 4294967296));
    }
    adder = adder % effectiveSpace;
    
    let mult = 0n;
    for (let i = 0; i < 8; i++) {
        mult = (mult << 32n) | BigInt(Math.floor(rng() * 4294967296));
    }
    mult = mult % effectiveSpace;
    while (mult % 29n === 0n || mult <= 1n) {
        mult = (mult + 1n) % effectiveSpace;
        if (mult <= 1n) mult = 2n;
    }
    
    return { m: mult, a: adder, space: effectiveSpace };
}

/**
 * 应用掩码变换：将种子书名映射为当前位置的显示书名
 * 保持书名长度不变
 * 
 * @param {BigInt} titleNum 原始书名数值
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @returns {BigInt} 变换后的书名数值
 */
function transformTitleByMaskKeep(titleNum, w, s, v) {
    if (titleNum < 0n) titleNum = -titleNum;
    titleNum = titleNum % UNIFORM_TITLE_SPACE;
    
    // 提取长度和内容
    const lengthIndex = titleNum / CONTENT_SPACE_PER_LENGTH;
    const contentNum = titleNum % CONTENT_SPACE_PER_LENGTH;
    const len = Number(lengthIndex % 25n) + 1;
    
    // 有效内容空间是 29^len
    const effectiveSpace = 29n ** BigInt(len);
    const relativeNum = contentNum % effectiveSpace;
    
    // 仿射变换
    const { m, a, space } = getPositionalParamsKeep(w, s, v, len);
    const transformedRelative = (relativeNum * m + a) % space;
    
    // 重新组合：保持相同长度索引
    return lengthIndex * CONTENT_SPACE_PER_LENGTH + transformedRelative;
}

/**
 * 逆向掩码变换：将显示书名还原为种子书名
 * 
 * @param {BigInt} displayTitleNum 显示的书名数值
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @returns {BigInt} 原始书名数值
 */
function inverseTitleByMaskKeep(displayTitleNum, w, s, v) {
    if (displayTitleNum < 0n) displayTitleNum = -displayTitleNum;
    displayTitleNum = displayTitleNum % UNIFORM_TITLE_SPACE;
    
    const lengthIndex = displayTitleNum / CONTENT_SPACE_PER_LENGTH;
    const contentNum = displayTitleNum % CONTENT_SPACE_PER_LENGTH;
    const len = Number(lengthIndex % 25n) + 1;
    
    const effectiveSpace = 29n ** BigInt(len);
    const transformedRelative = contentNum % effectiveSpace;
    
    const { m, a, space } = getPositionalParamsKeep(w, s, v, len);
    
    let temp = transformedRelative - a;
    while (temp < 0n) temp += space;
    
    const mInv = modInverse(m, space);
    const originalRelative = (temp * mInv) % space;
    
    return lengthIndex * CONTENT_SPACE_PER_LENGTH + originalRelative;
}

// ============================================================
// 掩码模式 B：长度也变化（均匀分布版）
// ============================================================

/**
 * 获取基于位置的长度偏移量
 * @returns {number} 0-24 的偏移值
 */
function getLengthShift(w, s, v) {
    const seedStr = `LEN_SHIFT_V3|${w}|${s}|${v}`;
    const seedHash = hashStr(seedStr);
    return seedHash % 25;
}

/**
 * 生成基于位置的仿射变换参数 (变长度模式)
 * 
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @param {number} len 书名长度
 * @returns {Object} { m: 乘数, a: 加数, space: 模空间 }
 */
function getPositionalParamsVary(w, s, v, len) {
    const seedStr = `BABEL_VARY_V2|${w}|${s}|${v}|${len}`;
    const seedHash = hashStr(seedStr); 
    const rng = mulberry32(seedHash);
    
    const effectiveSpace = 29n ** BigInt(len);
    
    let adder = 0n;
    for (let i = 0; i < 8; i++) {
        adder = (adder << 32n) | BigInt(Math.floor(rng() * 4294967296));
    }
    adder = adder % effectiveSpace;
    
    let mult = 0n;
    for (let i = 0; i < 8; i++) {
        mult = (mult << 32n) | BigInt(Math.floor(rng() * 4294967296));
    }
    mult = mult % effectiveSpace;
    while (mult % 29n === 0n || mult <= 1n) {
        mult = (mult + 1n) % effectiveSpace;
        if (mult <= 1n) mult = 2n;
    }
    
    return { m: mult, a: adder, space: effectiveSpace };
}

/**
 * 应用掩码变换：将种子书名映射为当前位置的显示书名
 * 同时改变书名的内容和长度
 * 
 * @param {BigInt} titleNum 原始书名数值
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @returns {BigInt} 变换后的书名数值
 */
function transformTitleByMaskVary(titleNum, w, s, v) {
    if (titleNum < 0n) titleNum = -titleNum;
    titleNum = titleNum % UNIFORM_TITLE_SPACE;
    
    // 提取原始长度和内容
    const originalLengthIndex = titleNum / CONTENT_SPACE_PER_LENGTH;
    const contentNum = titleNum % CONTENT_SPACE_PER_LENGTH;
    const originalLen = Number(originalLengthIndex % 25n) + 1;
    
    // 长度偏移
    const shift = getLengthShift(w, s, v);
    const displayLen = ((originalLen - 1 + shift) % 25) + 1;
    const displayLengthIndex = BigInt(displayLen - 1);
    
    // 内容映射
    const originalSpace = 29n ** BigInt(originalLen);
    const displaySpace = 29n ** BigInt(displayLen);
    const relativeNum = contentNum % originalSpace;
    
    let mappedRelative;
    if (displaySpace >= originalSpace) {
        // 扩展映射
        const factor = displaySpace / originalSpace;
        mappedRelative = (relativeNum * factor + relativeNum) % displaySpace;
    } else {
        // 压缩映射
        mappedRelative = relativeNum % displaySpace;
    }
    
    // 仿射变换
    const { m, a, space } = getPositionalParamsVary(w, s, v, displayLen);
    const transformedRelative = (mappedRelative * m + a) % space;
    
    return displayLengthIndex * CONTENT_SPACE_PER_LENGTH + transformedRelative;
}

/**
 * 逆向掩码变换：将显示书名还原为种子书名
 * 
 * @param {BigInt} displayTitleNum 显示的书名数值
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @returns {BigInt} 原始书名数值
 */
function inverseTitleByMaskVary(displayTitleNum, w, s, v) {
    if (displayTitleNum < 0n) displayTitleNum = -displayTitleNum;
    displayTitleNum = displayTitleNum % UNIFORM_TITLE_SPACE;
    
    // 提取显示长度和内容
    const displayLengthIndex = displayTitleNum / CONTENT_SPACE_PER_LENGTH;
    const contentNum = displayTitleNum % CONTENT_SPACE_PER_LENGTH;
    const displayLen = Number(displayLengthIndex % 25n) + 1;
    
    const displaySpace = 29n ** BigInt(displayLen);
    const transformedRelative = contentNum % displaySpace;
    
    // 逆仿射变换
    const { m, a, space } = getPositionalParamsVary(w, s, v, displayLen);
    let temp = transformedRelative - a;
    while (temp < 0n) temp += space;
    const mInv = modInverse(m, space);
    const mappedRelative = (temp * mInv) % space;
    
    // 逆长度偏移
    const shift = getLengthShift(w, s, v);
    const originalLen = ((displayLen - 1 - shift + 25) % 25) + 1;
    const originalLengthIndex = BigInt(originalLen - 1);
    
    // 逆内容映射
    const originalSpace = 29n ** BigInt(originalLen);
    
    let relativeNum;
    if (displaySpace >= originalSpace) {
        relativeNum = mappedRelative % originalSpace;
    } else {
        const factor = originalSpace / displaySpace;
        relativeNum = (mappedRelative * factor + mappedRelative) % originalSpace;
    }
    
    return originalLengthIndex * CONTENT_SPACE_PER_LENGTH + relativeNum;
}

// ============================================================
// 统一的长度区间函数（新编码方案）
// ============================================================

/**
 * 获取书名长度（新编码：直接从高位读取）
 * @param {BigInt} num 书名数值
 * @returns {number} 书名长度 (1-25)
 */
function getLengthFromNum(num) {
    if (num < 0n) num = -num;
    num = num % UNIFORM_TITLE_SPACE;
    const lengthIndex = num / CONTENT_SPACE_PER_LENGTH;
    return Number(lengthIndex % 25n) + 1;
}

/**
 * 获取长度区间的起始偏移量
 * @param {number} len 书名长度
 * @returns {BigInt} 
 */
function getLengthOffset(len) {
    if (len < 1) len = 1;
    if (len > 25) len = 25;
    return BigInt(len - 1) * CONTENT_SPACE_PER_LENGTH;
}

/**
 * 获取该长度区间的大小
 * (始终是 CONTENT_SPACE_PER_LENGTH，保持均匀分布)
 * @returns {BigInt}
 */
function getLengthRangeSize(len) {
    return CONTENT_SPACE_PER_LENGTH;
}

// ============================================================
// 统一坐标编解码
// ============================================================

/**
 * 从完整坐标分离出内容部分
 * @param {BigInt} fullNum 完整坐标
 * @returns {Object} { contentNum }
 */
function splitCoordinate(fullNum) {
    if (fullNum < 0n) fullNum = -fullNum;
    const contentNum = fullNum % PAGE_SPACE;
    return { contentNum };
}

/**
 * 合并书名和内容数值为完整坐标
 * @param {BigInt} titlesNum 书名部分数值
 * @param {BigInt} contentNum 内容部分数值
 * @returns {BigInt} 完整坐标
 */
function combineCoordinate(titlesNum, contentNum) {
    if (titlesNum < 0n) titlesNum = -titlesNum;
    if (contentNum < 0n) contentNum = -contentNum;
    contentNum = contentNum % PAGE_SPACE;
    return titlesNum * PAGE_SPACE + contentNum;
}

/**
 * 从 hex 字符串获取内容数值
 * @param {string} hex 坐标字符串
 * @returns {BigInt} 内容数值
 */
function getContentNumFromHex(hex) {
    const fullNum = fromHex(hex);
    const { contentNum } = splitCoordinate(fullNum);
    return contentNum;
}

/**
 * 获取在特定位置显示的书名
 * 根据当前模式 (Title Mode) 计算显示书名
 * 
 * @param {string} hex 六边形坐标字符串
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @returns {string} 显示的书名
 */
function getDisplayTitle(hex, w, s, v) {
    const fullNum = fromHex(hex);
    const mode = state.titleMode;
    const modeConfig = TITLE_MODES[mode];
    
    if (mode === 'mask-keep') {
        // 掩码模式（保长度）
        const seedTitleNum = (fullNum / PAGE_SPACE) % SINGLE_TITLE_SPACE;
        const displayTitleNum = transformTitleByMaskKeep(seedTitleNum, w, s, v);
        return numToTitle(displayTitleNum);
    }
    
    if (mode === 'mask-vary') {
        // 掩码模式（变长度）
        const seedTitleNum = (fullNum / PAGE_SPACE) % SINGLE_TITLE_SPACE;
        const displayTitleNum = transformTitleByMaskVary(seedTitleNum, w, s, v);
        return numToTitle(displayTitleNum);
    }
    
    // 其他模式：直接获取对应位置的书名
    const index = modeConfig.getIndex(w, s, v);
    const titleNum = getTitleAt(fullNum, index, mode);
    return numToTitle(titleNum);
}

/**
 * 根据内容和书名数组创建完整 hex
 */
function createFullHexWithTitles(contentNum, titlesNum) {
    const fullNum = combineCoordinate(titlesNum, contentNum);
    return toHex(fullNum);
}

/**
 * 创建带有指定位置书名的完整 hex（用于搜索）
 * 通过逆向运算计算出满足特定位置显示特定书名的种子坐标
 */
function createFullHexForSearch(contentNum, displayTitle, w, s, v) {
    const mode = state.titleMode;
    const modeConfig = TITLE_MODES[mode];
    const displayTitleNum = titleToNum(displayTitle);
    
    if (mode === 'mask-keep') {
        const seedTitleNum = inverseTitleByMaskKeep(displayTitleNum, w, s, v);
        return createFullHexWithTitles(contentNum, seedTitleNum);
    }
    
    if (mode === 'mask-vary') {
        const seedTitleNum = inverseTitleByMaskVary(displayTitleNum, w, s, v);
        return createFullHexWithTitles(contentNum, seedTitleNum);
    }
    
    // 其他模式：生成随机书名填充其他位置
    const rng = mulberry32(Math.floor(Math.random() * 0xFFFFFFFF));
    let titlesNum = generateRandomTitles(mode, rng);
    
    const index = modeConfig.getIndex(w, s, v);
    const count = modeConfig.count;
    
    const titles = [];
    let temp = titlesNum;
    for (let i = count - 1; i >= 0; i--) {
        titles[i] = temp % SINGLE_TITLE_SPACE;
        temp = temp / SINGLE_TITLE_SPACE;
    }
    titles[index] = displayTitleNum;
    
    titlesNum = 0n;
    for (let i = 0; i < count; i++) {
        titlesNum = titlesNum * SINGLE_TITLE_SPACE + titles[i];
    }
    
    return createFullHexWithTitles(contentNum, titlesNum);
}

/**
 * 编码引擎定义
 * 包含多种大整数压缩编码方案
 * 
 * 核心接口：
 * - size: 字符集大小 (BigInt)
 * - toStr(n): BigInt -> String
 * - fromStr(s): String -> BigInt
 */
const ENCODINGS = {
    /**
     * Base36: 0-9, a-z
     * 传统编码，兼容性最好，但结果最长
     */
    'b36': {
        size: 36n,
        toStr: (n) => n.toString(36),
        fromStr: (s) => {
            let res = 0n;
            const digits = '0123456789abcdefghijklmnopqrstuvwxyz';
            for (let c of s.toLowerCase()) {
                const val = BigInt(digits.indexOf(c));
                if (val >= 0n) res = res * 36n + val;
            }
            return res;
        }
    },

    /**
     * Base85 (修正版)
     * ASCII 可打印字符集，比 Base64 更紧凑
     */
    'b85': {
        // 原来的字符集 (84个字符)
        chars: '!#$%()*+,.0123456789:;=?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^abcdefghijklmnopqrstuvwxyz{|}~',
        
        // 【核心修复】size 必须等于 chars.length
        // 之前写死 85n 导致了越界 undefined 错误
        get size() { return BigInt(this.chars.length); }, 
        
        toStr: function(n) {
            if (n === 0n) return this.chars[0];
            let s = '';
            const len = this.size;
            while (n > 0n) {
                // 现在的余数永远不会超过 chars 的最大下标
                s = this.chars[Number(n % len)] + s;
                n = n / len;
            }
            return s;
        },
        fromStr: function(s) {
            let res = 0n;
            const len = this.size;
            for (let c of s) {
                const idx = this.chars.indexOf(c);
                // 增加安全检查，防止非法字符导致数据污染
                if (idx !== -1) {
                    res = res * len + BigInt(idx);
                }
            }
            return res;
        }
    },

    /**
     * Base16k: 常用汉字
     * 使用 Unicode 0x4E00 起始的 16384 个汉字
     * 压缩率高，推荐使用
     */
    'b16k': {
        start: 0x4E00, size: 16384n,
        toStr: function(n) {
            if (n === 0n) return String.fromCodePoint(this.start);
            let s = '';
            while (n > 0n) {
                s = String.fromCodePoint(this.start + Number(n % this.size)) + s;
                n = n / this.size;
            }
            return s;
        },
        fromStr: function(s) {
            let res = 0n;
            for (let c of s) {
                const code = c.codePointAt(0);
                if (code >= this.start && code < this.start + Number(this.size)) {
                    res = res * this.size + BigInt(code - this.start);
                }
            }
            return res;
        }
    },

    /**
     * Base20k: 基本汉字全集
     * 覆盖 Unicode CJK 基本平面
     */
    'b20k': {
        start: 0x4E00, size: 20902n, 
        toStr: function(n) { // 复用逻辑，只是 size 变了
            if (n === 0n) return String.fromCodePoint(this.start);
            let s = '';
            while (n > 0n) {
                s = String.fromCodePoint(this.start + Number(n % this.size)) + s;
                n = n / this.size;
            }
            return s;
        },
        fromStr: function(s) {
            let res = 0n;
            for (let c of s) {
                const code = c.codePointAt(0);
                if (code >= this.start && code < this.start + Number(this.size)) {
                    res = res * this.size + BigInt(code - this.start);
                }
            }
            return res;
        }
    },

    /**
     * Base27k: 基本 + 扩展A区
     * 进一步扩充字符集
     */
    'b27k': {
        size: 27494n,
        toStr: function(n) {
            if (n === 0n) return String.fromCodePoint(0x4E00);
            let s = '';
            while (n > 0n) {
                const r = Number(n % this.size);
                if (r < 6592) s = String.fromCodePoint(0x3400 + r) + s;
                else s = String.fromCodePoint(0x4E00 + (r - 6592)) + s;
                n = n / this.size;
            }
            return s;
        },
        fromStr: function(s) {
            let res = 0n;
            for (let c of s) {
                const code = c.codePointAt(0);
                let val = -1;
                if (code >= 0x3400 && code <= 0x4DBF) val = code - 0x3400;
                else if (code >= 0x4E00 && code <= 0x9FA5) val = code - 0x4E00 + 6592;
                if (val !== -1) res = res * this.size + BigInt(val);
            }
            return res;
        }
    },
    
    /**
     * Base65k: BMP 平面大字符集
     * 排除代理对区域，使用约 65000 个字符
     * 压缩率极高
     */
    'b65k': {
        size: 65536n,
        toStr: function(n) {
            if (n === 0n) return String.fromCodePoint(0x4E00);
            let s = '';
            while (n > 0n) {
                let r = Number(n % this.size);
                // 跳过代理对区域 (0xD800-0xDFFF)
                if (r >= 0xD800) r += 0x800;
                s = String.fromCodePoint(r) + s;
                n = n / this.size;
            }
            return s;
        },
        fromStr: function(s) {
            let res = 0n;
            for (let c of [...s]) {
                let code = c.codePointAt(0);
                if (code >= 0xE000) code -= 0x800;
                if (code >= 0 && code < 65536 + 0x800) {
                    res = res * this.size + BigInt(Math.min(code, 65535));
                }
            }
            return res;
        }
    },

    /**
     * Base1.1M: 全 Unicode
     * 理论极限压缩，包含 Emoji 等所有字符
     */
    'b11m': {
        size: 1112064n, gapStart: 0xD800, gapSize: 0x800,
        toStr: function(n) {
            if (n === 0n) return '!';
            let s = '';
            while (n > 0n) {
                let r = Number(n % this.size);
                if (r >= this.gapStart) r += this.gapSize;
                try { s = String.fromCodePoint(r) + s; } catch(e) { s = '?' + s; }
                n = n / this.size;
            }
            return s;
        },
        fromStr: function(s) {
            let res = 0n;
            for (let c of [...s]) { 
                let code = c.codePointAt(0);
                if (code >= 0xE000) code -= this.gapSize;
                if (code >= 0 && code < Number(this.size)) res = res * this.size + BigInt(code);
            }
            return res;
        }
    }
};

// 从 localStorage 读取编码模式，默认为 'b16k'
if (!state.encodingMode) {
    const savedEncodingMode = localStorage.getItem('babelEncodingMode');
    state.encodingMode = (savedEncodingMode && ENCODINGS[savedEncodingMode]) ? savedEncodingMode : 'b16k';
}

/**
 * 通用转换入口 (大整数 -> 字符串)
 * 根据当前设置的编码模式，将大整数转换为压缩字符串
 * 并附带书名模式标记
 * 
 * @param {BigInt} bigInt 坐标数值
 * @returns {string} 格式化的坐标字符串 (如 b16k.ws:...)
 */
function toHex(bigInt) {
    if (!ENCODINGS[state.encodingMode]) state.encodingMode = 'b16k';
    const encoder = ENCODINGS[state.encodingMode];
    let neg = bigInt < 0n;
    if (neg) bigInt = -bigInt;
    const str = encoder.toStr(bigInt);
    
    // 书名模式缩写
    const titleModeShort = {
        'single': 's',
        'wall': 'w', 
        'wall-shelf': 'ws',
        'full': 'f',
        'mask-keep': 'mk',
        'mask-vary': 'mv'
    };
    const modeTag = titleModeShort[state.titleMode] || 's';
    
    // 格式: 编码模式.书名模式:内容
    // 例如: b16k.ws:一二三四五
    const prefix = state.encodingMode + '.' + modeTag + ':';
    return neg ? prefix + '－' + str : prefix + str;
}

/**
 * 通用解析入口 (字符串 -> 大整数)
 * 自动识别字符串中的编码模式和书名模式标记
 * 
 * @param {string} str 坐标字符串
 * @returns {Object} { value: BigInt, detectedTitleMode: string | null }
 */
function fromHexWithMode(str) {
    if (!str) return { value: 0n, detectedTitleMode: null };
    
    let mode = 'b16k';
    let titleMode = null;
    let body = str;
    
    // 新格式: 编码.书名模式:内容 (如 b16k.ws:一二三)
    const newMatch = str.match(/^([a-z0-9]+)\.([a-z]+):(.+)$/);
    if (newMatch && ENCODINGS[newMatch[1]]) {
        mode = newMatch[1];
        const titleModeShort = newMatch[2];
        body = newMatch[3];
        
        // 解析书名模式缩写
        const shortToFull = {
            's': 'single',
            'w': 'wall',
            'ws': 'wall-shelf',
            'f': 'full',
            'mk': 'mask-keep',
            'mv': 'mask-vary',
            'm': 'mask-keep'
        };
        titleMode = shortToFull[titleModeShort] || null;
    } else {
        // 旧格式: 编码:内容 (如 b16k:一二三)
        const oldMatch = str.match(/^([a-z0-9]+):(.+)$/);
        if (oldMatch && ENCODINGS[oldMatch[1]]) {
            mode = oldMatch[1];
            body = oldMatch[2];
        }
    }
    
    let neg = false;
    if (body.startsWith('－') || body.startsWith('-') || body.startsWith('/')) {
        neg = true;
        body = [...body].slice(1).join('');
    }
    const val = ENCODINGS[mode].fromStr(body);
    return { value: neg ? -val : val, detectedTitleMode: titleMode };
}

/**
 * 简化的解析入口，只返回数值
 * 兼容旧代码
 */
function fromHex(str) {
    return fromHexWithMode(str).value;
}

// ============================================================
// ============================================================
// 位置哈希与随机数生成
// ============================================================

/**
 * 字符串哈希函数 (djb2 变体)
 * 用于生成确定性的种子值
 * 
 * @param {string} s 输入字符串
 * @returns {number} 32位无符号整数
 */
function hashStr(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) h = Math.imul(31, h) + s.charCodeAt(i) | 0;
    return h >>> 0;
}

/**
 * Mulberry32 伪随机数生成器
 * 即使在不同浏览器上也能产生确定性的随机序列
 * 
 * @param {number} seed 种子
 * @returns {function} 返回 0-1 之间浮点数的函数
 */
function mulberry32(seed) {
    return function() {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    };
}

/**
 * 生成掩码页内容
 * 用于将纯内容坐标映射到视觉上的乱码页
 * 
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @param {number} p 页码
 * @returns {string} 掩码字符串
 */
function generateMaskPage(w, s, v, p) {
    const seed = hashStr(`BABEL|${w}|${s}|${v}|${p}`);
    const rng = mulberry32(seed);
    let page = '';
    for (let i = 0; i < PAGE_LEN; i++) page += CHARS[Math.floor(rng() * 29)];
    return page;
}

/**
 * 页面文本转大整数 (同步版)
 * 用于快速计算，不包含进度条更新
 * 
 * @param {string} text 页面文本
 * @returns {bigint} 对应的数值
 */
function pageToBigIntSync(text) {
    let result = 0n;
    for (let i = 0; i < text.length; i++) {
        const idx = CHARS.indexOf(text[i]);
        result = result * BASE + BigInt(idx >= 0 ? idx : 0);
    }
    return result;
}

/**
 * 大整数转页面文本 (同步版)
 * 
 * @param {bigint} num 数值
 * @returns {string} 页面文本
 */
function bigIntToPageSync(num) {
    if (num < 0n) num = -num;
    let chars = [];
    while (num > 0n && chars.length < PAGE_LEN) {
        chars.push(CHARS[Number(num % BASE)]);
        num = num / BASE;
    }
    while (chars.length < PAGE_LEN) chars.push(CHARS[0]);
    return chars.reverse().join('');
}

/**
 * 获取第一页的内容 (同步版)
 * 用于生成书名预览
 * 
 * @param {string} hex 六边形坐标
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @returns {string} 第一页的内容
 */
function getPage1Sync(hex, w, s, v) {
    const maskPage = generateMaskPage(w, s, v, 1);
    const maskNum = pageToBigIntSync(maskPage);
    const hexNum = fromHex(hex);
    const pageNum = hexNum ^ maskNum;
    return bigIntToPageSync(pageNum);
}

/**
 * 获取书籍标题 (同步版)
 * 
 * @param {string} hex 六边形坐标
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @returns {string} 书籍标题
 */
function getBookTitleSync(hex, w, s, v) {
    return getDisplayTitle(hex, w, s, v);
}

// ============================================================
// 页面生成
// ============================================================

/**
 * 生成指定位置的页面内容
 * 
 * @param {string} hex 六边形坐标字符串
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @param {number} p 页码
 * @returns {string} 页面文本内容
 */
async function generatePage(hex, w, s, v, p) {
    showProgress('正在生成页面...', '准备中');
    
    updateProgress(5, '解析坐标...');
    await new Promise(r => setTimeout(r, 0));
    
    // 从完整坐标中提取内容数值
    const contentNum = getContentNumFromHex(hex);
    
    updateProgress(10, '生成位置掩码...');
    await new Promise(r => setTimeout(r, 0));
    const maskPage = generateMaskPage(w, s, v, p);
    
    updateProgress(15, '编码掩码...');
    const maskNum = await pageToBigInt(maskPage);
    
    updateProgress(50, 'XOR运算...');
    await new Promise(r => setTimeout(r, 0));
    const pageNum = contentNum ^ maskNum;
    
    const content = await bigIntToPage(pageNum, 50);
    
    hideProgress();
    return content;
}

// ============================================================
// 搜索核心逻辑
// ============================================================

/**
 * 搜索函数：返回满足目标内容的基础数值
 * 通过逆向异或运算计算出生成目标页面所需的种子数值
 * 
 * @returns {BigInt} 内容数值 (contentNum)
 */
async function searchForContent(targetPage, w, s, v, p) {
    showProgress('正在搜索...', '构造目标');
    
    updateProgress(5, '编码目标...');
    const targetNum = await pageToBigInt(targetPage);
    
    updateProgress(50, '计算掩码...');
    const maskPage = generateMaskPage(w, s, v, p);
    const maskNum = await pageToBigInt(maskPage);
    
    updateProgress(95, '计算坐标...');
    await new Promise(r => setTimeout(r, 0));
    const contentNum = targetNum ^ maskNum;
    
    hideProgress();
    return contentNum; // 返回内容数值，不是完整hex
}

// ============================================================
// 高级搜索功能
// ============================================================

/**
 * 精确搜索：查找包含目标文本的页面
 * 自动补全空格并随机生成周围内容
 */
/**
 * 精确搜索：查找仅包含搜索词（其余为空格）的页面
 * 
 * @param {string} text 搜索关键词
 * @returns {Promise<Object>} 搜索结果对象
 */
async function findExactMatch(text) {
    let searchText = text;
    
    if (text.length <= PAGE_LEN - 2) {
        if (!searchText.startsWith(' ') && !/^[.,;?!]/.test(searchText)) searchText = ' ' + searchText;
        if (!searchText.endsWith(' ') && !/[.,;?!]$/.test(searchText)) searchText = searchText + ' ';
    }

    const maxIndex = PAGE_LEN - searchText.length;
    const safeMaxIndex = Math.max(0, maxIndex);
    const startIndex = Math.floor(Math.random() * (safeMaxIndex + 1));
    
    const prefix = ' '.repeat(startIndex);
    const suffix = ' '.repeat(Math.max(0, PAGE_LEN - startIndex - searchText.length));
    const targetPage = prefix + searchText + suffix;
    
    const w = Math.floor(Math.random() * WALLS) + 1;
    const s = Math.floor(Math.random() * SHELVES) + 1;
    const v = Math.floor(Math.random() * VOLUMES) + 1;
    const p = Math.floor(Math.random() * PAGES) + 1;
    
    const contentNum = await searchForContent(targetPage, w, s, v, p);
    
    // 生成随机书名
    const rng = mulberry32(Math.floor(Math.random() * 0xFFFFFFFF));
    const titleLen = 1 + Math.floor(rng() * 25);
    let randomTitle = '';
    for (let i = 0; i < titleLen; i++) {
        randomTitle += CHARS[Math.floor(rng() * 29)];
    }
    randomTitle = randomTitle.trim().replace(/^[,.\s]+|[,.\s]+$/g, '') || 'a';
    
    // 使用新的创建函数
    const fullHex = createFullHexForSearch(contentNum, randomTitle, w, s, v);
    
    const verifyContent = await generatePage(fullHex, w, s, v, p);
    const actualPosition = verifyContent.indexOf(searchText);
    const finalPosition = actualPosition >= 0 ? actualPosition : startIndex;
    
    const previewStart = Math.max(0, finalPosition - 20);
    const previewEnd = Math.min(PAGE_LEN, finalPosition + searchText.length + 40);
    let preview = verifyContent.substring(previewStart, previewEnd);
    if (previewStart > 0) preview = '...' + preview;
    if (previewEnd < PAGE_LEN) preview += '...';
    
    return { 
        hex: fullHex, 
        wall: w, shelf: s, volume: v, page: p, 
        preview, 
        text: searchText, 
        position: finalPosition
    };
}

/**
 * 随机搜索：查找包含目标文本的随机页面
 * 目标文本周围填充随机字符
 * 
 * @param {string} text 搜索关键词
 * @returns {Promise<Object>} 搜索结果对象
 */
async function findRandomMatch(text) {
    const searchText = text;
    const maxIndex = PAGE_LEN - searchText.length;
    const startIndex = Math.floor(Math.random() * (maxIndex + 1));
    
    const w = Math.floor(Math.random() * WALLS) + 1;
    const s = Math.floor(Math.random() * SHELVES) + 1;
    const v = Math.floor(Math.random() * VOLUMES) + 1;
    const p = Math.floor(Math.random() * PAGES) + 1;
    
    const rng = mulberry32(Math.floor(Math.random() * 0xFFFFFFFF));
    let targetPage = '';
    
    for (let i = 0; i < startIndex; i++) targetPage += CHARS[Math.floor(rng() * CHARS.length)];
    targetPage += searchText;
    for (let i = startIndex + searchText.length; i < PAGE_LEN; i++) targetPage += CHARS[Math.floor(rng() * CHARS.length)];
    
    const contentNum = await searchForContent(targetPage, w, s, v, p);
    
    const rng2 = mulberry32(Math.floor(Math.random() * 0xFFFFFFFF));
    const titleLen = 1 + Math.floor(rng2() * 25);
    let randomTitle = '';
    for (let i = 0; i < titleLen; i++) {
        randomTitle += CHARS[Math.floor(rng2() * 29)];
    }
    randomTitle = randomTitle.trim().replace(/^[,.\s]+|[,.\s]+$/g, '') || 'a';
    
    const fullHex = createFullHexForSearch(contentNum, randomTitle, w, s, v);
    
    const previewStart = Math.max(0, startIndex - 20);
    const previewEnd = Math.min(PAGE_LEN, startIndex + searchText.length + 40);
    let preview = targetPage.substring(previewStart, previewEnd);
    if (previewStart > 0) preview = '...' + preview;
    if (previewEnd < PAGE_LEN) preview += '...';
    
    return { 
        hex: fullHex,
        wall: w, shelf: s, volume: v, page: p, 
        preview, 
        text: searchText, 
        position: startIndex 
    };
}

/**
 * 书名搜索：查找指定书名的书籍
 * 由于书名与位置绑定，可能需要多次尝试才能找到匹配的书名
 * 
 * @param {string} text 书名关键词
 * @returns {Promise<Object>} 搜索结果对象
 */
async function findTitleMatch(text) {
    let searchText = text;
    if (searchText.length > PAGE_LEN) searchText = searchText.substring(0, PAGE_LEN);
    
    const w = Math.floor(Math.random() * WALLS) + 1;
    const s = Math.floor(Math.random() * SHELVES) + 1;
    const v = Math.floor(Math.random() * VOLUMES) + 1;
    const p = 1;
    
    const rng = mulberry32(Math.floor(Math.random() * 0xFFFFFFFF));
    let targetPage = searchText;
    for (let i = targetPage.length; i < PAGE_LEN; i++) {
        targetPage += CHARS[Math.floor(rng() * 29)];
    }
    
    const contentNum = await searchForContent(targetPage, w, s, v, p);
    
    const rng2 = mulberry32(Math.floor(Math.random() * 0xFFFFFFFF));
    const titleLen = 1 + Math.floor(rng2() * 25);
    let randomTitle = '';
    for (let i = 0; i < titleLen; i++) {
        randomTitle += CHARS[Math.floor(rng2() * 29)];
    }
    randomTitle = randomTitle.trim().replace(/^[,.\s]+|[,.\s]+$/g, '') || 'a';
    
    const fullHex = createFullHexForSearch(contentNum, randomTitle, w, s, v);
    
    return { 
        hex: fullHex,
        wall: w, shelf: s, volume: v, page: p, 
        preview: searchText, 
        text: searchText
    };
}

/**
 * 批量书名搜索
 * 尝试寻找多本具有相同书名的书
 * 
 * @param {string} searchText 书名关键词
 * @param {number} maxResults 最大结果数量
 * @returns {Promise<Array>} 搜索结果数组
 */
async function searchByTitle(searchText, maxResults = 10) {
    searchText = searchText.toLowerCase().replace(/[^a-z ,.]/g, '');
    if (searchText.length === 0) searchText = 'a';
    if (searchText.length > 25) searchText = searchText.substring(0, 25);
    
    showProgress('正在定位书籍...', '计算坐标中');
    const results = [];
    
    let attempts = 0;
    const maxAttempts = maxResults * 10; // 最多尝试次数
    
    while (results.length < maxResults && attempts < maxAttempts) {
        attempts++;
        updateProgress(Math.floor(results.length / maxResults * 100), `正在生成第 ${results.length + 1}/${maxResults} 本`);
        
        const w = Math.floor(Math.random() * WALLS) + 1;
        const s = Math.floor(Math.random() * SHELVES) + 1;
        const v = Math.floor(Math.random() * VOLUMES) + 1;
        
        const rng = mulberry32(Math.floor(Math.random() * 0xFFFFFFFF));
        let randomPage = '';
        for (let j = 0; j < PAGE_LEN; j++) {
            randomPage += CHARS[Math.floor(rng() * 29)];
        }
        
        const contentNum = await searchForContent(randomPage, w, s, v, 1);
        
        // 使用搜索的书名创建坐标
        const fullHex = createFullHexForSearch(contentNum, searchText, w, s, v);
        
        // 验证书名是否正确
        const displayTitle = getDisplayTitle(fullHex, w, s, v);
        
        // 只有书名匹配才加入结果
        if (displayTitle === searchText) {
            results.push({ hex: fullHex, wall: w, shelf: s, volume: v, title: displayTitle, page: 1 });
        }
        // 如果不匹配，继续尝试（不同的 w, s, v 可能会成功）
    }
    
    // 如果尝试很多次还是不够，用已有的结果
    if (results.length < maxResults) {
        console.warn(`书名搜索：尝试 ${attempts} 次，只找到 ${results.length} 个精确匹配`);
    }
    
    hideProgress();
    return results;
}

// ============================================================
// 可读化模式 - 基于英语音系学（Phonotactics）
// ============================================================
/** 英语元音字母 */
const VOWELS = 'aeiou';

/** 包含半元音 Y 的元音集合 */
const VOWELS_Y = 'aeiouy';

/** 
 * 有效的开头辅音簇 (Onset)
 * 英语单词开头可能出现的辅音组合
 */
const VALID_ONSET = new Set([
    'b','c','d','f','g','h','j','k','l','m','n','p','q','r','s','t','v','w','x','y','z',
    'bl','br','ch','cl','cr','dr','dw','fl','fr','gl','gr','gw',
    'pl','pr','qu','sc','sh','sk','sl','sm','sn','sp','st','sw',
    'th','tr','tw','wh','wr','sch','scr','shr','spl','spr','squ','str','thr'
]);

/** 
 * 有效的结尾辅音簇 (Coda)
 * 英语单词结尾可能出现的辅音组合
 */
const VALID_CODA = new Set([
    'b','c','d','f','g','k','l','m','n','p','r','s','t','x','z',
    'ch','ck','ct','ft','gh','lb','ld','lf','lk','ll','lm','ln','lp','ls','lt',
    'mp','nc','nd','ng','nk','ns','nt','pt','rb','rc','rd','rf','rg','rk',
    'rl','rm','rn','rp','rs','rt','rv','sh','sk','sp','ss','st','th','ts','xt',
    'lch','lth','mph','nce','nch','nge','nse','nth','rce','rch','rge','rse','rst','rth',
    'sch','tch','dge','ght'
]);

/** 
 * 高频双字母 (Bigrams)
 * 基于英语语料库统计的常见双字母组合
 */
const COMMON_BIGRAMS = new Set([
    'th','he','in','er','an','re','on','at','en','nd','ti','es','or','te','of',
    'ed','is','it','al','ar','st','to','nt','ng','se','ha','as','ou','io','le',
    've','co','me','de','hi','ri','ro','ic','ne','ea','ra','ce','li','ch','ll',
    'be','ma','si','om','ur','ca','el','ta','la','ns','di','fo','ho','pe','un',
    'no','so','us','ss','tr','op','ot','pr','wa','ol','ad','ge','nc','ee','ly',
    'ac','il','rt','sh','lo','ct','oo','ld','ul','ut','wh','we','wi','wo','am',
    'id','ke','su','em','ow','po','ay','ey','ab','ob','ub','ig','ag','og','up'
]);

/** 
 * 高频三字母 (Trigrams)
 * 基于英语语料库统计的常见三字母组合
 */
const COMMON_TRIGRAMS = new Set([
    'the','and','ing','ion','tio','ent','ati','for','her','ter','hat','tha',
    'ere','ate','his','con','res','ver','all','ons','nce','men','ith','ted',
    'ers','pro','thi','wit','are','ess','not','ive','was','ect','rea','com',
    'eve','per','int','est','sta','cti','ica','ist','ear','ain','one','our',
    'iti','rat','ble','age','out','ght','ave','ine','sto','ant','oun','ome',
    'end','ort','tur','rom','ous','ess','ful','str','pre','han','whi','ove'
]);

/** 
 * 不可能的双字母开头
 * 英语中不存在的单词首部字母组合
 * 用于快速排除生成的无意义单词
 */
const IMPOSSIBLE_START = new Set([
    'bk','bf','bg','bm','bn','bp','bt','bv','bw','bx','bz',
    'cf','cg','cj','cm','cn','cp','cv','cw','cx','cz',
    'df','dg','dj','dk','dl','dm','dn','dp','dt','dv','dx','dz',
    'fj','fk','fm','fn','fp','fv','fw','fx','fz',
    'gd','gf','gj','gk','gm','gp','gt','gv','gx','gz',
    'hb','hc','hd','hf','hg','hj','hk','hl','hm','hn','hp','hr','hs','ht','hv','hx','hz',
    'jb','jc','jd','jf','jg','jh','jj','jk','jl','jm','jn','jp','jr','js','jt','jv','jw','jx','jz',
    'kb','kc','kd','kf','kg','kh','kj','kk','km','kp','kr','ks','kt','kv','kx','kz',
    'lk','lg','lh','lj','lm','ln','lp','lr','ls','lt','lv','lw','lx','lz',
    'md','mf','mg','mh','mj','mk','ml','mm','mn','mp','mr','ms','mt','mv','mw','mx','mz',
    'nb','nc','nd','nf','ng','nh','nj','nk','nl','nm','nn','np','nr','ns','nt','nv','nw','nx','nz',
    'pb','pc','pd','pf','pg','pj','pk','pm','pn','pp','pt','pv','pw','px','pz',
    'qa','qb','qc','qd','qe','qf','qg','qh','qi','qj','qk','ql','qm','qn','qo','qp','qr','qs','qt','qv','qw','qx','qy','qz',
    'rh','rj','rk','rl','rm','rn','rp','rr','rs','rt','rv','rw','rx','rz',
    'sd','sf','sg','sj','sr','sv','sx','sz',
    'tb','tc','td','tf','tg','tj','tk','tl','tm','tn','tp','ts','tt','tv','tx','tz',
    'uu','uv','uw','ux','uz',
    'vb','vc','vd','vf','vg','vh','vj','vk','vl','vm','vn','vp','vr','vs','vt','vv','vw','vx','vz',
    'wb','wc','wd','wf','wg','wj','wk','wl','wm','wn','wp','ws','wt','wv','ww','wx','wz',
    'xb','xc','xd','xf','xg','xh','xj','xk','xl','xm','xn','xp','xr','xs','xt','xv','xw','xx','xz',
    'yb','yc','yd','yf','yg','yh','yj','yk','yl','ym','yn','yp','yr','ys','yt','yv','yw','yx','yz',
    'zb','zc','zd','zf','zg','zj','zk','zl','zm','zn','zp','zr','zs','zt','zv','zw','zx','zz'
]);

/**
 * 单词评分
 * 基于英语音系学规则评估单词像"真词"的程度
 * 
 * @param {string} word 待评估单词
 * @returns {number} 评分 (0-100，真词返回1000)
 */
function scoreWord(word) {
    const w = word.toLowerCase();
    
    // 【新增】真词直接返回满分 (1000分)
    if (isRealWord(w)) return 1000;

    const len = w.length;
    // 基本长度检查
    if (len < 2) return 0;
    if (len > 15) return 0;
    
    // 1. 元音检查 - 每个英语单词必须有元音
    const vowelCount = w.split('').filter(c => VOWELS.includes(c)).length;
    const yCount = w.split('').filter(c => c === 'y').length;
    if (vowelCount === 0 && yCount === 0) return 0;  // 无元音
    
    // 元音比例（英语通常20%-50%）
    const effectiveVowels = vowelCount + (vowelCount === 0 ? yCount : 0);
    const vowelRatio = effectiveVowels / len;
    if (vowelRatio < 0.12 || vowelRatio > 0.75) return 0;
    
    let score = 0;
    
    // 2. 长度评分
    if (len >= 3 && len <= 8) score += 12;
    else if (len >= 9 && len <= 11) score += 5;
    else if (len > 11) score -= 5;
    
    // 3. 检查开头辅音簇
    const firstVowelIdx = [...w].findIndex(c => VOWELS_Y.includes(c));
    if (firstVowelIdx > 0) {
        const onset = w.substring(0, firstVowelIdx);
        if (onset.length <= 3 && VALID_ONSET.has(onset)) {
            score += 10;
        } else if (onset.length > 3) {
            return 0;  // 英语开头最多3个辅音
        } else if (onset.length >= 2 && IMPOSSIBLE_START.has(onset.substring(0, 2))) {
            return 0;  // 不可能的开头
        }
    }
    
    // 4. 检查连续辅音（中间位置）
    let maxConsec = 0, consec = 0;
    for (const c of w) {
        if (!VOWELS_Y.includes(c)) {
            consec++;
            maxConsec = Math.max(maxConsec, consec);
        } else {
            consec = 0;
        }
    }
    if (maxConsec > 4) return 0;  // 超过4个连续辅音
    if (maxConsec === 4) score -= 10;
    if (maxConsec <= 2) score += 5;
    
    // 5. 检查连续元音
    let maxVowelConsec = 0, vowelConsec = 0;
    for (const c of w) {
        if (VOWELS.includes(c)) {
            vowelConsec++;
            maxVowelConsec = Math.max(maxVowelConsec, vowelConsec);
        } else {
            vowelConsec = 0;
        }
    }
    if (maxVowelConsec > 3) score -= 10;
    
    // 6. 检查重复字母（3+连续相同字母不存在）
    for (let i = 0; i < len - 2; i++) {
        if (w[i] === w[i+1] && w[i] === w[i+2]) return 0;
    }
    
    // 7. 双字母组合评分
    let bigramScore = 0;
    for (let i = 0; i < len - 1; i++) {
        const bi = w.substring(i, i + 2);
        if (COMMON_BIGRAMS.has(bi)) bigramScore += 6;
    }
    score += Math.min(bigramScore, 30);  // 上限
    
    // 8. 三字母组合评分
    let trigramScore = 0;
    for (let i = 0; i < len - 2; i++) {
        const tri = w.substring(i, i + 3);
        if (COMMON_TRIGRAMS.has(tri)) trigramScore += 10;
    }
    score += Math.min(trigramScore, 40);  // 上限
    
    // 9. 元音分布奖励（分散的元音比集中的好）
    if (vowelRatio >= 0.25 && vowelRatio <= 0.45) score += 8;
    
    // 10. 常见结尾检查
    if (len >= 3) {
        const ending2 = w.substring(len - 2);
        const ending3 = w.substring(len - 3);
        if (['ed','er','ly','es','le','al','ty','ry','ny'].includes(ending2)) score += 8;
        if (['ing','tion','ness','ment','able','ible','ous','ive'].includes(ending3)) score += 10;
    }
    
    return Math.min(100, Math.max(0, score));
}

/**
 * 应用可读化高亮
 * 将文本分段并高亮显示"有意义"的单词
 * 
 * @param {string} text 原始文本
 * @param {Array} skipRanges 跳过高亮的区域（如搜索关键词）
 * @returns {string} HTML格式的文本
 */
function applyReadable(text, skipRanges = []) {
    // 1. 分句
    const segments = text.split(/([.?!;\n]+)/);
    
    let finalHtml = '';
    let globalIndex = 0;

    for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];
        
        // 纯标点处理
        if (/^[.?!;\n]+$/.test(segment)) {
            finalHtml += esc(segment);
            globalIndex += segment.length;
            continue;
        }

        // 2. 分词 (保留分隔符)
        const tokens = segment.split(/([a-zA-Z]+)/);
        
        let stats = {
            totalWords: 0,
            meaningfulScore: 0,
            realWordCount: 0,
            maxLen: 0,
            hasSpace: false
        };

        // --- 预处理 & 统计阶段 ---
        // 我们需要先遍历一遍，模拟"挖掘"过程来计算分数
        for (const token of tokens) {
            if (/\s/.test(token)) stats.hasSpace = true;
            if (!/^[a-zA-Z]+$/.test(token)) continue;

            stats.totalWords++;
            if (token.length > stats.maxLen) stats.maxLen = token.length;

            // === 核心改进：粘连词挖掘逻辑 ===
            let coreWord = token;
            let isSticky = false; // 是否是粘连词

            // 如果这个词本身不是真词，且长度超过5，尝试挖掘词头
            if (!isRealWord(token) && token.length > 4) {
                // 从最长可能的词头开始倒序查找 (比如 trashn... 先查 trashn 再查 trash)
                // 限制：词头至少3个字母，且不能把原来的词切得只剩1-2个字母(可选)
                for (let len = Math.min(token.length - 1, 12); len >= 3; len--) {
                    const sub = token.substring(0, len);
                    if (isRealWord(sub)) {
                        coreWord = sub; // 找到了隐藏的真词！(trash)
                        isSticky = true;
                        break; 
                    }
                }
            }

            // 评分 (基于挖掘后的核心词 coreWord)
            const s = scoreWord(coreWord);
            if (s >= 1000) {
                stats.meaningfulScore += 1;
                stats.realWordCount++;
            } else if (s >= 55) {
                stats.meaningfulScore += 0.5;
            }
        }

        // --- 句子判定逻辑 (微调) ---
        // 1. 至少4个词
        // 2. 密度 > 0.4
        // 3. 至少2个真词
        // 4. 【修改】只要真词够多，稍微长一点的乱码也可以容忍 (提升到 25)
        //    或者，如果它是"粘连词"(sticky)，那么它已经被切分了，不算怪兽词
        const density = stats.totalWords > 0 ? (stats.meaningfulScore / stats.totalWords) : 0;
        const isSentence = 
            stats.totalWords >= 4 && 
            density > 0.4 && 
            stats.realWordCount >= 2 && 
            stats.maxLen < 25 && // 放宽长度限制，给粘连词机会
            stats.hasSpace;

        // --- 渲染阶段 ---
        let sentenceHtml = '';
        
        for (const token of tokens) {
            const tokenStart = globalIndex;
            const tokenEnd = globalIndex + token.length;
            globalIndex += token.length;

            // 搜索高亮跳过逻辑
            const inSkip = skipRanges.some(sr => (tokenStart < sr.end && tokenEnd > sr.start));
            if (inSkip) {
                sentenceHtml += esc(token);
                continue;
            }

            if (/^[a-zA-Z]+$/.test(token)) {
                // === 渲染时的粘连挖掘 ===
                // 重复上面的逻辑来决定如何上色
                let head = token;
                let tail = '';
                let headScore = 0;

                if (!isRealWord(token) && token.length > 4) {
                    for (let len = Math.min(token.length - 1, 12); len >= 3; len--) {
                        const sub = token.substring(0, len);
                        if (isRealWord(sub)) {
                            head = sub;
                            tail = token.substring(len); // 尾巴 (ncocceelbaazo)
                            break;
                        }
                    }
                }
                
                headScore = scoreWord(head);

                // 渲染头部 (trash)
                let headClass = '';
                // 只有非超长怪兽词才上色，或者它是被挖掘出来的真词
                if (head.length < 20 || headScore >= 1000) {
                    if (headScore >= 1000) headClass = 'readable-real';
                    else if (headScore >= 55) headClass = 'readable-high';
                    else if (headScore >= 35) headClass = 'readable-medium';
                    else if (headScore >= 20) headClass = 'readable-low';
                }

                if (headClass) {
                    sentenceHtml += `<span class="${headClass}">${esc(head)}</span>`;
                } else {
                    sentenceHtml += esc(head);
                }

                // 渲染尾巴 (ncocceelbaazo) - 默认为灰色/普通颜色，或者给个低分色
                if (tail) {
                    // 可以给尾巴上个淡淡的红色，或者就保持原样
                    // 这里为了不抢戏，我们保持原样，或者用低概率色
                    sentenceHtml += `<span class="readable-low" style="opacity:0.5">${esc(tail)}</span>`;
                }

            } else {
                sentenceHtml += esc(token);
            }
        }

        if (isSentence) {
            sentenceHtml = `<span class="sentence-highlight" title="密度: ${Math.round(density*100)}%">${sentenceHtml}</span>`;
        }
        
        finalHtml += sentenceHtml;
    }
    
    return finalHtml;
}

// ============================================================
// UI 工具函数
// ============================================================

/**
 * HTML 转义
 * 防止 XSS 攻击
 */
function esc(t) { 
    return t
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;'); 
}

// 使用 DOM API 设置页面内容，正确保留空格
// 智能检测：只对高空格比例的内容（精准搜索）强制换行

let cachedLineWidth = null; // 缓存计算的行宽
const DEFAULT_LINE_WIDTH = 80; // 默认行宽

// 窗口大小变化时重置缓存
window.addEventListener('resize', () => { cachedLineWidth = null; });

/**
 * 测量容器行宽
 * 计算当前字体设置下，容器一行能容纳多少个字符
 */
function measureLineWidth(container) {
    // 动态测量容器能容纳多少等宽字符
    if (cachedLineWidth && cachedLineWidth > 0) return cachedLineWidth;
    
    try {
        const testSpan = document.createElement('span');
        testSpan.style.cssText = 'visibility:hidden;position:absolute;white-space:pre;font-family:monospace;';
        testSpan.textContent = 'M'.repeat(100);
        container.appendChild(testSpan);
        
        const charWidth = testSpan.offsetWidth / 100;
        const containerStyle = getComputedStyle(container);
        const paddingLeft = parseFloat(containerStyle.paddingLeft) || 0;
        const paddingRight = parseFloat(containerStyle.paddingRight) || 0;
        const availableWidth = container.clientWidth - paddingLeft - paddingRight;
        
        container.removeChild(testSpan);
        
        // 安全检查：确保返回合理的值
        if (charWidth > 0 && availableWidth > 0) {
            cachedLineWidth = Math.floor(availableWidth / charWidth);
            if (cachedLineWidth > 10 && cachedLineWidth < 500) {
                console.log('测量行宽:', cachedLineWidth, '字符');
                return cachedLineWidth;
            }
        }
    } catch (e) {
        console.warn('测量行宽失败:', e);
    }
    
    // 回退到默认值
    console.log('使用默认行宽:', DEFAULT_LINE_WIDTH);
    return DEFAULT_LINE_WIDTH;
}

/**
 * 文本强制换行
 * 用于处理长行或高空格内容的显示问题
 */
function wrapText(text, width) {
    // 安全检查
    if (!width || width <= 0) width = DEFAULT_LINE_WIDTH;
    
    let result = '';
    for (let i = 0; i < text.length; i += width) {
        result += text.substring(i, i + width);
        if (i + width < text.length) result += '\n';
    }
    return result;
}

/**
 * 设置页面内容
 * 智能处理搜索高亮和换行
 * 
 * @returns {number} 搜索词在内容中的位置索引
 */
function setPageContent(container, content, searchTerm) {
    container.textContent = '';
    
    // 计算空格比例
    const spaceCount = (content.match(/ /g) || []).length;
    const spaceRatio = spaceCount / content.length;
    const isHighSpaceContent = spaceRatio > 0.85; // 空格超过85%视为精准搜索结果
    
    // 普通内容：直接设置，让浏览器自然换行
    if (!isHighSpaceContent) {
        if (!searchTerm) {
            container.textContent = content;
            return -1;
        }
        
        const searchIdx = content.indexOf(searchTerm);
        if (searchIdx < 0) {
            container.textContent = content;
            return -1;
        }
        
        // 普通内容带搜索高亮
        const before = content.substring(0, searchIdx);
        const match = content.substring(searchIdx, searchIdx + searchTerm.length);
        const after = content.substring(searchIdx + searchTerm.length);
        
        if (before) container.appendChild(document.createTextNode(before));
        const highlightSpan = document.createElement('span');
        highlightSpan.className = 'highlight';
        highlightSpan.textContent = match;
        container.appendChild(highlightSpan);
        if (after) container.appendChild(document.createTextNode(after));
        
        return searchIdx;
    }
    
    // 高空格内容（精准搜索）：需要强制换行
    const lineWidth = measureLineWidth(container);
    const wrappedContent = wrapText(content, lineWidth);
    
    if (!searchTerm) {
        container.textContent = wrappedContent;
        return -1;
    }
    
    const originalIdx = content.indexOf(searchTerm);
    if (originalIdx < 0) {
        container.textContent = wrappedContent;
        return -1;
    }
    
    // 计算换行后的位置
    const wrappedIdx = originalIdx + Math.floor(originalIdx / lineWidth);
    const searchEnd = originalIdx + searchTerm.length;
    const linesCrossed = Math.floor(searchEnd / lineWidth) - Math.floor(originalIdx / lineWidth);
    
    if (linesCrossed > 0) {
        // 搜索词跨行
        const before = content.substring(0, originalIdx);
        const match = searchTerm;
        const after = content.substring(originalIdx + searchTerm.length);
        
        const wrappedBefore = wrapText(before, lineWidth);
        let finalBefore = wrappedBefore;
        if (before.length > 0 && before.length % lineWidth === 0) {
            finalBefore = wrappedBefore.slice(0, -1);
        }
        
        if (finalBefore) container.appendChild(document.createTextNode(finalBefore));
        
        const highlightSpan = document.createElement('span');
        highlightSpan.className = 'highlight';
        highlightSpan.textContent = match;
        container.appendChild(highlightSpan);
        
        const afterStartInLine = (originalIdx + searchTerm.length) % lineWidth;
        let finalAfter;
        if (afterStartInLine > 0 && after.length > 0) {
            const firstLineRemaining = lineWidth - afterStartInLine;
            if (after.length > firstLineRemaining) {
                finalAfter = after.substring(0, firstLineRemaining) + '\n' + 
                             wrapText(after.substring(firstLineRemaining), lineWidth);
            } else {
                finalAfter = after;
            }
        } else {
            finalAfter = wrapText(after, lineWidth);
        }
        
        if (finalAfter) container.appendChild(document.createTextNode(finalAfter));
    } else {
        // 搜索词在同一行
        const before = wrappedContent.substring(0, wrappedIdx);
        const wrappedSearchEnd = wrappedIdx + searchTerm.length;
        const after = wrappedContent.substring(wrappedSearchEnd);
        
        if (before) container.appendChild(document.createTextNode(before));
        
        const highlightSpan = document.createElement('span');
        highlightSpan.className = 'highlight';
        highlightSpan.textContent = searchTerm;
        container.appendChild(highlightSpan);
        
        if (after) container.appendChild(document.createTextNode(after));
    }
    
    return originalIdx;
}

/**
 * 显示提示消息 (Toast)
 */
function showToast(m) {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const t = document.createElement('div');
    t.className = 'toast'; t.textContent = m;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
}

/**
 * 切换界面板块
 */
function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`nav button[data-section="${id}"]`).classList.add('active');
    if (id === 'bookmarks') renderBookmarks();
}

async function displayPage(hex, wall, shelf, volume, page, searchTerm) {
    if (computing) return;
    computing = true;
    
    try {
        state.hex = hex;
        state.wall = wall;
        state.shelf = shelf;
        state.volume = volume;
        state.page = page;
        if (searchTerm !== undefined) state.searchTerm = searchTerm;
        
        const content = await generatePage(hex, wall, shelf, volume, page);
        // 先切换到浏览页面，确保容器可见（有正确的宽度）
        showSection('browse');
        
        // 等待一帧让布局完成
        await new Promise(r => requestAnimationFrame(r));
        
        let searchIdx = -1;
        const pageContentEl = document.getElementById('pageContent');
        
        // 检测是否为高空格内容（需要强制换行）
        const spaceCount = (content.match(/ /g) || []).length;
        const spaceRatio = spaceCount / content.length;
        const isHighSpaceContent = spaceRatio > 0.85;
        
        // 如果是高空格内容，先进行换行处理
        let processedContent = content;
        if (isHighSpaceContent) {
            const lineWidth = measureLineWidth(pageContentEl);
            processedContent = wrapText(content, lineWidth);
        }
        
        if (state.readable) {
            // 可读模式使用 innerHTML
            if (state.searchTerm) {
                searchIdx = content.indexOf(state.searchTerm);
                if (searchIdx >= 0) {
                    const searchEnd = searchIdx + state.searchTerm.length;
                    
                    if (isHighSpaceContent) {
                        // 高空格内容：对原始内容分段后分别处理
                        const lineWidth = measureLineWidth(pageContentEl);
                        const beforeContent = content.substring(0, searchIdx);
                        const afterContent = content.substring(searchEnd);
                        
                        const beforeWrapped = wrapText(beforeContent, lineWidth);
                        const afterWrapped = wrapText(afterContent, lineWidth);
                        
                        const before = applyReadable(beforeWrapped, []);
                        const searchPart = '<span class="highlight">' + esc(state.searchTerm) + '</span>';
                        const after = applyReadable(afterWrapped, []);
                        pageContentEl.innerHTML = before + searchPart + after;
                    } else {
                        // 普通内容
                        const before = applyReadable(content.substring(0, searchIdx), []);
                        const searchPart = '<span class="highlight">' + esc(state.searchTerm) + '</span>';
                        const after = applyReadable(content.substring(searchEnd), []);
                        pageContentEl.innerHTML = before + searchPart + after;
                    }
                } else {
                    pageContentEl.innerHTML = applyReadable(processedContent, []);
                }
            } else {
                pageContentEl.innerHTML = applyReadable(processedContent, []);
            }
        } else {
            // 非可读模式：使用 DOM API 保留空格（关键修复！）
            searchIdx = setPageContent(pageContentEl, content, state.searchTerm);
        }
        
        // === 位置指示器 ===
        let existingIndicator = document.getElementById('searchPositionIndicator');
        if (existingIndicator) existingIndicator.remove();
        
        if (state.searchTerm && searchIdx >= 0) {
            const posPercent = ((searchIdx / PAGE_LEN) * 100).toFixed(1);
            const posLabel = searchIdx < PAGE_LEN * 0.1 ? '页首区域' : 
                             searchIdx > PAGE_LEN * 0.9 ? '页尾区域' : '页面中部';
            
            const posIndicator = document.createElement('div');
            posIndicator.id = 'searchPositionIndicator';
            posIndicator.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, rgba(212,175,55,0.2) 0%, rgba(139,115,85,0.15) 100%);
                    border: 1px solid var(--gold);
                    border-radius: 6px;
                    padding: 0.8rem 1rem;
                    margin-bottom: 1rem;
                    font-size: 0.9rem;
                ">
                    <div style="display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:0.3rem 1rem;margin-bottom:0.5rem">
                        <span style="color:var(--gold-light);font-weight:600">🔍 搜索词位置</span>
                        <span style="color:#fff;font-weight:500;text-align:right">「${esc(state.searchTerm)}」位于 <strong style="color:var(--gold-light)">${posLabel}</strong></span>
                    </div>
                    <div style="background:#1a1612;border-radius:4px;height:14px;position:relative;overflow:hidden;border:1px solid var(--gold-dark)">
                        <div style="position:absolute;left:${posPercent}%;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;background:var(--gold);border-radius:50%;box-shadow:0 0 12px var(--gold-light)"></div>
                        <div style="position:absolute;left:0;top:0;width:${posPercent}%;height:100%;background:linear-gradient(90deg,rgba(212,175,55,0.4),rgba(244,207,103,0.6))"></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:0.4rem;font-size:0.8rem;color:#fff">
                        <span>0</span>
                        <span style="color:var(--gold-light);font-weight:500">第 ${searchIdx} 字符 (${posPercent}%)</span>
                        <span>${PAGE_LEN}</span>
                    </div>
                </div>`;
            pageContentEl.parentElement.insertBefore(posIndicator, pageContentEl);
            
            // 高亮动画和滚动
            setTimeout(() => {
                const highlight = document.querySelector('.highlight');
                if (highlight) {
                    highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    highlight.style.animation = 'pulse 2s infinite';
                }
            }, 100);
        }
        
        // 获取书名（独立随机生成）
        const title = getBookTitleSync(hex, wall, shelf, volume);
        
        // === 第一页书名显示 ===
        let existingTitleDisplay = document.getElementById('pageTitleDisplay');
        if (existingTitleDisplay) existingTitleDisplay.remove();
        
        if (page === 1) {
            const titleDisplay = document.createElement('div');
            titleDisplay.id = 'pageTitleDisplay';
            titleDisplay.innerHTML = `
                <div style="
                    text-align: center;
                    padding: 1.5rem 1rem;
                    margin-bottom: 1rem;
                    border-bottom: 2px solid var(--gold-dark);
                    background: linear-gradient(180deg, rgba(212,175,55,0.08) 0%, transparent 100%);
                ">
                    <div style="
                        font-family: 'ZCOOL XiaoWei', 'Noto Serif SC', serif;
                        font-size: 1.4rem;
                        font-weight: 600;
                        color: var(--ink);
                        letter-spacing: 0.1em;
                        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
                        word-break: break-word;
                    ">${esc(title)}</div>
                    <div style="
                        margin-top: 0.5rem;
                        font-size: 0.75rem;
                        color: var(--ink-light);
                        opacity: 0.7;
                    ">— 第一页 —</div>
                </div>`;
            pageContentEl.parentElement.insertBefore(titleDisplay, pageContentEl);
        }
        
        document.getElementById('bookTitle').textContent = title;
        document.getElementById('locationInfo').textContent = `墙${wall} · 架${shelf} · 卷${volume}`;
        const coverSvg = generateBookCover(hex, wall, shelf, volume);
// 将 SVG 字符串转为 Data URI，或者直接插入 innerHTML
document.getElementById('bookCover').innerHTML = coverSvg;
        document.getElementById('pageInput').value = page;
        document.getElementById('pageInput').disabled = false;
        // 启用空间导航控件
document.getElementById('navWallBtn').disabled = false;
document.getElementById('navShelfUp').disabled = false;
document.getElementById('navShelfDown').disabled = false;
document.getElementById('navVolLeft').disabled = false;
document.getElementById('navVolRight').disabled = false;
        document.getElementById('prevBtn').disabled = page <= 1;
        document.getElementById('nextBtn').disabled = page >= PAGES;
        
        const coord = `${hex}-w${wall}-s${shelf}-v${volume}-p${page}`;
        document.getElementById('fullCoordinate').textContent = coord;
        // ... 原有代码 ...
        document.getElementById('hexLength').textContent = [...hex].length;
        
        // --- 修改开始：获取语义分和熵 ---
        // 我们需要从 updateEntropyDisplay 内部获取数值，或者在这里重新计算
        // 为了代码整洁，我们让 calculateStats 返回这些值
        const pageStats = analyzePageStats(content); // 下面会定义这个新辅助函数
        
        // 记录统计
        gameData.stats.visits++;
        if (state.searchTerm) gameData.stats.searches++;
        else gameData.stats.randoms++; // 假设非搜索即随机/浏览
        
        gameData.stats.highestEntropy = Math.max(gameData.stats.highestEntropy, pageStats.entropy);
        gameData.stats.lowestEntropy = Math.min(gameData.stats.lowestEntropy, pageStats.entropy);
        gameData.stats.highestSemantics = Math.max(gameData.stats.highestSemantics, pageStats.semanticScore);
        
        // 1. 生成当前页面的唯一指纹 (使用已有的 hashStr 函数)
        // 坐标字符串本身很长，但 hashStr 算出来的只是一个短整数
        const fullCoordStr = `${hex}-${wall}-${shelf}-${volume}-${page}`;
        const pageHash = hashStr(fullCoordStr); 

        // 2. 检查这个指纹是否在最近访问列表中
        // 如果 gameData.recentHashes 不存在 (旧存档兼容)，则初始化为空数组
        if (!gameData.recentHashes) gameData.recentHashes = [];

        const hasVisitedRecently = gameData.recentHashes.includes(pageHash);

        if (!hasVisitedRecently) {
    // --- 如果是新页面，发放奖励 ---
    
    // 计算经验（获取详细因子）
    const xpResult = calculatePageXP(
        content, 
        pageStats.semanticScore, 
        pageStats.entropy, 
        !state.searchTerm 
    );
    
    if (xpResult.total > 0) {
        addXP(xpResult.total, xpResult.factors);
    }

    // --- 记录到历史 ---
    gameData.recentHashes.push(pageHash);
    
    // --- 限制记忆容量 ---
    if (gameData.recentHashes.length > 1000) {
        gameData.recentHashes.shift();
    }
} else {
    // 已访问过的页面，显示提示
    showVisitedNotice();
}
        
        // 检查成就
        checkAchievements({ page: page });
        
        // 更新UI
        updateEntropyDisplay(content, pageStats); // 修改这个函数接受预计算的stats
        updatePlayerUI();
        saveGame();
        // --- 修改结束 ---

    } finally {
        computing = false;
    }
}

// 给书名添加点击复制功能
document.getElementById('bookTitle').onclick = function() {
    const text = this.innerText;
    if(text === '—') return;
    
    // 尝试写入剪贴板
    navigator.clipboard.writeText(text).then(() => {
        showToast('📋 书名已复制');
    }).catch(() => {
        // 如果失败（部分浏览器限制），选中文字让用户手动复制
        const range = document.createRange();
        range.selectNodeContents(this);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        showToast('📋 请长按复制'); // 提示用户
    });
};

async function goRandom() {
    if (computing) return;
    
    showProgress('生成随机页面...', '创建内容');
    
    const rng = mulberry32(Math.floor(Math.random() * 0xFFFFFFFF));
    let randomPage = '';
    for (let i = 0; i < PAGE_LEN; i++) randomPage += CHARS[Math.floor(rng() * 29)];
    
    const w = Math.floor(Math.random() * WALLS) + 1;
    const s = Math.floor(Math.random() * SHELVES) + 1;
    const v = Math.floor(Math.random() * VOLUMES) + 1;
    const p = Math.floor(Math.random() * PAGES) + 1;
    
    const contentNum = await searchForContent(randomPage, w, s, v, p);
    
    // 生成随机书名
    const rng2 = mulberry32(Math.floor(Math.random() * 0xFFFFFFFF));
    const titleLen = 1 + Math.floor(rng2() * 25);
    let randomTitle = '';
    for (let i = 0; i < titleLen; i++) {
        randomTitle += CHARS[Math.floor(rng2() * 29)];
    }
    randomTitle = randomTitle.trim().replace(/^[,.\s]+|[,.\s]+$/g, '') || 'a';
    
    // 使用新的创建函数
    const fullHex = createFullHexForSearch(contentNum, randomTitle, w, s, v);
    
    await displayPage(fullHex, w, s, v, p, '');
}

/**
 * 解析完整坐标字符串
 * 格式: {hex}-w{wall}-s{shelf}-v{volume}-p{page}
 * 
 * @param {string} str 坐标字符串
 * @returns {Object|null} 解析后的对象或null
 */
function parseCoord(str) {
    const m = str.trim().match(/^(.+)-w(\d+)-s(\d+)-v(\d+)-p(\d+)$/i);
    if (!m) return null;
    const [, hex, w, sh, v, p] = m;
    const wall = +w, shelf = +sh, volume = +v, page = +p;
    if (wall < 1 || wall > WALLS || shelf < 1 || shelf > SHELVES ||
        volume < 1 || volume > VOLUMES || page < 1 || page > PAGES) return null;
    return { hex, wall, shelf, volume, page };
}

// ============================================================
// 搜索 UI
// ============================================================

/**
 * 执行搜索操作
 * 读取输入框内容，触发各类搜索，并渲染结果
 */
async function doSearch() {
    if (computing) return;
    
    const raw = document.getElementById('searchInput').value;
    const text = raw.toLowerCase().replace(/[^a-z ,.]/g, '');
    
    // 允许纯空格搜索（巴别图书馆包含任何可能的文本组合）
    if (text.length === 0) { 
        alert('请输入搜索内容（可以是纯空格）'); 
        return; 
    }
    if (text.length > PAGE_LEN) { 
        alert(`文本过长,最多${PAGE_LEN}字符`); 
        return; 
    }
    
    state.searchTerm = text;
    computing = true;
    
    try {
        document.getElementById('searchResults').innerHTML = '<div style="padding:2rem;text-align:center;color:var(--gold-dark)">⏳ 正在计算...</div>';
        
        const exactResult = await findExactMatch(text);
        const randomResult = await findRandomMatch(text);
        
        // 书名搜索 - 书名长度为 1-25
        let titleResults = [];
        if (text.length >= 1 && text.length <= 25) {
            const titleSearchResults = await searchByTitle(text, 1);
            titleResults = titleSearchResults;
        }
        
        const results = {
            exact: [exactResult],
            random: [randomResult],
            title: [await findTitleMatch(text)],
            bookTitle: titleResults
        };
        
        renderResults(results, text);
    } finally {
        computing = false;
    }
}

function renderResults(results, text) {
    let html = '';
    
    html += `<div class="result-category"><h3>📄 精准匹配(整页只有搜索词+空格)</h3>
             <div class="result-list">${renderItems(results.exact, text)}</div>
             <div class="load-more" data-type="exact" data-search="${esc(text)}">⊕ 生成更多</div></div>`;
    
    html += `<div class="result-category"><h3>🔀 随机字符匹配</h3>
             <div class="result-list">${renderItems(results.random, text)}</div>
             <div class="load-more" data-type="random" data-search="${esc(text)}">⊕ 生成更多</div></div>`;
    
    // 首页开头匹配结果
    html += `<div class="result-category"><h3>📚 首页开头匹配(搜索词位于第一页开头)</h3>
             <div class="result-list">${renderTitleItems(results.title, text)}</div>
             <div class="load-more" data-type="title" data-search="${esc(text)}">⊕ 生成更多</div></div>`;
    
    // 书名匹配分类 - 书名长度为 1-25
    if (text.length >= 1 && text.length <= 25) {
        if (results.bookTitle && results.bookTitle.length > 0) {
            html += `<div class="result-category"><h3>📖 书名匹配(书名包含关键词)</h3>
                     <div class="result-list">${renderBookTitleItems(results.bookTitle, text)}</div>
                     <div class="load-more" data-type="bookTitle" data-search="${esc(text)}">⊕ 生成更多</div></div>`;
        }
    } else if (text.length < 1) {
        html += `<div class="result-category"><h3>📖 书名匹配</h3>
                 <p style="padding:1.5rem;color:var(--parchment-dark);text-align:center">
                   请输入书名关键词（可以是纯空格）
                 </p></div>`;
    } else {
        html += `<div class="result-category"><h3>📖 书名匹配</h3>
                 <p style="padding:1.5rem;color:var(--parchment-dark);text-align:center">
                   书名搜索最长 25 个字符,当前 ${text.length} 个字符
                 </p></div>`;
    }
    
    document.getElementById('searchResults').innerHTML = html;
    bindSearchEvents();
}

function renderItems(items, text) {
    return items.map(it => {
        const coord = `${it.hex}-w${it.wall}-s${it.shelf}-v${it.volume}-p${it.page}`;
        
        // 获取处理过的预览文案
        let pv = it.preview || '';
        
        // 在预览文案中高亮搜索词
        const highlightText = it.text || text.trim();
        
        const pvParts = pv.split(highlightText);
        const pvHtml = pvParts.join(`<span class="highlight">${esc(highlightText)}</span>`);

        // 计算位置百分比
        const positionPercent = ((it.position / PAGE_LEN) * 100).toFixed(1);
        const positionLabel = it.position < PAGE_LEN * 0.1 ? '📍 页首' : 
                              it.position > PAGE_LEN * 0.9 ? '📍 页尾' : '📍 页中';
        
        // 位置指示条
        const positionBar = `
            <div style="margin:0.5rem 0;background:#2a2520;border-radius:4px;height:10px;position:relative;overflow:hidden;border:1px solid var(--gold-dark)">
                <div style="position:absolute;left:${positionPercent}%;top:0;width:4px;height:100%;background:var(--gold-light);box-shadow:0 0 8px var(--gold)"></div>
                <div style="position:absolute;left:0;top:0;width:${positionPercent}%;height:100%;background:linear-gradient(90deg,rgba(212,175,55,0.3),rgba(244,207,103,0.5))"></div>
            </div>`;

        return `<div class="result-item" data-coord="${esc(coord)}" data-text="${esc(highlightText)}">
                  <div style="color:var(--gold-light);font-size:0.9rem;font-weight:500">
                    📖 墙${it.wall} · 架${it.shelf} · 卷${it.volume} · 第${it.page}页
                  </div>
                  <div style="font-size:0.85rem;color:#fff;margin:0.3rem 0">
                    ${positionLabel} <span style="color:var(--gold-light)">第 ${it.position} 字符</span> / ${PAGE_LEN} <span style="color:var(--gold)">(${positionPercent}%)</span>
                  </div>
                  ${positionBar}
                  <div class="result-preview">${pvHtml}</div>
                  <div class="result-coord">${esc(coord.substring(0, 80))}...</div>
                </div>`;
    }).join('');
}

// ============================================================
// 熵值计算器 (Shannon Entropy)
// ============================================================

/**
 * 计算文本的香农熵
 * 衡量文本的随机程度，用于辅助判断是否有意义
 * 
 * @param {string} text 输入文本
 * @returns {number} 熵值 (bits/symbol)
 */
function calculateEntropy(text) {
    if (!text || text.length === 0) return 0;
    
    // 1. 统计字符频率
    const freqs = {};
    for (let char of text) {
        freqs[char] = (freqs[char] || 0) + 1;
    }
    
    // 2. 计算香农熵
    const len = text.length;
    let entropy = 0;
    for (let char in freqs) {
        const p = freqs[char] / len; // 概率 P(x)
        entropy -= p * Math.log2(p); // - P * log2(P)
    }
    
    return entropy;
}

// ============================================================
// 综合分析器：结合熵值与词汇学分析
// ============================================================

/**
 * 更新熵值和语义分析的 UI 显示
 * 
 * @param {string} text 页面文本
 * @param {object|null} precalcStats 预计算的统计结果 (可选)
 */
function updateEntropyDisplay(text, precalcStats = null) {
    if (!text) return;

    const stats = precalcStats || analyzePageStats(text);
    const entropy = stats.entropy;
    const semanticScore = stats.semanticScore;
    const maxEntropy = Math.log2(95);

    const elVal = document.getElementById('entropyValue');
    const elDesc = document.getElementById('entropyDesc');
    const elBar = document.getElementById('entropyBar');
    
    // === 修改：5位小数 ===
    elVal.textContent = entropy.toFixed(5); 
    
    // 剩下的UI逻辑保持不变，或者直接使用 semanticScore
    let desc = '';
    let color = '';
    let barPercent = 0;

    if (semanticScore > 60) {
        desc = '✦ 高度文明 (可读)'; color = '#bd52ff'; barPercent = 95;
    } else if (semanticScore > 20) {
        desc = '⚠ 疑似自然语言'; color = '#4ade80'; barPercent = 70;
    } else if (entropy < 3.500) {
        desc = '∅ 信息匮乏 (重复)'; color = '#60a5fa'; barPercent = 10;
    } else if (entropy > 4.856) {
        desc = '∿ 极度混沌 (白噪)'; color = '#f87171'; barPercent = 100;
    } else {
        desc = '≈ 复杂噪声'; color = '#fbbf24'; barPercent = (entropy / maxEntropy) * 100;
    }
    
    elDesc.textContent = desc;
    elDesc.style.color = color;
    elBar.style.width = barPercent + '%';
    elBar.style.backgroundColor = color;
}

function renderTitleItems(items, text) {
    return items.map(it => {
        const coord = `${it.hex}-w${it.wall}-s${it.shelf}-v${it.volume}-p${it.page}`;
        return `<div class="result-item" data-coord="${esc(coord)}" data-text="${esc(it.text || text)}">
                  <div class="result-title">「${esc(it.text)}」</div>
                  <div style="color:var(--parchment-dark);font-size:0.85rem;margin-top:0.3rem">
                    📍 墙${it.wall} · 架${it.shelf} · 卷${it.volume} · 第一页开头
                  </div>
                  <div class="result-coord">${esc(coord.substring(0, 80))}...</div>
                </div>`;
    }).join('');
}

function renderBookTitleItems(items, searchText) {
    return items.map(it => {
        const coord = `${it.hex}-w${it.wall}-s${it.shelf}-v${it.volume}-p1`;
        
        // 高亮书名中的搜索关键词
        let titleHtml = esc(it.title);
        if (searchText) {
            const searchLower = searchText.toLowerCase();
            const titleLower = it.title.toLowerCase();
            const idx = titleLower.indexOf(searchLower);
            if (idx >= 0) {
                const before = it.title.substring(0, idx);
                const match = it.title.substring(idx, idx + searchText.length);
                const after = it.title.substring(idx + searchText.length);
                titleHtml = esc(before) + `<span class="highlight">${esc(match)}</span>` + esc(after);
            }
        }
        
        return `<div class="result-item" data-coord="${esc(coord)}" data-text="">
                  <div class="result-title">「${titleHtml}」</div>
                  <div style="color:var(--parchment-dark);font-size:0.85rem;margin-top:0.3rem">
                    📍 墙${it.wall} · 架${it.shelf} · 卷${it.volume} · 第一页
                  </div>
                  <div class="result-coord">${esc(coord.substring(0, 80))}...</div>
                </div>`;
    }).join('');
}

function bindSearchEvents() {
    document.querySelectorAll('.load-more').forEach(btn => {
        btn.onclick = async function() {
            if (computing) return;
            computing = true;
            
            // 【修复】从按钮的 data-search 属性读取搜索词
            const text = this.dataset.search;
            const type = this.dataset.type;
            
            // 【新增】验证搜索词
            if (!text) {
                alert('搜索词丢失,请重新搜索');
                computing = false;
                return;
            }
            
            try {
                let item;
                let html;
                
                if (type === 'exact') {
                    item = await findExactMatch(text);
                    html = renderItems([item], text);
                } 
                else if (type === 'random') {
                    item = await findRandomMatch(text);
                    html = renderItems([item], text);
                }
                else if (type === 'title') {
                    item = await findTitleMatch(text);
                    html = renderTitleItems([item], text);
                }
                else if (type === 'bookTitle') {
                    const titleResults = await searchByTitle(text, 1);
                    if (titleResults.length > 0) {
                        item = titleResults[0];
                        html = renderBookTitleItems([item], text);
                    } else {
                        showToast('未找到匹配的书名');
                        computing = false;
                        return;
                    }
                }
                
                this.previousElementSibling.insertAdjacentHTML('beforeend', html);
                bindResultClicks();
            } finally {
                computing = false;
            }
        };
    });
    bindResultClicks();
}

/**
 * 绑定搜索结果点击事件
 * 为搜索结果列表项添加点击监听器，点击后跳转到对应页面
 */
function bindResultClicks() {
    document.querySelectorAll('.result-item').forEach(el => {
        if (el.dataset.bound) return;
        el.dataset.bound = '1';
        el.onclick = async function() {
            const c = parseCoord(this.dataset.coord);
            if (c) await displayPage(c.hex, c.wall, c.shelf, c.volume, c.page, this.dataset.text);
        };
    });
}

// ============================================================
// 书签系统
// ============================================================

/**
 * 获取书签列表
 * 从 localStorage 读取并解析书签数据
 * @returns {Array<{name:string, coord:string}>} 书签数组
 */
function getBookmarks() {
    try { return JSON.parse(localStorage.getItem('babelBookmarks4') || '[]'); }
    catch { return []; }
}

/**
 * 保存书签列表
 * 将书签数据序列化并保存到 localStorage
 * @param {Array} b 书签数组
 */
function saveBookmarks(b) {
    try { localStorage.setItem('babelBookmarks4', JSON.stringify(b)); }
    catch { alert('无法保存'); }
}

/**
 * 添加当前页为书签
 * 弹出对话框输入名称，保存当前坐标和名称
 */
function addBookmark() {
    if (!state.hex) { alert('请先打开一个页面'); return; }
    const title = getBookTitleSync(state.hex, state.wall, state.shelf, state.volume);
    const name = prompt('书签名称:', title);
    if (!name) return;
    const coord = `${state.hex}-w${state.wall}-s${state.shelf}-v${state.volume}-p${state.page}`;
    const bm = getBookmarks();
    bm.push({ name, coord });
    saveBookmarks(bm);
    showToast('⭐ 书签已添加');
}

/**
 * 渲染书签列表
 * 将存储的书签显示在界面上，并绑定点击跳转和删除事件
 */
function renderBookmarks() {
    const bm = getBookmarks();
    const el = document.getElementById('bookmarkList');
    if (!bm.length) { 
        el.innerHTML = '<p style="color:var(--parchment-dark);text-align:center;padding:2rem">暂无书签</p>'; 
        return; 
    }
    el.innerHTML = bm.map((b, i) => `
        <div class="bookmark-item">
          <div class="bookmark-info" data-i="${i}">
            <div class="bookmark-name">📖 ${esc(b.name)}</div>
            <div class="bookmark-coord">${esc(b.coord.substring(0, 60))}...</div>
          </div>
          <button class="delete-btn" data-i="${i}">✕</button>
        </div>`).join('');
    
    el.querySelectorAll('.bookmark-info').forEach(e => {
        e.onclick = async () => {
            const c = parseCoord(getBookmarks()[+e.dataset.i]?.coord || '');
            if (c) await displayPage(c.hex, c.wall, c.shelf, c.volume, c.page, '');
        };
    });
    el.querySelectorAll('.delete-btn').forEach(e => {
        e.onclick = ev => {
            ev.stopPropagation();
            if (!confirm('确定删除此书签？')) return;
            const bm = getBookmarks();
            bm.splice(+e.dataset.i, 1);
            saveBookmarks(bm);
            renderBookmarks();
            showToast('书签已删除');
        };
    });
}

/**
 * 复制当前坐标
 * 将完整的六边形坐标复制到剪贴板
 */
function copyCoord() {
    const coord = document.getElementById('fullCoordinate').textContent;
    if (coord === '—') return;
    
    navigator.clipboard?.writeText(coord).then(() => showToast('📋 坐标已复制')).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = coord; ta.style.cssText = 'position:fixed;left:-9999px';
        document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); showToast('📋 坐标已复制'); }
        catch { showToast('复制失败'); }
        document.body.removeChild(ta);
    });
}

// ============================================================
// 封面生成系统
// ============================================================

/**
 * 程序化生成书籍封面
 * 根据坐标生成确定性的、独一无二的 SVG 封面
 * 包含随机颜色、纹理滤镜和 30 种不同的图案样式
 * 
 * @param {string} hex 六边形坐标
 * @param {number} w 墙号
 * @param {number} s 书架号
 * @param {number} v 卷号
 * @returns {string} SVG 格式的封面 HTML
 */
function generateBookCover(hex, w, s, v) {
    // 1. 解析坐标数值（新架构：直接提取内容数值）
    const contentNum = getContentNumFromHex(hex);

    // 2. 使用数值字符串做种子
    const seedString = `COVER|${contentNum.toString(10)}|${w}|${s}|${v}`;
    const rng = mulberry32(hashStr(seedString));

    // 1. 颜色生成 (保持不变)
    const hue = Math.floor(rng() * 360);
    const sat = Math.floor(15 + rng() * 35);
    const light = Math.floor(10 + rng() * 25);
    
    const baseColor = `hsl(${hue}, ${sat}%, ${light}%)`;
    const patternColor = `hsl(${hue}, ${sat}%, ${light + 15}%)`;
    const goldColor = `hsl(45, 60%, ${50 + rng() * 20}%)`;

    // 2. 纹理滤镜 (保持不变)
    const filter = `
        <filter id="noise${w}${s}${v}">
            <feTurbulence type="fractalNoise" baseFrequency="${0.5 + rng()}" numOctaves="3" stitchTiles="stitch"/>
            <feColorMatrix type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 0.1 0"/>
            <feBlend mode="multiply" in2="SourceGraphic"/>
        </filter>
    `;

    // 3. 随机决定图案样式 (现在有 30 种可能性)
    const patternType = Math.floor(rng() * 30); 
    
    // === 新增：记录封面收集进度 ===
    if (!gameData.stats.coversSeen.includes(patternType)) {
        gameData.stats.coversSeen.push(patternType);
        // 如果是新发现的，稍微给点XP奖励
        addXP(50);
        showToast('🎨 发现新封面样式！');
        saveGame();
    }
    
    let svgContent = '';
    
    // 基础背景
    svgContent += `<rect width="100%" height="100%" fill="${baseColor}" filter="url(#noise${w}${s}${v})" />`;

    // === 图案库 ===
    if (patternType === 0) {
        // [双线边框] 经典
        svgContent += `<rect x="5" y="5" width="50" height="80" fill="none" stroke="${goldColor}" stroke-width="1" opacity="0.6" />`;
        svgContent += `<rect x="8" y="8" width="44" height="74" fill="none" stroke="${patternColor}" stroke-width="0.5" />`;
    } 
    else if (patternType === 1) {
        // [中央菱形] 神秘
        svgContent += `<path d="M30 20 L50 45 L30 70 L10 45 Z" fill="none" stroke="${goldColor}" stroke-width="1" opacity="0.5" />`;
        svgContent += `<circle cx="30" cy="45" r="5" fill="${goldColor}" opacity="0.8" />`;
    }
    else if (patternType === 2) {
        // [顶部装饰带] 官方档案风格
        svgContent += `<rect x="0" y="15" width="60" height="10" fill="${patternColor}" opacity="0.3" />`;
        svgContent += `<rect x="0" y="65" width="60" height="10" fill="${patternColor}" opacity="0.3" />`;
        svgContent += `<line x1="30" y1="15" x2="30" y2="25" stroke="${goldColor}" stroke-width="2"/>`;
    }
    else if (patternType === 3) {
        // [极简圆环] 哲学
        svgContent += `<circle cx="30" cy="40" r="15" fill="none" stroke="${patternColor}" stroke-width="2" />`;
        svgContent += `<circle cx="30" cy="40" r="12" fill="none" stroke="${goldColor}" stroke-width="0.5" />`;
    }
    else if (patternType === 4) {
        // [十字架/四分] 宗教或法典
        svgContent += `<line x1="30" y1="10" x2="30" y2="80" stroke="${patternColor}" stroke-width="1" opacity="0.5"/>`;
        svgContent += `<line x1="10" y1="45" x2="50" y2="45" stroke="${patternColor}" stroke-width="1" opacity="0.5"/>`;
        svgContent += `<rect x="25" y="40" width="10" height="10" fill="none" stroke="${goldColor}" stroke-width="1" transform="rotate(45 30 45)"/>`;
    }
    else if (patternType === 5) {
        // [三颗星] 魔法
        svgContent += `<circle cx="30" cy="25" r="2" fill="${goldColor}" />`;
        svgContent += `<circle cx="30" cy="45" r="2" fill="${goldColor}" />`;
        svgContent += `<circle cx="30" cy="65" r="2" fill="${goldColor}" />`;
        svgContent += `<path d="M30 25 L30 65" stroke="${goldColor}" stroke-width="0.5" opacity="0.5"/>`;
    }
    else if (patternType === 6) {
        // [拱门] 建筑感
        svgContent += `<path d="M10 80 L10 30 Q30 5 50 30 L50 80" fill="none" stroke="${goldColor}" stroke-width="1" opacity="0.7"/>`;
        svgContent += `<path d="M15 80 L15 35 Q30 15 45 35 L45 80" fill="none" stroke="${patternColor}" stroke-width="0.5"/>`;
    }
    else if (patternType === 7) {
        // [侧边金条] 百科全书风格
        svgContent += `<rect x="5" y="0" width="10" height="90" fill="${patternColor}" opacity="0.2"/>`;
        svgContent += `<line x1="10" y1="0" x2="10" y2="90" stroke="${goldColor}" stroke-width="1" stroke-dasharray="2,2"/>`;
        svgContent += `<rect x="40" y="70" width="15" height="15" fill="none" stroke="${goldColor}" stroke-width="1" opacity="0.5"/>`;
    }
    else if (patternType === 8) {
        // [全视之眼/三角形] 炼金术
        svgContent += `<path d="M10 60 L30 20 L50 60 Z" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<circle cx="30" cy="42" r="4" fill="${patternColor}" stroke="${goldColor}" stroke-width="0.5"/>`;
    }
    else if (patternType === 9) {
        // [网格] 科学/数学
        svgContent += `<path d="M10 10 L50 10 M10 30 L50 30 M10 50 L50 50 M10 70 L50 70" stroke="${patternColor}" stroke-width="0.5" opacity="0.6"/>`;
        svgContent += `<line x1="30" y1="10" x2="30" y2="80" stroke="${goldColor}" stroke-width="1"/>`;
    }
    else if (patternType === 10) {
        // [星芒] 罗盘八芒星
        svgContent += `<polygon points="30,28 47,45 30,62 13,45" fill="none" stroke="${patternColor}" stroke-width="1" opacity="0.6"/>`;
        svgContent += `<path d="M30 15 L33 42 L60 45 L33 48 L30 75 L27 48 L0 45 L27 42 Z" fill="none" stroke="${goldColor}" stroke-width="1" opacity="0.8"/>`;
        svgContent += `<circle cx="30" cy="45" r="5" fill="${baseColor}" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<circle cx="30" cy="45" r="2" fill="${goldColor}"/>`;
    }
    else if (patternType === 11) {
        // [纯色皮面] 极简风格 - 什么都没有
    }
    else if (patternType === 12) {
        // [月亮与星星] 天文
        svgContent += `<circle cx="35" cy="30" r="12" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<circle cx="40" cy="25" r="10" fill="${baseColor}"/>`;
        svgContent += `<circle cx="20" cy="60" r="1.5" fill="${goldColor}"/>`;
        svgContent += `<circle cx="45" cy="55" r="1" fill="${goldColor}"/>`;
        svgContent += `<circle cx="15" cy="70" r="1" fill="${goldColor}"/>`;
    }
    else if (patternType === 13) {
        // [六芒星] 神秘学
        svgContent += `<path d="M30 20 L45 55 L15 55 Z" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<path d="M30 60 L45 25 L15 25 Z" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
    }
    else if (patternType === 14) {
        // [螺旋] 自然/生命
        svgContent += `<path d="M30 45 Q35 40 35 35 Q35 25 30 25 Q20 25 20 35 Q20 50 30 50 Q45 50 45 35 Q45 15 30 15" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
    }
    else if (patternType === 15) {
        // [树] 家族/知识
        svgContent += `<line x1="30" y1="80" x2="30" y2="40" stroke="${patternColor}" stroke-width="2"/>`;
        svgContent += `<path d="M30 40 L20 25 M30 40 L40 25 M30 50 L15 35 M30 50 L45 35" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<circle cx="20" cy="22" r="3" fill="${goldColor}" opacity="0.6"/>`;
        svgContent += `<circle cx="40" cy="22" r="3" fill="${goldColor}" opacity="0.6"/>`;
    }
    else if (patternType === 16) {
        // [锁链] 束缚/连接
        for (let y = 15; y < 75; y += 15) {
            svgContent += `<ellipse cx="30" cy="${y}" rx="8" ry="5" fill="none" stroke="${goldColor}" stroke-width="1" opacity="0.7"/>`;
        }
    }
    else if (patternType === 17) {
        // [羽毛] 诗歌/轻盈
        svgContent += `<path d="M30 75 Q25 50 30 25 Q35 50 30 75" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<path d="M30 25 Q20 35 15 30 M30 35 Q18 45 12 40 M30 45 Q20 55 15 50" stroke="${patternColor}" stroke-width="0.5"/>`;
        svgContent += `<path d="M30 25 Q40 35 45 30 M30 35 Q42 45 48 40 M30 45 Q40 55 45 50" stroke="${patternColor}" stroke-width="0.5"/>`;
    }
    else if (patternType === 18) {
        // [皇冠] 王权
        svgContent += `<path d="M15 50 L15 35 L22 45 L30 30 L38 45 L45 35 L45 50 Z" fill="none" stroke="${goldColor}" stroke-width="1.5"/>`;
        svgContent += `<circle cx="30" cy="30" r="2" fill="${goldColor}"/>`;
        svgContent += `<circle cx="15" cy="35" r="1.5" fill="${goldColor}"/>`;
        svgContent += `<circle cx="45" cy="35" r="1.5" fill="${goldColor}"/>`;
    }
    else if (patternType === 19) {
        // [钥匙] 秘密/解答
        svgContent += `<circle cx="30" cy="30" r="8" fill="none" stroke="${goldColor}" stroke-width="1.5"/>`;
        svgContent += `<line x1="30" y1="38" x2="30" y2="70" stroke="${goldColor}" stroke-width="2"/>`;
        svgContent += `<path d="M30 60 L37 60 M30 67 L35 67" stroke="${goldColor}" stroke-width="2"/>`;
    }
    else if (patternType === 20) {
        // [沙漏] 时间
        svgContent += `<path d="M20 20 L40 20 L30 45 L40 70 L20 70 L30 45 Z" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<line x1="18" y1="20" x2="42" y2="20" stroke="${goldColor}" stroke-width="2"/>`;
        svgContent += `<line x1="18" y1="70" x2="42" y2="70" stroke="${goldColor}" stroke-width="2"/>`;
    }
    else if (patternType === 21) {
        // [蛇杖] 医学/智慧
        svgContent += `<line x1="30" y1="20" x2="30" y2="75" stroke="${patternColor}" stroke-width="2"/>`;
        svgContent += `<path d="M30 25 Q40 30 30 40 Q20 50 30 55 Q40 60 30 70" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<circle cx="30" cy="18" r="3" fill="${goldColor}"/>`;
    }
    else if (patternType === 22) {
        // [波浪] 海洋/流动
        svgContent += `<path d="M10 35 Q20 25 30 35 Q40 45 50 35" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<path d="M10 50 Q20 40 30 50 Q40 60 50 50" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<path d="M10 65 Q20 55 30 65 Q40 75 50 65" fill="none" stroke="${patternColor}" stroke-width="0.5"/>`;
    }
    else if (patternType === 23) {
        // [原子] 科学
        svgContent += `<circle cx="30" cy="45" r="4" fill="${goldColor}"/>`;
        svgContent += `<ellipse cx="30" cy="45" rx="20" ry="8" fill="none" stroke="${patternColor}" stroke-width="0.5"/>`;
        svgContent += `<ellipse cx="30" cy="45" rx="20" ry="8" fill="none" stroke="${patternColor}" stroke-width="0.5" transform="rotate(60 30 45)"/>`;
        svgContent += `<ellipse cx="30" cy="45" rx="20" ry="8" fill="none" stroke="${patternColor}" stroke-width="0.5" transform="rotate(120 30 45)"/>`;
    }
    else if (patternType === 24) {
        // [棋盘] 策略/游戏
        for (let x = 15; x < 45; x += 10) {
            for (let y = 25; y < 65; y += 10) {
                if ((x + y) % 20 === 5) {
                    svgContent += `<rect x="${x}" y="${y}" width="10" height="10" fill="${patternColor}" opacity="0.3"/>`;
                }
            }
        }
        svgContent += `<rect x="15" y="25" width="30" height="40" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
    }
    else if (patternType === 25) {
        // [眼睛] 观察/真理
        svgContent += `<ellipse cx="30" cy="45" rx="18" ry="12" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<circle cx="30" cy="45" r="8" fill="none" stroke="${patternColor}" stroke-width="1"/>`;
        svgContent += `<circle cx="30" cy="45" r="4" fill="${goldColor}"/>`;
    }
    else if (patternType === 26) {
        // [迷宫] 探索/复杂
        svgContent += `<rect x="15" y="20" width="30" height="50" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<path d="M15 35 L35 35 L35 50 L20 50 L20 40 L30 40" fill="none" stroke="${patternColor}" stroke-width="0.5"/>`;
        svgContent += `<path d="M45 55 L25 55 L25 60 L40 60" fill="none" stroke="${patternColor}" stroke-width="0.5"/>`;
    }
    else if (patternType === 27) {
        // [阴阳] 平衡/哲学
        svgContent += `<circle cx="30" cy="45" r="18" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<path d="M30 27 A9 9 0 0 1 30 45 A9 9 0 0 0 30 63 A18 18 0 0 1 30 27" fill="${patternColor}" opacity="0.3"/>`;
        svgContent += `<circle cx="30" cy="36" r="3" fill="${goldColor}"/>`;
        svgContent += `<circle cx="30" cy="54" r="3" fill="${baseColor}" stroke="${goldColor}" stroke-width="0.5"/>`;
    }
    else if (patternType === 28) {
        // [火焰] 激情/毁灭
        svgContent += `<path d="M30 70 Q20 55 25 45 Q20 35 30 20 Q40 35 35 45 Q40 55 30 70" fill="none" stroke="${goldColor}" stroke-width="1"/>`;
        svgContent += `<path d="M30 65 Q25 55 28 48 Q25 42 30 30 Q35 42 32 48 Q35 55 30 65" fill="${patternColor}" opacity="0.3"/>`;
    }
    else if (patternType === 29) {
        // [无限符号] 永恒
        svgContent += `<path d="M15 45 Q15 30 25 30 Q35 30 35 45 Q35 60 45 60 Q55 60 55 45 Q55 30 45 30 Q35 30 35 45 Q35 60 25 60 Q15 60 15 45" fill="none" stroke="${goldColor}" stroke-width="1.5"/>`;
    }

    // 4. 生成 SVG
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 90" preserveAspectRatio="none">
            <defs>${filter}</defs>
            ${svgContent}
            <rect width="100%" height="100%" fill="url(#grad)" style="mix-blend-mode: overlay; opacity: 0.3" />
            <defs>
                <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#fff" stop-opacity="0.2"/>
                    <stop offset="5%" stop-color="#fff" stop-opacity="0"/>
                    <stop offset="90%" stop-color="#000" stop-opacity="0"/>
                    <stop offset="100%" stop-color="#000" stop-opacity="0.4"/>
                </linearGradient>
            </defs>
        </svg>
    `;
}

// ============================================================
// 应用初始化
// ============================================================

/**
 * DOM 加载完成后的初始化逻辑
 * 加载游戏数据、创建背景、绑定事件监听器
 */
document.addEventListener('DOMContentLoaded', () => {
    // 1. 核心数据加载
    loadGame();
    createStars();
    
    

    
    // 初始化时禁用需要页面数据的控件
    
    // 2. XP 设置初始化
    const xpSettings = JSON.parse(localStorage.getItem('babelXpSettings') || '{"float":true,"panel":true}');
    const floatCheck = document.getElementById('showXpFloat');
    const panelCheck = document.getElementById('showXpPanel');
    
    if (floatCheck) floatCheck.checked = xpSettings.float;
    if (panelCheck) panelCheck.checked = xpSettings.panel;

    // 绑定设置变更事件
    if (floatCheck) {
        floatCheck.onchange = function() {
            const settings = JSON.parse(localStorage.getItem('babelXpSettings') || '{}');
            settings.float = this.checked;
            localStorage.setItem('babelXpSettings', JSON.stringify(settings));
        };
    }
    
    if (panelCheck) {
        panelCheck.onchange = function() {
            const settings = JSON.parse(localStorage.getItem('babelXpSettings') || '{}');
            settings.panel = this.checked;
            localStorage.setItem('babelXpSettings', JSON.stringify(settings));
        };
    }
    
    // 3. 初始禁用导航按钮 (未打开书本时)
    const navBtns = ['navWallBtn', 'navShelfUp', 'navShelfDown', 'navVolLeft', 'navVolRight'];
    navBtns.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = true;
    });
    
    document.querySelectorAll('nav button').forEach(b => {
        b.onclick = () => showSection(b.dataset.section);
    });
    
    document.getElementById('prevBtn').onclick = async () => {
        if (state.page > 1 && state.hex) {
            await displayPage(state.hex, state.wall, state.shelf, state.volume, state.page - 1, state.searchTerm);
        }
    };
    document.getElementById('nextBtn').onclick = async () => {
        if (state.page < PAGES && state.hex) {
            await displayPage(state.hex, state.wall, state.shelf, state.volume, state.page + 1, state.searchTerm);
        }
    };
    document.getElementById('pageInput').onchange = async function() {
        if (!state.hex) return;
        let p = Math.max(1, Math.min(PAGES, +this.value || 1));
        await displayPage(state.hex, state.wall, state.shelf, state.volume, p, state.searchTerm);
    };
    
    document.getElementById('readableToggle').onclick = async function() {
        state.readable = !state.readable;
        this.classList.toggle('active', state.readable);
        document.getElementById('readableLegend').classList.toggle('show', state.readable);
        if (state.hex) await displayPage(state.hex, state.wall, state.shelf, state.volume, state.page, state.searchTerm);
    };
    
    document.getElementById('searchBtn').onclick = doSearch;
    document.getElementById('searchInput').oninput = function() {
        const len = this.value.replace(/[^a-z ,.]/gi, '').length;
        const c = document.getElementById('searchCharCount');
        c.textContent = `${len} / ${PAGE_LEN} 字符`;
        c.classList.toggle('warning', len > PAGE_LEN);
    };
    
    // ... 在 document.addEventListener('DOMContentLoaded', ...) 内部 ...

    // ============================================================
    // 空间漫游逻辑
    // ============================================================
    
    // 1. 书架漫游 (Shelf 1-5)
    // 向上移动书架 (循环: 1 -> 5)
    document.getElementById('navShelfUp').onclick = async () => {
        if (!state.hex || computing) return;
        let newShelf = state.shelf - 1;
        if (newShelf < 1) newShelf = SHELVES; 
        
        await displayPage(state.hex, state.wall, newShelf, state.volume, state.page, state.searchTerm);
        showToast(`⬆️ 移动至第 ${newShelf} 层书架`);
    };
    
    // 向下移动书架 (循环: 5 -> 1)
    document.getElementById('navShelfDown').onclick = async () => {
        if (!state.hex || computing) return;
        let newShelf = state.shelf + 1;
        if (newShelf > SHELVES) newShelf = 1;

        await displayPage(state.hex, state.wall, newShelf, state.volume, state.page, state.searchTerm);
        showToast(`⬇️ 移动至第 ${newShelf} 层书架`);
    };
    
    // 2. 墙面导航按钮
    document.getElementById('navWallBtn').onclick = openWallNav;
    
    // 初始化时显示当前墙号
    document.getElementById('currentWallNum').textContent = state.wall || 1;

    // 3. 卷宗漫游 (Volume 1-32)
    // 向左取出书籍 (循环: 1 -> 32)
    document.getElementById('navVolLeft').onclick = async () => {
        if (!state.hex || computing) return;
        let newVol = state.volume - 1;
        if (newVol < 1) newVol = VOLUMES; 

        await displayPage(state.hex, state.wall, state.shelf, newVol, state.page, state.searchTerm);
        showToast(`⬅️ 取出左侧书籍 (卷${newVol})`);
    };

    // 向右取出书籍 (循环: 32 -> 1)
    document.getElementById('navVolRight').onclick = async () => {
        if (!state.hex || computing) return;
        let newVol = state.volume + 1;
        if (newVol > VOLUMES) newVol = 1;

        await displayPage(state.hex, state.wall, state.shelf, newVol, state.page, state.searchTerm);
        showToast(`➡️ 取出右侧书籍 (卷${newVol})`);
    };
    
    // 4. 随机跳转
    document.getElementById('randomBtn').onclick = goRandom;
    
// === 在 DOMContentLoaded 内部添加 ===

    // ============================================================
    // 编码选择器逻辑
    // ============================================================
    
    // 编码显示名称映射表
    const encodingDisplayNames = {
        'b36': 'Base36',
        'b85': 'Base85', 
        'b16k': 'Base16k',
        'b20k': 'Base20k',
        'b27k': 'Base27k',
        'b65k': 'Base65k',
        'b11m': 'Base1.1M'
    };
    
    /**
     * 打开编码选择弹窗
     * 高亮当前选中的编码选项
     */
    window.openEncodingModal = function() {
        const modal = document.getElementById('encodingModal');
        modal.classList.add('active');
        
        // 高亮当前选中的编码
        document.querySelectorAll('.encoding-option').forEach(opt => {
            opt.classList.remove('selected');
            if (opt.dataset.encoding === state.encodingMode) {
                opt.classList.add('selected');
            }
        });
    };
    
    /**
     * 关闭编码选择弹窗
     */
    window.closeEncodingModal = function() {
        document.getElementById('encodingModal').classList.remove('active');
    };
    
    // 绑定打开按钮
    document.getElementById('encodingSelectorBtn').onclick = openEncodingModal;
    
    // 绑定编码选项点击事件
    document.querySelectorAll('.encoding-option').forEach(opt => {
        opt.onclick = function() {
            const newMode = this.dataset.encoding;
            const oldHex = state.hex;
            
            // 更新选中状态
            document.querySelectorAll('.encoding-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            
            // 如果当前没有坐标，直接更新状态
            if (!oldHex) {
                state.encodingMode = newMode;
                localStorage.setItem('babelEncodingMode', newMode);
                document.getElementById('currentEncodingName').textContent = encodingDisplayNames[newMode];
                closeEncodingModal();
                showToast(`✨ 已切换到 ${encodingDisplayNames[newMode]} 编码`);
                return;
            }

            try {
                // 解析旧坐标为 BigInt
                const fullNum = fromHex(oldHex);

                // 切换到新编码模式
                state.encodingMode = newMode;
                localStorage.setItem('babelEncodingMode', newMode);
                
                // 重新编码为新格式
                const newFullHex = toHex(fullNum);

                // 更新系统状态和 UI
                state.hex = newFullHex;
                
                const coordStr = `${newFullHex}-w${state.wall}-s${state.shelf}-v${state.volume}-p${state.page}`;
                document.getElementById('fullCoordinate').textContent = coordStr;
                document.getElementById('hexLength').textContent = [...newFullHex].length;
                document.getElementById('currentEncodingName').textContent = encodingDisplayNames[newMode];

                // 更新分析面板的编码类型标签
                document.getElementById('coordTypeLabel').textContent = encodingDisplayNames[newMode] + ' 编码';
                
                closeEncodingModal();
                showToast(`✨ 已转换为 ${encodingDisplayNames[newMode]} 编码`);

            } catch (e) {
                console.error("编码转换失败", e);
                showToast('⚠️ 编码转换出现错误');
            }
        };
    });
    
    // 点击弹窗背景关闭
    document.getElementById('encodingModal').onclick = function(e) {
        if (e.target === this) closeEncodingModal();
    };
    
    // ESC 键关闭弹窗
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('encodingModal').classList.contains('active')) {
            closeEncodingModal();
        }
    });
    
    // ============================================================
    // 书名模式选择器逻辑
    // ============================================================
    
    // 书名模式显示名称映射
    const titleModeDisplayNames = {
        'single': '统一书名',
        'wall': '每墙不同',
        'wall-shelf': '每墙每架不同',
        'full': '每本不同',
        'mask-keep': '掩码派生A',
        'mask-vary': '掩码派生B'
    };
    
    /**
     * 打开书名模式选择弹窗
     * 高亮当前选中的模式选项
     */
    window.openTitleModeModal = function() {
        const modal = document.getElementById('titleModeModal');
        modal.classList.add('active');
        
        // 高亮当前选中的模式
        document.querySelectorAll('#titleModeModal .encoding-option').forEach(opt => {
            opt.classList.remove('selected');
            if (opt.dataset.titlemode === state.titleMode) {
                opt.classList.add('selected');
            }
        });
    };
    
    /**
     * 关闭书名模式选择弹窗
     */
    window.closeTitleModeModal = function() {
        document.getElementById('titleModeModal').classList.remove('active');
    };
    
    // 绑定打开按钮
    document.getElementById('titleModeSelectorBtn').onclick = openTitleModeModal;
    
    // 绑定书名模式选项点击事件
    document.querySelectorAll('#titleModeModal .encoding-option').forEach(opt => {
        opt.onclick = function() {
            const newMode = this.dataset.titlemode;
            
            // 更新选中状态
            document.querySelectorAll('#titleModeModal .encoding-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            
            // 更新状态
            state.titleMode = newMode;
            localStorage.setItem('babelTitleMode', newMode);
            document.getElementById('currentTitleModeName').textContent = titleModeDisplayNames[newMode];
            
            closeTitleModeModal();
            showToast(`📚 已切换到「${titleModeDisplayNames[newMode]}」模式`);
            
            // 如果当前有显示的页面，刷新书名显示
            if (state.hex) {
                const newTitle = getDisplayTitle(state.hex, state.wall, state.shelf, state.volume);
                document.getElementById('bookTitle').textContent = newTitle;
            }
        };
    });
    
    // 点击弹窗背景关闭
    document.getElementById('titleModeModal').onclick = function(e) {
        if (e.target === this) closeTitleModeModal();
    };
    
    // 更新书名模式按钮显示
    const titleModeNameEl = document.getElementById('currentTitleModeName');
    if (titleModeNameEl && titleModeDisplayNames[state.titleMode]) {
        titleModeNameEl.textContent = titleModeDisplayNames[state.titleMode];
    }
    
    // 更新编码模式按钮显示
    const encodingNameEl = document.getElementById('currentEncodingName');
    if (encodingNameEl && encodingDisplayNames[state.encodingMode]) {
        encodingNameEl.textContent = encodingDisplayNames[state.encodingMode];
    }

    // ============================================================
    // 跳转 (Goto) 功能逻辑
    // ============================================================

    // 绑定跳转按钮点击事件 (支持坐标前缀解析)
    document.getElementById('gotoBtn').onclick = async function() {
        if (computing) return;
        const input = document.getElementById('coordinateInput').value.trim();
        
        // 解析坐标格式：hex-w墙-s架-v卷-p页
        const parseCoord = (str) => {
            const pattern = /^(.+)-w(\d+)-s(\d+)-v(\d+)-p(\d+)$/i;
            const match = str.match(pattern);
            if (match) {
                return {
                    hex: match[1],
                    wall: parseInt(match[2]),
                    shelf: parseInt(match[3]),
                    volume: parseInt(match[4]),
                    page: parseInt(match[5])
                };
            }
            return null;
        };
        
        const c = parseCoord(input);
        
        if (c && c.hex) {
            // 验证物理地址范围
            if (c.wall < 1 || c.wall > WALLS) {
                alert(`墙编号必须在 1-${WALLS} 之间`);
                return;
            }
            if (c.shelf < 1 || c.shelf > SHELVES) {
                alert(`架编号必须在 1-${SHELVES} 之间`);
                return;
            }
            if (c.volume < 1 || c.volume > VOLUMES) {
                alert(`卷编号必须在 1-${VOLUMES} 之间`);
                return;
            }
            if (c.page < 1 || c.page > PAGES) {
                alert(`页编号必须在 1-${PAGES} 之间`);
                return;
            }
            
            // 检测坐标中的书名模式
            const { detectedTitleMode } = fromHexWithMode(c.hex);
            
            if (detectedTitleMode && detectedTitleMode !== state.titleMode) {
                // 自动切换到坐标指定的书名模式
                state.titleMode = detectedTitleMode;
                localStorage.setItem('babelTitleMode', detectedTitleMode);
                
                const titleModeDisplayNames = {
                    'single': '统一书名',
                    'wall': '每墙不同',
                    'wall-shelf': '每墙每架不同',
                    'full': '每本不同',
                    'mask-keep': '掩码派生A',
                    'mask-vary': '掩码派生B'
                };
                
                const displayName = titleModeDisplayNames[detectedTitleMode] || detectedTitleMode;
                document.getElementById('currentTitleModeName').textContent = displayName;
                showToast(`📚 已自动切换到「${displayName}」模式`);
            }
            
            // 同时检测并自动切换编码模式
            const encMatch = c.hex.match(/^([a-z0-9]+)[.:]/);
            if (encMatch && ENCODINGS[encMatch[1]] && encMatch[1] !== state.encodingMode) {
                state.encodingMode = encMatch[1];
                localStorage.setItem('babelEncodingMode', encMatch[1]);
                
                const encodingDisplayNames = {
                    'b36': 'Base36', 'b85': 'Base85', 'b16k': 'Base16k',
                    'b20k': 'Base20k', 'b27k': 'Base27k', 'b65k': 'Base65k', 'b11m': 'Base1.1M'
                };
                
                const displayName = encodingDisplayNames[encMatch[1]] || encMatch[1];
                document.getElementById('currentEncodingName').textContent = displayName;
                showToast(`✨ 已自动切换到 ${displayName} 编码`);
            }
            
            await displayPage(c.hex, c.wall, c.shelf, c.volume, c.page, '');
            
        } else {
            alert('坐标格式无效\n格式: hex-w墙-s架-v卷-p页\n例如: b16k.ws:一二三四五-w1-s2-v3-p4');
        }
    };
    
    // 绑定其他按钮事件
    document.getElementById('addBookmarkBtn').onclick = addBookmark;
    document.getElementById('copyCoordBtn').onclick = copyCoord;
    
    renderBookmarks();
});

// ============================================================
// 墙面导航系统 (Hex Navigation)
// ============================================================

/**
 * 打开墙面导航弹窗 (Hex 内部导航)
 * 显示 4 面墙的选择界面，并绑定点击事件
 */
function openWallNav() {
    const modal = document.getElementById('wallNavModal');
    modal.classList.add('active');
    
    // 高亮当前所在的墙
    document.querySelectorAll('.hex-wall-btn').forEach(btn => {
        btn.classList.remove('active');
        // 将 data-wall="1" 转换为数字进行比较
        if (parseInt(btn.dataset.wall) === state.wall) {
            btn.classList.add('active');
        }
        
        // 绑定点击事件 (防止重复绑定，先解绑)
        btn.onclick = null; 
        btn.onclick = async function() {
            const selectedWall = parseInt(this.dataset.wall);
            if (selectedWall !== state.wall) {
                // 播放一个小的音效或者震动反馈（可选）
                if(navigator.vibrate) navigator.vibrate(10);
                
                // 执行跳转
                await displayPage(state.hex, selectedWall, state.shelf, state.volume, state.page, state.searchTerm);
                
                // 更新UI显示的墙号
                document.getElementById('currentWallNum').textContent = selectedWall;
                
                showToast(`🔄 已转身面向第 ${selectedWall} 面墙`);
            }
            closeWallNav();
        };
    });
    
    // 绑定通道按钮事件 (左侧通道)
    document.getElementById('passageLeft').onclick = async function() {
        if (!state.hex || computing) return;
        // 生成相邻六边形坐标（通过修改hex的一部分来模拟移动）
        const newHex = navigateToAdjacentHex(state.hex, 'left');
        closeWallNav();
        await displayPage(newHex, state.wall, state.shelf, state.volume, state.page, '');
        showToast('🚶 穿过左侧通道，进入相邻六边形');
    };
    
    // 绑定通道按钮事件 (右侧通道)
    document.getElementById('passageRight').onclick = async function() {
        if (!state.hex || computing) return;
        const newHex = navigateToAdjacentHex(state.hex, 'right');
        closeWallNav();
        await displayPage(newHex, state.wall, state.shelf, state.volume, state.page, '');
        showToast('🚶 穿过右侧通道，进入相邻六边形');
    };
}

/**
 * 关闭墙面导航弹窗
 */
function closeWallNav() {
    document.getElementById('wallNavModal').classList.remove('active');
}

// ============================================================
// 相邻六边形导航算法
// ============================================================

/**
 * 计算相邻六边形的坐标
 * 模拟在无限六边形网格中的移动
 * 
 * @param {string} currentHex 当前六边形坐标
 * @param {'left'|'right'} direction 移动方向
 * @returns {string} 新的六边形坐标
 */
function navigateToAdjacentHex(currentHex, direction) {
    const fullNum = fromHex(currentHex);
    let contentNum = fullNum % PAGE_SPACE;
    let titlesNum = fullNum / PAGE_SPACE;
    
    if (contentNum < 100n) {
        const rng = mulberry32(Date.now());
        contentNum = 0n;
        const encoder = ENCODINGS[state.encodingMode];
        for (let i = 0; i < 30; i++) {
            contentNum = contentNum * encoder.size + BigInt(Math.floor(rng() * Number(encoder.size)));
        }
    }
    
    const mode = state.titleMode;
    const modeConfig = TITLE_MODES[mode];
    
    // 生成均匀分布的偏移（在 UNIFORM_TITLE_SPACE 内）
    const generateUniformOffset = (seedNum, index, spaceSize) => {
        const seed1 = Number((seedNum >> 0n) % 0xFFFFFFFFn) ^ (index * 0x9E3779B9);
        const seed2 = Number((seedNum >> 32n) % 0xFFFFFFFFn) ^ (index * 0x85EBCA6B);
        const seed3 = Number((seedNum >> 64n) % 0xFFFFFFFFn) ^ (index * 0xC2B2AE35);
        
        const rng1 = mulberry32(Math.abs(seed1) + 1);
        const rng2 = mulberry32(Math.abs(seed2) + 1);
        const rng3 = mulberry32(Math.abs(seed3) + 1);
        
        // 生成覆盖整个空间的偏移
        let offset = 0n;
        const rngs = [rng1, rng2, rng3];
        // 需要约 log29(spaceSize) 位数字
        for (let i = 0; i < 40; i++) {  // 40位足够覆盖 25 * 29^25
            offset = offset * 29n + BigInt(Math.floor(rngs[i % 3]() * 29));
        }
        
        return offset % spaceSize;
    };
    
    const titleSpace = SINGLE_TITLE_SPACE;
    
    if (direction === 'left') {
        const targetContent = contentNum - 1n < 0n ? PAGE_SPACE - 1n : contentNum - 1n;
        
        if (mode === 'mask-keep' || mode === 'mask-vary' || modeConfig.count === 1) {
            const offset = generateUniformOffset(targetContent, 0, titleSpace);
            titlesNum = (titlesNum + offset) % titleSpace;
        } else {
            const count = modeConfig.count;
            const titles = [];
            let temp = titlesNum;
            for (let i = count - 1; i >= 0; i--) {
                titles[i] = temp % titleSpace;
                temp = temp / titleSpace;
            }
            for (let i = 0; i < count; i++) {
                const offset = generateUniformOffset(targetContent, i, titleSpace);
                titles[i] = (titles[i] + offset) % titleSpace;
            }
            titlesNum = 0n;
            for (let i = 0; i < count; i++) {
                titlesNum = titlesNum * titleSpace + titles[i];
            }
        }
        contentNum = targetContent;
        
    } else {
        if (mode === 'mask-keep' || mode === 'mask-vary' || modeConfig.count === 1) {
            const offset = generateUniformOffset(contentNum, 0, titleSpace);
            titlesNum = (titlesNum + titleSpace - offset) % titleSpace;
        } else {
            const count = modeConfig.count;
            const titles = [];
            let temp = titlesNum;
            for (let i = count - 1; i >= 0; i--) {
                titles[i] = temp % titleSpace;
                temp = temp / titleSpace;
            }
            for (let i = 0; i < count; i++) {
                const offset = generateUniformOffset(contentNum, i, titleSpace);
                titles[i] = (titles[i] + titleSpace - offset) % titleSpace;
            }
            titlesNum = 0n;
            for (let i = 0; i < count; i++) {
                titlesNum = titlesNum * titleSpace + titles[i];
            }
        }
        contentNum = contentNum + 1n;
        if (contentNum >= PAGE_SPACE) contentNum = 0n;
    }
    
    const newFullNum = titlesNum * PAGE_SPACE + contentNum;
    return toHex(newFullNum);
}

// ============================================================
// 全局事件监听器
// ============================================================

// 点击模态框背景关闭
document.getElementById('wallNavModal').onclick = function(e) {
    if (e.target === this) closeWallNav();
};

// 键盘快捷键监听
document.addEventListener('keydown', (e) => {
    // W 键打开墙面导航
    if (e.key.toLowerCase() === 'w' && !document.querySelector('textarea:focus') && !document.querySelector('input:focus')) {
        openWallNav();
    }
    // ESC 键关闭
    if (e.key === 'Escape') {
        closeWallNav();
    }
});

// ============================================================
// 辅助分析函数
// ============================================================

/**
 * 分析页面文本的统计特征
 * 计算熵值和语义评分，用于辅助判断页面是否有意义
 * 
 * @param {string} text 页面文本
 * @returns {{entropy: number, semanticScore: number}} 统计结果
 */
function analyzePageStats(text) {
    if (!text) return { entropy: 0, semanticScore: 0 };
    
    // 熵
    const entropy = calculateEntropy(text);
    
    // 语义分
    let totalScore = 0;
    let wordCount = 0;
    const tokens = text.split(/[^a-zA-Z]+/); 
    for (const token of tokens) {
        if (token.length > 1) { 
            wordCount++;
            const s = scoreWord(token);
            if (s >= 1000) totalScore += 100;
            else if (s >= 55) totalScore += 20; 
            else if (s >= 35) totalScore += 5;
        }
    }
    const semanticScore = wordCount > 0 ? (totalScore / wordCount) : 0;
    
    return { entropy, semanticScore };
}

// ============================================================
// 调试与重置
// ============================================================

/**
 * 重置游戏数据
 * 清除所有进度、成就、书签和设置，并刷新页面
 * (通常用于调试或完全重开)
 */
function resetGameData() {
    if (confirm('⚠️ 警告：这将清除所有进度！\n\n包括：\n- 探索等级和经验值\n- 解锁的所有成就\n- 访问统计数据\n- 所有保存的书签\n\n确定要重新开始吗？')) {
        // 清除 LocalStorage
        localStorage.removeItem('babelGameData');
        localStorage.removeItem('babelBookmarks4');
        localStorage.removeItem('babelXpSettings'); // 可选：也重置设置
        
        // 刷新页面
        showToast('数据已重置，正在重载...');
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}

</script>
</body>
</html>
