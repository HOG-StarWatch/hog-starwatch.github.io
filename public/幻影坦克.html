<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幻影坦克图片合成工具</title>
</head>
<body>
    <h1>幻影坦克图片合成工具</h1>
    <p>上传两张图片，生成在白色和黑色背景下显示不同图像的PNG图片</p>
    
    <form id="uploadForm">
        <h2>第一步：上传图片</h2>
        <p>白色背景下显示的图片（较亮的图）：</p>
        <input type="file" id="whiteBgImage" accept="image/*" required>
        
        <p>黑色背景下显示的图片（较暗的图）：</p>
        <input type="file" id="blackBgImage" accept="image/*" required>
        
        <h2>第二步：调整参数（可选）</h2>
        <p>暗图调整参数 a: <input type="number" id="paramA" value="0.5" step="0.1" min="0" max="1"></p>
        <p>暗图调整参数 b: <input type="number" id="paramB" value="20" step="1" min="0" max="100"></p>
        
        <h2>第三步：生成并下载</h2>
        <button type="button" id="generateBtn">生成幻影坦克图片</button>
    </form>
    
    <div id="result" style="display:none;">
        <h2>生成结果</h2>
        <p>右键点击图片选择"另存为"下载图片</p>
        <img id="outputImage" alt="幻影坦克合成结果">
    </div>
    
    <script>
        document.getElementById('generateBtn').addEventListener('click', function() {
            const whiteBgFile = document.getElementById('whiteBgImage').files[0];
            const blackBgFile = document.getElementById('blackBgImage').files[0];
            const paramA = parseFloat(document.getElementById('paramA').value);
            const paramB = parseInt(document.getElementById('paramB').value);
            
            if (!whiteBgFile || !blackBgFile) {
                alert('请先上传两张图片！');
                return;
            }
            
            const reader1 = new FileReader();
            const reader2 = new FileReader();
            
            reader1.onload = function(e1) {
                reader2.onload = function(e2) {
                    // 创建图像对象
                    const img1 = new Image();
                    const img2 = new Image();
                    
                    img1.onload = function() {
                        img2.onload = function() {
                            // 创建画布进行处理
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // 设置画布大小为第一张图片的大小
                            canvas.width = img1.width;
                            canvas.height = img1.height;
                            
                            // 绘制第一张图片（白色背景显示）
                            ctx.drawImage(img1, 0, 0);
                            const imageData1 = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            // 绘制第二张图片（黑色背景显示）
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img2, 0, 0, canvas.width, canvas.height);
                            const imageData2 = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            // 处理图像数据
                            const data1 = imageData1.data;
                            const data2 = imageData2.data;
                            const outputData = new Uint8ClampedArray(data1.length);
                            
                            for (let i = 0; i < data1.length; i += 4) {
                                // 获取两个图像的RGB值
                                const r1 = data1[i];
                                const g1 = data1[i + 1];
                                const b1 = data1[i + 2];
                                
                                const r2 = data2[i];
                                const g2 = data2[i + 1];
                                const b2 = data2[i + 2];
                                
                                // 转换为灰度值
                                const gray1 = 0.299 * r1 + 0.587 * g1 + 0.114 * b1;
                                const gray2 = 0.299 * r2 + 0.587 * g2 + 0.114 * b2;
                                
                                // 调整暗图
                                const adjustedGray2 = paramA * gray2 + paramB;
                                
                                // 计算alpha通道
                                let alpha = 255 - gray1 + adjustedGray2;
                                alpha = Math.max(1, Math.min(alpha, 255));
                                
                                // 计算输出像素值
                                const outputValue = (gray2 / (alpha / 255)) * (paramA / 0.5);
                                const clampedOutput = Math.max(0, Math.min(outputValue, 255));
                                
                                // 设置输出RGBA
                                outputData[i] = clampedOutput;     // R
                                outputData[i + 1] = clampedOutput; // G
                                outputData[i + 2] = clampedOutput; // B
                                outputData[i + 3] = alpha;         // A
                            }
                            
                            // 创建输出图像
                            const outputImageData = new ImageData(outputData, canvas.width, canvas.height);
                            ctx.putImageData(outputImageData, 0, 0);
                            
                            // 显示结果
                            const outputImage = document.getElementById('outputImage');
                            outputImage.src = canvas.toDataURL('image/png');
                            document.getElementById('result').style.display = 'block';
                        };
                        img2.src = e2.target.result;
                    };
                    img1.src = e1.target.result;
                };
                reader2.readAsDataURL(blackBgFile);
            };
            reader1.readAsDataURL(whiteBgFile);
        });
    </script>
    
    <footer>
        <p>幻影坦克原理：通过调整PNG图片的透明度通道，实现在不同背景色下显示不同的图像</p>
    </footer>
</body>
</html>