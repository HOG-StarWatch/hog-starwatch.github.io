<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PixivåŸå›¾i.pximg.net</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a2e;
            color: #e6e6fa;
        }

        .container {
            background: #2a2a3a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #b19cd9;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #b19cd9;
        }

        input[type="url"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #4b0082;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: #3a3a4a;
            color: #e6e6fa;
        }

        input[type="url"]:focus {
            border-color: #9370db;
            outline: none;
        }

        select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #4b0082;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: #3a3a4a;
            color: #e6e6fa;
            margin-bottom: 10px;
        }

        select:focus {
            border-color: #9370db;
            outline: none;
        }

        .custom-proxy-input {
            display: none;
            margin-top: 10px;
        }

        button {
            padding: 12px;
            font-size: 16px;
            background-color: #6a5acd;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #9370db;
        }

        .button-row {
            display: flex;
            gap: 10px;
        }

        .button-row button {
            flex: 1;
        }

        .image-container {
            margin-top: 30px;
            border: 1px solid #4b0082;
            border-radius: 6px;
            overflow: hidden;
        }

        .image-label {
            background: #4b0082;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #4b0082;
            color: white;
        }

        .image-wrapper {
            width: 100%;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }

        .scaled-image {
            max-width: 100%;
            max-height: 600px;
            object-fit: contain;
        }

        .original-image {
            max-width: none;
            max-height: none;
            width: auto;
            height: auto;
        }

        .error {
            color: #ff6b6b;
            background: #3a1a1a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #ff6b6b;
        }

        .info {
            background: #2a3a4a;
            color: #add8e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .result-link-container {
            margin-top: 20px;
            padding: 15px;
            background: #3a3a4a;
            border-radius: 6px;
            border: 1px solid #4b0082;
        }
        
        .result-link-label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            color: #b19cd9;
        }
        
        .result-link {
            word-break: break-all;
            padding: 10px;
            background: #2a2a3a;
            border: 1px solid #4b0082;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            color: #e6e6fa;
        }
        
        .result-link:hover {
            background: #3a3a4a;
        }
        
        .copy-notification {
            position: absolute;
            top: -30px;
            right: 0;
            background: #6a5acd;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .show-copy-notification {
            opacity: 1;
        }

        .button-container {
            display: flex;
            justify-content: flex-end;
            padding: 10px;
            background: #3a3a4a;
            border-top: 1px solid #4b0082;
        }

        .show-original-btn {
            width: auto;
            margin-top: 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .secret-settings {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .secret-settings-content {
            background: #2a2a3a;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .secret-settings h2 {
            color: #b19cd9;
            margin-bottom: 20px;
            text-align: center;
        }

        .secret-input-group {
            margin-bottom: 20px;
        }

        .secret-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #b19cd9;
        }

        .secret-input-group input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #4b0082;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: #3a3a4a;
            color: #e6e6fa;
        }

        .secret-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .secret-buttons button {
            flex: 1;
        }

        .close-secret {
            background: #ff6b6b !important;
        }

        .close-secret:hover {
            background: #ff5252 !important;
        }

        /* å¿«é€Ÿè®¿é—®æŒ‰é’®å®¹å™¨ */
        .quick-access-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
            display: none; /* é»˜è®¤éšè— */
        }

        /* å¿«é€Ÿè®¿é—®æŒ‰é’®æ ·å¼ */
        .quick-access-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-top: 0; /* Override default button margin */
        }

        .quick-access-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }

        /* è¯¦æƒ…ä¿¡æ¯å®¹å™¨ */
        .details-container {
            margin-top: 15px;
            background: #2a2a3a;
            border: 1px solid #4b0082;
            border-radius: 6px;
            padding: 15px;
            display: none; /* é»˜è®¤éšè— */
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: #b19cd9;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .detail-value {
            color: #e6e6fa;
            word-break: break-all;
        }

        /* æ ‡ç­¾æ ·å¼ */
        .tag-pill {
            display: inline-block;
            background: #4b0082;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* åŠŸèƒ½åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .function-toggle {
            display: flex;
            margin-bottom: 20px;
            border: 1px solid #4b0082;
            border-radius: 6px;
            overflow: hidden;
        }

        .function-toggle button {
            flex: 1;
            margin: 0;
            border-radius: 0;
            background-color: #3a3a4a;
        }

        .function-toggle button.active {
            background-color: #6a5acd;
        }

        /* Gallery Layout Styles */
        .gallery-body {
            display: flex;
            gap: 20px;
            height: 70vh; /* Fixed height for internal scrolling */
            margin-top: 10px;
        }

        .gallery-sidebar {
            width: 250px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
            border-right: 1px solid #4b0082;
            padding-right: 15px;
        }

        .gallery-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Crucial for flex child overflow */
        }

        .gallery-table-container {
            flex: 1;
            overflow: auto; /* Both horizontal and vertical scroll */
            border: 1px solid #4b0082;
            border-radius: 6px;
        }
        
        /* --- Gallery Table Styles (maintainability) --- */
        .gallery-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            font-size: 14px;
        }
        .gallery-table thead {
            background: #4b0082;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .gallery-table th, .gallery-table td {
            padding: 10px;
        }
        .gallery-table th.th-center { text-align: center; }
        .gallery-table th.th-left { text-align: left; }
        .gallery-row { border-bottom: 1px solid #3a3a4a; color: #e6e6fa; }
        .cell-title {
            min-width: 280px;
            max-width: 480px;
            white-space: normal;
            word-break: normal;
            overflow-wrap: break-word;
        }
        .cell-desc {
            min-width: 380px;
            max-width: 640px;
            white-space: normal;
            word-break: normal;
            overflow-wrap: break-word;
        }
        .cell-action {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .action-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #6a5acd;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            cursor: pointer;
        }
        .action-btn:hover { background: #7b6be0; }
        .cell-tags {
            display: grid;
            grid-template-columns: repeat(2, max-content);
            gap: 6px 10px;
            align-items: center;
        }
        .tag-toggle {
            display: inline-block;
            padding: 2px 6px;
            font-size: 12px;
            background: #4b0082;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            margin-left: 6px;
            vertical-align: middle;
            align-self: center;
        }
        .fill-url-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #6a5acd;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            cursor: pointer;
        }
        .fill-url-btn:hover { background: #7b6be0; }
        .meta-pill {
            display: inline-block;
            background: #3a3a4a;
            color: #e6e6fa;
            padding: 2px 6px;
            border-radius: 12px;
            margin-right: 6px;
            font-size: 12px;
            white-space: nowrap;
        }
        .cell-meta { white-space: nowrap; }
        /* Tag dropdown controls */
        .tag-dropdown {
            position: relative;
        }
        .tag-panel {
            display: none;
            position: absolute;
            left: 0;
            top: 100%;
            z-index: 20;
            background: #3a3a4a;
            border: 1px solid #4b0082;
            border-radius: 6px;
            padding: 10px;
            max-height: 220px;
            overflow: auto;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .tag-panel.open { 
            display: block;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .tag-item {
            display: block;
            padding: 4px 6px;
            font-size: 12px;
            border-radius: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .tag-item.selected {
            background: #6a5acd;
            color: #fff;
        }
        .tag-dropdown button {
            width: 100%;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .filters-row {
            display: flex;
            gap: 8px;
        }
        .filters-row .tag-dropdown { flex: 1; min-width: 0; }
        .selected-tags-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .selected-group {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .selected-label {
            color: #b19cd9;
            font-size: 12px;
        }
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .selected-tags .tag-pill { cursor: pointer; }
        .thumb-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #3a3a4a;
            border: 1px solid #4b0082;
            color: #e6e6fa;
            border-radius: 4px;
        }
        .pager-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }
        .pager-select, .pager-input {
            padding: 8px 10px;
            background: #3a3a4a;
            border: 1px solid #4b0082;
            color: #e6e6fa;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.2;
        }
        .pager-row select, 
        .pager-row input {
            width: auto !important;
            flex: 0 0 auto;
        }
        .pager-btn {
            padding: 8px 12px;
            background: #6a5acd;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.2;
        }
        .pager-btn:hover { background: #7b6be0; }
        /* Sticky first column (Action) */
        .gallery-table thead th.action-col {
            position: sticky;
            left: 0;
            z-index: 11;
            background: #4b0082;
        }
        .gallery-table tbody td.action-col {
            position: sticky;
            left: 0;
            z-index: 5;
            background: #2a2a3a;
            border-right: 1px solid #3a3a4a;
        }
        
        /* Sidebar inputs styling override */
        .gallery-sidebar select, 
        .gallery-sidebar input,
        .gallery-sidebar .input-wrapper {
            width: 100% !important;
            box-sizing: border-box;
        }
        /* Do NOT stretch compact rows */
        .gallery-sidebar .filters-row select,
        .gallery-sidebar .filters-row input {
            width: auto !important;
            flex: 0 0 auto;
        }
        .gallery-sidebar .filters-row .thumb-option {
            flex: 0 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PixivåŸå›¾ <br> i.pximg.net</h1>

        <!-- å¿«é€Ÿè®¿é—®æŒ‰é’® -->
        <div id="quickAccessContainer" class="quick-access-container">
            <button id="quickAccessBtn" class="quick-access-btn" style="background-color: #9370db; display: none;" onclick="openSecretSettings()" title="è®¾ç½®">
                âš™
            </button>
            <button id="galleryBtn" class="quick-access-btn" style="background-color: #ff9f43; display: none;" onclick="openGalleryBrowser()" title="å›¾åº“">
                ğŸ“‚
            </button>
            <button id="quickRandomBtn" class="quick-access-btn" style="background-color: #ff6b6b; display: none;" onclick="quickRandomImage()" title="éšæœºä¸€å›¾">
                ğŸ²
            </button>
        </div>

        <div class="input-group">
            <label for="proxySelect">é€‰æ‹©æœåŠ¡å™¨ï¼š</label>
            <select id="proxySelect" onchange="handleProxyChange()">
                <option value="https://prox.futa.de5.net/">ç«™é•¿è‡ªå»º</option>
                <option value="https://prox.spacetimee.xyz/">Githubå¤§ä½¬å…¬å¼€</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
            <input 
                type="url" 
                id="customProxyInput" 
                class="custom-proxy-input"
                placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ç½‘å€ï¼Œä¾‹å¦‚ï¼šhttps://prox.yourdomainname.domain/"
            />
        </div>

        <div class="input-group">
            <label for="urlInput">è¯·è¾“å…¥PixivåŸå›¾ <br> i.pximg.net çš„é“¾æ¥ï¼š</label>
            <input 
                type="url" 
                id="urlInput" 
                placeholder="ä¾‹å¦‚ï¼šhttps://i.pximg.net/img-original/img/..."
                oninput="checkSecretCode(); updatePageControlFromUrl()"
            />
            <div class="pager-control-row" style="display:flex; align-items:center; gap:10px; margin-top:10px; margin-bottom:10px;">
                <button onclick="changeUrlPage(-1)" style="margin:0; flex:1; background-color: #5a4a9d;">â—€ ä¸Šä¸€å¼ </button>
                <div style="flex:0 0 100px; display:flex; align-items:center; justify-content:center; background:#3a3a4a; border:2px solid #4b0082; border-radius:6px; padding:0;">
                     <span style="color:#b19cd9; margin-right:5px; font-weight:bold;">P</span>
                     <input type="number" id="urlPageInput" value="1" min="1" style="background:transparent; border:none; color:#e6e6fa; width:50px; text-align:center; font-size:16px; padding:10px 0;" onchange="jumpUrlPage(this.value)">
                </div>
                <button onclick="changeUrlPage(1)" style="margin:0; flex:1; background-color: #5a4a9d;">ä¸‹ä¸€å¼  â–¶</button>
            </div>
            <div class="button-row">
                <button onclick="processLink()">ğŸ”„ åŠ è½½å›¾ç‰‡</button>
                <button onclick="loadApiImage()">ğŸ² API éšæœºå›¾</button>
                <button onclick="openInNewTab()">ğŸ”— åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€åŸå›¾</button>
            </div>
        </div>

        <!-- è¯¦ç»†ä¿¡æ¯å±•ç¤ºåŒº -->
        <div id="detailsContainer" class="details-container">
            <h3 style="margin-top: 0; color: #b19cd9; margin-bottom: 10px;">ğŸ“„ å›¾ç‰‡è¯¦æƒ…</h3>
            <div id="detailsGrid" class="details-grid">
                <!-- Content will be injected via JS -->
            </div>
        </div>

        <div id="errorMsg" class="error" style="display: none;"></div>
        <div id="infoMsg" class="info" style="display: none;"></div>

        <!-- æ˜¾ç¤ºè½¬æ¢åçš„é“¾æ¥ -->
        <div id="resultLinkContainer" class="result-link-container" style="display: none;">
            <span class="result-link-label">å¯ç›´æ¥è®¿é—®çš„é“¾æ¥ï¼ˆç‚¹å‡»å¯å¤åˆ¶ï¼‰ï¼š</span>
            <div id="resultLink" class="result-link" onclick="copyToClipboard(this)"></div>
        </div>

        <!-- ä¸‹æ–¹ç”¨äºæ˜¾ç¤ºå›¾ç‰‡ -->
        <div id="imageContainer" class="image-container" style="display: none;">
            <div class="image-label">å›¾ç‰‡å†…å®¹ï¼ˆå³é”®/é•¿æŒ‰å¯ä¿å­˜ï¼‰ï¼š</div>
            <div class="image-wrapper" id="imageWrapper">
                <div id="loadingIndicator" style="display: none; padding: 20px;">
                    <span class="loading"></span>
                    <span id="loadingText">æ­£åœ¨åŠ è½½å›¾ç‰‡...</span>
                    <div id="progressContainer" style="margin-top: 10px; width: 100%; max-width: 300px; height: 5px; background: #3a3a4a; border-radius: 3px; overflow: hidden; display: none;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: #6a5acd; transition: width 0.1s;"></div>
                    </div>
                    <div id="progressStats" style="font-size: 12px; color: #b19cd9; margin-top: 5px; display: none;">0%</div>
                </div>
                <img id="resultImage" src="" alt="Pixivå›¾ç‰‡" style="display: none;" />
            </div>
            <div class="button-container">
                <button id="downloadBtn" class="show-original-btn" onclick="downloadImage()">ä¸‹è½½åŸå›¾</button>
            </div>
        </div>
    </div>

    <!-- é™æ€èµ„æºé¡µé¢ -->
    <div id="secretSettings" class="secret-settings">
        <div class="secret-settings-content">
            <h2>é™æ€èµ„æº</h2>
            
            <!-- åŠŸèƒ½åˆ‡æ¢æŒ‰é’® -->
            <div class="function-toggle">
                <button id="staticResourceBtn" class="active" onclick="switchFunction('static')">é™æ€èµ„æº</button>
                <button id="AnotherBtn" onclick="switchFunction('Another')">å¦ä¸€ä¸ªé™æ€èµ„æº-PikPak</button>
            </div>
            
            <!-- é™æ€èµ„æºéƒ¨åˆ† -->
            <div id="staticResourceSection">
                <div class="secret-input-group">
                    <label for="secretProxySelect">é€‰æ‹©æœåŠ¡å™¨ï¼š</label>
                    <select id="secretProxySelect" onchange="handleSecretProxyChange()">
                        <option value="https://prox.futa.de5.net/">ç«™é•¿è‡ªå»º</option>
                        <option value="https://prox.spacetimee.xyz/">Githubå¤§ä½¬å…¬å¼€</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                    <input 
                        type="url" 
                        id="secretCustomProxyInput" 
                        class="custom-proxy-input"
                        placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ç½‘å€ï¼Œä¾‹å¦‚ï¼šhttps://prox.mydomain.com/"
                    />
                </div>
                <div class="secret-input-group">
                    <label for="secretInput">è¾“å…¥å†…å®¹ï¼š</label>
                    <input 
                        type="text" 
                        id="secretInput" 
                        placeholder="è¯·è¾“å…¥é™æ€èµ„æºé“¾æ¥..."
                    />
                </div>
            </div>
            
            <!-- å¦ä¸€ä¸ªé™æ€èµ„æºéƒ¨åˆ† -->
            <div id="AnotherSection" style="display: none;">
                <div class="secret-input-group">
                    <label for="AnotherInput">è¾“å…¥é“¾æ¥ï¼š</label>
                    <input 
                        type="text" 
                        id="AnotherInput" 
                        placeholder="è¯·è¾“å…¥é“¾æ¥..."
                    />
                </div>
            </div>
            
            <div class="secret-buttons">
                <button onclick="handleSecretAction()">æ‰§è¡Œæ“ä½œ</button>
                <button class="close-secret" onclick="closeSecretSettings()">å…³é—­</button>
            </div>
        </div>
    </div>

        <!-- Gallery Browser Modal -->
    <div id="galleryBrowser" class="secret-settings" style="display: none;">
        <div class="secret-settings-content" style="max-width: 1200px; width: 95%; height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h2 style="margin: 0;">å›¾åº“æµè§ˆ</h2>
                    <button onclick="pickRandomImage()" style="margin: 0; padding: 8px 15px; background: #ff9f43; font-size: 14px; border-radius: 4px; border: none; cursor: pointer; color: white;">ğŸ² éšæœºä¸€å›¾</button>
                    <label class="thumb-option" for="useThumbCheckbox">
                        <input type="checkbox" id="useThumbCheckbox" />
                        ä½¿ç”¨ç¼©ç•¥å›¾
                    </label>
                </div>
                <button class="close-secret" onclick="closeGalleryBrowser()" style="width: auto; padding: 5px 15px;">âœ•</button>
            </div>
            
            <div class="gallery-body">
                <div class="gallery-sidebar">
                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">æ•°æ®æº</label>
                        <select id="galleryCsvSelect" onchange="loadGalleryData()" style="padding: 10px; background: #3a3a4a; border: 1px solid #4b0082; color: #e6e6fa; border-radius: 4px;">
                            <!-- Options injected via JS -->
                        </select>
                        <input type="file" id="localCsvInput" accept=".csv" style="display:none;">
                    </div>

                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">æœç´¢</label>
                        <input type="text" id="gallerySearch" placeholder="æœç´¢æ ‡é¢˜ã€æè¿°ã€ID..." style="padding: 10px; background: #3a3a4a; border: 1px solid #4b0082; color: #e6e6fa; border-radius: 4px;">
                    </div>
                
                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">æ’åº</label>
                        <select id="gallerySort" style="padding: 10px; background: #3a3a4a; border: 1px solid #4b0082; color: #e6e6fa; border-radius: 4px;">
                            <option value="newest">ğŸ“… æ—¥æœŸæœ€æ–°</option>
                            <option value="oldest">ğŸ“… æ—¥æœŸæœ€æ—©</option>
                            <option value="id_desc">ğŸ”¢ ID é™åº</option>
                            <option value="id_asc">ğŸ”¢ ID å‡åº</option>
                            <option value="view_desc">ğŸ‘ï¸ æµè§ˆæœ€å¤š</option>
                            <option value="like_desc">â¤ï¸ æ”¶è—æœ€å¤š</option>
                        </select>
                    </div>

                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">æ ‡ç­¾ç­›é€‰</label>
                        <div class="filters-row">
                            <div class="tag-dropdown">
                                <button id="openTagInclude" style="padding:8px 10px;">é€‰æ‹©åŒ…å«æ ‡ç­¾</button>
                                <div id="tagIncludePanel" class="tag-panel"></div>
                            </div>
                            <div class="tag-dropdown">
                                <button id="openTagExclude" style="padding:8px 10px;">é€‰æ‹©æ’é™¤æ ‡ç­¾</button>
                                <div id="tagExcludePanel" class="tag-panel"></div>
                            </div>
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">å·²é€‰æ ‡ç­¾</label>
                        <div class="selected-tags-row">
                            <div class="selected-group">
                                <span class="selected-label">åŒ…å«</span>
                                <div id="selectedInclude" class="selected-tags"></div>
                            </div>
                            <div class="selected-group">
                                <span class="selected-label">æ’é™¤</span>
                                <div id="selectedExclude" class="selected-tags"></div>
                            </div>
                            <button id="clearSelectedTags" class="pager-btn">æ¸…ç©º</button>
                        </div>
                    </div>

                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">æ˜¾ç¤ºé€‰é¡¹</label>
                        <div class="filters-row">
                            <select id="galleryAiFilter" class="pager-select">
                                <option value="">ğŸ¤– AI: å…¨éƒ¨</option>
                                <option value="YES">AI: æ˜¯</option>
                                <option value="NO">AI: å¦</option>
                            </select>
                            <select id="galleryDateFormat" class="pager-select">
                                <option value="raw">åŸå§‹</option>
                                <option value="local">æœ¬åœ°æ ¼å¼</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="galleryStatus" style="color: #888; font-size: 12px; margin-top: 10px; word-break: break-all;"></div>
                </div>

                <!-- Main: Table -->
                <div class="gallery-main">
                    <div class="gallery-table-container">
                        <table class="gallery-table">
                            <thead>
                                <tr>
                                    <th class="th-center action-col">æ“ä½œ</th>
                                    <th class="th-left">ID</th>
                                    <th class="th-left">æ ‡é¢˜</th>
                                    <th class="th-left">æè¿°</th>
                                    <th class="th-left">æ–‡ä»¶å</th>
                                    <th class="th-left">æ ‡ç­¾</th>
                                    <th class="th-left">é¡µç </th>
                                    <th class="th-left">é™åˆ¶çº§</th>
                                    <th class="th-left">æ—¥æœŸ</th>
                                    <th class="th-left">æµè§ˆ</th>
                                    <th class="th-left">æ”¶è—</th>
                                </tr>
                            </thead>
                            <tbody id="galleryTableBody">
                                <!-- Data injected via JS -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="galleryPagination" class="pager-row">
                        <label for="perPageSelect" style="color:#b19cd9;">æ¯é¡µ</label>
                        <select id="perPageSelect" class="pager-select">
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                        <button id="prevPageBtn" class="pager-btn">ä¸Šä¸€é¡µ</button>
                        <button id="nextPageBtn" class="pager-btn">ä¸‹ä¸€é¡µ</button>
                        <span id="pageInfo" style="color:#888; font-size:12px;">ç¬¬ 1 / 1 é¡µ</span>
                        <input id="pageInput" type="number" min="1" value="1" class="pager-input">
                        <button id="jumpPageBtn" class="pager-btn">è·³è½¬</button>
                    </div>
                    
                    <div id="galleryLoading" style="text-align: center; padding: 20px; display: none;">
                        <span class="loading"></span> æ­£åœ¨åŠ è½½æ•°æ®...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvFilesConfig = [];
        let isOriginalSize = false;
        let originalUrl = '';
        let replacedUrl = '';
        let hasAccessedSecret = false; // æ ‡è®°æ˜¯å¦è®¿é—®è¿‡
        let currentFunction = 'static'; // å½“å‰åŠŸèƒ½ï¼šstaticæˆ–Another

        // --- Gallery Browser Variables ---
        let galleryData = [];
        let galleryTags = new Set();
        let tagCountsMap = {};
        let isGalleryLoaded = false;
        // -------------------------------------

        function initCsvSelect(failed = false) {
            const select = document.getElementById('galleryCsvSelect');
            if (!select) return;
            select.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = failed ? 'CSVæ–‡ä»¶æ•°æ®åŠ è½½å¤±è´¥' : 'è¯·é€‰æ‹©CSVæ–‡ä»¶';
            placeholder.disabled = true;
            placeholder.selected = true;
            select.appendChild(placeholder);
            csvFilesConfig.forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.textContent = file;
                select.appendChild(option);
            });
            const localOpt = document.createElement('option');
            localOpt.value = '__local__';
            localOpt.textContent = 'é€‰æ‹©æœ¬åœ°CSVæ–‡ä»¶...';
            select.appendChild(localOpt);
            if (csvFilesConfig.length > 0) {
                select.value = csvFilesConfig[0];
            }
        }
        async function loadCsvConfig() {
            let failed = false;
            try {
                const resp = await fetch('csv.json');
                if (!resp.ok) throw new Error();
                const data = await resp.json();
                const files = Array.isArray(data) ? data : (Array.isArray(data.files) ? data.files : []);
                csvFilesConfig = files && files.length ? files : [];
            } catch (e) {
                csvFilesConfig = [];
                failed = true;
            }
            initCsvSelect(failed);
        }
        window.addEventListener('DOMContentLoaded', () => {
            loadCsvConfig();
        });

        // åˆ‡æ¢åŠŸèƒ½
        function switchFunction(func) {
            currentFunction = func;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('staticResourceBtn').classList.toggle('active', func === 'static');
            document.getElementById('AnotherBtn').classList.toggle('active', func === 'Another');
            
            // æ˜¾ç¤º/éšè—å¯¹åº”éƒ¨åˆ†
            document.getElementById('staticResourceSection').style.display = func === 'static' ? 'block' : 'none';
            document.getElementById('AnotherSection').style.display = func === 'Another' ? 'block' : 'none';
        }

        // ä»£ç æ£€æµ‹
        function checkSecretCode() {
            const input = document.getElementById('urlInput');
            const value = input.value.toLowerCase();
            const container = document.getElementById('quickAccessContainer');
            const btnProx = document.getElementById('quickAccessBtn');
            const btnGallery = document.getElementById('galleryBtn');
            
            if (value === 'prox') {
                input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                hasAccessedSecret = true;
                container.style.display = 'flex';
                btnProx.style.display = 'flex';
                // è‡ªåŠ¨æ‰“å¼€è®¾ç½®èœå• (å¯é€‰ï¼Œä¿ç•™åŸé€»è¾‘)
                openSecretSettings();
            } else if (value === 'random') {
                input.value = '';
                hasAccessedSecret = true;
                container.style.display = 'flex';
                btnGallery.style.display = 'flex';
                document.getElementById('quickRandomBtn').style.display = 'flex';
                // è‡ªåŠ¨æ‰“å¼€å›¾åº“
                openGalleryBrowser();
            }
        }

        function fillUrl(url, itemData = null) {
            const input = document.getElementById('urlInput');
            input.value = url;
            
            // If item data is provided, show details
            if (itemData) {
                const detailsContainer = document.getElementById('detailsContainer');
                const detailsGrid = document.getElementById('detailsGrid');
                
                detailsContainer.style.display = 'block';
                detailsGrid.innerHTML = '';
                
                for (const key in itemData) {
                    if (Object.prototype.hasOwnProperty.call(itemData, key)) {
                        const value = itemData[key];
                        
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'detail-item';
                        
                        // Make description and tags full width
                        if (key.toLowerCase().includes('description') || key.toLowerCase().includes('tag')) {
                             itemDiv.style.gridColumn = '1 / -1';
                        }

                        const labelSpan = document.createElement('span');
                        labelSpan.className = 'detail-label';
                        labelSpan.textContent = key;
                        
                        const valueDiv = document.createElement('div');
                        valueDiv.className = 'detail-value';

                        if (key === 'tags_transl' && value) {
                             value.split(',').forEach(tag => {
                                const span = document.createElement('span');
                                span.className = 'tag-pill';
                                span.textContent = tag.trim();
                                valueDiv.appendChild(span);
                            });
                        } else {
                            valueDiv.textContent = value;
                        }

                        itemDiv.appendChild(labelSpan);
                        itemDiv.appendChild(valueDiv);
                        detailsGrid.appendChild(itemDiv);
                    }
                }
            } else {
                // Hide details if no data (e.g. manual entry or random from unknown source)
                document.getElementById('detailsContainer').style.display = 'none';
            }
        }



        // CSV Parser
        function parseCSV(text) {
            const lines = [];
            let row = [];
            let inQuote = false;
            let currentValue = '';
            
            // Remove BOM if present
            if (text.charCodeAt(0) === 0xFEFF) {
                text = text.slice(1);
            }

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (inQuote && nextChar === '"') {
                        currentValue += '"';
                        i++; 
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    row.push(currentValue);
                    currentValue = '';
                } else if ((char === '\r' || char === '\n') && !inQuote) {
                    if (currentValue || row.length > 0) {
                        row.push(currentValue);
                        lines.push(row);
                        row = [];
                        currentValue = '';
                    }
                    if (char === '\r' && nextChar === '\n') i++;
                } else {
                    currentValue += char;
                }
            }
            if (currentValue || row.length > 0) {
                row.push(currentValue);
                lines.push(row);
            }
            
            if (lines.length < 2) return [];
            
            const headers = lines[0].map(h => h.trim());
            return lines.slice(1).map(line => {
                const obj = {};
                headers.forEach((h, i) => {
                    obj[h] = line[i] || '';
                });
                return obj;
            });
        }

        // Initialize listeners when DOM is loaded (but here we are in script at end of body)
        // Add event listeners for Random Menu

        // --- Gallery Browser Functions ---
        function openGalleryBrowser() {
            document.getElementById('galleryBrowser').style.display = 'flex';
            if (!isGalleryLoaded) {
                loadGalleryData();
            }
        }

        function pickRandomImage() {
            if (galleryData.length === 0) {
                alert('è¯·å…ˆåŠ è½½æ•°æ®ï¼');
                return;
            }
            
            // Use current filtered data if available? No, usually random means from all data or current view.
            // Let's use all data for true random, or maybe respect filters? 
            // User just said "Random Image", let's pick from ALL loaded data to be safe.
            const randomIndex = Math.floor(Math.random() * galleryData.length);
            const item = galleryData[randomIndex];
            
            const useThumb = document.getElementById('useThumbCheckbox') && document.getElementById('useThumbCheckbox').checked;
            
            // Fill URL and process
            fillUrl(useThumb ? (item.thumb || item.original) : item.original, item);
            closeGalleryBrowser();
            
            // Trigger load
            processLink();
        }

        function closeGalleryBrowser() {
            document.getElementById('galleryBrowser').style.display = 'none';
        }
        
        // é˜²æŠ–å·¥å…·å‡½æ•°
        function debounce(fn, delay = 300) {
            let timer = null;
            return (...args) => {
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        }

        async function loadGalleryData() {
            const loading = document.getElementById('galleryLoading');
            const status = document.getElementById('galleryStatus');
            const selectedFile = document.getElementById('galleryCsvSelect').value;
            
            if (!selectedFile) {
                status.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªCSVæ–‡ä»¶';
                return;
            }

            if (selectedFile === '__local__') {
                const input = document.getElementById('localCsvInput');
                if (!input) return;
                input.onchange = async () => {
                    const file = input.files && input.files[0];
                    if (!file) {
                        status.textContent = 'æœªé€‰æ‹©æœ¬åœ°CSVæ–‡ä»¶';
                        loading.style.display = 'none';
                        return;
                    }
                    loading.style.display = 'block';
                    status.textContent = `æ­£åœ¨ä»æœ¬åœ°åŠ è½½: ${file.name}`;
                    try {
                        const text = await file.text();
                        galleryData = parseCSV(text);
                        const tagCounts = {};
                        galleryData.forEach(item => {
                            if (item.tags_transl) {
                                item.tags_transl.split(',').forEach(t => {
                                    const tag = t.trim();
                                    if (tag) {
                                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                                    }
                                });
                            }
                        });
                        tagCountsMap = tagCounts;
                        const includePanel = document.getElementById('tagIncludePanel');
                        const excludePanel = document.getElementById('tagExcludePanel');
                        includePanel.innerHTML = '';
                        excludePanel.innerHTML = '';
                        Object.keys(tagCounts)
                            .sort((a, b) => {
                                const diff = tagCounts[b] - tagCounts[a];
                                if (diff !== 0) return diff;
                                return a.localeCompare(b, 'zh-CN');
                            })
                            .forEach(tag => {
                                const inc = document.createElement('div');
                                inc.className = 'tag-item';
                                inc.dataset.value = tag;
                                inc.textContent = `${tag} (${tagCounts[tag]})`;
                                includePanel.appendChild(inc);
                                const exc = document.createElement('div');
                                exc.className = 'tag-item';
                                exc.dataset.value = tag;
                                exc.textContent = `${tag} (${tagCounts[tag]})`;
                                excludePanel.appendChild(exc);
                            });
                        isGalleryLoaded = true;
                        status.textContent = `åŠ è½½æˆåŠŸ: ${file.name} (å…± ${galleryData.length} æ¡æ•°æ®)`;
                        renderGalleryTable();
                    } catch (err) {
                        console.error(err);
                        status.textContent = `åŠ è½½å¤±è´¥: ${err.message}`;
                    } finally {
                        loading.style.display = 'none';
                        input.value = '';
                    }
                };
                input.click();
                return;
            }

            loading.style.display = 'block';
            status.textContent = 'æ­£åœ¨å°è¯•åŠ è½½æ•°æ®...';
            
            try {
                const response = await fetch(selectedFile);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                galleryData = parseCSV(text);
                
                // Extract Tags and Count Frequency
                const tagCounts = {};
                galleryData.forEach(item => {
                    if (item.tags_transl) {
                        // Split by comma, trim whitespace
                        item.tags_transl.split(',').forEach(t => {
                            const tag = t.trim();
                            if (tag) {
                                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                            }
                        });
                    }
                });
                tagCountsMap = tagCounts;
                
                // Populate Tag Panels
                const includePanel = document.getElementById('tagIncludePanel');
                const excludePanel = document.getElementById('tagExcludePanel');
                includePanel.innerHTML = '';
                excludePanel.innerHTML = '';
                
                // Sort by count desc
                Object.keys(tagCounts)
                    .sort((a, b) => {
                        const diff = tagCounts[b] - tagCounts[a];
                        if (diff !== 0) return diff;
                        return a.localeCompare(b, 'zh-CN');
                    })
                    .forEach(tag => {
                        const inc = document.createElement('div');
                        inc.className = 'tag-item';
                        inc.dataset.value = tag;
                        inc.textContent = `${tag} (${tagCounts[tag]})`;
                        includePanel.appendChild(inc);
                        const exc = document.createElement('div');
                        exc.className = 'tag-item';
                        exc.dataset.value = tag;
                        exc.textContent = `${tag} (${tagCounts[tag]})`;
                        excludePanel.appendChild(exc);
                    });

                isGalleryLoaded = true;
                status.textContent = `åŠ è½½æˆåŠŸ: ${selectedFile} (å…± ${galleryData.length} æ¡æ•°æ®)`;
                renderGalleryTable();
            } catch (err) {
                console.error(err);
                status.textContent = `åŠ è½½å¤±è´¥: ${err.message} (è¯·ç¡®ä¿ ${selectedFile} å­˜åœ¨)`;
            } finally {
                loading.style.display = 'none';
            }
        }

        let currentPage = 1;
        let perPage = 50;
        function updatePaginationUI(totalFiltered, totalPages) {
            const info = document.getElementById('pageInfo');
            const input = document.getElementById('pageInput');
            if (info) info.textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
            if (input) {
                input.max = Math.max(1, totalPages);
                input.value = currentPage;
            }
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderGalleryTable();
            }
        }
        function nextPage() {
            currentPage++;
            renderGalleryTable();
        }
        function goToPage(p) {
            const total = Math.max(1, Math.ceil(galleryData.length / perPage));
            currentPage = Math.min(Math.max(1, parseInt(p, 10) || 1), total);
            renderGalleryTable();
        }
        
        function renderGalleryTable() {
            const tbody = document.getElementById('galleryTableBody');
            const status = document.getElementById('galleryStatus');
            tbody.innerHTML = '';
            
            const tStart = performance.now();
                const searchText = document.getElementById('gallerySearch').value.toLowerCase();
                const sortMode = document.getElementById('gallerySort').value;
                const includeTags = Array.from(document.querySelectorAll('#tagIncludePanel .tag-item.selected')).map(el => el.dataset.value);
                const excludeTags = Array.from(document.querySelectorAll('#tagExcludePanel .tag-item.selected')).map(el => el.dataset.value);
                const filterAi = document.getElementById('galleryAiFilter').value;
            const dateFormatEl = document.getElementById('galleryDateFormat');
            const dateFormat = dateFormatEl ? dateFormatEl.value : 'raw';
            
            // Filter
            let items = galleryData.filter(item => {
                const matchSearch = !searchText || 
                    (item.title || '').toLowerCase().includes(searchText) || 
                    (item.description || '').toLowerCase().includes(searchText) || 
                    (item.id || '').toLowerCase().includes(searchText);
                
                // ç²¾ç¡®æ ‡ç­¾åŒ¹é…
                const tagArr = (item.tags_transl || '').split(',').map(t => t.trim()).filter(Boolean);
                const matchTagInclude = includeTags.length === 0 || includeTags.some(t => tagArr.includes(t));
                const matchTagExclude = excludeTags.length === 0 || excludeTags.every(t => !tagArr.includes(t));
                const matchTag = matchTagInclude && matchTagExclude;
                
                // AI Filter (YES/NO)
                const matchAi = !filterAi || (item.AI || '').toUpperCase() === filterAi;

                return matchSearch && matchTag && matchAi;
            });
            
            // Sort
            items.sort((a, b) => {
                const dA = Date.parse(a.date || '') || 0;
                const dB = Date.parse(b.date || '') || 0;
                switch (sortMode) {
                    case 'newest': return dB - dA;
                    case 'oldest': return dA - dB;
                    case 'id_desc': return parseInt(b.id || 0) - parseInt(a.id || 0);
                    case 'id_asc': return parseInt(a.id || 0) - parseInt(b.id || 0);
                    case 'view_desc': return parseInt(b.viewCount || 0) - parseInt(a.viewCount || 0);
                    case 'like_desc': return parseInt(b.likeCount || 0) - parseInt(a.likeCount || 0);
                    default: return 0;
                }
            });
            
            const totalFiltered = items.length;
            const totalPages = Math.max(1, Math.ceil(totalFiltered / perPage));
            if (currentPage > totalPages) currentPage = totalPages;
            const startIndex = (currentPage - 1) * perPage;
            const endIndex = startIndex + perPage;
            const pageItems = items.slice(startIndex, endIndex);
            updatePaginationUI(totalFiltered, totalPages);
            
            status.textContent = `æ˜¾ç¤º ${pageItems.length} / ${totalFiltered} æ¡æ•°æ® (æ€»è®¡ ${galleryData.length})`;
            
            const frag = document.createDocumentFragment();
            pageItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'gallery-row';
                
                // --- Action Column (Moved to first) ---
                const tdAction = document.createElement('td');
                tdAction.className = 'action-col cell-action';

                const btnOriginal = document.createElement('button');
                btnOriginal.textContent = 'å¡«å…¥é“¾æ¥';
                btnOriginal.className = 'fill-url-btn action-btn';
                btnOriginal.onclick = () => {
                    const useThumb = document.getElementById('useThumbCheckbox') && document.getElementById('useThumbCheckbox').checked;
                    fillUrl(useThumb ? (item.thumb || item.original) : item.original, item);
                    closeGalleryBrowser();
                };
                tdAction.appendChild(btnOriginal);
                tr.appendChild(tdAction);

                const tdId = document.createElement('td');
                tdId.textContent = item.id;
                tdId.className = 'cell-id';
                tr.appendChild(tdId);
                
                const tdTitle = document.createElement('td');
                tdTitle.textContent = item.title;
                tdTitle.className = 'cell-title';
                tdTitle.title = item.title;
                tr.appendChild(tdTitle);
                
                const tdDesc = document.createElement('td');
                tdDesc.textContent = item.description;
                tdDesc.className = 'cell-desc';
                tdDesc.title = item.description;
                tr.appendChild(tdDesc);
                
                const tdFile = document.createElement('td');
                tdFile.textContent = item.fileName || '';
                tdFile.className = 'cell-file';
                tr.appendChild(tdFile);
                
                const tdTags = document.createElement('td');
                tdTags.className = 'cell-tags';
                if (item.tags_transl) {
                    const tags = item.tags_transl.split(',').map(x => x.trim()).filter(Boolean);
                    const threshold = 3;
                    const spans = [];
                    tags.forEach((t, idx) => {
                        const span = document.createElement('span');
                        span.className = 'tag-pill';
                        if (idx >= threshold) span.style.display = 'none';
                        span.textContent = t;
                        tdTags.appendChild(span);
                        spans.push(span);
                    });
                    if (tags.length > threshold) {
                        const btn = document.createElement('button');
                        btn.className = 'tag-toggle';
                        btn.textContent = 'å±•å¼€';
                        btn.setAttribute('data-expanded', '0');
                        btn.onclick = () => {
                            const expanded = btn.getAttribute('data-expanded') === '1';
                            if (expanded) {
                                spans.forEach((s, idx) => { if (idx >= threshold) s.style.display = 'none'; });
                                btn.textContent = 'å±•å¼€';
                                btn.setAttribute('data-expanded', '0');
                            } else {
                                spans.forEach(s => { s.style.display = 'inline-block'; });
                                btn.textContent = 'æ”¶èµ·';
                                btn.setAttribute('data-expanded', '1');
                            }
                        };
                        tdTags.appendChild(btn);
                    }
                }
                tr.appendChild(tdTags);

                const tdPage = document.createElement('td');
                tdPage.className = 'cell-meta';
                const pageSpan = document.createElement('span');
                pageSpan.className = 'meta-pill';
                pageSpan.textContent = `é¡µç : ${item.page || '-'}`;
                pageSpan.style.border = '1px solid #ff6b6b';
                pageSpan.style.color = '#ff6b6b';
                tdPage.appendChild(pageSpan);
                tr.appendChild(tdPage);

                const tdRestrict = document.createElement('td');
                tdRestrict.className = 'cell-meta';
                const rSpan = document.createElement('span');
                rSpan.className = 'meta-pill';
                rSpan.textContent = `é™åˆ¶çº§: ${item.xRestrict || '0'}`;
                tdRestrict.appendChild(rSpan);
                tr.appendChild(tdRestrict);

                // Date
                const tdDate = document.createElement('td');
                tdDate.textContent = dateFormat === 'local' && item.date ? new Date(item.date).toLocaleString() : (item.date || '-');
                tr.appendChild(tdDate);

                // View Count
                const tdView = document.createElement('td');
                tdView.textContent = item.viewCount || '0';
                tr.appendChild(tdView);

                // Collection (Bookmark) Count
                const tdBookmark = document.createElement('td');
                tdBookmark.textContent = item.bookmark || '0';
                tr.appendChild(tdBookmark);
                
                frag.appendChild(tr);
            });
            tbody.appendChild(frag);
            const tElapsed = performance.now() - tStart;
            status.textContent += `ï¼Œæ¸²æŸ“è€—æ—¶ ${tElapsed.toFixed(1)} ms`;
        }
        
        // æœç´¢ä¸ç­›é€‰ç›‘å¬ï¼ˆé˜²æŠ–ï¼‰
        const debouncedRender = debounce(renderGalleryTable, 300);
        document.getElementById('gallerySearch').addEventListener('input', debouncedRender);
        const tagIncludePanel = document.getElementById('tagIncludePanel');
        const tagExcludePanel = document.getElementById('tagExcludePanel');
        const aiFilterEl = document.getElementById('galleryAiFilter');
        const sortEl = document.getElementById('gallerySort');
        const dateFmtEl = document.getElementById('galleryDateFormat');
        const perPageEl = document.getElementById('perPageSelect');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const jumpBtn = document.getElementById('jumpPageBtn');
        const pageInput = document.getElementById('pageInput');
        const selectedInclude = document.getElementById('selectedInclude');
        const selectedExclude = document.getElementById('selectedExclude');
        const clearSelectedBtn = document.getElementById('clearSelectedTags');

        function updateSelectedTagsSummary() {
            if (!selectedInclude || !selectedExclude) return;
            const inc = Array.from(document.querySelectorAll('#tagIncludePanel .tag-item.selected')).map(el => el.dataset.value);
            const exc = Array.from(document.querySelectorAll('#tagExcludePanel .tag-item.selected')).map(el => el.dataset.value);
            selectedInclude.innerHTML = '';
            selectedExclude.innerHTML = '';
            inc.forEach(tag => {
                const pill = document.createElement('span');
                pill.className = 'tag-pill';
                pill.dataset.tag = tag;
                pill.textContent = tag;
                selectedInclude.appendChild(pill);
            });
            exc.forEach(tag => {
                const pill = document.createElement('span');
                pill.className = 'tag-pill';
                pill.dataset.tag = tag;
                pill.textContent = tag;
                selectedExclude.appendChild(pill);
            });
        }
        function reorderTagPanel(panel) {
            if (!panel) return;
            const items = Array.from(panel.querySelectorAll('.tag-item'));
            items.sort((a, b) => {
                const aSel = a.classList.contains('selected') ? 1 : 0;
                const bSel = b.classList.contains('selected') ? 1 : 0;
                if (aSel !== bSel) return bSel - aSel;
                const ta = a.dataset.value || '';
                const tb = b.dataset.value || '';
                const ca = tagCountsMap[ta] || 0;
                const cb = tagCountsMap[tb] || 0;
                if (ca !== cb) return cb - ca;
                return ta.localeCompare(tb, 'zh-CN');
            });
            items.forEach(it => panel.appendChild(it));
        }
        function bindPanelClick(panel) {
            if (!panel) return;
            panel.addEventListener('click', (e) => {
                const item = e.target.closest('.tag-item');
                if (!item || !panel.contains(item)) return;
                item.classList.toggle('selected');
                updateSelectedTagsSummary();
                reorderTagPanel(panel);
                debouncedRender();
            });
        }
        bindPanelClick(tagIncludePanel);
        bindPanelClick(tagExcludePanel);
        if (clearSelectedBtn) {
            clearSelectedBtn.addEventListener('click', () => {
                document.querySelectorAll('#tagIncludePanel .tag-item.selected, #tagExcludePanel .tag-item.selected').forEach(el => el.classList.remove('selected'));
                updateSelectedTagsSummary();
                debouncedRender();
            });
        }
        if (selectedInclude) {
            selectedInclude.addEventListener('click', (e) => {
                const pill = e.target.closest('.tag-pill');
                if (!pill) return;
                const tag = pill.dataset.tag;
                const item = document.querySelector(`#tagIncludePanel .tag-item[data-value="${tag}"]`);
                if (item) item.classList.remove('selected');
                updateSelectedTagsSummary();
                debouncedRender();
            });
        }
        if (selectedExclude) {
            selectedExclude.addEventListener('click', (e) => {
                const pill = e.target.closest('.tag-pill');
                if (!pill) return;
                const tag = pill.dataset.tag;
                const item = document.querySelector(`#tagExcludePanel .tag-item[data-value="${tag}"]`);
                if (item) item.classList.remove('selected');
                updateSelectedTagsSummary();
                debouncedRender();
            });
        }
        if (aiFilterEl) aiFilterEl.addEventListener('change', debouncedRender);
        if (sortEl) sortEl.addEventListener('change', renderGalleryTable);
        if (dateFmtEl) dateFmtEl.addEventListener('change', renderGalleryTable);
        if (perPageEl) perPageEl.addEventListener('change', () => { perPage = parseInt(perPageEl.value, 10) || 50; currentPage = 1; renderGalleryTable(); });
        if (prevBtn) prevBtn.addEventListener('click', prevPage);
        if (nextBtn) nextBtn.addEventListener('click', nextPage);
        if (jumpBtn && pageInput) jumpBtn.addEventListener('click', () => { const p = parseInt(pageInput.value, 10); if (!isNaN(p)) { goToPage(p); } });
        
        // Dropdown toggles
        const openTagIncludeBtn = document.getElementById('openTagInclude');
        const openTagExcludeBtn = document.getElementById('openTagExclude');
        function togglePanel(btn, panel) {
            if (!btn || !panel) return;
            btn.addEventListener('click', () => {
                panel.classList.toggle('open');
                reorderTagPanel(panel);
            });
        }
        togglePanel(openTagIncludeBtn, tagIncludePanel);
        togglePanel(openTagExcludeBtn, tagExcludePanel);
        document.addEventListener('click', (e) => {
            const incWrap = openTagIncludeBtn ? openTagIncludeBtn.parentElement : null;
            const excWrap = openTagExcludeBtn ? openTagExcludeBtn.parentElement : null;
            if (incWrap && !incWrap.contains(e.target)) { tagIncludePanel.classList.remove('open'); }
            if (excWrap && !excWrap.contains(e.target)) { tagExcludePanel.classList.remove('open'); }
        });



        function openSecretSettings() {
            document.getElementById('secretSettings').style.display = 'flex';
            // æ ‡è®°å·²è®¿é—®è¿‡é¡µé¢ï¼Œå¹¶æ˜¾ç¤ºå¿«é€Ÿè®¿é—®æŒ‰é’®
            hasAccessedSecret = true;
            document.getElementById('quickAccessBtn').style.display = 'block';
        }

        function closeSecretSettings() {
            document.getElementById('secretSettings').style.display = 'none';
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('urlInput').value = '';
            document.getElementById('secretInput').value = '';
            document.getElementById('AnotherInput').value = '';
        }

        function handleSecretProxyChange() {
            const secretProxySelect = document.getElementById('secretProxySelect');
            const secretCustomProxyInput = document.getElementById('secretCustomProxyInput');
            
            if (secretProxySelect.value === 'custom') {
                secretCustomProxyInput.style.display = 'block';
            } else {
                secretCustomProxyInput.style.display = 'none';
            }
        }

        function handleSecretAction() {
            if (currentFunction === 'static') {
                handleStaticResource();
            } else if (currentFunction === 'Another') {
                handleAnotherAcceleration();
            }
        }

        function handleStaticResource() {
            const secretInput = document.getElementById('secretInput').value.trim();
            const secretProxySelect = document.getElementById('secretProxySelect');
            const secretCustomProxyInput = document.getElementById('secretCustomProxyInput');
            
            if (!secretInput) {
                alert('âŒ è¯·è¾“å…¥é™æ€èµ„æºé“¾æ¥ï¼');
                return;
            }
            
            // è·å–é€‰æ‹©çš„ä»£ç†æœåŠ¡å™¨
            let proxyUrl;
            if (secretProxySelect.value === 'custom') {
                proxyUrl = secretCustomProxyInput.value.trim();
                if (!proxyUrl) {
                    alert('âŒ è¯·è¾“å…¥è‡ªå®šä¹‰æœåŠ¡å™¨åœ°å€ï¼');
                    return;
                }
            } else {
                proxyUrl = secretProxySelect.value;
            }

            // æ¸…ç†ä»£ç†URLï¼ˆç§»é™¤æœ«å°¾çš„æ–œæ ï¼‰
            const cleanProxyUrl = proxyUrl.replace(/\/+$/, '');
            
            // å¤„ç†è¾“å…¥å†…å®¹ï¼šç§»é™¤åè®®å¤´ï¼Œæ›¿æ¢ä¸º~
            let processedInput = secretInput;
            
            // ç§»é™¤ http:// æˆ– https:// åè®®å¤´
            processedInput = processedInput.replace(/^https?:\/\//, '');
            
            // æ„å»ºæœ€ç»ˆURLï¼šä»£ç†æœåŠ¡å™¨ + /~ + å¤„ç†åçš„è¾“å…¥å†…å®¹
            const finalUrl = cleanProxyUrl + '/~' + processedInput;
            
            // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
            window.open(finalUrl, '_blank');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('secretInput').value = '';
        }

        function handleAnotherAcceleration() {
            const AnotherInput = document.getElementById('AnotherInput').value.trim();
            
            if (!AnotherInput) {
                alert('âŒ è¯·è¾“å…¥é“¾æ¥ï¼');
                return;
            }
            
            // å¤„ç†è¾“å…¥å†…å®¹ï¼šç§»é™¤åè®®å¤´
            let processedInput = AnotherInput;
            
            // ç§»é™¤ http:// æˆ– https:// åè®®å¤´
            // processedInput = processedInput.replace(/^https?:\/\//, '');
            
            // æ„å»ºæœ€ç»ˆURLï¼šåŠ é€ŸåŸŸå + å¤„ç†åçš„è¾“å…¥å†…å®¹
            const finalUrl = 'https://p.futa.de5.net/' + processedInput;
            
            // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
            window.open(finalUrl, '_blank');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('AnotherInput').value = '';
        }

        function getProxyUrl() {
            const proxySelect = document.getElementById('proxySelect');
            const customProxyInput = document.getElementById('customProxyInput');
            
            if (proxySelect.value === 'custom') {
                return customProxyInput.value.trim();
            } else {
                return proxySelect.value;
            }
        }

        function handleProxyChange() {
            const proxySelect = document.getElementById('proxySelect');
            const customProxyInput = document.getElementById('customProxyInput');
            
            if (proxySelect.value === 'custom') {
                customProxyInput.style.display = 'block';
            } else {
                customProxyInput.style.display = 'none';
            }
        }

        async function loadImageWithProgress(url) {
            const loadingText = document.getElementById('loadingText');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressStats = document.getElementById('progressStats');
            const resultImage = document.getElementById('resultImage');
            const loadingIndicator = document.getElementById('loadingIndicator');

            loadingText.textContent = 'æ­£åœ¨å»ºç«‹è¿æ¥...';
            progressContainer.style.display = 'block';
            progressStats.style.display = 'block';
            progressBar.style.width = '0%';
            progressStats.textContent = '0%';

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentLength = response.headers.get('content-length');
                const total = contentLength ? parseInt(contentLength, 10) : 0;
                let loaded = 0;

                const reader = response.body.getReader();
                const chunks = [];

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    chunks.push(value);
                    loaded += value.length;

                    if (total) {
                        const percent = Math.round((loaded / total) * 100);
                        progressBar.style.width = percent + '%';
                        progressStats.textContent = `${percent}% (${(loaded / 1024 / 1024).toFixed(2)} MB / ${(total / 1024 / 1024).toFixed(2)} MB)`;
                    } else {
                        progressStats.textContent = `å·²ä¸‹è½½: ${(loaded / 1024 / 1024).toFixed(2)} MB`;
                    }
                }

                loadingText.textContent = 'æ­£åœ¨æ¸²æŸ“å›¾ç‰‡...';
                
                const blob = new Blob(chunks);
                const objectUrl = URL.createObjectURL(blob);
                
                resultImage.onload = function() {
                    loadingIndicator.style.display = 'none';
                    resultImage.style.display = 'block';
                };
                
                resultImage.onerror = function() {
                    loadingIndicator.style.display = 'none';
                    showError('âŒ å›¾ç‰‡æ¸²æŸ“å¤±è´¥');
                };

                resultImage.src = objectUrl;
                // Update global replacedUrl for download button
                replacedUrl = objectUrl;

            } catch (err) {
                console.error(err);
                // Fallback for CORS or other fetch errors
                console.warn('Fetch failed (likely CORS), falling back to direct img src loading...');
                
                loadingText.textContent = 'æµå¼åŠ è½½å¤±è´¥ï¼Œå°è¯•ç›´æ¥åŠ è½½...';
                progressContainer.style.display = 'none';
                progressStats.style.display = 'none';
                
                // Clear blob URL if any
                if (resultImage.src.startsWith('blob:')) {
                    URL.revokeObjectURL(resultImage.src);
                }

                resultImage.onload = function() {
                    loadingIndicator.style.display = 'none';
                    resultImage.style.display = 'block';
                };
                
                resultImage.onerror = function() {
                    loadingIndicator.style.display = 'none';
                    showError('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥: æ— æ³•è®¿é—®å›¾ç‰‡èµ„æº (CORSé™åˆ¶ä¸”ç›´æ¥åŠ è½½å¤±è´¥)');
                };
                
                resultImage.src = url;
                replacedUrl = url;
            }
        }

        function processLink() {
            const input = document.getElementById('urlInput').value.trim();
            const errorMsg = document.getElementById('errorMsg');
            const infoMsg = document.getElementById('infoMsg');
            const imageContainer = document.getElementById('imageContainer');
            const resultImage = document.getElementById('resultImage');
            const resultLinkContainer = document.getElementById('resultLinkContainer');
            const resultLink = document.getElementById('resultLink');
            const downloadBtn = document.getElementById('downloadBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // éšè—ä¹‹å‰çš„æ¶ˆæ¯å’Œå›¾ç‰‡
            errorMsg.style.display = 'none';
            infoMsg.style.display = 'none';
            imageContainer.style.display = 'none';
            resultLinkContainer.style.display = 'none';
            resultImage.style.display = 'none';
            loadingIndicator.style.display = 'none';

            if (!input) {
                showError('âŒ è¯·å…ˆè¾“å…¥ä¸€ä¸ªé“¾æ¥ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»£ç 
            if (input.toLowerCase() === 'prox') {
                openSecretSettings();
                // æ ‡è®°å·²è®¿é—®è¿‡é¡µé¢ï¼Œå¹¶æ˜¾ç¤ºå¿«é€Ÿè®¿é—®æŒ‰é’®
                hasAccessedSecret = true;
                document.getElementById('quickAccessBtn').style.display = 'block';
                return;
            }

            try {
                originalUrl = input;

                // å¦‚æœç”¨æˆ·æ²¡è¾“å…¥åè®®ï¼Œæˆ‘ä»¬é»˜è®¤è¡¥ä¸Š https://
                if (!originalUrl.startsWith('http://') && !originalUrl.startsWith('https://')) {
                    originalUrl = 'https://' + originalUrl;
                }

                // è·å–ä»£ç†URL
                const proxyUrl = getProxyUrl();
                if (!proxyUrl) {
                    showError('âŒ è¯·é€‰æ‹©æˆ–è¾“å…¥ä»£ç†æœåŠ¡å™¨åœ°å€ï¼');
                    return;
                }

                // æ¸…ç†ä»£ç†URLï¼ˆç§»é™¤æœ«å°¾çš„æ–œæ ï¼‰
                const cleanProxyUrl = proxyUrl.replace(/\/+$/, '');
                
                // æ‰§è¡Œæ›¿æ¢ï¼ši.pximg.net â†’ é€‰æ‹©çš„ä»£ç†åŸŸå
                replacedUrl = originalUrl.replace(
                    /i\.pximg\.net/g, 
                    cleanProxyUrl.replace(/^https?:\/\//, '')
                );

                if (replacedUrl === originalUrl) {
                    showError('âš ï¸ <br> æ­¤éPixivåŸå›¾é“¾æ¥ <br> é“¾æ¥åº”ä¸º https://i.pximg.net/img-original/img/... <br> æ— æ³•æ‰“å¼€ã€‚è¯·æ£€æŸ¥è¾“å…¥çš„é“¾æ¥æ˜¯å¦æ­£ç¡®ã€‚');
                    return;
                }

                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                showInfo(`âœ… <br> å·²è½¬æ¥ï¼š<br> i.pximg.net â†’ ${cleanProxyUrl} <br>æ­£åœ¨åŠ è½½å›¾ç‰‡å†…å®¹...`);

                // æ˜¾ç¤ºè½¬æ¢åçš„é“¾æ¥
                resultLink.textContent = replacedUrl;
                resultLinkContainer.style.display = 'block';

                // é‡ç½®ä¸ºç¼©æ”¾æ¨¡å¼
                isOriginalSize = false;
                resultImage.className = 'scaled-image';
                
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                loadingIndicator.style.display = 'block';
                imageContainer.style.display = 'block';
                
                // ä½¿ç”¨æµå¼åŠ è½½
                loadImageWithProgress(replacedUrl);

            } catch (err) {
                showError('âŒ å¤„ç†é“¾æ¥æ—¶å‡ºé”™ï¼š' + err.message);
            }
        }

        function openInNewTab() {
            const input = document.getElementById('urlInput').value.trim();
            
            if (!input) {
                showError('âŒ è¯·å…ˆè¾“å…¥ä¸€ä¸ªé“¾æ¥ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»£ç 
            if (input.toLowerCase() === 'prox') {
                openSecretSettings();
                // æ ‡è®°å·²è®¿é—®è¿‡é¡µé¢ï¼Œå¹¶æ˜¾ç¤ºå¿«é€Ÿè®¿é—®æŒ‰é’®
                hasAccessedSecret = true;
                document.getElementById('quickAccessBtn').style.display = 'block';
                return;
            }

            try {
                let urlToOpen = input;

                // å¦‚æœç”¨æˆ·æ²¡è¾“å…¥åè®®ï¼Œæˆ‘ä»¬é»˜è®¤è¡¥ä¸Š https://
                if (!urlToOpen.startsWith('http://') && !urlToOpen.startsWith('https://')) {
                    urlToOpen = 'https://' + urlToOpen;
                }

                // è·å–ä»£ç†URL
                const proxyUrl = getProxyUrl();
                if (!proxyUrl) {
                    showError('âŒ è¯·é€‰æ‹©æˆ–è¾“å…¥æœåŠ¡å™¨åœ°å€ï¼');
                    return;
                }

                // æ¸…ç†ä»£ç†URLï¼ˆç§»é™¤æœ«å°¾çš„æ–œæ ï¼‰
                const cleanProxyUrl = proxyUrl.replace(/\/+$/, '');
                
                // æ‰§è¡Œæ›¿æ¢ï¼ši.pximg.net â†’ é€‰æ‹©çš„ä»£ç†åŸŸå
                const newTabUrl = urlToOpen.replace(
                    /i\.pximg\.net/g, 
                    cleanProxyUrl.replace(/^https?:\/\//, '')
                );

                if (newTabUrl === urlToOpen) {
                    showError('âš ï¸ <br> æ­¤éPixivåŸå›¾é“¾æ¥ <br> é“¾æ¥åº”ä¸º https://i.pximg.net/img-original/img/... <br> æ— æ³•æ‰“å¼€ã€‚è¯·æ£€æŸ¥è¾“å…¥çš„é“¾æ¥æ˜¯å¦æ­£ç¡®ã€‚');
                    return;
                }

                // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
                window.open(newTabUrl, '_blank');

            } catch (err) {
                showError('âŒ å¤„ç†é“¾æ¥æ—¶å‡ºé”™ï¼š' + err.message);
            }
        }

        function downloadImage() {
            if (!replacedUrl) {
                showError('âŒ æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡é“¾æ¥');
                return;
            }

            // åˆ›å»ºä¸€ä¸ªéšè—çš„aæ ‡ç­¾ç”¨äºä¸‹è½½
            const a = document.createElement('a');
            a.href = replacedUrl;
            
            // ä»URLä¸­æå–æ–‡ä»¶å
            let filename = 'pixiv-image.png';
            if (originalUrl) {
                filename = originalUrl.split('/').pop();
            } else if (replacedUrl && !replacedUrl.startsWith('blob:')) {
                filename = replacedUrl.split('/').pop();
            }
            a.download = filename;
            
            // è§¦å‘ä¸‹è½½
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function showError(msg) {
            const elem = document.getElementById('errorMsg');
            elem.innerHTML = msg;
            elem.style.display = 'block';
        }

        function showInfo(msg) {
            const elem = document.getElementById('infoMsg');
            elem.innerHTML = msg;
            elem.style.display = 'block';
        }

        function copyToClipboard(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const notification = document.createElement('div');
                notification.className = 'copy-notification show-copy-notification';
                notification.textContent = 'å·²å¤åˆ¶!';
                element.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.remove('show-copy-notification');
                    setTimeout(() => {
                        element.removeChild(notification);
                    }, 300);
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        // --- Feature 1: Pagination Logic ---
        function getUrlPage(url) {
            const match = url.match(/_p(\d+)(\.[a-zA-Z0-9]+)?$/);
            if (match) {
                return parseInt(match[1], 10);
            }
            return null; // Not found
        }

        function setUrlPage(url, page) {
            // If URL has _p\d+, replace it.
            if (/_p(\d+)(\.[a-zA-Z0-9]+)?$/.test(url)) {
                return url.replace(/_p(\d+)(\.[a-zA-Z0-9]+)?$/, `_p${page}$2`);
            }
            // If not, try to insert before extension?
            const extMatch = url.match(/(\.[a-zA-Z0-9]+)$/);
            if (extMatch) {
                return url.replace(/(\.[a-zA-Z0-9]+)$/, `_p${page}$1`);
            }
            return url + `_p${page}`;
        }

        function updatePageControlFromUrl() {
            const input = document.getElementById('urlInput');
            const pageInput = document.getElementById('urlPageInput');
            if (!input || !pageInput) return;
            const page = getUrlPage(input.value);
            if (page !== null) {
                pageInput.value = page + 1;
            }
        }

        function changeUrlPage(delta) {
            const input = document.getElementById('urlInput');
            let val = input.value.trim();
            if (!val) return;
            
            let page = getUrlPage(val);
            if (page === null) page = 0; // Default start at 0
            
            let newPage = page + delta;
            if (newPage < 0) newPage = 0;
            
            const newUrl = setUrlPage(val, newPage);
            input.value = newUrl;
            document.getElementById('urlPageInput').value = newPage + 1;
            
            // Trigger checkSecretCode just in case (though prox/random won't match)
            // checkSecretCode(); 
        }

        function jumpUrlPage(page) {
            const input = document.getElementById('urlInput');
            let val = input.value.trim();
            if (!val) return;
            
            let displayPage = parseInt(page, 10);
            if (isNaN(displayPage) || displayPage < 1) displayPage = 1;
            
            let newPage = displayPage - 1;
            if (newPage < 0) newPage = 0;
            
            const newUrl = setUrlPage(val, newPage);
            input.value = newUrl;
            document.getElementById('urlPageInput').value = displayPage;
        }

        // --- Feature 2: Quick Random Image ---
        async function quickRandomImage() {
            if (!isGalleryLoaded) {
                 // Try to load default or currently selected
                 await loadGalleryData();
            }
            
            if (galleryData.length === 0) {
                 alert('è¯·å…ˆåœ¨å›¾åº“ä¸­åŠ è½½æ•°æ®ï¼');
                 openGalleryBrowser(); 
                 return;
            }
            
            pickRandomImage();
        }

        // --- Feature 3: API Random Image ---
        function loadApiImage() {
            const apiUrl = 'https://img.futa.de5.net/1';
            // User requested no timestamp
            const targetUrl = apiUrl;
            
            const errorMsg = document.getElementById('errorMsg');
            const infoMsg = document.getElementById('infoMsg');
            const imageContainer = document.getElementById('imageContainer');
            const resultImage = document.getElementById('resultImage');
            const resultLinkContainer = document.getElementById('resultLinkContainer');
            const resultLink = document.getElementById('resultLink');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // Reset UI
            errorMsg.style.display = 'none';
            infoMsg.style.display = 'none';
            imageContainer.style.display = 'block';
            resultLinkContainer.style.display = 'block';
            
            // Show loading state
            loadingIndicator.style.display = 'block';
            resultImage.style.display = 'none';
            
            // Update Link Display
            resultLink.textContent = apiUrl;
            
            // Reset global vars for download
            originalUrl = ''; 
            replacedUrl = targetUrl;
            
            // Reset Image Class
            isOriginalSize = false;
            resultImage.className = 'scaled-image';
            
            // Use existing stream loader (supports progress bar if CORS allows)
            loadImageWithProgress(targetUrl);
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            handleProxyChange(); // åˆå§‹åŒ–ä»£ç†é€‰æ‹©æ˜¾ç¤ºçŠ¶æ€
            handleSecretProxyChange(); // åˆå§‹åŒ–ç§˜å¯†è®¾ç½®ä»£ç†é€‰æ‹©æ˜¾ç¤ºçŠ¶æ€
            
            // æ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½é‡ç½®çŠ¶æ€ï¼Œå¿«é€Ÿè®¿é—®æŒ‰é’®é»˜è®¤éšè—
            hasAccessedSecret = false;
            document.getElementById('quickAccessBtn').style.display = 'none';
        });
    </script>
</body>
</html>
