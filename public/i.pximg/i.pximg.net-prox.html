<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PixivÂéüÂõæi.pximg.net</title>
    <style>
        /* Cache Dashboard Floating Button */
        .cache-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #6a5acd;
            color: #fff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 999;
            transition: transform 0.2s, background 0.2s;
        }
        .cache-fab:hover { transform: scale(1.1); background: #7b6be0; }

        /* Cache Dashboard Modal */
        .cache-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .cache-modal-content {
            background: #2a2a3a;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        .cache-header {
            padding: 20px;
            border-bottom: 1px solid #4b0082;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cache-header h2 { margin: 0; color: #b19cd9; }
        .cache-close {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }
        .cache-body { padding: 20px; overflow-y: auto; flex: 1; }
        .cache-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #3a3a4a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #4b0082;
            text-align: center;
        }
        .stat-val { font-size: 24px; font-weight: bold; color: #e6e6fa; }
        .stat-label { font-size: 14px; color: #b19cd9; }
        .cache-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            padding: 0;
            margin: 0;
        }
        .cache-item {
            display: flex;
            flex-direction: column;
            background: #3a3a4a;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #4b0082;
        }
        .cache-thumb { width: 100%; height: 100px; object-fit: cover; background: #000; }
        .cache-info { padding: 8px; font-size: 12px; }
        .cache-url { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 4px; color: #add8e6; }
        .cache-size { color: #888; }
        .cache-footer {
            padding: 20px;
            border-top: 1px solid #4b0082;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn-danger { background: #ff4757; }
        .btn-danger:hover { background: #ff6b81; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Main Dark Theme Styles */
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a2e;
            color: #e6e6fa;
        }
        .container {
            background: #2a2a3a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        h1 { text-align: center; color: #b19cd9; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #b19cd9; }
        input[type="url"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #4b0082;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: #3a3a4a;
            color: #e6e6fa;
        }
        input[type="url"]:focus { border-color: #9370db; outline: none; }
        select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #4b0082;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: #3a3a4a;
            color: #e6e6fa;
            margin-bottom: 10px;
        }
        select:focus { border-color: #9370db; outline: none; }
        .custom-proxy-input { display: none; margin-top: 10px; }
        button {
            padding: 12px;
            font-size: 16px;
            background-color: #6a5acd;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #9370db; }
        .button-row { display: flex; gap: 10px; }
        .button-row button { flex: 1; }
        .image-container {
            margin-top: 30px;
            border: 1px solid #4b0082;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            min-height: 400px;
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(2px);
        }
        .image-label {
            background: #4b0082;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #4b0082;
            color: #fff;
        }
        .image-wrapper {
            width: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        .scaled-image { max-width: 100%; max-height: 600px; object-fit: contain; }
        .original-image { max-width: none; max-height: none; width: auto; height: auto; }
        .error {
            color: #ff6b6b;
            background: #3a1a1a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #ff6b6b;
        }
        .info {
            background: #2a3a4a;
            color: #add8e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        .result-link-container {
            margin-top: 20px;
            padding: 15px;
            background: #3a3a4a;
            border-radius: 6px;
            border: 1px solid #4b0082;
        }
        .result-link-label { font-weight: bold; margin-bottom: 10px; display: block; color: #b19cd9; }
        .result-link {
            word-break: break-all;
            padding: 10px;
            background: #2a2a3a;
            border: 1px solid #4b0082;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            color: #e6e6fa;
        }
        .result-link:hover { background: #3a3a4a; }
        .copy-notification {
            position: absolute;
            top: -30px;
            right: 0;
            background: #6a5acd;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .show-copy-notification { opacity: 1; }
        .button-container {
            display: flex;
            justify-content: flex-end;
            padding: 10px;
            background: #3a3a4a;
            border-top: 1px solid #4b0082;
        }
        .show-original-btn { width: auto; margin-top: 0; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .secret-settings {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .secret-settings-content {
            background: #2a2a3a;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .secret-settings h2 { color: #b19cd9; margin-bottom: 20px; text-align: center; }
        .secret-input-group { margin-bottom: 20px; }
        .secret-input-group label { display: block; margin-bottom: 8px; color: #b19cd9; }
        .secret-input-group input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #4b0082;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: #3a3a4a;
            color: #e6e6fa;
        }
        .secret-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .secret-buttons button { flex: 1; }
        .close-secret { background: #ff6b6b !important; }
        .close-secret:hover { background: #ff5252 !important; }

        .quick-access-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
            display: none;
        }
        .quick-access-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-top: 0;
        }
        .quick-access-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(0,0,0,0.6); }

        .details-container {
            margin-top: 15px;
            background: #2a2a3a;
            border: 1px solid #4b0082;
            border-radius: 6px;
            padding: 15px;
            display: none;
        }
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { color: #b19cd9; font-weight: bold; font-size: 12px; margin-bottom: 4px; }
        .detail-value { color: #e6e6fa; word-break: break-all; }
        .tag-pill {
            display: inline-block;
            background: #4b0082;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px;
            font-size: 12px;
            white-space: nowrap;
        }

        .function-toggle {
            display: flex;
            margin-bottom: 20px;
            border: 1px solid #4b0082;
            border-radius: 6px;
            overflow: hidden;
        }
        .function-toggle button {
            flex: 1;
            margin: 0;
            border-radius: 0;
            background-color: #3a3a4a;
        }
        .function-toggle button.active { background-color: #6a5acd; }

        /* Gallery Layout Styles */
        .gallery-body { display: flex; gap: 20px; height: 70vh; margin-top: 10px; }
        .gallery-sidebar {
            width: 250px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 15px;
            border-right: 1px solid #4b0082;
        }
        .gallery-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .gallery-table-container { flex: 1; overflow: auto; border: 1px solid #4b0082; border-radius: 6px; }
        .gallery-table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 14px; }
        .gallery-table thead { background: #4b0082; color: #fff; position: sticky; top: 0; z-index: 10; }
        .gallery-table th, .gallery-table td { padding: 10px; }
        .gallery-table th.th-center { text-align: center; }
        .gallery-table th.th-left { text-align: left; }
        .gallery-row { border-bottom: 1px solid #3a3a4a; color: #e6e6fa; }
        .cell-title { min-width: 280px; max-width: 480px; white-space: normal; word-break: normal; overflow-wrap: break-word; }
        .cell-desc { min-width: 380px; max-width: 640px; white-space: normal; word-break: normal; overflow-wrap: break-word; }
        .cell-action { display: flex; gap: 5px; justify-content: center; }
        .action-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #6a5acd;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            cursor: pointer;
        }
        .action-btn:hover { background: #7b6be0; }
        .cell-tags { display: grid; grid-template-columns: repeat(2, max-content); gap: 6px 10px; align-items: center; }
        .tag-toggle {
            display: inline-block;
            padding: 2px 6px;
            font-size: 12px;
            background: #4b0082;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            margin-left: 6px;
            vertical-align: middle;
            align-self: center;
        }
        .fill-url-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #6a5acd;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            cursor: pointer;
        }
        .fill-url-btn:hover { background: #7b6be0; }
        .meta-pill { display: inline-block; background: #3a3a4a; color: #e6e6fa; padding: 2px 6px; border-radius: 12px; margin-right: 6px; font-size: 12px; white-space: nowrap; }
        .cell-meta { white-space: nowrap; }
        .tag-dropdown { position: relative; }
        .tag-panel {
            display: none;
            position: absolute;
            left: 0;
            top: 100%;
            z-index: 20;
            background: #3a3a4a;
            border: 1px solid #4b0082;
            border-radius: 6px;
            padding: 10px;
            max-height: 220px;
            overflow: auto;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .tag-panel.open { display: block; overflow-y: auto; overflow-x: hidden; }
        .tag-item {
            display: block;
            padding: 4px 6px;
            font-size: 12px;
            border-radius: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .tag-item.selected { background: #6a5acd; color: #fff; }
        .tag-dropdown button { width: 100%; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filters-row { display: flex; gap: 8px; }
        .filters-row .tag-dropdown { flex: 1; min-width: 0; }
        .selected-tags-row { display: flex; align-items: center; gap: 10px; }
        .selected-group { flex: 1; min-width: 0; display: flex; align-items: center; gap: 6px; }
        .selected-label { color: #b19cd9; font-size: 12px; }
        .selected-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .selected-tags .tag-pill { cursor: pointer; }
        .thumb-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #3a3a4a;
            border: 1px solid #4b0082;
            color: #e6e6fa;
            border-radius: 4px;
        }
        .pager-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; }
        .pager-select, .pager-input {
            padding: 8px 10px;
            background: #3a3a4a;
            border: 1px solid #4b0082;
            color: #e6e6fa;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.2;
        }
        .pager-row select, .pager-row input { width: auto !important; flex: 0 0 auto; }
        .pager-btn {
            padding: 8px 12px;
            background: #6a5acd;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.2;
        }
        .pager-btn:hover { background: #7b6be0; }
        .gallery-table thead th.action-col { position: sticky; left: 0; z-index: 11; background: #4b0082; }
        .gallery-table tbody td.action-col { position: sticky; left: 0; z-index: 5; background: #2a2a3a; border-right: 1px solid #3a3a4a; }
        .gallery-sidebar select, .gallery-sidebar input, .gallery-sidebar .input-wrapper { width: 100% !important; box-sizing: border-box; }
        .gallery-sidebar .filters-row select, .gallery-sidebar .filters-row input { width: auto !important; flex: 0 0 auto; }
        .gallery-sidebar .filters-row .thumb-option { flex: 0 0 auto; }
 
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a2e;
            color: #e6e6fa;
        }

        .container {
            background: #2a2a3a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #b19cd9;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #b19cd9;
        }

        input[type="url"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #4b0082;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: #3a3a4a;
            color: #e6e6fa;
        }

        input[type="url"]:focus {
            border-color: #9370db;
            outline: none;
        }

        select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #4b0082;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: #3a3a4a;
            color: #e6e6fa;
            margin-bottom: 10px;
        }

        select:focus {
            border-color: #9370db;
            outline: none;
        }

        .custom-proxy-input {
            display: none;
            margin-top: 10px;
        }

        button {
            padding: 12px;
            font-size: 16px;
            background-color: #6a5acd;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #9370db;
        }

        .button-row {
            display: flex;
            gap: 10px;
        }

        .button-row button {
            flex: 1;
        }

        .image-container {
            margin-top: 30px;
            border: 1px solid #4b0082;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            min-height: 400px; /* Layout stability */
        }

        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(2px);
        }

        .image-label {
            background: #4b0082;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #4b0082;
            color: white;
        }

        .image-wrapper {
            width: 100%;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }

        .scaled-image {
            max-width: 100%;
            max-height: 600px;
            object-fit: contain;
        }

        .original-image {
            max-width: none;
            max-height: none;
            width: auto;
            height: auto;
        }

        .error {
            color: #ff6b6b;
            background: #3a1a1a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #ff6b6b;
        }

        .info {
            background: #2a3a4a;
            color: #add8e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .result-link-container {
            margin-top: 20px;
            padding: 15px;
            background: #3a3a4a;
            border-radius: 6px;
            border: 1px solid #4b0082;
        }
        
        .result-link-label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            color: #b19cd9;
        }
        
        .result-link {
            word-break: break-all;
            padding: 10px;
            background: #2a2a3a;
            border: 1px solid #4b0082;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            color: #e6e6fa;
        }
        
        .result-link:hover {
            background: #3a3a4a;
        }
        
        .copy-notification {
            position: absolute;
            top: -30px;
            right: 0;
            background: #6a5acd;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .show-copy-notification {
            opacity: 1;
        }

        .button-container {
            display: flex;
            justify-content: flex-end;
            padding: 10px;
            background: #3a3a4a;
            border-top: 1px solid #4b0082;
        }

        .show-original-btn {
            width: auto;
            margin-top: 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .secret-settings {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .secret-settings-content {
            background: #2a2a3a;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .secret-settings h2 {
            color: #b19cd9;
            margin-bottom: 20px;
            text-align: center;
        }

        .secret-input-group {
            margin-bottom: 20px;
        }

        .secret-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #b19cd9;
        }

        .secret-input-group input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #4b0082;
            border-radius: 6px;
            box-sizing: border-box;
            background-color: #3a3a4a;
            color: #e6e6fa;
        }

        .secret-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .secret-buttons button {
            flex: 1;
        }

        .close-secret {
            background: #ff6b6b !important;
        }

        .close-secret:hover {
            background: #ff5252 !important;
        }

        /* Âø´ÈÄüËÆøÈóÆÊåâÈíÆÂÆπÂô® */
        .quick-access-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
            display: none; /* ÈªòËÆ§ÈöêËóè */
        }

        /* Âø´ÈÄüËÆøÈóÆÊåâÈíÆÊ†∑Âºè */
        .quick-access-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-top: 0; /* Override default button margin */
        }

        .quick-access-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }

        /* ËØ¶ÊÉÖ‰ø°ÊÅØÂÆπÂô® */
        .details-container {
            margin-top: 15px;
            background: #2a2a3a;
            border: 1px solid #4b0082;
            border-radius: 6px;
            padding: 15px;
            display: none; /* ÈªòËÆ§ÈöêËóè */
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: #b19cd9;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .detail-value {
            color: #e6e6fa;
            word-break: break-all;
        }

        /* Ê†áÁ≠æÊ†∑Âºè */
        .tag-pill {
            display: inline-block;
            background: #4b0082;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* ÂäüËÉΩÂàáÊç¢ÊåâÈíÆÊ†∑Âºè */
        .function-toggle {
            display: flex;
            margin-bottom: 20px;
            border: 1px solid #4b0082;
            border-radius: 6px;
            overflow: hidden;
        }

        .function-toggle button {
            flex: 1;
            margin: 0;
            border-radius: 0;
            background-color: #3a3a4a;
        }

        .function-toggle button.active {
            background-color: #6a5acd;
        }

        /* Gallery Layout Styles */
        .gallery-body {
            display: flex;
            gap: 20px;
            height: 70vh; /* Fixed height for internal scrolling */
            margin-top: 10px;
        }

        .gallery-sidebar {
            width: 250px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
            border-right: 1px solid #4b0082;
            padding-right: 15px;
        }

        .gallery-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Crucial for flex child overflow */
        }

        .gallery-table-container {
            flex: 1;
            overflow: auto; /* Both horizontal and vertical scroll */
            border: 1px solid #4b0082;
            border-radius: 6px;
        }
        
        /* --- Gallery Table Styles (maintainability) --- */
        .gallery-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            font-size: 14px;
        }
        .gallery-table thead {
            background: #4b0082;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .gallery-table th, .gallery-table td {
            padding: 10px;
        }
        .gallery-table th.th-center { text-align: center; }
        .gallery-table th.th-left { text-align: left; }
        .gallery-row { border-bottom: 1px solid #3a3a4a; color: #e6e6fa; }
        .cell-title {
            min-width: 280px;
            max-width: 480px;
            white-space: normal;
            word-break: normal;
            overflow-wrap: break-word;
        }
        .cell-desc {
            min-width: 380px;
            max-width: 640px;
            white-space: normal;
            word-break: normal;
            overflow-wrap: break-word;
        }
        .cell-action {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .action-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #6a5acd;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            cursor: pointer;
        }
        .action-btn:hover { background: #7b6be0; }
        .cell-tags {
            display: grid;
            grid-template-columns: repeat(2, max-content);
            gap: 6px 10px;
            align-items: center;
        }
        .tag-toggle {
            display: inline-block;
            padding: 2px 6px;
            font-size: 12px;
            background: #4b0082;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            margin-left: 6px;
            vertical-align: middle;
            align-self: center;
        }
        .fill-url-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #6a5acd;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            cursor: pointer;
        }
        .fill-url-btn:hover { background: #7b6be0; }
        .meta-pill {
            display: inline-block;
            background: #3a3a4a;
            color: #e6e6fa;
            padding: 2px 6px;
            border-radius: 12px;
            margin-right: 6px;
            font-size: 12px;
            white-space: nowrap;
        }
        .cell-meta { white-space: nowrap; }
        /* Tag dropdown controls */
        .tag-dropdown {
            position: relative;
        }
        .tag-panel {
            display: none;
            position: absolute;
            left: 0;
            top: 100%;
            z-index: 20;
            background: #3a3a4a;
            border: 1px solid #4b0082;
            border-radius: 6px;
            padding: 10px;
            max-height: 220px;
            overflow: auto;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .tag-panel.open { 
            display: block;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .tag-item {
            display: block;
            padding: 4px 6px;
            font-size: 12px;
            border-radius: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .tag-item.selected {
            background: #6a5acd;
            color: #fff;
        }
        .tag-dropdown button {
            width: 100%;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .filters-row {
            display: flex;
            gap: 8px;
        }
        .filters-row .tag-dropdown { flex: 1; min-width: 0; }
        .selected-tags-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .selected-group {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .selected-label {
            color: #b19cd9;
            font-size: 12px;
        }
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .selected-tags .tag-pill { cursor: pointer; }
        .thumb-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #3a3a4a;
            border: 1px solid #4b0082;
            color: #e6e6fa;
            border-radius: 4px;
        }
        .pager-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }
        .pager-select, .pager-input {
            padding: 8px 10px;
            background: #3a3a4a;
            border: 1px solid #4b0082;
            color: #e6e6fa;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.2;
        }
        .pager-row select, 
        .pager-row input {
            width: auto !important;
            flex: 0 0 auto;
        }
        .pager-btn {
            padding: 8px 12px;
            background: #6a5acd;
            color: #fff;
            border: 1px solid #7a6eea;
            border-radius: 14px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.2;
        }
        .pager-btn:hover { background: #7b6be0; }
        /* Sticky first column (Action) */
        .gallery-table thead th.action-col {
            position: sticky;
            left: 0;
            z-index: 11;
            background: #4b0082;
        }
        .gallery-table tbody td.action-col {
            position: sticky;
            left: 0;
            z-index: 5;
            background: #2a2a3a;
            border-right: 1px solid #3a3a4a;
        }
        
        /* Sidebar inputs styling override */
        .gallery-sidebar select, 
        .gallery-sidebar input,
        .gallery-sidebar .input-wrapper {
            width: 100% !important;
            box-sizing: border-box;
        }
        /* Do NOT stretch compact rows */
        .gallery-sidebar .filters-row select,
        .gallery-sidebar .filters-row input {
            width: auto !important;
            flex: 0 0 auto;
        }
        .gallery-sidebar .filters-row .thumb-option {
            flex: 0 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PixivÂéüÂõæ <br> i.pximg.net</h1>

        <!-- Âø´ÈÄüËÆøÈóÆÊåâÈíÆ -->
        <div id="quickAccessContainer" class="quick-access-container">
            <button id="quickAccessBtn" class="quick-access-btn" style="background-color: #9370db; display: none;" onclick="openSecretSettings()" title="ËÆæÁΩÆ">
                ‚öô
            </button>
            <button id="galleryBtn" class="quick-access-btn" style="background-color: #ff9f43; display: none;" onclick="openGalleryBrowser()" title="ÂõæÂ∫ì">
                üìÇ
            </button>
            <button id="quickRandomBtn" class="quick-access-btn" style="background-color: #ff6b6b; display: none;" onclick="quickRandomImage()" title="ÈöèÊú∫‰∏ÄÂõæ">
                üé≤
            </button>
        </div>

        <div class="input-group">
            <label for="proxySelect">ÈÄâÊã©ÊúçÂä°Âô®Ôºö</label>
            <select id="proxySelect" onchange="handleProxyChange()">
                <option value="https://prox.futa.de5.net/">Á´ôÈïøËá™Âª∫</option>
                <option value="https://prox.spacetimee.xyz/">GithubÂ§ß‰Ω¨ÂÖ¨ÂºÄ</option>
                <option value="custom">Ëá™ÂÆö‰πâ</option>
            </select>
            <input 
                type="url" 
                id="customProxyInput" 
                class="custom-proxy-input"
                placeholder="ËØ∑ËæìÂÖ•Ëá™ÂÆö‰πâÁΩëÂùÄÔºå‰æãÂ¶ÇÔºöhttps://prox.yourdomainname.domain/"
            />
        </div>

        <div class="input-group">
            <label for="urlInput">ËØ∑ËæìÂÖ•PixivÂéüÂõæ <br> i.pximg.net ÁöÑÈìæÊé•Ôºö</label>
            <input 
                type="url" 
                id="urlInput" 
                placeholder="‰æãÂ¶ÇÔºöhttps://i.pximg.net/img-original/img/..."
                oninput="checkSecretCode(); updatePageControlFromUrl()"
            />
            <div class="pager-control-row" style="display:flex; align-items:center; gap:10px; margin-top:10px; margin-bottom:10px;">
                <button onclick="changeUrlPage(-1)" style="margin:0; flex:1; background-color: #5a4a9d;">‚óÄ ‰∏ä‰∏ÄÂº†</button>
                <div style="flex:0 0 100px; display:flex; align-items:center; justify-content:center; background:#3a3a4a; border:2px solid #4b0082; border-radius:6px; padding:0;">
                     <span style="color:#b19cd9; margin-right:5px; font-weight:bold;">P</span>
                     <input type="number" id="urlPageInput" value="1" min="1" style="background:transparent; border:none; color:#e6e6fa; width:50px; text-align:center; font-size:16px; padding:10px 0;" onchange="jumpUrlPage(this.value)">
                </div>
                <button onclick="changeUrlPage(1)" style="margin:0; flex:1; background-color: #5a4a9d;">‰∏ã‰∏ÄÂº† ‚ñ∂</button>
            </div>
            <div class="button-row">
                <button onclick="processLink()">üîÑ Âä†ËΩΩÂõæÁâá</button>
                <button onclick="loadApiImage()">üé≤ API ÈöèÊú∫Âõæ</button>
                <button onclick="openInNewTab()">üîó Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄÂéüÂõæ</button>
            </div>
        </div>

        <div id="errorMsg" class="error" style="display: none;"></div>
        <div id="infoMsg" class="info" style="display: none;"></div>

        <!-- ÊòæÁ§∫ËΩ¨Êç¢ÂêéÁöÑÈìæÊé• -->
        <div id="resultLinkContainer" class="result-link-container" style="display: none;">
            <span class="result-link-label">ÂèØÁõ¥Êé•ËÆøÈóÆÁöÑÈìæÊé•ÔºàÁÇπÂáªÂèØÂ§çÂà∂ÔºâÔºö</span>
            <div id="resultLink" class="result-link" onclick="copyToClipboard(this)"></div>
        </div>

        <!-- ‰∏ãÊñπÁî®‰∫éÊòæÁ§∫ÂõæÁâá -->
        <div id="imageContainer" class="image-container" style="display: none;">
            <div class="image-label">ÂõæÁâáÂÜÖÂÆπÔºàÂè≥ÈîÆ/ÈïøÊåâÂèØ‰øùÂ≠òÔºâÔºö</div>
            <div class="image-wrapper" id="imageWrapper">
                <div id="loadingIndicator" style="display: none; padding: 20px;">
                    <span class="loading"></span>
                    <span id="loadingText">Ê≠£Âú®Âä†ËΩΩÂõæÁâá...</span>
                    <div id="progressContainer" style="margin-top: 10px; width: 100%; max-width: 300px; height: 5px; background: #3a3a4a; border-radius: 3px; overflow: hidden; display: none;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: #6a5acd; transition: width 0.1s;"></div>
                    </div>
                    <div id="progressStats" style="font-size: 12px; color: #b19cd9; margin-top: 5px; display: none;">0%</div>
                </div>
                <img id="resultImage" src="" alt="PixivÂõæÁâá" style="display: none;" />
            </div>
            <div class="button-container">
                <button id="downloadBtn" class="show-original-btn" onclick="downloadImage()">‰∏ãËΩΩÂéüÂõæ</button>
            </div>
        </div>

        <!-- ËØ¶ÁªÜ‰ø°ÊÅØÂ±ïÁ§∫Âå∫ -->
        <div id="detailsContainer" class="details-container">
            <h3 style="margin-top: 0; color: #b19cd9; margin-bottom: 10px;">üìÑ ÂõæÁâáËØ¶ÊÉÖ</h3>
            <div id="detailsGrid" class="details-grid">
                <!-- Content will be injected via JS -->
            </div>
        </div>
    </div>

    <!-- ÈùôÊÄÅËµÑÊ∫êÈ°µÈù¢ -->
    <div id="secretSettings" class="secret-settings">
        <div class="secret-settings-content">
            <h2>ÈùôÊÄÅËµÑÊ∫ê</h2>
            
            <!-- ÂäüËÉΩÂàáÊç¢ÊåâÈíÆ -->
            <div class="function-toggle">
                <button id="staticResourceBtn" class="active" onclick="switchFunction('static')">ÈùôÊÄÅËµÑÊ∫ê</button>
                <button id="AnotherBtn" onclick="switchFunction('Another')">Âè¶‰∏Ä‰∏™ÈùôÊÄÅËµÑÊ∫ê-PikPak</button>
            </div>
            
            <!-- ÈùôÊÄÅËµÑÊ∫êÈÉ®ÂàÜ -->
            <div id="staticResourceSection">
                <div class="secret-input-group">
                    <label for="secretProxySelect">ÈÄâÊã©ÊúçÂä°Âô®Ôºö</label>
                    <select id="secretProxySelect" onchange="handleSecretProxyChange()">
                        <option value="https://prox.futa.de5.net/">Á´ôÈïøËá™Âª∫</option>
                        <option value="https://prox.spacetimee.xyz/">GithubÂ§ß‰Ω¨ÂÖ¨ÂºÄ</option>
                        <option value="custom">Ëá™ÂÆö‰πâ</option>
                    </select>
                    <input 
                        type="url" 
                        id="secretCustomProxyInput" 
                        class="custom-proxy-input"
                        placeholder="ËØ∑ËæìÂÖ•Ëá™ÂÆö‰πâÁΩëÂùÄÔºå‰æãÂ¶ÇÔºöhttps://prox.mydomain.com/"
                    />
                </div>
                <div class="secret-input-group">
                    <label for="secretInput">ËæìÂÖ•ÂÜÖÂÆπÔºö</label>
                    <input 
                        type="text" 
                        id="secretInput" 
                        placeholder="ËØ∑ËæìÂÖ•ÈùôÊÄÅËµÑÊ∫êÈìæÊé•..."
                    />
                </div>
            </div>
            
            <!-- Âè¶‰∏Ä‰∏™ÈùôÊÄÅËµÑÊ∫êÈÉ®ÂàÜ -->
            <div id="AnotherSection" style="display: none;">
                <div class="secret-input-group">
                    <label for="AnotherInput">ËæìÂÖ•ÈìæÊé•Ôºö</label>
                    <input 
                        type="text" 
                        id="AnotherInput" 
                        placeholder="ËØ∑ËæìÂÖ•ÈìæÊé•..."
                    />
                </div>
            </div>
            
            <div class="secret-buttons">
                <button onclick="handleSecretAction()">ÊâßË°åÊìç‰Ωú</button>
                <button class="close-secret" onclick="closeSecretSettings()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

        <!-- Gallery Browser Modal -->
    <div id="galleryBrowser" class="secret-settings" style="display: none;">
        <div class="secret-settings-content" style="max-width: 1200px; width: 95%; height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h2 style="margin: 0;">ÂõæÂ∫ìÊµèËßà</h2>
                    <button onclick="pickRandomImage()" style="margin: 0; padding: 8px 15px; background: #ff9f43; font-size: 14px; border-radius: 4px; border: none; cursor: pointer; color: white;">üé≤ ÈöèÊú∫‰∏ÄÂõæ</button>
                    <label class="thumb-option" for="useThumbCheckbox">
                        <input type="checkbox" id="useThumbCheckbox" />
                        ‰ΩøÁî®Áº©Áï•Âõæ
                    </label>
                </div>
                <button class="close-secret" onclick="closeGalleryBrowser()" style="width: auto; padding: 5px 15px;">‚úï</button>
            </div>
            
            <div class="gallery-body">
                <div class="gallery-sidebar">
                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">Êï∞ÊçÆÊ∫ê</label>
                        <select id="galleryCsvSelect" onchange="loadGalleryData()" style="padding: 10px; background: #3a3a4a; border: 1px solid #4b0082; color: #e6e6fa; border-radius: 4px;">
                            <!-- Options injected via JS -->
                        </select>
                        <input type="file" id="localCsvInput" accept=".csv" style="display:none;">
                    </div>

                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">ÊêúÁ¥¢</label>
                        <input type="text" id="gallerySearch" placeholder="ÊêúÁ¥¢Ê†áÈ¢ò„ÄÅÊèèËø∞„ÄÅID..." style="padding: 10px; background: #3a3a4a; border: 1px solid #4b0082; color: #e6e6fa; border-radius: 4px;">
                    </div>
                
                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">ÊéíÂ∫è</label>
                        <select id="gallerySort" style="padding: 10px; background: #3a3a4a; border: 1px solid #4b0082; color: #e6e6fa; border-radius: 4px;">
                            <option value="newest">üìÖ Êó•ÊúüÊúÄÊñ∞</option>
                            <option value="oldest">üìÖ Êó•ÊúüÊúÄÊó©</option>
                            <option value="id_desc">üî¢ ID ÈôçÂ∫è</option>
                            <option value="id_asc">üî¢ ID ÂçáÂ∫è</option>
                            <option value="view_desc">üëÅÔ∏è ÊµèËßàÊúÄÂ§ö</option>
                            <option value="like_desc">‚ù§Ô∏è Êî∂ËóèÊúÄÂ§ö</option>
                        </select>
                    </div>

                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">Ê†áÁ≠æÁ≠õÈÄâ</label>
                        <div class="filters-row">
                            <div class="tag-dropdown">
                                <button id="openTagInclude" style="padding:8px 10px;">ÈÄâÊã©ÂåÖÂê´Ê†áÁ≠æ</button>
                                <div id="tagIncludePanel" class="tag-panel"></div>
                            </div>
                            <div class="tag-dropdown">
                                <button id="openTagExclude" style="padding:8px 10px;">ÈÄâÊã©ÊéíÈô§Ê†áÁ≠æ</button>
                                <div id="tagExcludePanel" class="tag-panel"></div>
                            </div>
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">Â∑≤ÈÄâÊ†áÁ≠æ</label>
                        <div class="selected-tags-row">
                            <div class="selected-group">
                                <span class="selected-label">ÂåÖÂê´</span>
                                <div id="selectedInclude" class="selected-tags"></div>
                            </div>
                            <div class="selected-group">
                                <span class="selected-label">ÊéíÈô§</span>
                                <div id="selectedExclude" class="selected-tags"></div>
                            </div>
                            <button id="clearSelectedTags" class="pager-btn">Ê∏ÖÁ©∫</button>
                        </div>
                    </div>

                    <div class="input-wrapper">
                        <label style="display:block; color:#b19cd9; margin-bottom:5px; font-size:14px;">ÊòæÁ§∫ÈÄâÈ°π</label>
                        <div class="filters-row">
                            <select id="galleryAiFilter" class="pager-select">
                                <option value="">ü§ñ AI: ÂÖ®ÈÉ®</option>
                                <option value="YES">AI: ÊòØ</option>
                                <option value="NO">AI: Âê¶</option>
                            </select>
                            <select id="galleryDateFormat" class="pager-select">
                                <option value="raw">ÂéüÂßã</option>
                                <option value="local">Êú¨Âú∞Ê†ºÂºè</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="galleryStatus" style="color: #888; font-size: 12px; margin-top: 10px; word-break: break-all;"></div>
                </div>

                <!-- Main: Table -->
                <div class="gallery-main">
                    <div class="gallery-table-container">
                        <table class="gallery-table">
                            <thead>
                                <tr>
                                    <th class="th-center action-col">Êìç‰Ωú</th>
                                    <th class="th-left">ID</th>
                                    <th class="th-left">Ê†áÈ¢ò</th>
                                    <th class="th-left">ÊèèËø∞</th>
                                    <th class="th-left">Êñá‰ª∂Âêç</th>
                                    <th class="th-left">Ê†áÁ≠æ</th>
                                    <th class="th-left">È°µÁ†Å</th>
                                    <th class="th-left">ÈôêÂà∂Á∫ß</th>
                                    <th class="th-left">Êó•Êúü</th>
                                    <th class="th-left">ÊµèËßà</th>
                                    <th class="th-left">Êî∂Ëóè</th>
                                </tr>
                            </thead>
                            <tbody id="galleryTableBody">
                                <!-- Data injected via JS -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="galleryPagination" class="pager-row">
                        <label for="perPageSelect" style="color:#b19cd9;">ÊØèÈ°µ</label>
                        <select id="perPageSelect" class="pager-select">
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                        <button id="prevPageBtn" class="pager-btn">‰∏ä‰∏ÄÈ°µ</button>
                        <button id="nextPageBtn" class="pager-btn">‰∏ã‰∏ÄÈ°µ</button>
                        <span id="pageInfo" style="color:#888; font-size:12px;">Á¨¨ 1 / 1 È°µ</span>
                        <input id="pageInput" type="number" min="1" value="1" class="pager-input">
                        <button id="jumpPageBtn" class="pager-btn">Ë∑≥ËΩ¨</button>
                    </div>
                    
                    <div id="galleryLoading" style="text-align: center; padding: 20px; display: none;">
                        <span class="loading"></span> Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Dashboard FAB -->
    <div class="cache-fab" onclick="openCacheDashboard()" title="ÁºìÂ≠òÁÆ°ÁêÜ">
        üìä
    </div>

    <!-- Cache Dashboard Modal -->
    <div id="cacheModal" class="cache-modal">
        <div class="cache-modal-content">
            <div class="cache-header">
                <h2>ÁºìÂ≠òÁÆ°ÁêÜ</h2>
                <button class="cache-close" onclick="closeCacheDashboard()">√ó</button>
            </div>
            <div class="cache-body">
                <div class="cache-stats">
                    <div class="stat-card">
                        <div class="stat-val" id="cacheCount">0</div>
                        <div class="stat-label">ÁºìÂ≠òÂõæÁâáÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="cacheMemory">0 MB</div>
                        <div class="stat-label">È¢Ñ‰º∞Âç†Áî®ÂÜÖÂ≠ò</div>
                    </div>
                </div>
                <div class="cache-grid" id="cacheList">
                    <!-- Items will be populated here -->
                </div>
            </div>
            <div class="cache-footer">
                <button class="btn-danger" onclick="clearCache()">Ê∏ÖÁ©∫ÁºìÂ≠ò</button>
                <button onclick="closeCacheDashboard()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <script>
        let csvFilesConfig = [];
        let isOriginalSize = false;
        let originalUrl = '';
        let replacedUrl = '';
        let hasAccessedSecret = false; // Ê†áËÆ∞ÊòØÂê¶ËÆøÈóÆËøá
        let currentFunction = 'static'; // ÂΩìÂâçÂäüËÉΩÔºöstaticÊàñAnother
        
        // --- Image Cache ---
        // --- Performance & Optimization ---
        
        // 1. Image Cache Manager (LRU + Memory Cleanup)
        class ImageCacheManager {
            constructor(maxSize = 50) {
                this.maxSize = maxSize;
                this.cacheName = 'pximg-cache-v1';
                this.initCache();
            }

            async initCache() {
                if ('caches' in window) {
                    this.cacheStorage = await caches.open(this.cacheName);
                }
            }

            async has(key) { 
                if (!this.cacheStorage) return false;
                const match = await this.cacheStorage.match(key);
                return !!match;
            }

            async get(key) {
                if (!this.cacheStorage) return undefined;
                const response = await this.cacheStorage.match(key);
                if (response) {
                    const blob = await response.blob();
                    return URL.createObjectURL(blob);
                }
                return undefined;
            }

            async set(key, value, size = 0) {
                // value is blob URL, but Cache API needs Response
                // We should store the blob directly from fetch response if possible
                // But here we might receive objectUrl. 
                // Better approach: store fetch response directly in loadImageWithProgress
                // This method is kept for compatibility but should be adapted
                
                // If we receive a Blob directly (which we should refactor to do)
                // For now, let's fetch the blob from objectUrl and store it
                if (!this.cacheStorage) return;

                try {
                    const blob = await fetch(value).then(r => r.blob());
                    const response = new Response(blob, {
                        headers: { 'Content-Type': blob.type }
                    });
                    await this.cacheStorage.put(key, response);
                    
                    // Manage LRU size manually or rely on browser quota?
                    // Browser Cache API doesn't have built-in LRU.
                    // We need to implement manual cleanup if we want strict limit.
                    this.enforceLimit();
                    
                    updateCacheDashboard();
                } catch (e) {
                    console.error('Cache set error:', e);
                }
            }
            
            async enforceLimit() {
                if (!this.cacheStorage) return;
                const keys = await this.cacheStorage.keys();
                if (keys.length > this.maxSize) {
                    // Delete oldest (first ones)
                    // Note: keys() order is insertion order in Chrome/Firefox
                    const toDelete = keys.slice(0, keys.length - this.maxSize);
                    for (const request of toDelete) {
                        await this.cacheStorage.delete(request);
                    }
                }
            }
            
            async delete(key) {
                if (this.cacheStorage) {
                    await this.cacheStorage.delete(key);
                    updateCacheDashboard();
                }
            }
            
            async clear() {
                if (this.cacheStorage) {
                    const keys = await this.cacheStorage.keys();
                    for (const request of keys) {
                        await this.cacheStorage.delete(request);
                    }
                }
                updateCacheDashboard();
            }
            
            async getAll() {
                if (!this.cacheStorage) return [];
                const keys = await this.cacheStorage.keys();
                const items = [];
                
                // Reverse to show newest first
                for (let i = keys.length - 1; i >= 0; i--) {
                    const request = keys[i];
                    const response = await this.cacheStorage.match(request);
                    const blob = await response.blob();
                    items.push({
                        key: request.url,
                        size: blob.size,
                        blob: blob
                    });
                }
                return items;
            }
            
            async getSize() {
                if (!this.cacheStorage) return 0;
                const keys = await this.cacheStorage.keys();
                let total = 0;
                for (const req of keys) {
                    const res = await this.cacheStorage.match(req);
                    const blob = await res.blob();
                    total += blob.size;
                }
                return total;
            }
        }

        const imageCache = new ImageCacheManager(50);
        let currentFetchController = null; // For cancelling pending requests
        let lastClickTime = 0; // For throttling
        
        // --- Cache Dashboard Functions ---
        function openCacheDashboard() {
            updateCacheDashboard();
            document.getElementById('cacheModal').style.display = 'flex';
        }

        function closeCacheDashboard() {
            document.getElementById('cacheModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('cacheModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        async function updateCacheDashboard() {
            const list = document.getElementById('cacheList');
            const countEl = document.getElementById('cacheCount');
            const memEl = document.getElementById('cacheMemory');
            
            if (!list) return; // Not ready
            
            const items = await imageCache.getAll();
            const totalSize = await imageCache.getSize();
            
            countEl.textContent = items.length;
            memEl.textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
            
            list.innerHTML = '';
            if (items.length === 0) {
                list.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#888; padding:20px;">ÊöÇÊó†ÁºìÂ≠òÊï∞ÊçÆ</div>';
                return;
            }
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'cache-item';
                
                const sizeStr = (item.size / 1024).toFixed(1) + ' KB';
                const objectUrl = URL.createObjectURL(item.blob);
                
                div.innerHTML = `
                    <img src="${objectUrl}" class="cache-thumb" loading="lazy" alt="Cached Image">
                    <div class="cache-info">
                        <div class="cache-url" title="${item.key}">${item.key.split('/').pop()}</div>
                        <div class="cache-size">${sizeStr}</div>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                             <button onclick="downloadCacheItem('${item.key}')" style="flex:1; padding:4px; font-size:12px; background:#4b0082; margin:0;">‚¨á</button>
                             <button onclick="deleteCacheItem('${item.key}')" style="flex:1; padding:4px; font-size:12px; background:#ff4757; margin:0;">‚úï</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        async function deleteCacheItem(key) {
            await imageCache.delete(key);
        }

        async function downloadCacheItem(key) {
            try {
                const blobUrl = await imageCache.get(key);
                if (blobUrl) {
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = key.split('/').pop() || 'image.jpg';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(blobUrl);
                }
            } catch (e) {
                console.error('Download failed:', e);
                alert('‰∏ãËΩΩÂ§±Ë¥•');
            }
        }

        async function clearCache() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÁºìÂ≠òÂõæÁâáÂêóÔºü')) {
                await imageCache.clear();
            }
        }

        // --- Gallery Browser Variables ---
        let galleryData = [];
        let galleryTags = new Set();
        let tagCountsMap = {};
        let isGalleryLoaded = false;
        // -------------------------------------

        function initCsvSelect(failed = false) {
            const select = document.getElementById('galleryCsvSelect');
            if (!select) return;
            select.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = failed ? 'CSVÊñá‰ª∂Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•' : 'ËØ∑ÈÄâÊã©CSVÊñá‰ª∂';
            placeholder.disabled = true;
            placeholder.selected = true;
            select.appendChild(placeholder);
            csvFilesConfig.forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.textContent = file;
                select.appendChild(option);
            });
            const localOpt = document.createElement('option');
            localOpt.value = '__local__';
            localOpt.textContent = 'ÈÄâÊã©Êú¨Âú∞CSVÊñá‰ª∂...';
            select.appendChild(localOpt);
            if (csvFilesConfig.length > 0) {
                select.value = csvFilesConfig[0];
            }
        }
        async function loadCsvConfig() {
            let failed = false;
            try {
                const resp = await fetch('csv.json');
                if (!resp.ok) throw new Error();
                const data = await resp.json();
                const files = Array.isArray(data) ? data : (Array.isArray(data.files) ? data.files : []);
                csvFilesConfig = files && files.length ? files : [];
            } catch (e) {
                csvFilesConfig = [];
                failed = true;
            }
            initCsvSelect(failed);
        }
        window.addEventListener('DOMContentLoaded', () => {
            loadCsvConfig();
        });

        // ÂàáÊç¢ÂäüËÉΩ
        function switchFunction(func) {
            currentFunction = func;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('staticResourceBtn').classList.toggle('active', func === 'static');
            document.getElementById('AnotherBtn').classList.toggle('active', func === 'Another');
            
            // ÊòæÁ§∫/ÈöêËóèÂØπÂ∫îÈÉ®ÂàÜ
            document.getElementById('staticResourceSection').style.display = func === 'static' ? 'block' : 'none';
            document.getElementById('AnotherSection').style.display = func === 'Another' ? 'block' : 'none';
        }

        // ‰ª£Á†ÅÊ£ÄÊµã
        function checkSecretCode() {
            const input = document.getElementById('urlInput');
            const value = input.value.toLowerCase();
            const container = document.getElementById('quickAccessContainer');
            const btnProx = document.getElementById('quickAccessBtn');
            const btnGallery = document.getElementById('galleryBtn');
            
            if (value === 'prox') {
                input.value = ''; // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                hasAccessedSecret = true;
                container.style.display = 'flex';
                btnProx.style.display = 'flex';
                // Ëá™Âä®ÊâìÂºÄËÆæÁΩÆËèúÂçï (ÂèØÈÄâÔºå‰øùÁïôÂéüÈÄªËæë)
                openSecretSettings();
            } else if (value === 'random') {
                input.value = '';
                hasAccessedSecret = true;
                container.style.display = 'flex';
                btnGallery.style.display = 'flex';
                document.getElementById('quickRandomBtn').style.display = 'flex';
                // Ëá™Âä®ÊâìÂºÄÂõæÂ∫ì
                openGalleryBrowser();
            }
        }

        function fillUrl(url, itemData = null) {
            const input = document.getElementById('urlInput');
            input.value = url;
            
            // If item data is provided, show details
            if (itemData) {
                const detailsContainer = document.getElementById('detailsContainer');
                const detailsGrid = document.getElementById('detailsGrid');
                
                detailsContainer.style.display = 'block';
                detailsGrid.innerHTML = '';
                
                for (const key in itemData) {
                    if (Object.prototype.hasOwnProperty.call(itemData, key)) {
                        const value = itemData[key];
                        
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'detail-item';
                        
                        // Make description and tags full width
                        if (key.toLowerCase().includes('description') || key.toLowerCase().includes('tag')) {
                             itemDiv.style.gridColumn = '1 / -1';
                        }

                        const labelSpan = document.createElement('span');
                        labelSpan.className = 'detail-label';
                        labelSpan.textContent = key;
                        
                        const valueDiv = document.createElement('div');
                        valueDiv.className = 'detail-value';

                        if (key === 'tags_transl' && value) {
                             value.split(',').forEach(tag => {
                                const span = document.createElement('span');
                                span.className = 'tag-pill';
                                span.textContent = tag.trim();
                                valueDiv.appendChild(span);
                            });
                        } else {
                            valueDiv.textContent = value;
                        }

                        itemDiv.appendChild(labelSpan);
                        itemDiv.appendChild(valueDiv);
                        detailsGrid.appendChild(itemDiv);
                    }
                }
            } else {
                // Hide details if no data (e.g. manual entry or random from unknown source)
                document.getElementById('detailsContainer').style.display = 'none';
            }
        }



        // CSV Parser
        function parseCSV(text) {
            const lines = [];
            let row = [];
            let inQuote = false;
            let currentValue = '';
            
            // Remove BOM if present
            if (text.charCodeAt(0) === 0xFEFF) {
                text = text.slice(1);
            }

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (inQuote && nextChar === '"') {
                        currentValue += '"';
                        i++; 
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    row.push(currentValue);
                    currentValue = '';
                } else if ((char === '\r' || char === '\n') && !inQuote) {
                    if (currentValue || row.length > 0) {
                        row.push(currentValue);
                        lines.push(row);
                        row = [];
                        currentValue = '';
                    }
                    if (char === '\r' && nextChar === '\n') i++;
                } else {
                    currentValue += char;
                }
            }
            if (currentValue || row.length > 0) {
                row.push(currentValue);
                lines.push(row);
            }
            
            if (lines.length < 2) return [];
            
            const headers = lines[0].map(h => h.trim());
            return lines.slice(1).map(line => {
                const obj = {};
                headers.forEach((h, i) => {
                    obj[h] = line[i] || '';
                });
                return obj;
            });
        }

        // Initialize listeners when DOM is loaded (but here we are in script at end of body)
        // Add event listeners for Random Menu

        // --- Gallery Browser Functions ---
        function openGalleryBrowser() {
            document.getElementById('galleryBrowser').style.display = 'flex';
            if (!isGalleryLoaded) {
                loadGalleryData();
            }
        }

        function pickRandomImage() {
            if (galleryData.length === 0) {
                alert('ËØ∑ÂÖàÂä†ËΩΩÊï∞ÊçÆÔºÅ');
                return;
            }
            
            // Use current filtered data if available? No, usually random means from all data or current view.
            // Let's use all data for true random, or maybe respect filters? 
            // User just said "Random Image", let's pick from ALL loaded data to be safe.
            const randomIndex = Math.floor(Math.random() * galleryData.length);
            const item = galleryData[randomIndex];
            
            const useThumb = document.getElementById('useThumbCheckbox') && document.getElementById('useThumbCheckbox').checked;
            
            // Fill URL and process
            fillUrl(useThumb ? (item.thumb || item.original) : item.original, item);
            closeGalleryBrowser();
            
            // Trigger load
            processLink();
        }

        function closeGalleryBrowser() {
            document.getElementById('galleryBrowser').style.display = 'none';
        }
        
        // Èò≤ÊäñÂ∑•ÂÖ∑ÂáΩÊï∞
        function debounce(fn, delay = 300) {
            let timer = null;
            return (...args) => {
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        }

        async function loadGalleryData() {
            const loading = document.getElementById('galleryLoading');
            const status = document.getElementById('galleryStatus');
            const selectedFile = document.getElementById('galleryCsvSelect').value;
            
            if (!selectedFile) {
                status.textContent = 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™CSVÊñá‰ª∂';
                return;
            }

            if (selectedFile === '__local__') {
                const input = document.getElementById('localCsvInput');
                if (!input) return;
                input.onchange = async () => {
                    const file = input.files && input.files[0];
                    if (!file) {
                        status.textContent = 'Êú™ÈÄâÊã©Êú¨Âú∞CSVÊñá‰ª∂';
                        loading.style.display = 'none';
                        return;
                    }
                    loading.style.display = 'block';
                    status.textContent = `Ê≠£Âú®‰ªéÊú¨Âú∞Âä†ËΩΩ: ${file.name}`;
                    try {
                        const text = await file.text();
                        galleryData = parseCSV(text);
                        const tagCounts = {};
                        galleryData.forEach(item => {
                            if (item.tags_transl) {
                                item.tags_transl.split(',').forEach(t => {
                                    const tag = t.trim();
                                    if (tag) {
                                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                                    }
                                });
                            }
                        });
                        tagCountsMap = tagCounts;
                        const includePanel = document.getElementById('tagIncludePanel');
                        const excludePanel = document.getElementById('tagExcludePanel');
                        includePanel.innerHTML = '';
                        excludePanel.innerHTML = '';
                        Object.keys(tagCounts)
                            .sort((a, b) => {
                                const diff = tagCounts[b] - tagCounts[a];
                                if (diff !== 0) return diff;
                                return a.localeCompare(b, 'zh-CN');
                            })
                            .forEach(tag => {
                                const inc = document.createElement('div');
                                inc.className = 'tag-item';
                                inc.dataset.value = tag;
                                inc.textContent = `${tag} (${tagCounts[tag]})`;
                                includePanel.appendChild(inc);
                                const exc = document.createElement('div');
                                exc.className = 'tag-item';
                                exc.dataset.value = tag;
                                exc.textContent = `${tag} (${tagCounts[tag]})`;
                                excludePanel.appendChild(exc);
                            });
                        isGalleryLoaded = true;
                        status.textContent = `Âä†ËΩΩÊàêÂäü: ${file.name} (ÂÖ± ${galleryData.length} Êù°Êï∞ÊçÆ)`;
                        renderGalleryTable();
                    } catch (err) {
                        console.error(err);
                        status.textContent = `Âä†ËΩΩÂ§±Ë¥•: ${err.message}`;
                    } finally {
                        loading.style.display = 'none';
                        input.value = '';
                    }
                };
                input.click();
                return;
            }

            loading.style.display = 'block';
            status.textContent = 'Ê≠£Âú®Â∞ùËØïÂä†ËΩΩÊï∞ÊçÆ...';
            
            try {
                const response = await fetch(selectedFile);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                galleryData = parseCSV(text);
                
                // Extract Tags and Count Frequency
                const tagCounts = {};
                galleryData.forEach(item => {
                    if (item.tags_transl) {
                        // Split by comma, trim whitespace
                        item.tags_transl.split(',').forEach(t => {
                            const tag = t.trim();
                            if (tag) {
                                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                            }
                        });
                    }
                });
                tagCountsMap = tagCounts;
                
                // Populate Tag Panels
                const includePanel = document.getElementById('tagIncludePanel');
                const excludePanel = document.getElementById('tagExcludePanel');
                includePanel.innerHTML = '';
                excludePanel.innerHTML = '';
                
                // Sort by count desc
                Object.keys(tagCounts)
                    .sort((a, b) => {
                        const diff = tagCounts[b] - tagCounts[a];
                        if (diff !== 0) return diff;
                        return a.localeCompare(b, 'zh-CN');
                    })
                    .forEach(tag => {
                        const inc = document.createElement('div');
                        inc.className = 'tag-item';
                        inc.dataset.value = tag;
                        inc.textContent = `${tag} (${tagCounts[tag]})`;
                        includePanel.appendChild(inc);
                        const exc = document.createElement('div');
                        exc.className = 'tag-item';
                        exc.dataset.value = tag;
                        exc.textContent = `${tag} (${tagCounts[tag]})`;
                        excludePanel.appendChild(exc);
                    });

                isGalleryLoaded = true;
                status.textContent = `Âä†ËΩΩÊàêÂäü: ${selectedFile} (ÂÖ± ${galleryData.length} Êù°Êï∞ÊçÆ)`;
                renderGalleryTable();
            } catch (err) {
                console.error(err);
                status.textContent = `Âä†ËΩΩÂ§±Ë¥•: ${err.message} (ËØ∑Á°Æ‰øù ${selectedFile} Â≠òÂú®)`;
            } finally {
                loading.style.display = 'none';
            }
        }

        let currentPage = 1;
        let perPage = 50;
        function updatePaginationUI(totalFiltered, totalPages) {
            const info = document.getElementById('pageInfo');
            const input = document.getElementById('pageInput');
            if (info) info.textContent = `Á¨¨ ${currentPage} / ${totalPages} È°µ`;
            if (input) {
                input.max = Math.max(1, totalPages);
                input.value = currentPage;
            }
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderGalleryTable();
            }
        }
        function nextPage() {
            currentPage++;
            renderGalleryTable();
        }
        function goToPage(p) {
            const total = Math.max(1, Math.ceil(galleryData.length / perPage));
            currentPage = Math.min(Math.max(1, parseInt(p, 10) || 1), total);
            renderGalleryTable();
        }
        
        function renderGalleryTable() {
            const tbody = document.getElementById('galleryTableBody');
            const status = document.getElementById('galleryStatus');
            tbody.innerHTML = '';
            
            const tStart = performance.now();
                const searchText = document.getElementById('gallerySearch').value.toLowerCase();
                const sortMode = document.getElementById('gallerySort').value;
                const includeTags = Array.from(document.querySelectorAll('#tagIncludePanel .tag-item.selected')).map(el => el.dataset.value);
                const excludeTags = Array.from(document.querySelectorAll('#tagExcludePanel .tag-item.selected')).map(el => el.dataset.value);
                const filterAi = document.getElementById('galleryAiFilter').value;
            const dateFormatEl = document.getElementById('galleryDateFormat');
            const dateFormat = dateFormatEl ? dateFormatEl.value : 'raw';
            
            // Filter
            let items = galleryData.filter(item => {
                const matchSearch = !searchText || 
                    (item.title || '').toLowerCase().includes(searchText) || 
                    (item.description || '').toLowerCase().includes(searchText) || 
                    (item.id || '').toLowerCase().includes(searchText);
                
                // Á≤æÁ°ÆÊ†áÁ≠æÂåπÈÖç
                const tagArr = (item.tags_transl || '').split(',').map(t => t.trim()).filter(Boolean);
                const matchTagInclude = includeTags.length === 0 || includeTags.some(t => tagArr.includes(t));
                const matchTagExclude = excludeTags.length === 0 || excludeTags.every(t => !tagArr.includes(t));
                const matchTag = matchTagInclude && matchTagExclude;
                
                // AI Filter (YES/NO)
                const matchAi = !filterAi || (item.AI || '').toUpperCase() === filterAi;

                return matchSearch && matchTag && matchAi;
            });
            
            // Sort
            items.sort((a, b) => {
                const dA = Date.parse(a.date || '') || 0;
                const dB = Date.parse(b.date || '') || 0;
                switch (sortMode) {
                    case 'newest': return dB - dA;
                    case 'oldest': return dA - dB;
                    case 'id_desc': return parseInt(b.id || 0) - parseInt(a.id || 0);
                    case 'id_asc': return parseInt(a.id || 0) - parseInt(b.id || 0);
                    case 'view_desc': return parseInt(b.viewCount || 0) - parseInt(a.viewCount || 0);
                    case 'like_desc': return parseInt(b.likeCount || 0) - parseInt(a.likeCount || 0);
                    default: return 0;
                }
            });
            
            const totalFiltered = items.length;
            const totalPages = Math.max(1, Math.ceil(totalFiltered / perPage));
            if (currentPage > totalPages) currentPage = totalPages;
            const startIndex = (currentPage - 1) * perPage;
            const endIndex = startIndex + perPage;
            const pageItems = items.slice(startIndex, endIndex);
            updatePaginationUI(totalFiltered, totalPages);
            
            status.textContent = `ÊòæÁ§∫ ${pageItems.length} / ${totalFiltered} Êù°Êï∞ÊçÆ (ÊÄªËÆ° ${galleryData.length})`;
            
            const frag = document.createDocumentFragment();
            pageItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'gallery-row';
                
                // --- Action Column (Moved to first) ---
                const tdAction = document.createElement('td');
                tdAction.className = 'action-col cell-action';

                const btnOriginal = document.createElement('button');
                btnOriginal.textContent = 'Â°´ÂÖ•ÈìæÊé•';
                btnOriginal.className = 'fill-url-btn action-btn';
                btnOriginal.onclick = () => {
                    const useThumb = document.getElementById('useThumbCheckbox') && document.getElementById('useThumbCheckbox').checked;
                    fillUrl(useThumb ? (item.thumb || item.original) : item.original, item);
                    closeGalleryBrowser();
                };
                tdAction.appendChild(btnOriginal);
                tr.appendChild(tdAction);

                const tdId = document.createElement('td');
                tdId.textContent = item.id;
                tdId.className = 'cell-id';
                tr.appendChild(tdId);
                
                const tdTitle = document.createElement('td');
                tdTitle.textContent = item.title;
                tdTitle.className = 'cell-title';
                tdTitle.title = item.title;
                tr.appendChild(tdTitle);
                
                const tdDesc = document.createElement('td');
                tdDesc.textContent = item.description;
                tdDesc.className = 'cell-desc';
                tdDesc.title = item.description;
                tr.appendChild(tdDesc);
                
                const tdFile = document.createElement('td');
                tdFile.textContent = item.fileName || '';
                tdFile.className = 'cell-file';
                tr.appendChild(tdFile);
                
                const tdTags = document.createElement('td');
                tdTags.className = 'cell-tags';
                if (item.tags_transl) {
                    const tags = item.tags_transl.split(',').map(x => x.trim()).filter(Boolean);
                    const threshold = 3;
                    const spans = [];
                    tags.forEach((t, idx) => {
                        const span = document.createElement('span');
                        span.className = 'tag-pill';
                        if (idx >= threshold) span.style.display = 'none';
                        span.textContent = t;
                        tdTags.appendChild(span);
                        spans.push(span);
                    });
                    if (tags.length > threshold) {
                        const btn = document.createElement('button');
                        btn.className = 'tag-toggle';
                        btn.textContent = 'Â±ïÂºÄ';
                        btn.setAttribute('data-expanded', '0');
                        btn.onclick = () => {
                            const expanded = btn.getAttribute('data-expanded') === '1';
                            if (expanded) {
                                spans.forEach((s, idx) => { if (idx >= threshold) s.style.display = 'none'; });
                                btn.textContent = 'Â±ïÂºÄ';
                                btn.setAttribute('data-expanded', '0');
                            } else {
                                spans.forEach(s => { s.style.display = 'inline-block'; });
                                btn.textContent = 'Êî∂Ëµ∑';
                                btn.setAttribute('data-expanded', '1');
                            }
                        };
                        tdTags.appendChild(btn);
                    }
                }
                tr.appendChild(tdTags);

                const tdPage = document.createElement('td');
                tdPage.className = 'cell-meta';
                const pageSpan = document.createElement('span');
                pageSpan.className = 'meta-pill';
                pageSpan.textContent = `È°µÁ†Å: ${item.page || '-'}`;
                pageSpan.style.border = '1px solid #ff6b6b';
                pageSpan.style.color = '#ff6b6b';
                tdPage.appendChild(pageSpan);
                tr.appendChild(tdPage);

                const tdRestrict = document.createElement('td');
                tdRestrict.className = 'cell-meta';
                const rSpan = document.createElement('span');
                rSpan.className = 'meta-pill';
                rSpan.textContent = `ÈôêÂà∂Á∫ß: ${item.xRestrict || '0'}`;
                tdRestrict.appendChild(rSpan);
                tr.appendChild(tdRestrict);

                // Date
                const tdDate = document.createElement('td');
                tdDate.textContent = dateFormat === 'local' && item.date ? new Date(item.date).toLocaleString() : (item.date || '-');
                tr.appendChild(tdDate);

                // View Count
                const tdView = document.createElement('td');
                tdView.textContent = item.viewCount || '0';
                tr.appendChild(tdView);

                // Collection (Bookmark) Count
                const tdBookmark = document.createElement('td');
                tdBookmark.textContent = item.bookmark || '0';
                tr.appendChild(tdBookmark);
                
                frag.appendChild(tr);
            });
            tbody.appendChild(frag);
            const tElapsed = performance.now() - tStart;
            status.textContent += `ÔºåÊ∏≤ÊüìËÄóÊó∂ ${tElapsed.toFixed(1)} ms`;
        }
        
        // ÊêúÁ¥¢‰∏éÁ≠õÈÄâÁõëÂê¨ÔºàÈò≤ÊäñÔºâ
        const debouncedRender = debounce(renderGalleryTable, 300);
        document.getElementById('gallerySearch').addEventListener('input', debouncedRender);
        const tagIncludePanel = document.getElementById('tagIncludePanel');
        const tagExcludePanel = document.getElementById('tagExcludePanel');
        const aiFilterEl = document.getElementById('galleryAiFilter');
        const sortEl = document.getElementById('gallerySort');
        const dateFmtEl = document.getElementById('galleryDateFormat');
        const perPageEl = document.getElementById('perPageSelect');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const jumpBtn = document.getElementById('jumpPageBtn');
        const pageInput = document.getElementById('pageInput');
        const selectedInclude = document.getElementById('selectedInclude');
        const selectedExclude = document.getElementById('selectedExclude');
        const clearSelectedBtn = document.getElementById('clearSelectedTags');

        function updateSelectedTagsSummary() {
            if (!selectedInclude || !selectedExclude) return;
            const inc = Array.from(document.querySelectorAll('#tagIncludePanel .tag-item.selected')).map(el => el.dataset.value);
            const exc = Array.from(document.querySelectorAll('#tagExcludePanel .tag-item.selected')).map(el => el.dataset.value);
            selectedInclude.innerHTML = '';
            selectedExclude.innerHTML = '';
            inc.forEach(tag => {
                const pill = document.createElement('span');
                pill.className = 'tag-pill';
                pill.dataset.tag = tag;
                pill.textContent = tag;
                selectedInclude.appendChild(pill);
            });
            exc.forEach(tag => {
                const pill = document.createElement('span');
                pill.className = 'tag-pill';
                pill.dataset.tag = tag;
                pill.textContent = tag;
                selectedExclude.appendChild(pill);
            });
        }
        function reorderTagPanel(panel) {
            if (!panel) return;
            const items = Array.from(panel.querySelectorAll('.tag-item'));
            items.sort((a, b) => {
                const aSel = a.classList.contains('selected') ? 1 : 0;
                const bSel = b.classList.contains('selected') ? 1 : 0;
                if (aSel !== bSel) return bSel - aSel;
                const ta = a.dataset.value || '';
                const tb = b.dataset.value || '';
                const ca = tagCountsMap[ta] || 0;
                const cb = tagCountsMap[tb] || 0;
                if (ca !== cb) return cb - ca;
                return ta.localeCompare(tb, 'zh-CN');
            });
            items.forEach(it => panel.appendChild(it));
        }
        function bindPanelClick(panel) {
            if (!panel) return;
            panel.addEventListener('click', (e) => {
                const item = e.target.closest('.tag-item');
                if (!item || !panel.contains(item)) return;
                item.classList.toggle('selected');
                updateSelectedTagsSummary();
                reorderTagPanel(panel);
                debouncedRender();
            });
        }
        bindPanelClick(tagIncludePanel);
        bindPanelClick(tagExcludePanel);
        if (clearSelectedBtn) {
            clearSelectedBtn.addEventListener('click', () => {
                document.querySelectorAll('#tagIncludePanel .tag-item.selected, #tagExcludePanel .tag-item.selected').forEach(el => el.classList.remove('selected'));
                updateSelectedTagsSummary();
                debouncedRender();
            });
        }
        if (selectedInclude) {
            selectedInclude.addEventListener('click', (e) => {
                const pill = e.target.closest('.tag-pill');
                if (!pill) return;
                const tag = pill.dataset.tag;
                const item = document.querySelector(`#tagIncludePanel .tag-item[data-value="${tag}"]`);
                if (item) item.classList.remove('selected');
                updateSelectedTagsSummary();
                debouncedRender();
            });
        }
        if (selectedExclude) {
            selectedExclude.addEventListener('click', (e) => {
                const pill = e.target.closest('.tag-pill');
                if (!pill) return;
                const tag = pill.dataset.tag;
                const item = document.querySelector(`#tagExcludePanel .tag-item[data-value="${tag}"]`);
                if (item) item.classList.remove('selected');
                updateSelectedTagsSummary();
                debouncedRender();
            });
        }
        if (aiFilterEl) aiFilterEl.addEventListener('change', debouncedRender);
        if (sortEl) sortEl.addEventListener('change', renderGalleryTable);
        if (dateFmtEl) dateFmtEl.addEventListener('change', renderGalleryTable);
        if (perPageEl) perPageEl.addEventListener('change', () => { perPage = parseInt(perPageEl.value, 10) || 50; currentPage = 1; renderGalleryTable(); });
        if (prevBtn) prevBtn.addEventListener('click', prevPage);
        if (nextBtn) nextBtn.addEventListener('click', nextPage);
        if (jumpBtn && pageInput) jumpBtn.addEventListener('click', () => { const p = parseInt(pageInput.value, 10); if (!isNaN(p)) { goToPage(p); } });
        
        // Dropdown toggles
        const openTagIncludeBtn = document.getElementById('openTagInclude');
        const openTagExcludeBtn = document.getElementById('openTagExclude');
        function togglePanel(btn, panel) {
            if (!btn || !panel) return;
            btn.addEventListener('click', () => {
                panel.classList.toggle('open');
                reorderTagPanel(panel);
            });
        }
        togglePanel(openTagIncludeBtn, tagIncludePanel);
        togglePanel(openTagExcludeBtn, tagExcludePanel);
        document.addEventListener('click', (e) => {
            const incWrap = openTagIncludeBtn ? openTagIncludeBtn.parentElement : null;
            const excWrap = openTagExcludeBtn ? openTagExcludeBtn.parentElement : null;
            if (incWrap && !incWrap.contains(e.target)) { tagIncludePanel.classList.remove('open'); }
            if (excWrap && !excWrap.contains(e.target)) { tagExcludePanel.classList.remove('open'); }
        });



        function openSecretSettings() {
            document.getElementById('secretSettings').style.display = 'flex';
            // Ê†áËÆ∞Â∑≤ËÆøÈóÆËøáÈ°µÈù¢ÔºåÂπ∂ÊòæÁ§∫Âø´ÈÄüËÆøÈóÆÊåâÈíÆ
            hasAccessedSecret = true;
            document.getElementById('quickAccessBtn').style.display = 'block';
        }

        function closeSecretSettings() {
            document.getElementById('secretSettings').style.display = 'none';
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('urlInput').value = '';
            document.getElementById('secretInput').value = '';
            document.getElementById('AnotherInput').value = '';
        }

        function handleSecretProxyChange() {
            const secretProxySelect = document.getElementById('secretProxySelect');
            const secretCustomProxyInput = document.getElementById('secretCustomProxyInput');
            
            if (secretProxySelect.value === 'custom') {
                secretCustomProxyInput.style.display = 'block';
            } else {
                secretCustomProxyInput.style.display = 'none';
            }
        }

        function handleSecretAction() {
            if (currentFunction === 'static') {
                handleStaticResource();
            } else if (currentFunction === 'Another') {
                handleAnotherAcceleration();
            }
        }

        function handleStaticResource() {
            const secretInput = document.getElementById('secretInput').value.trim();
            const secretProxySelect = document.getElementById('secretProxySelect');
            const secretCustomProxyInput = document.getElementById('secretCustomProxyInput');
            
            if (!secretInput) {
                alert('‚ùå ËØ∑ËæìÂÖ•ÈùôÊÄÅËµÑÊ∫êÈìæÊé•ÔºÅ');
                return;
            }
            
            // Ëé∑ÂèñÈÄâÊã©ÁöÑ‰ª£ÁêÜÊúçÂä°Âô®
            let proxyUrl;
            if (secretProxySelect.value === 'custom') {
                proxyUrl = secretCustomProxyInput.value.trim();
                if (!proxyUrl) {
                    alert('‚ùå ËØ∑ËæìÂÖ•Ëá™ÂÆö‰πâÊúçÂä°Âô®Âú∞ÂùÄÔºÅ');
                    return;
                }
            } else {
                proxyUrl = secretProxySelect.value;
            }

            // Ê∏ÖÁêÜ‰ª£ÁêÜURLÔºàÁßªÈô§Êú´Â∞æÁöÑÊñúÊù†Ôºâ
            const cleanProxyUrl = proxyUrl.replace(/\/+$/, '');
            
            // Â§ÑÁêÜËæìÂÖ•ÂÜÖÂÆπÔºöÁßªÈô§ÂçèËÆÆÂ§¥ÔºåÊõøÊç¢‰∏∫~
            let processedInput = secretInput;
            
            // ÁßªÈô§ http:// Êàñ https:// ÂçèËÆÆÂ§¥
            processedInput = processedInput.replace(/^https?:\/\//, '');
            
            // ÊûÑÂª∫ÊúÄÁªàURLÔºö‰ª£ÁêÜÊúçÂä°Âô® + /~ + Â§ÑÁêÜÂêéÁöÑËæìÂÖ•ÂÜÖÂÆπ
            const finalUrl = cleanProxyUrl + '/~' + processedInput;
            
            // Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄ
            window.open(finalUrl, '_blank');
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('secretInput').value = '';
        }

        function handleAnotherAcceleration() {
            const AnotherInput = document.getElementById('AnotherInput').value.trim();
            
            if (!AnotherInput) {
                alert('‚ùå ËØ∑ËæìÂÖ•ÈìæÊé•ÔºÅ');
                return;
            }
            
            // Â§ÑÁêÜËæìÂÖ•ÂÜÖÂÆπÔºöÁßªÈô§ÂçèËÆÆÂ§¥
            let processedInput = AnotherInput;
            
            // ÁßªÈô§ http:// Êàñ https:// ÂçèËÆÆÂ§¥
            // processedInput = processedInput.replace(/^https?:\/\//, '');
            
            // ÊûÑÂª∫ÊúÄÁªàURLÔºöÂä†ÈÄüÂüüÂêç + Â§ÑÁêÜÂêéÁöÑËæìÂÖ•ÂÜÖÂÆπ
            const finalUrl = 'https://p.futa.de5.net/' + processedInput;
            
            // Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄ
            window.open(finalUrl, '_blank');
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('AnotherInput').value = '';
        }

        function getProxyUrl() {
            const proxySelect = document.getElementById('proxySelect');
            const customProxyInput = document.getElementById('customProxyInput');
            
            if (proxySelect.value === 'custom') {
                return customProxyInput.value.trim();
            } else {
                return proxySelect.value;
            }
        }

        function handleProxyChange() {
            const proxySelect = document.getElementById('proxySelect');
            const customProxyInput = document.getElementById('customProxyInput');
            
            if (proxySelect.value === 'custom') {
                customProxyInput.style.display = 'block';
            } else {
                customProxyInput.style.display = 'none';
            }
        }

        async function loadImageWithProgress(url) {
            const loadingText = document.getElementById('loadingText');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressStats = document.getElementById('progressStats');
            const resultImage = document.getElementById('resultImage');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // 1. Cancel previous request if exists (Fix: Fast switching/duplicate loading)
            if (currentFetchController) {
                currentFetchController.abort();
            }
            currentFetchController = new AbortController();
            const signal = currentFetchController.signal;

            // 2. Show Loading Overlay
            loadingIndicator.className = 'loading-overlay'; 
            loadingIndicator.style.display = 'flex';
            
            loadingText.textContent = 'Ê≠£Âú®ÂáÜÂ§á...';
            progressContainer.style.display = 'block';
            progressStats.style.display = 'block';
            progressBar.style.width = '0%';
            progressStats.textContent = '0%';

            // 3. Check Cache
            if (await imageCache.has(url)) {
                console.log('Using cached image for:', url);
                const blobUrl = await imageCache.get(url);
                
                loadingText.textContent = '‚ö° Ê≠£Âú®‰ªéÁºìÂ≠òÂä†ËΩΩ...';
                
                // Allow UI to update
                await new Promise(r => requestAnimationFrame(r));
                
                if (signal.aborted) return;

                resultImage.onload = function() {
                    loadingIndicator.style.display = 'none';
                    resultImage.style.display = 'block';
                };
                
                resultImage.onerror = function() {
                    // If cache is invalid, remove and retry or fail
                    // imageCache.cache.delete(url); // Old Map method
                    loadingIndicator.style.display = 'none';
                    showError('‚ùå ÁºìÂ≠òËØªÂèñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï');
                };

                resultImage.src = blobUrl;
                replacedUrl = blobUrl;
                return;
            }

            try {
                loadingText.textContent = 'Ê≠£Âú®Âª∫Á´ãËøûÊé•...';
                const response = await fetch(url, { signal });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentLength = response.headers.get('content-length');
                const total = contentLength ? parseInt(contentLength, 10) : 0;
                let loaded = 0;

                const reader = response.body.getReader();
                const chunks = [];

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    chunks.push(value);
                    loaded += value.length;

                    if (total) {
                        const percent = Math.round((loaded / total) * 100);
                        progressBar.style.width = percent + '%';
                        progressStats.textContent = `${percent}% (${(loaded / 1024 / 1024).toFixed(2)} MB / ${(total / 1024 / 1024).toFixed(2)} MB)`;
                    } else {
                        progressStats.textContent = `Â∑≤‰∏ãËΩΩ: ${(loaded / 1024 / 1024).toFixed(2)} MB`;
                    }
                }

                loadingText.textContent = 'Ê≠£Âú®Ê∏≤ÊüìÂõæÁâá...';
                
                const blob = new Blob(chunks);
                const objectUrl = URL.createObjectURL(blob);
                
                // Save to Cache
                await imageCache.set(url, objectUrl, blob.size);

                if (signal.aborted) return;

                resultImage.onload = function() {
                    loadingIndicator.style.display = 'none';
                    resultImage.style.display = 'block';
                };
                
                resultImage.onerror = function() {
                    loadingIndicator.style.display = 'none';
                    showError('‚ùå ÂõæÁâáÊ∏≤ÊüìÂ§±Ë¥•');
                };

                resultImage.src = objectUrl;
                // Update global replacedUrl for download button
                replacedUrl = objectUrl;

            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log('Fetch aborted: ' + url);
                    return;
                }
                
                console.error(err);
                // Fallback for CORS or other fetch errors
                console.warn('Fetch failed (likely CORS), falling back to direct img src loading...');
                
                loadingText.textContent = 'ÊµÅÂºèÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•Âä†ËΩΩ...';
                progressContainer.style.display = 'none';
                progressStats.style.display = 'none';
                
                // Clear blob URL if any
                if (resultImage.src.startsWith('blob:')) {
                    URL.revokeObjectURL(resultImage.src);
                }
                
                if (signal.aborted) return;

                resultImage.onload = function() {
                    loadingIndicator.style.display = 'none';
                    resultImage.style.display = 'block';
                };
                
                resultImage.onerror = function() {
                    loadingIndicator.style.display = 'none';
                    showError('‚ùå ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•: ' + err.message);
                };
                
                resultImage.src = url;
                replacedUrl = url;
            } finally {
                 if (currentFetchController && currentFetchController.signal === signal) {
                     currentFetchController = null;
                 }
            }
        }

        // --- Preload Logic ---
        async function preloadNextImages(currentUrl) {
            // Determine current page
            let currentPage = 0;
            let baseUrl = currentUrl;
            let suffix = ''; // e.g. .jpg
            
            const pMatch = currentUrl.match(/(_p)(\d+)(\.[a-zA-Z0-9]+)$/);
            if (pMatch) {
                // ..._p0.jpg
                currentPage = parseInt(pMatch[2], 10);
                baseUrl = currentUrl.substring(0, pMatch.index); // remove _p0.jpg part? No, easier to use setUrlPage logic or rebuild
            } else {
                // Maybe just ends with .jpg and no _p? (Usually _p0 is implicit or explicit)
                // If the url doesn't match standard pattern, we might skip or try to append _p1
                const extMatch = currentUrl.match(/(\.[a-zA-Z0-9]+)$/);
                if (extMatch) {
                   // treat as p0?
                   // setUrlPage handles this
                }
            }

            const preloadCount = 2; // Preload next 2 images
            
            for (let i = 1; i <= preloadCount; i++) {
                const nextPage = currentPage + i;
                const nextUrl = setUrlPage(currentUrl, nextPage);
                
                if (imageCache.has(nextUrl)) {
                    console.log(`Page ${nextPage} already cached.`);
                    continue;
                }
                
                console.log(`Preloading page ${nextPage}: ${nextUrl}`);
                
                // Fetch in background
                fetch(nextUrl)
                    .then(resp => {
                        if (!resp.ok) throw new Error(resp.status);
                        return resp.blob();
                    })
                    .then(async blob => {
                        const objectUrl = URL.createObjectURL(blob);
                        await imageCache.set(nextUrl, objectUrl, blob.size);
                        console.log(`Preloaded page ${nextPage} success.`);
                    })
                    .catch(err => {
                        // 404 is expected if no more pages
                        console.log(`Preload page ${nextPage} failed (likely end of gallery):`, err);
                    });
            }
        }

        function processLink() {
            const input = document.getElementById('urlInput').value.trim();
            const errorMsg = document.getElementById('errorMsg');
            const infoMsg = document.getElementById('infoMsg');
            const imageContainer = document.getElementById('imageContainer');
            const resultImage = document.getElementById('resultImage');
            const resultLinkContainer = document.getElementById('resultLinkContainer');
            const resultLink = document.getElementById('resultLink');
            const downloadBtn = document.getElementById('downloadBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // ÈöêËóè‰πãÂâçÁöÑÊ∂àÊÅØÂíåÂõæÁâá
            errorMsg.style.display = 'none';
            infoMsg.style.display = 'none';
            // imageContainer.style.display = 'none'; // Optimization: Keep container to prevent layout shift
            resultLinkContainer.style.display = 'none';
            // resultImage.style.display = 'none'; // Optimization: Keep old image until new one loads (overlay mode)
            loadingIndicator.style.display = 'none';

            if (!input) {
                showError('‚ùå ËØ∑ÂÖàËæìÂÖ•‰∏Ä‰∏™ÈìæÊé•ÔºÅ');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰ª£Á†Å
            if (input.toLowerCase() === 'prox') {
                openSecretSettings();
                // Ê†áËÆ∞Â∑≤ËÆøÈóÆËøáÈ°µÈù¢ÔºåÂπ∂ÊòæÁ§∫Âø´ÈÄüËÆøÈóÆÊåâÈíÆ
                hasAccessedSecret = true;
                document.getElementById('quickAccessBtn').style.display = 'block';
                return;
            }

            try {
                originalUrl = input;

                // Â¶ÇÊûúÁî®Êà∑Ê≤°ËæìÂÖ•ÂçèËÆÆÔºåÊàë‰ª¨ÈªòËÆ§Ë°•‰∏ä https://
                if (!originalUrl.startsWith('http://') && !originalUrl.startsWith('https://')) {
                    originalUrl = 'https://' + originalUrl;
                }

                // Ëé∑Âèñ‰ª£ÁêÜURL
                const proxyUrl = getProxyUrl();
                if (!proxyUrl) {
                    showError('‚ùå ËØ∑ÈÄâÊã©ÊàñËæìÂÖ•‰ª£ÁêÜÊúçÂä°Âô®Âú∞ÂùÄÔºÅ');
                    return;
                }

                // Ê∏ÖÁêÜ‰ª£ÁêÜURLÔºàÁßªÈô§Êú´Â∞æÁöÑÊñúÊù†Ôºâ
                const cleanProxyUrl = proxyUrl.replace(/\/+$/, '');
                
                // ÊâßË°åÊõøÊç¢Ôºöi.pximg.net ‚Üí ÈÄâÊã©ÁöÑ‰ª£ÁêÜÂüüÂêç
                replacedUrl = originalUrl.replace(
                    /i\.pximg\.net/g, 
                    cleanProxyUrl.replace(/^https?:\/\//, '')
                );

                if (replacedUrl === originalUrl) {
                    showError('‚ö†Ô∏è <br> Ê≠§ÈùûPixivÂéüÂõæÈìæÊé• <br> ÈìæÊé•Â∫î‰∏∫ https://i.pximg.net/img-original/img/... <br> Êó†Ê≥ïÊâìÂºÄ„ÄÇËØ∑Ê£ÄÊü•ËæìÂÖ•ÁöÑÈìæÊé•ÊòØÂê¶Ê≠£Á°Æ„ÄÇ');
                    return;
                }

                // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
                showInfo(`‚úÖ <br> Â∑≤ËΩ¨Êé•Ôºö<br> i.pximg.net ‚Üí ${cleanProxyUrl} <br>Ê≠£Âú®Âä†ËΩΩÂõæÁâáÂÜÖÂÆπ...`);

                // ÊòæÁ§∫ËΩ¨Êç¢ÂêéÁöÑÈìæÊé•
                resultLink.textContent = replacedUrl;
                resultLinkContainer.style.display = 'block';

                // ÈáçÁΩÆ‰∏∫Áº©ÊîæÊ®°Âºè
                isOriginalSize = false;
                resultImage.className = 'scaled-image';
                
                // ÊòæÁ§∫Âä†ËΩΩÊåáÁ§∫Âô®
                // loadingIndicator.style.display = 'block'; // Moved to loadImageWithProgress for better control
                imageContainer.style.display = 'block';
                
                // ‰ΩøÁî®ÊµÅÂºèÂä†ËΩΩ
                loadImageWithProgress(replacedUrl);

                // Ëß¶ÂèëÈ¢ÑÂä†ËΩΩ
                preloadNextImages(replacedUrl);

            } catch (err) {
                showError('‚ùå Â§ÑÁêÜÈìæÊé•Êó∂Âá∫ÈîôÔºö' + err.message);
            }
        }

        function openInNewTab() {
            const input = document.getElementById('urlInput').value.trim();
            
            if (!input) {
                showError('‚ùå ËØ∑ÂÖàËæìÂÖ•‰∏Ä‰∏™ÈìæÊé•ÔºÅ');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰ª£Á†Å
            if (input.toLowerCase() === 'prox') {
                openSecretSettings();
                // Ê†áËÆ∞Â∑≤ËÆøÈóÆËøáÈ°µÈù¢ÔºåÂπ∂ÊòæÁ§∫Âø´ÈÄüËÆøÈóÆÊåâÈíÆ
                hasAccessedSecret = true;
                document.getElementById('quickAccessBtn').style.display = 'block';
                return;
            }

            try {
                let urlToOpen = input;

                // Â¶ÇÊûúÁî®Êà∑Ê≤°ËæìÂÖ•ÂçèËÆÆÔºåÊàë‰ª¨ÈªòËÆ§Ë°•‰∏ä https://
                if (!urlToOpen.startsWith('http://') && !urlToOpen.startsWith('https://')) {
                    urlToOpen = 'https://' + urlToOpen;
                }

                // Ëé∑Âèñ‰ª£ÁêÜURL
                const proxyUrl = getProxyUrl();
                if (!proxyUrl) {
                    showError('‚ùå ËØ∑ÈÄâÊã©ÊàñËæìÂÖ•ÊúçÂä°Âô®Âú∞ÂùÄÔºÅ');
                    return;
                }

                // Ê∏ÖÁêÜ‰ª£ÁêÜURLÔºàÁßªÈô§Êú´Â∞æÁöÑÊñúÊù†Ôºâ
                const cleanProxyUrl = proxyUrl.replace(/\/+$/, '');
                
                // ÊâßË°åÊõøÊç¢Ôºöi.pximg.net ‚Üí ÈÄâÊã©ÁöÑ‰ª£ÁêÜÂüüÂêç
                const newTabUrl = urlToOpen.replace(
                    /i\.pximg\.net/g, 
                    cleanProxyUrl.replace(/^https?:\/\//, '')
                );

                if (newTabUrl === urlToOpen) {
                    showError('‚ö†Ô∏è <br> Ê≠§ÈùûPixivÂéüÂõæÈìæÊé• <br> ÈìæÊé•Â∫î‰∏∫ https://i.pximg.net/img-original/img/... <br> Êó†Ê≥ïÊâìÂºÄ„ÄÇËØ∑Ê£ÄÊü•ËæìÂÖ•ÁöÑÈìæÊé•ÊòØÂê¶Ê≠£Á°Æ„ÄÇ');
                    return;
                }

                // Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄ
                window.open(newTabUrl, '_blank');

            } catch (err) {
                showError('‚ùå Â§ÑÁêÜÈìæÊé•Êó∂Âá∫ÈîôÔºö' + err.message);
            }
        }

        function downloadImage() {
            if (!replacedUrl) {
                showError('‚ùå Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÂõæÁâáÈìæÊé•');
                return;
            }

            // ÂàõÂª∫‰∏Ä‰∏™ÈöêËóèÁöÑaÊ†áÁ≠æÁî®‰∫é‰∏ãËΩΩ
            const a = document.createElement('a');
            a.href = replacedUrl;
            
            // ‰ªéURL‰∏≠ÊèêÂèñÊñá‰ª∂Âêç
            let filename = 'pixiv-image.png';
            if (originalUrl) {
                filename = originalUrl.split('/').pop();
            } else if (replacedUrl && !replacedUrl.startsWith('blob:')) {
                filename = replacedUrl.split('/').pop();
            }
            a.download = filename;
            
            // Ëß¶Âèë‰∏ãËΩΩ
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function showError(msg) {
            const elem = document.getElementById('errorMsg');
            elem.innerHTML = msg;
            elem.style.display = 'block';
        }

        function showInfo(msg) {
            const elem = document.getElementById('infoMsg');
            elem.innerHTML = msg;
            elem.style.display = 'block';
        }

        function copyToClipboard(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const notification = document.createElement('div');
                notification.className = 'copy-notification show-copy-notification';
                notification.textContent = 'Â∑≤Â§çÂà∂!';
                element.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.remove('show-copy-notification');
                    setTimeout(() => {
                        element.removeChild(notification);
                    }, 300);
                }, 2000);
            }).catch(err => {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
            });
        }

        // --- Feature 1: Pagination Logic ---
        function getUrlPage(url) {
            const match = url.match(/_p(\d+)(\.[a-zA-Z0-9]+)?$/);
            if (match) {
                return parseInt(match[1], 10);
            }
            return null; // Not found
        }

        function setUrlPage(url, page) {
            // If URL has _p\d+, replace it.
            if (/_p(\d+)(\.[a-zA-Z0-9]+)?$/.test(url)) {
                return url.replace(/_p(\d+)(\.[a-zA-Z0-9]+)?$/, `_p${page}$2`);
            }
            // If not, try to insert before extension?
            const extMatch = url.match(/(\.[a-zA-Z0-9]+)$/);
            if (extMatch) {
                return url.replace(/(\.[a-zA-Z0-9]+)$/, `_p${page}$1`);
            }
            return url + `_p${page}`;
        }

        function updatePageControlFromUrl() {
            const input = document.getElementById('urlInput');
            const pageInput = document.getElementById('urlPageInput');
            if (!input || !pageInput) return;
            const page = getUrlPage(input.value);
            if (page !== null) {
                pageInput.value = page + 1;
            }
        }

        function changeUrlPage(delta) {
            // Optimization: Throttle clicks to prevent excessive processing
            const now = Date.now();
            if (now - lastClickTime < 300) return; 
            lastClickTime = now;

            const input = document.getElementById('urlInput');
            let val = input.value.trim();
            if (!val) return;
            
            let page = getUrlPage(val);
            if (page === null) page = 0; // Default start at 0
            
            let newPage = page + delta;
            if (newPage < 0) newPage = 0;
            
            const newUrl = setUrlPage(val, newPage);
            input.value = newUrl;
            document.getElementById('urlPageInput').value = newPage + 1;
            
            // Trigger checkSecretCode just in case (though prox/random won't match)
            // checkSecretCode(); 

            // Auto load
            processLink();
        }

        function jumpUrlPage(page) {
            // Optimization: Throttle
            const now = Date.now();
            if (now - lastClickTime < 300) return; 
            lastClickTime = now;

            const input = document.getElementById('urlInput');
            let val = input.value.trim();
            if (!val) return;
            
            let displayPage = parseInt(page, 10);
            if (isNaN(displayPage) || displayPage < 1) displayPage = 1;
            
            let newPage = displayPage - 1;
            if (newPage < 0) newPage = 0;
            
            const newUrl = setUrlPage(val, newPage);
            input.value = newUrl;
            document.getElementById('urlPageInput').value = displayPage;

            // Auto load
            processLink();
        }

        // --- Feature 2: Quick Random Image ---
        async function quickRandomImage() {
            if (!isGalleryLoaded) {
                 // Try to load default or currently selected
                 await loadGalleryData();
            }
            
            if (galleryData.length === 0) {
                 alert('ËØ∑ÂÖàÂú®ÂõæÂ∫ì‰∏≠Âä†ËΩΩÊï∞ÊçÆÔºÅ');
                 openGalleryBrowser(); 
                 return;
            }
            
            pickRandomImage();
        }

        // --- Feature 3: API Random Image ---
        function loadApiImage() {
            const apiUrl = 'https://img.futa.de5.net/1';
            // User requested no cache for random API image
            const targetUrl = apiUrl + '?t=' + Date.now();
            
            const errorMsg = document.getElementById('errorMsg');
            const infoMsg = document.getElementById('infoMsg');
            const imageContainer = document.getElementById('imageContainer');
            const resultImage = document.getElementById('resultImage');
            const resultLinkContainer = document.getElementById('resultLinkContainer');
            const resultLink = document.getElementById('resultLink');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // Reset UI
            errorMsg.style.display = 'none';
            infoMsg.style.display = 'none';
            imageContainer.style.display = 'block';
            resultLinkContainer.style.display = 'block';
            
            // Show loading state
            loadingIndicator.style.display = 'block';
            resultImage.style.display = 'none';
            
            // Update Link Display
            resultLink.textContent = apiUrl;
            
            // Reset global vars for download
            originalUrl = ''; 
            replacedUrl = targetUrl;
            
            // Reset Image Class
            isOriginalSize = false;
            resultImage.className = 'scaled-image';
            
            // Use existing stream loader (supports progress bar if CORS allows)
            loadImageWithProgress(targetUrl);
        }

        // ÂàùÂßãÂåñÈ°µÈù¢
        document.addEventListener('DOMContentLoaded', function() {
            handleProxyChange(); // ÂàùÂßãÂåñ‰ª£ÁêÜÈÄâÊã©ÊòæÁ§∫Áä∂ÊÄÅ
            handleSecretProxyChange(); // ÂàùÂßãÂåñÁßòÂØÜËÆæÁΩÆ‰ª£ÁêÜÈÄâÊã©ÊòæÁ§∫Áä∂ÊÄÅ
            
            // ÊØèÊ¨°Âà∑Êñ∞È°µÈù¢ÈÉΩÈáçÁΩÆÁä∂ÊÄÅÔºåÂø´ÈÄüËÆøÈóÆÊåâÈíÆÈªòËÆ§ÈöêËóè
            hasAccessedSecret = false;
            document.getElementById('quickAccessBtn').style.display = 'none';
        });
    </script>
</body>
</html>
