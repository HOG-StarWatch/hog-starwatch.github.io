<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æå…‰å·¥å…·ç®± (Aurora Toolbox)</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//unpkg.com">
    <script src="js/loader.js"></script>
    <style>
        body { overflow: hidden; }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
            display: block;
        }
        main {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <header>
        <div style="display:flex; align-items:center; width: 100%; justify-content: space-between; height: 100%;">
            <div style="display:flex; align-items:center; height: 100%;">
                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" style="display:none; background:none; border:none; color:var(--text-main); font-size:1.5rem; margin-right:15px; cursor:pointer;">
                    â˜°
                </button>
                <div class="logo" id="logo-home" style="cursor: pointer;">AURORA <span style="font-weight:300; opacity:0.7">TOOLBOX</span></div>
            </div>
            
            <div style="display:flex; align-items:center; height: 100%;">
                <nav class="nav-tabs" id="main-nav">
                    <button class="btn" id="back-home-btn">
                    <span>â¤</span>
                    </button>   
                    <button class="tab-btn active" data-src="tools/home.html">ä¸»é¡µ</button>
        
                    <!-- Image Dropdown -->
                    <div class="dropdown">
                        <button class="tab-btn dropdown-toggle">å›¾åƒä¸è§†è§‰</button>
                        <div class="dropdown-content">
                            <div class="dropdown-header">åŸºç¡€å¤„ç†</div>
                            <button class="tab-btn" data-src="tools/image-convert.html">æ ¼å¼è½¬æ¢</button>
                            <button class="tab-btn" data-src="tools/image-svg-tracer.html">SVG çŸ¢é‡åŒ–</button>
                            <button class="tab-btn" data-src="tools/image-gif.html">GIF åˆæˆ</button>
                            <button class="tab-btn" data-src="tools/image-svg-painter.html">SVG ç”»æ¿</button>
                            <button class="tab-btn" data-src="tools/image-svg-optimizer.html">SVG ä¼˜åŒ–</button>
                            <button class="tab-btn" data-src="tools/image-drawing.html">ç®€æ˜“ç”»æ¿</button>
                            <button class="tab-btn" data-src="tools/image-overlay.html">å›¾ç‰‡å åŠ </button>
                            
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-header">ç‰¹æ•ˆä¸æ»¤é•œ</div>
                            <button class="tab-btn" data-src="tools/image-photon.html">ä¸“ä¸šæ»¤é•œ (Photon)</button>
                            <button class="tab-btn" data-src="tools/image-pixel.html">åƒç´ åŒ–</button>
                            <button class="tab-btn" data-src="tools/image-glitch.html">æ•…éšœè‰ºæœ¯</button>
                            <button class="tab-btn" data-src="tools/image-ascii.html">å­—ç¬¦ç”»</button>

                            <div class="dropdown-divider"></div>
                            <div class="dropdown-header">åŠ å¯†ä¸ç”Ÿæˆ</div>
                            <button class="tab-btn" data-src="tools/image-crypto.html">è§†è§‰åŠ å¯†</button>
                            <button class="tab-btn" data-src="tools/image-phantom.html">å¹»å½±å¦å…‹</button>
                            <button class="tab-btn" data-src="tools/image-hybrid.html">æ··åˆå›¾åƒ</button>
                            <button class="tab-btn" data-src="tools/image-seeder.html">å›¾ç§ç”Ÿæˆ</button>
                            <button class="tab-btn" data-src="tools/image-fun.html">è¶£å‘³ç”Ÿæˆ</button>
                        </div>
                    </div>

                    <!-- Text Dropdown -->
                    <div class="dropdown">
                        <button class="tab-btn dropdown-toggle">æ–‡æœ¬ä¸ç¼–ç </button>
                        <div class="dropdown-content">
                            <button class="tab-btn" data-src="tools/text.html">æ–‡æœ¬å¤„ç†</button>
                            <button class="tab-btn" data-src="tools/regex.html">æ­£åˆ™å®éªŒå®¤</button>
                            <button class="tab-btn" data-src="tools/transcode.html">æ–‡æœ¬è½¬ç </button>
                            <button class="tab-btn" data-src="tools/format.html">ä»£ç æ ¼å¼åŒ–</button>
                            <button class="tab-btn" data-src="tools/diff.html">æ–‡æœ¬å¯¹æ¯” (Diff)</button>
                            <button class="tab-btn" data-src="tools/markdown.html">Markdown</button>
                            <div class="dropdown-divider"></div>
                            <button class="tab-btn" data-src="tools/encrypt.html">å¯¹ç§°åŠ å¯†</button>
                            <button class="tab-btn" data-src="tools/obfuscator.html">HTML æ··æ·†</button>
                        </div>
                    </div>
        
                    <!-- File Dropdown -->
                    <div class="dropdown">
                        <button class="tab-btn dropdown-toggle">æ–‡ä»¶ä¸æ•°æ®</button>
                        <div class="dropdown-content">
                            <button class="tab-btn" data-src="tools/file.html">æ–‡ä»¶ç®¡ç†</button>
                            <button class="tab-btn" data-src="tools/file-encoding.html">æ–‡ä»¶ç¼–ç </button>
                            <button class="tab-btn" data-src="tools/file-qrcode.html">æ–‡ä»¶äºŒç»´ç åºåˆ—</button>
                            <div class="dropdown-divider"></div>
                            <button class="tab-btn" data-src="tools/datetime.html">æ—¶é—´å·¥å…·</button>
                            <button class="tab-btn" data-src="tools/unit.html">å•ä½æ¢ç®—</button>
                            <div class="dropdown-divider"></div>
                            <button class="tab-btn" data-src="tools/hash.html">å“ˆå¸Œè®¡ç®—</button>
                            <button class="tab-btn" data-src="tools/generator.html">æ•°æ®ç”Ÿæˆå™¨</button>
                            <button class="tab-btn" data-src="tools/qrcode.html">äºŒç»´ç ç”Ÿæˆ</button>
                        </div>
                    </div>
        
                    <!-- Network Dropdown -->
                    <div class="dropdown">
                        <button class="tab-btn dropdown-toggle">ç½‘ç»œä¸æŸ¥è¯¢</button>
                        <div class="dropdown-content">
                            <button class="tab-btn" data-src="tools/network-ip.html">IP ä¿¡æ¯æŸ¥è¯¢</button>
                            <button class="tab-btn" data-src="tools/url.html">URL è§£æå™¨</button>
                            <button class="tab-btn" data-src="tools/network-ping.html">ç½‘ç»œæµ‹è¯•</button>
                            <button class="tab-btn" data-src="tools/network-rdap.html">RDAP/Whois æŸ¥è¯¢</button>
                            <button class="tab-btn" data-src="tools/network-github.html">GitHub æœç´¢</button>
                            <button class="tab-btn" data-src="tools/network-epic.html">Epic å…è´¹æ¸¸æˆ</button>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="tab-btn dropdown-toggle">AI ä¸æ™ºèƒ½</button>
                        <div class="dropdown-content">
                            <button class="tab-btn" data-src="tools/ai-tts.html">è¯­éŸ³åˆæˆ (TTS)</button>
                            <button class="tab-btn" data-src="tools/ai-stt.html">è¯­éŸ³è½¬æ–‡æœ¬ (STT)</button>
                            <button class="tab-btn" data-src="tools/ai-translate.html">æ™ºèƒ½ç¿»è¯‘</button>
                        </div>
                    </div>
                </nav>

                <button id="offline-btn" title="ç¦»çº¿å¯ç”¨æ€§" style="margin-left: 15px; background:rgba(255,255,255,0.1); border:none; color:var(--text-main); cursor:pointer; height:32px; padding:0 10px; border-radius:16px; display:flex; align-items:center; justify-content:center; transition:0.2s; font-size:0.8rem;">
                    âŠ—
                </button>
                <button id="theme-btn" title="åˆ‡æ¢ä¸»é¢˜" style="margin-left: 10px; background:rgba(255,255,255,0.1); border:none; color:var(--text-main); cursor:pointer; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:0.2s;">
                    â¤
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Drawer -->
    <div id="mobile-drawer" style="position:fixed; top:60px; left:-100%; width:260px; height:calc(100% - 60px); background:var(--bg-deep); border-right:1px solid var(--border); transition:left 0.3s ease; z-index:100; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.5rem; box-shadow: 2px 0 10px rgba(0,0,0,0.5);">
        <!-- Content will be injected by JS or cloned -->
    </div>
    <div id="mobile-overlay" style="display:none; position:fixed; top:60px; left:0; width:100%; height:calc(100% - 60px); background:rgba(0,0,0,0.5); z-index:90; backdrop-filter:blur(3px);"></div>
    
    <main style="position:relative;">
        <div id="loading-overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:var(--bg-deep); z-index:50; justify-content:center; align-items:center; flex-direction:column;">
            <div class="spinner"></div>
            <div style="margin-top:10px; color:var(--text-dim); font-size:0.9rem;">åŠ è½½ä¸­...</div>
        </div>
        <iframe id="app-frame" src="tools/home.html"></iframe>
    </main>

    <!-- Theme Modal -->
    <div id="theme-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); z-index:2000; align-items:center; justify-content:center; opacity:0; transition: opacity 0.3s;">
        <div style="background:var(--bg-deep); width:600px; max-height:85vh; overflow-y:auto; padding:24px; border-radius:var(--radius-lg); border:1px solid var(--border); box-shadow:var(--shadow); transform: scale(0.95); transition: transform 0.3s;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; position:sticky; top:0; background:var(--bg-deep); padding-bottom:10px; border-bottom:1px solid var(--border); z-index:10;">
                <div>
                    <h3 style="margin:0; color:var(--text-main); font-size:1.2rem;">ä¸»é¢˜è®¾ç½®</h3>
                    <div style="font-size:0.8rem; color:var(--text-dim); margin-top:4px;">é€‰æ‹©æ‚¨å–œæ¬¢çš„ç•Œé¢é£æ ¼</div>
                </div>
                <button id="theme-modal-close" style="background:none; border:none; color:var(--text-dim); font-size:1.5rem; cursor:pointer; padding:5px; border-radius:50%; display:flex; align-items:center; justify-content:center; width:32px; height:32px;">Ã—</button>
            </div>
            
            <div style="margin-bottom:30px;">
                <h4 style="color:var(--text-dim); margin-bottom:15px; font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; font-weight:600;">é£æ ¼é¢„è®¾ (Presets)</h4>
                <div id="preset-themes-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:15px;">
                    <!-- Themes will be generated by JS -->
                </div>
            </div>

            <div style="margin-bottom:30px;">
                <h4 style="color:var(--text-dim); margin-bottom:15px; font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; font-weight:600;">ä»¿çŸ¥åç½‘ç«™é…è‰² (Famous Sites)</h4>
                <div id="famous-themes-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:15px;">
                    <!-- Themes will be generated by JS -->
                </div>
            </div>

            <div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h4 style="color:var(--text-dim); margin:0; font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; font-weight:600;">è‡ªå®šä¹‰ (Custom)</h4>
                    <div style="display:flex; gap:8px;">
                        <button id="randomize-btn" class="btn btn-sm btn-secondary" style="font-size:0.75rem; padding:2px 8px;">ğŸ² éšæœº</button>
                        <button id="chaos-btn" class="btn btn-sm btn-secondary" style="font-size:0.75rem; padding:2px 8px;">ğŸ”¥ å…¨éšæœº</button>
                        <button id="meltdown-btn" class="btn btn-sm btn-secondary" style="font-size:0.75rem; padding:2px 8px;">ğŸŒ€ å´©å</button>
                    </div>
                </div>
                <div style="background:var(--bg-panel); padding:20px; border-radius:var(--radius-md); border:1px solid var(--border);">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="font-size:0.8rem; color:var(--text-dim);">ä¸»è‰² (Primary)</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="custom-primary">
                                <span id="val-primary">#000000</span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="font-size:0.8rem; color:var(--text-dim);">è¾…è‰² (Secondary)</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="custom-secondary">
                                <span id="val-secondary">#000000</span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="font-size:0.8rem; color:var(--text-dim);">èƒŒæ™¯ (Background)</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="custom-bg">
                                <span id="val-bg">#000000</span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="font-size:0.8rem; color:var(--text-dim);">æ–‡æœ¬ (Text)</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="custom-text-main">
                                <span id="val-text">#000000</span>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden inputs -->
                    <input type="hidden" id="custom-accent">
                    <input type="hidden" id="custom-text-dim">
                </div>
            </div>
        </div>
    </div>

    <div id="offline-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); z-index:2000; align-items:center; justify-content:center; opacity:0; transition: opacity 0.3s;">
        <div style="background:var(--bg-deep); width:640px; max-height:85vh; overflow-y:auto; padding:24px; border-radius:var(--radius-lg); border:1px solid var(--border); box-shadow:var(--shadow); transform: scale(0.95); transition: transform 0.3s;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; position:sticky; top:0; background:var(--bg-deep); padding-bottom:10px; border-bottom:1px solid var(--border); z-index:10; gap:12px;">
                <div style="min-width:0;">
                    <h3 style="margin:0; color:var(--text-main); font-size:1.2rem;">ç¦»çº¿å¯ç”¨æ€§</h3>
                    <div style="font-size:0.8rem; color:var(--text-dim); margin-top:4px;">é€‰æ‹©éœ€è¦ç¦»çº¿ç¼“å­˜çš„å·¥å…·é¡µ</div>
                    <div id="offline-cache-summary" style="font-size:0.75rem; color:var(--text-dim); margin-top:6px;">æš‚æ— ç»Ÿè®¡</div>
                    <div style="font-size:0.7rem; color:var(--text-dim); margin-top:4px;">æµè§ˆå™¨å ç”¨å¯èƒ½éœ€è¦åˆ·æ–°æ‰ä¼šæ¸…é™¤</div>
                    <div style="font-size:0.7rem; color:var(--text-dim); margin-top:2px;">è·¨åŸŸèµ„æºå¯èƒ½æ˜¾ç¤º 0Bï¼Œä½†ä»è®¡å…¥æµè§ˆå™¨å ç”¨</div>
                </div>
                <button id="offline-modal-close" style="background:none; border:none; color:var(--text-dim); font-size:1.5rem; cursor:pointer; padding:5px; border-radius:50%; display:flex; align-items:center; justify-content:center; width:32px; height:32px;">Ã—</button>
            </div>
            <div id="offline-status" style="font-size:0.8rem; color:var(--text-dim); margin-bottom:12px;"></div>
            <div style="display:flex; flex-direction:column; gap:14px;" id="offline-layout">
                <div id="offline-list" style="display:flex; flex-direction:column; gap:14px;"></div>
                <div style="padding:12px; border:1px solid var(--border); border-radius:var(--radius-md); background:var(--bg-panel);">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                        <div style="font-size:0.85rem; color:var(--text-main);">ç¼“å­˜æ˜ç»†</div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button id="offline-stats-refresh" class="btn btn-sm btn-secondary">åˆ·æ–°ç»Ÿè®¡</button>
                        </div>
                    </div>
                    <div id="offline-cache-details" style="margin-top:10px; max-height:200px; overflow:auto; border-top:1px solid var(--border); padding-top:10px; font-size:0.75rem; color:var(--text-dim); display:grid; gap:6px;"></div>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; gap:10px; flex-wrap:wrap;">
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button id="offline-select-all" class="btn btn-sm btn-secondary">å…¨é€‰</button>
                    <button id="offline-clear" class="btn btn-sm btn-secondary">æ¸…ç©º</button>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button id="offline-advanced-toggle" class="btn btn-secondary">é«˜çº§ä¾èµ–è®¾ç½®</button>
                    <button id="offline-apply" class="btn btn-primary">åº”ç”¨é€‰æ‹©</button>
                    <button id="offline-clear-site" class="btn btn-secondary">æ¸…é™¤ç½‘ç«™æ•°æ®</button>
                </div>
            </div>
        </div>
    </div>
    <div id="offline-advanced-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); z-index:2100; align-items:center; justify-content:center; opacity:0; transition: opacity 0.3s;">
        <div style="background:var(--bg-deep); max-height:85vh; overflow-y:auto; padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border); box-shadow:var(--shadow); transform: scale(0.95); transition: transform 0.3s;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; position:sticky; top:0; background:var(--bg-deep); padding-bottom:10px; border-bottom:1px solid var(--border); z-index:10;">
                <div>
                    <h3 style="margin:0; color:var(--text-main); font-size:1.1rem;">é«˜çº§ä¾èµ–è®¾ç½®</h3>
                    <div style="font-size:0.8rem; color:var(--text-dim); margin-top:4px;">æŒ‰å·¥å…·ç»†åŒ–ä¾èµ–ï¼Œè‡ªåŠ¨åŒæ­¥å…±äº«ä¾èµ–</div>
                </div>
                <button id="offline-advanced-close" style="background:none; border:none; color:var(--text-dim); font-size:1.5rem; cursor:pointer; padding:5px; border-radius:50%; display:flex; align-items:center; justify-content:center; width:32px; height:32px;">Ã—</button>
            </div>
            <div id="offline-advanced-list" style="display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>

    <style>
        .color-input-wrapper {
            display:flex; 
            align-items:center; 
            background:rgba(0,0,0,0.1); 
            padding:5px 10px; 
            border-radius:var(--radius-sm); 
            border:1px solid var(--border);
            transition: border-color 0.3s;
        }
        .color-input-wrapper:focus-within {
            border-color: var(--primary);
        }
        .color-input-wrapper input[type="color"] {
            background:none; 
            border:none; 
            width:24px; 
            height:24px; 
            padding:0; 
            cursor:pointer;
        }
        .color-input-wrapper span {
            font-size:0.8rem; 
            margin-left:10px; 
            font-family:var(--font-mono); 
            color:var(--text-main);
            opacity: 0.8;
        }
        .theme-card {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .theme-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-color: var(--primary);
        }
        .theme-card.active {
            border-color: var(--secondary);
            background: rgba(var(--primary-rgb), 0.1);
            box-shadow: 0 0 0 2px var(--secondary);
        }
        .theme-preview {
            height: 60px;
            border-radius: var(--radius-sm);
            margin-bottom: 5px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #offline-layout {
            grid-template-columns: 2fr 1fr;
        }
        #offline-advanced-modal > div {
            width: min(720px, 92vw);
        }
        @media (max-width: 900px) {
            #offline-layout {
                grid-template-columns: 1fr;
            }
            #offline-cache-details {
                max-height: 160px;
            }
        }
    </style>

    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js?v=15')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        try { registration.update(); } catch (e) {}
                        syncOfflinePrefs();
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        const frame = document.getElementById('app-frame');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Only select tab buttons that have a data-src attribute (exclude dropdown toggles)
        const buttons = document.querySelectorAll('.tab-btn[data-src]');
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        frame.addEventListener('load', () => {
             hideLoading();
             const frameSrc = frame.getAttribute('src') || '';
             if (currentThemeData && (lastAppliedFrameSrc !== frameSrc || lastAppliedFrameSignature !== themeSignature)) {
                 applyThemeVariables(currentThemeData);
                 lastAppliedFrameSrc = frameSrc;
                 lastAppliedFrameSignature = themeSignature;
             }
             if (isMeltdownMode && (!lastMeltdownAppliedState || lastMeltdownAppliedSrc !== frameSrc)) {
                 applyMeltdownEffect();
                 lastMeltdownAppliedState = true;
                 lastMeltdownAppliedSrc = frameSrc;
             }
        });

        let themeSignature = '';
        let lastAppliedFrameSrc = '';
        let lastAppliedFrameSignature = '';
        let lastMeltdownAppliedState = false;
        let lastMeltdownAppliedSrc = '';

        function switchToHome() {
            const homeBtn = document.querySelector('.tab-btn[data-src="tools/home.html"]');
            if (homeBtn) homeBtn.click();
        }

        // Expose switchTab for iframe content (e.g., home.html cards)
        window.switchTab = function(url) {
            const btn = document.querySelector(`.tab-btn[data-src="${url}"]`);
            if(btn) {
                // If the button is inside a dropdown, we might want to ensure the dropdown is visible or just click it
                btn.click();
                // Scroll button into view if needed (less relevant now with dropdowns, but good for Home)
                btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        };

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.src;
                if (!target) return;

                // Remove active class from all buttons
                buttons.forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                btn.classList.add('active');

                // Also handle Parent Dropdown Active State if needed
                // Reset all dropdown toggles
                document.querySelectorAll('.dropdown-toggle').forEach(t => t.classList.remove('active'));
                
                // If button is inside a dropdown-content, highlight the parent dropdown toggle
                const dropdownContent = btn.closest('.dropdown-content');
                if (dropdownContent) {
                    const dropdown = dropdownContent.parentElement;
                    const toggle = dropdown.querySelector('.dropdown-toggle');
                    if (toggle) toggle.classList.add('active');
                }

                const current = new URL(frame.src, window.location.href);
                const next = new URL(target, window.location.href);
                if (current.href === next.href) return;
                if (window.app && typeof app.releaseAllWorkers === 'function') {
                    try { app.releaseAllWorkers(); } catch (e) {}
                }
                if (window.ResourceLoader) {
                    ResourceLoader.loadToolDeps(target).finally(() => {
                        showLoading();
                        frame.src = target;
                    });
                } else {
                    showLoading();
                    frame.src = target;
                }
            });
        });

        // Theme Logic
        let currentThemeData = null;
        let presetThemes = null;
        let famousThemes = null;
        let allThemes = null;
        let themeDataLoaded = false;
        let themeDataLoading = null;

        function captureCurrentThemeData() {
            const styles = getComputedStyle(document.documentElement);
            const keys = ['--bg-deep', '--bg-panel', '--bg-header', '--primary', '--secondary', '--accent', '--text-main', '--text-dim', '--bg-image', '--font-main', '--font-mono', '--radius-lg', '--radius-md', '--radius-sm', '--shadow', '--border', '--input-bg', '--btn-bg', '--btn-hover-bg'];
            const theme = {};
            keys.forEach((key) => {
                const value = styles.getPropertyValue(key).trim();
                if (value) theme[key] = value;
            });
            return theme;
        }

        currentThemeData = captureCurrentThemeData();

        function loadThemeData() {
            if (themeDataLoaded) return Promise.resolve();
            if (themeDataLoading) return themeDataLoading;
            themeDataLoading = new Promise((resolve, reject) => {
                const finish = () => {
                    const data = window.__themeData;
                    if (!data || !data.presetThemes || !data.famousThemes) {
                        themeDataLoading = null;
                        reject(new Error('theme data missing'));
                        return;
                    }
                    presetThemes = data.presetThemes;
                    famousThemes = data.famousThemes;
                    allThemes = { ...presetThemes, ...famousThemes };
                    if (!currentThemeData && presetThemes.aurora) {
                        currentThemeData = presetThemes.aurora.vars;
                    }
                    themeDataLoaded = true;
                    resolve();
                };
                const existing = document.getElementById('theme-data-script');
                if (existing) {
                    if (themeDataLoaded) {
                        resolve();
                    } else {
                        existing.addEventListener('load', finish, { once: true });
                        existing.addEventListener('error', () => {
                            themeDataLoading = null;
                            reject(new Error('theme data load failed'));
                        }, { once: true });
                    }
                    return;
                }
                const script = document.createElement('script');
                script.id = 'theme-data-script';
                script.src = 'js/theme-data.js';
                script.onload = finish;
                script.onerror = () => {
                    themeDataLoading = null;
                    reject(new Error('theme data load failed'));
                };
                document.head.appendChild(script);
            });
            return themeDataLoading;
        }



        function renderThemeList() {
            if (!presetThemes || !famousThemes) return;
            const renderGrid = (containerId, themesObj) => {
                const grid = document.getElementById(containerId);
                if(!grid) return;
                grid.innerHTML = '';

                Object.entries(themesObj).forEach(([key, theme]) => {
                    const btn = document.createElement('div');
                    btn.className = 'theme-card';
                    btn.onclick = () => setTheme(key);
                    
                    // Create preview
                    const preview = document.createElement('div');
                    preview.className = 'theme-preview';
                    preview.style.background = theme.vars['--bg-deep'];
                    preview.style.backgroundImage = theme.vars['--bg-image'];
                    
                    // Add a small "window" inside preview to show panel color
                    const panel = document.createElement('div');
                    panel.style.position = 'absolute';
                    panel.style.bottom = '10px';
                    panel.style.right = '10px';
                    panel.style.width = '60%';
                    panel.style.height = '60%';
                    panel.style.background = theme.vars['--bg-panel'];
                    panel.style.borderRadius = theme.vars['--radius-sm'];
                    panel.style.border = `1px solid ${theme.vars['--border'] || 'rgba(255,255,255,0.1)'}`;
                    preview.appendChild(panel);

                    // Add primary color dot
                    const dot = document.createElement('div');
                    dot.style.position = 'absolute';
                    dot.style.top = '10px';
                    dot.style.left = '10px';
                    dot.style.width = '12px';
                    dot.style.height = '12px';
                    dot.style.borderRadius = '50%';
                    dot.style.background = theme.vars['--primary'];
                    preview.appendChild(dot);

                    const info = document.createElement('div');
                    info.innerHTML = `
                        <div style="font-weight:bold; font-size:0.9rem; color:var(--text-main)">${theme.name.split(' ')[0]}</div>
                        <div style="font-size:0.7rem; color:var(--text-dim); margin-top:2px;">${theme.desc}</div>
                    `;

                    btn.appendChild(preview);
                    btn.appendChild(info);
                    grid.appendChild(btn);
                });
            };

            renderGrid('preset-themes-grid', presetThemes);
            renderGrid('famous-themes-grid', famousThemes);
        }

        function toggleThemeModal() {
            const modal = document.getElementById('theme-modal');
            if (modal.style.display === 'flex') {
                modal.style.opacity = '0';
                modal.querySelector('div').style.transform = 'scale(0.95)';
                setTimeout(() => modal.style.display = 'none', 300);
            } else {
                loadThemeData().then(() => {
                    renderThemeList();
                    modal.style.display = 'flex';
                    modal.offsetHeight;
                    modal.style.opacity = '1';
                    modal.querySelector('div').style.transform = 'scale(1)';
                }).catch(() => {
                    modal.style.display = 'flex';
                    modal.offsetHeight;
                    modal.style.opacity = '1';
                    modal.querySelector('div').style.transform = 'scale(1)';
                    if (window.app && app.showToast) app.showToast('ä¸»é¢˜æ•°æ®åŠ è½½å¤±è´¥', 'error');
                });
            }
        }

        const OFFLINE_PREF_KEY = 'aurora_offline_optional_v1';
        const OFFLINE_DEP_PREF_KEY = 'aurora_offline_dep_prefs_v1';
        const OFFLINE_REQUIRED = new Set(['./tools/home.html']);

        function normalizeToolUrl(url) {
            if (!url) return '';
            if (url.startsWith('./')) return url;
            if (url.startsWith('/')) return '.' + url;
            return './' + url;
        }

        function collectOfflineGroups() {
            const groups = [];
            const map = new Map();
            const seen = new Set();
            document.querySelectorAll('.tab-btn[data-src]').forEach(btn => {
                const raw = btn.dataset.src;
                const url = normalizeToolUrl(raw);
                if (!url || !url.endsWith('.html')) return;
                if (seen.has(url)) return;
                seen.add(url);
                let group = 'åŸºç¡€';
                const dropdown = btn.closest('.dropdown');
                if (dropdown) {
                    const toggle = dropdown.querySelector('.dropdown-toggle');
                    if (toggle && toggle.innerText.trim()) group = toggle.innerText.trim();
                }
                if (!map.has(group)) {
                    const entry = { group, items: [] };
                    map.set(group, entry);
                    groups.push(entry);
                }
                map.get(group).items.push({ url, label: btn.innerText.trim() || url });
            });
            return groups;
        }

        function getToolMetaMap() {
            const meta = new Map();
            const groups = collectOfflineGroups();
            groups.forEach(group => {
                group.items.forEach(item => {
                    meta.set(item.url, { label: item.label, group: group.group });
                });
            });
            return meta;
        }

        function getAvailableOfflineUrls(groups) {
            const list = [];
            groups.forEach(g => g.items.forEach(item => list.push(item.url)));
            return list;
        }

        function getDepPrefs() {
            try {
                const raw = localStorage.getItem(OFFLINE_DEP_PREF_KEY);
                const data = JSON.parse(raw || '{}');
                return data && typeof data === 'object' ? data : {};
            } catch (e) {
                return {};
            }
        }

        function setDepPrefs(prefs) {
            try {
                localStorage.setItem(OFFLINE_DEP_PREF_KEY, JSON.stringify(prefs || {}));
            } catch (e) {}
        }

        function buildToolDepsMap() {
            if (!window.ResourceLoader) return { toolDeps: new Map(), depUsage: new Map() };
            const loader = ResourceLoader;
            const toolDeps = new Map();
            const depUsage = new Map();
            const groups = collectOfflineGroups();
            const tools = [];
            groups.forEach(g => g.items.forEach(item => tools.push(item.url)));
            tools.forEach(toolUrl => {
                const key = loader.getToolId ? loader.getToolId(toolUrl) : toolUrl;
                const deps = (loader.toolDeps && loader.toolDeps[key]) ? loader.toolDeps[key] : [];
                const resolved = loader._resolveDeps ? loader._resolveDeps(deps) : deps;
                if (!resolved || !resolved.length) return;
                toolDeps.set(toolUrl, resolved);
                resolved.forEach(lib => {
                    if (!depUsage.has(lib)) depUsage.set(lib, new Set());
                    depUsage.get(lib).add(toolUrl);
                });
            });
            return { toolDeps, depUsage };
        }

        function collectOfflineDeps(toolUrls) {
            if (!window.ResourceLoader) return [];
            const loader = ResourceLoader;
            const prefs = getDepPrefs();
            const map = buildToolDepsMap();
            const libs = [];
            toolUrls.forEach(toolUrl => {
                const deps = map.toolDeps.get(toolUrl) || [];
                deps.forEach(lib => {
                    if (prefs[toolUrl] && prefs[toolUrl][lib] === false) return;
                    libs.push(lib);
                });
            });
            const seen = new Set();
            const uniqueLibs = libs.filter(lib => {
                if (seen.has(lib)) return false;
                seen.add(lib);
                return true;
            });
            const urls = [];
            uniqueLibs.forEach(lib => {
                const sources = loader.registry ? loader.registry[lib] : null;
                if (!sources) return;
                let arr = Array.isArray(sources) ? sources : (sources.url ? [sources.url].concat(sources.fallback ? [sources.fallback] : []) : [sources]);
                arr = arr.filter(Boolean);
                if (loader._prioritizeUrls) arr = loader._prioritizeUrls(arr);
                if (loader._reorderUrls) arr = loader._reorderUrls(lib, arr);
                const first = arr[0];
                if (first && !urls.includes(first)) urls.push(first);
            });
            return urls;
        }

        function getOfflinePrefs() {
            try {
                const raw = localStorage.getItem(OFFLINE_PREF_KEY);
                const list = JSON.parse(raw || '[]');
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function setOfflinePrefs(urls) {
            try {
                localStorage.setItem(OFFLINE_PREF_KEY, JSON.stringify(urls || []));
            } catch (e) {}
        }

        function toggleOfflineModal() {
            const modal = document.getElementById('offline-modal');
            if (modal.style.display === 'flex') {
                modal.style.opacity = '0';
                modal.querySelector('div').style.transform = 'scale(0.95)';
                setTimeout(() => modal.style.display = 'none', 300);
                closeAdvancedModal();
            } else {
                renderOfflineList();
                refreshOfflineStatus();
                modal.style.display = 'flex';
                modal.offsetHeight;
                modal.style.opacity = '1';
                modal.querySelector('div').style.transform = 'scale(1)';
                console.log('[Offline] modal opened');
            }
        }

        function renderOfflineList() {
            const container = document.getElementById('offline-list');
            if (!container) return;
            container.innerHTML = '';
            const groups = collectOfflineGroups();
            const available = new Set(getAvailableOfflineUrls(groups));
            const saved = getOfflinePrefs().filter(u => available.has(u));
            if (saved.length !== getOfflinePrefs().length) setOfflinePrefs(saved);
            const selected = new Set(saved);
            groups.forEach(group => {
                const wrap = document.createElement('div');
                const title = document.createElement('div');
                title.style.cssText = 'font-size:0.75rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; font-weight:600; margin-bottom:8px;';
                title.innerText = group.group;
                const grid = document.createElement('div');
                grid.style.cssText = 'display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:10px;';
                group.items.forEach(item => {
                    const label = document.createElement('label');
                    label.style.cssText = 'display:flex; flex-direction:column; gap:6px; background:var(--bg-panel); border:1px solid var(--border); border-radius:var(--radius-sm); padding:8px 10px; cursor:pointer;';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.dataset.url = item.url;
                    cb.checked = selected.has(item.url) || OFFLINE_REQUIRED.has(item.url);
                    if (OFFLINE_REQUIRED.has(item.url)) cb.disabled = true;
                    const text = document.createElement('span');
                    text.style.cssText = 'font-size:0.85rem; color:var(--text-main);';
                    text.innerText = item.label;
                    const badge = document.createElement('span');
                    badge.dataset.url = item.url;
                    badge.dataset.role = 'offline-badge';
                    badge.style.cssText = 'font-size:0.7rem; color:var(--text-dim);';
                    const info = document.createElement('span');
                    info.style.cssText = 'font-size:0.7rem; color:var(--text-dim);';
                    const deps = (buildToolDepsMap().toolDeps.get(item.url) || []).length;
                    info.innerText = deps ? `ä¾èµ–: ${deps}` : '';
                    const adv = document.createElement('button');
                    adv.type = 'button';
                    adv.dataset.tool = item.url;
                    adv.style.cssText = 'margin-left:auto; font-size:0.85rem; line-height:1; padding:2px 6px; border:1px solid var(--border); border-radius:4px; background:var(--bg-deep); color:var(--text-dim); cursor:pointer;';
                    adv.innerText = 'âš™';
                    adv.title = 'é«˜çº§è®¾ç½®';
                    adv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openAdvancedModal([item.url]);
                    });
                    const row = document.createElement('div');
                    row.style.cssText = 'display:flex; align-items:center; gap:8px;';
                    row.appendChild(cb);
                    row.appendChild(text);
                    row.appendChild(adv);
                    const meta = document.createElement('div');
                    meta.style.cssText = 'display:flex; align-items:center; gap:10px;';
                    meta.appendChild(badge);
                    if (info.innerText) meta.appendChild(info);
                    label.appendChild(row);
                    label.appendChild(meta);
                    grid.appendChild(label);
                });
                wrap.appendChild(title);
                wrap.appendChild(grid);
                container.appendChild(wrap);
            });
            if (!container.dataset.bound) {
                container.addEventListener('change', () => {
                    const urls = getSelectedOfflineUrls(false);
                    setOfflinePrefs(urls);
                    const advModal = document.getElementById('offline-advanced-modal');
                    if (advModal && advModal.style.display === 'flex') renderAdvancedDeps();
                });
                container.dataset.bound = '1';
            }
        }

        function getOfflineCheckboxes() {
            return Array.from(document.querySelectorAll('#offline-list input[type="checkbox"][data-url]'));
        }

        function getSelectedOfflineUrls(usePrefsFallback = true) {
            const selected = getOfflineCheckboxes().filter(cb => cb.checked && !cb.disabled).map(cb => cb.dataset.url);
            if (selected.length) return selected;
            if (!usePrefsFallback) return [];
            const prefs = getOfflinePrefs();
            return Array.isArray(prefs) ? prefs : [];
        }

        function setAllOfflineCheckboxes(checked) {
            getOfflineCheckboxes().forEach(cb => { if (!cb.disabled) cb.checked = checked; });
            const urls = getSelectedOfflineUrls(false);
            setOfflinePrefs(urls);
        }

        async function refreshOfflineStatus() {
            const status = document.getElementById('offline-status');
            if (!('caches' in window)) {
                if (status) status.innerText = 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç¼“å­˜æ¥å£';
                return;
            }
            const badges = Array.from(document.querySelectorAll('#offline-list [data-role="offline-badge"]'));
            let cachedCount = 0;
            for (const badge of badges) {
                const url = badge.dataset.url;
                try {
                    const abs = new URL(url, window.location.href).href;
                    const match = await caches.match(abs);
                    if (match) {
                        badge.innerText = 'å·²ç¼“å­˜';
                        badge.style.color = 'var(--primary)';
                        cachedCount++;
                    } else {
                        badge.innerText = 'æœªç¼“å­˜';
                        badge.style.color = 'var(--text-dim)';
                    }
                } catch (e) {
                    badge.innerText = 'æœªçŸ¥';
                    badge.style.color = 'var(--text-dim)';
                }
            }
            if (status) status.innerText = `å·²ç¼“å­˜ ${cachedCount} / ${badges.length}`;
            showCacheStats();
        }

        async function getCacheName() {
            try {
                const names = await caches.keys();
                if (!names || !names.length) return '';
                const preferred = names.find(n => n.includes('aurora-toolbox'));
                return preferred || names[0];
            } catch (e) {
                return '';
            }
        }

        async function showCacheStats() {
            const summary = document.getElementById('offline-cache-summary');
            const details = document.getElementById('offline-cache-details');
            if (!('caches' in window)) {
                if (summary) summary.innerText = 'ç¼“å­˜æ¥å£ä¸å¯ç”¨';
                return;
            }
            try {
                const formatBytes = (value) => {
                    if (value === 0) return '0 B';
                    if (!value || Number.isNaN(value)) return 'æœªçŸ¥';
                    const units = ['B', 'KB', 'MB', 'GB'];
                    let v = value;
                    let i = 0;
                    while (v >= 1024 && i < units.length - 1) {
                        v /= 1024;
                        i++;
                    }
                    return `${v.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
                };
                let storageUsage = null;
                let storageQuota = null;
                if (navigator.storage && navigator.storage.estimate) {
                    try {
                        const estimate = await navigator.storage.estimate();
                        storageUsage = estimate.usage;
                        storageQuota = estimate.quota;
                    } catch (e) {}
                }
                const name = await getCacheName();
                if (!name) {
                    if (summary) {
                        const usageText = storageUsage != null ? ` â€¢ æµè§ˆå™¨å ç”¨ ${formatBytes(storageUsage)}${storageQuota ? ` / ${formatBytes(storageQuota)}` : ''}` : '';
                        summary.innerText = `æš‚æ— ç¼“å­˜${usageText}`;
                    }
                    if (details) details.innerHTML = '';
                    return;
                }
                const cache = await caches.open(name);
                const keys = await cache.keys();
                let total = 0;
                let unknownCount = 0;
                const group = {
                    required: { count: 0, size: 0 },
                    optional: { count: 0, size: 0 },
                    cdn: { count: 0, size: 0 }
                };
                const requiredRel = [
                    './',
                    './index.html',
                    './css/style.css',
                    './js/app.js',
                    './js/loader.js',
                    './js/perf-monitor.js',
                    './favicon.svg',
                    './tools/home.html'
                ];
                const requiredAbs = new Set(requiredRel.map(p => new URL(p, window.location.href).href));
                const items = [];
                for (const req of keys) {
                    try {
                        const res = await cache.match(req);
                        let size = 0;
                        let known = false;
                        if (res && res.headers && res.headers.get('content-length')) {
                            const len = Number(res.headers.get('content-length'));
                            if (!Number.isNaN(len)) {
                                size = len;
                                total += len;
                                known = true;
                            }
                        }
                        if (!known && res && res.body && res.type !== 'opaque') {
                            const reader = res.body.getReader();
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;
                                total += value.byteLength;
                                size += value.byteLength;
                            }
                            known = true;
                        }
                        if (!known) unknownCount++;
                        const u = new URL(req.url);
                        const isSame = u.origin === window.location.origin;
                        const isRequired = isSame && requiredAbs.has(req.url);
                        if (isSame) {
                            if (isRequired) {
                                group.required.count++;
                                group.required.size += size;
                            } else {
                                group.optional.count++;
                                group.optional.size += size;
                                items.push({ url: req.url, size });
                            }
                        } else {
                            group.cdn.count++;
                            group.cdn.size += size;
                            items.push({ url: req.url, size });
                        }
                    } catch (e) {}
                }
                if (summary) {
                    const usageText = storageUsage != null ? ` â€¢ æµè§ˆå™¨å ç”¨ ${formatBytes(storageUsage)}${storageQuota ? ` / ${formatBytes(storageQuota)}` : ''}` : '';
                    summary.innerText = `å¿…éœ€é¡¹ ${group.required.count}ï¼ˆ${formatBytes(group.required.size)}ï¼‰ â€¢ å¯é€‰é¡¹ ${group.optional.count}ï¼ˆ${formatBytes(group.optional.size)}ï¼‰ â€¢ ä¾èµ– ${group.cdn.count}ï¼ˆ${formatBytes(group.cdn.size)}ï¼‰ â€¢ å¯è¯»æ€»è®¡ ${formatBytes(total)}${usageText}`;
                }
                if (details) {
                    details.innerHTML = '';
                    const reqLine = document.createElement('div');
                    reqLine.innerText = `å¿…é¡»é¡¹ï¼š${group.required.count} æ¡ â€” ${formatBytes(group.required.size)}`;
                    details.appendChild(reqLine);
                    if (unknownCount) {
                        const unknownLine = document.createElement('div');
                        unknownLine.innerText = `æœªçŸ¥å¤§å°ï¼š${unknownCount} æ¡`;
                        details.appendChild(unknownLine);
                    }
                    items.sort((a, b) => b.size - a.size);
                    items.slice(0, 50).forEach(item => {
                        const div = document.createElement('div');
                        div.innerText = `${item.url}  â€”  ${formatBytes(item.size)}`;
                        details.appendChild(div);
                    });
                }
            } catch (e) {
                if (summary) summary.innerText = 'ç»Ÿè®¡å¤±è´¥';
            }
        }

        function postOfflinePrefs(urls) {
            if (!('serviceWorker' in navigator)) return;
            const payload = { type: 'OFFLINE_PREFS', urls: urls || [], cdnUrls: collectOfflineDeps(urls || []) };
            navigator.serviceWorker.ready.then(reg => {
                const sw = navigator.serviceWorker.controller || reg.active;
                if (sw) sw.postMessage(payload);
            }).catch(() => {});
        }

        function syncOfflinePrefs() {
            const groups = collectOfflineGroups();
            const available = new Set(getAvailableOfflineUrls(groups));
            const prefs = getOfflinePrefs().filter(u => available.has(u));
            if (prefs.length !== getOfflinePrefs().length) setOfflinePrefs(prefs);
            postOfflinePrefs(prefs);
        }

        function applyOfflinePrefs() {
            const urls = getSelectedOfflineUrls(false);
            setOfflinePrefs(urls);
            postOfflinePrefs(urls);
            refreshOfflineStatus();
            const status = document.getElementById('offline-status');
            if (status) status.innerText = 'æ­£åœ¨åº”ç”¨é€‰æ‹©å¹¶ç¼“å­˜...';
            if (window.app && app.showToast) app.showToast('å·²å¼€å§‹ç¼“å­˜é€‰ä¸­å·¥å…·ä¸ä¾èµ–');
        }

        function renderAdvancedDeps(targetTools) {
            const container = document.getElementById('offline-advanced-list');
            if (!container) return;
            container.innerHTML = '';
            const prefs = getDepPrefs();
            const { toolDeps, depUsage } = buildToolDepsMap();
            const selectedTools = new Set(Array.isArray(targetTools) && targetTools.length ? targetTools : getSelectedOfflineUrls());
            const meta = getToolMetaMap();
            const tools = Array.from(toolDeps.keys()).filter(u => selectedTools.has(u));
            if (!tools.length) {
                const empty = document.createElement('div');
                empty.style.cssText = 'font-size:0.8rem; color:var(--text-dim);';
                empty.innerText = 'å½“å‰å·¥å…·æ— ä¾èµ–æˆ–æœªé€‰æ‹©';
                container.appendChild(empty);
                return;
            }
            tools.forEach(toolUrl => {
                const box = document.createElement('div');
                box.style.cssText = 'border:1px solid var(--border); border-radius:var(--radius-sm); padding:8px;';
                const header = document.createElement('div');
                header.style.cssText = 'display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;';
                const name = document.createElement('div');
                name.style.cssText = 'font-size:0.85rem; color:var(--text-main);';
                name.innerText = (meta.get(toolUrl) && meta.get(toolUrl).label) ? meta.get(toolUrl).label : toolUrl;
                const usage = document.createElement('div');
                usage.style.cssText = 'font-size:0.75rem; color:var(--text-dim);';
                const deps = toolDeps.get(toolUrl) || [];
                usage.innerText = `ä¾èµ–æ•°: ${deps.length}`;
                header.appendChild(name);
                header.appendChild(usage);
                const grid = document.createElement('div');
                grid.style.cssText = 'display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:8px;';
                deps.forEach(lib => {
                    const label = document.createElement('label');
                    label.style.cssText = 'display:flex; align-items:center; gap:8px;';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.dataset.tool = toolUrl;
                    cb.dataset.lib = lib;
                    cb.checked = !(prefs[toolUrl] && prefs[toolUrl][lib] === false);
                    const span = document.createElement('span');
                    span.style.cssText = 'font-size:0.8rem; color:var(--text-main);';
                    span.innerText = lib;
                    const shared = document.createElement('span');
                    shared.style.cssText = 'margin-left:auto; font-size:0.7rem; color:var(--text-dim);';
                    const users = (depUsage.get(lib) || new Set()).size;
                    shared.innerText = users > 1 ? `å…±äº«: ${users}` : '';
                    cb.addEventListener('change', () => {
                        const prefsNow = getDepPrefs();
                        const linkedTools = Array.from(depUsage.get(lib) || []);
                        linkedTools.forEach(t => {
                            if (!prefsNow[t]) prefsNow[t] = {};
                            prefsNow[t][lib] = cb.checked ? true : false;
                        });
                        setDepPrefs(prefsNow);
                        const all = container.querySelectorAll(`input[type="checkbox"][data-lib="${lib}"]`);
                        all.forEach(i => { i.checked = cb.checked; });
                    });
                    label.appendChild(cb);
                    label.appendChild(span);
                    label.appendChild(shared);
                    grid.appendChild(label);
                });
                box.appendChild(header);
                box.appendChild(grid);
                container.appendChild(box);
            });
        }
        function openAdvancedModal(targetTools) {
            const modal = document.getElementById('offline-advanced-modal');
            if (!modal) return;
            renderAdvancedDeps(targetTools);
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.style.opacity = '1';
            modal.querySelector('div').style.transform = 'scale(1)';
        }
        function closeAdvancedModal() {
            const modal = document.getElementById('offline-advanced-modal');
            if (!modal) return;
            modal.style.opacity = '0';
            modal.querySelector('div').style.transform = 'scale(0.95)';
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function clearSiteData() {
            const status = document.getElementById('offline-status');
            if (status) status.innerText = 'æ­£åœ¨æ¸…é™¤ç½‘ç«™æ•°æ®...';
            try {
                const names = await caches.keys();
                await Promise.all(names.map(n => caches.delete(n)));
            } catch (e) {}
            try {
                if ('serviceWorker' in navigator) {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(regs.map(r => r.unregister()));
                }
            } catch (e) {}
            try {
                if (window.indexedDB && indexedDB.databases) {
                    const dbs = await indexedDB.databases();
                    await Promise.all((dbs || []).map(db => new Promise(resolve => {
                        try {
                            const req = indexedDB.deleteDatabase(db.name || '');
                            req.onsuccess = req.onerror = req.onblocked = () => resolve();
                        } catch (e) {
                            resolve();
                        }
                    })));
                }
            } catch (e) {}
            try { localStorage.clear(); } catch (e) {}
            try { sessionStorage.clear(); } catch (e) {}
            if (status) status.innerText = 'ç½‘ç«™æ•°æ®å·²æ¸…é™¤';
            if (window.app && app.showToast) app.showToast('ç½‘ç«™æ•°æ®å·²æ¸…é™¤');
            setTimeout(() => location.reload(), 200);
        }

        // Close modal when clicking outside
        document.getElementById('theme-modal').addEventListener('click', function(e) {
            if (e.target === this) toggleThemeModal();
        });
        document.getElementById('offline-modal').addEventListener('click', function(e) {
            if (e.target === this) toggleOfflineModal();
        });
        document.getElementById('offline-advanced-toggle').addEventListener('click', function() {
            const urls = getSelectedOfflineUrls();
            openAdvancedModal(urls);
        });
        document.getElementById('offline-advanced-modal').addEventListener('click', function(e) {
            if (e.target === this) closeAdvancedModal();
        });
        document.getElementById('offline-advanced-close').addEventListener('click', function() {
            closeAdvancedModal();
        });
        document.getElementById('offline-stats-refresh').addEventListener('click', function() {
            showCacheStats();
        });

        function setTheme(name) {
            if (!allThemes) return;
            const theme = allThemes[name];
            if(!theme) return;
            
            applyThemeVariables(theme.vars);
            syncCustomInputs(theme.vars);
            currentThemeData = theme.vars;
            
            // Highlight selected
            document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
            // This is tricky because we regenerate list. But simple enough:
            // renderThemeList can check currentThemeData
        }

        function syncCustomInputs(vars) {
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                const disp = document.getElementById('val-' + id.split('-')[1]);
                if(el && val && val.startsWith('#')) {
                    el.value = val;
                    if(disp) disp.innerText = val;
                }
            };

            setVal('custom-primary', vars['--primary']);
            setVal('custom-secondary', vars['--secondary']);
            setVal('custom-bg', vars['--bg-deep']);
            setVal('custom-text-main', vars['--text-main']);
        }

        function updateCustomTheme() {
            const getVal = (id) => {
                const val = document.getElementById(id).value;
                document.getElementById('val-' + id.split('-')[1]).innerText = val;
                return val;
            };
            
            const bgDeep = getVal('custom-bg');
            const primary = getVal('custom-primary');
            const textMain = getVal('custom-text-main');
            const isLightBg = getContrastColor(bgDeep) === '#000000';

            const theme = {
                '--primary': primary,
                '--secondary': getVal('custom-secondary'),
                '--accent': primary, // Link accent to primary for simple custom
                '--bg-deep': bgDeep,
                '--text-main': textMain,
                '--text-dim': adjustColorOpacity(textMain, 0.6),
                
                // Defaults for custom
                '--bg-panel': isLightBg ? '#ffffff' : 'rgba(20, 25, 40, 0.65)',
                '--bg-header': isLightBg ? 'rgba(255, 255, 255, 0.9)' : 'rgba(11, 15, 25, 0.8)',
                '--bg-image': 'none',
                '--font-main': "'Inter', sans-serif",
                '--font-mono': "'JetBrains Mono', monospace",
                '--radius-lg': '8px',
                '--radius-md': '4px',
                '--radius-sm': '2px',
                '--shadow': isLightBg ? '0 4px 12px rgba(0,0,0,0.1)' : '0 8px 32px rgba(0, 0, 0, 0.4)',
                '--border': isLightBg ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)',
                '--input-bg': isLightBg ? 'rgba(0, 0, 0, 0.05)' : 'rgba(0, 0, 0, 0.3)',
                '--btn-bg': isLightBg ? 'rgba(0, 0, 0, 0.05)' : 'rgba(255, 255, 255, 0.05)',
                '--btn-hover-bg': isLightBg ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)'
            };
            
            applyThemeVariables(theme);
            currentThemeData = theme;
        }

        // Helper to adjust color (simplified)
        function adjustColorOpacity(hex, opacity, invert = false) {
            // Very basic implementation, just returns hex if complex
            return hex; 
        }

        // --- Random / Chaos Mode ---
        let isChaosMode = false;

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function randomizeCustomTheme() {
            const primary = getRandomColor();
            const secondary = getRandomColor();
            const bg = getRandomColor();
            // Ensure text contrasts with bg
            const isDark = getContrastColor(bg) === '#ffffff';
            const text = isDark ? '#f1f5f9' : '#1a1f2e'; // Simple default text based on bg

            document.getElementById('custom-primary').value = primary;
            document.getElementById('custom-secondary').value = secondary;
            document.getElementById('custom-bg').value = bg;
            document.getElementById('custom-text-main').value = text;
            
            // Trigger update
            updateCustomTheme();
        }

        function toggleChaosMode() {
            isChaosMode = !isChaosMode;
            const btn = document.getElementById('chaos-btn');
            if (isChaosMode) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary'); // Or some active style
                btn.innerText = 'ğŸ”¥ å…¨éšæœº (ON)';
                // Immediately randomize
                randomizeCustomTheme();
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                btn.innerText = 'ğŸ”¥ å…¨éšæœº';
            }
        }

        // --- Meltdown Mode (Component-level Randomization) ---
        let isMeltdownMode = false;

        function toggleMeltdownMode() {
            isMeltdownMode = !isMeltdownMode;
            const btn = document.getElementById('meltdown-btn');
            
            if (isMeltdownMode) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-danger'); // Use red for danger/meltdown
                btn.innerText = 'ğŸŒ€ å´©å (ON)';
                app.showToast('å´©åæ¨¡å¼å·²å¼€å¯ï¼šè­¦å‘Šï¼é«˜èƒ½ååº”ï¼', 'warning');
                applyMeltdownEffect();
            } else {
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-secondary');
                btn.innerText = 'ğŸŒ€ å´©å';
                removeMeltdownEffect();
            }
        }

        function applyMeltdownEffect() {
            if (!frame || !frame.contentWindow) return;
            
            const doc = frame.contentWindow.document;
            let styleEl = doc.getElementById('meltdown-style');
            
            if (!styleEl) {
                styleEl = doc.createElement('style');
                styleEl.id = 'meltdown-style';
                doc.head.appendChild(styleEl);
            }

            // Generate crazy CSS
            let css = '';
            const selectors = ['div', 'span', 'button', 'input', '.panel', '.btn', '.card', 'label', 'h1', 'h2', 'h3', 'h4'];
            const props = ['color', 'background-color', 'border-color'];
            
            // We use :nth-child to target elements pseudo-randomly without JS iteration
            // Generate 50 rules
            for (let i = 1; i <= 50; i++) {
                const color = getRandomColor();
                const bg = getRandomColor();
                const border = getRandomColor();
                
                // Randomly target children
                // e.g. *:nth-child(50n + 1)
                css += `*:nth-child(50n + ${i}) { 
                    --primary: ${color} !important; 
                    --secondary: ${bg} !important;
                    --bg-panel: ${bg}80 !important;
                    --text-main: ${getContrastColor(bg)} !important;
                    border-color: ${border} !important;
                }\n`;
                
                // Specific component overrides for maximum chaos
                css += `.btn:nth-child(20n + ${i}) { background-color: ${bg} !important; color: ${getContrastColor(bg)} !important; }\n`;
                css += `.panel:nth-child(10n + ${i}) { background-color: ${color}20 !important; }\n`;
            }

            styleEl.textContent = css;
        }

        function removeMeltdownEffect() {
            if (!frame || !frame.contentWindow) return;
            const styleEl = frame.contentWindow.document.getElementById('meltdown-style');
            if (styleEl) styleEl.remove();
        }

        function getContrastColor(hex) {
            if (!hex || !hex.startsWith('#')) return '#ffffff';
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        }

        function getThemeSignature(theme) {
            if (!theme) return '';
            const keys = Object.keys(theme).sort();
            let out = '';
            for (const key of keys) {
                out += key + ':' + String(theme[key]) + ';';
            }
            return out;
        }

        function applyThemeVariables(theme) {
            const root = document.documentElement;
            themeSignature = getThemeSignature(theme);
            
            // Calculate contrast colors
            if(theme['--primary']) {
                theme['--primary-contrast'] = getContrastColor(theme['--primary']);
            }
            // Auto-calculate text visibility for light/dark backgrounds if not explicitly set
            // (Optional, but good for custom themes)
            
            // Optimization: Request Animation Frame to batch reflows
            requestAnimationFrame(() => {
                for (const [key, value] of Object.entries(theme)) {
                    root.style.setProperty(key, value);
                }
                if(frame && frame.contentWindow) {
                    const frameRoot = frame.contentWindow.document.documentElement;
                    try {
                        for (const [key, value] of Object.entries(theme)) {
                            frameRoot.style.setProperty(key, value);
                        }
                        
                        // Propagate to nested iframes (Level 2)
                        // Try to find iframes inside the current frame
                        const nestedFrames = frame.contentWindow.document.querySelectorAll('iframe');
                        nestedFrames.forEach(nestedFrame => {
                            try {
                                const nestedRoot = nestedFrame.contentWindow.document.documentElement;
                                for (const [key, value] of Object.entries(theme)) {
                                    nestedRoot.style.setProperty(key, value);
                                }
                                
                                // Propagate to Level 3 (e.g. image-fun -> image-phantom)
                                const deepFrames = nestedFrame.contentWindow.document.querySelectorAll('iframe');
                                deepFrames.forEach(deepFrame => {
                                    try {
                                        const deepRoot = deepFrame.contentWindow.document.documentElement;
                                        for (const [key, value] of Object.entries(theme)) {
                                            deepRoot.style.setProperty(key, value);
                                        }
                                    } catch(e) {}
                                });
                            } catch(e) {}
                        });
                        
                    } catch(e) {}
                }
            });
        }

        // Initialize with Aurora but don't persist
        // Pre-fill inputs with default aurora values
        if (currentThemeData) {
            syncCustomInputs(currentThemeData);
        }
        
        // Also listen for iframe load to re-apply theme
        // (Handled above in frame.load)
        // frame.addEventListener('load', () => {
        //      if(currentThemeData) {
        //          applyThemeVariables(currentThemeData);
        //      }
        // });

        // Mobile Menu Logic
        const mobileDrawer = document.getElementById('mobile-drawer');
        const mobileOverlay = document.getElementById('mobile-overlay');
        let isMobileMenuOpen = false;

        function toggleMobileMenu() {
            isMobileMenuOpen = !isMobileMenuOpen;
            if (isMobileMenuOpen) {
                mobileDrawer.style.left = '0';
                mobileOverlay.style.display = 'block';
                // Lazy init
                if (mobileDrawer.children.length === 0 || mobileDrawer.innerHTML.trim() === '<!-- Content will be injected by JS or cloned -->') {
                    initMobileMenu();
                }
            } else {
                mobileDrawer.style.left = '-100%';
                mobileOverlay.style.display = 'none';
            }
        }

        function bindShellEvents() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            const logoHome = document.getElementById('logo-home');
            if (logoHome) logoHome.addEventListener('click', switchToHome);
            const backHome = document.getElementById('back-home-btn');
            if (backHome) backHome.addEventListener('click', () => {
                window.location.href = window.location.origin;
            });
            const offlineBtn = document.getElementById('offline-btn');
            if (offlineBtn) offlineBtn.addEventListener('click', toggleOfflineModal);
            const themeBtn = document.getElementById('theme-btn');
            if (themeBtn) themeBtn.addEventListener('click', toggleThemeModal);
            const themeClose = document.getElementById('theme-modal-close');
            if (themeClose) themeClose.addEventListener('click', toggleThemeModal);
            const offlineClose = document.getElementById('offline-modal-close');
            if (offlineClose) offlineClose.addEventListener('click', toggleOfflineModal);
            if (mobileOverlay) mobileOverlay.addEventListener('click', toggleMobileMenu);
            const randomizeBtn = document.getElementById('randomize-btn');
            if (randomizeBtn) randomizeBtn.addEventListener('click', randomizeCustomTheme);
            const chaosBtn = document.getElementById('chaos-btn');
            if (chaosBtn) chaosBtn.addEventListener('click', toggleChaosMode);
            const meltdownBtn = document.getElementById('meltdown-btn');
            if (meltdownBtn) meltdownBtn.addEventListener('click', toggleMeltdownMode);
            const offlineSelectAll = document.getElementById('offline-select-all');
            if (offlineSelectAll) offlineSelectAll.addEventListener('click', () => setAllOfflineCheckboxes(true));
            const offlineClear = document.getElementById('offline-clear');
            if (offlineClear) offlineClear.addEventListener('click', () => setAllOfflineCheckboxes(false));
            const offlineApply = document.getElementById('offline-apply');
            if (offlineApply) offlineApply.addEventListener('click', () => {
                const status = document.getElementById('offline-status');
                if (status) status.innerText = 'æ­£åœ¨åº”ç”¨é€‰æ‹©å¹¶ç¼“å­˜...';
                if (window.app && app.showToast) app.showToast('å·²å¼€å§‹ç¼“å­˜é€‰ä¸­å·¥å…·ä¸ä¾èµ–');
                console.log('[Offline] apply click');
                applyOfflinePrefs();
            });
            const offlineClearSite = document.getElementById('offline-clear-site');
            if (offlineClearSite) offlineClearSite.addEventListener('click', clearSiteData);
            ['custom-primary', 'custom-secondary', 'custom-bg', 'custom-text-main'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateCustomTheme);
            });
        }

        function initMobileMenu() {
            mobileDrawer.innerHTML = ''; // Clear placeholder
            
            // Clone Back/Home Button (The one with â†©â¤â†©)
            const backBtn = document.querySelector('#main-nav > .btn');
            if(backBtn) {
                const backClone = backBtn.cloneNode(true);
                // Ensure it looks good in drawer (full width)
                backClone.style.width = '100%';
                backClone.style.marginBottom = '10px';
                mobileDrawer.appendChild(backClone);
            }
            
            // Clone Home Button
            const homeBtn = document.querySelector('.tab-btn[data-src="tools/home.html"]').cloneNode(true);
            attachMobileClick(homeBtn);
            mobileDrawer.appendChild(homeBtn);

            // Clone Dropdowns as Groups
            document.querySelectorAll('.dropdown').forEach(dd => {
                const title = dd.querySelector('.dropdown-toggle').innerText;
                const groupTitle = document.createElement('div');
                groupTitle.className = 'group-title';
                groupTitle.innerText = title;
                // Inline styles for group title
                groupTitle.style.marginTop = '15px';
                groupTitle.style.marginBottom = '8px';
                groupTitle.style.color = 'var(--primary)';
                groupTitle.style.fontWeight = 'bold';
                groupTitle.style.fontSize = '1.1rem';
                mobileDrawer.appendChild(groupTitle);

                const content = dd.querySelector('.dropdown-content');
                if (content) {
                    Array.from(content.children).forEach(child => {
                        if (child.classList.contains('tab-btn')) {
                            const clone = child.cloneNode(true);
                            clone.style.width = '100%'; // Ensure full width
                            clone.style.justifyContent = 'flex-start';
                            clone.style.padding = '10px';
                            attachMobileClick(clone);
                            mobileDrawer.appendChild(clone);
                        } else if (child.classList.contains('dropdown-header')) {
                            const header = document.createElement('div');
                            header.style.padding = '12px 0 4px 5px';
                            header.style.fontSize = '0.8rem';
                            header.style.color = 'var(--text-dim)';
                            header.style.fontWeight = '600';
                            header.style.textTransform = 'uppercase';
                            header.style.letterSpacing = '1px';
                            header.innerText = child.innerText;
                            mobileDrawer.appendChild(header);
                        }
                        // We skip dividers in mobile view to save space or just let headers act as dividers
                    });
                }
            });
        }

        function attachMobileClick(btn) {
            btn.addEventListener('click', () => {
                const target = btn.dataset.src;
                if(target) {
                    frame.src = target;
                    // Update active state in both navs
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    // Find original and add active
                    const orig = document.querySelector(`.tab-btn[data-src="${target}"]`);
                    if(orig) orig.classList.add('active');
                    // Add active to this mobile btn (and siblings in drawer)
                    // Actually, re-rendering drawer might be overkill, just setting active class is fine
                    // Since we clone, the mobile btn is new. 
                    // Let's just manually set active on all matching data-src
                    document.querySelectorAll(`.tab-btn[data-src="${target}"]`).forEach(b => b.classList.add('active'));
                    
                    toggleMobileMenu(); // Close menu
                }
            });
        }

        bindShellEvents();

    </script>
</body>
</html>
