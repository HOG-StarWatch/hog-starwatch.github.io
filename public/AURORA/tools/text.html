<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æœ¬å¤„ç†</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body style="padding: 1rem;">
    <div class="sub-tab-group">
        <div class="sub-tab active" onclick="textTool.switchTab('basic', this)">åŸºç¡€å¤„ç†</div>
        <div class="sub-tab" onclick="textTool.switchTab('regex', this)">æ­£åˆ™å·¥å…·</div>
    </div>

    <div class="workspace">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">è¾“å…¥</div>
                <div class="panel-actions">
                    <button class="btn btn-icon" onclick="app.clear('text'); textTool.updateStats();">æ¸…ç©º</button>
                </div>
            </div>
            <textarea id="text-input" placeholder="åœ¨æ­¤è¾“å…¥æ–‡æœ¬..."></textarea>
            <div class="stats-row">
                <span>å­—ç¬¦: <b id="stat-total">0</b></span>
                <span>éç©º: <b id="stat-nospace">0</b></span>
                <span>å•è¯: <b id="stat-words">0</b></span>
                <span>æ±‰å­—: <b id="stat-cn">0</b></span>
                <span>æ•°å­—: <b id="stat-num">0</b></span>
                <span>æ ‡ç‚¹: <b id="stat-punct">0</b></span>
                <span>è¡Œæ•°: <b id="stat-lines">0</b></span>
            </div>
        </div>

        <div id="tool-basic" class="toolbar">
            <div class="tool-group">
                <div class="group-label">åŸºç¡€</div>
                <button class="btn" onclick="textTool.process('upper')">å…¨å¤§å†™ <span>AA</span></button>
                <button class="btn" onclick="textTool.process('lower')">å…¨å°å†™ <span>aa</span></button>
                <button class="btn" onclick="textTool.process('title')">é¦–å­—æ¯å¤§å†™ <span>Aa</span></button>
            </div>
            <div class="tool-group">
                <div class="group-label">æ ¼å¼</div>
                <button class="btn" onclick="textTool.process('trim')">å»é¦–å°¾ç©º <span>|__|</span></button>
                <button class="btn" onclick="textTool.process('nospace')">å»æ‰€æœ‰ç©ºæ ¼ <span>><</span></button>
                <button class="btn" onclick="textTool.process('oneline')">åˆå¹¶ä¸ºä¸€è¡Œ <span>â€”</span></button>
            </div>
            <div class="tool-group">
                <div class="group-label">é«˜çº§</div>
                <button class="btn" onclick="textTool.process('snake')">Snake Case <span>a_b</span></button>
                <button class="btn" onclick="textTool.process('camel')">Camel Case <span>aB</span></button>
                <button class="btn" onclick="textTool.process('dedupe')">å»é‡è¡Œ <span>1,1â†’1</span></button>
                <button class="btn" onclick="textTool.process('sort')">A-Z æ’åº <span>â†“</span></button>
            </div>
            <div class="tool-group">
                <div class="group-label">ä¸­æ–‡</div>
                <button class="btn" onclick="textTool.process('sc2tc')">è½¬ç¹ä½“ <span>æ±‰â†’æ¼¢</span></button>
                <button class="btn" onclick="textTool.process('tc2sc')">è½¬ç®€ä½“ <span>æ¼¢â†’æ±‰</span></button>
            </div>
        </div>

        <div id="tool-regex" class="panel" style="display:none; padding: 1rem; gap: 1rem; background: rgba(255,255,255,0.03);">
             <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="text" id="regex-pattern" placeholder="æ­£åˆ™è¡¨è¾¾å¼ (ä¾‹å¦‚: \d+)" style="flex:1;">
                <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: var(--text-dim);">
                    <label><input type="checkbox" id="flag-g" checked> g</label>
                    <label><input type="checkbox" id="flag-i"> i</label>
                    <label><input type="checkbox" id="flag-m"> m</label>
                    <label><input type="checkbox" id="flag-s"> s</label>
                </div>
             </div>
             
             <!-- Regex Cheatsheet -->
             <div class="regex-cheatsheet" style="display:flex; flex-wrap:wrap; gap:5px; font-size:0.75rem; color:var(--text-dim);">
                <span class="cheat-item" onclick="textTool.insertRegex('\\d+')">\d+ æ•°å­—</span>
                <span class="cheat-item" onclick="textTool.insertRegex('\\w+')">\w+ å•è¯</span>
                <span class="cheat-item" onclick="textTool.insertRegex('[\\u4e00-\\u9fa5]+')">[\u4e00-\u9fa5] ä¸­æ–‡</span>
                <span class="cheat-item" onclick="textTool.insertRegex('^')">^ å¼€å¤´</span>
                <span class="cheat-item" onclick="textTool.insertRegex('$')">$ ç»“å°¾</span>
                <span class="cheat-item" onclick="textTool.insertRegex('(.*?)')">(.*?) åˆ†ç»„</span>
             </div>

             <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="regex-replace" placeholder="æ›¿æ¢æ–‡æœ¬ (æ”¯æŒ $1, $2...)" style="flex:1;">
             </div>
             <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" style="flex:1;" onclick="textTool.runRegex('match')">æå–åŒ¹é… (é«˜äº®)</button>
                <button class="btn btn-primary" style="flex:1;" onclick="textTool.runRegex('replace')">æ›¿æ¢æ–‡æœ¬</button>
             </div>
             
             <!-- Highlight Output -->
             <div id="regex-highlight" style="display:none; min-height:100px; max-height:200px; overflow-y:auto; padding:10px; border:1px solid var(--border); border-radius:4px; background:rgba(0,0,0,0.2); white-space:pre-wrap; word-break:break-all; color:var(--text-dim);"></div>
             
             <!-- Regex Guide -->
             <div style="border-top: 1px dashed rgba(255,255,255,0.1); margin-top: 10px; padding-top: 10px;">
                <button class="btn btn-secondary" style="width:100%; text-align:left; justify-content:space-between;" onclick="document.getElementById('regex-guide').style.display = document.getElementById('regex-guide').style.display === 'none' ? 'block' : 'none'">
                    ğŸ“– ä½¿ç”¨æŒ‡å— (Help) <span>â–¼</span>
                </button>
                <div id="regex-guide" style="display:none; margin-top:10px; font-size:0.85rem; color:var(--text-dim); background:rgba(0,0,0,0.2); padding:15px; border-radius:8px;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <h4 style="color:var(--primary); margin:0 0 8px 0;">ä¿®é¥°ç¬¦ (Flags)</h4>
                            <ul style="list-style:none; padding:0; margin:0; line-height:1.6;">
                                <li><code style="color:var(--secondary)">g</code> - å…¨å±€æœç´¢ (Global)</li>
                                <li><code style="color:var(--secondary)">i</code> - å¿½ç•¥å¤§å°å†™ (Insensitive)</li>
                                <li><code style="color:var(--secondary)">m</code> - å¤šè¡Œæ¨¡å¼ (Multi-line)</li>
                                <li><code style="color:var(--secondary)">s</code> - ç‚¹å·åŒ¹é…æ¢è¡Œ (Single-line)</li>
                            </ul>
                        </div>
                        <div>
                            <h4 style="color:var(--primary); margin:0 0 8px 0;">å¸¸ç”¨åŒ¹é… (Patterns)</h4>
                            <ul style="list-style:none; padding:0; margin:0; line-height:1.6;">
                                <li><code style="color:var(--accent)">.</code> - ä»»æ„å­—ç¬¦ (é™¤æ¢è¡Œ)</li>
                                <li><code style="color:var(--accent)">\d</code> - æ•°å­— [0-9]</li>
                                <li><code style="color:var(--accent)">\w</code> - å­—æ¯/æ•°å­—/ä¸‹åˆ’çº¿</li>
                                <li><code style="color:var(--accent)">\s</code> - ç©ºç™½ç¬¦ (ç©ºæ ¼/Tab/æ¢è¡Œ)</li>
                                <li><code style="color:var(--accent)">^ / $</code> - å¼€å¤´ / ç»“å°¾</li>
                                <li><code style="color:var(--accent)">* / +</code> - 0æ¬¡ä»¥ä¸Š / 1æ¬¡ä»¥ä¸Š</li>
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.05);">
                        <div style="margin-bottom:5px;"><strong>ğŸ’¡ ç¤ºä¾‹ï¼š</strong></div>
                        <div>æå–ä¸­æ–‡: <code style="background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:3px;">[\u4e00-\u9fa5]+</code></div>
                        <div>æå–é‚®ç®±: <code style="background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:3px;">\w+@\w+\.\w+</code></div>
                        <div>æ›¿æ¢åˆ†ç»„: æŸ¥æ‰¾ <code style="color:var(--accent)">(\d{4})-(\d{2})</code> æ›¿æ¢ä¸º <code style="color:var(--success)">$1å¹´$2æœˆ</code></div>
                    </div>
                </div>
             </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">ç»“æœ <span class="stat-badge" id="text-out-stat">0 å­—ç¬¦</span></div>
                <div class="panel-actions">
                    <button class="btn btn-icon btn-secondary" onclick="app.copy('text-output')">å¤åˆ¶</button>
                </div>
            </div>
            <textarea id="text-output" readonly placeholder="å¤„ç†ç»“æœ..."></textarea>
        </div>
    </div>

    <div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>
    <script src="../js/app.js"></script>
    <script src="../js/loader.js"></script>
    <script>
        const textTool = {
            hasCheckedGuide: false,
            switchTab: function(tab, el) {
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                
                if(tab === 'basic') {
                    document.getElementById('tool-basic').style.display = 'flex';
                    document.getElementById('tool-regex').style.display = 'none';
                } else {
                    document.getElementById('tool-basic').style.display = 'none';
                    document.getElementById('tool-regex').style.display = 'flex';
                    document.getElementById('tool-regex').style.flexDirection = 'column';

                    // Adaptive Guide: Open if window is tall enough
                    if (!this.hasCheckedGuide) {
                        if (window.innerHeight > 800) {
                            document.getElementById('regex-guide').style.display = 'block';
                        }
                        this.hasCheckedGuide = true;
                    }
                }
            },

            updateStats: function() {
                const val = document.getElementById('text-input').value;
                document.getElementById('stat-total').innerText = val.length;
                document.getElementById('stat-nospace').innerText = val.replace(/\s/g, '').length;
                document.getElementById('stat-words').innerText = (val.match(/[a-zA-Z]+/g) || []).length;
                document.getElementById('stat-cn').innerText = (val.match(/[\u4e00-\u9fa5]/g) || []).length;
                document.getElementById('stat-num').innerText = (val.match(/[0-9]/g) || []).length;
                // Punctuation: non-word, non-space, non-cn
                document.getElementById('stat-punct').innerText = (val.match(/[^\w\s\u4e00-\u9fa5]/g) || []).length;
                document.getElementById('stat-lines').innerText = val ? val.split(/\r\n|\r|\n/).length : 0;
            },

            runRegex: function(action) {
                const input = document.getElementById('text-input').value;
                const pattern = document.getElementById('regex-pattern').value;
                if(!pattern) {
                    app.showToast('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼', 'error');
                    return;
                }

                let flags = '';
                if(document.getElementById('flag-g').checked) flags += 'g';
                if(document.getElementById('flag-i').checked) flags += 'i';
                if(document.getElementById('flag-m').checked) flags += 'm';
                if(document.getElementById('flag-s').checked) flags += 's';

                try {
                    const regex = new RegExp(pattern, flags);
                    let res = '';

                    if(action === 'match') {
                        const hlDiv = document.getElementById('regex-highlight');
                        hlDiv.style.display = 'block';
                        
                        // Real-time highlight logic
                        // We construct HTML by replacing matches with <span class="match-highlight">...</span>
                        // Need to be careful with HTML escaping
                        const escapeHtml = (text) => text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                        
                        // If global flag is set, we can replace all. If not, only first.
                        // However, string.replace with string preserves text, but we want to wrap it.
                        // Using replace with callback
                        
                        // First escape original input to prevent XSS/broken HTML
                        // But wait, if we escape first, indices change.
                        // Better approach: Split string by regex, then rejoin with spans?
                        // Or use replace on the original string, but we must ensure we don't double escape.
                        
                        // Safest: Iterate matches and build string segments.
                        let lastIdx = 0;
                        let html = '';
                        let match;
                        
                        // Clone regex for exec loop if global
                        const iterRegex = new RegExp(pattern, flags + (flags.includes('g') ? '' : 'g')); 
                        // Note: if user didn't select 'g', we usually only match once.
                        
                        if(!flags.includes('g')) {
                            match = regex.exec(input);
                            if(match) {
                                html += escapeHtml(input.substring(0, match.index));
                                html += `<span class="match-highlight">${escapeHtml(match[0])}</span>`;
                                html += escapeHtml(input.substring(match.index + match[0].length));
                                app.showToast(`æ‰¾åˆ° 1 ä¸ªåŒ¹é…`);
                            } else {
                                html = escapeHtml(input);
                                app.showToast('æ— åŒ¹é…');
                            }
                        } else {
                            let count = 0;
                            while ((match = iterRegex.exec(input)) !== null) {
                                html += escapeHtml(input.substring(lastIdx, match.index));
                                html += `<span class="match-highlight">${escapeHtml(match[0])}</span>`;
                                lastIdx = iterRegex.lastIndex;
                                count++;
                                if(match[0].length === 0) iterRegex.lastIndex++; // Avoid infinite loop on zero-width matches
                            }
                            html += escapeHtml(input.substring(lastIdx));
                            app.showToast(`æ‰¾åˆ° ${count} ä¸ªåŒ¹é…`);
                        }
                        
                        hlDiv.innerHTML = html;
                        
                        // Also fill standard output for copy
                        const matches = input.match(regex);
                        res = matches ? matches.join('\n') : '(æ— åŒ¹é…)';

                    } else {
                        const replaceStr = document.getElementById('regex-replace').value;
                        res = input.replace(regex, replaceStr);
                        app.showToast('æ›¿æ¢å®Œæˆ');
                        document.getElementById('regex-highlight').style.display = 'none';
                    }

                    document.getElementById('text-output').value = res;
                    document.getElementById('text-out-stat').innerText = `${res.length} å­—ç¬¦`;

                } catch(e) {
                    app.showToast('æ­£åˆ™è¯­æ³•é”™è¯¯: ' + e.message, 'error');
                }
            },
            
            insertRegex: function(str) {
                const input = document.getElementById('regex-pattern');
                input.value += str;
                input.focus();
            },

            process: function(action) {
                const input = document.getElementById('text-input').value;
                let res = input;

                switch(action) {
                    case 'upper': res = input.toUpperCase(); break;
                    case 'lower': res = input.toLowerCase(); break;
                    case 'title': res = input.replace(/\b\w/g, c => c.toUpperCase()); break;
                    case 'trim': res = input.trim(); break;
                    case 'nospace': res = input.replace(/\s+/g, ''); break;
                    case 'oneline': res = input.replace(/[\r\n]+/g, ' '); break;
                    case 'snake': 
                        res = input.replace(/([A-Z])/g, "_$1").toLowerCase().replace(/^_/, '').replace(/\s+/g, '_');
                        break;
                    case 'camel':
                        res = input.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g, (m, chr) => chr.toUpperCase());
                        break;
                    case 'dedupe':
                        res = [...new Set(input.split('\n'))].join('\n');
                        break;
                    case 'sort':
                        res = input.split('\n').sort().join('\n');
                        break;
                    case 'sc2tc':
                        app.showToast('æ­£åœ¨åŠ è½½ç»„ä»¶...', 'info');
                        ResourceLoader.load('opencc-js').then(() => {
                            const sc2tc = OpenCC.Converter({ from: 'cn', to: 'tw' });
                            const res = sc2tc(input);
                            document.getElementById('text-output').value = res;
                            document.getElementById('text-out-stat').innerText = `${res.length} å­—ç¬¦`;
                            app.showToast('è½¬æ¢å®Œæˆ');
                        });
                        return;
                    case 'tc2sc':
                        app.showToast('æ­£åœ¨åŠ è½½ç»„ä»¶...', 'info');
                        ResourceLoader.load('opencc-js').then(() => {
                            const tc2sc = OpenCC.Converter({ from: 'tw', to: 'cn' });
                            const res = tc2sc(input);
                            document.getElementById('text-output').value = res;
                            document.getElementById('text-out-stat').innerText = `${res.length} å­—ç¬¦`;
                            app.showToast('è½¬æ¢å®Œæˆ');
                        });
                        return;
                }

                document.getElementById('text-output').value = res;
                document.getElementById('text-out-stat').innerText = `${res.length} å­—ç¬¦`;
            }
        };

        const txtInput = document.getElementById('text-input');
        if(txtInput) {
            txtInput.addEventListener('input', (e) => {
                textTool.updateStats();
            });
        }
    </script>
</body>
</html>