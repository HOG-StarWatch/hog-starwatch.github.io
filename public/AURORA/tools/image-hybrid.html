<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†è§‰æ··åˆå›¾ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background: transparent;
            padding: 20px;
            overflow-y: auto;
            display: block;
            height: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            backdrop-filter: blur(10px);
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(192, 132, 252, 0.05);
        }
        .upload-zone img {
            max-width: 100%;
            max-height: 120px;
            border-radius: 4px;
            display: none;
            object-fit: contain;
        }
        .upload-placeholder {
            color: var(--text-dim);
            font-size: 0.9rem;
        }
        .zone-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            display: block;
            font-size: 0.95rem;
        }

        .control-group {
            margin-bottom: 5px;
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: var(--text-main);
            font-size: 0.9rem;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        .btn {
            padding: 10px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; 
            width: 100%; 
        }
        .btn-primary:hover { 
            box-shadow: 0 4px 15px rgba(192, 132, 252, 0.4); 
        }
        .btn-success { 
            background: linear-gradient(135deg, var(--secondary), #22c55e);
            color: var(--bg-deep);
            width: 100%;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .preview-area {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .canvas-container {
            width: 100%;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #eee;
            border-radius: var(--radius-md);
            overflow: hidden;
            min-height: 400px;
            margin-bottom: 20px;
            position: relative;
            border: 1px solid var(--border);
        }

        canvas {
            max-width: 100%;
            max-height: 600px;
            object-fit: contain;
            transition: width 0.3s; 
        }

        .view-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .view-btn {
            padding: 5px 15px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            color: var(--text-dim);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .view-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .select-control {
            width: 100%;
            padding: 8px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-deep);
            color: var(--text-main);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .checkbox-label {
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            color: var(--text-main);
            font-size: 0.9rem;
        }
        .checkbox-label input { margin-right: 8px; }

        @media (max-width: 800px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Control Panel -->
        <div class="panel">
            <h2 style="margin:0; color:var(--primary); font-size:1.5rem;">è§†è§‰æ··åˆå›¾ç”Ÿæˆå™¨</h2>
            <p style="margin:0; color:var(--text-dim); font-size:0.9rem;">è¿‘çœ‹æ˜¯Aå›¾(ç»†èŠ‚)ï¼Œè¿œçœ‹æ˜¯Bå›¾(æ¨¡ç³Š)ã€‚</p>

            <div style="margin-top:10px;">
                <span class="zone-label">1. è¿‘çœ‹å›¾ (ç»†èŠ‚/High Freq)</span>
                <input type="file" id="input-near" accept="image/*" style="display: none;">
                <div class="upload-zone" onclick="document.getElementById('input-near').click()">
                    <p class="upload-placeholder" id="ph-near">ä¸Šä¼ è¿‘çœ‹å›¾</p>
                    <img id="img-near">
                </div>
                <div class="control-group" style="margin-top: 10px;">
                    <label>ä¿ç•™ç»†èŠ‚é‡ (High Pass): <span id="val-hp">15</span></label>
                    <input type="range" id="range-hp" min="1" max="50" value="15">
                </div>
            </div>

            <div>
                <span class="zone-label">2. è¿œçœ‹å›¾ (è½®å»“/Low Freq)</span>
                <input type="file" id="input-far" accept="image/*" style="display: none;">
                <div class="upload-zone" onclick="document.getElementById('input-far').click()">
                    <p class="upload-placeholder" id="ph-far">ä¸Šä¼ è¿œçœ‹å›¾</p>
                    <img id="img-far">
                </div>
                <div class="control-group" style="margin-top: 10px;">
                    <label>æ¨¡ç³Šç¨‹åº¦ (Low Pass): <span id="val-lp">10</span></label>
                    <input type="range" id="range-lp" min="1" max="50" value="10">
                </div>

                <!-- è¿œçœ‹å›¾å¯¹é½æ§åˆ¶ -->
                <div class="control-group" style="margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px;">
                    <label>è¿œçœ‹å›¾å¯¹é½ (Alignment)</label>
                    <select id="sel-fit-mode" class="select-control">
                        <option value="cover">å±…ä¸­è£å‰ª (Cover) - é»˜è®¤</option>
                        <option value="contain">å®Œæ•´æ˜¾ç¤º (Contain)</option>
                        <option value="stretch">å¼ºåˆ¶æ‹‰ä¼¸ (Stretch)</option>
                    </select>
                    
                    <div id="group-manual-adjust">
                        <label>ç¼©æ”¾ (Scale): <span id="val-scale">1.0</span></label>
                        <input type="range" id="range-scale" min="0.1" max="3.0" step="0.05" value="1.0">
                        
                        <label style="margin-top:5px;">å‚ç›´åç§» (Offset Y): <span id="val-offset-y">0%</span></label>
                        <input type="range" id="range-offset-y" min="-100" max="100" step="1" value="0">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label>
                    <span>æ··åˆå¹³è¡¡ (0=è¿œ, 1=è¿‘)</span>
                    <span id="val-bal">0.5</span>
                </label>
                <input type="range" id="range-bal" min="0" max="1" step="0.1" value="0.5">
            </div>
            
            <div class="control-group">
                <label>å›¾åƒé¢„å¤„ç†</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="chk-gray" checked> è½¬é»‘ç™½
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="chk-edge"> è¾¹ç¼˜æå–
                    </label>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-area">
            <div class="view-controls">
                <button class="view-btn active" onclick="setViewSize(1)">100% (è¿‘çœ‹)</button>
                <button class="view-btn" onclick="setViewSize(0.25)">25% (æ¨¡æ‹Ÿè¿œçœ‹)</button>
                <button class="view-btn" onclick="setViewSize(0.1)">10% (å¾ˆè¿œ)</button>
            </div>

            <div class="canvas-container">
                <canvas id="result-cvs"></canvas>
            </div>

            <a id="btn-download" class="btn btn-success" style="display: none;">ğŸ’¾ ä¿å­˜å›¾ç‰‡ (PNG)</a>
        </div>
    </div>

    <script>
        const cvs = document.getElementById('result-cvs');
        const ctx = cvs.getContext('2d');
        let imgNear = null, imgFar = null;

        // UI
        const rangeHP = document.getElementById('range-hp');
        const rangeLP = document.getElementById('range-lp');
        const rangeBal = document.getElementById('range-bal');
        
        // Alignment UI
        const selFitMode = document.getElementById('sel-fit-mode');
        const rangeScale = document.getElementById('range-scale');
        const rangeOffsetY = document.getElementById('range-offset-y');
        
        // Filters UI
        const chkGray = document.getElementById('chk-gray');
        const chkEdge = document.getElementById('chk-edge');

        rangeHP.oninput = () => document.getElementById('val-hp').innerText = rangeHP.value;
        rangeLP.oninput = () => document.getElementById('val-lp').innerText = rangeLP.value;
        rangeBal.oninput = () => document.getElementById('val-bal').innerText = rangeBal.value;
        rangeScale.oninput = () => document.getElementById('val-scale').innerText = rangeScale.value;
        rangeOffsetY.oninput = () => document.getElementById('val-offset-y').innerText = rangeOffsetY.value + '%';

        selFitMode.onchange = () => {
            document.getElementById('group-manual-adjust').style.display = (selFitMode.value === 'cover') ? 'block' : 'none';
        };

        // View Controls
        window.setViewSize = (scale) => {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if(cvs.width > 0) {
                // Reset style
                cvs.style.width = '';
                cvs.style.height = '';
                
                if (scale < 1) {
                    cvs.style.width = (cvs.width * scale) + 'px';
                }
            }
        };

        function handleFile(input, imgId, phId, isNear) {
            input.onchange = (e) => {
                if (!e.target.files[0]) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        document.getElementById(imgId).src = img.src;
                        document.getElementById(imgId).style.display = 'block';
                        document.getElementById(phId).style.display = 'none';
                        if(isNear) imgNear = img; else imgFar = img;
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            };
        }

        handleFile(document.getElementById('input-near'), 'img-near', 'ph-near', true);
        handleFile(document.getElementById('input-far'), 'img-far', 'ph-far', false);

        document.getElementById('btn-generate').onclick = async () => {
            if (!imgNear || !imgFar) return alert('è¯·å…ˆä¸Šä¼ ä¸¤å¼ å›¾ç‰‡ï¼');

            const btn = document.getElementById('btn-generate');
            btn.disabled = true;
            btn.innerText = 'ç”Ÿæˆä¸­...';
            
            await new Promise(r => setTimeout(r, 50));
            
            // 1. Setup Dimensions (Use Near Image as base)
            const w = imgNear.width;
            const h = imgNear.height;
            cvs.width = w;
            cvs.height = h;

            // 2. Prepare Layers
            const cNear = document.createElement('canvas'); cNear.width = w; cNear.height = h;
            const ctxNear = cNear.getContext('2d');
            
            const cFar = document.createElement('canvas'); cFar.width = w; cFar.height = h;
            const ctxFar = cFar.getContext('2d');
            
            // Draw & Resize Far image to match Near image (Crop to Cover)
            drawSmart(ctxFar, imgFar, w, h);
            
            // Draw Near Image
            ctxNear.drawImage(imgNear, 0, 0, w, h);

            if (chkEdge.checked) {
                 const cEdge = document.createElement('canvas'); cEdge.width = w; cEdge.height = h;
                 const ctxEdge = cEdge.getContext('2d');
                 ctxEdge.filter = 'blur(2px) grayscale(100%)';
                 ctxEdge.drawImage(cNear, 0, 0);
                 const idEdgeBlur = ctxEdge.getImageData(0,0,w,h);
                 const idEdgeOrig = ctxNear.getImageData(0,0,w,h);
                 const idNew = ctxNear.createImageData(w,h);
                 for(let i=0; i<idNew.data.length; i+=4) {
                     const r = idEdgeOrig.data[i];
                     const g = idEdgeOrig.data[i+1];
                     const b = idEdgeOrig.data[i+2];
                     const gray = 0.299*r + 0.587*g + 0.114*b;
                     
                     const rB = idEdgeBlur.data[i];
                     const gB = idEdgeBlur.data[i+1];
                     const bB = idEdgeBlur.data[i+2];
                     const grayB = 0.299*rB + 0.587*gB + 0.114*bB;
                     
                     const edgeVal = Math.abs(gray - grayB) * 4.0;
                     idNew.data[i] = edgeVal;
                     idNew.data[i+1] = edgeVal;
                     idNew.data[i+2] = edgeVal;
                     idNew.data[i+3] = 255;
                 }
                 ctxNear.putImageData(idNew, 0, 0);
            }
            
            // 3. Generate Low Frequency (Blur Far Image)
            const lpRadius = parseInt(rangeLP.value);
            const cFarBlur = document.createElement('canvas'); cFarBlur.width = w; cFarBlur.height = h;
            const ctxFarBlur = cFarBlur.getContext('2d');
            ctxFarBlur.filter = `blur(${lpRadius}px)`;
            ctxFarBlur.drawImage(cFar, 0, 0);
            ctxFarBlur.filter = 'none';
            
            // 4. Generate High Frequency (Near - Blur(Near))
            const hpRadius = parseInt(rangeHP.value);
            const cNearBlur = document.createElement('canvas'); cNearBlur.width = w; cNearBlur.height = h;
            const ctxNearBlur = cNearBlur.getContext('2d');
            ctxNearBlur.filter = `blur(${hpRadius}px)`;
            ctxNearBlur.drawImage(cNear, 0, 0);
            
            const idNear = ctxNear.getImageData(0, 0, w, h);
            const idNearBlur = ctxNearBlur.getImageData(0, 0, w, h);
            const idFarBlur = ctxFarBlur.getImageData(0, 0, w, h);
            const dN = idNear.data;
            const dNB = idNearBlur.data;
            const dFB = idFarBlur.data;
            
            const balance = parseFloat(rangeBal.value);
            const isGray = chkGray.checked;

            if (hybridWorker) {
                hybridWorker.postMessage({
                    type: 'process',
                    dN: dN,
                    dNB: dNB,
                    dFB: dFB,
                    config: {
                        rangeBalValue: balance,
                        isGray: isGray
                    }
                });
            } else {
                const output = ctx.createImageData(w, h);
                const dOut = output.data;

                for (let i = 0; i < dN.length; i += 4) {
                    if (isGray) {
                         const lN = 0.299*dN[i] + 0.587*dN[i+1] + 0.114*dN[i+2];
                         const lNB = 0.299*dNB[i] + 0.587*dNB[i+1] + 0.114*dNB[i+2];
                         const lFB = 0.299*dFB[i] + 0.587*dFB[i+1] + 0.114*dFB[i+2];
                         
                         const highFreq = lN - lNB;
                         const lowFreq = lFB;
                         
                         const hStrength = rangeBal.value * 3.0; 
                         let val = lowFreq + highFreq * hStrength;
                         val = Math.min(255, Math.max(0, val));
                         
                         dOut[i] = val;
                         dOut[i+1] = val;
                         dOut[i+2] = val;
                         dOut[i+3] = 255; // Alpha
                    } else {
                        for (let c = 0; c < 3; c++) {
                            const highFreq = dN[i+c] - dNB[i+c];
                            const lowFreq = dFB[i+c];
                            
                            const hStrength = rangeBal.value * 3.0; 
                            let val = lowFreq + highFreq * hStrength;
                            
                            dOut[i+c] = Math.min(255, Math.max(0, val));
                        }
                         dOut[i+3] = 255;
                    }
                }
                
                ctx.putImageData(output, 0, 0);
                
                const dl = document.getElementById('btn-download');
                dl.style.display = 'inline-flex';
                dl.href = cvs.toDataURL('image/png');
                dl.download = `hybrid_${Date.now()}.png`;
                
                const btn = document.getElementById('btn-generate');
                btn.disabled = false;
                btn.innerText = 'âš¡ ç”Ÿæˆæ··åˆå›¾';
            }
        };
        
        function drawSmart(ctx, img, w, h) {
            const mode = selFitMode.value;
            
            if (mode === 'stretch') {
                ctx.drawImage(img, 0, 0, w, h);
                return;
            }
            
            const ratioDst = w / h;
            const ratioSrc = img.width / img.height;
            let sx=0, sy=0, sw=img.width, sh=img.height;
            let dx=0, dy=0, dw=w, dh=h;
            
            if (mode === 'contain') {
                 if (ratioSrc > ratioDst) {
                    dw = w;
                    dh = w / ratioSrc;
                    dy = (h - dh) / 2;
                } else {
                    dh = h;
                    dw = h * ratioSrc;
                    dx = (w - dw) / 2;
                }
                ctx.drawImage(img, dx, dy, dw, dh);
                return;
            }
            
            // Cover (Default) + Manual
            if (ratioSrc > ratioDst) {
                sh = img.height;
                sw = sh * ratioDst;
                sx = (img.width - sw) / 2;
            } else {
                sw = img.width;
                sh = sw / ratioDst;
                sy = (img.height - sh) / 2;
            }
            
            const scale = parseFloat(rangeScale.value);
            const offYPct = parseFloat(rangeOffsetY.value);
            
            const cx = sx + sw/2;
            const cy = sy + sh/2;
            
            sw /= scale;
            sh /= scale;
            
            sx = cx - sw/2;
            sy = cy - sh/2;
            
            sy += (offYPct / 100) * img.height;
            
            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);
        }
    </script>
</body>
</html>