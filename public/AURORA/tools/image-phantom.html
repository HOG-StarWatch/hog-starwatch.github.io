<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹»å½±å¦å…‹ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background: transparent;
            padding: 20px;
            overflow-y: auto;
            display: block;
            height: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            backdrop-filter: blur(10px);
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(192, 132, 252, 0.05);
        }
        .upload-zone img {
            max-width: 100%;
            max-height: 120px;
            border-radius: 4px;
            display: none;
            object-fit: contain;
        }
        .upload-placeholder {
            color: var(--text-dim);
            font-size: 0.9rem;
        }
        .zone-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            display: block;
            font-size: 0.95rem;
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: var(--text-main);
            font-size: 0.9rem;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        .btn {
            padding: 10px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; 
            width: 100%; 
        }
        .btn-primary:hover { 
            box-shadow: 0 4px 15px rgba(192, 132, 252, 0.4); 
        }
        .btn-success { 
            background: linear-gradient(135deg, var(--secondary), #22c55e);
            color: var(--bg-deep);
            width: 100%;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .preview-area {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .canvas-container {
            width: 100%;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #eee;
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%), 
                linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ccc 75%), 
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: var(--radius-md);
            overflow: hidden;
            min-height: 400px;
            margin-bottom: 20px;
            position: relative;
            border: 1px solid var(--border);
        }

        .bg-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: var(--radius-md);
        }
        .bg-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bg-btn.active { border-color: var(--primary); transform: scale(1.1); }

        canvas {
            max-width: 100%;
            max-height: 600px;
            object-fit: contain;
        }
        
        .select-control {
            width: 100%;
            padding: 8px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-deep);
            color: var(--text-main);
            font-size: 0.9rem;
        }

        .info-tip {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 5px;
            line-height: 1.4;
        }

        @media (max-width: 800px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Control Panel -->
        <div class="panel">
            <h2 style="margin:0; color:var(--primary); font-size:1.5rem;">å¹»å½±å¦å…‹ç”Ÿæˆå™¨</h2>
            <p style="margin:0; color:var(--text-dim); font-size:0.9rem;">åœ¨ç™½åº•æ˜¾ç¤ºè¡¨å›¾ï¼Œé»‘åº•æ˜¾ç¤ºé‡Œå›¾ã€‚</p>
            
            <div style="margin-top:10px;">
                <span class="zone-label">1. è¡¨å›¾ (ç™½åº•æ˜¾ç¤º)</span>
                <input type="file" id="input-front" accept="image/*" style="display: none;">
                <div class="upload-zone" onclick="document.getElementById('input-front').click()">
                    <p class="upload-placeholder" id="ph-front">ç‚¹å‡»ä¸Šä¼ è¡¨å›¾</p>
                    <img id="img-front">
                </div>
            </div>

            <div>
                <span class="zone-label">2. é‡Œå›¾ (é»‘åº•æ˜¾ç¤º)</span>
                <input type="file" id="input-back" accept="image/*" style="display: none;">
                <div class="upload-zone" onclick="document.getElementById('input-back').click()">
                    <p class="upload-placeholder" id="ph-back">ç‚¹å‡»ä¸Šä¼ é‡Œå›¾</p>
                    <img id="img-back">
                </div>
            </div>

            <div style="margin: 10px 0;">
                <button class="btn btn-primary" id="btn-generate">âš¡ ç”Ÿæˆå¹»å½±å¦å…‹</button>
            </div>

            <div class="control-group">
                <label>
                    <span>é‡Œå›¾å¯¹é½æ¨¡å¼</span>
                </label>
                <select id="sel-fit-mode" class="select-control">
                    <option value="cover">å±…ä¸­è£å‰ª (Cover) - é»˜è®¤</option>
                    <option value="contain">å®Œæ•´æ˜¾ç¤º (Contain) - ç•™ç™½</option>
                    <option value="stretch">å¼ºåˆ¶æ‹‰ä¼¸ (Stretch) - å˜å½¢</option>
                </select>
            </div>

            <div class="control-group" id="group-manual-adjust" style="display:none;">
                 <label>é‡Œå›¾ç¼©æ”¾: <span id="val-scale">1.0</span></label>
                 <input type="range" id="range-scale" min="0.1" max="3.0" step="0.05" value="1.0">
                 
                 <label>å‚ç›´åç§»: <span id="val-offset-y">0%</span></label>
                 <input type="range" id="range-offset-y" min="-100" max="100" step="1" value="0">
            </div>

            <div class="control-group">
                <label>
                    <span>å¯¹æ¯”åº¦å‹ç¼© (0.5-0.7)</span>
                    <span id="val-contrast">0.5</span>
                </label>
                <input type="range" id="range-contrast" min="0.1" max="1.0" step="0.05" value="0.5">
            </div>

            <div class="control-group">
                <label>
                    <span>äº®åº¦ä¿®æ­£</span>
                    <span id="val-bright">0</span>
                </label>
                <input type="range" id="range-bright" min="-50" max="50" step="1" value="0">
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-area">
            <div class="bg-controls">
                <div class="bg-btn active" style="background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHJlY3Qgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjY2NjIi8+PHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiNjY2MiLz48L3N2Zz4=');" onclick="setBg('chess')" title="é€æ˜æ£‹ç›˜æ ¼"></div>
                <div class="bg-btn" style="background: #ffffff;" onclick="setBg('white')" title="ç™½è‰²èƒŒæ™¯ (é¢„è§ˆè¡¨å›¾)"></div>
                <div class="bg-btn" style="background: #000000;" onclick="setBg('black')" title="é»‘è‰²èƒŒæ™¯ (é¢„è§ˆé‡Œå›¾)"></div>
                <div class="bg-btn" style="background: #888888;" onclick="setBg('gray')" title="ç°è‰²èƒŒæ™¯"></div>
            </div>

            <div class="canvas-container" id="cvs-container">
                <canvas id="result-cvs"></canvas>
            </div>

            <a id="btn-download" class="btn btn-success" style="display: none;">ğŸ’¾ ä¿å­˜å›¾ç‰‡ (PNG)</a>
        </div>
    </div>

    <script>
        const cvs = document.getElementById('result-cvs');
        const ctx = cvs.getContext('2d');
        let imgFront = null, imgBack = null;
        let phantomWorker = null;

        // Worker Init
        if (window.Worker) {
            phantomWorker = new Worker('../js/workers/phantom.worker.js');
            phantomWorker.onmessage = (e) => {
                const { type, outputData, error } = e.data;
                const btn = document.getElementById('btn-generate');
                
                if (type === 'complete') {
                    const w = cvs.width;
                    const h = cvs.height;
                    const imgData = new ImageData(new Uint8ClampedArray(outputData), w, h);
                    ctx.putImageData(imgData, 0, 0);

                    // Enable Download
                    const dl = document.getElementById('btn-download');
                    dl.style.display = 'inline-flex';
                    dl.href = cvs.toDataURL('image/png');
                    dl.download = `phantom_${Date.now()}.png`;
                    
                    btn.disabled = false;
                    btn.innerText = 'âš¡ ç”Ÿæˆå¹»å½±å¦å…‹';
                } else if (type === 'error') {
                    console.error(error);
                    alert('Worker Error: ' + error);
                    btn.disabled = false;
                    btn.innerText = 'âš¡ ç”Ÿæˆå¹»å½±å¦å…‹';
                }
            };
        }

        // UI References
        const rangeContrast = document.getElementById('range-contrast');
        const rangeBright = document.getElementById('range-bright');
        const valContrast = document.getElementById('val-contrast');
        const valBright = document.getElementById('val-bright');
        const container = document.getElementById('cvs-container');
        
        const selFitMode = document.getElementById('sel-fit-mode');
        const groupManual = document.getElementById('group-manual-adjust');
        const rangeScale = document.getElementById('range-scale');
        const rangeOffsetY = document.getElementById('range-offset-y');
        const valScale = document.getElementById('val-scale');
        const valOffsetY = document.getElementById('val-offset-y');

        // Update Labels
        rangeContrast.oninput = () => valContrast.innerText = rangeContrast.value;
        rangeBright.oninput = () => valBright.innerText = rangeBright.value;
        
        rangeScale.oninput = () => valScale.innerText = rangeScale.value;
        rangeOffsetY.oninput = () => valOffsetY.innerText = rangeOffsetY.value + '%';
        
        selFitMode.onchange = () => {
            if (selFitMode.value === 'cover') {
                groupManual.style.display = 'block';
            } else {
                groupManual.style.display = 'none';
            }
        };
        // Init state
        selFitMode.onchange();

        // File Handling
        function handleFile(input, imgId, phId, isFront) {
            input.onchange = (e) => {
                if (!e.target.files[0]) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        document.getElementById(imgId).src = img.src;
                        document.getElementById(imgId).style.display = 'block';
                        document.getElementById(phId).style.display = 'none';
                        if(isFront) imgFront = img; else imgBack = img;
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            };
        }

        handleFile(document.getElementById('input-front'), 'img-front', 'ph-front', true);
        handleFile(document.getElementById('input-back'), 'img-back', 'ph-back', false);

        // Background Switcher
        window.setBg = (type) => {
            document.querySelectorAll('.bg-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'chess') {
                container.style.background = '';
                container.style.backgroundColor = '#eee';
                container.style.backgroundImage = `
                    linear-gradient(45deg, #ccc 25%, transparent 25%), 
                    linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                    linear-gradient(45deg, transparent 75%, #ccc 75%), 
                    linear-gradient(-45deg, transparent 75%, #ccc 75%)`;
                container.style.backgroundSize = '20px 20px';
                container.style.backgroundPosition = '0 0, 0 10px, 10px -10px, -10px 0px';
            } else {
                container.style.backgroundImage = 'none';
                container.style.backgroundColor = type;
            }
        };

        // Core Algorithm
        document.getElementById('btn-generate').onclick = () => {
            if (!imgFront || !imgBack) return alert('è¯·å…ˆä¸Šä¼ ä¸¤å¼ å›¾ç‰‡ï¼');

            const btn = document.getElementById('btn-generate');
            btn.disabled = true;
            btn.innerText = 'ç”Ÿæˆä¸­...';

            setTimeout(() => {
                generate();
                btn.disabled = false;
                btn.innerText = 'âš¡ ç”Ÿæˆå¹»å½±å¦å…‹';
            }, 50);
        };

        function generate() {
            // 1. Determine size (use Front image size)
            const w = imgFront.width;
            const h = imgFront.height;
            cvs.width = w;
            cvs.height = h;

            // 2. Draw and get data
            // Helper canvas to resize Back image to Front image size
            const tempCvs = document.createElement('canvas');
            tempCvs.width = w;
            tempCvs.height = h;
            const tempCtx = tempCvs.getContext('2d');

            // Draw Front
            tempCtx.drawImage(imgFront, 0, 0, w, h);
            const dataFront = tempCtx.getImageData(0, 0, w, h).data;

            // Draw Back (Fill/Stretch/Contain)
            tempCtx.clearRect(0, 0, w, h);
            
            const mode = selFitMode.value;
            let sx=0, sy=0, sw=imgBack.width, sh=imgBack.height; // Source rect
            let dx=0, dy=0, dw=w, dh=h; // Dest rect
            
            if (mode === 'stretch') {
                tempCtx.drawImage(imgBack, 0, 0, w, h);
            } else if (mode === 'contain') {
                // Contain logic
                const ratioF = w / h;
                const ratioB = imgBack.width / imgBack.height;
                if (ratioB > ratioF) {
                    dw = w;
                    dh = w / ratioB;
                    dx = 0;
                    dy = (h - dh) / 2;
                } else {
                    dh = h;
                    dw = h * ratioB;
                    dy = 0;
                    dx = (w - dw) / 2;
                }
                tempCtx.drawImage(imgBack, dx, dy, dw, dh);
            } else {
                // Cover logic (Default) + Manual Adjust
                const ratioF = w / h;
                const ratioB = imgBack.width / imgBack.height;
                
                // Base Cover calculation
                if (ratioB > ratioF) {
                    sh = imgBack.height;
                    sw = sh * ratioF;
                    sy = 0;
                    sx = (imgBack.width - sw) / 2;
                } else {
                    sw = imgBack.width;
                    sh = sw / ratioF;
                    sx = 0;
                    sy = (imgBack.height - sh) / 2;
                }

                // Apply Manual Scale
                const userScale = parseFloat(rangeScale.value);
                const centerSX = sx + sw/2;
                const centerSY = sy + sh/2;
                
                sw = sw / userScale;
                sh = sh / userScale;
                
                sx = centerSX - sw/2;
                sy = centerSY - sh/2;
                
                // Apply Offset
                const offY = parseFloat(rangeOffsetY.value) / 100 * imgBack.height;
                sy += offY;
                
                tempCtx.drawImage(imgBack, sx, sy, sw, sh, 0, 0, w, h);
            }
            
            const dataBack = tempCtx.getImageData(0, 0, w, h).data;

            // 3. Process Pixels
            const contrast = parseFloat(rangeContrast.value);
            const brightness = parseInt(rangeBright.value);

            if (phantomWorker) {
                phantomWorker.postMessage({
                    type: 'process',
                    dataFront: dataFront,
                    dataBack: dataBack,
                    config: {
                        width: w,
                        height: h,
                        contrast: contrast,
                        brightness: brightness
                    }
                }); // Note: Could use transferables but keeping it simple for stability
            } else {
                // Fallback for no worker
                const outputData = ctx.createImageData(w, h);
                const dOut = outputData.data;
                const split = 128 + brightness;
                
                for (let i = 0; i < w * h * 4; i += 4) {
                    // Grayscale
                    const rA = dataFront[i], gA = dataFront[i+1], bA = dataFront[i+2];
                    const rB = dataBack[i], gB = dataBack[i+1], bB = dataBack[i+2];
                    
                    const grayA = 0.299 * rA + 0.587 * gA + 0.114 * bA;
                    const grayB = 0.299 * rB + 0.587 * gB + 0.114 * bB;

                    const A_new = (grayA / 255.0) * (255 - split) + split;
                    const B_new = (grayB / 255.0) * split;
                    
                    let alpha = 255 - (A_new - B_new);
                    
                    let gray;
                    if (alpha === 0) {
                        gray = 0;
                    } else {
                        gray = (B_new * 255) / alpha;
                    }
                    
                    dOut[i] = gray;
                    dOut[i+1] = gray;
                    dOut[i+2] = gray;
                    dOut[i+3] = alpha;
                }

                ctx.putImageData(outputData, 0, 0);

                // Enable Download
                const dl = document.getElementById('btn-download');
                dl.style.display = 'inline-flex';
                dl.href = cvs.toDataURL('image/png');
                dl.download = `phantom_${Date.now()}.png`;
                
                const btn = document.getElementById('btn-generate');
                btn.disabled = false;
                btn.innerText = 'âš¡ ç”Ÿæˆå¹»å½±å¦å…‹';
            }
        }
    </script>
</body>
</html>