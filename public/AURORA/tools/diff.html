<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¯¹æ¯”å·¥å…·</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsondiffpatch@0.4.1/dist/formatters-styles/html.css">
</head>
<body>
    <div class="workspace layout-vertical">
        
        <div class="sub-tab-group">
            <div class="sub-tab active" onclick="diffTool.setMode('text')" id="tab-text">æ–‡æœ¬å¯¹æ¯” (Text)</div>
            <div class="sub-tab" onclick="diffTool.setMode('json')" id="tab-json">JSON ç»“æ„åŒ–å¯¹æ¯”</div>
        </div>

        <div class="layout-split">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">åŸæ–‡ (Old)</div>
                    <div class="panel-actions">
                        <button class="btn btn-icon" onclick="document.getElementById('file-old').click()" title="åŠ è½½æ–‡ä»¶">ğŸ“‚</button>
                        <input type="file" id="file-old" style="display:none" onchange="diffTool.loadFile(this, 'diff-old')">
                        <button class="btn btn-icon" onclick="diffTool.formatJSON('diff-old')" title="æ ¼å¼åŒ– JSON" id="btn-fmt-old" style="display:none;">{}</button>
                        <button class="btn btn-icon" onclick="document.getElementById('diff-old').value=''">æ¸…ç©º</button>
                    </div>
                </div>
                <textarea id="diff-old" placeholder="è¾“å…¥åŸå§‹å†…å®¹..."></textarea>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">æ–°æ–‡ (New)</div>
                    <div class="panel-actions">
                        <button class="btn btn-icon" onclick="document.getElementById('file-new').click()" title="åŠ è½½æ–‡ä»¶">ğŸ“‚</button>
                        <input type="file" id="file-new" style="display:none" onchange="diffTool.loadFile(this, 'diff-new')">
                        <button class="btn btn-icon" onclick="diffTool.formatJSON('diff-new')" title="æ ¼å¼åŒ– JSON" id="btn-fmt-new" style="display:none;">{}</button>
                        <button class="btn btn-icon" onclick="document.getElementById('diff-new').value=''">æ¸…ç©º</button>
                    </div>
                </div>
                <textarea id="diff-new" placeholder="è¾“å…¥ä¿®æ”¹åçš„å†…å®¹..."></textarea>
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem; align-items: center; padding: 0.5rem 0;">
            <button class="btn btn-primary" onclick="diffTool.compare()">å¼€å§‹å¯¹æ¯” (Compare)</button>
            <div style="font-size: 0.8rem; color: var(--text-dim);" id="legend-text">
                <span class="legend-badge ins">æ–°å¢</span>
                <span class="legend-badge del">åˆ é™¤</span>
            </div>
        </div>

        <div class="panel" style="flex: 1; min-height: 0;">
             <div class="panel-header">
                <div class="panel-title">å¯¹æ¯”ç»“æœ</div>
            </div>
            <div id="diff-output" style="padding: 1rem; overflow: auto; flex: 1; font-family: monospace; white-space: pre-wrap; color: var(--text-main);"></div>
        </div>
    </div>

    <div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>
    <script src="../js/loader.js"></script>
    <script src="../js/app.js"></script>
    <script>
        const diffTool = {
            mode: 'text',

            setMode: function(mode) {
                this.mode = mode;
                
                // Update Tabs
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('tab-' + mode).classList.add('active');
                
                // Update UI controls
                const showJsonBtns = mode === 'json' ? 'inline-flex' : 'none';
                document.getElementById('btn-fmt-old').style.display = showJsonBtns;
                document.getElementById('btn-fmt-new').style.display = showJsonBtns;
                
                // Clear output
                document.getElementById('diff-output').innerHTML = '';
                
                app.showToast('å·²åˆ‡æ¢è‡³ ' + (mode === 'json' ? 'JSON ç»“æ„åŒ–å¯¹æ¯”' : 'æ–‡æœ¬å¯¹æ¯”') + ' æ¨¡å¼');
            },

            formatJSON: function(id) {
                const el = document.getElementById(id);
                try {
                    const val = el.value.trim();
                    if (!val) return;
                    const obj = JSON.parse(val);
                    el.value = JSON.stringify(obj, null, 2);
                    app.showToast('æ ¼å¼åŒ–æˆåŠŸ');
                } catch(e) {
                    app.showToast('JSON æ ¼å¼é”™è¯¯: ' + e.message, 'error');
                }
            },

            compare: function() {
                if (this.mode === 'json') {
                    this.compareJSON();
                } else {
                    this.compareText();
                }
            },

            compareText: function() {
                const oldTxt = document.getElementById('diff-old').value;
                const newTxt = document.getElementById('diff-new').value;
                
                app.showToast('æ­£åœ¨åŠ è½½ç»„ä»¶...', 'info');
                ResourceLoader.load('diff_match_patch').then(() => {
                    const dmp = new diff_match_patch();
                    const diffs = dmp.diff_main(oldTxt, newTxt);
                    dmp.diff_cleanupSemantic(diffs);
                    
                    // Custom pretty HTML generation
                    const html = [];
                    for (let x = 0; x < diffs.length; x++) {
                        const op = diffs[x][0];    // Operation (insert, delete, equal)
                        const data = diffs[x][1];  // Text of change
                        const text = data.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
                        
                        switch (op) {
                            case DIFF_INSERT:
                                html[x] = '<ins>' + text + '</ins>';
                                break;
                            case DIFF_DELETE:
                                html[x] = '<del>' + text + '</del>';
                                break;
                            case DIFF_EQUAL:
                                html[x] = '<span>' + text + '</span>';
                                break;
                        }
                    }
                    
                    document.getElementById('diff-output').innerHTML = html.join('');
                    app.showToast('å¯¹æ¯”å®Œæˆ');
                });
            },

            compareJSON: function() {
                const oldTxt = document.getElementById('diff-old').value;
                const newTxt = document.getElementById('diff-new').value;
                
                let oldObj, newObj;
                try {
                    oldObj = oldTxt ? JSON.parse(oldTxt) : undefined;
                } catch(e) {
                    return app.showToast('åŸæ–‡ä¸æ˜¯æœ‰æ•ˆçš„ JSON', 'error');
                }
                
                try {
                    newObj = newTxt ? JSON.parse(newTxt) : undefined;
                } catch(e) {
                    return app.showToast('æ–°æ–‡ä¸æ˜¯æœ‰æ•ˆçš„ JSON', 'error');
                }

                app.showToast('æ­£åœ¨åŠ è½½ç»„ä»¶...', 'info');
                ResourceLoader.load('jsondiffpatch').then(() => {
                    const delta = jsondiffpatch.diff(oldObj, newObj);
                    
                    if (!delta) {
                        document.getElementById('diff-output').innerHTML = '<div style="padding:1rem; opacity:0.7;">æ²¡æœ‰å‘ç°å·®å¼‚ (No differences found)</div>';
                        app.showToast('å¯¹æ¯”å®Œæˆ: æ— å·®å¼‚');
                        return;
                    }

                    // Render Diff
                    // Note: jsondiffpatch.formatters.html.format returns HTML string
                    // But we might need to load CSS if not loaded. (Handled in head)
                    const html = jsondiffpatch.formatters.html.format(delta, oldObj);
                    
                    // jsondiffpatch css requires a wrapper or global css. 
                    // We added CSS link in head.
                    document.getElementById('diff-output').innerHTML = html;
                    
                    // Enable visual interactions if needed (unhiding unchanged parts etc)
                    // jsondiffpatch.formatters.html.hideUnchanged() is a feature but requires JS to toggle classes
                    // We can stick to basic static view first.
                    
                    app.showToast('å¯¹æ¯”å®Œæˆ');
                }).catch(err => {
                    console.error(err);
                    app.showToast('åŠ è½½ç»„ä»¶å¤±è´¥', 'error');
                });
            },

            loadFile: function(input, targetId) {
                const file = input.files[0];
                if(!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const buf = e.target.result;
                    const bytes = new Uint8Array(buf);
                    
                    // Check for null bytes to detect binary (heuristic)
                    let isBinary = false;
                    const checkLen = Math.min(bytes.length, 1000);
                    for(let i=0; i<checkLen; i++) {
                        if(bytes[i] === 0) {
                            isBinary = true;
                            break;
                        }
                    }
                    
                    if(isBinary) {
                        // Convert to Hex view for comparison
                        let hexOutput = '';
                        const len = bytes.length;
                        for(let i=0; i<len; i++) {
                            const b = bytes[i];
                            hexOutput += (b < 16 ? '0' : '') + b.toString(16);
                            // Add space every byte, newline every 16 bytes
                            if ((i + 1) % 16 === 0) {
                                hexOutput += '\n';
                            } else {
                                hexOutput += ' ';
                            }
                        }
                        
                        document.getElementById(targetId).value = hexOutput.trim();
                        app.showToast('æ£€æµ‹åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå·²è½¬æ¢ä¸º Hex è§†å›¾', 'info');
                    } else {
                        // Decode as text
                        const decoder = new TextDecoder('utf-8');
                        const text = decoder.decode(bytes);
                        document.getElementById(targetId).value = text;
                        app.showToast('æ–‡ä»¶åŠ è½½æˆåŠŸ');
                    }
                };
                
                reader.onerror = () => app.showToast('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
                reader.readAsArrayBuffer(file);
                
                // Reset input
                input.value = '';
            }
        };
    </script>
</body>
</html>