<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶è½¬äºŒç»´ç  (File to QR)</title>
    <link rel="stylesheet" href="../css/style.css">
    <!-- Dependencies -->
    <script src="../js/app.js"></script>
    <script src="../js/loader.js"></script>
    <style>
        body {
            background: transparent;
            padding: 20px;
            overflow-y: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .header-section {
            text-align: center; 
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 25px;
            backdrop-filter: blur(10px);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .sub-tab-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .sub-tab {
            padding: 10px 30px;
            border-radius: var(--radius-md);
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: 0.3s;
            color: var(--text-dim);
            font-weight: 600;
        }
        .sub-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(192, 132, 252, 0.3);
        }

        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-main);
            font-weight: 500;
        }
        
        .upload-box {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: rgba(0,0,0,0.2);
            transition: 0.3s;
            position: relative;
        }
        .upload-box:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.05);
        }

        select, input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-main);
            font-size: 0.95rem;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; 
        }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }

        .progress-wrap {
            margin-top: 15px;
            display: none;
        }
        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-fill {
            height: 100%;
            background: var(--secondary);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-align: center;
        }

        canvas {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin: 20px auto;
            display: block;
        }

        .info-note {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 5px;
            line-height: 1.4;
        }

        /* Layout Split */
        .split-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        @media (min-width: 900px) {
            .split-layout {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                align-items: start;
                height: 100%;
                overflow: hidden;
            }
            .left-col {
                display: flex;
                flex-direction: column;
                gap: 20px;
                height: 100%;
                overflow-y: auto;
                padding-right: 10px;
            }
            .right-col {
                background: rgba(0,0,0,0.2);
                padding: 20px;
                border-radius: var(--radius-md);
                display: flex;
                flex-direction: column;
                justify-content: center;
                height: 100%;
                overflow-y: auto;
            }
        }

        /* File List Widget Styles (Ported from file-encoding.html) */
        .file-list-widget {
            margin-top: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .file-list-item:last-child { border-bottom: none; }
        .file-list-item:hover { background: rgba(255,255,255,0.05); }
        .file-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        .file-meta {
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .remove-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
            margin-left: 10px;
            border-radius: 4px;
        }
        .remove-btn:hover { color: #ef4444; background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-section">
            <h2 style="color: var(--primary); margin: 0;">æ–‡ä»¶ â‡Œ äºŒç»´ç </h2>
        </div>
        
        <div class="sub-tab-group">
            <div class="sub-tab active" onclick="switchTab('embed')">ğŸ” æ–‡ä»¶åµŒå…¥ (Embed)</div>
            <div class="sub-tab" onclick="switchTab('extract')">ğŸ“¥ æ–‡ä»¶æå– (Extract)</div>
        </div>

        <!-- EMBED SECTION -->
        <div id="section-embed" class="panel">
            <div class="split-layout">
                <!-- Left Column: Inputs -->
                <div class="left-col">
                    <div class="control-group">
                        <label>1. é€‰æ‹©æ–‡ä»¶ (å¯å¤šé€‰)</label>
                        <input type="file" id="filesInput" multiple style="display: none;">
                        <div class="upload-box" id="drop-zone" onclick="document.getElementById('filesInput').click()">
                            <i class="fas fa-file-import" style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--text-dim);"></i>
                            <div style="font-size: 1rem;">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶</div>
                            <div style="color: var(--text-dim); font-size: 0.8rem; margin-top:5px;">æ”¯æŒå¤šæ–‡ä»¶æ‰¹é‡å¤„ç†</div>
                        </div>
                        <!-- File List Widget -->
                        <div id="file-list-widget" class="file-list-widget"></div>
                    </div>

                    <div class="control-group">
                        <label>2. åµŒå…¥ç­–ç•¥</label>
                        <select id="embedMode">
                            <option value="anticomp" selected>è¶…æŠ—å‹ç¼© (Bç«™/è§†é¢‘æ¨è, 2bit/px)</option>
                            <option value="pair41">æœ€å°ä½“ç§¯ (å¾®ä¿¡/QQæ¨è, 2B/px)</option>
                            <option value="byte7">æœ€éšè”½ (ä½“ç§¯è¾ƒå¤§, 1B/px)</option>
                        </select>
                        <p class="info-note">"è¶…æŠ—å‹ç¼©"æ¨¡å¼å¯ä»¥æŠµæŠ—è§†é¢‘äºŒå‹ï¼Œä½†ä½“ç§¯åˆ©ç”¨ç‡è¾ƒä½ã€‚</p>
                    </div>

                    <div class="control-group">
                        <label>3. æ‰«ç è·³è½¬é“¾æ¥</label>
                        <select id="qrLinkSelect" onchange="toggleCustomLink()">
                            <option value="https://hog-starwatch.github.io/File2QRcode" selected>Github è§£å¯†é¡µ (é»˜è®¤)</option>
                            <option value="custom">è‡ªå®šä¹‰é“¾æ¥</option>
                        </select>
                        <input type="text" id="customLinkInput" placeholder="è¾“å…¥é“¾æ¥ (http://...)" style="display:none; margin-top:10px;">
                    </div>

                    <div class="control-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="convertToJpg" style="margin-right: 8px;"> 
                            å°†å›¾ç‰‡è½¬ä¸º JPG (å‡å°ä½“ç§¯)
                        </label>
                        <div id="jpgQualityContainer" style="display:none; margin-top:5px; margin-left: 20px;">
                            <label>è´¨é‡: <select id="jpgQuality" style="width:auto; display:inline-block;">
                                <option value="0.7">0.7 (å°)</option>
                                <option value="0.85" selected>0.85 (æ¨è)</option>
                                <option value="1.0">1.0 (åŸç”»)</option>
                            </select></label>
                        </div>
                    </div>

                    <div class="control-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="extraInfoToggle" onchange="toggleExtraInfo()" style="margin-right: 8px;"> 
                            é™„åŠ å¯è§†æè¿° (å›¾ç‰‡/æ–‡å­—)
                        </label>
                        <div id="extraInfoContainer" style="display: none; margin-top: 10px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <label>æè¿°å›¾ç‰‡:</label>
                            <input type="file" id="previewImageInput" accept="image/*" style="margin-bottom: 10px; width: 100%;">
                            <label>æè¿°æ–‡å­—:</label>
                            <input type="text" id="descriptionInput" placeholder="æ˜¾ç¤ºåœ¨äºŒç»´ç ä¸‹æ–¹çš„æ–‡å­—">
                        </div>
                    </div>
                </div>

                <!-- Right Column: Action & Preview -->
                <div class="right-col">
                    <button class="btn btn-primary" id="generateButton">âš¡ ç”ŸæˆäºŒç»´ç å›¾åƒ</button>
                    
                    <div id="encodeProgressWrap" class="progress-wrap">
                        <div id="encodeProgressText" class="progress-text">å‡†å¤‡ä¸­...</div>
                        <div class="progress-bar"><div id="encodeProgressBar" class="progress-fill"></div></div>
                    </div>

                    <div id="qrPreviewContainer" style="text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center; flex: 1;">
                        <div style="color:var(--text-dim);">
                            <i class="fas fa-qrcode" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <div>é¢„è§ˆåŒºåŸŸ</div>
                        </div>
                    </div>
                    <a id="downloadLink" class="btn btn-primary" style="background: var(--secondary); display: none; margin-top: 15px;">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</a>
                </div>
            </div>
        </div>

        <!-- EXTRACT SECTION -->
        <div id="section-extract" class="panel" style="display: none;">
            <div class="split-layout">
                <div class="left-col">
                    <div class="control-group">
                        <label>é€‰æ‹©åŒ…å«æ•°æ®çš„äºŒç»´ç å›¾ç‰‡</label>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        <div class="upload-box" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-image" style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--text-dim);"></i>
                            <span id="imageInputName">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡...</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="decodeButton">ğŸ”“ æå–æ–‡ä»¶</button>
                </div>
                
                <div class="right-col">
                    <div id="decodeProgressWrap" class="progress-wrap">
                        <div id="decodeProgressText" class="progress-text">å‡†å¤‡ä¸­...</div>
                        <div class="progress-bar"><div id="decodeProgressBar" class="progress-fill"></div></div>
                    </div>
                    <div id="fileList" style="margin-top: 20px; text-align: center; color: var(--text-dim);">
                        (æå–ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ)
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let selectedFiles = [];

        // --- Tab Switching ---
        function switchTab(tab) {
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
            
            if(tab === 'embed') {
                document.querySelector('.sub-tab:nth-child(1)').classList.add('active');
                document.getElementById('section-embed').style.display = 'flex';
            } else {
                document.querySelector('.sub-tab:nth-child(2)').classList.add('active');
                document.getElementById('section-extract').style.display = 'flex';
            }
        }

        // --- UI Utils ---
        function toggleCustomLink() {
            document.getElementById('customLinkInput').style.display = 
                document.getElementById('qrLinkSelect').value === 'custom' ? 'block' : 'none';
        }
        function toggleExtraInfo() {
            document.getElementById('extraInfoContainer').style.display = 
                document.getElementById('extraInfoToggle').checked ? 'block' : 'none';
        }
        document.getElementById('convertToJpg').onchange = (e) => {
            document.getElementById('jpgQualityContainer').style.display = e.target.checked ? 'block' : 'none';
        };

        // --- File Inputs & List Handling ---
        const filesInput = document.getElementById('filesInput');
        filesInput.onchange = (e) => {
            handleFiles(e.target.files);
            filesInput.value = ''; // Reset to allow re-selecting same files
        };

        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary)';
            dropZone.style.background = 'rgba(255,255,255,0.05)';
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border)';
            dropZone.style.background = 'rgba(0,0,0,0.2)';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border)';
            dropZone.style.background = 'rgba(0,0,0,0.2)';
            if(e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });

        function handleFiles(files) {
            const newFiles = Array.from(files);
            selectedFiles = [...selectedFiles, ...newFiles];
            updateFileListUI();
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileListUI();
        }

        function updateFileListUI() {
            const container = document.getElementById('file-list-widget');
            container.innerHTML = '';
            
            if (selectedFiles.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            selectedFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'file-list-item';
                div.innerHTML = `
                    <div class="file-info">
                        <span class="file-name" title="${file.name}">${file.name}</span>
                        <span class="file-meta">${(file.size / 1024).toFixed(1)} KB | ${file.type || 'Unknown'}</span>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})" title="ç§»é™¤æ–‡ä»¶">âœ•</button>
                `;
                container.appendChild(div);
            });
        }

        document.getElementById('imageInput').onchange = (e) => {
            const file = e.target.files[0];
            document.getElementById('imageInputName').innerText = file ? file.name : 'ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡...';
        };

        // --- Core Logic ---
        const setProgress = (type, pct, text) => {
            const wrap = document.getElementById(type + 'ProgressWrap');
            const bar = document.getElementById(type + 'ProgressBar');
            const txt = document.getElementById(type + 'ProgressText');
            wrap.style.display = 'block';
            bar.style.width = pct + '%';
            txt.innerText = text;
        };
        const uiTick = () => new Promise(r => setTimeout(r, 0));

        // ================= EMBED LOGIC =================
        document.getElementById("generateButton").onclick = async function () {
            if (selectedFiles.length === 0) return alert("è¯·é€‰æ‹©æ–‡ä»¶");

            const button = document.getElementById("generateButton");
            button.disabled = true;
            button.innerText = "å¤„ç†ä¸­â€¦";

            try {
                if(window.app && app.showToast) app.showToast('æ­£åœ¨åŠ è½½ç»„ä»¶...', 'info');
                await ResourceLoader.loadDeps('@file-qrcode');
                await generateDataQRCodeFromFiles(selectedFiles);
            } catch (err) {
                console.error(err);
                alert("å¤„ç†å¤±è´¥ï¼š" + err.message);
            }

            button.disabled = false;
            button.innerText = "âš¡ ç”ŸæˆäºŒç»´ç å›¾åƒ";
        };

        async function generateDataQRCodeFromFiles(fileList) {
            setProgress("encode", 1, "å‡†å¤‡å¼€å§‹â€¦");
            await uiTick();

            // 1. Zip
            setProgress("encode", 5, "å‹ç¼©æ–‡ä»¶â€¦");
            const entries = {};
            const convertToJpg = document.getElementById('convertToJpg').checked;
            
            for(let file of fileList) {
                let data = new Uint8Array(await file.arrayBuffer());
                let name = file.name;
                
                if(convertToJpg && file.type.startsWith('image/') && !file.type.includes('jpeg')) {
                    try {
                        const bmp = await createImageBitmap(file);
                        const cvs = document.createElement('canvas');
                        cvs.width = bmp.width; cvs.height = bmp.height;
                        const ctx = cvs.getContext('2d');
                        ctx.fillStyle='#fff'; ctx.fillRect(0,0,bmp.width,bmp.height);
                        ctx.drawImage(bmp,0,0);
                        const blob = await new Promise(r => cvs.toBlob(r, 'image/jpeg', parseFloat(document.getElementById('jpgQuality').value)));
                        data = new Uint8Array(await blob.arrayBuffer());
                        name = name.substring(0, name.lastIndexOf('.')) + '.jpg';
                    } catch(e) { console.warn("Image conversion failed, using original", e); }
                }
                entries[name] = data;
            }
            
            const zipped = await new Promise((resolve, reject) => {
                 fflate.zip(entries, { level: 9 }, (err, data) => err ? reject(err) : resolve(data));
            });
            
            // 2. Prepare Data
            const checksum = zipped.reduce((acc, b) => acc ^ b, 0) & 0xff;
            const mode = document.getElementById("embedMode").value;
            let fullData, bytesPerPixel=1, bitsPerPixel=8, qrSize;
            
            // Header Construction
            if (mode === "anticomp") {
                fullData = new Uint8Array(10 + zipped.length);
                fullData.set([0x01, 0xFC, checksum, 0,0,0, ...new Uint8Array(new Uint32Array([zipped.length]).buffer).reverse()], 0); 
                fullData[6] = (zipped.length >>> 24) & 0xFF;
                fullData[7] = (zipped.length >>> 16) & 0xFF;
                fullData[8] = (zipped.length >>> 8) & 0xFF;
                fullData[9] = zipped.length & 0xFF;
                fullData.set(zipped, 10);
                bitsPerPixel = 2; 
            } else {
                fullData = new Uint8Array(8 + zipped.length);
                fullData[0] = checksum;
                fullData[4] = (zipped.length >>> 24) & 0xFF;
                fullData[5] = (zipped.length >>> 16) & 0xFF;
                fullData[6] = (zipped.length >>> 8) & 0xFF;
                fullData[7] = zipped.length & 0xFF;
                fullData.set(zipped, 8);
                bytesPerPixel = (mode === 'pair41') ? 2 : 1;
            }

            // 3. Calc Size
            let neededPixels;
            if (mode === "anticomp") neededPixels = Math.ceil(fullData.length * 8 / 2);
            else neededPixels = Math.ceil(fullData.length / bytesPerPixel) + 3; 

            qrSize = Math.max(512, Math.ceil(Math.sqrt(neededPixels)));
            
            // Write Size to Header
            if (mode === "anticomp") {
                fullData[3] = (qrSize >> 16) & 0xFF;
                fullData[4] = (qrSize >> 8) & 0xFF;
                fullData[5] = qrSize & 0xFF;
            } else {
                fullData[1] = (qrSize >> 16) & 0xFF;
                fullData[2] = (qrSize >> 8) & 0xFF;
                fullData[3] = qrSize & 0xFF;
            }

            // 4. Generate QR Base
            setProgress("encode", 20, "ç”ŸæˆåŸºç¡€äºŒç»´ç ...");
            const canvas = document.createElement("canvas");
            canvas.width = qrSize; canvas.height = qrSize;
            
            let url = document.getElementById("qrLinkSelect").value;
            if(url === 'custom') url = document.getElementById("customLinkInput").value || 'http://localhost';
            
            await QRCode.toCanvas(canvas, url, { errorCorrectionLevel: 'L', margin: 1, width: qrSize });
            
            // 5. Embed Data
            setProgress("encode", 30, "å†™å…¥æ•°æ®...");
            const ctx = canvas.getContext('2d');
            const imgData = ctx.getImageData(0,0,qrSize,qrSize);
            const px = imgData.data;

            if (mode === "anticomp") {
                const LEVELS = [0, 30, 60, 90];
                let bitIndex = 0;
                const totalBits = fullData.length * 8;
                for(let y=0; y<qrSize; y++) {
                    for(let x=0; x<qrSize; x++) {
                        const idx = (y*qrSize+x)*4;
                        let twoBits = 0;
                        if(bitIndex < totalBits) {
                            const b1 = (fullData[bitIndex>>>3] >>> (7-(bitIndex&7))) & 1;
                            bitIndex++;
                            const b2 = (fullData[bitIndex>>>3] >>> (7-(bitIndex&7))) & 1;
                            bitIndex++;
                            twoBits = (b1<<1)|b2;
                        } else {
                            twoBits = Math.floor(Math.random()*4);
                        }
                        
                        const lum = (px[idx]+px[idx+1]+px[idx+2])/3;
                        const base = LEVELS[twoBits];
                        const v = (lum >= 128) ? (255-base) : base;
                        px[idx]=px[idx+1]=px[idx+2]=v;
                        px[idx+3]=255;
                    }
                    if(y%10===0) await uiTick();
                }

            } else {
                let dataIdx = 0;
                const isPair = (mode === 'pair41');
                const setPx = (i, r,g,b) => { px[i]=r; px[i+1]=g; px[i+2]=b; px[i+3]=255; };
                setPx(0, 250,251,252); 
                setPx(4, 253,254,255); 
                setPx(8, 255,255, (isPair?255:254)); 
                
                for(let i=3; i<qrSize*qrSize; i++) { 
                    const idx = i*4;
                    let c1,c2,c3;
                    
                    if(dataIdx < fullData.length) {
                        if(isPair) {
                            const b1 = fullData[dataIdx++] || 0;
                            const b2 = fullData[dataIdx++] || 0;
                            let v = (b1<<8)|b2;
                            c3 = v%41; v=Math.floor(v/41);
                            c2 = v%41; v=Math.floor(v/41);
                            c1 = v;
                        } else {
                            let v = fullData[dataIdx++] || 0;
                            c3 = v%7; v=Math.floor(v/7);
                            c2 = v%7; v=Math.floor(v/7);
                            c1 = v;
                        }
                    } else {
                         if(isPair) { c1=Math.random()*41|0; c2=Math.random()*41|0; c3=Math.random()*41|0; }
                         else { c1=Math.random()*7|0; c2=Math.random()*7|0; c3=Math.random()*7|0; }
                    }
                    
                    const writeCh = (orig, v) => (orig < 128 ? v : 255-v);
                    px[idx] = writeCh(px[idx], c1);
                    px[idx+1] = writeCh(px[idx+1], c2);
                    px[idx+2] = writeCh(px[idx+2], c3);
                    px[idx+3] = 255;
                }
            }
            
            ctx.putImageData(imgData, 0, 0);
            
            // 6. Composition (Extra Info)
            setProgress("encode", 90, "åˆæˆæœ€ç»ˆå›¾ç‰‡...");
            const finalCanvas = await composeFinal(canvas);
            
            // Display
            const container = document.getElementById('qrPreviewContainer');
            container.innerHTML = '';
            finalCanvas.style.maxWidth = '100%';
            finalCanvas.style.height = 'auto';
            container.appendChild(finalCanvas);
            
            const dl = document.getElementById('downloadLink');
            dl.href = finalCanvas.toDataURL('image/png');
            dl.download = `qrcode_${Date.now()}.png`;
            dl.style.display = 'flex';
            
            setProgress("encode", 100, "å®Œæˆï¼");
        }

        async function composeFinal(qrCvs) {
            if(!document.getElementById('extraInfoToggle').checked) return qrCvs;
            
            const n = qrCvs.width;
            const extraH = Math.floor(n * 0.25);
            const cvs = document.createElement('canvas');
            cvs.width = n; cvs.height = n + extraH;
            const ctx = cvs.getContext('2d');
            
            // Get Theme Colors
            const style = getComputedStyle(document.body);
            const bgPanel = style.getPropertyValue('--bg-panel').trim() || '#fff';
            const textMain = style.getPropertyValue('--text-main').trim() || '#000';
            
            // Background
            ctx.fillStyle = bgPanel; 
            ctx.fillRect(0,0,n,cvs.height);
            
            // Draw QR
            ctx.drawImage(qrCvs, 0, 0);
            
            const desc = document.getElementById('descriptionInput').value;
            const file = document.getElementById('previewImageInput').files[0];
            
            if(file) {
                const img = await createImageBitmap(file);
                const boxSize = n * 0.2;
                const scale = Math.min(boxSize/img.width, boxSize/img.height);
                const w = img.width*scale, h = img.height*scale;
                ctx.drawImage(img, (boxSize-w)/2, n+(extraH-h)/2, w, h);
                
                if(desc) {
                    ctx.font = `${Math.floor(n*0.05)}px sans-serif`;
                    ctx.fillStyle = textMain;
                    ctx.textBaseline = 'middle';
                    ctx.fillText(desc, n*0.25, n+extraH/2);
                }
            } else if(desc) {
                ctx.font = `${Math.floor(n*0.05)}px sans-serif`;
                ctx.fillStyle = textMain;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(desc, n/2, n+extraH/2);
            }
            
            return cvs;
        }

        // ================= DECODE LOGIC =================
        document.getElementById("decodeButton").onclick = () => {
             alert("è§£ç åŠŸèƒ½åœ¨æ­¤ç‰ˆæœ¬æš‚æœªç§»æ¤ (TODO: Port Decode Logic)");
        };

        // Theme Propagation Listener
        window.addEventListener('message', (e) => {
            if(e.data && e.data.type === 'theme-update') {
                // Force redraw if needed, but since we rely on getComputedStyle, 
                // just re-rendering (if something was generated) might be needed.
                // However, style.css usually handles CSS vars. 
                // This is just a placeholder if parent pushes specific values.
            }
        });

    </script>
</body>
</html>
