<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ ¼å¼è½¬æ¢</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .converter-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            min-height: 200px;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(192, 132, 252, 0.05);
            color: var(--text-main);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .upload-area.drag-over {
            border-color: var(--secondary);
            background: rgba(45, 212, 191, 0.1);
            transform: scale(1.02);
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .preview-item {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
            position: relative;
        }
        
        .preview-img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            background: rgba(255,255,255,0.05); /* Checkerboard would be better */
            border-radius: var(--radius-sm);
        }

        /* Base64 Tool Animations & Styles */
        .tab-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 1;
            transform: translateY(0);
        }
        .tab-content.hidden {
            display: none;
            opacity: 0;
            transform: translateY(10px);
        }
        
        .mode-btn {
            flex: 1; 
            text-align: center; 
            padding: 0.8rem; 
            border-radius: var(--radius-sm); 
            border: 1px solid var(--border); 
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border-color: var(--primary);
            font-weight: 600;
        }
        .mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }
    </style>
</head>
<body style="padding: 1rem;">
    <div class="sub-tab-group">
        <div class="sub-tab active" onclick="switchSubTab('format', this)">æ ¼å¼è½¬æ¢</div>
        <div class="sub-tab" onclick="switchSubTab('resize', this)">å°ºå¯¸è°ƒæ•´</div>
        <div class="sub-tab" onclick="switchSubTab('base64', this)">Base64 è½¬æ¢</div>
    </div>

    <div class="workspace">
        <!-- Format Converter -->
        <div id="tab-format" class="panel" style="padding: 1.5rem;">
            <div class="converter-container">
                <div class="panel-title">å›¾ç‰‡æ ¼å¼è½¬æ¢å™¨</div>
                
                <!-- Controls -->
                <div class="input-row" style="flex-wrap: wrap; gap: 1rem;">
                    <div style="flex: 1; min-width: 200px;">
                        <label>ç›®æ ‡æ ¼å¼</label>
                        <select id="target-format" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-main); padding: 0.5rem;">
                            <option value="image/png">PNG</option>
                            <option value="image/jpeg">JPEG</option>
                            <option value="image/webp">WEBP</option>
                            <option value="image/bmp">BMP</option>
                            <option value="image/gif">GIF (ä»…é¦–å¸§)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label>è´¨é‡ (JPEG/WEBP)</label>
                        <input type="range" id="target-quality" min="0.1" max="1.0" step="0.1" value="0.9" oninput="document.getElementById('quality-val').innerText = Math.round(this.value * 100) + '%'">
                        <span id="quality-val" style="font-size: 0.8rem; color: var(--primary);">90%</span>
                    </div>
                </div>

                <!-- Upload -->
                <div class="upload-area" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“‚</div>
                    <div>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.5rem;">æ”¯æŒ PNG, JPG, WEBP, BMP, GIF ç­‰</div>
                    <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="imgConverter.convertAll()">å…¨éƒ¨è½¬æ¢</button>
                    <button class="btn btn-secondary" onclick="imgConverter.clearAll()">æ¸…ç©ºåˆ—è¡¨</button>
                </div>

                <!-- Preview List -->
                <div class="preview-grid" id="preview-list">
                    <!-- Items will be injected here -->
                </div>
            </div>
        </div>

        <!-- Resize Tool -->
        <div id="tab-resize" class="panel" style="padding: 1.5rem; display: none;">
            <div class="panel-title">å›¾ç‰‡å°ºå¯¸è°ƒæ•´</div>
            
            <!-- Upload Area -->
            <div class="upload-area" id="resize-drop-zone" onclick="document.getElementById('resize-file-input').click()" style="margin-bottom: 1.5rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“</div>
                <div>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                <input type="file" id="resize-file-input" accept="image/*" style="display: none;" onchange="resizeTool.handleFile(this.files[0])">
            </div>

            <!-- Workspace (Hidden until file loaded) -->
            <div id="resize-workspace" style="display: none;">
                <div style="display: flex; flex-wrap: wrap; gap: 2rem;">
                    <!-- Controls -->
                    <div style="flex: 1; min-width: 300px;">
                        <div class="input-row">
                            <label>åŸå§‹å°ºå¯¸</label>
                            <div id="original-size" style="color: var(--text-dim); padding: 0.5rem 0;">- x -</div>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <label>å®½åº¦ (px)</label>
                                <input type="number" id="resize-width" min="1" class="input-box" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-main); padding: 0.6rem;">
                            </div>
                            <div style="flex: 1;">
                                <label>é«˜åº¦ (px)</label>
                                <input type="number" id="resize-height" min="1" class="input-box" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-main); padding: 0.6rem;">
                            </div>
                        </div>

                        <div class="input-row" style="margin-bottom: 1.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="resize-lock" checked style="width: auto;">
                                é”å®šé•¿å®½æ¯”
                            </label>
                        </div>

                        <div class="input-row">
                            <label>è¾“å‡ºæ ¼å¼</label>
                            <select id="resize-format" style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-main); padding: 0.6rem; margin-bottom: 1rem;">
                                <option value="image/png">PNG</option>
                                <option value="image/jpeg">JPEG</option>
                                <option value="image/webp">WEBP</option>
                            </select>
                        </div>

                        <div class="input-row" id="resize-quality-wrapper" style="display: none;">
                            <label>è´¨é‡ (<span id="resize-quality-val">0.9</span>)</label>
                            <input type="range" id="resize-quality" min="0.1" max="1.0" step="0.05" value="0.9" style="width: 100%;">
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button class="btn btn-primary" onclick="resizeTool.process()" style="flex: 1;">åº”ç”¨å¹¶é¢„è§ˆ</button>
                            <button class="btn btn-secondary" id="resize-download-btn" disabled onclick="resizeTool.download()" style="flex: 1;">ä¸‹è½½å›¾ç‰‡</button>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div style="flex: 1; min-width: 300px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md); padding: 1rem; display: flex; align-items: center; justify-content: center; min-height: 300px; border: 1px dashed var(--border);">
                        <div id="resize-preview-container" style="max-width: 100%; max-height: 400px; overflow: auto;">
                            <span style="color: var(--text-dim);">é¢„è§ˆåŒºåŸŸ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Base64 Converter -->
        <div id="tab-base64" class="panel" style="padding: 1.5rem; display:none;">
            <div class="panel-title">Base64 å›¾ç‰‡è½¬æ¢</div>
            
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <button class="mode-btn active" id="mode-to-base64" onclick="base64Tool.switchMode('toBase64')">å›¾ç‰‡è½¬ Base64</button>
                <button class="mode-btn" id="mode-to-image" onclick="base64Tool.switchMode('toImage')">Base64 è½¬å›¾ç‰‡</button>
            </div>

            <!-- Image to Base64 -->
            <div id="view-to-base64" class="tab-content">
                <div class="upload-area" id="b64-drop-zone" onclick="document.getElementById('b64-file-input').click()">
                    <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.8;">ğŸ–¼ï¸</div>
                    <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                    <div style="font-size: 0.85rem; color: var(--text-dim); opacity: 0.7;">æ”¯æŒ PNG, JPG, WEBP, GIF (è‡ªåŠ¨è½¬æ¢ä¸º Base64)</div>
                    <input type="file" id="b64-file-input" accept="image/*" style="display: none;" onchange="base64Tool.handleFile(this.files[0])">
                </div>
                
                <div id="b64-result-area" style="display:none; margin-top:1.5rem;">
                    <div class="input-row">
                        <label>Base64 ç»“æœ</label>
                        <textarea id="b64-output" style="width:100%; height:150px; background:rgba(0,0,0,0.2); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-main); padding:0.8rem; resize:vertical;" readonly></textarea>
                    </div>
                    <div style="display:flex; gap:1rem; margin-top:1rem;">
                        <button class="btn btn-primary" onclick="app.copy('b64-output')">å¤åˆ¶ç»“æœ</button>
                        <button class="btn btn-secondary" onclick="base64Tool.copyAsCSS()">å¤åˆ¶ä¸º CSS</button>
                        <button class="btn btn-secondary" onclick="base64Tool.copyAsHTML()">å¤åˆ¶ä¸º HTML img</button>
                    </div>
                    <div style="margin-top:1rem; text-align:center;">
                        <img id="b64-preview-img" style="max-width:100%; max-height:200px; border-radius:var(--radius-md); box-shadow:0 4px 10px rgba(0,0,0,0.3);">
                        <div id="b64-file-info" style="font-size:0.8rem; color:var(--text-dim); margin-top:0.5rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Base64 to Image -->
            <div id="view-to-image" class="tab-content hidden">
                <div class="input-row">
                    <label>Base64 å­—ç¬¦ä¸²</label>
                    <textarea id="b64-input" spellcheck="false" placeholder="ç²˜è´´ Base64 å­—ç¬¦ä¸²..." style="width:100%; height:150px; background:rgba(0,0,0,0.2); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-main); padding:0.8rem; resize:vertical;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="base64Tool.decode()" style="margin-top:1rem;">è§£ç å¹¶é¢„è§ˆ</button>
                
                <div id="decode-result-area" style="display:none; margin-top:1.5rem; text-align:center;">
                    <img id="decode-preview-img" style="max-width:100%; max-height:300px; border-radius:var(--radius-md); box-shadow:0 4px 10px rgba(0,0,0,0.3);">
                    <div style="margin-top:1rem;">
                        <button class="btn btn-secondary" onclick="base64Tool.download()">ä¸‹è½½å›¾ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>
    <script src="../js/app.js"></script>
    <script>
        function switchSubTab(tab, el) {
            document.querySelectorAll('.sub-tab-group .sub-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            
            document.getElementById('tab-format').style.display = tab === 'format' ? 'block' : 'none';
            document.getElementById('tab-resize').style.display = tab === 'resize' ? 'block' : 'none';
            document.getElementById('tab-base64').style.display = tab === 'base64' ? 'block' : 'none';
        }

        const resizeTool = {
            currentFile: null,
            currentImage: null,
            ratio: 1,
            blobUrl: null,

            init: function() {
                const dropZone = document.getElementById('resize-drop-zone');
                if (!dropZone) return;

                // Drag & Drop
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    this.handleFile(e.dataTransfer.files[0]);
                });

                // Input Listeners
                const widthInput = document.getElementById('resize-width');
                const heightInput = document.getElementById('resize-height');
                const lockInput = document.getElementById('resize-lock');
                const formatSelect = document.getElementById('resize-format');
                const qualityInput = document.getElementById('resize-quality');

                widthInput.addEventListener('input', () => {
                    if (lockInput.checked && widthInput.value && this.ratio) {
                        heightInput.value = Math.round(Number(widthInput.value) / this.ratio);
                    }
                });

                heightInput.addEventListener('input', () => {
                    if (lockInput.checked && heightInput.value && this.ratio) {
                        widthInput.value = Math.round(Number(heightInput.value) * this.ratio);
                    }
                });
                
                // Show quality slider for JPEG/WEBP
                formatSelect.addEventListener('change', () => {
                    const fmt = formatSelect.value;
                    const wrapper = document.getElementById('resize-quality-wrapper');
                    if (fmt === 'image/jpeg' || fmt === 'image/webp') {
                        wrapper.style.display = 'block';
                    } else {
                        wrapper.style.display = 'none';
                    }
                });

                qualityInput.addEventListener('input', (e) => {
                    document.getElementById('resize-quality-val').textContent = e.target.value;
                });
            },

            handleFile: function(file) {
                if (!file || !file.type.startsWith('image/')) {
                    app.showToast('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
                    return;
                }

                this.currentFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentImage = new Image();
                    this.currentImage.onload = () => {
                        this.ratio = this.currentImage.naturalWidth / this.currentImage.naturalHeight;
                        
                        // Update UI
                        document.getElementById('original-size').textContent = `${this.currentImage.naturalWidth} x ${this.currentImage.naturalHeight}`;
                        document.getElementById('resize-width').value = this.currentImage.naturalWidth;
                        document.getElementById('resize-height').value = this.currentImage.naturalHeight;
                        
                        // Reset preview
                        const container = document.getElementById('resize-preview-container');
                        container.innerHTML = '';
                        const img = this.currentImage.cloneNode();
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '100%';
                        container.appendChild(img);
                        
                        document.getElementById('resize-workspace').style.display = 'block';
                        document.getElementById('resize-download-btn').disabled = true; // Need to process first
                    };
                    this.currentImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            },

            process: function() {
                if (!this.currentImage) return;

                const width = parseInt(document.getElementById('resize-width').value);
                const height = parseInt(document.getElementById('resize-height').value);
                const format = document.getElementById('resize-format').value;
                const quality = parseFloat(document.getElementById('resize-quality').value);

                if (!width || !height) {
                    app.showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å®½é«˜', 'error');
                    return;
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                // Handle transparent background for JPEG
                if (format === 'image/jpeg') {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, width, height);
                }
                
                ctx.drawImage(this.currentImage, 0, 0, width, height);

                canvas.toBlob((blob) => {
                    if (!blob) {
                        app.showToast('å¤„ç†å¤±è´¥', 'error');
                        return;
                    }
                    
                    if (this.blobUrl) URL.revokeObjectURL(this.blobUrl);
                    this.blobUrl = URL.createObjectURL(blob);
                    
                    const container = document.getElementById('resize-preview-container');
                    container.innerHTML = '';
                    const img = new Image();
                    img.src = this.blobUrl;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    container.appendChild(img);
                    
                    document.getElementById('resize-download-btn').disabled = false;
                    app.showToast('å›¾ç‰‡å·²ç”Ÿæˆ');
                }, format, quality);
            },

            download: function() {
                if (!this.blobUrl) return;
                
                const format = document.getElementById('resize-format').value;
                const ext = format.split('/')[1];
                const link = document.createElement('a');
                link.download = `resized_${Date.now()}.${ext}`;
                link.href = this.blobUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        const base64Tool = {
            currentMode: 'toBase64',
            currentMime: '',
            
            init: function() {
                const dropZone = document.getElementById('b64-drop-zone');
                if(!dropZone) return;
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    this.handleFile(e.dataTransfer.files[0]);
                });
            },
            
            switchMode: function(mode) {
                this.currentMode = mode;
                // Update buttons
                const btn1 = document.getElementById('mode-to-base64');
                const btn2 = document.getElementById('mode-to-image');
                
                if (mode === 'toBase64') {
                    btn1.classList.add('active');
                    btn2.classList.remove('active');
                } else {
                    btn1.classList.remove('active');
                    btn2.classList.add('active');
                }
                
                // Animate views
                const view1 = document.getElementById('view-to-base64');
                const view2 = document.getElementById('view-to-image');
                
                // Fade out current visible one? No, just toggle classes
                // Simple fade switch
                if (mode === 'toBase64') {
                    view2.classList.add('hidden');
                    setTimeout(() => {
                        view2.style.display = 'none';
                        view1.style.display = 'block';
                        // Small delay to allow display block to apply before removing opacity class
                        requestAnimationFrame(() => {
                            view1.classList.remove('hidden');
                        });
                    }, 300); // Match CSS transition time
                } else {
                    view1.classList.add('hidden');
                    setTimeout(() => {
                        view1.style.display = 'none';
                        view2.style.display = 'block';
                        requestAnimationFrame(() => {
                            view2.classList.remove('hidden');
                        });
                    }, 300);
                }
            },

            handleFile: function(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const res = e.target.result;
                    document.getElementById('b64-output').value = res;
                    document.getElementById('b64-preview-img').src = res;
                    document.getElementById('b64-file-info').innerText = `${file.name} (${(file.size/1024).toFixed(2)} KB)`;
                    document.getElementById('b64-result-area').style.display = 'block';
                    this.currentMime = res.split(';')[0].split(':')[1];
                };
                reader.readAsDataURL(file);
            },

            copyAsCSS: function() {
                const b64 = document.getElementById('b64-output').value;
                if(!b64) return;
                const css = `background-image: url('${b64}');`;
                this.copyToClip(css, 'CSS å·²å¤åˆ¶');
            },

            copyAsHTML: function() {
                const b64 = document.getElementById('b64-output').value;
                if(!b64) return;
                const html = `<img src="${b64}" alt="image" />`;
                this.copyToClip(html, 'HTML img æ ‡ç­¾å·²å¤åˆ¶');
            },

            decode: function() {
                let val = document.getElementById('b64-input').value.trim();
                if(!val) {
                    app.showToast('è¯·è¾“å…¥ Base64 å­—ç¬¦ä¸²');
                    return;
                }
                
                // Add prefix if missing (simple check)
                if(!val.startsWith('data:image')) {
                    // Try to guess or just let browser handle it if it's raw base64
                    // If raw base64, we might need to know mime type or try common ones
                    // For now, assume user might paste full Data URI or raw.
                    // If raw, try adding png prefix as fallback
                    if(!val.includes(',')) {
                         val = 'data:image/png;base64,' + val;
                    }
                }

                const img = document.getElementById('decode-preview-img');
                img.src = val;
                img.onload = () => {
                    document.getElementById('decode-result-area').style.display = 'block';
                };
                img.onerror = () => {
                    app.showToast('è§£ç å¤±è´¥ï¼Œæ— æ•ˆçš„ Base64 å›¾ç‰‡æ•°æ®');
                };
            },

            download: function() {
                const src = document.getElementById('decode-preview-img').src;
                if(!src) return;
                
                const link = document.createElement('a');
                link.download = 'decoded-image.png'; // Default name
                link.href = src;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            
            copyToClip: function(text, msg) {
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                app.showToast(msg);
            }
        };

        const imgConverter = {
            files: [],
            
            init: function() {
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');

                if(!dropZone) return;

                // Drag & Drop
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    this.handleFiles(e.dataTransfer.files);
                });

                // File Input
                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                    fileInput.value = ''; // Reset
                });
            },

            handleFiles: function(fileList) {
                Array.from(fileList).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const fileObj = {
                                id: Date.now() + Math.random().toString(16).slice(2),
                                file: file,
                                src: e.target.result,
                                convertedSrc: null
                            };
                            this.files.push(fileObj);
                            this.renderItem(fileObj);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        app.showToast('è·³è¿‡éå›¾ç‰‡æ–‡ä»¶: ' + file.name, 'error');
                    }
                });
            },

            renderItem: function(item) {
                const list = document.getElementById('preview-list');
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.id = 'item-' + item.id;
                div.innerHTML = `
                    <img src="${item.src}" class="preview-img">
                    <div class="file-info" title="${item.file.name}">${item.file.name}</div>
                    <div class="file-info">${(item.file.size / 1024).toFixed(1)} KB</div>
                    <div class="action-row">
                        <span class="status-badge" style="font-size: 0.8rem; color: var(--secondary);">å¾…è½¬æ¢</span>
                        <button class="btn btn-icon btn-sm" onclick="imgConverter.removeItem('${item.id}')" title="åˆ é™¤">âœ•</button>
                    </div>
                `;
                list.appendChild(div);
            },

            removeItem: function(id) {
                this.files = this.files.filter(f => f.id !== id);
                document.getElementById('item-' + id).remove();
            },

            clearAll: function() {
                this.files = [];
                document.getElementById('preview-list').innerHTML = '';
            },

            convertAll: function() {
                if(this.files.length === 0) {
                    app.showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                    return;
                }

                const format = document.getElementById('target-format').value;
                const quality = parseFloat(document.getElementById('target-quality').value);
                
                let processed = 0;
                
                this.files.forEach(item => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        // Handle transparent background for JPEG (fill white)
                        if (format === 'image/jpeg') {
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                        }
                        
                        ctx.drawImage(img, 0, 0);
                        
                        const convertedDataUrl = canvas.toDataURL(format, quality);
                        item.convertedSrc = convertedDataUrl;
                        
                        // Update UI
                        const el = document.getElementById('item-' + item.id);
                        if (el) {
                            const ext = format.split('/')[1];
                            const badge = el.querySelector('.status-badge');
                            badge.innerText = 'å·²å®Œæˆ';
                            badge.style.color = 'var(--primary)';
                            
                            // Add download button if not exists
                            if (!el.querySelector('.btn-download')) {
                                const btn = document.createElement('button');
                                btn.className = 'btn btn-secondary btn-sm btn-download';
                                btn.innerText = `ä¸‹è½½ .${ext}`;
                                btn.style.marginTop = '0.5rem';
                                btn.onclick = () => this.download(item, ext);
                                el.appendChild(btn);
                            }
                        }
                        
                        processed++;
                        if(processed === this.files.length) {
                            app.showToast('æ‰€æœ‰å›¾ç‰‡è½¬æ¢å®Œæˆ');
                        }
                    };
                    img.src = item.src;
                });
            },
            
            download: function(item, ext) {
                const link = document.createElement('a');
                link.download = item.file.name.split('.')[0] + '_converted.' + ext;
                link.href = item.convertedSrc;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // Initialize
        window.onload = function() {
             imgConverter.init();
             base64Tool.init();
             resizeTool.init();
        };
    </script>
</body>
</html>