<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡é‡å åˆæˆå·¥å…·</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Override global style.css lock */
        body {
            height: auto !important;
            overflow-y: auto !important;
            overflow-x: hidden;
        }
        
        /* Local overrides */
        .preview-thumb {
            max-width: 100%;
            max-height: 120px;
            object-fit: contain;
            border-radius: 4px;
            margin-top: 10px;
            display: none; /* Hidden by default until loaded */
        }
        .upload-area {
            padding: 1rem;
            min-height: 100px;
        }

        /* Mobile Scroll & Layout Fix */
        @media (max-width: 768px) {
            body {
                height: auto !important;
                overflow-y: auto !important;
                display: block !important;
            }
            .layout-sidebar {
                height: auto !important;
                overflow: visible !important;
                display: flex !important;
                flex-direction: column;
            }
            .preview-area {
                min-height: 400px;
            }
            .controls.panel {
                width: 100% !important;
                max-width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <div class="layout-sidebar">
        <!-- Controls Panel -->
        <div class="controls panel">
            <h2 style="margin:0 0 10px 0; color:var(--primary); font-size:1.5rem;">å›¾ç‰‡åˆæˆ</h2>
            <p style="font-size:0.85rem; color:var(--text-dim); margin-bottom:15px;">
                é€‰æ‹©ä¸¤å¼ å›¾ç‰‡ï¼Œè°ƒæ•´é€æ˜åº¦å’Œæ··åˆæ¨¡å¼ã€‚
            </p>
            
            <!-- Upload 1 -->
            <div class="control-group">
                <label>1. åº•å±‚å›¾ç‰‡ (Base)</label>
                <div class="upload-area" id="uploadArea1" onclick="document.getElementById('image1').click()">
                    <i class="fas fa-image" style="font-size: 1.5rem; color: var(--text-dim);"></i>
                    <div class="upload-text" style="font-size: 0.8rem; color: var(--text-dim);">ç‚¹å‡»ä¸Šä¼ </div>
                    <img id="preview1" class="preview-thumb">
                    <input type="file" id="image1" accept="image/*" hidden>
                </div>
            </div>

            <!-- Upload 2 -->
            <div class="control-group">
                <label>2. ä¸Šå±‚å›¾ç‰‡ (Overlay)</label>
                <div class="upload-area" id="uploadArea2" onclick="document.getElementById('image2').click()">
                    <i class="fas fa-layer-group" style="font-size: 1.5rem; color: var(--text-dim);"></i>
                    <div class="upload-text" style="font-size: 0.8rem; color: var(--text-dim);">ç‚¹å‡»ä¸Šä¼ </div>
                    <img id="preview2" class="preview-thumb">
                    <input type="file" id="image2" accept="image/*" hidden>
                </div>
            </div>

            <!-- Settings -->
            <div class="control-group">
                <label>ä¸Šå±‚é€æ˜åº¦: <span id="opacityValue" style="color: var(--primary); margin-left: auto;">50%</span></label>
                <input type="range" id="opacity" min="0" max="100" value="50" style="width:100%">
            </div>
            
            <div class="control-group">
                <label>æ··åˆæ¨¡å¼</label>
                <select id="blendMode" style="width:100%">
                    <option value="normal">æ­£å¸¸ (Normal)</option>
                    <option value="difference">å·®å€¼ (Difference)</option>
                    <option value="multiply">æ­£ç‰‡å åº• (Multiply)</option>
                    <option value="screen">æ»¤è‰² (Screen)</option>
                </select>
                <div id="modeInfo" style="font-size:0.8rem; color:var(--text-dim); margin-top:5px; padding:5px; background:rgba(255,255,255,0.05); border-radius:4px;">
                    æ­£å¸¸æ¨¡å¼ï¼šä¸Šå±‚å›¾ç‰‡æŒ‰é€æ˜åº¦å åŠ åœ¨åº•å±‚å›¾ç‰‡ä¸Š
                </div>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 10px; margin-top: auto; flex-direction: column;">
                <button id="combine" class="btn btn-primary" disabled>âš¡ åˆæˆå›¾ç‰‡</button>
                <button id="download" class="btn btn-success" disabled>ğŸ’¾ ä¸‹è½½ç»“æœ</button>
                <button id="reset" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
            </div>
        </div>

        <!-- Result Area -->
        <div class="preview-area">
            <div id="placeholder" style="color:var(--text-dim); text-align:center;">
                <i class="fas fa-magic" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <div>è¯·ä¸Šä¼ ä¸¤å¼ å›¾ç‰‡å¹¶ç‚¹å‡»åˆæˆ</div>
            </div>
            <canvas id="resultCanvas" class="canvas-responsive" style="display:none; border-radius: var(--radius-md); box-shadow: var(--shadow);"></canvas>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const image1Input = document.getElementById('image1');
            const image2Input = document.getElementById('image2');
            const preview1 = document.getElementById('preview1');
            const preview2 = document.getElementById('preview2');
            const opacitySlider = document.getElementById('opacity');
            const opacityValue = document.getElementById('opacityValue');
            const blendModeSelect = document.getElementById('blendMode');
            const modeInfo = document.getElementById('modeInfo');
            const combineBtn = document.getElementById('combine');
            const downloadBtn = document.getElementById('download');
            const resetBtn = document.getElementById('reset');
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            const placeholder = document.getElementById('placeholder');
            
            let image1 = null;
            let image2 = null;
            
            // æ··åˆæ¨¡å¼è¯´æ˜
            const modeDescriptions = {
                normal: "æ­£å¸¸æ¨¡å¼ï¼šä¸Šå±‚å›¾ç‰‡æŒ‰é€æ˜åº¦å åŠ åœ¨åº•å±‚å›¾ç‰‡ä¸Š",
                difference: "å·®å€¼æ¨¡å¼ï¼šè®¡ç®—ä¸¤å¼ å›¾ç‰‡é¢œè‰²å€¼çš„ç»å¯¹å·®å¼‚ï¼Œäº§ç”Ÿé«˜å¯¹æ¯”åº¦æ•ˆæœ",
                multiply: "æ­£ç‰‡å åº•æ¨¡å¼ï¼šå°†ä¸¤å¼ å›¾ç‰‡çš„é¢œè‰²å€¼ç›¸ä¹˜ï¼Œé€šå¸¸ä¼šä½¿å›¾åƒå˜æš—",
                screen: "æ»¤è‰²æ¨¡å¼ï¼šå°†ä¸¤å¼ å›¾ç‰‡çš„é¢œè‰²å€¼åè½¬åç›¸ä¹˜å†åè½¬ï¼Œé€šå¸¸ä¼šä½¿å›¾åƒå˜äº®"
            };
            
            // ç›‘å¬æ··åˆæ¨¡å¼é€‰æ‹©å˜åŒ–
            blendModeSelect.addEventListener('change', function() {
                modeInfo.textContent = modeDescriptions[this.value];
            });
            
            // ç›‘å¬å›¾ç‰‡1ä¸Šä¼ 
            image1Input.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview1.src = e.target.result;
                        preview1.style.display = 'block';
                        // Hide text/icon in upload area to clean up
                        document.querySelector('#uploadArea1 .upload-text').style.display = 'none';
                        document.querySelector('#uploadArea1 i').style.display = 'none';
                        
                        image1 = new Image();
                        image1.src = e.target.result;
                        image1.onload = function() {
                            if (image1 && image2) combineBtn.disabled = false;
                        };
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // ç›‘å¬å›¾ç‰‡2ä¸Šä¼ 
            image2Input.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview2.src = e.target.result;
                        preview2.style.display = 'block';
                        document.querySelector('#uploadArea2 .upload-text').style.display = 'none';
                        document.querySelector('#uploadArea2 i').style.display = 'none';
                        
                        image2 = new Image();
                        image2.src = e.target.result;
                        image2.onload = function() {
                            if (image1 && image2) combineBtn.disabled = false;
                        };
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // æ›´æ–°é€æ˜åº¦å€¼æ˜¾ç¤º
            opacitySlider.addEventListener('input', function() {
                opacityValue.textContent = this.value + '%';
            });
            
            // åˆæˆå›¾ç‰‡
            combineBtn.addEventListener('click', function() {
                if (!image1 || !image2) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸¤å¼ å›¾ç‰‡ï¼');
                    return;
                }
                
                placeholder.style.display = 'none';
                canvas.style.display = 'block';
                
                // è®¾ç½®canvaså°ºå¯¸ä¸ºç¬¬ä¸€å¼ å›¾ç‰‡çš„å°ºå¯¸
                canvas.width = image1.width;
                canvas.height = image1.height;
                
                // æ¸…é™¤canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // è·å–æ··åˆæ¨¡å¼
                const blendMode = blendModeSelect.value;
                const opacity = opacitySlider.value / 100;
                
                // æ ¹æ®æ··åˆæ¨¡å¼è¿›è¡Œä¸åŒçš„åˆæˆå¤„ç†
                if (blendMode === 'normal') {
                    // æ­£å¸¸æ¨¡å¼
                    ctx.drawImage(image1, 0, 0, canvas.width, canvas.height);
                    ctx.globalAlpha = opacity;
                    ctx.drawImage(image2, 0, 0, canvas.width, canvas.height);
                    ctx.globalAlpha = 1.0;
                } else {
                    // å…¶ä»–æ··åˆæ¨¡å¼éœ€è¦æ‰‹åŠ¨è®¡ç®—åƒç´ 
                    applyBlendMode(blendMode, opacity);
                }
                
                // å¯ç”¨ä¸‹è½½æŒ‰é’®
                downloadBtn.disabled = false;
            });
            
            // åº”ç”¨æ··åˆæ¨¡å¼
            function applyBlendMode(mode, opacity) {
                // åˆ›å»ºä¸´æ—¶canvasç”¨äºå¤„ç†å›¾åƒæ•°æ®
                const tempCanvas1 = document.createElement('canvas');
                const tempCtx1 = tempCanvas1.getContext('2d');
                tempCanvas1.width = canvas.width;
                tempCanvas1.height = canvas.height;
                
                const tempCanvas2 = document.createElement('canvas');
                const tempCtx2 = tempCanvas2.getContext('2d');
                tempCanvas2.width = canvas.width;
                tempCanvas2.height = canvas.height;
                
                // ç»˜åˆ¶å›¾ç‰‡åˆ°ä¸´æ—¶canvas
                tempCtx1.drawImage(image1, 0, 0, canvas.width, canvas.height);
                tempCtx2.drawImage(image2, 0, 0, canvas.width, canvas.height);
                
                // è·å–å›¾åƒæ•°æ®
                const imageData1 = tempCtx1.getImageData(0, 0, canvas.width, canvas.height);
                const imageData2 = tempCtx2.getImageData(0, 0, canvas.width, canvas.height);
                const data1 = imageData1.data;
                const data2 = imageData2.data;
                
                // åˆ›å»ºç»“æœå›¾åƒæ•°æ®
                const resultData = ctx.createImageData(canvas.width, canvas.height);
                const result = resultData.data;
                
                // åº”ç”¨æ··åˆæ¨¡å¼
                for (let i = 0; i < data1.length; i += 4) {
                    const r1 = data1[i];
                    const g1 = data1[i + 1];
                    const b1 = data1[i + 2];
                    const a1 = data1[i + 3];
                    
                    const r2 = data2[i];
                    const g2 = data2[i + 1];
                    const b2 = data2[i + 2];
                    const a2 = data2[i + 3];
                    
                    let r, g, b;
                    
                    switch (mode) {
                        case 'difference':
                            // å·®å€¼æ¨¡å¼ï¼š|åº•å±‚é¢œè‰² - ä¸Šå±‚é¢œè‰²|
                            r = Math.abs(r1 - r2);
                            g = Math.abs(g1 - g2);
                            b = Math.abs(b1 - b2);
                            break;
                        case 'multiply':
                            // æ­£ç‰‡å åº•æ¨¡å¼ï¼šåº•å±‚é¢œè‰² Ã— ä¸Šå±‚é¢œè‰² / 255
                            r = (r1 * r2) / 255;
                            g = (g1 * g2) / 255;
                            b = (b1 * b2) / 255;
                            break;
                        case 'screen':
                            // æ»¤è‰²æ¨¡å¼ï¼š255 - ((255 - åº•å±‚é¢œè‰²) Ã— (255 - ä¸Šå±‚é¢œè‰²)) / 255
                            r = 255 - ((255 - r1) * (255 - r2)) / 255;
                            g = 255 - ((255 - g1) * (255 - g2)) / 255;
                            b = 255 - ((255 - b1) * (255 - b2)) / 255;
                            break;
                        default:
                            r = r1;
                            g = g1;
                            b = b1;
                    }
                    
                    // åº”ç”¨é€æ˜åº¦æ··åˆ: result = blend * opacity + base * (1 - opacity)
                    // æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾åº•å±‚å›¾ç‰‡æ˜¯ä¸é€æ˜çš„
                    
                    const blendedR = Math.round(r * opacity + r1 * (1 - opacity));
                    const blendedG = Math.round(g * opacity + g1 * (1 - opacity));
                    const blendedB = Math.round(b * opacity + b1 * (1 - opacity));
                    
                    result[i] = blendedR;
                    result[i + 1] = blendedG;
                    result[i + 2] = blendedB;
                    result[i + 3] = 255; // Alpha
                }
                
                // å°†ç»“æœç»˜åˆ¶å›ä¸»canvas
                ctx.putImageData(resultData, 0, 0);
            }
            
            // ä¸‹è½½å›¾ç‰‡
            downloadBtn.addEventListener('click', function() {
                const link = document.createElement('a');
                link.download = 'merged-image.png';
                link.href = canvas.toDataURL();
                link.click();
            });
            
            // é‡ç½®
            resetBtn.addEventListener('click', function() {
                image1 = null;
                image2 = null;
                image1Input.value = '';
                image2Input.value = '';
                
                preview1.src = "";
                preview1.style.display = 'none';
                document.querySelector('#uploadArea1 .upload-text').style.display = 'block';
                document.querySelector('#uploadArea1 i').style.display = 'block';
                
                preview2.src = "";
                preview2.style.display = 'none';
                document.querySelector('#uploadArea2 .upload-text').style.display = 'block';
                document.querySelector('#uploadArea2 i').style.display = 'block';
                
                combineBtn.disabled = true;
                downloadBtn.disabled = true;
                
                canvas.style.display = 'none';
                placeholder.style.display = 'block';
                
                opacitySlider.value = 50;
                opacityValue.textContent = '50%';
                blendModeSelect.value = 'normal';
                modeInfo.textContent = modeDescriptions['normal'];
            });
        });
    </script>
</body>
</html>
