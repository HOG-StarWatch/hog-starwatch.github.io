<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD / HTML ËΩ¨Êç¢</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-container {
            background: var(--bg-panel);
            width: 800px;
            max-width: 90%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }
        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-weight: bold; font-size: 1.1rem; }
        .modal-close { cursor: pointer; font-size: 1.5rem; line-height: 1; }
        .modal-body {
            padding: 1rem;
            overflow-y: auto;
        }
        .entity-section { margin-bottom: 1.5rem; }
        .entity-section-title {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
        }
        .entity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }
        .entity-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            padding: 6px;
            border-radius: 4px;
            background: rgba(0,0,0,0.1);
        }
        .entity-char {
            width: 32px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .entity-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .entity-codes {
            display: flex;
            gap: 8px;
            font-family: monospace;
            color: var(--secondary);
            font-size: 0.75rem;
        }
        .entity-desc {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="workspace">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Markdown / Ê∫êÁ†Å</div>
                <div class="panel-actions">
                    <div class="file-upload btn btn-icon" style="overflow:hidden">
                        <span>üìÇ ‰∏ä‰º†MD</span>
                        <input type="file" accept=".md,.txt" onchange="mdTool.loadFile(this)">
                    </div>
                    <div class="file-upload btn btn-icon" style="overflow:hidden">
                        <span>üìÇ ÂØºÂÖ•WordËΩ¨MD</span>
                        <input type="file" accept=".docx" onchange="mdTool.importWord(this)">
                    </div>
                    <button class="btn btn-icon" onclick="app.clear('md')">Ê∏ÖÁ©∫</button>
                </div>
            </div>
            <textarea id="md-input" placeholder="# Ê†áÈ¢ò&#10;**Âä†Á≤ó**&#10;- ÂàóË°®..."></textarea>
        </div>

        <div class="toolbar">
            <div class="tool-group">
                <div class="group-label">ËΩ¨Êç¢</div>
                <button class="btn btn-primary" onclick="mdTool.toHtml()">ËΩ¨ HTML ‚Üí</button>
                <button class="btn btn-primary" onclick="mdTool.toMd()">ËΩ¨ MD ‚Üí</button>
            </div>
            <div class="tool-group">
                <div class="group-label">ÂºïÊìé</div>
                <select id="md-engine" onchange="mdTool.onEngineChange()" style="font-size:0.8rem; padding:4px;">
                    <option value="js">JavaScript (Regex)</option>
                    <option value="wasm">WebAssembly (High Perf)</option>
                </select>
                <div id="engine-status" style="font-size:0.75rem; color:var(--text-dim); display:none;">
                    Wasm Loaded
                </div>
            </div>
            <div class="tool-group">
                <div class="group-label">ÈÄâÈ°π</div>
                <label style="font-size:0.8rem; display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="md-escape" checked> ËΩ¨‰πâÁâπÊÆäÂ≠óÁ¨¶
                </label>
            </div>
            <div class="tool-group">
                <div class="group-label">Ê†áÁ≠æÂØπÁÖßË°®</div>
                <div style="font-size:0.75rem; color:var(--text-dim); display:grid; grid-template-columns: 1fr 1fr; gap:4px; max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:5px; border-radius:4px;">
                    <span style="color:var(--secondary)"># H1</span> <span>&lt;h1&gt;</span>
                    <span style="color:var(--secondary)">## H2</span> <span>&lt;h2&gt;</span>
                    <span style="color:var(--secondary)">### H3</span> <span>&lt;h3&gt;</span>
                    <span style="color:var(--secondary)">**Bold**</span> <span>&lt;b&gt;</span>
                    <span style="color:var(--secondary)">*Italic*</span> <span>&lt;i&gt;</span>
                    <span style="color:var(--secondary)">> Quote</span> <span>&lt;blockquote&gt;</span>
                    <span style="color:var(--secondary)">`Code`</span> <span>&lt;code&gt;</span>
                    <span style="color:var(--secondary)">```Pre```</span> <span>&lt;pre&gt;</span>
                    <span style="color:var(--secondary)">[Txt](Url)</span> <span>&lt;a&gt;</span>
                    <span style="color:var(--secondary)">---</span> <span>&lt;hr&gt;</span>
                    <span style="color:var(--secondary)">\n\n</span> <span>&lt;br&gt;</span>
                </div>
            </div>
            <div class="tool-group">
                <div class="group-label">Â∏∏Áî®Á¨¶Âè∑ÂØπÁÖßË°®</div>
                <div style="font-size:0.75rem; color:var(--text-dim); display:grid; grid-template-columns: 1fr; gap:4px; max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:5px; border-radius:4px;">
                    <div style="display:flex; justify-content:space-between;"><span>&lt;</span> <span>&amp;lt; / &amp;#60;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>&gt;</span> <span>&amp;gt; / &amp;#62;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>&amp;</span> <span>&amp;amp; / &amp;#38;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>&quot;</span> <span>&amp;quot; / &amp;#34;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Space</span> <span>&amp;nbsp; / &amp;#160;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>¬©</span> <span>&amp;copy; / &amp;#169;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>¬Æ</span> <span>&amp;reg; / &amp;#174;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>‚Ñ¢</span> <span>&amp;trade; / &amp;#8482;</span></div>
                </div>
                <button class="btn btn-secondary btn-sm" style="margin-top:5px; width:100%" onclick="mdTool.showEntityModal()">Êü•ÁúãÂÆåÊï¥ÂàóË°®</button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">ÁªìÊûú</div>
                <div class="panel-actions">
                    <button class="btn btn-icon btn-secondary" onclick="app.copy('md-output')">Â§çÂà∂‰ª£Á†Å</button>
                    <button class="btn btn-icon" onclick="mdTool.preview()">È¢ÑËßà</button>
                </div>
            </div>
            <textarea id="md-output" placeholder="<h1...>ÁªìÊûú..."></textarea>
        </div>
    </div>

    <div id="toast" class="toast">Êìç‰ΩúÊàêÂäü</div>
    
    <!-- Entity List Modal -->
    <div id="entity-modal" class="modal-overlay" onclick="if(event.target===this) mdTool.closeEntityModal()">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">HTML ÂÆû‰ΩìÁ¨¶Âè∑ÂÆåÊï¥ÂàóË°®</div>
                <div class="modal-close" onclick="mdTool.closeEntityModal()">&times;</div>
            </div>
            <div class="modal-body" id="entity-list-body">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <script src="../js/loader.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Register markdown-wasm in loader (custom manual registration if not in loader.js)
        // Or we can just load it dynamically here.
        // Let's assume ResourceLoader handles standard libs, but for wasm we might need direct handling or custom loader entry.
        // Since we didn't add markdown-wasm to loader.js registry, we'll handle it here or update loader.js? 
        // Updating loader.js is better practice but for now direct import/script is fine if we handle fallback.
        // Actually, let's just add it to the script tags dynamically if needed.
        
        let wasmModule = null;

        const ENTITY_DATA = [
            {
                category: "Êï∞Â≠¶Á¨¶Âè∑ (Math)",
                items: [
                    { char: '‚àÄ', name: '&forall;', code: '&#8704;', desc: 'for all / ÂÖ®Áß∞ÈáèËØç' },
                    { char: '‚àÇ', name: '&part;', code: '&#8706;', desc: 'partial differential / ÂÅèÂæÆÂàÜ' },
                    { char: '‚àÉ', name: '&exist;', code: '&#8707;', desc: 'exists / Â≠òÂú®ÈáèËØç' },
                    { char: '‚àÖ', name: '&empty;', code: '&#8709;', desc: 'empty set / Á©∫ÈõÜ' },
                    { char: '‚àá', name: '&nabla;', code: '&#8711;', desc: 'nabla / ÂÄí‰∏âËßíÁÆóÂ≠ê' },
                    { char: '‚àà', name: '&isin;', code: '&#8712;', desc: 'element of / Â±û‰∫é' },
                    { char: '‚àâ', name: '&notin;', code: '&#8713;', desc: 'not an element of / ‰∏çÂ±û‰∫é' },
                    { char: '‚àã', name: '&ni;', code: '&#8715;', desc: 'contains as member / ÂåÖÂê´' },
                    { char: '‚àè', name: '&prod;', code: '&#8719;', desc: 'n-ary product / ‰πòÁßØ' },
                    { char: '‚àë', name: '&sum;', code: '&#8721;', desc: 'n-ary summation / Ê±ÇÂíå' },
                    { char: '‚àí', name: '&minus;', code: '&#8722;', desc: 'minus sign / ÂáèÂè∑' },
                    { char: '‚àó', name: '&lowast;', code: '&#8727;', desc: 'asterisk operator / ÊòüÂè∑ËøêÁÆóÁ¨¶' },
                    { char: '‚àö', name: '&radic;', code: '&#8730;', desc: 'square root / Âπ≥ÊñπÊ†π' },
                    { char: '‚àù', name: '&prop;', code: '&#8733;', desc: 'proportional to / Ê≠£ÊØî‰∫é' },
                    { char: '‚àû', name: '&infin;', code: '&#8734;', desc: 'infinity / Êó†Á©∑Â§ß' },
                    { char: '‚à†', name: '&ang;', code: '&#8736;', desc: 'angle / Ëßí' },
                    { char: '‚àß', name: '&and;', code: '&#8743;', desc: 'logical and / ÈÄªËæë‰∏é' },
                    { char: '‚à®', name: '&or;', code: '&#8744;', desc: 'logical or / ÈÄªËæëÊàñ' },
                    { char: '‚à©', name: '&cap;', code: '&#8745;', desc: 'intersection / ‰∫§ÈõÜ' },
                    { char: '‚à™', name: '&cup;', code: '&#8746;', desc: 'union / Âπ∂ÈõÜ' },
                    { char: '‚à´', name: '&int;', code: '&#8747;', desc: 'integral / ÁßØÂàÜ' },
                    { char: '‚à¥', name: '&there4;', code: '&#8756;', desc: 'therefore / ÊâÄ‰ª•' },
                    { char: '‚àº', name: '&sim;', code: '&#8764;', desc: 'similar to / Áõ∏‰ºº' },
                    { char: '‚âÖ', name: '&cong;', code: '&#8773;', desc: 'congruent to / ÂÖ®Á≠â' },
                    { char: '‚âà', name: '&asymp;', code: '&#8776;', desc: 'almost equal to / Á∫¶Á≠â‰∫é' },
                    { char: '‚â†', name: '&ne;', code: '&#8800;', desc: 'not equal to / ‰∏çÁ≠â‰∫é' },
                    { char: '‚â°', name: '&equiv;', code: '&#8801;', desc: 'identical to / ÊÅíÁ≠â‰∫é' },
                    { char: '‚â§', name: '&le;', code: '&#8804;', desc: 'less-than or equal to / Â∞è‰∫éÁ≠â‰∫é' },
                    { char: '‚â•', name: '&ge;', code: '&#8805;', desc: 'greater-than or equal to / Â§ß‰∫éÁ≠â‰∫é' },
                    { char: '‚äÇ', name: '&sub;', code: '&#8834;', desc: 'subset of / ÁúüÂ≠êÈõÜ' },
                    { char: '‚äÉ', name: '&sup;', code: '&#8835;', desc: 'superset of / ÁúüË∂ÖÈõÜ' },
                    { char: '‚äÑ', name: '&nsub;', code: '&#8836;', desc: 'not a subset of / ÈùûÂ≠êÈõÜ' },
                    { char: '‚äÜ', name: '&sube;', code: '&#8838;', desc: 'subset of or equal to / Â≠êÈõÜ' },
                    { char: '‚äá', name: '&supe;', code: '&#8839;', desc: 'superset of or equal to / Ë∂ÖÈõÜ' },
                    { char: '‚äï', name: '&oplus;', code: '&#8853;', desc: 'circled plus / Áõ¥Âíå' },
                    { char: '‚äó', name: '&otimes;', code: '&#8855;', desc: 'circled times / Âº†ÈáèÁßØ' },
                    { char: '‚ä•', name: '&perp;', code: '&#8869;', desc: 'up tack / ÂûÇÁõ¥' },
                    { char: '‚ãÖ', name: '&sdot;', code: '&#8901;', desc: 'dot operator / ÁÇπ‰πò' }
                ]
            },
            {
                category: "Â∏åËÖäÂ≠óÊØç (Greek)",
                items: [
                    { char: 'Œë', name: '&Alpha;', code: '&#913;', desc: 'Capital Alpha' },
                    { char: 'Œí', name: '&Beta;', code: '&#914;', desc: 'Capital Beta' },
                    { char: 'Œì', name: '&Gamma;', code: '&#915;', desc: 'Capital Gamma' },
                    { char: 'Œî', name: '&Delta;', code: '&#916;', desc: 'Capital Delta' },
                    { char: 'Œï', name: '&Epsilon;', code: '&#917;', desc: 'Capital Epsilon' },
                    { char: 'Œñ', name: '&Zeta;', code: '&#918;', desc: 'Capital Zeta' },
                    { char: 'Œó', name: '&Eta;', code: '&#919;', desc: 'Capital Eta' },
                    { char: 'Œò', name: '&Theta;', code: '&#920;', desc: 'Capital Theta' },
                    { char: 'Œô', name: '&Iota;', code: '&#921;', desc: 'Capital Iota' },
                    { char: 'Œö', name: '&Kappa;', code: '&#922;', desc: 'Capital Kappa' },
                    { char: 'Œõ', name: '&Lambda;', code: '&#923;', desc: 'Capital Lambda' },
                    { char: 'Œú', name: '&Mu;', code: '&#924;', desc: 'Capital Mu' },
                    { char: 'Œù', name: '&Nu;', code: '&#925;', desc: 'Capital Nu' },
                    { char: 'Œû', name: '&Xi;', code: '&#926;', desc: 'Capital Xi' },
                    { char: 'Œü', name: '&Omicron;', code: '&#927;', desc: 'Capital Omicron' },
                    { char: 'Œ†', name: '&Pi;', code: '&#928;', desc: 'Capital Pi' },
                    { char: 'Œ°', name: '&Rho;', code: '&#929;', desc: 'Capital Rho' },
                    { char: 'Œ£', name: '&Sigma;', code: '&#931;', desc: 'Capital Sigma' },
                    { char: 'Œ§', name: '&Tau;', code: '&#932;', desc: 'Capital Tau' },
                    { char: 'Œ•', name: '&Upsilon;', code: '&#933;', desc: 'Capital Upsilon' },
                    { char: 'Œ¶', name: '&Phi;', code: '&#934;', desc: 'Capital Phi' },
                    { char: 'Œß', name: '&Chi;', code: '&#935;', desc: 'Capital Chi' },
                    { char: 'Œ®', name: '&Psi;', code: '&#936;', desc: 'Capital Psi' },
                    { char: 'Œ©', name: '&Omega;', code: '&#937;', desc: 'Capital Omega' },
                    { char: 'Œ±', name: '&alpha;', code: '&#945;', desc: 'Small alpha' },
                    { char: 'Œ≤', name: '&beta;', code: '&#946;', desc: 'Small beta' },
                    { char: 'Œ≥', name: '&gamma;', code: '&#947;', desc: 'Small gamma' },
                    { char: 'Œ¥', name: '&delta;', code: '&#948;', desc: 'Small delta' },
                    { char: 'Œµ', name: '&epsilon;', code: '&#949;', desc: 'Small epsilon' },
                    { char: 'Œ∂', name: '&zeta;', code: '&#950;', desc: 'Small zeta' },
                    { char: 'Œ∑', name: '&eta;', code: '&#951;', desc: 'Small eta' },
                    { char: 'Œ∏', name: '&theta;', code: '&#952;', desc: 'Small theta' },
                    { char: 'Œπ', name: '&iota;', code: '&#953;', desc: 'Small iota' },
                    { char: 'Œ∫', name: '&kappa;', code: '&#954;', desc: 'Small kappa' },
                    { char: 'Œª', name: '&lambda;', code: '&#955;', desc: 'Small lambda' },
                    { char: 'Œº', name: '&mu;', code: '&#956;', desc: 'Small mu' },
                    { char: 'ŒΩ', name: '&nu;', code: '&#957;', desc: 'Small nu' },
                    { char: 'Œæ', name: '&xi;', code: '&#958;', desc: 'Small xi' },
                    { char: 'Œø', name: '&omicron;', code: '&#959;', desc: 'Small omicron' },
                    { char: 'œÄ', name: '&pi;', code: '&#960;', desc: 'Small pi' },
                    { char: 'œÅ', name: '&rho;', code: '&#961;', desc: 'Small rho' },
                    { char: 'œÇ', name: '&sigmaf;', code: '&#962;', desc: 'Small final sigma' },
                    { char: 'œÉ', name: '&sigma;', code: '&#963;', desc: 'Small sigma' },
                    { char: 'œÑ', name: '&tau;', code: '&#964;', desc: 'Small tau' },
                    { char: 'œÖ', name: '&upsilon;', code: '&#965;', desc: 'Small upsilon' },
                    { char: 'œÜ', name: '&phi;', code: '&#966;', desc: 'Small phi' },
                    { char: 'œá', name: '&chi;', code: '&#967;', desc: 'Small chi' },
                    { char: 'œà', name: '&psi;', code: '&#968;', desc: 'Small psi' },
                    { char: 'œâ', name: '&omega;', code: '&#969;', desc: 'Small omega' },
                    { char: 'œë', name: '&thetasym;', code: '&#977;', desc: 'Theta symbol' },
                    { char: 'œí', name: '&upsih;', code: '&#978;', desc: 'Upsilon symbol' },
                    { char: 'œñ', name: '&piv;', code: '&#982;', desc: 'Pi symbol' }
                ]
            },
            {
                category: "ÂÖ∂‰ªñÂÆû‰Ωì (Other)",
                items: [
                    { char: '≈í', name: '&OElig;', code: '&#338;', desc: 'Capital ligature OE' },
                    { char: '≈ì', name: '&oelig;', code: '&#339;', desc: 'Small ligature oe' },
                    { char: '≈†', name: '&Scaron;', code: '&#352;', desc: 'Capital S with caron' },
                    { char: '≈°', name: '&scaron;', code: '&#353;', desc: 'Small s with caron' },
                    { char: '≈∏', name: '&Yuml;', code: '&#376;', desc: 'Capital Y with diaeresis' },
                    { char: '∆í', name: '&fnof;', code: '&#402;', desc: 'Latin small f with hook' },
                    { char: 'ÀÜ', name: '&circ;', code: '&#710;', desc: 'Modifier letter circumflex' },
                    { char: 'Àú', name: '&tilde;', code: '&#732;', desc: 'Small tilde' },
                    { char: '‚ÄÇ', name: '&ensp;', code: '&#8194;', desc: 'En space / ÂçäËßíÁ©∫Ê†º' },
                    { char: '‚ÄÉ', name: '&emsp;', code: '&#8195;', desc: 'Em space / ÂÖ®ËßíÁ©∫Ê†º' },
                    { char: '‚Äâ', name: '&thinsp;', code: '&#8201;', desc: 'Thin space / Á™ÑÁ©∫Ê†º' },
                    { char: '‚Äå', name: '&zwnj;', code: '&#8204;', desc: 'Zero width non-joiner / Èõ∂ÂÆΩ‰∏çËøûÂ≠ó' },
                    { char: '‚Äç', name: '&zwj;', code: '&#8205;', desc: 'Zero width joiner / Èõ∂ÂÆΩËøûÂ≠ó' },
                    { char: '‚Äé', name: '&lrm;', code: '&#8206;', desc: 'Left-to-right mark / Â∑¶Ëá≥Âè≥Ê†áËÆ∞' },
                    { char: '‚Äè', name: '&rlm;', code: '&#8207;', desc: 'Right-to-left mark / Âè≥Ëá≥Â∑¶Ê†áËÆ∞' },
                    { char: '‚Äì', name: '&ndash;', code: '&#8211;', desc: 'En dash / Áü≠Á†¥ÊäòÂè∑' },
                    { char: '‚Äî', name: '&mdash;', code: '&#8212;', desc: 'Em dash / ÈïøÁ†¥ÊäòÂè∑' },
                    { char: "'", name: '&lsquo;', code: '&#8216;', desc: 'Left single quote' },
                    { char: "'", name: '&rsquo;', code: '&#8217;', desc: 'Right single quote' },
                    { char: '‚Äö', name: '&sbquo;', code: '&#8218;', desc: 'Single low-9 quote' },
                    { char: '"', name: '&ldquo;', code: '&#8220;', desc: 'Left double quote' },
                    { char: '"', name: '&rdquo;', code: '&#8221;', desc: 'Right double quote' },
                    { char: '‚Äû', name: '&bdquo;', code: '&#8222;', desc: 'Double low-9 quote' },
                    { char: '‚Ä†', name: '&dagger;', code: '&#8224;', desc: 'Dagger / ÂâëÂè∑' },
                    { char: '‚Ä°', name: '&Dagger;', code: '&#8225;', desc: 'Double dagger / ÂèåÂâëÂè∑' },
                    { char: '‚Ä¢', name: '&bull;', code: '&#8226;', desc: 'Bullet / È°πÁõÆÁ¨¶Âè∑' },
                    { char: '‚Ä¶', name: '&hellip;', code: '&#8230;', desc: 'Horizontal ellipsis / ÁúÅÁï•Âè∑' },
                    { char: '‚Ä∞', name: '&permil;', code: '&#8240;', desc: 'Per mille sign / ÂçÉÂàÜÂè∑' },
                    { char: '‚Ä≤', name: '&prime;', code: '&#8242;', desc: 'Prime / ËßíÂàÜÁ¨¶Âè∑' },
                    { char: '‚Ä≥', name: '&Prime;', code: '&#8243;', desc: 'Double prime / ËßíÁßíÁ¨¶Âè∑' },
                    { char: '‚Äπ', name: '&lsaquo;', code: '&#8249;', desc: 'Single left-pointing angle quote' },
                    { char: '‚Ä∫', name: '&rsaquo;', code: '&#8250;', desc: 'Single right-pointing angle quote' },
                    { char: '‚Äæ', name: '&oline;', code: '&#8254;', desc: 'Overline / ‰∏äÂàíÁ∫ø' },
                    { char: '‚Ç¨', name: '&euro;', code: '&#8364;', desc: 'Euro sign / Ê¨ßÂÖÉÁ¨¶Âè∑' },
                    { char: '‚Ñ¢', name: '&trade;', code: '&#8482;', desc: 'Trade mark / ÂïÜÊ†áÁ¨¶Âè∑' },
                    { char: '‚Üê', name: '&larr;', code: '&#8592;', desc: 'Leftwards arrow' },
                    { char: '‚Üë', name: '&uarr;', code: '&#8593;', desc: 'Upwards arrow' },
                    { char: '‚Üí', name: '&rarr;', code: '&#8594;', desc: 'Rightwards arrow' },
                    { char: '‚Üì', name: '&darr;', code: '&#8595;', desc: 'Downwards arrow' },
                    { char: '‚Üî', name: '&harr;', code: '&#8596;', desc: 'Left right arrow' },
                    { char: '‚Üµ', name: '&crarr;', code: '&#8629;', desc: 'Carriage return arrow' },
                    { char: '‚åà', name: '&lceil;', code: '&#8968;', desc: 'Left ceiling' },
                    { char: '‚åâ', name: '&rceil;', code: '&#8969;', desc: 'Right ceiling' },
                    { char: '‚åä', name: '&lfloor;', code: '&#8970;', desc: 'Left floor' },
                    { char: '‚åã', name: '&rfloor;', code: '&#8971;', desc: 'Right floor' },
                    { char: '‚óä', name: '&loz;', code: '&#9674;', desc: 'Lozenge / Ëè±ÂΩ¢' },
                    { char: '‚ô†', name: '&spades;', code: '&#9824;', desc: 'Black spade suit / ÈªëÊ°É' },
                    { char: '‚ô£', name: '&clubs;', code: '&#9827;', desc: 'Black club suit / Ê¢ÖËä±' },
                    { char: '‚ô•', name: '&hearts;', code: '&#9829;', desc: 'Black heart suit / Á∫¢Ê°É' },
                    { char: '‚ô¶', name: '&diams;', code: '&#9830;', desc: 'Black diamond suit / ÊñπÂùó' }
                ]
            }
        ];

        const mdTool = {
            wasmLoaded: false,
            
            onEngineChange: function() {
                const engine = document.getElementById('md-engine').value;
                if(engine === 'wasm') {
                    this.loadWasm();
                }
            },

            loadWasm: function() {
                if(this.wasmLoaded) return;
                
                app.showToast('Ê≠£Âú®Âä†ËΩΩ WebAssembly Ê®°Âùó...', 'info');
                
                // Try ESM first
                ResourceLoader.import('markdown-wasm-esm').then(module => {
                    // ESM usually exports { parse, ready }
                    // Or default export.
                    // markdown-wasm esm export: export { parse, ready, ... }
                    if(module.ready) {
                        module.ready.then(() => {
                            window.markdown = module; // shim for existing code
                            this.onWasmReady();
                        });
                    } else {
                        // Maybe default export?
                        // If direct esm fail, try UMD fallback in catch
                        throw new Error("Invalid ESM module structure");
                    }
                }).catch(e => {
                    console.warn("Markdown ESM load failed, trying UMD...", e);
                    // Fallback to UMD
                    ResourceLoader.load('markdown-wasm').then(() => {
                        window.markdown.ready.then(() => {
                            this.onWasmReady();
                        }).catch(err => {
                            console.error(err);
                            this.fallbackToJs('Wasm ÂàùÂßãÂåñÂ§±Ë¥•');
                        });
                    }).catch(() => {
                        this.fallbackToJs('Wasm ‰∏ãËΩΩÂ§±Ë¥•');
                    });
                });
            },
            
            onWasmReady: function() {
                this.wasmLoaded = true;
                document.getElementById('engine-status').style.display = 'block';
                document.getElementById('engine-status').innerText = 'Wasm Ready';
                document.getElementById('engine-status').style.color = 'var(--primary)';
                app.showToast('Wasm ÂºïÊìéÂä†ËΩΩÊàêÂäü');
            },

            fallbackToJs: function(reason) {
                app.showToast(reason + 'ÔºåÂ∑≤Ëá™Âä®ÈôçÁ∫ßÂõû JavaScript ÂºïÊìé', 'error');
                document.getElementById('md-engine').value = 'js';
                this.wasmLoaded = false;
                document.getElementById('engine-status').style.display = 'none';
            },

            showEntityModal: function() {
                const modal = document.getElementById('entity-modal');
                const body = document.getElementById('entity-list-body');
                
                // Only populate if empty
                if (!body.hasChildNodes() || body.innerHTML.trim() === '<!-- Content will be injected by JS -->') {
                    let html = '';
                    ENTITY_DATA.forEach(section => {
                        html += `<div class="entity-section">
                            <div class="entity-section-title">${section.category}</div>
                            <div class="entity-grid">`;
                        section.items.forEach(item => {
                            // Convert HTML entities in name to string to prevent rendering them
                            const safeName = item.name.replace(/&/g, '&amp;');
                            const safeCode = item.code.replace(/&/g, '&amp;');
                            
                            html += `<div class="entity-item">
                                <span class="entity-char">${item.char}</span>
                                <div class="entity-info">
                                    <div class="entity-codes">
                                        <span>${safeName}</span>
                                        <span>${safeCode}</span>
                                    </div>
                                    <div class="entity-desc" title="${item.desc}">${item.desc}</div>
                                </div>
                            </div>`;
                        });
                        html += `</div></div>`;
                    });
                    body.innerHTML = html;
                }
                
                modal.style.display = 'flex';
            },

            closeEntityModal: function() {
                document.getElementById('entity-modal').style.display = 'none';
            },

            loadFile: function(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('md-input').value = e.target.result;
                    app.showToast('Êñá‰ª∂Âä†ËΩΩÊàêÂäü');
                };
                reader.readAsText(file);
            },

            escapeHtml: function(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            },

            toHtml: function() {
                let mdContent = document.getElementById('md-input').value;
                const engine = document.getElementById('md-engine').value;

                if (engine === 'wasm' && this.wasmLoaded) {
                    try {
                        const html = window.markdown.parse(mdContent);
                        document.getElementById('md-output').value = html;
                        app.showToast('ËΩ¨Êç¢ÂÆåÊàê (Wasm)');
                        return;
                    } catch(e) {
                        console.error(e);
                        app.showToast('Wasm ËΩ¨Êç¢Âá∫ÈîôÔºåÂ∞ùËØï JS ÈôçÁ∫ß...', 'error');
                        // Fallback continue below
                    }
                }

                // JS Fallback / Default
                const shouldEscape = document.getElementById('md-escape').checked;
                
                let html = mdContent;
                
                // Â¶ÇÊûúÂºÄÂêØËΩ¨‰πâÔºåÂÖàÂØπÂÖ®ÊñáËøõË°åËΩ¨‰πâ
                if (shouldEscape) {
                    html = mdTool.escapeHtml(html);
                }

                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                // ÂÖºÂÆπËΩ¨‰πâÂêéÁöÑ > (&gt;)
                html = html.replace(/^(?:>|&gt;) (.*$)/gim, '<blockquote>$1</blockquote>');
                html = html.replace(/\*\*(.*)\*\*/gim, '<b>$1</b>');
                html = html.replace(/\*(.*)\*/gim, '<i>$1</i>');
                html = html.replace(/```([\s\S]*?)```/gim, (match, code) => {
                    return '<pre><code>' + code + '</code></pre>';
                });
                html = html.replace(/`([^`]+)`/gim, (match, code) => {
                    return '<code>' + code + '</code>';
                });
                html = html.replace(/\[(.*?)\]\((.*?)\)/gim, "<a href='$2'>$1</a>");
                html = html.replace(/^---$/gim, '<hr>');
                html = html.replace(/\n\n/g, '<br><br>');

                document.getElementById('md-output').value = html;
            },

            importWord: function(input) {
                const file = input.files[0];
                if (!file) return;
                
                app.showToast('Ê≠£Âú®Âä†ËΩΩÁªÑ‰ª∂...', 'info');
                ResourceLoader.load('mammoth').then(() => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const arrayBuffer = e.target.result;
                        mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                            .then(function(result) {
                                const html = result.value; 
                                const md = mdTool.convertHtmlStrToMd(html);
                                document.getElementById('md-input').value = md;
                                app.showToast('Word ÂØºÂÖ•ÊàêÂäü');
                            })
                            .catch(function(error) {
                                console.error(error);
                                app.showToast('Word ËΩ¨Êç¢Â§±Ë¥•: ' + error.message);
                            });
                    };
                    reader.readAsArrayBuffer(file);
                });
            },

            convertHtmlStrToMd: function(html) {
                return html
                    .replace(/<h1[^>]*>(.*?)<\/h1>/gim, '# $1\n')
                    .replace(/<h2[^>]*>(.*?)<\/h2>/gim, '## $1\n')
                    .replace(/<h3[^>]*>(.*?)<\/h3>/gim, '### $1\n')
                    .replace(/<b[^>]*>(.*?)<\/b>/gim, '**$1**')
                    .replace(/<strong[^>]*>(.*?)<\/strong>/gim, '**$1**')
                    .replace(/<i[^>]*>(.*?)<\/i>/gim, '*$1*')
                    .replace(/<em[^>]*>(.*?)<\/em>/gim, '*$1*')
                    .replace(/<a[^>]*href=['"](.*?)['"][^>]*>(.*?)<\/a>/gim, '[$2]($1)')
                    .replace(/<p[^>]*>(.*?)<\/p>/gim, '$1\n\n')
                    .replace(/<br\s*\/?>/gim, '\n')
                    .replace(/<ul>([\s\S]*?)<\/ul>/gim, function(match, content) {
                         return content.replace(/<li[^>]*>(.*?)<\/li>/gim, '- $1\n');
                    })
                    .replace(/<ol>([\s\S]*?)<\/ol>/gim, function(match, content) {
                         let index = 1;
                         return content.replace(/<li[^>]*>(.*?)<\/li>/gim, function(m, c) {
                             return (index++) + '. ' + c + '\n';
                         });
                    })
                    // ËøòÂéüÊâÄÊúâ HTML ÂÆû‰Ωì
                    .replace(/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-f]{1,6});/ig, function(match) {
                        const txt = document.createElement("textarea");
                        txt.innerHTML = match;
                        return txt.value;
                    });
            },

            toMd: function() {
                let html = document.getElementById('md-input').value;
                document.getElementById('md-output').value = this.convertHtmlStrToMd(html);
            },
            
            preview: function() {
                const html = document.getElementById('md-output').value;
                const win = window.open("", "Preview", "width=800,height=600");
                win.document.write('<' + 'html><' + 'head><' + 'title>Preview</' + 'title>');
                win.document.write('<' + 'style>body{font-family:sans-serif;padding:2rem;line-height:1.6;color:#333}</' + 'style>');
                win.document.write('</' + 'head><' + 'body>');
                win.document.write(html);
                win.document.write('</' + 'body></' + 'html>');
                win.document.close();
            }
        };
    </script>
</body>
</html>