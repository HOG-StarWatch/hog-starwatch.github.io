<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD / HTML è½¬æ¢</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-container {
            background: var(--bg-panel);
            width: 800px;
            max-width: 90%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }
        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-weight: bold; font-size: 1.1rem; }
        .modal-close { cursor: pointer; font-size: 1.5rem; line-height: 1; }
        .modal-body {
            padding: 1rem;
            overflow-y: auto;
        }
        .entity-section { margin-bottom: 1.5rem; }
        .entity-section-title {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
        }
        .entity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }
        .entity-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            padding: 6px;
            border-radius: 4px;
            background: rgba(0,0,0,0.1);
        }
        .entity-char {
            width: 32px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .entity-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .entity-codes {
            display: flex;
            gap: 8px;
            font-family: monospace;
            color: var(--secondary);
            font-size: 0.75rem;
        }
        .entity-desc {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="workspace">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Markdown / æºç </div>
                <div class="panel-actions">
                    <div class="file-upload btn btn-icon" style="overflow:hidden">
                        <span>ğŸ“‚ ä¸Šä¼ MD</span>
                        <input type="file" accept=".md,.txt" onchange="mdTool.loadFile(this)">
                    </div>
                    <div class="file-upload btn btn-icon" style="overflow:hidden">
                        <span>ğŸ“‚ å¯¼å…¥Wordè½¬MD</span>
                        <input type="file" accept=".docx" onchange="mdTool.importWord(this)">
                    </div>
                    <button class="btn btn-icon" onclick="app.clear('md')">æ¸…ç©º</button>
                </div>
            </div>
            <textarea id="md-input" placeholder="# æ ‡é¢˜&#10;**åŠ ç²—**&#10;- åˆ—è¡¨..."></textarea>
        </div>

        <div class="toolbar">
            <div class="tool-group">
                <div class="group-label">è½¬æ¢</div>
                <button class="btn btn-primary" onclick="mdTool.toHtml()">è½¬ HTML â†’</button>
                <button class="btn btn-primary" onclick="mdTool.toMd()">è½¬ MD â†’</button>
            </div>
            <div class="tool-group">
                <div class="group-label">é€‰é¡¹</div>
                <label style="font-size:0.8rem; display:flex; align-items:center; gap:8px; cursor:pointer; color: var(--text-main);">
                    <input type="checkbox" id="md-escape" checked> è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
                </label>
            </div>
            <div class="tool-group">
                <div class="group-label">æ ‡ç­¾å¯¹ç…§è¡¨</div>
                <div style="font-size:0.75rem; color:var(--text-dim); display:grid; grid-template-columns: 1fr 1fr; gap:4px; max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:5px; border-radius:4px;">
                    <span style="color:var(--secondary)"># H1</span> <span>&lt;h1&gt;</span>
                    <span style="color:var(--secondary)">## H2</span> <span>&lt;h2&gt;</span>
                    <span style="color:var(--secondary)">### H3</span> <span>&lt;h3&gt;</span>
                    <span style="color:var(--secondary)">**Bold**</span> <span>&lt;b&gt;</span>
                    <span style="color:var(--secondary)">*Italic*</span> <span>&lt;i&gt;</span>
                    <span style="color:var(--secondary)">> Quote</span> <span>&lt;blockquote&gt;</span>
                    <span style="color:var(--secondary)">`Code`</span> <span>&lt;code&gt;</span>
                    <span style="color:var(--secondary)">```Pre```</span> <span>&lt;pre&gt;</span>
                    <span style="color:var(--secondary)">[Txt](Url)</span> <span>&lt;a&gt;</span>
                    <span style="color:var(--secondary)">---</span> <span>&lt;hr&gt;</span>
                    <span style="color:var(--secondary)">\n\n</span> <span>&lt;br&gt;</span>
                </div>
            </div>
            <div class="tool-group">
                <div class="group-label">å¸¸ç”¨ç¬¦å·å¯¹ç…§è¡¨</div>
                <div style="font-size:0.75rem; color:var(--text-dim); display:grid; grid-template-columns: 1fr; gap:4px; max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:5px; border-radius:4px;">
                    <div style="display:flex; justify-content:space-between;"><span>&lt;</span> <span>&amp;lt; / &amp;#60;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>&gt;</span> <span>&amp;gt; / &amp;#62;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>&amp;</span> <span>&amp;amp; / &amp;#38;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>&quot;</span> <span>&amp;quot; / &amp;#34;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Space</span> <span>&amp;nbsp; / &amp;#160;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Â©</span> <span>&amp;copy; / &amp;#169;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>Â®</span> <span>&amp;reg; / &amp;#174;</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>â„¢</span> <span>&amp;trade; / &amp;#8482;</span></div>
                </div>
                <button class="btn btn-secondary btn-sm" style="margin-top:5px; width:100%" onclick="mdTool.showEntityModal()">æŸ¥çœ‹å®Œæ•´åˆ—è¡¨</button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">ç»“æœ</div>
                <div class="panel-actions">
                    <button class="btn btn-icon btn-secondary" onclick="app.copy('md-output')">å¤åˆ¶ä»£ç </button>
                    <button class="btn btn-icon" onclick="mdTool.preview()">é¢„è§ˆ</button>
                </div>
            </div>
            <textarea id="md-output" placeholder="<h1...>ç»“æœ..."></textarea>
        </div>
    </div>

    <div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>
    
    <!-- Entity List Modal -->
    <div id="entity-modal" class="modal-overlay" onclick="if(event.target===this) mdTool.closeEntityModal()">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">HTML å®ä½“ç¬¦å·å®Œæ•´åˆ—è¡¨</div>
                <div class="modal-close" onclick="mdTool.closeEntityModal()">&times;</div>
            </div>
            <div class="modal-body" id="entity-list-body">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="../js/app.js"></script>
    <script>
        const ENTITY_DATA = [
            {
                category: "æ•°å­¦ç¬¦å· (Math)",
                items: [
                    { char: 'âˆ€', name: '&forall;', code: '&#8704;', desc: 'for all / å…¨ç§°é‡è¯' },
                    { char: 'âˆ‚', name: '&part;', code: '&#8706;', desc: 'partial differential / åå¾®åˆ†' },
                    { char: 'âˆƒ', name: '&exist;', code: '&#8707;', desc: 'exists / å­˜åœ¨é‡è¯' },
                    { char: 'âˆ…', name: '&empty;', code: '&#8709;', desc: 'empty set / ç©ºé›†' },
                    { char: 'âˆ‡', name: '&nabla;', code: '&#8711;', desc: 'nabla / å€’ä¸‰è§’ç®—å­' },
                    { char: 'âˆˆ', name: '&isin;', code: '&#8712;', desc: 'element of / å±äº' },
                    { char: 'âˆ‰', name: '&notin;', code: '&#8713;', desc: 'not an element of / ä¸å±äº' },
                    { char: 'âˆ‹', name: '&ni;', code: '&#8715;', desc: 'contains as member / åŒ…å«' },
                    { char: 'âˆ', name: '&prod;', code: '&#8719;', desc: 'n-ary product / ä¹˜ç§¯' },
                    { char: 'âˆ‘', name: '&sum;', code: '&#8721;', desc: 'n-ary summation / æ±‚å’Œ' },
                    { char: 'âˆ’', name: '&minus;', code: '&#8722;', desc: 'minus sign / å‡å·' },
                    { char: 'âˆ—', name: '&lowast;', code: '&#8727;', desc: 'asterisk operator / æ˜Ÿå·è¿ç®—ç¬¦' },
                    { char: 'âˆš', name: '&radic;', code: '&#8730;', desc: 'square root / å¹³æ–¹æ ¹' },
                    { char: 'âˆ', name: '&prop;', code: '&#8733;', desc: 'proportional to / æ­£æ¯”äº' },
                    { char: 'âˆ', name: '&infin;', code: '&#8734;', desc: 'infinity / æ— ç©·å¤§' },
                    { char: 'âˆ ', name: '&ang;', code: '&#8736;', desc: 'angle / è§’' },
                    { char: 'âˆ§', name: '&and;', code: '&#8743;', desc: 'logical and / é€»è¾‘ä¸' },
                    { char: 'âˆ¨', name: '&or;', code: '&#8744;', desc: 'logical or / é€»è¾‘æˆ–' },
                    { char: 'âˆ©', name: '&cap;', code: '&#8745;', desc: 'intersection / äº¤é›†' },
                    { char: 'âˆª', name: '&cup;', code: '&#8746;', desc: 'union / å¹¶é›†' },
                    { char: 'âˆ«', name: '&int;', code: '&#8747;', desc: 'integral / ç§¯åˆ†' },
                    { char: 'âˆ´', name: '&there4;', code: '&#8756;', desc: 'therefore / æ‰€ä»¥' },
                    { char: 'âˆ¼', name: '&sim;', code: '&#8764;', desc: 'similar to / ç›¸ä¼¼' },
                    { char: 'â‰…', name: '&cong;', code: '&#8773;', desc: 'congruent to / å…¨ç­‰' },
                    { char: 'â‰ˆ', name: '&asymp;', code: '&#8776;', desc: 'almost equal to / çº¦ç­‰äº' },
                    { char: 'â‰ ', name: '&ne;', code: '&#8800;', desc: 'not equal to / ä¸ç­‰äº' },
                    { char: 'â‰¡', name: '&equiv;', code: '&#8801;', desc: 'identical to / æ’ç­‰äº' },
                    { char: 'â‰¤', name: '&le;', code: '&#8804;', desc: 'less-than or equal to / å°äºç­‰äº' },
                    { char: 'â‰¥', name: '&ge;', code: '&#8805;', desc: 'greater-than or equal to / å¤§äºç­‰äº' },
                    { char: 'âŠ‚', name: '&sub;', code: '&#8834;', desc: 'subset of / çœŸå­é›†' },
                    { char: 'âŠƒ', name: '&sup;', code: '&#8835;', desc: 'superset of / çœŸè¶…é›†' },
                    { char: 'âŠ„', name: '&nsub;', code: '&#8836;', desc: 'not a subset of / éå­é›†' },
                    { char: 'âŠ†', name: '&sube;', code: '&#8838;', desc: 'subset of or equal to / å­é›†' },
                    { char: 'âŠ‡', name: '&supe;', code: '&#8839;', desc: 'superset of or equal to / è¶…é›†' },
                    { char: 'âŠ•', name: '&oplus;', code: '&#8853;', desc: 'circled plus / ç›´å’Œ' },
                    { char: 'âŠ—', name: '&otimes;', code: '&#8855;', desc: 'circled times / å¼ é‡ç§¯' },
                    { char: 'âŠ¥', name: '&perp;', code: '&#8869;', desc: 'up tack / å‚ç›´' },
                    { char: 'â‹…', name: '&sdot;', code: '&#8901;', desc: 'dot operator / ç‚¹ä¹˜' }
                ]
            },
            {
                category: "å¸Œè…Šå­—æ¯ (Greek)",
                items: [
                    { char: 'Î‘', name: '&Alpha;', code: '&#913;', desc: 'Capital Alpha' },
                    { char: 'Î’', name: '&Beta;', code: '&#914;', desc: 'Capital Beta' },
                    { char: 'Î“', name: '&Gamma;', code: '&#915;', desc: 'Capital Gamma' },
                    { char: 'Î”', name: '&Delta;', code: '&#916;', desc: 'Capital Delta' },
                    { char: 'Î•', name: '&Epsilon;', code: '&#917;', desc: 'Capital Epsilon' },
                    { char: 'Î–', name: '&Zeta;', code: '&#918;', desc: 'Capital Zeta' },
                    { char: 'Î—', name: '&Eta;', code: '&#919;', desc: 'Capital Eta' },
                    { char: 'Î˜', name: '&Theta;', code: '&#920;', desc: 'Capital Theta' },
                    { char: 'Î™', name: '&Iota;', code: '&#921;', desc: 'Capital Iota' },
                    { char: 'Îš', name: '&Kappa;', code: '&#922;', desc: 'Capital Kappa' },
                    { char: 'Î›', name: '&Lambda;', code: '&#923;', desc: 'Capital Lambda' },
                    { char: 'Îœ', name: '&Mu;', code: '&#924;', desc: 'Capital Mu' },
                    { char: 'Î', name: '&Nu;', code: '&#925;', desc: 'Capital Nu' },
                    { char: 'Î', name: '&Xi;', code: '&#926;', desc: 'Capital Xi' },
                    { char: 'ÎŸ', name: '&Omicron;', code: '&#927;', desc: 'Capital Omicron' },
                    { char: 'Î ', name: '&Pi;', code: '&#928;', desc: 'Capital Pi' },
                    { char: 'Î¡', name: '&Rho;', code: '&#929;', desc: 'Capital Rho' },
                    { char: 'Î£', name: '&Sigma;', code: '&#931;', desc: 'Capital Sigma' },
                    { char: 'Î¤', name: '&Tau;', code: '&#932;', desc: 'Capital Tau' },
                    { char: 'Î¥', name: '&Upsilon;', code: '&#933;', desc: 'Capital Upsilon' },
                    { char: 'Î¦', name: '&Phi;', code: '&#934;', desc: 'Capital Phi' },
                    { char: 'Î§', name: '&Chi;', code: '&#935;', desc: 'Capital Chi' },
                    { char: 'Î¨', name: '&Psi;', code: '&#936;', desc: 'Capital Psi' },
                    { char: 'Î©', name: '&Omega;', code: '&#937;', desc: 'Capital Omega' },
                    { char: 'Î±', name: '&alpha;', code: '&#945;', desc: 'Small alpha' },
                    { char: 'Î²', name: '&beta;', code: '&#946;', desc: 'Small beta' },
                    { char: 'Î³', name: '&gamma;', code: '&#947;', desc: 'Small gamma' },
                    { char: 'Î´', name: '&delta;', code: '&#948;', desc: 'Small delta' },
                    { char: 'Îµ', name: '&epsilon;', code: '&#949;', desc: 'Small epsilon' },
                    { char: 'Î¶', name: '&zeta;', code: '&#950;', desc: 'Small zeta' },
                    { char: 'Î·', name: '&eta;', code: '&#951;', desc: 'Small eta' },
                    { char: 'Î¸', name: '&theta;', code: '&#952;', desc: 'Small theta' },
                    { char: 'Î¹', name: '&iota;', code: '&#953;', desc: 'Small iota' },
                    { char: 'Îº', name: '&kappa;', code: '&#954;', desc: 'Small kappa' },
                    { char: 'Î»', name: '&lambda;', code: '&#955;', desc: 'Small lambda' },
                    { char: 'Î¼', name: '&mu;', code: '&#956;', desc: 'Small mu' },
                    { char: 'Î½', name: '&nu;', code: '&#957;', desc: 'Small nu' },
                    { char: 'Î¾', name: '&xi;', code: '&#958;', desc: 'Small xi' },
                    { char: 'Î¿', name: '&omicron;', code: '&#959;', desc: 'Small omicron' },
                    { char: 'Ï€', name: '&pi;', code: '&#960;', desc: 'Small pi' },
                    { char: 'Ï', name: '&rho;', code: '&#961;', desc: 'Small rho' },
                    { char: 'Ï‚', name: '&sigmaf;', code: '&#962;', desc: 'Small final sigma' },
                    { char: 'Ïƒ', name: '&sigma;', code: '&#963;', desc: 'Small sigma' },
                    { char: 'Ï„', name: '&tau;', code: '&#964;', desc: 'Small tau' },
                    { char: 'Ï…', name: '&upsilon;', code: '&#965;', desc: 'Small upsilon' },
                    { char: 'Ï†', name: '&phi;', code: '&#966;', desc: 'Small phi' },
                    { char: 'Ï‡', name: '&chi;', code: '&#967;', desc: 'Small chi' },
                    { char: 'Ïˆ', name: '&psi;', code: '&#968;', desc: 'Small psi' },
                    { char: 'Ï‰', name: '&omega;', code: '&#969;', desc: 'Small omega' },
                    { char: 'Ï‘', name: '&thetasym;', code: '&#977;', desc: 'Theta symbol' },
                    { char: 'Ï’', name: '&upsih;', code: '&#978;', desc: 'Upsilon symbol' },
                    { char: 'Ï–', name: '&piv;', code: '&#982;', desc: 'Pi symbol' }
                ]
            },
            {
                category: "å…¶ä»–å®ä½“ (Other)",
                items: [
                    { char: 'Å’', name: '&OElig;', code: '&#338;', desc: 'Capital ligature OE' },
                    { char: 'Å“', name: '&oelig;', code: '&#339;', desc: 'Small ligature oe' },
                    { char: 'Å ', name: '&Scaron;', code: '&#352;', desc: 'Capital S with caron' },
                    { char: 'Å¡', name: '&scaron;', code: '&#353;', desc: 'Small s with caron' },
                    { char: 'Å¸', name: '&Yuml;', code: '&#376;', desc: 'Capital Y with diaeresis' },
                    { char: 'Æ’', name: '&fnof;', code: '&#402;', desc: 'Latin small f with hook' },
                    { char: 'Ë†', name: '&circ;', code: '&#710;', desc: 'Modifier letter circumflex' },
                    { char: 'Ëœ', name: '&tilde;', code: '&#732;', desc: 'Small tilde' },
                    { char: 'â€‚', name: '&ensp;', code: '&#8194;', desc: 'En space / åŠè§’ç©ºæ ¼' },
                    { char: 'â€ƒ', name: '&emsp;', code: '&#8195;', desc: 'Em space / å…¨è§’ç©ºæ ¼' },
                    { char: 'â€‰', name: '&thinsp;', code: '&#8201;', desc: 'Thin space / çª„ç©ºæ ¼' },
                    { char: 'â€Œ', name: '&zwnj;', code: '&#8204;', desc: 'Zero width non-joiner / é›¶å®½ä¸è¿å­—' },
                    { char: 'â€', name: '&zwj;', code: '&#8205;', desc: 'Zero width joiner / é›¶å®½è¿å­—' },
                    { char: 'â€', name: '&lrm;', code: '&#8206;', desc: 'Left-to-right mark / å·¦è‡³å³æ ‡è®°' },
                    { char: 'â€', name: '&rlm;', code: '&#8207;', desc: 'Right-to-left mark / å³è‡³å·¦æ ‡è®°' },
                    { char: 'â€“', name: '&ndash;', code: '&#8211;', desc: 'En dash / çŸ­ç ´æŠ˜å·' },
                    { char: 'â€”', name: '&mdash;', code: '&#8212;', desc: 'Em dash / é•¿ç ´æŠ˜å·' },
                    { char: "'", name: '&lsquo;', code: '&#8216;', desc: 'Left single quote' },
                    { char: "'", name: '&rsquo;', code: '&#8217;', desc: 'Right single quote' },
                    { char: 'â€š', name: '&sbquo;', code: '&#8218;', desc: 'Single low-9 quote' },
                    { char: '"', name: '&ldquo;', code: '&#8220;', desc: 'Left double quote' },
                    { char: '"', name: '&rdquo;', code: '&#8221;', desc: 'Right double quote' },
                    { char: 'â€', name: '&bdquo;', code: '&#8222;', desc: 'Double low-9 quote' },
                    { char: 'â€ ', name: '&dagger;', code: '&#8224;', desc: 'Dagger / å‰‘å·' },
                    { char: 'â€¡', name: '&Dagger;', code: '&#8225;', desc: 'Double dagger / åŒå‰‘å·' },
                    { char: 'â€¢', name: '&bull;', code: '&#8226;', desc: 'Bullet / é¡¹ç›®ç¬¦å·' },
                    { char: 'â€¦', name: '&hellip;', code: '&#8230;', desc: 'Horizontal ellipsis / çœç•¥å·' },
                    { char: 'â€°', name: '&permil;', code: '&#8240;', desc: 'Per mille sign / åƒåˆ†å·' },
                    { char: 'â€²', name: '&prime;', code: '&#8242;', desc: 'Prime / è§’åˆ†ç¬¦å·' },
                    { char: 'â€³', name: '&Prime;', code: '&#8243;', desc: 'Double prime / è§’ç§’ç¬¦å·' },
                    { char: 'â€¹', name: '&lsaquo;', code: '&#8249;', desc: 'Single left-pointing angle quote' },
                    { char: 'â€º', name: '&rsaquo;', code: '&#8250;', desc: 'Single right-pointing angle quote' },
                    { char: 'â€¾', name: '&oline;', code: '&#8254;', desc: 'Overline / ä¸Šåˆ’çº¿' },
                    { char: 'â‚¬', name: '&euro;', code: '&#8364;', desc: 'Euro sign / æ¬§å…ƒç¬¦å·' },
                    { char: 'â„¢', name: '&trade;', code: '&#8482;', desc: 'Trade mark / å•†æ ‡ç¬¦å·' },
                    { char: 'â†', name: '&larr;', code: '&#8592;', desc: 'Leftwards arrow' },
                    { char: 'â†‘', name: '&uarr;', code: '&#8593;', desc: 'Upwards arrow' },
                    { char: 'â†’', name: '&rarr;', code: '&#8594;', desc: 'Rightwards arrow' },
                    { char: 'â†“', name: '&darr;', code: '&#8595;', desc: 'Downwards arrow' },
                    { char: 'â†”', name: '&harr;', code: '&#8596;', desc: 'Left right arrow' },
                    { char: 'â†µ', name: '&crarr;', code: '&#8629;', desc: 'Carriage return arrow' },
                    { char: 'âŒˆ', name: '&lceil;', code: '&#8968;', desc: 'Left ceiling' },
                    { char: 'âŒ‰', name: '&rceil;', code: '&#8969;', desc: 'Right ceiling' },
                    { char: 'âŒŠ', name: '&lfloor;', code: '&#8970;', desc: 'Left floor' },
                    { char: 'âŒ‹', name: '&rfloor;', code: '&#8971;', desc: 'Right floor' },
                    { char: 'â—Š', name: '&loz;', code: '&#9674;', desc: 'Lozenge / è±å½¢' },
                    { char: 'â™ ', name: '&spades;', code: '&#9824;', desc: 'Black spade suit / é»‘æ¡ƒ' },
                    { char: 'â™£', name: '&clubs;', code: '&#9827;', desc: 'Black club suit / æ¢…èŠ±' },
                    { char: 'â™¥', name: '&hearts;', code: '&#9829;', desc: 'Black heart suit / çº¢æ¡ƒ' },
                    { char: 'â™¦', name: '&diams;', code: '&#9830;', desc: 'Black diamond suit / æ–¹å—' }
                ]
            }
        ];

        const mdTool = {
            showEntityModal: function() {
                const modal = document.getElementById('entity-modal');
                const body = document.getElementById('entity-list-body');
                
                // Only populate if empty
                if (!body.hasChildNodes() || body.innerHTML.trim() === '<!-- Content will be injected by JS -->') {
                    let html = '';
                    ENTITY_DATA.forEach(section => {
                        html += `<div class="entity-section">
                            <div class="entity-section-title">${section.category}</div>
                            <div class="entity-grid">`;
                        section.items.forEach(item => {
                            // Convert HTML entities in name to string to prevent rendering them
                            const safeName = item.name.replace(/&/g, '&amp;');
                            const safeCode = item.code.replace(/&/g, '&amp;');
                            
                            html += `<div class="entity-item">
                                <span class="entity-char">${item.char}</span>
                                <div class="entity-info">
                                    <div class="entity-codes">
                                        <span>${safeName}</span>
                                        <span>${safeCode}</span>
                                    </div>
                                    <div class="entity-desc" title="${item.desc}">${item.desc}</div>
                                </div>
                            </div>`;
                        });
                        html += `</div></div>`;
                    });
                    body.innerHTML = html;
                }
                
                modal.style.display = 'flex';
            },

            closeEntityModal: function() {
                document.getElementById('entity-modal').style.display = 'none';
            },

            loadFile: function(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('md-input').value = e.target.result;
                    app.showToast('æ–‡ä»¶åŠ è½½æˆåŠŸ');
                };
                reader.readAsText(file);
            },

            escapeHtml: function(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            },

            toHtml: function() {
                let md = document.getElementById('md-input').value;
                const shouldEscape = document.getElementById('md-escape').checked;
                
                let html = md;
                
                // å¦‚æœå¼€å¯è½¬ä¹‰ï¼Œå…ˆå¯¹å…¨æ–‡è¿›è¡Œè½¬ä¹‰
                if (shouldEscape) {
                    html = mdTool.escapeHtml(html);
                }

                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                // å…¼å®¹è½¬ä¹‰åçš„ > (&gt;)
                html = html.replace(/^(?:>|&gt;) (.*$)/gim, '<blockquote>$1</blockquote>');
                html = html.replace(/\*\*(.*)\*\*/gim, '<b>$1</b>');
                html = html.replace(/\*(.*)\*/gim, '<i>$1</i>');
                html = html.replace(/```([\s\S]*?)```/gim, (match, code) => {
                    return '<pre><code>' + code + '</code></pre>';
                });
                html = html.replace(/`([^`]+)`/gim, (match, code) => {
                    return '<code>' + code + '</code>';
                });
                html = html.replace(/\[(.*?)\]\((.*?)\)/gim, "<a href='$2'>$1</a>");
                html = html.replace(/^---$/gim, '<hr>');
                html = html.replace(/\n\n/g, '<br><br>');

                document.getElementById('md-output').value = html;
            },

            importWord: function(input) {
                const file = input.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                        .then(function(result) {
                            const html = result.value; 
                            const md = mdTool.convertHtmlStrToMd(html);
                            document.getElementById('md-input').value = md;
                            app.showToast('Word å¯¼å…¥æˆåŠŸ');
                        })
                        .catch(function(error) {
                            console.error(error);
                            app.showToast('Word è½¬æ¢å¤±è´¥: ' + error.message);
                        });
                };
                reader.readAsArrayBuffer(file);
            },

            convertHtmlStrToMd: function(html) {
                return html
                    .replace(/<h1[^>]*>(.*?)<\/h1>/gim, '# $1\n')
                    .replace(/<h2[^>]*>(.*?)<\/h2>/gim, '## $1\n')
                    .replace(/<h3[^>]*>(.*?)<\/h3>/gim, '### $1\n')
                    .replace(/<b[^>]*>(.*?)<\/b>/gim, '**$1**')
                    .replace(/<strong[^>]*>(.*?)<\/strong>/gim, '**$1**')
                    .replace(/<i[^>]*>(.*?)<\/i>/gim, '*$1*')
                    .replace(/<em[^>]*>(.*?)<\/em>/gim, '*$1*')
                    .replace(/<a[^>]*href=['"](.*?)['"][^>]*>(.*?)<\/a>/gim, '[$2]($1)')
                    .replace(/<p[^>]*>(.*?)<\/p>/gim, '$1\n\n')
                    .replace(/<br\s*\/?>/gim, '\n')
                    .replace(/<ul>([\s\S]*?)<\/ul>/gim, function(match, content) {
                         return content.replace(/<li[^>]*>(.*?)<\/li>/gim, '- $1\n');
                    })
                    .replace(/<ol>([\s\S]*?)<\/ol>/gim, function(match, content) {
                         let index = 1;
                         return content.replace(/<li[^>]*>(.*?)<\/li>/gim, function(m, c) {
                             return (index++) + '. ' + c + '\n';
                         });
                    })
                    // è¿˜åŸæ‰€æœ‰ HTML å®ä½“
                    .replace(/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-f]{1,6});/ig, function(match) {
                        const txt = document.createElement("textarea");
                        txt.innerHTML = match;
                        return txt.value;
                    });
            },

            toMd: function() {
                let html = document.getElementById('md-input').value;
                document.getElementById('md-output').value = this.convertHtmlStrToMd(html);
            },
            
            preview: function() {
                const html = document.getElementById('md-output').value;
                const win = window.open("", "Preview", "width=800,height=600");
                win.document.write('<' + 'html><' + 'head><' + 'title>Preview</' + 'title>');
                win.document.write('<' + 'style>body{font-family:sans-serif;padding:2rem;line-height:1.6;color:#333}</' + 'style>');
                win.document.write('</' + 'head><' + 'body>');
                win.document.write(html);
                win.document.write('</' + 'body></' + 'html>');
                win.document.close();
            }
        };
    </script>
</body>
</html>