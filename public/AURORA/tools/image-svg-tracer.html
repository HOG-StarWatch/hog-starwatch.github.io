<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è½¬ SVG (Vectorize)</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .tracer-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .tracer-shell {
            display: grid;
            grid-template-columns: minmax(280px, 360px) minmax(0, 1fr);
            gap: 1.5rem;
            align-items: start;
        }
        .tracer-left {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 0;
        }
        .tracer-right {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-width: 0;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            min-height: 180px;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(192, 132, 252, 0.05);
            color: var(--text-main);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .upload-area.drag-over {
            border-color: var(--secondary);
            background: rgba(45, 212, 191, 0.1);
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 0.8rem;
            display: flex;
            align-items: stretch;
            gap: 1rem;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .thumb {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            background: #1e293b;
            border: 1px solid var(--border);
        }

        .file-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .filename {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-main);
            margin-bottom: 0.2rem;
        }

        .file-status {
            font-size: 0.85rem;
            color: var(--text-dim);
        }
        .file-status.processing { color: var(--primary); }
        .file-status.done { color: var(--secondary); }
        .file-status.error { color: var(--accent); }

        .file-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .file-meta {
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .file-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 999px;
            overflow: hidden;
        }
        .file-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.2s ease;
        }
        .file-progress-bar.error {
            background: var(--accent);
        }
        .file-progress-text {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-align: right;
        }
        .list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .list-meta {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        .list-meta b {
            color: var(--text-main);
        }
        @media (max-width: 980px) {
            .tracer-shell {
                grid-template-columns: 1fr;
            }
            .file-item {
                flex-direction: column;
            }
            .file-actions {
                justify-content: flex-end;
            }
        }

        /* Modal specific overrides */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal.show { display: flex; }
        
        .modal-content {
            background: var(--bg-deep);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            position: relative;
            box-shadow: var(--shadow);
        }

        .compare-view {
            flex: 1;
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
            overflow: hidden;
        }

        .view-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .view-pane h4 {
            text-align: center;
            margin: 0;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-dim);
        }

        .img-container {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Checkerboard */
            background-image: 
                linear-gradient(45deg, #2a2a2a 25%, transparent 25%), 
                linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #2a2a2a 75%), 
                linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #1a1a1a;
            padding: 1rem;
        }

        .img-container img, .img-container svg {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body style="padding: 1rem;">
    
    <div class="panel" style="padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h2 style="margin: 0; color: var(--primary);">SVG çŸ¢é‡åŒ–å·¥å…·</h2>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-dim);">å°†ä½å›¾ (PNG, JPG) è½¬æ¢ä¸ºçŸ¢é‡ SVGï¼Œæ”¯æŒæ‰¹é‡å¤„ç†ä¸å®æ—¶é¢„è§ˆ</p>
            </div>
            <div style="text-align: right;">
                <button class="btn" onclick="tracerTool.downloadAll()" id="btn-download-all" disabled>
                    ä¸‹è½½å…¨éƒ¨ (ZIP)
                </button>
            </div>
        </div>

        <div class="tracer-container">
            <div class="tracer-shell">
                <div class="tracer-left">
                    <div class="panel" style="background: rgba(0,0,0,0.2);">
                        <div class="settings-grid">
                            <div class="input-row">
                                <label>è‰²å½©æ•°é‡ (Colors)</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <input type="range" id="color-count" min="2" max="64" value="16" style="flex: 1;" oninput="document.getElementById('color-val').innerText = this.value">
                                    <span id="color-val" style="width: 30px; text-align: right; color: var(--primary);">16</span>
                                </div>
                            </div>

                            <div class="input-row">
                                <label>é™åˆ¶æœ€å¤§å®½åº¦ (Resize)</label>
                                <select id="max-width" style="width: 100%; background: var(--input-bg); border: 1px solid var(--border); padding: 0.5rem; color: var(--text-main); border-radius: var(--radius-sm);">
                                    <option value="0">åŸå§‹å°ºå¯¸ (ä¸ç¼©æ”¾)</option>
                                    <option value="640">640px</option>
                                    <option value="1024" selected>1024px</option>
                                    <option value="2048">2048px</option>
                                </select>
                            </div>

                            <div class="input-row">
                                <label>è·¯å¾„ç²¾åº¦ (LTres)</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <input type="range" id="ltres" min="0" max="10" step="0.1" value="1" style="flex: 1;" oninput="document.getElementById('ltres-val').innerText = this.value">
                                    <span id="ltres-val" style="width: 30px; text-align: right; color: var(--primary);">1</span>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.2rem;">å€¼è¶Šå°ç²¾åº¦è¶Šé«˜</div>
                            </div>

                            <div class="input-row">
                                <label>æ›²çº¿ç²¾åº¦ (QTres)</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <input type="range" id="qtres" min="0" max="10" step="0.1" value="1" style="flex: 1;" oninput="document.getElementById('qtres-val').innerText = this.value">
                                    <span id="qtres-val" style="width: 30px; text-align: right; color: var(--primary);">1</span>
                                </div>
                            </div>
                            
                            <div class="input-row">
                                <label>æ¨¡ç³Šé¢„å¤„ç†</label>
                                 <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 0.5rem;">
                                    <input type="checkbox" id="blur-check" onchange="document.getElementById('blur-control').style.display = this.checked ? 'block' : 'none'">
                                    å¯ç”¨é«˜æ–¯æ¨¡ç³Š
                                </label>
                                <div id="blur-control" style="display: none; margin-top: 0.5rem;">
                                    <input type="range" id="blur-radius" min="1" max="20" value="5" style="width: 100%;">
                                </div>
                            </div>

                            <div class="input-row" style="display: flex; align-items: flex-end;">
                                 <button class="btn btn-primary" onclick="tracerTool.processAll()" style="width: 100%;">åº”ç”¨è®¾ç½®å¹¶é‡æ–°è½¬æ¢</button>
                            </div>
                        </div>
                    </div>

                    <div class="upload-area" id="drop-zone" onclick="document.getElementById('file-input').click()">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem; color: var(--primary);">ğŸ¨</div>
                        <div style="font-size: 1.1rem; font-weight: 500;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                        <div style="font-size: 0.9rem; color: var(--text-dim); margin-top: 0.5rem;">æ”¯æŒ JPG, PNG (æ¨èé€æ˜èƒŒæ™¯)</div>
                        <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
                    </div>
                </div>

                <div class="tracer-right">
                    <div class="panel-title list-header" style="margin-top: 0;">
                        <span>æ–‡ä»¶åˆ—è¡¨ (<span id="file-count">0</span>)</span>
                        <div class="list-meta">
                            <span>å¤„ç†ä¸­ <b id="file-processing">0</b></span>
                            <span>å®Œæˆ <b id="file-done">0</b></span>
                            <span>å¤±è´¥ <b id="file-error">0</b></span>
                        </div>
                        <button class="btn btn-sm" onclick="tracerTool.clearAll()" style="color: var(--accent);">æ¸…ç©ºåˆ—è¡¨</button>
                    </div>
                    <div id="file-list" class="file-list">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                <h3 style="margin: 0;">é¢„è§ˆå¯¹æ¯”</h3>
                <span onclick="document.getElementById('preview-modal').classList.remove('show')" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
            </div>
            <div class="compare-view">
                <div class="view-pane">
                    <h4>åŸå›¾</h4>
                    <div class="img-container" id="preview-original"></div>
                </div>
                <div class="view-pane">
                    <h4>SVG çŸ¢é‡å›¾ (<span id="svg-size">-</span> KB)</h4>
                    <div class="img-container" id="preview-svg"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/app.js"></script>
    <script src="../js/loader.js"></script>
    <script>
        const tracerTool = {
            files: [],
            worker: null,

            init: function() {
                // Initialize Worker
                this.worker = (window.app && app.getWorker) ? app.getWorker('../js/workers/svg-tracer.worker.js') : new Worker('../js/workers/svg-tracer.worker.js');
                this.worker.onmessage = this.handleWorkerMessage.bind(this);

                // Load libraries
                ResourceLoader.loadDeps('@file-export')
                    .then(() => {
                        console.log('Libraries loaded');
                    });

                // Events
                this.setupEvents();
            },

            setupEvents: function() {
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    this.handleFiles(e.dataTransfer.files);
                });

                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                    fileInput.value = '';
                });

                // Modal close on outside click
                window.addEventListener('click', (e) => {
                    const modal = document.getElementById('preview-modal');
                    if (e.target === modal) modal.classList.remove('show');
                });
            },

            handleFiles: function(fileList) {
                if (!fileList.length) return;
                
                Array.from(fileList).forEach(file => {
                    if (!file.type.startsWith('image/')) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const fileItem = {
                            id: Date.now() + Math.random().toString(36).substr(2, 9),
                            file: file,
                            status: 'pending', // pending, processing, done, error
                            svgContent: null,
                            thumbnail: e.target.result,
                            originalSize: file.size,
                            progress: 5,
                            statusText: 'ç­‰å¾…ä¸­'
                        };
                        this.files.push(fileItem);
                        this.renderList();
                        
                        // Auto process
                        setTimeout(() => this.processFile(fileItem), 100);
                    };
                    reader.readAsDataURL(file);
                });
            },

            getOptions: function() {
                const blurCheck = document.getElementById('blur-check').checked;
                return {
                    numberofcolors: parseInt(document.getElementById('color-count').value),
                    ltres: parseFloat(document.getElementById('ltres').value),
                    qtres: parseFloat(document.getElementById('qtres').value),
                    pathomit: 8, // Fixed or add control if needed
                    blurradius: blurCheck ? parseInt(document.getElementById('blur-radius').value) : 0,
                    blurdelta: 20,
                    scale: 1, // We handle resizing via canvas before, so scale 1 usually
                    viewbox: true
                };
            },

            processAll: function() {
                this.files.forEach(f => {
                    f.status = 'pending';
                    this.processFile(f);
                });
                this.renderList();
            },

            processFile: function(fileItem) {
                if (fileItem.status === 'processing') return;
                fileItem.status = 'processing';
                fileItem.progress = 12;
                fileItem.statusText = 'å‡†å¤‡ä¸­';
                this.renderList();

                const maxWidth = parseInt(document.getElementById('max-width').value);
                const options = this.getOptions();

                // Load image to canvas to get ImageData (and resize)
                const img = new Image();
                img.src = fileItem.thumbnail;
                img.onload = () => {
                    fileItem.progress = 35;
                    fileItem.statusText = 'è¯»å–å›¾åƒ';
                    this.renderList();
                    let width = img.width;
                    let height = img.height;
                    
                    if (maxWidth > 0 && width > maxWidth) {
                        const ratio = maxWidth / width;
                        width = maxWidth;
                        height = Math.round(height * ratio);
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const imageData = ctx.getImageData(0, 0, width, height);

                    // Send to worker
                    fileItem.progress = 60;
                    fileItem.statusText = 'çŸ¢é‡åŒ–ä¸­';
                    this.renderList();
                    this.worker.postMessage({
                        id: fileItem.id,
                        imageData: imageData,
                        options: options
                    });
                };
            },

            handleWorkerMessage: function(e) {
                const { id, status, svgContent, error } = e.data;
                const fileItem = this.files.find(f => f.id === id);
                if (!fileItem) return;

                if (status === 'success') {
                    fileItem.status = 'done';
                    fileItem.svgContent = svgContent;
                    fileItem.progress = 100;
                    fileItem.statusText = 'å®Œæˆ';
                } else {
                    fileItem.status = 'error';
                    fileItem.progress = 100;
                    fileItem.statusText = 'å¤±è´¥';
                    console.error('Worker error:', error);
                }
                
                this.renderList();
            },

            renderList: function() {
                const listEl = document.getElementById('file-list');
                const countEl = document.getElementById('file-count');
                const dlBtn = document.getElementById('btn-download-all');
                const processingEl = document.getElementById('file-processing');
                const doneEl = document.getElementById('file-done');
                const errorEl = document.getElementById('file-error');
                
                listEl.innerHTML = '';
                countEl.textContent = this.files.length;
                
                const processingCount = this.files.filter(f => f.status === 'processing').length;
                const doneCount = this.files.filter(f => f.status === 'done').length;
                const errorCount = this.files.filter(f => f.status === 'error').length;
                if (processingEl) processingEl.textContent = processingCount;
                if (doneEl) doneEl.textContent = doneCount;
                if (errorEl) errorEl.textContent = errorCount;

                const hasDone = this.files.some(f => f.status === 'done');
                dlBtn.disabled = !hasDone;

                this.files.forEach(f => {
                    const el = document.createElement('div');
                    el.className = 'file-item';
                    const thumb = document.createElement('img');
                    thumb.src = f.thumbnail;
                    thumb.className = 'thumb';

                    const info = document.createElement('div');
                    info.className = 'file-info';
                    const name = document.createElement('div');
                    name.className = 'filename';
                    name.textContent = f.file.name;
                    const status = document.createElement('span');
                    status.className = 'file-status';
                    if (f.status === 'processing') status.classList.add('processing');
                    if (f.status === 'done') status.classList.add('done');
                    if (f.status !== 'pending' && f.status !== 'processing' && f.status !== 'done') status.classList.add('error');
                    status.textContent = f.statusText || (f.status === 'pending' ? 'ç­‰å¾…ä¸­' : (f.status === 'processing' ? 'å¤„ç†ä¸­...' : (f.status === 'done' ? 'å®Œæˆ' : 'å¤±è´¥')));
                    const meta = document.createElement('div');
                    meta.className = 'file-meta';
                    const sizeKb = (f.originalSize / 1024).toFixed(1);
                    let metaText = `åŸå§‹ ${sizeKb} KB`;
                    if (f.status === 'done' && f.svgContent) {
                        const outKb = (new Blob([f.svgContent]).size / 1024).toFixed(1);
                        metaText = `åŸå§‹ ${sizeKb} KB Â· è¾“å‡º ${outKb} KB`;
                    }
                    meta.textContent = metaText;
                    const progressWrap = document.createElement('div');
                    progressWrap.className = 'file-progress';
                    const progressBar = document.createElement('div');
                    progressBar.className = 'file-progress-bar';
                    if (f.status === 'error') progressBar.classList.add('error');
                    const progressVal = Math.max(0, Math.min(100, f.progress || 0));
                    progressBar.style.width = `${progressVal}%`;
                    progressWrap.appendChild(progressBar);
                    const progressText = document.createElement('div');
                    progressText.className = 'file-progress-text';
                    progressText.textContent = f.status === 'error' ? 'å¤±è´¥' : `${progressVal}%`;
                    info.appendChild(name);
                    info.appendChild(status);
                    info.appendChild(meta);
                    info.appendChild(progressWrap);
                    info.appendChild(progressText);

                    const actions = document.createElement('div');
                    actions.className = 'file-actions';
                    const btnPreview = document.createElement('button');
                    btnPreview.className = 'btn';
                    btnPreview.style.padding = '0.3rem 0.6rem';
                    btnPreview.textContent = 'é¢„è§ˆ';
                    btnPreview.disabled = f.status !== 'done';
                    btnPreview.addEventListener('click', () => this.preview(f.id));
                    const btnDownload = document.createElement('button');
                    btnDownload.className = 'btn';
                    btnDownload.style.padding = '0.3rem 0.6rem';
                    btnDownload.textContent = 'â¬‡';
                    btnDownload.disabled = f.status !== 'done';
                    btnDownload.addEventListener('click', () => this.download(f.id));
                    const btnRemove = document.createElement('button');
                    btnRemove.className = 'btn';
                    btnRemove.style.padding = '0.3rem 0.6rem';
                    btnRemove.style.color = 'var(--accent)';
                    btnRemove.textContent = 'Ã—';
                    btnRemove.addEventListener('click', () => this.remove(f.id));
                    actions.appendChild(btnPreview);
                    actions.appendChild(btnDownload);
                    actions.appendChild(btnRemove);

                    el.appendChild(thumb);
                    el.appendChild(info);
                    el.appendChild(actions);
                    listEl.appendChild(el);
                });
            },

            preview: function(id) {
                const f = this.files.find(f => f.id === id);
                if (!f || !f.svgContent) return;

                const previewOriginal = document.getElementById('preview-original');
                previewOriginal.innerHTML = '';
                const img = document.createElement('img');
                img.src = f.thumbnail;
                previewOriginal.appendChild(img);
                const previewSvg = document.getElementById('preview-svg');
                const safeSvg = (window.app && app.sanitizeSvg) ? app.sanitizeSvg(f.svgContent) : f.svgContent;
                previewSvg.innerHTML = safeSvg;
                
                const sizeKB = (new Blob([f.svgContent]).size / 1024).toFixed(2);
                document.getElementById('svg-size').textContent = sizeKB;

                document.getElementById('preview-modal').classList.add('show');
            },

            download: function(id) {
                const f = this.files.find(f => f.id === id);
                if (!f || !f.svgContent) return;
                
                const blob = new Blob([f.svgContent], {type: "image/svg+xml;charset=utf-8"});
                const fileName = f.file.name.replace(/\.[^/.]+$/, "") + ".svg";
                saveAs(blob, fileName);
            },

            downloadAll: function() {
                const zip = new JSZip();
                let count = 0;
                
                this.files.forEach(f => {
                    if (f.status === 'done' && f.svgContent) {
                        const fileName = f.file.name.replace(/\.[^/.]+$/, "") + ".svg";
                        zip.file(fileName, f.svgContent);
                        count++;
                    }
                });
                
                if (count === 0) return;
                
                zip.generateAsync({type:"blob"})
                .then(function(content) {
                    saveAs(content, "svg-vectors.zip");
                });
            },

            remove: function(id) {
                this.files = this.files.filter(f => f.id !== id);
                this.renderList();
            },

            clearAll: function() {
                this.files = [];
                this.renderList();
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            tracerTool.init();
        });
    </script>
</body>
</html>
